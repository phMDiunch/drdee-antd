# Reset Password Implementation

## Overview

Reset password feature sử dụng **Implicit Flow** của Supabase Auth để cho phép user đặt lại mật khẩu qua email.

## Flow

1. User truy cập `/forgot-password` và nhập email
2. Gọi `supabase.auth.resetPasswordForEmail(email, { redirectTo: '/reset-password' })`
3. Supabase gửi email với link chứa access token trong URL hash
4. User click link từ email → Redirect về `/reset-password#access_token=xxx&type=recovery`
5. Supabase client tự động extract token từ URL hash và tạo session
6. Trang `/reset-password` kiểm tra session và hiển thị form nhập password mới
7. User nhập password mới → Gọi `supabase.auth.updateUser({ password: newPassword })`
8. Password được cập nhật và user được redirect về trang chính

## Implementation

### Client Configuration

File: `src/services/supabase/client.ts`

```typescript
import { createBrowserClient } from "@supabase/ssr";

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
    // Using default implicit flow (not PKCE) for password reset
  );
}
```

**Lý do không dùng PKCE**: PKCE yêu cầu code_verifier trong localStorage, nhưng khi user click link từ email client, link thường mở trong browser/tab mới → code_verifier không tồn tại → Lỗi.

### Session Verification Hook

File: `src/features/auth/hooks/usePasswordResetSession.ts`

Hook này kiểm tra xem user có session hợp lệ sau khi redirect từ email link hay không:

```typescript
export function usePasswordResetSession() {
  // Check if user has valid session (from URL hash)
  const {
    data: { session },
  } = await supabase.auth.getSession();

  if (session) {
    return { isReady: true }; // Allow password reset
  } else {
    return { isError: true }; // Show error message
  }
}
```

### Middleware

File: `src/services/supabase/middleware.ts`

```typescript
const PUBLIC_PATHS = [
  "/login",
  "/forgot-password",
  "/reset-password", // ← Public để cho phép truy cập
  "/api/public",
  "/complete-profile",
];
```

Trang `/reset-password` là public path để user có thể truy cập sau khi click link từ email.

## Supabase Dashboard Configuration

### Email Template

**Path**: Dashboard → Authentication → Email Templates → "Reset Password"

**Template**:

```html
<h2>Reset Your Password</h2>
<p>Click the link below to reset your password:</p>
<p><a href="{{ .ConfirmationURL }}">Reset Password</a></p>
```

**Quan trọng**:

- Phải dùng `{{ .ConfirmationURL }}`
- KHÔNG dùng `{{ .TokenHash }}` hay `{{ .Token }}`
- `{{ .ConfirmationURL }}` tự động tạo URL với access_token trong hash fragment

### Redirect URLs

**Path**: Dashboard → Authentication → URL Configuration → Redirect URLs

Thêm:

```
http://localhost:3000/reset-password
http://localhost:3000/*
https://yourdomain.com/reset-password
https://yourdomain.com/*
```

### Site URL

**Path**: Dashboard → Authentication → URL Configuration → Site URL

- Development: `http://localhost:3000`
- Production: `https://yourdomain.com`

## Testing

### Local Development

1. Start dev server:

   ```bash
   npm run dev
   ```

2. Truy cập: http://localhost:3000/forgot-password

3. Nhập email và gửi

4. Check email trong Mailpit: http://localhost:54324

5. Click link trong email

6. Xác nhận:
   - URL có dạng: `http://localhost:3000/reset-password#access_token=...&type=recovery`
   - Form nhập password mới hiển thị
   - Sau khi đặt password mới thành công → Redirect về trang chính

## Important Notes

1. **Implicit Flow vs PKCE**:

   - Implicit flow: Token trong URL hash (`#access_token=...`)
   - PKCE flow: Code trong query params (`?code=...`)
   - Password reset dùng implicit flow vì đơn giản và hoạt động cross-browser/tab

2. **Security**:

   - Link chỉ sử dụng được 1 lần
   - Link hết hạn sau 60 phút
   - Access token trong hash không được gửi lên server (client-side only)

3. **Browser Compatibility**:
   - Hoạt động trên mọi browser modern
   - Không phụ thuộc vào localStorage
   - Link có thể click từ bất kỳ email client nào

## Troubleshooting

### Lỗi: "Liên kết không hợp lệ hoặc đã hết hạn"

**Nguyên nhân**:

- Email template chưa dùng `{{ .ConfirmationURL }}`
- Link đã được sử dụng hoặc hết hạn
- Redirect URL chưa được whitelist

**Giải pháp**:

- Kiểm tra lại email template trên Dashboard
- Yêu cầu link mới từ trang forgot-password
- Thêm redirect URL vào whitelist

### Lỗi: "Session expired"

**Nguyên nhân**: User mở link sau 60 phút

**Giải pháp**: Yêu cầu link mới

## References

- [Supabase Auth - Password Reset](https://supabase.com/docs/guides/auth/passwords#resetting-a-users-password-forgot-password)
- [Supabase Auth - Email Templates](https://supabase.com/docs/guides/auth/auth-email-templates)
- [Supabase Auth - Redirect URLs](https://supabase.com/docs/guides/auth/redirect-urls)
