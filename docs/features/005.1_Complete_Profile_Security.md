# Complete Profile - Invite Verification Fix

## ğŸ”’ Security Issue Fixed

### Váº¥n Ä‘á» trÆ°á»›c Ä‘Ã¢y:

- Trang `/complete-profile` chá»‰ cáº§n `employeeId` trong URL query params
- KhÃ´ng verify invite token tá»« Supabase
- Báº¥t ká»³ ai biáº¿t `employeeId` Ä‘á»u cÃ³ thá»ƒ complete profile

### Giáº£i phÃ¡p:

- Verify session tá»« invite link cá»§a Supabase
- Extract `employeeId` tá»« `user_metadata` trong session (Ä‘Æ°á»£c set khi invite)
- Cháº·n truy cáº­p náº¿u khÃ´ng cÃ³ session há»£p lá»‡

---

## ğŸ¯ Implementation

### 1. **New Hook: `useInviteVerification`**

**File**: `src/features/auth/hooks/useInviteVerification.ts`

```typescript
export function useInviteVerification() {
  // Check if user has valid session from invite link
  const {
    data: { session },
  } = await supabase.auth.getSession();

  if (!session) {
    return { isError: true, errorMessage: "Link khÃ´ng há»£p lá»‡" };
  }

  // Extract employeeId from metadata (set during inviteUserByEmail)
  const employeeId = session.user.user_metadata?.employeeId;

  return { isVerified: true, employeeId };
}
```

**Returns:**

- `isLoading`: Äang verify session
- `isVerified`: Session há»£p lá»‡ vÃ  cÃ³ `employeeId`
- `isError`: Link khÃ´ng há»£p lá»‡ hoáº·c háº¿t háº¡n
- `errorMessage`: Chi tiáº¿t lá»—i
- `employeeId`: ID tá»« metadata (null náº¿u khÃ´ng cÃ³)

### 2. **Updated Complete Profile Page**

**File**: `src/app/(auth)/complete-profile/page.tsx`

**Changes:**

```typescript
// âŒ BEFORE: Láº¥y employeeId tá»« URL (khÃ´ng secure)
const employeeId = searchParams?.get("employeeId");

// âœ… AFTER: Verify invite vÃ  láº¥y employeeId tá»« auth metadata
const inviteVerification = useInviteVerification();
const employeeId = inviteVerification.employeeId;

// Show error if verification failed
if (inviteVerification.isError) {
  return <Empty description={inviteVerification.errorMessage} />;
}
```

### 3. **Invite Flow (No Changes Needed)**

**Server-side**: `src/server/services/employee/createEmployee.ts`

```typescript
// Gá»­i invite email vá»›i metadata
await client.auth.admin.inviteUserByEmail(email, {
  redirectTo: buildInviteRedirectUrl(employeeId),
  data: {
    employeeId: employeeId, // â† LÆ°u vÃ o user_metadata
    role: role,
  },
});
```

**Supabase tá»± Ä‘á»™ng:**

1. Gá»­i email vá»›i magic link chá»©a invite code
2. User click link â†’ Redirect vá» `/complete-profile?code=xxx`
3. Supabase client tá»± Ä‘á»™ng exchange code â†’ Create session
4. Session chá»©a `user_metadata.employeeId`

---

## ğŸ”„ Complete Flow

```
1. Admin táº¡o employee vá»›i email
   â†“
2. inviteUserByEmail() gá»­i email vá»›i:
   - redirectTo: http://localhost:3000/complete-profile
   - data: { employeeId: "xxx", role: "employee" }
   â†“
3. Supabase gá»­i email vá»›i link:
   http://localhost:3000/complete-profile?code=invite_code_xxx
   â†“
4. User click link â†’ Browser request vá»›i ?code=xxx
   â†“
5. Supabase client (táº¡i page) tá»± Ä‘á»™ng:
   - Exchange code â†’ Create session
   - Session.user.user_metadata = { employeeId: "xxx", role: "employee" }
   â†“
6. useInviteVerification() verify:
   - Check session exists
   - Extract employeeId tá»« metadata
   - Return { isVerified: true, employeeId: "xxx" }
   â†“
7. Page fetch employee data vá»›i verified employeeId
   â†“
8. User complete profile â†’ Success
```

---

## ğŸ›¡ï¸ Security Benefits

### Before Fix:

```
âŒ URL: /complete-profile?employeeId=abc-123
âŒ Anyone with employeeId can access
âŒ No authentication required
âŒ Can guess/enumerate employeeIds
```

### After Fix:

```
âœ… URL: /complete-profile?code=secure_invite_code
âœ… Must have valid invite session
âœ… employeeId from trusted metadata (not URL)
âœ… Cannot guess/enumerate (code is random)
âœ… Link expires after use or timeout
âœ… One-time use only
```

---

## ğŸ§ª Testing

### Local Development:

1. **Create employee with email:**

   ```bash
   POST /api/v1/employees
   {
     "fullName": "Test Employee",
     "email": "test@example.com",
     "role": "employee",
     "clinicId": "clinic-uuid"
   }
   ```

2. **Check email in Mailpit:**

   ```
   http://localhost:54324
   ```

3. **Click invite link from email:**

   ```
   Should redirect to: /complete-profile?code=xxx&type=invite
   ```

4. **Verify session created:**

   - Open browser DevTools â†’ Console
   - Check: `supabase.auth.getSession()`
   - Should see: `user.user_metadata.employeeId`

5. **Complete profile:**
   - Fill form
   - Submit
   - Should update employee and set password

### Security Tests:

**Test 1: Old URL format (should fail)**

```
âŒ /complete-profile?employeeId=abc-123
â†’ Should show error: "Link khÃ´ng há»£p lá»‡"
```

**Test 2: Invalid code (should fail)**

```
âŒ /complete-profile?code=invalid_code
â†’ Should show error: "Link Ä‘Ã£ háº¿t háº¡n"
```

**Test 3: Expired link (should fail)**

```
âŒ Click old invite link (>24h)
â†’ Should show error: "Link Ä‘Ã£ háº¿t háº¡n"
```

**Test 4: Reuse link (should fail)**

```
âŒ Click same invite link twice
â†’ First: Success
â†’ Second: "Link Ä‘Ã£ háº¿t háº¡n" or redirect to dashboard
```

---

## ğŸ“‹ Supabase Configuration

### Email Template

**Path**: Dashboard â†’ Authentication â†’ Email Templates â†’ "Invite User"

**Default template** (no changes needed):

```html
<h2>You have been invited</h2>
<p>
  You have been invited to join {{ .SiteURL }}. Follow this link to accept the
  invite:
</p>
<p><a href="{{ .ConfirmationURL }}">Accept the invite</a></p>
```

**Important:**

- `{{ .ConfirmationURL }}` automatically includes the secure invite code
- Supabase handles code generation and expiration
- No custom token logic needed

### Redirect URLs

**Path**: Dashboard â†’ Authentication â†’ URL Configuration

**Add these URLs:**

```
http://localhost:3000/complete-profile
http://localhost:3000/*
https://yourdomain.com/complete-profile
https://yourdomain.com/*
```

### Site URL

```
Development: http://localhost:3000
Production: https://yourdomain.com
```

---

## ğŸ”§ Files Changed

| File                                               | Changes                                       | Status              |
| -------------------------------------------------- | --------------------------------------------- | ------------------- |
| `src/features/auth/hooks/useInviteVerification.ts` | New hook to verify invite session             | âœ… Created          |
| `src/features/auth/index.ts`                       | Export new hook                               | âœ… Updated          |
| `src/app/(auth)/complete-profile/page.tsx`         | Use invite verification instead of URL params | âœ… Updated          |
| `src/services/supabase/middleware.ts`              | Already allows `/complete-profile` as public  | âœ… No change needed |

---

## ğŸ“ Key Differences: Invite vs Reset Password

| Feature            | Invite (`inviteUserByEmail`) | Reset Password (`resetPasswordForEmail`) |
| ------------------ | ---------------------------- | ---------------------------------------- |
| **Method**         | `admin.inviteUserByEmail()`  | `resetPasswordForEmail()`                |
| **URL Pattern**    | `?code=xxx&type=invite`      | `#access_token=xxx&type=recovery`        |
| **Session**        | Created from invite code     | Created from access token                |
| **Metadata**       | Can pass custom data         | No custom data                           |
| **Use Case**       | New user onboarding          | Existing user password reset             |
| **Admin Required** | Yes (admin client)           | No (public method)                       |

---

## âœ… Benefits

1. **Security**: Cannot access without valid invite session
2. **Simple**: Leverages Supabase built-in invite flow
3. **Maintainable**: No custom token management
4. **Reliable**: Supabase handles expiration and one-time use
5. **Consistent**: Similar pattern to reset password flow

---

**Status**: âœ… Secure invite verification implemented!
