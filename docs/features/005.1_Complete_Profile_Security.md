# Complete Profile - Invite Verification Fix

## üîí Security Issue Fixed

### V·∫•n ƒë·ªÅ tr∆∞·ªõc ƒë√¢y:

- Trang `/complete-profile` ch·ªâ c·∫ßn `employeeId` trong URL query params
- Kh√¥ng verify invite token t·ª´ Supabase
- B·∫•t k·ª≥ ai bi·∫øt `employeeId` ƒë·ªÅu c√≥ th·ªÉ complete profile

### Gi·∫£i ph√°p:

- Verify session t·ª´ invite link c·ªßa Supabase
- Extract `employeeId` t·ª´ `user_metadata` trong session (ƒë∆∞·ª£c set khi invite)
- Ch·∫∑n truy c·∫≠p n·∫øu kh√¥ng c√≥ session h·ª£p l·ªá

---

## üéØ Implementation

### 1. **New Hook: `useInviteVerification`**

**File**: `src/features/auth/hooks/useInviteVerification.ts`

```typescript
export function useInviteVerification() {
  // Step 1: Check if URL has token_hash parameter
  const tokenHash = searchParams.get("token_hash");
  const type = searchParams.get("type");
  
  if (tokenHash && type === "invite") {
    // Step 2: Verify token with Supabase and create session
    const { data, error } = await supabase.auth.verifyOtp({
      token_hash: tokenHash,
      type: "invite",
    });
    
    if (error || !data.session) {
      return { isError: true, errorMessage: "Link kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n" };
    }
    
    // Step 3: Extract employeeId from metadata (set during inviteUserByEmail)
    const employeeId = data.session.user.user_metadata?.employeeId;
    return { isVerified: true, employeeId };
  }
  
  // Fallback: Check existing session (if already verified)
  const { data: { session } } = await supabase.auth.getSession();
  const employeeId = session?.user.user_metadata?.employeeId;
  
  return session ? { isVerified: true, employeeId } : { isError: true };
}
```

**Returns:**

- `isLoading`: ƒêang verify session
- `isVerified`: Session h·ª£p l·ªá v√† c√≥ `employeeId`
- `isError`: Link kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt h·∫°n
- `errorMessage`: Chi ti·∫øt l·ªói
- `employeeId`: ID t·ª´ metadata (null n·∫øu kh√¥ng c√≥)

### 2. **Updated Complete Profile Page**

**File**: `src/app/(auth)/complete-profile/page.tsx`

**Changes:**

```typescript
// ‚ùå BEFORE: L·∫•y employeeId t·ª´ URL (kh√¥ng secure)
const employeeId = searchParams?.get("employeeId");

// ‚úÖ AFTER: Verify invite v√† l·∫•y employeeId t·ª´ auth metadata
const inviteVerification = useInviteVerification();
const employeeId = inviteVerification.employeeId;

// Show error if verification failed
if (inviteVerification.isError) {
  return <Empty description={inviteVerification.errorMessage} />;
}
```

### 3. **Invite Flow**

**Server-side**: `src/server/services/employee/createEmployee.ts`

```typescript
// G·ª≠i invite email v·ªõi metadata
await client.auth.admin.inviteUserByEmail(email, {
  data: {
    employeeId: employeeId, // ‚Üê L∆∞u v√†o user_metadata
    role: role,
  },
});
```

**Email template handles URL:**
- Template: `{{ .SiteURL }}/complete-profile?token_hash={{ .TokenHash }}&type=invite`
- Result: `https://drdee-antd.vercel.app/complete-profile?token_hash=xxx&type=invite`

**Supabase t·ª± ƒë·ªông:**

1. G·ª≠i email v·ªõi magic link ch·ª©a invite code
2. User click link ‚Üí Redirect v·ªÅ `/complete-profile?code=xxx`
3. Supabase client t·ª± ƒë·ªông exchange code ‚Üí Create session
4. Session ch·ª©a `user_metadata.employeeId`

---

## üîÑ Complete Flow

```
1. Admin t·∫°o employee v·ªõi email
   ‚Üì
2. inviteUserByEmail() g·ª≠i email v·ªõi:
   - redirectTo: http://localhost:3000/complete-profile
   - data: { employeeId: "xxx", role: "employee" }
   ‚Üì
3. Supabase g·ª≠i email v·ªõi link:
   http://localhost:3000/complete-profile?token_hash=xxx&type=invite
   ‚Üì
4. User click link ‚Üí Browser request v·ªõi ?token_hash=xxx
   ‚Üì
5. useInviteVerification() at page:
   - Extract token_hash from URL
   - Call verifyOtp(token_hash, type: "invite")
   - Supabase creates session
   - Session.user.user_metadata = { employeeId: "xxx", role: "employee" }
   ‚Üì
6. Hook returns:
   - { isVerified: true, employeeId: "xxx" }
   ‚Üì
7. Page fetch employee data v·ªõi verified employeeId
   ‚Üì
8. User complete profile ‚Üí Success
```

---

## üõ°Ô∏è Security Benefits

### Before Fix:

```
‚ùå URL: /complete-profile?employeeId=abc-123
‚ùå Anyone with employeeId can access
‚ùå No authentication required
‚ùå Can guess/enumerate employeeIds
```

### After Fix:

```
‚úÖ URL: /complete-profile?code=secure_invite_code
‚úÖ Must have valid invite session
‚úÖ employeeId from trusted metadata (not URL)
‚úÖ Cannot guess/enumerate (code is random)
‚úÖ Link expires after use or timeout
‚úÖ One-time use only
```

---

## üß™ Testing

### Local Development:

1. **Create employee with email:**

   ```bash
   POST /api/v1/employees
   {
     "fullName": "Test Employee",
     "email": "test@example.com",
     "role": "employee",
     "clinicId": "clinic-uuid"
   }
   ```

2. **Check email in Mailpit:**

   ```
   http://localhost:54324
   ```

3. **Click invite link from email:**

   ```
   Should redirect to: /complete-profile?code=xxx&type=invite
   ```

4. **Verify session created:**

   - Open browser DevTools ‚Üí Console
   - Check: `supabase.auth.getSession()`
   - Should see: `user.user_metadata.employeeId`

5. **Complete profile:**
   - Fill form
   - Submit
   - Should update employee and set password

### Security Tests:

**Test 1: Old URL format (should fail)**

```
‚ùå /complete-profile?employeeId=abc-123
‚Üí Should show error: "Link kh√¥ng h·ª£p l·ªá"
```

**Test 2: Invalid code (should fail)**

```
‚ùå /complete-profile?code=invalid_code
‚Üí Should show error: "Link ƒë√£ h·∫øt h·∫°n"
```

**Test 3: Expired link (should fail)**

```
‚ùå Click old invite link (>24h)
‚Üí Should show error: "Link ƒë√£ h·∫øt h·∫°n"
```

**Test 4: Reuse link (should fail)**

```
‚ùå Click same invite link twice
‚Üí First: Success
‚Üí Second: "Link ƒë√£ h·∫øt h·∫°n" or redirect to dashboard
```

---

## üìã Supabase Configuration

### Email Template

**Path**: Dashboard ‚Üí Authentication ‚Üí Email Templates ‚Üí "Invite User"

**Default template** (no changes needed):

```html
<h2>You have been invited</h2>
<p>
  You have been invited to join {{ .SiteURL }}. Follow this link to accept the
  invite:
</p>
<p><a href="{{ .ConfirmationURL }}">Accept the invite</a></p>
```

**Important:**

- `{{ .ConfirmationURL }}` automatically includes the secure invite code
- Supabase handles code generation and expiration
- No custom token logic needed

### Redirect URLs

**Path**: Dashboard ‚Üí Authentication ‚Üí URL Configuration

**Add these URLs:**

```
http://localhost:3000/complete-profile
http://localhost:3000/*
https://yourdomain.com/complete-profile
https://yourdomain.com/*
```

### Site URL

```
Development: http://localhost:3000
Production: https://yourdomain.com
```

---

## üîß Files Changed

| File                                               | Changes                                       | Status              |
| -------------------------------------------------- | --------------------------------------------- | ------------------- |
| `src/features/auth/hooks/useInviteVerification.ts` | New hook to verify invite session             | ‚úÖ Created          |
| `src/features/auth/index.ts`                       | Export new hook                               | ‚úÖ Updated          |
| `src/app/(auth)/complete-profile/page.tsx`         | Use invite verification instead of URL params | ‚úÖ Updated          |
| `src/services/supabase/middleware.ts`              | Already allows `/complete-profile` as public  | ‚úÖ No change needed |

---

## üéì Key Differences: Invite vs Reset Password

| Feature            | Invite (`inviteUserByEmail`) | Reset Password (`resetPasswordForEmail`) |
| ------------------ | ---------------------------- | ---------------------------------------- |
| **Method**         | `admin.inviteUserByEmail()`  | `resetPasswordForEmail()`                |
| **URL Pattern**    | `?code=xxx&type=invite`      | `#access_token=xxx&type=recovery`        |
| **Session**        | Created from invite code     | Created from access token                |
| **Metadata**       | Can pass custom data         | No custom data                           |
| **Use Case**       | New user onboarding          | Existing user password reset             |
| **Admin Required** | Yes (admin client)           | No (public method)                       |

---

## ‚úÖ Benefits

1. **Security**: Cannot access without valid invite session
2. **Simple**: Leverages Supabase built-in invite flow
3. **Maintainable**: No custom token management
4. **Reliable**: Supabase handles expiration and one-time use
5. **Consistent**: Similar pattern to reset password flow

---

**Status**: ‚úÖ Secure invite verification implemented!
