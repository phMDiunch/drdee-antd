# ğŸ§© Requirements: Customer Daily - Quick Check-in

> **ğŸ“Š STATUS: âœ… IMPLEMENTED**  
> **ğŸ“„ Dependencies**: Customer (007), Appointment (008)  
> **ğŸ”— Implementation**: Customer Daily View actions column
> **ğŸ”§ Last Updated**: 2025-11-03 - Implementation complete with walk-in support

## ğŸ“Š Tham kháº£o

- **Old Requirements**:
  - `docs/Dá»± Ã¡n cÅ©/07. customers/CUSTOMER_DETAIL_REQUIREMENTS.md` Section 6.5
  - `docs/Dá»± Ã¡n cÅ©/08. appointment/appointment-old-claude.md` Section III.B
  - `docs/Dá»± Ã¡n cÅ©/08. appointment/appointment-old-codex.md` Section 6.5

## ğŸ¯ Má»¥c TiÃªu

Cho phÃ©p check-in nhanh khÃ¡ch hÃ ng ngay tá»« Customer Daily View, khÃ´ng cáº§n vÃ o chi tiáº¿t appointment.

---

## 1. ğŸ“Š Backend Requirements

### 1.1 API Enhancement: GET /api/v1/customers/daily

**Changes needed:**

```typescript
// src/app/api/v1/customers/daily/route.ts
// Add optional query param: includeAppointments

interface GetCustomersDailyQuery {
  date: string; // Existing
  clinicId: string; // Existing
  includeAppointments?: string; // NEW - "true" | "false", default "false"
}
```

**Response schema update:**

```typescript
// src/shared/validation/customer.schema.ts
// Create new schema for daily response with appointments

export const CustomerDailyResponseSchema = CustomerResponseSchema.extend({
  todayAppointment: z
    .object({
      id: z.string(),
      appointmentDateTime: z.coerce.date(),
      status: z.string(),
      checkInTime: z.coerce.date().nullable(),
      checkOutTime: z.coerce.date().nullable(),
      primaryDentist: z.object({
        id: z.string(),
        fullName: z.string(),
      }),
    })
    .nullable()
    .optional(),
});

export type CustomerDailyResponse = z.infer<typeof CustomerDailyResponseSchema>;
```

**Backend logic:**

```typescript
// src/server/repos/customer.repo.ts
// Add method: listDaily vá»›i optional includeAppointments

async listDaily(params: {
  date: string;              // Customer createdAt filter (selectedDate)
  clinicId?: string;
  includeAppointments?: boolean;
}) {
  const where = { /* filter customers by params.date */ };

  const include = includeAppointments ? {
    appointments: {
      where: {
        appointmentDateTime: {
          gte: startOfDay(TODAY),    // âœ… Always query TODAY appointments, not params.date
          lt: endOfDay(TODAY),        // âœ… For check-in logic (current day only)
        },
      },
      take: 1,
      include: {
        primaryDentist: {
          select: { id: true, fullName: true },
        },
      },
    },
  } : undefined;

  const items = await prisma.customer.findMany({ where, include });

  // Transform: appointments[0] â†’ todayAppointment
  return items.map(item => ({
    ...item,
    todayAppointment: item.appointments?.[0] || null,  // Appointment of TODAY
  }));
}
```

**âš ï¸ QUAN TRá»ŒNG - Query Logic:**

- **Customer filter**: Theo `params.date` (selectedDate) - Hiá»ƒn thá»‹ customers táº¡o ngÃ y nÃ o
- **Appointment filter**: Theo `TODAY` (current date) - Check-in chá»‰ cho lá»‹ch hÃ´m nay
- **LÃ½ do**: User chá»n ngÃ y 05/11 xem customers cÅ©, nhÆ°ng check-in pháº£i cho lá»‹ch 08/11 (TODAY)

````

### 1.2 Quick Check-in: Reuse Existing Update API

**NO NEW API NEEDED** - Reuse existing pattern:

```typescript
// PUT /api/v1/appointments/[id] (existing endpoint)
// Body: { checkInTime: new Date(), status: "ÄÃ£ Ä‘áº¿n" }
````

**Pattern Ä‘Ã£ cÃ³ sáºµn:**

- âœ… `useUpdateAppointment()` hook detect `checkInTime` trong body â†’ show "Check-in thÃ nh cÃ´ng"
- âœ… Backend validation trong `appointment.service.ts` Ä‘Ã£ handle permissions
- âœ… No need for dedicated `/checkin` endpoint

### 1.3 Walk-in: Reuse Existing Create API

**NO NEW VALIDATION** - Reuse existing:

```typescript
// POST /api/v1/appointments (existing endpoint)
// Body: CreateAppointmentRequest vá»›i status = "Äáº¿n Ä‘á»™t xuáº¥t"
```

**Implementation Details:**

- âœ… Status "Äáº¿n Ä‘á»™t xuáº¥t" treated same as "ÄÃ£ Ä‘áº¿n" (marker only)
- âœ… Frontend set `appointmentDateTime = now()`, `checkInTime = now()`
- âœ… Backend allows appointment creation within **2 minutes** (network latency tolerance)
- âœ… No special exception for walk-in - standard validation applies
- âœ… Conflict check: 1 customer/1 appointment/day (includes walk-in)

---

## 2. ğŸ¨ Frontend Implementation

### 2.1 File Structure

```
src/features/customers/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ CustomerTable.tsx (UPDATE - add actions column)
â”‚   â”œâ”€â”€ QuickCheckInButton.tsx (NEW)
â”‚   â””â”€â”€ WalkInModal.tsx (NEW)
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useCustomersDaily.ts (UPDATE - support includeAppointments)
â””â”€â”€ api/
    â””â”€â”€ getCustomersDaily.ts (UPDATE - add query param)
```

### 2.2 API Layer Update

```typescript
// src/features/customers/api/getCustomersDaily.ts
export type GetCustomersDailyParams = {
  date?: string;
  clinicId?: string;
  includeAppointments?: boolean; // NEW
};

export async function getCustomersDailyApi(params?: GetCustomersDailyParams) {
  const query = new URLSearchParams();
  if (params?.date) query.set("date", params.date);
  if (params?.clinicId) query.set("clinicId", params.clinicId);
  if (params?.includeAppointments) query.set("includeAppointments", "true"); // NEW

  // ... rest stays same

  // Parse with CustomerDailyResponseSchema if includeAppointments
  const schema = params?.includeAppointments
    ? z.object({
        items: z.array(CustomerDailyResponseSchema),
        count: z.number(),
      })
    : CustomersListResponseSchema;

  const parsed = schema.safeParse(json);
  // ...
}
```

### 2.3 Hook Update

```typescript
// src/features/customers/hooks/useCustomersDaily.ts
export function useCustomersDaily(params?: {
  date?: string;
  clinicId?: string;
  includeAppointments?: boolean; // NEW
}) {
  return useQuery({
    queryKey: ["customers", "daily", params], // Auto include includeAppointments in key
    queryFn: () => getCustomersDailyApi(params),
    staleTime: 30_000,
  });
}
```

### 2.4 CustomerTable Component Update

```typescript
// src/features/customers/components/CustomerTable.tsx
import QuickCheckInButton from "./QuickCheckInButton";

type Props = {
  data: CustomerResponse[];
  loading?: boolean;
  showCheckIn?: boolean; // NEW - cho Daily View
  selectedDate?: string; // NEW - for check-in context
};

export default function CustomerTable({
  data,
  loading,
  showCheckIn = false,
  selectedDate,
}: Props) {
  const columns: ColumnsType<CustomerResponse> = [
    // ... existing columns
    {
      title: "Thao tÃ¡c",
      key: "actions",
      width: 150,
      render: (_, record) => (
        <Space>
          {showCheckIn && selectedDate && (
            <QuickCheckInButton
              customer={record as CustomerDailyResponse}
              date={selectedDate}
            />
          )}
          {/* Future: Detail view link */}
        </Space>
      ),
    },
  ];

  // ... rest stays same
}
```

### 2.5 QuickCheckInButton Component (NEW)

```typescript
// src/features/customers/components/QuickCheckInButton.tsx
"use client";
import { useState } from "react";
import { Button } from "antd";
import { CheckCircleOutlined } from "@ant-design/icons";
import { useUpdateAppointment } from "@/features/appointments";
import { useQueryClient } from "@tanstack/react-query";
import WalkInModal from "./WalkInModal";
import type { CustomerDailyResponse } from "@/shared/validation/customer.schema";

type Props = {
  customer: CustomerDailyResponse;
  date: string; // YYYY-MM-DD
};

export default function QuickCheckInButton({ customer, date }: Props) {
  const [openWalkIn, setOpenWalkIn] = useState(false);
  const updateMutation = useUpdateAppointment();
  const qc = useQueryClient();

  const { todayAppointment } = customer;

  const handleCheckIn = async () => {
    if (!todayAppointment) return;

    await updateMutation.mutateAsync({
      id: todayAppointment.id,
      body: {
        checkInTime: new Date(),
        status: "ÄÃ£ Ä‘áº¿n",
      },
    });

    // Refetch daily list to update button state
    qc.invalidateQueries({ queryKey: ["customers", "daily"] });
  };

  // Case 1: ÄÃ£ check-in
  if (todayAppointment?.checkInTime) {
    return (
      <Button size="small" disabled icon={<CheckCircleOutlined />}>
        ÄÃ£ check-in
      </Button>
    );
  }

  // Case 2: CÃ³ lá»‹ch, chÆ°a check-in
  if (todayAppointment) {
    return (
      <Button
        type="primary"
        size="small"
        icon={<CheckCircleOutlined />}
        loading={updateMutation.isPending}
        onClick={handleCheckIn}
      >
        Check-in
      </Button>
    );
  }

  // Case 3: KhÃ´ng cÃ³ lá»‹ch - Walk-in
  return (
    <>
      <Button
        type="primary"
        size="small"
        icon={<CheckCircleOutlined />}
        onClick={() => setOpenWalkIn(true)}
      >
        Check-in
      </Button>

      <WalkInModal
        open={openWalkIn}
        customer={customer}
        date={date}
        onClose={() => setOpenWalkIn(false)}
      />
    </>
  );
}
```

### 2.6 WalkInModal Component (NEW)

```typescript
// src/features/customers/components/WalkInModal.tsx
"use client";
import { Modal, Form, Select } from "antd";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useCreateAppointment } from "@/features/appointments";
import { useWorkingEmployees } from "@/features/employees";
import { useQueryClient } from "@tanstack/react-query";
import type { CustomerDailyResponse } from "@/shared/validation/customer.schema";

const WalkInFormSchema = z.object({
  primaryDentistId: z.string().min(1, "Vui lÃ²ng chá»n bÃ¡c sÄ©"),
  notes: z.string().optional(),
});

type WalkInForm = z.infer<typeof WalkInFormSchema>;

type Props = {
  open: boolean;
  customer: CustomerDailyResponse;
  date: string;
  onClose: () => void;
};

export default function WalkInModal({ open, customer, date, onClose }: Props) {
  const { control, handleSubmit, reset } = useForm<WalkInForm>({
    resolver: zodResolver(WalkInFormSchema),
  });

  const createMutation = useCreateAppointment();
  const { data: employees } = useWorkingEmployees({
    clinicId: customer.clinicId,
    role: "dentist",
  });
  const qc = useQueryClient();

  const onSubmit = async (formData: WalkInForm) => {
    await createMutation.mutateAsync({
      customerId: customer.id,
      clinicId: customer.clinicId,
      primaryDentistId: formData.primaryDentistId,
      appointmentDateTime: new Date(), // Now
      duration: 30,
      status: "Äáº¿n Ä‘á»™t xuáº¥t",
      notes: formData.notes,
      // Auto check-in by setting checkInTime
      checkInTime: new Date(),
    });

    // Refetch daily list
    qc.invalidateQueries({ queryKey: ["customers", "daily"] });
    reset();
    onClose();
  };

  const handleCancel = () => {
    reset();
    onClose();
  };

  return (
    <Modal
      title={`Walk-in: ${customer.fullName}`}
      open={open}
      onOk={handleSubmit(onSubmit)}
      onCancel={handleCancel}
      confirmLoading={createMutation.isPending}
      okText="XÃ¡c nháº­n Check-in"
      destroyOnHidden
    >
      <Form layout="vertical">
        <Form.Item label="Chá»n bÃ¡c sÄ© chÃ­nh" required>
          <Controller
            name="primaryDentistId"
            control={control}
            render={({ field, fieldState }) => (
              <>
                <Select
                  {...field}
                  placeholder="Chá»n bÃ¡c sÄ©"
                  options={employees?.map((e) => ({
                    label: e.fullName,
                    value: e.id,
                  }))}
                  status={fieldState.error ? "error" : undefined}
                />
                {fieldState.error && (
                  <div style={{ color: "red", fontSize: 12, marginTop: 4 }}>
                    {fieldState.error.message}
                  </div>
                )}
              </>
            )}
          />
        </Form.Item>

        <Form.Item label="Ghi chÃº">
          <Controller
            name="notes"
            control={control}
            render={({ field }) => (
              <Input.TextArea
                {...field}
                rows={3}
                placeholder="Ghi chÃº (náº¿u cÃ³)"
              />
            )}
          />
        </Form.Item>
      </Form>
    </Modal>
  );
}
```

### 2.7 CustomerDailyView Update

```typescript
// src/features/customers/views/CustomerDailyView.tsx
export default function CustomerDailyView() {
  // ... existing code

  const { data, isLoading } = useCustomersDaily({
    date: selectedDate.format("YYYY-MM-DD"),
    clinicId: selectedClinicId,
    includeAppointments: true, // NEW - enable check-in feature
  });

  return (
    <div>
      {/* ... existing components */}

      <CustomerTable
        data={items}
        loading={isLoading}
        showCheckIn={true} // NEW
        selectedDate={selectedDate.format("YYYY-MM-DD")} // NEW
      />

      {/* ... rest */}
    </div>
  );
}

---

## 3. ğŸ”„ Data Flow

### Scenario 1: Check-in Existing Appointment

```

1. User clicks "Check-in" button
2. Call useUpdateAppointment hook
   â†’ PUT /api/v1/appointments/{id}
   â†’ Body: { checkInTime: new Date(), status: "ÄÃ£ Ä‘áº¿n" }
3. Hook detects checkInTime in body â†’ show "Check-in thÃ nh cÃ´ng"
4. Invalidate queries: ["appointments"], ["customers", "daily"]
5. Daily list refetches â†’ Button updates to "ÄÃ£ check-in" (disabled)

```

### Scenario 2: Walk-in (No Appointment)

```

1. User clicks "Check-in" button
2. Open WalkInModal
3. User chá»n bÃ¡c sÄ© + notes (optional)
4. Submit â†’ Call useCreateAppointment hook
   â†’ POST /api/v1/appointments
   â†’ Body: {
   customerId, clinicId, primaryDentistId,
   appointmentDateTime: new Date(), // Client time
   status: "Äáº¿n Ä‘á»™t xuáº¥t",
   duration: 30,
   checkInTime: new Date(), // Auto set
   notes
   }
5. Hook shows "Táº¡o lá»‹ch háº¹n thÃ nh cÃ´ng"
6. Invalidate queries: ["appointments"], ["customers", "daily"]
7. Close modal
8. Daily list refetches â†’ Button updates to "ÄÃ£ check-in" (disabled)

```

**Key Points:**
- âœ… Reuse existing hooks: `useUpdateAppointment`, `useCreateAppointment`
- âœ… Standard invalidation pattern: refetch both appointments & customers
- âœ… Notification handled by hooks (no custom logic needed)

---

## 4. ğŸ”’ Permissions

- **Employee**: Chá»‰ check-in customers thuá»™c clinic cá»§a mÃ¬nh
- **Admin**: Check-in customers cá»§a báº¥t ká»³ clinic nÃ o
- **Button visibility**: LuÃ´n hiá»ƒn thá»‹ náº¿u customer thuá»™c clinic Ä‘ang view

---

## 5. âœ… Validation & Business Rules

### Existing Appointment Check-in
- âœ… Chá»‰ check-in Ä‘Æ°á»£c appointments cá»§a ngÃ y Ä‘ang xem (date param)
- âœ… KhÃ´ng check-in láº¡i náº¿u Ä‘Ã£ cÃ³ `checkInTime`
- âœ… Status pháº£i cho phÃ©p check-in (theo Appointment business rules)

### Walk-in Creation
- âœ… Validate primaryDentistId thuá»™c clinic
- âœ… KhÃ´ng validate "1 customer/1 appointment/day" cho walk-in (allow multiple)
- âœ… appointmentDateTime = server timestamp (ignore client time)
- âœ… Auto set checkInTime ngay khi create

---

## 6. ğŸ¯ Acceptance Criteria

âœ… **Given** customer cÃ³ appointment hÃ´m nay, chÆ°a check-in
**When** click button "Check-in"
**Then** gá»i API check-in, update checkInTime, button Ä‘á»•i thÃ nh "ÄÃ£ check-in"

âœ… **Given** customer cÃ³ appointment hÃ´m nay, Ä‘Ã£ check-in
**When** load table
**Then** button hiá»ƒn thá»‹ "ÄÃ£ check-in" (disabled)

âœ… **Given** customer khÃ´ng cÃ³ appointment hÃ´m nay
**When** click button "Check-in"
**Then** má»Ÿ WalkInModal Ä‘á»ƒ chá»n bÃ¡c sÄ©

âœ… **Given** user chá»n bÃ¡c sÄ© vÃ  submit trong WalkInModal
**When** submit
**Then** táº¡o appointment má»›i vá»›i status "Äáº¿n Ä‘á»™t xuáº¥t", checkInTime = now(), close modal, refetch list

âœ… **Given** employee access
**When** xem customer cá»§a clinic khÃ¡c (khÃ´ng nÃªn xáº£y ra)
**Then** button check-in bá»‹ disable hoáº·c hidden

---

## 7. ğŸ“ Implementation Checklist

### Phase 1: Schema & Types
- [ ] `src/shared/validation/customer.schema.ts` - Add `CustomerDailyResponseSchema`
- [ ] Export type `CustomerDailyResponse` from schema

### Phase 2: Backend
- [ ] `src/app/api/v1/customers/daily/route.ts` - Add `includeAppointments` query param handling
- [ ] `src/server/repos/customer.repo.ts` - Add `includeAppointments` param to `listDaily()` method
- [ ] Add Prisma include logic for appointments relation (with date filter)
- [ ] Transform `appointments[0]` â†’ `todayAppointment` in response

### Phase 3: Frontend - API & Hooks
- [ ] `src/features/customers/api/getCustomersDaily.ts` - Add `includeAppointments` param & schema handling
- [ ] `src/features/customers/hooks/useCustomersDaily.ts` - Add `includeAppointments` to params type

### Phase 4: Frontend - Components
- [ ] `src/features/customers/components/QuickCheckInButton.tsx` - NEW component with 3 states
- [ ] `src/features/customers/components/WalkInModal.tsx` - NEW modal for dentist selection
- [ ] `src/features/customers/components/CustomerTable.tsx` - Add `showCheckIn`, `selectedDate` props, update actions column

### Phase 5: Frontend - Integration
- [ ] `src/features/customers/views/CustomerDailyView.tsx` - Pass `includeAppointments: true`, `showCheckIn`, `selectedDate` to components
- [ ] Update barrel export in `src/features/customers/index.ts` if needed (QuickCheckInButton is internal, no export)

### Phase 6: Testing
- [ ] Test Scenario 1: Check-in existing appointment
- [ ] Test Scenario 2: Walk-in (no appointment)
- [ ] Test permissions (employee vs admin)
- [ ] Test refetch & button state updates

---

## 8. ğŸ”® Implementation Notes

### Pattern Compliance âœ…

**TuÃ¢n thá»§ Guidelines:**
- âœ… **Reuse existing APIs**: DÃ¹ng PUT `/appointments/[id]` vÃ  POST `/appointments` (khÃ´ng táº¡o endpoint má»›i)
- âœ… **Reuse existing hooks**: `useUpdateAppointment`, `useCreateAppointment` (khÃ´ng táº¡o hook má»›i)
- âœ… **Zod validation**: Schema trong `customer.schema.ts`, parse á»Ÿ API layer
- âœ… **React Query**: Standard invalidation pattern, refetch queries sau mutation
- âœ… **Modal pattern**: `destroyOnHidden`, React Hook Form + zodResolver
- âœ… **Notification**: Hooks tá»± Ä‘á»™ng show notification (detection logic Ä‘Ã£ cÃ³)
- âœ… **Component organization**: Internal components (khÃ´ng export trong barrel)

**Code Quality:**
- âœ… **Clean**: TÃ¡ch component nhá» (QuickCheckInButton, WalkInModal), single responsibility
- âœ… **Dá»… Ä‘á»c**: Clear props interface, 3 states rÃµ rÃ ng (if-else), tÃªn biáº¿n descriptive
- âœ… **Dá»… maintain**: Reuse appointment hooks â†’ fix bug 1 chá»— apply cho táº¥t cáº£ features
- âœ… **Type-safe**: Zod schema â†’ `z.infer` â†’ TypeScript types, compile-time safety

### Performance Considerations

- `includeAppointments=true` **chá»‰ dÃ¹ng** trong Daily View (data Ã­t, ~10-50 customers)
- List View **khÃ´ng dÃ¹ng** (paginated, khÃ´ng cáº§n appointment data)
- Appointment include cÃ³ filter theo date â†’ khÃ´ng load toÃ n bá»™ appointments
- Client-side filter dentists tá»« `useWorkingEmployees` (cached 30min)

### Error Handling

- Backend: ServiceError â†’ HTTP status â†’ JSON `{ error }`
- Frontend: Hook catches error â†’ `useNotify().error()` â†’ AntD notification
- WalkInModal: Zod validation errors â†’ inline display dÆ°á»›i field
- Network error: Mutation `isPending` state â†’ Loading button, prevent double-submit

---

## âœ… Implementation Summary

**Completed Features:**
- âœ… Backend: `includeAppointments` parameter in GET /api/v1/customers/daily
- âœ… Backend: Walk-in validation (2-minute tolerance for past appointments)
- âœ… Schema: CustomerDailyResponseSchema with todayAppointment field
- âœ… Frontend: QuickCheckInButton component (3-state logic)
- âœ… Frontend: WalkInModal with dentist selection + search
- âœ… Frontend: CustomerTable "Lá»‹ch háº¹n hÃ´m nay" column (status + time)
- âœ… Permissions: "Äáº¿n Ä‘á»™t xuáº¥t" treated same as "ÄÃ£ Ä‘áº¿n"

**Key Implementation Details:**
- Walk-in creates appointment with `appointmentDateTime = now`, `checkInTime = now`, `status = "Äáº¿n Ä‘á»™t xuáº¥t"`
- Backend allows creation within 2 minutes to handle network latency
- "Äáº¿n Ä‘á»™t xuáº¥t" is a marker (createdAt â‰ˆ appointmentDateTime), not a special case
- All validation, permissions, and behavior same as "ÄÃ£ Ä‘áº¿n"
- UI: Cyan tag for walk-in, green tag for regular check-in

---

**Document Version**: 2.1
**Created**: November 3, 2025
**Updated**: November 3, 2025 - Implementation complete
**Status**: âœ… IMPLEMENTED
```
