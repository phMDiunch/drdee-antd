# üß© Requirements: Payment QR Code Two-Step Flow

> **üìã STATUS: üöß IN PROGRESS** - Enhancement to existing Payment feature  
> **üîó Base Feature**: `010 Payment.md`  
> **üîß Updated**: 2025-12-02

## üìä Tham kh·∫£o

- Base Requirement: `docs/requirements/010 Payment.md`
- Prisma Model: `prisma/schema.prisma` ‚Üí Clinic, PaymentVoucher
- Existing Components: `src/shared/components/QRPayment.tsx`, `src/shared/constants/payment.ts`
- Related: `004 Clinic.md` (th√™m bank info)

## üéØ M·ª•c Ti√™u

**Problem Statement**: Hi·ªán t·∫°i t·∫•t c·∫£ c√°c c∆° s·ªü ƒëang d√πng chung 1 m√£ QR code c·ªë ƒë·ªãnh, kh√¥ng ph√¢n bi·ªát ƒë∆∞·ª£c ti·ªÅn t·ª´ c∆° s·ªü n√†o.

**Solution**:

- ‚úÖ M·ªói c∆° s·ªü c√≥ **QR code ri√™ng** (l∆∞u th√¥ng tin ng√¢n h√†ng trong DB)
- ‚úÖ Quy tr√¨nh t·∫°o phi·∫øu thu chia **2 b∆∞·ªõc r√µ r√†ng**:
  - **B∆∞·ªõc 1**: Thu ng√¢n nh·∫≠p th√¥ng tin ‚Üí T·∫°o m√£ QR ‚Üí Kh√°ch qu√©t thanh to√°n
  - **B∆∞·ªõc 2**: Thu ng√¢n ki·ªÉm tra ti·ªÅn v·ªÅ ‚Üí X√°c nh·∫≠n ‚Üí Ghi nh·∫≠n phi·∫øu thu
- ‚úÖ T·∫≠n d·ª•ng logic QR code ƒë√£ c√≥, kh√¥ng duplicate code
- ‚úÖ Frontend qu·∫£n l√Ω state t·∫°m, DB ch·ªâ l∆∞u khi confirm

---

## üé≤ Decision Log

### Key Decisions

**1. QR Code per Clinic** ‚úÖ

- **Store in DB**: Th√¥ng tin ng√¢n h√†ng l∆∞u trong `Clinic` model
- **Why**: Persistent data, d√πng cho nhi·ªÅu ch·ª©c nƒÉng (print receipt, QR payment, reports)
- **Fields**: `bankName`, `bankAccountNo`, `bankAccountName`

**2. No New Payment Status** ‚úÖ

- **NO database changes** cho PaymentVoucher
- **Why**: Payment ch·ªâ t·∫°o khi ƒë√£ confirm ‚Üí simplify DB, avoid complexity
- **Frontend**: Qu·∫£n l√Ω draft state t·∫°m v·ªõi `useState`

**3. Reuse Existing QR Logic** ‚úÖ

- **Component**: `QRPayment.tsx` - refactor ƒë·ªÉ accept clinic bank info
- **Function**: `generateVietQRUrl()` - update signature ƒë·ªÉ dynamic
- **Why**: DRY principle, maintain single source of truth

**4. Two-Step Flow** ‚úÖ

- **Step 1**: Modal nh·∫≠p li·ªáu ‚Üí Generate QR ‚Üí Show QR modal
- **Step 2**: QR modal v·ªõi button "X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn" ‚Üí Create payment
- **Why**: Clear separation, prevent premature recording

---

## 1. üè• Database Changes

### Clinic Model Enhancement

**Add Bank Information Fields**:

```prisma
model Clinic {
  // ... existing fields ...

  // üÜï Th√¥ng tin ng√¢n h√†ng cho QR Code thanh to√°n
  bankName         String? // T√™n ng√¢n h√†ng (VD: "BIDV", "VCB", "TCB")
  bankAccountNo    String? // S·ªë t√†i kho·∫£n ng√¢n h√†ng
  bankAccountName  String? // T√™n ch·ªß t√†i kho·∫£n

  // ... rest of fields ...
}
```

**Migration**:

```prisma
-- Add nullable fields first, can set NOT NULL later if needed
ALTER TABLE "Clinic" ADD COLUMN "bankName" TEXT;
ALTER TABLE "Clinic" ADD COLUMN "bankAccountNo" TEXT;
ALTER TABLE "Clinic" ADD COLUMN "bankAccountName" TEXT;
```

**Seed Data Note**: Sau migration, admin c·∫ßn update th√¥ng tin ng√¢n h√†ng cho c√°c clinic hi·ªán t·∫°i.

---

## 2. üìù Schema Validation Updates

### Clinic Schema Enhancement

**File**: `src/shared/validation/clinic.schema.ts`

**Add to ClinicBaseSchema**:

```typescript
export const ClinicBaseSchema = z.object({
  // ... existing fields ...

  // üÜï Bank information for QR code
  bankName: z
    .string()
    .trim()
    .min(1, "T√™n ng√¢n h√†ng l√† b·∫Øt bu·ªôc")
    .optional()
    .nullable(),
  bankAccountNo: z
    .string()
    .trim()
    .min(5, "S·ªë t√†i kho·∫£n kh√¥ng h·ª£p l·ªá")
    .optional()
    .nullable(),
  bankAccountName: z
    .string()
    .trim()
    .min(1, "T√™n ch·ªß t√†i kho·∫£n l√† b·∫Øt bu·ªôc")
    .optional()
    .nullable(),
});
```

**Validation Rules**:

- All fields optional (nullable) - kh√¥ng b·∫Øt bu·ªôc khi t·∫°o clinic m·ªõi
- `bankAccountNo`: min 5 characters (cover most bank account formats)
- Frontend s·∫Ω validate ƒë·∫ßy ƒë·ªß khi admin nh·∫≠p

**Impact**:

- ‚úÖ `CreateClinicRequestSchema` - auto include (omit archivedAt only)
- ‚úÖ `UpdateClinicRequestSchema` - auto include
- ‚úÖ `ClinicResponseSchema` - c·∫ßn add manually

---

## 3. üé® Clinic Management UI Updates

### ClinicFormModal Enhancement

**Component**: `src/features/clinics/components/ClinicFormModal.tsx`

**Add Bank Info Section** (sau address, phone, email):

```tsx
{
  /* Divider */
}
<Col xs={24}>
  <Divider orientation="left">Th√¥ng tin ng√¢n h√†ng (cho QR thanh to√°n)</Divider>
</Col>;

{
  /* Bank Name */
}
<Col xs={24} lg={8}>
  <Controller
    name="bankName"
    control={control}
    render={({ field, fieldState }) => (
      <Form.Item
        label="T√™n ng√¢n h√†ng"
        validateStatus={fieldState.error ? "error" : ""}
        help={fieldState.error?.message}
      >
        <Input {...field} placeholder="VD: BIDV, VCB, TCB..." maxLength={50} />
      </Form.Item>
    )}
  />
</Col>;

{
  /* Account Number */
}
<Col xs={24} lg={8}>
  <Controller
    name="bankAccountNo"
    control={control}
    render={({ field, fieldState }) => (
      <Form.Item
        label="S·ªë t√†i kho·∫£n"
        validateStatus={fieldState.error ? "error" : ""}
        help={fieldState.error?.message}
      >
        <Input {...field} placeholder="VD: 2610143271" maxLength={30} />
      </Form.Item>
    )}
  />
</Col>;

{
  /* Account Name */
}
<Col xs={24} lg={8}>
  <Controller
    name="bankAccountName"
    control={control}
    render={({ field, fieldState }) => (
      <Form.Item
        label="T√™n ch·ªß t√†i kho·∫£n"
        validateStatus={fieldState.error ? "error" : ""}
        help={fieldState.error?.message}
      >
        <Input
          {...field}
          placeholder="VD: PHAM MINH DUC"
          maxLength={100}
          style={{ textTransform: "uppercase" }}
        />
      </Form.Item>
    )}
  />
</Col>;
```

**Form Layout Updated**:

```
Section 1: Th√¥ng tin c∆° b·∫£n
  H√†ng 1: [clinicCode ] [name                    ]
  H√†ng 2: [colorCode  ] [address                 ]
  H√†ng 3: [phone      ] [email                   ]

Section 2: Th√¥ng tin ng√¢n h√†ng (Divider)
  H√†ng 4: [bankName   ] [bankAccountNo           ] [bankAccountName  ]
```

**Update defaultValues**:

```typescript
const defaultClinicFormValues: CreateClinicRequest = {
  clinicCode: "",
  name: "",
  address: "",
  phone: undefined,
  email: undefined,
  colorCode: "#28B463",
  bankName: undefined, // üÜï
  bankAccountNo: undefined, // üÜï
  bankAccountName: undefined, // üÜï
};
```

---

## 4. üîÑ QR Code Generation Refactor

### Update Constants & Utils

**File**: `src/shared/constants/payment.ts`

**Refactor to support dynamic bank config**:

```typescript
/**
 * Bank Account Configuration for QR Code Payment
 * üî¥ DEPRECATED: Use clinic-specific bank info instead
 * Kept for backward compatibility with old receipts
 */
export const BANK_CONFIG = {
  BANK_NAME: "BIDV",
  ACCOUNT_NUMBER: "2610143271",
  ACCOUNT_NAME: "PHAM MINH DUC",
  TEMPLATE: "qronly",
} as const;

/**
 * Bank Configuration Type
 * Used for generating dynamic QR codes per clinic
 */
export type BankConfig = {
  bankName: string;
  accountNumber: string;
  accountName: string;
  template?: string;
};

/**
 * Generate SePay QR URL with clinic-specific bank information
 * @param amount - Payment amount in VND
 * @param description - Payment description (e.g., voucher code)
 * @param bankConfig - Bank configuration (use clinic's bank info)
 * @returns SePay QR image URL
 */
export function generateVietQRUrl(
  amount: number,
  description: string,
  bankConfig?: BankConfig // üÜï Optional, fallback to BANK_CONFIG
): string {
  const config = bankConfig || {
    bankName: BANK_CONFIG.BANK_NAME,
    accountNumber: BANK_CONFIG.ACCOUNT_NUMBER,
    accountName: BANK_CONFIG.ACCOUNT_NAME,
    template: BANK_CONFIG.TEMPLATE,
  };

  const baseUrl = "https://qr.sepay.vn/img";
  const params = new URLSearchParams({
    bank: config.bankName,
    acc: config.accountNumber,
    template: config.template || "qronly",
    amount: amount.toString(),
    des: description,
  });
  return `${baseUrl}?${params.toString()}`;
}

/**
 * Helper to convert Clinic bank info to BankConfig
 */
export function clinicToBankConfig(clinic: {
  bankName?: string | null;
  bankAccountNo?: string | null;
  bankAccountName?: string | null;
}): BankConfig | undefined {
  if (!clinic.bankName || !clinic.bankAccountNo || !clinic.bankAccountName) {
    return undefined; // Will fallback to BANK_CONFIG
  }
  return {
    bankName: clinic.bankName,
    accountNumber: clinic.bankAccountNo,
    accountName: clinic.bankAccountName,
  };
}
```

### Update QRPayment Component

**File**: `src/shared/components/QRPayment.tsx`

**Update to accept optional bank config**:

```typescript
import {
  generateVietQRUrl,
  clinicToBankConfig,
  type BankConfig,
} from "@/shared/constants/payment";

interface QRPaymentProps {
  amount: number;
  voucherCode: string;
  size?: number;
  showLabel?: boolean;
  bankConfig?: BankConfig; // üÜï Optional clinic bank config
}

export default function QRPayment({
  amount,
  voucherCode,
  size = 100,
  showLabel = false,
  bankConfig, // üÜï
}: QRPaymentProps) {
  const qrUrl = generateVietQRUrl(amount, voucherCode, bankConfig); // üÜï Pass config
  const accountName = bankConfig?.accountName || BANK_CONFIG.ACCOUNT_NAME;

  return (
    <div
      style={
        {
          /* ... */
        }
      }
    >
      <img src={qrUrl} alt={`QR thanh to√°n ${voucherCode}`} /* ... */ />
      {showLabel && (
        <div
          style={
            {
              /* ... */
            }
          }
        >
          <div style={{ fontWeight: 500 }}>Qu√©t m√£ thanh to√°n</div>
          <div>{accountName}</div> {/* üÜï Dynamic account name */}
        </div>
      )}
    </div>
  );
}
```

**Backward Compatibility**:

- N·∫øu kh√¥ng truy·ªÅn `bankConfig` ‚Üí fallback v·ªÅ `BANK_CONFIG` c≈©
- Old receipts v·∫´n ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng

---

## 5. üí∞ Two-Step Payment Flow

### Step 1: Create Payment Draft & Generate QR

**Component**: `CreatePaymentVoucherModal.tsx` (existing, c·∫ßn refactor)

**Changes**:

1. **Rename button**: "T·∫°o phi·∫øu thu" ‚Üí "T·∫°o m√£ QR thanh to√°n"
2. **onSubmit behavior**: Kh√¥ng g·ªçi API, ch·ªâ l∆∞u draft state v√† m·ªü QR modal
3. **Generate temporary code**: T·∫°o m√£ t·∫°m th·ªùi ƒë·ªÉ hi·ªÉn th·ªã trong QR (format gi·ªëng payment number)

**New State**:

```typescript
const [paymentDraft, setPaymentDraft] = useState<{
  customerId: string;
  customerName: string;
  totalAmount: number;
  details: SelectedService[];
  notes?: string;
  tempCode: string; // M√£ t·∫°m th·ªùi cho QR
} | null>(null);

const [showQRModal, setShowQRModal] = useState(false);
```

**Button Change**:

```tsx
<Button
  type="primary"
  icon={<QrcodeOutlined />}
  onClick={handleGenerateQR}
  disabled={!canGenerateQR}
>
  T·∫°o m√£ QR thanh to√°n
</Button>
```

**Generate QR Handler**:

```typescript
const handleGenerateQR = async () => {
  // Validate form
  const values = await form.validateFields();

  // Generate temporary code (same format as payment number)
  const tempCode = await generateTempPaymentCode(currentClinicId);

  // Save draft
  setPaymentDraft({
    customerId: values.customerId,
    customerName: selectedCustomer.fullName,
    totalAmount: calculateTotal(selectedServices),
    details: selectedServices,
    notes: values.notes,
    tempCode,
  });

  // Show QR modal
  setShowQRModal(true);

  // Keep current modal open (or close, depends on UX preference)
  // Option 1: Close current modal ‚Üí onCancel()
  // Option 2: Keep open behind QR modal (better for edit)
};
```

**Temp Code Generation**:

```typescript
/**
 * Generate temporary payment code for QR display
 * Format: TMP-{CLINIC_PREFIX}-{TIMESTAMP}
 * Example: TMP-MK-1733123456
 */
async function generateTempPaymentCode(clinicId: string): Promise<string> {
  const prefix = CLINIC_PREFIX_MAP[clinicId] || "XX";
  const timestamp = Date.now().toString().slice(-10);
  return `TMP-${prefix}-${timestamp}`;
}
```

### Step 2: Display QR & Confirm Payment

**New Component**: `PaymentQRConfirmModal.tsx`

**Props**:

```typescript
interface PaymentQRConfirmModalProps {
  open: boolean;
  draft: {
    customerId: string;
    customerName: string;
    totalAmount: number;
    details: SelectedService[];
    notes?: string;
    tempCode: string;
  } | null;
  clinicBankInfo: BankConfig | undefined; // From current clinic
  confirmLoading?: boolean;
  onCancel: () => void;
  onConfirm: (payload: CreatePaymentVoucherRequest) => void;
}
```

**Modal Layout** (70% width, centered):

```tsx
<Modal
  open={open}
  title="Qu√©t m√£ thanh to√°n"
  width="70%"
  footer={[
    <Button key="cancel" onClick={handleCancel}>
      H·ªßy thanh to√°n
    </Button>,
    <Button
      key="confirm"
      type="primary"
      icon={<CheckCircleOutlined />}
      loading={confirmLoading}
      onClick={handleConfirm}
    >
      ‚úì X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn
    </Button>,
  ]}
  onCancel={handleCancel}
  maskClosable={false}
  destroyOnClose
>
  <Space direction="vertical" size="large" style={{ width: "100%" }}>
    {/* QR Code Display */}
    <div style={{ textAlign: "center", padding: 24 }}>
      <QRPayment
        amount={draft?.totalAmount || 0}
        voucherCode={draft?.tempCode || ""}
        size={200} // Large size for easy scanning
        showLabel={false}
        bankConfig={clinicBankInfo} // üÜï Use clinic's bank
      />
    </div>

    {/* Bank Info Display */}
    <Card size="small" title="üì± Th√¥ng tin chuy·ªÉn kho·∫£n">
      <Descriptions column={1} size="small">
        <Descriptions.Item label="Ng√¢n h√†ng">
          {clinicBankInfo?.bankName || BANK_CONFIG.BANK_NAME}
        </Descriptions.Item>
        <Descriptions.Item label="S·ªë t√†i kho·∫£n">
          <Text copyable>
            {clinicBankInfo?.accountNumber || BANK_CONFIG.ACCOUNT_NUMBER}
          </Text>
        </Descriptions.Item>
        <Descriptions.Item label="Ch·ªß t√†i kho·∫£n">
          {clinicBankInfo?.accountName || BANK_CONFIG.ACCOUNT_NAME}
        </Descriptions.Item>
        <Descriptions.Item label="S·ªë ti·ªÅn">
          <Text strong style={{ fontSize: 18, color: "#1890ff" }}>
            {formatCurrency(draft?.totalAmount || 0)}
          </Text>
        </Descriptions.Item>
        <Descriptions.Item label="N·ªôi dung">
          <Text code>{draft?.tempCode}</Text>
        </Descriptions.Item>
      </Descriptions>
    </Card>

    {/* Payment Summary */}
    <Card size="small" title="Th√¥ng tin thanh to√°n">
      <Descriptions column={2} size="small">
        <Descriptions.Item label="Kh√°ch h√†ng" span={2}>
          {draft?.customerName}
        </Descriptions.Item>
        <Descriptions.Item label="S·ªë d·ªãch v·ª•">
          {draft?.details.length}
        </Descriptions.Item>
        <Descriptions.Item label="T·ªïng ti·ªÅn">
          {formatCurrency(draft?.totalAmount || 0)}
        </Descriptions.Item>
      </Descriptions>

      {/* Service List */}
      <div style={{ marginTop: 12 }}>
        <Text type="secondary">D·ªãch v·ª• thanh to√°n:</Text>
        <ul style={{ marginTop: 8 }}>
          {draft?.details.map((detail, idx) => (
            <li key={idx}>
              {detail.serviceName}: {formatCurrency(detail.amount)} (
              {getPaymentMethodConfig(detail.paymentMethod).label})
            </li>
          ))}
        </ul>
      </div>
    </Card>

    {/* Warning Alert */}
    <Alert
      message="‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng"
      description="Vui l√≤ng ki·ªÉm tra k·ªπ ti·ªÅn ƒë√£ v·ªÅ t√†i kho·∫£n ng√¢n h√†ng tr∆∞·ªõc khi nh·∫•n n√∫t X√°c nh·∫≠n. Sau khi x√°c nh·∫≠n, phi·∫øu thu s·∫Ω ƒë∆∞·ª£c t·∫°o v√† ƒë·ªìng b·ªô c√¥ng n·ª£."
      type="warning"
      showIcon
    />
  </Space>
</Modal>
```

**Confirm Handler**:

```typescript
const handleConfirm = () => {
  if (!draft) return;

  // Convert draft to CreatePaymentVoucherRequest
  const payload: CreatePaymentVoucherRequest = {
    customerId: draft.customerId,
    details: draft.details.map((d) => ({
      consultedServiceId: d.consultedServiceId,
      amount: d.amount,
      paymentMethod: d.paymentMethod,
      consultedServiceName: d.serviceName, // For display
    })),
    notes: draft.notes,
  };

  // Call parent handler (will create payment via Server Action)
  onConfirm(payload);
};
```

**Cancel Handler**:

```typescript
const handleCancel = () => {
  // Show confirm dialog
  Modal.confirm({
    title: "H·ªßy thanh to√°n?",
    content: "B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy? D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.",
    okText: "ƒê·ªìng √Ω",
    cancelText: "Quay l·∫°i",
    onOk: () => {
      onCancel(); // Close modal & clear draft
    },
  });
};
```

---

## 6. üîÑ Integration Flow

### Complete User Journey

```
1. Thu ng√¢n: Click "T·∫°o phi·∫øu thu"
   ‚Üí CreatePaymentVoucherModal opens

2. Thu ng√¢n: Nh·∫≠p th√¥ng tin
   - Ch·ªçn kh√°ch h√†ng
   - Ch·ªçn d·ªãch v·ª• c·∫ßn thu
   - Nh·∫≠p s·ªë ti·ªÅn & ph∆∞∆°ng th·ª©c
   - Nh·∫≠p ghi ch√∫ (optional)

3. Thu ng√¢n: Click "T·∫°o m√£ QR thanh to√°n"
   ‚Üí Validate form
   ‚Üí Generate temp code
   ‚Üí Save to draft state
   ‚Üí Open PaymentQRConfirmModal

4. Kh√°ch h√†ng: Qu√©t QR code
   ‚Üí App banking auto-fill th√¥ng tin
   ‚Üí Chuy·ªÉn kho·∫£n

5. Thu ng√¢n: Ki·ªÉm tra app banking
   ‚Üí X√°c nh·∫≠n ti·ªÅn ƒë√£ v·ªÅ
   ‚Üí Click "X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn"

6. System: Create PaymentVoucher
   ‚Üí Generate real payment number
   ‚Üí Sync debt v·ªõi ConsultedService
   ‚Üí Close modals
   ‚Üí Refresh payment list
   ‚Üí Show success message
```

### State Management

**Parent Component** (PaymentDailyView):

```typescript
const [createModalOpen, setCreateModalOpen] = useState(false);
const [qrModalOpen, setQRModalOpen] = useState(false);
const [paymentDraft, setPaymentDraft] = useState<PaymentDraft | null>(null);

// Handler for Step 1: Generate QR
const handleGenerateQR = (draft: PaymentDraft) => {
  setPaymentDraft(draft);
  setQRModalOpen(true);
  setCreateModalOpen(false); // Close input modal
};

// Handler for Step 2: Confirm payment
const handleConfirmPayment = async (payload: CreatePaymentVoucherRequest) => {
  try {
    await createPaymentVoucher(payload);
    message.success("T·∫°o phi·∫øu thu th√†nh c√¥ng!");
    setQRModalOpen(false);
    setPaymentDraft(null);
    refetchPayments();
  } catch (error) {
    message.error("L·ªói t·∫°o phi·∫øu thu: " + error.message);
  }
};

// Handler for cancel QR
const handleCancelQR = () => {
  setQRModalOpen(false);
  setCreateModalOpen(true); // Re-open input modal for edit
  // Keep draft for edit
};
```

**JSX**:

```tsx
<CreatePaymentVoucherModal
  open={createModalOpen}
  onCancel={() => {
    setCreateModalOpen(false);
    setPaymentDraft(null); // Clear draft
  }}
  onGenerateQR={handleGenerateQR} // üÜï New handler
  initialDraft={paymentDraft} // üÜï Allow edit from QR cancel
/>

<PaymentQRConfirmModal
  open={qrModalOpen}
  draft={paymentDraft}
  clinicBankInfo={clinicToBankConfig(currentClinic)}
  onCancel={handleCancelQR}
  onConfirm={handleConfirmPayment}
  confirmLoading={isCreating}
/>
```

---

## 7. üìÑ PrintableReceipt Update

### Use Clinic-Specific QR

**File**: `src/features/payments/components/PrintableReceipt.tsx`

**Update QRPayment usage**:

```tsx
{
  copyLabel === "LI√äN 2" && (
    <div>
      <QRPayment
        amount={voucher.totalAmount || 0}
        voucherCode={voucher.paymentNumber}
        size={60}
        bankConfig={clinicBankInfo} // üÜï Pass clinic bank config
      />
    </div>
  );
}
```

**Add prop to PrintableReceipt**:

```typescript
interface Props {
  voucher: PaymentVoucherResponse;
  clinicInfo?: {
    name: string;
    address: string;
    phone: string;
    logo?: string;
    // üÜï Bank info for QR
    bankName?: string;
    bankAccountNo?: string;
    bankAccountName?: string;
  };
}
```

**Convert to BankConfig**:

```typescript
const clinicBankConfig =
  clinicInfo?.bankName &&
  clinicInfo?.bankAccountNo &&
  clinicInfo?.bankAccountName
    ? {
        bankName: clinicInfo.bankName,
        accountNumber: clinicInfo.bankAccountNo,
        accountName: clinicInfo.bankAccountName,
      }
    : undefined;
```

---

## 8. üìä Clinic List View Enhancement

### Display Bank Info in Table

**Optional**: Add column to show if bank info is configured

**Table Column** (after colorCode):

```tsx
{
  title: 'QR Code',
  dataIndex: 'bankAccountNo',
  width: 100,
  align: 'center',
  render: (bankAccountNo: string | null, record: ClinicResponse) => {
    const hasBank = bankAccountNo && record.bankName && record.bankAccountName;
    return hasBank ? (
      <Tag color="green" icon={<CheckCircleOutlined />}>
        ƒê√£ c·∫•u h√¨nh
      </Tag>
    ) : (
      <Tag color="orange" icon={<ExclamationCircleOutlined />}>
        Ch∆∞a c·∫•u h√¨nh
      </Tag>
    );
  },
}
```

**Or**: Show in tooltip/popover when hover clinic row

---

## 9. üß™ Testing Checklist

### Database & Schema

- [ ] Migration th√™m bank fields v√†o Clinic
- [ ] Seed data v·ªõi bank info m·∫´u
- [ ] Validation schemas work correctly
- [ ] Null/undefined handling for optional fields

### Clinic Management

- [ ] Admin c√≥ th·ªÉ th√™m/s·ª≠a bank info
- [ ] Form validation ho·∫°t ƒë·ªông ƒë√∫ng
- [ ] Bank info hi·ªÉn th·ªã trong edit mode
- [ ] L∆∞u v√† load bank info ch√≠nh x√°c

### QR Code Generation

- [ ] generateVietQRUrl v·ªõi bank config dynamic
- [ ] Fallback v·ªÅ BANK_CONFIG khi kh√¥ng c√≥ clinic info
- [ ] QRPayment component hi·ªÉn th·ªã ƒë√∫ng QR
- [ ] Account name dynamic theo clinic

### Two-Step Payment Flow

- [ ] CreatePaymentVoucherModal: Button "T·∫°o QR" ho·∫°t ƒë·ªông
- [ ] Generate temp code unique
- [ ] PaymentQRConfirmModal hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin
- [ ] QR code scan ƒë∆∞·ª£c v√† auto-fill ƒë√∫ng
- [ ] Confirm t·∫°o payment voucher th√†nh c√¥ng
- [ ] Cancel flow: c√≥ th·ªÉ quay l·∫°i edit
- [ ] Debt sync ƒë√∫ng sau khi confirm

### Backward Compatibility

- [ ] Old payment receipts v·∫´n print ƒë∆∞·ª£c
- [ ] Old QR codes (kh√¥ng c√≥ clinic bank) v·∫´n ho·∫°t ƒë·ªông
- [ ] Existing payment flow kh√¥ng b·ªã break

### Edge Cases

- [ ] Clinic kh√¥ng c√≥ bank info ‚Üí fallback gracefully
- [ ] QR modal: cancel confirmation dialog
- [ ] Network error khi confirm payment
- [ ] Concurrent payment creation
- [ ] Mobile responsive cho QR modal

---

## 10. üìã Implementation Checklist

### Phase 1: Database & Schema (Backend)

- [ ] Create migration file: Add bank fields to Clinic
- [ ] Run migration: `prisma migrate dev --name add_clinic_bank_info`
- [ ] Update `ClinicBaseSchema` v·ªõi bank fields
- [ ] Update `ClinicResponseSchema` v·ªõi bank fields
- [ ] Update repository layer ƒë·ªÉ handle bank fields
- [ ] Test CRUD operations v·ªõi new fields

### Phase 2: QR Code Refactor (Shared)

- [ ] Update `payment.ts`: Add `BankConfig` type
- [ ] Refactor `generateVietQRUrl` signature: Add optional `bankConfig`
- [ ] Add `clinicToBankConfig` helper function
- [ ] Update `QRPayment.tsx`: Accept optional `bankConfig` prop
- [ ] Update account name display logic
- [ ] Test QR generation v·ªõi different configs
- [ ] Test fallback behavior

### Phase 3: Clinic Management UI (Frontend)

- [ ] Update `ClinicFormModal.tsx`: Add bank info fields
- [ ] Add Divider "Th√¥ng tin ng√¢n h√†ng"
- [ ] Add 3 form items: bankName, bankAccountNo, bankAccountName
- [ ] Update defaultValues
- [ ] Update form submission logic
- [ ] Test create clinic v·ªõi bank info
- [ ] Test edit clinic bank info
- [ ] Test validation errors

### Phase 4: Two-Step Payment Flow (Frontend)

- [ ] Refactor `CreatePaymentVoucherModal.tsx`:
  - [ ] Change button text to "T·∫°o m√£ QR thanh to√°n"
  - [ ] Add state: `paymentDraft`
  - [ ] Add handler: `handleGenerateQR`
  - [ ] Add function: `generateTempPaymentCode`
  - [ ] Update submit behavior: Save draft instead of create
- [ ] Create `PaymentQRConfirmModal.tsx`:
  - [ ] Create component file
  - [ ] Implement modal layout
  - [ ] Add QRPayment with large size
  - [ ] Add bank info display (Card + Descriptions)
  - [ ] Add payment summary
  - [ ] Add warning alert
  - [ ] Implement confirm handler
  - [ ] Implement cancel handler with confirmation
- [ ] Update `PaymentDailyView.tsx`:
  - [ ] Add state management for 2 modals
  - [ ] Add `handleGenerateQR` handler
  - [ ] Add `handleConfirmPayment` handler
  - [ ] Add `handleCancelQR` handler
  - [ ] Update JSX v·ªõi 2 modals
- [ ] Test complete flow end-to-end

### Phase 5: Receipt Integration (Frontend)

- [ ] Update `PrintableReceipt.tsx`:
  - [ ] Add bank fields to `clinicInfo` prop type
  - [ ] Convert to `BankConfig` if available
  - [ ] Pass `bankConfig` to `QRPayment`
- [ ] Update payment print handler to include bank info
- [ ] Test receipt printing v·ªõi clinic QR

### Phase 6: Optional Enhancements

- [ ] Add bank info status column in Clinic table
- [ ] Add validation warning khi clinic ch∆∞a c√≥ bank info
- [ ] Add bulk update tool cho admin (n·∫øu c·∫ßn)

### Phase 7: Documentation & Cleanup

- [ ] Update `004 Clinic.md` v·ªõi bank info fields
- [ ] Add migration guide cho team
- [ ] Update API documentation (n·∫øu c√≥)
- [ ] Remove old BANK_CONFIG usage (mark deprecated)
- [ ] Code review & cleanup

---

## 11. üö® Important Notes

### Data Migration

- Sau khi deploy, admin **B·∫ÆT BU·ªòC** ph·∫£i c·∫≠p nh·∫≠t th√¥ng tin ng√¢n h√†ng cho c√°c clinic
- C√≥ th·ªÉ t·∫°o script seed data v·ªõi bank info m·∫∑c ƒë·ªãnh
- Consider bulk import tool n·∫øu c√≥ nhi·ªÅu clinic

### Fallback Strategy

- N·∫øu clinic ch∆∞a c√≥ bank info ‚Üí Fallback v·ªÅ `BANK_CONFIG` global
- Show warning message trong UI: "C∆° s·ªü ch∆∞a c·∫•u h√¨nh QR code ri√™ng"
- Khuy·∫øn kh√≠ch admin c·∫≠p nh·∫≠t s·ªõm

### Security Considerations

- Bank info l√† sensitive data ‚Üí ch·ªâ admin ƒë∆∞·ª£c xem/s·ª≠a
- Consider m√£ h√≥a s·ªë t√†i kho·∫£n khi l∆∞u (optional, n·∫øu c·∫ßn cao c·∫•p)
- Audit log cho bank info changes

### UX Considerations

- QR modal size ph·∫£i ƒë·ªß l·ªõn ƒë·ªÉ d·ªÖ qu√©t
- Hi·ªÉn th·ªã r√µ r√†ng th√¥ng tin chuy·ªÉn kho·∫£n
- Warning alert ƒë·ªÉ tr√°nh confirm nh·∫ßm
- Cancel confirmation ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu

### Performance

- Temp code generation ph·∫£i nhanh (client-side timestamp)
- QR image loading t·ª´ external service ‚Üí c√≥ th·ªÉ cache
- No impact l√™n payment creation performance (v·∫´n 1 call nh∆∞ c≈©)

---

## 12. ‚úÖ Success Criteria

### Functional Requirements Met

- ‚úÖ M·ªói clinic c√≥ th√¥ng tin ng√¢n h√†ng ri√™ng trong DB
- ‚úÖ QR code ƒë∆∞·ª£c generate theo clinic-specific bank info
- ‚úÖ Payment flow r√µ r√†ng 2 b∆∞·ªõc: Generate QR ‚Üí Confirm
- ‚úÖ Kh√¥ng t·∫°o payment record cho ƒë·∫øn khi confirm
- ‚úÖ Frontend state management clean v√† maintainable
- ‚úÖ Reuse existing QR logic (no duplication)

### Technical Requirements Met

- ‚úÖ Backward compatible v·ªõi old payments/receipts
- ‚úÖ No breaking changes trong database
- ‚úÖ Clean separation of concerns
- ‚úÖ Proper error handling
- ‚úÖ Good UX v·ªõi clear feedback

### Business Requirements Met

- ‚úÖ Ph√¢n bi·ªát ƒë∆∞·ª£c ti·ªÅn t·ª´ c∆° s·ªü n√†o (m·ªói c∆° s·ªü 1 TK ri√™ng)
- ‚úÖ Gi·∫£m thi·ªÉu sai s√≥t thanh to√°n (2-step verification)
- ‚úÖ D·ªÖ audit v√† ki·ªÉm tra (clear tracking)
- ‚úÖ Scalable cho future enhancements

---

## üîÆ Future Enhancements

### Possible Improvements

- [ ] **Auto-detect payment**: Webhook t·ª´ bank ƒë·ªÉ auto-confirm
- [ ] **Payment timeout**: Auto-cancel draft sau X ph√∫t
- [ ] **QR expiration**: Th·ªùi gian h·∫øt h·∫°n QR code
- [ ] **Multiple payment methods**: H·ªó tr·ª£ nhi·ªÅu TK/bank cho 1 clinic
- [ ] **Payment tracking**: Realtime status t·ª´ banking API
- [ ] **Analytics**: Report payment by QR vs manual

### Integration Opportunities

- [ ] Connect v·ªõi SePay API ƒë·ªÉ track payment status
- [ ] SMS notification cho kh√°ch h√†ng
- [ ] Email receipt with QR code
- [ ] Mobile app scanning

---

**üéØ END OF REQUIREMENTS DOCUMENT**
