# ğŸ“Š Sales Report (BÃ¡o cÃ¡o Doanh sá»‘)

> **Status**: âœ… IMPLEMENTED  
> **Route**: `/reports/sales`  
> **Last Updated**: 2025-11-19

## ğŸ¯ Má»¥c ÄÃ­ch & Pháº¡m Vi

### Má»¥c Ä‘Ã­ch

BÃ¡o cÃ¡o tá»•ng há»£p vÃ  phÃ¢n tÃ­ch doanh sá»‘ tá»« dá»‹ch vá»¥ Ä‘Ã£ tÆ° váº¥n, giÃºp quáº£n lÃ½:

- Theo dÃµi hiá»‡u suáº¥t kinh doanh theo thÃ¡ng
- So sÃ¡nh tÄƒng trÆ°á»Ÿng vá»›i thÃ¡ng trÆ°á»›c vÃ  cÃ¹ng ká»³ nÄƒm ngoÃ¡i
- PhÃ¢n tÃ­ch doanh sá»‘ theo nhiá»u gÃ³c Ä‘á»™: ngÃ y, nguá»“n khÃ¡ch, dá»‹ch vá»¥, nhÃ¢n viÃªn
- Xem chi tiáº¿t tá»«ng dá»‹ch vá»¥ khi cáº§n drill-down

### Dá»¯ liá»‡u nguá»“n

- **Báº£ng**: `ConsultedService`
- **Äiá»u kiá»‡n**: Filter theo `consultationDate` (ngÃ y tÆ° váº¥n) trong thÃ¡ng
- **Bao gá»“m**: Cáº£ dá»‹ch vá»¥ "ÄÃ£ chá»‘t" vÃ  "ChÆ°a chá»‘t"
- **LÃ½ do**: Äá»ƒ xem toÃ n bá»™ hoáº¡t Ä‘á»™ng tÆ° váº¥n, khÃ´ng chá»‰ dá»‹ch vá»¥ Ä‘Ã£ chá»‘t

### PhÃ¢n quyá»n

- **Admin**:
  - Xem Ä‘Æ°á»£c táº¥t cáº£ chi nhÃ¡nh
  - CÃ³ dropdown chá»n chi nhÃ¡nh cá»¥ thá»ƒ hoáº·c "Táº¥t cáº£ chi nhÃ¡nh"
- **Employee**:
  - Chá»‰ xem chi nhÃ¡nh mÃ¬nh thuá»™c vá»
  - KhÃ´ng cÃ³ clinic selector

---

## ğŸ–¼ï¸ Mock Giao Diá»‡n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š BÃ¡o cÃ¡o Doanh sá»‘ - ThÃ¡ng nÃ y                      [ğŸ—“ï¸ 11/2025] [ğŸ¥ Chi nhÃ¡nh A â–¼] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° Tá»•ng DS   â”‚  â”‚ âœ… DV chá»‘t   â”‚  â”‚ ğŸ‘¤ KH má»›i    â”‚  â”‚ ğŸ‘¥ Má»›i/CÅ©    â”‚
â”‚ 1,250,000â‚«   â”‚  â”‚ 156          â”‚  â”‚ 85           â”‚  â”‚ ğŸŸ¢ 680M      â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ ğŸ”µ 570M      â”‚
â”‚ ğŸŸ¢ â†‘ +12.5%  â”‚  â”‚ ğŸŸ¢ â†‘ +8.3%   â”‚  â”‚ ğŸŸ¢ â†‘ +15.6%  â”‚  â”‚ ğŸŸ¢ â†‘ +18.2%  â”‚
â”‚ vs T.trÆ°á»›c   â”‚  â”‚ vs T.trÆ°á»›c   â”‚  â”‚ vs T.trÆ°á»›c   â”‚  â”‚ vs T.trÆ°á»›c   â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ ğŸŸ¢ â†‘ +28.3%  â”‚  â”‚ ğŸŸ¢ â†‘ +15.2%  â”‚  â”‚ ğŸŸ¢ â†‘ +22.8%  â”‚  â”‚              â”‚
â”‚ vs CÃ¹ng ká»³   â”‚  â”‚ vs CÃ¹ng ká»³   â”‚  â”‚ vs CÃ¹ng ká»³   â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Tá»•ng há»£p                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ [Theo ngÃ y] [Theo nguá»“n] [Theo dá»‹ch vá»¥] [Theo sale] [Theo BS] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tab: Theo ngÃ y                                                 â”‚
â”‚                                                                â”‚
â”‚ Ranking â”‚ NgÃ y       â”‚ KH Ä‘áº¿n â”‚ DV tÆ° váº¥n â”‚ DV chá»‘t â”‚ Doanh sá»‘    â”‚ Tá»· lá»‡ % â”‚ TB/DV      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥‡ #1   â”‚ 15/11/2025 â”‚   25   â”‚    30     â”‚   28    â”‚  85,000,000 â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 93%â”‚  3,035,714 â”‚
â”‚   8.5%  â”‚            â”‚        â”‚           â”‚         â”‚             â”‚         â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥ˆ #2   â”‚ 20/11/2025 â”‚   22   â”‚    26     â”‚   24    â”‚  72,000,000 â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 92%â”‚  3,000,000 â”‚
â”‚   7.2%  â”‚            â”‚        â”‚           â”‚         â”‚             â”‚         â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ...     â”‚ ...        â”‚  ...   â”‚   ...     â”‚  ...    â”‚      ...    â”‚   ...   â”‚    ...     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Tá»”NG    â”‚            â”‚  450   â”‚   520     â”‚  468    â”‚ 1,250,000,000â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 90%â”‚ 2,670,940 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ Chi tiáº¿t ngÃ y: 15/11/2025                                                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Tá»•ng sá»‘: 28 dá»‹ch vá»¥ â”‚ Tá»•ng doanh sá»‘: 85,000,000â‚«                                                  â”‚
â”‚                                                                                                   â”‚
â”‚ NgÃ y TV  â”‚ NgÃ y chá»‘t â”‚ Dá»‹ch vá»¥        â”‚ KhÃ¡ch hÃ ng â”‚ Nguá»“n  â”‚ Sale â”‚ BÃ¡c sÄ© â”‚ GiÃ¡ trá»‹   â”‚ TT      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 15/11/25 â”‚ 15/11/25  â”‚ Nhá»• rÄƒng khÃ´n  â”‚ Nguyá»…n A   â”‚ FB     â”‚ Lan  â”‚ Dr.B   â”‚ 3,000,000 â”‚ ÄÃ£ chá»‘t â”‚
â”‚ 15/11/25 â”‚ 15/11/25  â”‚ Bá»c rÄƒng sá»©    â”‚ Tráº§n B     â”‚ Tiktok â”‚ Hoa  â”‚ Dr.C   â”‚ 8,500,000 â”‚ ÄÃ£ chá»‘t â”‚
â”‚ 15/11/25 â”‚ -         â”‚ Niá»ng rÄƒng     â”‚ LÃª C       â”‚ Zalo   â”‚ Mai  â”‚ Dr.A   â”‚ 25,000,000â”‚ ChÆ°a    â”‚
â”‚ ...      â”‚ ...       â”‚ ...            â”‚ ...        â”‚ ...    â”‚ ...  â”‚ ...    â”‚ ...       â”‚ ...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š YÃªu Cáº§u Chá»©c NÄƒng

### 1. Bá»™ lá»c (Page Header)

**YÃªu cáº§u**:

- [ ] Month Picker: Chá»n thÃ¡ng cáº§n xem bÃ¡o cÃ¡o (format MM/YYYY)
- [ ] Clinic Selector: Admin chá»n chi nhÃ¡nh cá»¥ thá»ƒ hoáº·c "Táº¥t cáº£ chi nhÃ¡nh" (Employee khÃ´ng hiá»ƒn thá»‹)
- [ ] Auto-label: Hiá»ƒn thá»‹ "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", hoáº·c "ThÃ¡ng MM/YYYY" tÃ¹y thÃ¡ng chá»n
- [ ] Layout responsive: Title bÃªn trÃ¡i, controls bÃªn pháº£i

**Implementation**: `src/shared/components/PageHeaderWithMonthNav.tsx`

### 2. Tháº» KPI (4 cards)

**YÃªu cáº§u**:

- [ ] Card 1 - **Tá»•ng doanh sá»‘**: Icon ğŸ’°, mÃ u xanh dÆ°Æ¡ng

  - Hiá»ƒn thá»‹ tá»•ng doanh sá»‘ format VND
  - Growth MoM: % so vá»›i thÃ¡ng trÆ°á»›c (mÅ©i tÃªn â†‘/â†“, xanh/Ä‘á»)
  - Growth YoY: % so vá»›i cÃ¹ng ká»³ nÄƒm trÆ°á»›c

- [ ] Card 2 - **Sá»‘ dá»‹ch vá»¥ chá»‘t**: Icon âœ…, mÃ u xanh lÃ¡

  - Hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng dá»‹ch vá»¥ Ä‘Ã£ chá»‘t
  - Growth MoM vÃ  YoY tÆ°Æ¡ng tá»± card 1

- [ ] Card 3 - **Sá»‘ khÃ¡ch má»›i**: Icon ğŸ‘¤, mÃ u tÃ­m

  - Äáº¿m khÃ¡ch cÃ³ `Customer.createdAt` trong thÃ¡ng hiá»‡n táº¡i
  - Growth MoM vÃ  YoY tÆ°Æ¡ng tá»± card 1

- [ ] Card 4 - **KhÃ¡ch má»›i vs CÅ©**: Icon ğŸ‘¥, dual color
  - DÃ²ng 1: Doanh sá»‘ tá»« khÃ¡ch má»›i (mÃ u xanh lÃ¡, size 16px)
  - DÃ²ng 2: Doanh sá»‘ tá»« khÃ¡ch cÅ© (mÃ u xanh dÆ°Æ¡ng, size 14px)
  - Growth: Chá»‰ hiá»ƒn thá»‹ cho khÃ¡ch má»›i

**PhÃ¢n loáº¡i khÃ¡ch**:

- KhÃ¡ch má»›i: `Customer.createdAt` trong thÃ¡ng Ä‘ang xem
- KhÃ¡ch cÅ©: `Customer.createdAt` trÆ°á»›c thÃ¡ng Ä‘ang xem

**Layout**: Grid 4 cá»™t responsive (desktop: 4/row, tablet: 2/row, mobile: 1/row)

**Implementation**: `src/features/reports/sales/components/SalesReportStats.tsx`

### 3. Báº£ng Tá»•ng Há»£p (5 Tabs)

**YÃªu cáº§u**:

**Tab 1 - Theo ngÃ y**:

- [x] Hiá»ƒn thá»‹ breakdown theo tá»«ng ngÃ y trong thÃ¡ng
- [x] Cá»™t Ä‘áº§u: NgÃ y (DD/MM/YYYY)
- [x] Sáº¯p xáº¿p: Theo ngÃ y chronological (ASC), nhÆ°ng ranking dá»±a theo doanh thu
- [x] Ranking: Dá»±a trÃªn doanh thu (cao nháº¥t = #1), top 3 cÃ³ icon ğŸ†
- [x] **Implementation note**: Repo sort by date ASC â†’ Mapper sort by revenue Ä‘á»ƒ gÃ¡n rank â†’ Sort láº¡i by date Ä‘á»ƒ hiá»ƒn thá»‹

**Tab 2 - Theo nguá»“n**:

- [x] Hiá»ƒn thá»‹ breakdown theo nguá»“n khÃ¡ch hÃ ng (Facebook, Zalo, Tiktok, ...)
- [x] Cá»™t Ä‘áº§u: Nguá»“n
- [x] Map source value â†’ label (VD: "facebook" â†’ "Facebook")
- [x] KhÃ´ng phÃ¢n trang (thÆ°á»ng 5-10 nguá»“n)
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (repo layer)
- [x] Ranking: index + 1 (sau khi Ä‘Ã£ sort)

**Tab 3 - Theo dá»‹ch vá»¥**:

- [x] Hiá»ƒn thá»‹ breakdown theo nhÃ³m dá»‹ch vá»¥ (tá»« `DentalService.serviceGroup`)
- [x] Cá»™t Ä‘áº§u: Dá»‹ch vá»¥
- [x] KhÃ´ng phÃ¢n trang (thÆ°á»ng 5-15 nhÃ³m)
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (repo layer)
- [x] Ranking: index + 1

**Tab 4 - Theo sale**:

- [x] Hiá»ƒn thá»‹ breakdown theo nhÃ¢n viÃªn sale (tá»« `consultingSale`)
- [x] Cá»™t Ä‘áº§u: TÃªn Sale
- [x] PhÃ¢n trang: 10 rows/page
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (repo layer)
- [x] Ranking: index + 1

**Tab 5 - Theo bÃ¡c sÄ©**:

- [x] Hiá»ƒn thá»‹ breakdown theo bÃ¡c sÄ© tÆ° váº¥n (tá»« `consultingDoctor`)
- [x] Cá»™t Ä‘áº§u: TÃªn BÃ¡c sÄ©
- [x] PhÃ¢n trang: 10 rows/page
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (repo layer)
- [x] Ranking: index + 1

**Cá»™t chung cho táº¥t cáº£ tabs** (8 cá»™t):

1. **Ranking**: Badge #1, #2, #3,... + % doanh sá»‘/tá»•ng (top 3 cÃ³ trophy ğŸ†)
2. **[TÃªn]**: Dynamic theo tab (NgÃ y/Nguá»“n/Dá»‹ch vá»¥/Sale/BÃ¡c sÄ©)
3. **KhÃ¡ch Ä‘áº¿n**: Sá»‘ khÃ¡ch unique
4. **DV tÆ° váº¥n**: Tá»•ng sá»‘ dá»‹ch vá»¥ Ä‘Ã£ tÆ° váº¥n
5. **DV chá»‘t**: Sá»‘ dá»‹ch vá»¥ Ä‘Ã£ chá»‘t (mÃ u xanh lÃ¡, bold)
6. **Doanh sá»‘**: Format VND (mÃ u xanh dÆ°Æ¡ng, bold, sortable)
7. **Tá»· lá»‡ chá»‘t %**: Progress bar, cÃ´ng thá»©c: (DV chá»‘t / DV tÆ° váº¥n) Ã— 100%
8. **TB/dá»‹ch vá»¥**: Trung bÃ¬nh doanh sá»‘/dá»‹ch vá»¥, format VND

**Summary Row (Footer)**:

- [ ] Hiá»ƒn thá»‹ luÃ´n á»Ÿ cuá»‘i báº£ng (khÃ´ng scroll)
- [ ] Tá»•ng táº¥t cáº£ metrics: KhÃ¡ch Ä‘áº¿n, DV tÆ° váº¥n, DV chá»‘t, Doanh sá»‘
- [ ] Tá»· lá»‡ chá»‘t vÃ  TB/DV tÃ­nh tá»« tá»•ng
- [ ] Style: Bold text, background xÃ¡m nháº¡t, doanh sá»‘ mÃ u xanh dÆ°Æ¡ng

**Interaction**:

- [ ] Click vÃ o báº¥t ká»³ row nÃ o â†’ Hiá»ƒn thá»‹ DetailPanel vá»›i data tÆ°Æ¡ng á»©ng
- [ ] Click vÃ o row khÃ¡c â†’ Update DetailPanel vá»›i data má»›i
- [ ] Khi Ä‘á»•i thÃ¡ng/chi nhÃ¡nh â†’ Clear selection, DetailPanel vá» empty state
- [ ] Khi Ä‘á»•i tab â†’ Clear selection, DetailPanel vá» empty state

**Implementation**:

- `src/features/reports/sales/components/SummaryTabs.tsx` (wrapper)
- `src/features/reports/sales/components/SummaryTable.tsx` (reusable table component)

### 4. Panel Chi Tiáº¿t (LuÃ´n Hiá»ƒn Thá»‹)

**YÃªu cáº§u**:

**Tráº¡ng thÃ¡i hiá»ƒn thá»‹**:

- [ ] LuÃ´n render (khÃ´ng áº©n/hiá»‡n)
- [ ] **Khi chÆ°a chá»n row**: Hiá»ƒn thá»‹ empty state vá»›i icon â„¹ï¸, message "ChÆ°a cÃ³ dá»¯ liá»‡u chi tiáº¿t", guidance "Vui lÃ²ng chá»n má»™t dÃ²ng trong báº£ng tá»•ng há»£p bÃªn trÃªn"
- [ ] **Khi Ä‘Ã£ chá»n row**: Hiá»ƒn thá»‹ báº£ng chi tiáº¿t

**Header**:

- [ ] Title Ä‘á»™ng: "Chi tiáº¿t [tab label]: [selected item name]" (VD: "Chi tiáº¿t ngÃ y: 15/11/2025")
- [ ] Khi chÆ°a chá»n: Hiá»ƒn thá»‹ "Chi tiáº¿t dá»‹ch vá»¥" (generic title)
- [ ] Summary info: "Tá»•ng sá»‘: X dá»‹ch vá»¥ | Tá»•ng doanh sá»‘: XXX â‚«" (hiá»ƒn thá»‹ khi cÃ³ data)

**Báº£ng chi tiáº¿t** (9 cá»™t cá»‘ Ä‘á»‹nh):

1. **NgÃ y tÆ° váº¥n**: `consultationDate`, DD/MM/YYYY, fixed left
2. **NgÃ y chá»‘t**: `serviceConfirmDate`, DD/MM/YYYY hoáº·c "-" (náº¿u chÆ°a chá»‘t)
3. **Dá»‹ch vá»¥**: `dentalService.name`, width 200px
4. **KhÃ¡ch hÃ ng**: `customer.fullName`, **clickable link** navigate to `/customers/:id`, mÃ u xanh dÆ°Æ¡ng
5. **Nguá»“n khÃ¡ch**: `customer.source`, map to label (VD: "facebook" â†’ "Facebook"), nullable â†’ "KhÃ´ng rÃµ"
6. **Sale tÆ° váº¥n**: `consultingSale.fullName`, nullable â†’ "-"
7. **BÃ¡c sÄ© tÆ° váº¥n**: `consultingDoctor.fullName`, nullable â†’ "-"
8. **GiÃ¡ trá»‹**: `finalPrice`, format VND, mÃ u xanh dÆ°Æ¡ng bold, align right
9. **Tráº¡ng thÃ¡i**: `serviceStatus`, Tag ("ÄÃ£ chá»‘t" = green, "ChÆ°a chá»‘t" = default)

**Query logic**:

- **Base filter**: `consultationDate` trong thÃ¡ng Ä‘ang xem (KHÃ”NG filter theo `serviceStatus`)
- **Additional filter theo tab**:
  - Tab NgÃ y: AND `consultationDate = selected_date`
  - Tab Nguá»“n: AND `customer.source = selected_source`
  - Tab Dá»‹ch vá»¥: AND `dentalService.serviceGroup = selected_category`
  - Tab Sale: AND `consultingSaleId = selected_sale_id`
  - Tab BÃ¡c sÄ©: AND `consultingDoctorId = selected_doctor_id`

**PhÃ¢n trang**: 20 rows/page

**Implementation**: `src/features/reports/sales/components/DetailPanel.tsx`

---

## ğŸ“‹ TypeScript Types

**File**: `src/shared/validation/sales-report.schema.ts`

### Query Schemas

```typescript
GetSalesSummaryQuerySchema = z.object({
  month: z.string().regex(/^\d{4}-\d{2}$/),
  clinicId: z.string().optional(),
});

GetSalesDetailQuerySchema = z.object({
  month: z.string().regex(/^\d{4}-\d{2}$/),
  clinicId: z.string().optional(),
  tab: z.enum(["daily", "source", "service", "sale", "doctor"]),
  key: z.string(),
});
```

### Response Schemas

- **KpiData**: 12 fields (totalSales, closedDeals, newCustomers + 9 growth metrics)
- **DailyDetailData**: id, date, **rank**, 6 metrics (customers, consultations, closed, revenue, rate, avg)
- **SourceDetailData**: id, source, **rank**, 6 metrics
- **ServiceDetailData**: id, service, **rank**, 6 metrics
- **SaleDetailData**: id, saleName, **rank**, 6 metrics
- **DoctorDetailData**: id, doctorName, **rank**, 6 metrics
- **ConsultedServiceDetail**: Full record vá»›i nested customer, dentalService, consultingSale, consultingDoctor

**Note**: Táº¥t cáº£ detail schemas Ä‘á»u cÃ³ field `rank` (number) Ä‘Æ°á»£c tÃ­nh tá»« backend dá»±a trÃªn revenue DESC.

---

## ğŸ”„ Data Flow

### API Endpoints

#### GET `/api/v1/reports/sales/summary`

**Query**: `{ month, clinicId? }`

**Response**: `{ kpi, summaryTabs }`

- KPI: 4 cards vá»›i growth indicators
- SummaryTabs: 5 arrays (byDate, bySource, byService, bySale, byDoctor)

**Backend**:

- Admin: Query all if no clinicId, or filter by clinicId
- Employee: Force clinicId = user.clinicId
- Data source: ConsultedService filter by consultationDate (bao gá»“m cáº£ chÆ°a chá»‘t)

#### GET `/api/v1/reports/sales/detail`

**Query**: `{ month, clinicId?, tab, key }`

**Response**: `{ records, totalRecords, totalRevenue }`

**Backend**:

- Base filter: consultationDate in month (khÃ´ng filter serviceStatus)
- Additional filter:
  - daily: WHERE consultationDate = key
  - source: WHERE customer.source = key
  - service: WHERE dentalService.serviceGroup = key
  - sale: WHERE consultingSaleId = key
  - doctor: WHERE consultingDoctorId = key

### React Query Hooks

#### useSalesSummary(filters)

**File**: `src/features/reports/sales/hooks/useSalesSummary.ts`

```typescript
queryKey: ["sales-report", "summary", month, clinicId]
staleTime: calculateStaleTime(month) // 2min current, 2h past
gcTime: 5 hours
enabled: !!month
```

#### useSalesDetail(tab, key, filters)

**File**: `src/features/reports/sales/hooks/useSalesDetail.ts`

```typescript
queryKey: ["sales-report", "detail", tab, key, month, clinicId]
staleTime: calculateStaleTime(month)
gcTime: 5 hours
enabled: !!tab && !!key && !!month // Lazy load
```

**Dynamic Stale Time**:

- Current month: 2 minutes (data updating)
- Past months: 2 hours (rarely change)

---

## ğŸ—ï¸ Kiáº¿n TrÃºc Há»‡ Thá»‘ng

### Backend (3-Layer Architecture)

**Repository Layer**: `src/server/repos/sales-report.repo.ts`

- Data access layer, follows GUIDELINES.md Pattern 2
- **Public API methods** (7 methods):
  - `getKpiData(params)` - KPI vá»›i MoM/YoY growth
  - `getDailyData(params)` - Daily breakdown, **sort by date ASC**
  - `getSourceData(params)` - Source breakdown, **sort by revenue DESC**
  - `getServiceData(params)` - Service breakdown, **sort by revenue DESC**
  - `getSaleData(params)` - Sale performance, **sort by revenue DESC**
  - `getDoctorData(params)` - Doctor performance, **sort by revenue DESC**
  - `getDetailRecords(params)` - Detail records, **orderBy consultationDate DESC**
- **Private helper methods**:
  - `getMonthDateRange()` - Utility method (public)
  - `queryAllAggregationData()` - Query vá»›i full relations
  - `aggregateConsultations()` - Aggregate consultations
  - `aggregateClosedDeals()` - Aggregate closed deals
  - `groupByDimension()` - Generic aggregation helper
- Query optimization: Aggregate data tá»« `ConsultedService` vá»›i full relations
- Sá»­ dá»¥ng Zod types: `GetSalesSummaryQuery`, `GetSalesDetailQuery`
- **Sort logic**: Táº¥t cáº£ aggregation methods cÃ³ sort logic á»Ÿ repo layer (khÃ´ng Ä‘á»ƒ trong mapper)

**Service Layer**: `src/server/services/sales-report.service.ts`

- Business logic layer, follows GUIDELINES.md Pattern 2
- Zod validation vá»›i `safeParse`
- ServiceError pattern cho error handling
- Authentication checks (admin vs employee)
- **Query strategy**: Gá»i 6 public repo methods trong `Promise.all` (parallel queries)
  ```typescript
  const [kpiData, dailyData, sourceData, serviceData, saleData, doctorData] =
    await Promise.all([
      salesReportRepo.getKpiData(params),
      salesReportRepo.getDailyData(params),
      salesReportRepo.getSourceData(params),
      salesReportRepo.getServiceData(params),
      salesReportRepo.getSaleData(params),
      salesReportRepo.getDoctorData(params),
    ]);
  ```
- Gá»i mappers Ä‘á»ƒ transform data (data Ä‘Ã£ Ä‘Æ°á»£c sort tá»« repo)

**Mapper Functions**: `src/server/services/sales-report/_mappers.ts`

- 7 pure functions: `mapKpiData`, `mapDailyData`, `mapSourceData`, `mapServiceData`, `mapSaleData`, `mapDoctorData`, `mapDetailRecords`
- Transform only (khÃ´ng validation, khÃ´ng sort trá»« mapDailyData)
- **mapDailyData logic**:
  - Input: Data sorted by date ASC (tá»« repo)
  - Process: Sort by revenue DESC â†’ Assign rank â†’ Sort by date ASC
  - Output: Data theo thá»© tá»± ngÃ y nhÆ°ng cÃ³ rank theo revenue
- **mapSourceData/ServiceData/SaleData/DoctorData logic**:
  - Input: Data sorted by revenue DESC (tá»« repo)
  - Process: Assign `rank: index + 1`
  - Output: Data vá»›i rank field
- Comments tiáº¿ng Viá»‡t cho tá»«ng function
- Consistent pattern vá»›i cÃ¡c features khÃ¡c

**API Routes**:

- `src/app/api/v1/reports/sales/summary/route.ts` - KPI + Summary Tabs
- `src/app/api/v1/reports/sales/detail/route.ts` - Detail records

### Frontend (Feature-based Structure)

**Structure**: `src/features/reports/sales/`

```
â”œâ”€â”€ views/
â”‚   â””â”€â”€ SalesReportView.tsx         # Main orchestrator, state management
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SalesReportStats.tsx        # 4 KPI cards
â”‚   â”œâ”€â”€ SummaryTabs.tsx             # 5 tabs wrapper
â”‚   â”œâ”€â”€ SummaryTable.tsx            # Reusable table cho cÃ¡c tabs
â”‚   â””â”€â”€ DetailPanel.tsx             # Chi tiáº¿t luÃ´n hiá»ƒn thá»‹
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useSalesSummary.ts          # React Query hook cho summary
â”‚   â””â”€â”€ useSalesDetail.ts           # React Query hook cho detail (lazy)
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ caching.ts                  # Dynamic stale time calculation
â”œâ”€â”€ api.ts                          # API client functions
â””â”€â”€ index.ts                        # Barrel exports
```

### Caching Strategy

**React Query Configuration**:

- **Summary data**:

  - Query key: `["sales-report", "summary", month, clinicId]`
  - Stale time: 2 phÃºt (thÃ¡ng hiá»‡n táº¡i), 2 giá» (thÃ¡ng cÅ©)
  - GC time: 5 giá»
  - Enabled: `!!month`

- **Detail data**:
  - Query key: `["sales-report", "detail", tab, key, month, clinicId]`
  - Stale time: TÆ°Æ¡ng tá»± summary
  - GC time: 5 giá»
  - Enabled: `!!tab && !!key && !!month` (lazy load khi chá»n row)

**Logic**:

- ThÃ¡ng hiá»‡n táº¡i: Stale time = 2 phÃºt (data cÃ³ thá»ƒ thay Ä‘á»•i)
- ThÃ¡ng cÅ©: Stale time = 2 giá» (data Ã­t khi thay Ä‘á»•i)
- **Savings**: 50-67% vs all-upfront approach

---

## âœ… Checklist Triá»ƒn Khai

### Backend

- [x] Repository: Query aggregation data vá»›i full relations
- [x] Service: Business logic, authentication, validation
- [x] Mappers: Transform data cho responses
- [x] API Routes: `/api/v1/reports/sales/summary` vÃ  `/detail`
- [x] Role-based filtering (admin vs employee)
- [x] Zod validation cho táº¥t cáº£ inputs/outputs

### Frontend

- [x] PageHeaderWithMonthNav: Month picker + clinic selector
- [x] SalesReportStats: 4 KPI cards vá»›i growth indicators
- [x] SummaryTabs: 5 tabs vá»›i SummaryTable reusable
- [x] SummaryTable: 8 columns + summary row + ranking
- [x] DetailPanel: Always visible, 9 columns, customer link
- [x] React Query hooks: useSalesSummary + useSalesDetail
- [x] Dynamic stale time: 2min current, 2h past
- [x] Lazy loading detail data
- [x] Clear selection on filter change

### UI/UX

- [x] Ant Design 5.x modern API (variant, items)
- [x] Consistent table styling (size="small", bordered)
- [x] Responsive grid layout (4/2/1 columns)
- [x] Empty state vá»›i guidance message
- [x] Loading states cho táº¥t cáº£ data fetching
- [x] Customer name clickable navigate

---

## ğŸ”® TÃ­nh NÄƒng TÆ°Æ¡ng Lai

### Phase 2

- [ ] **Export Excel**: ExcelJS library, format Ä‘áº¹p vá»›i colors/headers
- [ ] **Advanced Filters**: Date range custom, service group, status multi-select
- [ ] **Charts**: Line chart daily trend, pie chart source distribution
- [ ] **Scheduled Reports**: Email bÃ¡o cÃ¡o Ä‘á»‹nh ká»³
- [ ] **Analytics**: Conversion funnel, customer lifetime value forecast

---

## ğŸ“ Ghi ChÃº Ká»¹ Thuáº­t

### Quyáº¿t Ä‘á»‹nh quan trá»ng

1. **Data source**: Filter theo `consultationDate` thay vÃ¬ `serviceConfirmDate` Ä‘á»ƒ bao gá»“m cáº£ dá»‹ch vá»¥ chÆ°a chá»‘t
2. **Customer classification**: Dá»±a vÃ o `Customer.createdAt` Ä‘á»ƒ phÃ¢n loáº¡i má»›i/cÅ©
3. **Daily ranking**: Rank by revenue nhÆ°ng hiá»ƒn thá»‹ theo chronological date
   - Repo: Sort by date ASC
   - Mapper: Sort by revenue â†’ Assign rank â†’ Sort by date láº¡i
   - Result: Data theo thá»© tá»± ngÃ y, cÃ³ rank theo revenue
4. **Other tabs ranking**: Rank by revenue, data sorted at repo level
   - Repo: Sort by revenue DESC
   - Mapper: Assign rank = index + 1
   - Result: Data sorted by revenue vá»›i rank tÆ°Æ¡ng á»©ng
5. **Always-visible DetailPanel**: UX tá»‘t hÆ¡n conditional rendering
6. **Fixed columns**: DetailPanel 9 cá»™t cá»‘ Ä‘á»‹nh thay vÃ¬ dynamic theo tab
7. **Lazy loading**: Detail data chá»‰ fetch khi user click row
8. **Dynamic stale time**: ThÃ¡ng hiá»‡n táº¡i 2min, thÃ¡ng cÅ© 2h Ä‘á»ƒ tá»‘i Æ°u caching
9. **Architecture**: Follows GUIDELINES.md Pattern 2
   - Public API methods accept Zod params
   - Private helper methods marked with comments
   - Sort logic at repo layer (not in mappers except mapDailyData special case)
   - Service calls public repo methods (not private helpers directly)
10. **Parallel queries**: Service gá»i 6 repo methods trong `Promise.all` Ä‘á»ƒ tá»‘i Æ°u performance
