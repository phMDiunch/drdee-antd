# ğŸ§© Requirements: Sales Report (BÃ¡o cÃ¡o Doanh sá»‘)

> **ğŸ“‹ STATUS: âœ… IMPLEMENTED** - Modern report with optimized backend architecture  
> **ğŸ”— Implementation**: `src/features/reports/sales/`  
> **ğŸ”§ Last Updated**: 2025-11-19 - Repository optimization (12â†’5 queries), mapper pattern, guideline compliance
> **ğŸ“± Route**: `/reports/sales`

## ğŸ“Š Tham kháº£o

- Prisma Models: `ConsultedService`, `Customer`, `Employee`, `DentalService`, `Clinic`
- Related: `009 Consulted-Service.md`, `006 Dental Service.md`
- UI Library: Ant Design 5.x (Card variant="borderless", Tabs items API)
- Data Fetching: React Query with dynamic stale time (2 min current month, 2 hours past)

## ğŸ¯ Má»¥c TiÃªu

Sales Report (BÃ¡o cÃ¡o Doanh sá»‘) lÃ  trang phÃ¢n tÃ­ch tá»•ng quan cho giÃ¡ trá»‹ dá»‹ch vá»¥ Ä‘Ã£ tÆ° váº¥n (bao gá»“m cáº£ "ÄÃ£ chá»‘t" vÃ  "ChÆ°a chá»‘t"), vá»›i:

### Core Features (âœ… ÄÃ£ triá»ƒn khai Ä‘áº§y Ä‘á»§)

1. **ğŸ” Page Header with Navigation**:

   - **Component**: `PageHeaderWithMonthNav` (shared component)
   - Month picker (chá»n thÃ¡ng phÃ¢n tÃ­ch)
   - Clinic selector (admin only, hiá»ƒn thá»‹ tÃªn chi nhÃ¡nh)
   - Auto-label: "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", hoáº·c "ThÃ¡ng MM/YYYY"
   - Responsive layout: Title bÃªn trÃ¡i, controls bÃªn pháº£i

2. **ğŸ“Š Sales Report Stats** (4 cards):

   - Tá»•ng doanh sá»‘ vá»›i 2 growth indicators (MoM + YoY)
   - Sá»‘ dá»‹ch vá»¥ chá»‘t vá»›i 2 growth indicators
   - Sá»‘ khÃ¡ch má»›i vá»›i 2 growth indicators
   - KhÃ¡ch má»›i vs CÅ© (revenue breakdown)

3. **ğŸ“Š Summary Tabs** (5 tabs - tá»•ng há»£p):

   - Tab 1: **Theo ngÃ y** (daily breakdown - sorted by date, ranked by revenue)
   - Tab 2: **Theo nguá»“n** (source analysis)
   - Tab 3: **Theo dá»‹ch vá»¥** (service category)
   - Tab 4: **Theo sale** (sale performance with ranking)
   - Tab 5: **Theo bÃ¡c sÄ© tÆ° váº¥n** (doctor consultation)
   - **UI**: Default line tabs (khÃ´ng dÃ¹ng type="card")
   - **Table styling**: `size="small"`, `bordered` (consistent with project pattern)
   - **Pagination**: KhÃ´ng phÃ¢n trang (hiá»ƒn thá»‹ táº¥t cáº£ records)
   - **Summary Row**: Hiá»ƒn thá»‹ tá»•ng doanh sá»‘ vÃ  cÃ¡c metrics á»Ÿ cuá»‘i báº£ng
   - **Reusable Component**: Táº¥t cáº£ tabs dÃ¹ng chung `SummaryTable` component Ä‘á»ƒ giáº£m duplication

4. **ğŸ“‹ Detail Panel** (always visible):

   - Hiá»ƒn thá»‹ lÃºc nÃ o cÅ©ng cÃ³ (skeleton/empty state khi chÆ°a chá»n row)
   - Danh sÃ¡ch ConsultedService chi tiáº¿t khi click row trong Summary Tabs
   - **8 fixed columns**: NgÃ y tÆ° váº¥n, NgÃ y chá»‘t, Dá»‹ch vá»¥, KhÃ¡ch hÃ ng (clickable link), Nguá»“n khÃ¡ch, Sale tÆ° váº¥n, BÃ¡c sÄ© tÆ° váº¥n, GiÃ¡ trá»‹, Tráº¡ng thÃ¡i
   - **Table styling**: `size="small"`, `bordered` (consistent with project)
   - Component dÃ¹ng chung cho táº¥t cáº£ tabs
   - **No Excel export button** (removed from detail panel)

5. **ğŸ“¤ Export Actions**:
   - Excel export button (pending implementation)

**Äá»‘i tÆ°á»£ng ngÆ°á»i dÃ¹ng**:

- Táº¥t cáº£ users cÃ³ quyá»n truy cáº­p `/reports/sales`
- **Admin**: CÃ³ thá»ƒ chá»n clinic trong filter Ä‘á»ƒ xem dá»¯ liá»‡u cá»§a báº¥t ká»³ chi nhÃ¡nh nÃ o (hoáº·c táº¥t cáº£)
- **Employee**: Chá»‰ xem Ä‘Æ°á»£c dá»¯ liá»‡u cá»§a clinic mÃ¬nh thuá»™c vá» (clinic filter khÃ´ng hiá»ƒn thá»‹)

**Dá»¯ liá»‡u hiá»ƒn thá»‹**:

- **Summary Tabs**: Hiá»ƒn thá»‹ dá»¯ liá»‡u theo `consultationDate` (ngÃ y tÆ° váº¥n) - bao gá»“m cáº£ dá»‹ch vá»¥ Ä‘Ã£ chá»‘t vÃ  chÆ°a chá»‘t
- **Detail Panel**: Hiá»ƒn thá»‹ táº¥t cáº£ dá»‹ch vá»¥ (khÃ´ng filter theo serviceStatus), cÃ³ cá»™t "NgÃ y chá»‘t" (nullable) vÃ  "Tráº¡ng thÃ¡i"

---

## ğŸ² Decision Log

### UI/UX Decisions (âœ… Implemented)

- âœ… **Single Page Dashboard**: KhÃ´ng dÃ¹ng tabs cho clinics, dÃ¹ng Select filter thay vÃ¬
- âœ… **PageHeaderWithMonthNav Component**: Táº¡o shared component tÆ°Æ¡ng tá»± PageHeaderWithDateNav
  - Title bÃªn trÃ¡i vá»›i auto-label (ThÃ¡ng nÃ y, ThÃ¡ng trÆ°á»›c, ThÃ¡ng MM/YYYY)
  - Month picker vÃ  Clinic selector bÃªn pháº£i
  - Responsive layout vá»›i Row/Col
  - Reusable cho cÃ¡c report features khÃ¡c
- âœ… **Ant Design 5.x**: Sá»­ dá»¥ng modern API
  - `Card` vá»›i `variant="borderless"` (thay vÃ¬ `bordered={false}`)
  - `Tabs` vá»›i `items` prop vÃ  default line style (khÃ´ng dÃ¹ng `type="card"`)
  - Consistent vá»›i pattern cá»§a ClinicTabs vÃ  CustomerDetailView
- âœ… **Table Styling Consistency**:
  - `size="small"` cho táº¥t cáº£ tables (SummaryTable vÃ  DetailPanel)
  - `bordered` Ä‘á»ƒ chia dÃ²ng rÃµ rÃ ng, dá»… Ä‘á»c
  - Pattern giá»‘ng TreatmentLogTable, EmployeeTable
- âœ… **Component Naming**:
  - `KpiCards` â†’ `SalesReportStats` (consistent vá»›i `EmployeeStats`)
  - File renamed: `KpiCards.tsx` â†’ `SalesReportStats.tsx`
  - Export updated trong barrel export
- âœ… **Layout**: Card-based vá»›i shadow vÃ  border radius
  - KhÃ´ng cÃ³ background color riÃªng (dÃ¹ng AppLayout background)
- âœ… **KPI Cards**: 4 cards vá»›i 2 growth indicators má»—i card (MoM + YoY)
  - Color-coded: Blue (sales), Green (deals), Purple (new customers), Mixed (customer type)
  - Growth arrow: Up (green) / Down (red) vs thÃ¡ng trÆ°á»›c
- âœ… **Responsive Grid**:
  - KPI Cards: 4 columns (lg), 2 columns (sm), 1 column (xs)
  - Mobile: Stack vertically
- âœ… **Code Optimization**: Created reusable `SummaryTable` component
  - Reduced SummaryTabs from 516 lines â†’ 93 lines (85% reduction)
  - Generic component vá»›i configurable nameColumn prop
- âœ… **DetailPanel**: Always visible vá»›i empty state
  - Skeleton/guidance when no row selected
  - Fixed 8 columns across all tabs (khÃ´ng cÃ²n dynamic columns)
  - Customer name clickable â†’ navigate to `/customers/:id`
  - Table vá»›i `size="small"` vÃ  `bordered`
  - **Export button removed** tá»« DetailPanel (sáº½ implement táº­p trung sau)

### Data & Business Logic (âœ… Implemented)

- âœ… **Data Source**: `ConsultedService` KHÃ”NG filter theo serviceStatus
  - Tab NgÃ y: Filter theo `consultationDate` (ngÃ y tÆ° váº¥n) - bao gá»“m cáº£ chÆ°a chá»‘t
  - Detail Panel: Hiá»ƒn thá»‹ táº¥t cáº£ services (cÃ³ cá»™t Tráº¡ng thÃ¡i Ä‘á»ƒ phÃ¢n biá»‡t)
- âœ… **Date Fields Clarification**:
  - `consultationDate`: NgÃ y tÆ° váº¥n (required) - dÃ¹ng Ä‘á»ƒ filter data
  - `serviceConfirmDate`: NgÃ y chá»‘t (nullable) - chá»‰ cÃ³ khi status = "ÄÃ£ chá»‘t"
- âœ… **Column Names**: "NgÃ y chá»‘t" (clarified from "NgÃ y") Ä‘á»ƒ rÃµ rÃ ng
- âœ… **Daily Tab Sorting**: Sáº¯p xáº¿p theo ngÃ y ASC, nhÆ°ng ranking theo revenue DESC
  - Ranking calculation: Sort by revenue â†’ assign rank â†’ re-sort by date
  - Display: Dates chronological, ranks revenue-based
- âœ… **Timezone Fix**: Date parsing vá»›i `new Date(year, month-1, day)` thay vÃ¬ string parsing
- âœ… **Customer Classification**: PhÃ¢n loáº¡i khÃ¡ch má»›i/cÅ© dá»±a vÃ o `Customer.createdAt`
  - **KhÃ¡ch má»›i**: `createdAt` trong thÃ¡ng Ä‘ang xem
  - **KhÃ¡ch cÅ©**: `createdAt` trÆ°á»›c thÃ¡ng Ä‘ang xem
  - Doanh sá»‘ tÃ­nh tá»« `ConsultedService.finalPrice`, group by customer classification
- âœ… **Clinic Filter**: Admin sees clinic names (fetched via `useClinics` hook) with "Táº¥t cáº£ chi nhÃ¡nh" option
- âœ… **Clear on Filter Change**: Selected row cleared when month/clinic filter changes to prevent stale data

### Component Architecture (âœ… Implemented)

- âœ… **Feature-based structure**: `src/features/reports/sales/`
- âœ… **Separation of concerns**:
  - `SalesReportView.tsx`: Main view orchestrator with PageHeaderWithMonthNav
  - `SummaryTabs.tsx`: Uses items API, imports SummaryTable
  - `SummaryTable.tsx`: Reusable component with BaseSummaryData interface
  - `DetailPanel.tsx`: Fixed columns, always visible, optional props, no export button
  - `SalesReportStats.tsx`: 4 KPI cards (renamed from KpiCards)
- âœ… **Shared Components**:
  - `PageHeaderWithMonthNav.tsx`: Month-based report header (similar to PageHeaderWithDateNav)
- âœ… **Type safety**: Full TypeScript types in `shared/validation/sales-report.schema.ts`
- âœ… **Reusable**: CÃ¡c component Ä‘á»™c láº­p, exported trong barrel export
- âœ… **React Query**: Dynamic stale time (2 min current month, 2 hours past)
- âœ… **Repository Layer**: Uses Zod types from shared/validation for consistency

---

## 1. ğŸ¨ UI Components (ÄÃ£ triá»ƒn khai)

### 1.1 Layout Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AppLayout (tráº¯ng background)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ReportFilters Card (white, shadow)                 â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ [Month] [Clinic]             â”‚ [Excel]         â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Tá»•ng DS â”‚ â”‚ DV chá»‘t â”‚ â”‚ KH má»›i  â”‚ â”‚ Má»›i/CÅ©  â”‚ (KPI) â”‚
â”‚  â”‚ 1.25B â‚« â”‚ â”‚ 156     â”‚ â”‚ 85      â”‚ â”‚ 680M/   â”‚        â”‚
â”‚  â”‚â†‘+12.5%  â”‚ â”‚â†‘+8.3%   â”‚ â”‚â†‘+15.6%  â”‚ â”‚ 570M    â”‚        â”‚
â”‚  â”‚â†‘+28.3%  â”‚ â”‚â†‘+15.2%  â”‚ â”‚â†‘+22.8%  â”‚ â”‚â†‘+18.2%  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ï¿½ Summary Tabs (Tá»•ng há»£p - Clickable Rows)        â”‚  â”‚
â”‚  â”‚ [NgÃ y] [Nguá»“n] [Dá»‹ch vá»¥] [Sale] [BÃ¡c sÄ©]           â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚
â”‚  â”‚ <Table data for active tab - Click row to detail>  â”‚  â”‚
â”‚  â”‚ Tab Sale: Rank | Sale | Assigned | Consulted ...   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“‹ Detail Panel (Chi tiáº¿t - When row selected)     â”‚  â”‚
â”‚  â”‚ â† Quay láº¡i  |  Selected: "01/01/2025"              â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚
â”‚  â”‚ Danh sÃ¡ch dá»‹ch vá»¥ chá»‘t ngÃ y 01/01/2025             â”‚  â”‚
â”‚  â”‚ Customer | Source | Service | Sale | Doctor | $    â”‚  â”‚
â”‚  â”‚ (Dynamic columns based on active tab)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 PageHeaderWithMonthNav Component

**File**: `src/shared/components/PageHeaderWithMonthNav.tsx` âœ… **NEW**

**Purpose**: Shared header component for monthly reports (similar to PageHeaderWithDateNav)

**Features**:

- **Title with Auto-label**:
  - Title prop displayed on left
  - Month label auto-generated: "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", hoáº·c "ThÃ¡ng MM/YYYY"
  - Loading indicator when data fetching
- **Month Picker**: Ant Design DatePicker
  - `picker="month"`
  - Format: "MM/YYYY"
  - CalendarOutlined icon
- **Clinic Selector** (conditional):
  - Select dropdown vá»›i clinic names
  - **Data source**: Passed as props `clinics` array from parent
  - **Visibility**: `showClinicFilter` prop (admin with multiple clinics only)
  - Width: 200px
  - AllowClear: true
  - Placeholder: "Táº¥t cáº£ chi nhÃ¡nh"

**Layout**: Row vá»›i justify-content: space-between

- Left: Title + subtitle
- Right: Clinic Select + Month Picker (Row vá»›i gutter 8px)

**Props**:

```typescript
interface PageHeaderWithMonthNavProps {
  title: string;
  selectedMonth: dayjs.Dayjs;
  onMonthChange: (date: dayjs.Dayjs | null) => void;
  clinics?: Array<{ id: string; clinicCode: string }>;
  selectedClinicId?: string;
  onClinicChange?: (clinicId: string | undefined) => void;
  showClinicFilter?: boolean;
  loading?: boolean;
  subtitle?: React.ReactNode;
}
```

**Reusability**: Can be used for Revenue Report and other monthly reports

---

### 1.3 SalesReportStats Component

**File**: `src/features/reports/sales/components/SalesReportStats.tsx` âœ… **RENAMED from KpiCards**

**Naming Convention**: Follows pattern of `EmployeeStats` - `{Feature}Stats`

**Layout**: Row vá»›i 4 columns responsive

- lg: 6 cols (4 cards/row)
- sm: 12 cols (2 cards/row)
- xs: 24 cols (1 card/row)

**Cards**:

1. **Tá»•ng doanh sá»‘**:

   - Icon: DollarOutlined (blue)
   - Value: 1,250,000,000 â‚« (VND format)
   - Color: #1890ff
   - Growth indicators (2 lines):
     - Line 1: +12.5% â†‘ (green arrow) - "vs thÃ¡ng trÆ°á»›c"
     - Line 2: +28.3% â†‘ (green arrow) - "vs cÃ¹ng ká»³ nÄƒm trÆ°á»›c"

2. **Sá»‘ dá»‹ch vá»¥ chá»‘t**:

   - Icon: UserOutlined (green)
   - Value: 156
   - Color: #52c41a
   - Growth indicators (2 lines):
     - Line 1: +8.3% â†‘ - "vs thÃ¡ng trÆ°á»›c"
     - Line 2: +15.2% â†‘ - "vs cÃ¹ng ká»³ nÄƒm trÆ°á»›c"

3. **Sá»‘ khÃ¡ch má»›i**:

   - Icon: UserAddOutlined (purple)
   - Value: 85 (sá»‘ khÃ¡ch cÃ³ `Customer.createdAt` trong thÃ¡ng hiá»‡n táº¡i)
   - Color: #722ed1 (purple)
   - Growth indicators (2 lines):
     - Line 1: +15.6% â†‘ - "vs thÃ¡ng trÆ°á»›c"
     - Line 2: +22.8% â†‘ - "vs cÃ¹ng ká»³ nÄƒm trÆ°á»›c"

4. **KhÃ¡ch má»›i vs CÅ©**:
   - Dual display (doanh sá»‘ phÃ¢n loáº¡i theo thá»i Ä‘iá»ƒm táº¡o khÃ¡ch hÃ ng):
     - Má»›i: 680,000,000 â‚« (green, size 16px) - Doanh sá»‘ tá»« khÃ¡ch cÃ³ `Customer.createdAt` trong thÃ¡ng hiá»‡n táº¡i
     - CÅ©: 570,000,000 â‚« (blue, size 14px) - Doanh sá»‘ tá»« khÃ¡ch cÃ³ `Customer.createdAt` trÆ°á»›c thÃ¡ng hiá»‡n táº¡i
   - Growth: +18.2% (for new customers)

**Styling**:

- Card: `variant="borderless"`, shadow, border-radius 12px
- Title: 14px, color #8c8c8c
- Value: 28px, bold, color-coded
- Growth indicators:
  - 2 lines per card (for cards 1, 2, 3)
  - Font size: 13px
  - Arrow icon (up/down) with color: green (positive) / red (negative)
  - Format: "[+/-]X.X% [â†‘/â†“] - [label]"

**Props**:

```typescript
interface KpiCardsProps {
  data: KpiData;
}
```

---

### 1.4 SummaryTabs Component

**File**: `src/features/reports/sales/components/SummaryTabs.tsx` âœ…

**Tabs Type**: Ant Design Tabs vá»›i **default line style** (khÃ´ng dÃ¹ng `type="card"`)

**Styling Consistency**: Matches ClinicTabs vÃ  CustomerDetailView pattern

**Key Features**:

- Uses Ant Design 5.x `items` prop (NOT deprecated `TabPane`)
- All tabs use reusable `SummaryTable` component (code reduction: 516â†’93 lines, 85% savings)
- All tables have `size="small"` and `bordered` props
- All rows clickable Ä‘á»ƒ trigger DetailPanel

**5 Tabs**:

#### Tab 1: Theo ngÃ y

**Data**: `data.byDate` - DailyDetailData[]

**Columns** (via SummaryTable):

- nameColumn: `{ title: "NgÃ y chá»‘t", dataIndex: "date", width: 120 }`
- Standard columns: Ranking | KhÃ¡ch Ä‘áº¿n | Dá»‹ch vá»¥ tÆ° váº¥n | Dá»‹ch vá»¥ chá»‘t | Doanh sá»‘ | Tá»· lá»‡ chá»‘t % | TB/dá»‹ch vá»¥

**Key Behavior**:

- **Sorting**: Hiá»ƒn thá»‹ theo ngÃ y chronological (ASC)
- **Ranking**: Based on revenue DESC (calculated in backend, khÃ´ng theo date order)
- **Data source**: Filter theo `consultationDate` (ngÃ y tÆ° váº¥n), bao gá»“m cáº£ "ChÆ°a chá»‘t"
- Pagination: 10 rows/page
- onRowClick: `(record) => onRowSelect("daily", record.id)`

#### Tab 2: Theo nguá»“n

**Data**: `data.bySource` - SourceDetailData[]

**Columns** (via SummaryTable):

- nameColumn: `{ title: "Nguá»“n", dataIndex: "source" }`
- Standard columns: Same as above

**Key Behavior**:

- No pagination (typically 5-10 rows)
- Ranking by revenue
- onRowClick: `(record) => onRowSelect("source", record.id)`

#### Tab 3: Theo dá»‹ch vá»¥

**Data**: `data.byService` - ServiceDetailData[]

**Columns** (via SummaryTable):

- nameColumn: `{ title: "Dá»‹ch vá»¥", dataIndex: "service" }`
- Standard columns: Same as above

**Key Behavior**:

- No pagination (typically 5-8 rows)
- Ranking by revenue
- onRowClick: `(record) => onRowSelect("service", record.id)`

#### Tab 4: Theo sale

**Data**: `data.bySale` - SaleDetailData[]

**Columns** (via SummaryTable):

- nameColumn: `{ title: "Sale", dataIndex: "saleName" }`
- Standard columns: Same as above

**Key Behavior**:

- Pagination: 10 rows/page
- Ranking by revenue
- onRowClick: `(record) => onRowSelect("sale", record.id)`

#### Tab 5: Theo bÃ¡c sÄ©

**Data**: `data.byDoctor` - DoctorDetailData[]

**Columns** (via SummaryTable):

- nameColumn: `{ title: "BÃ¡c sÄ©", dataIndex: "doctorName" }`
- Standard columns: Same as above

**Key Behavior**:

- Pagination: 10 rows/page
- Ranking by revenue
- onRowClick: `(record) => onRowSelect("doctor", record.id)`

**Card Wrapper**:

- `variant="borderless"`
- No title (tabs are self-explanatory)
- Full width table vá»›i scroll

**Props**:

```typescript
interface SummaryTabsProps {
  data: SummaryTabsData;
  loading?: boolean;
  onRowSelect: (tab: TabType, rowId: string) => void;
}
```

**Standard Table Columns** (All tabs via SummaryTable):

| Column         | Width  | Align  | Features                                                               |
| -------------- | ------ | ------ | ---------------------------------------------------------------------- |
| Ranking        | 110px  | center | Tag with trophy icon (top 3) + % doanh sá»‘ (small text gray)            |
| [Name]         | varies | left   | Dynamic per tab (date/source/service/sale/doctor), fixed column        |
| KhÃ¡ch Ä‘áº¿n      | 120px  | center | Number - Sá»‘ khÃ¡ch                                                      |
| Dá»‹ch vá»¥ tÆ° váº¥n | 110px  | center | Number - Sá»‘ dá»‹ch vá»¥ tÆ° váº¥n                                             |
| Dá»‹ch vá»¥ chá»‘t   | 100px  | center | Green bold number - Sá»‘ dá»‹ch vá»¥ chá»‘t                                    |
| Doanh sá»‘       | 140px  | right  | Blue bold, sortable                                                    |
| Tá»· lá»‡ chá»‘t %   | 110px  | center | Progress bar (0-100%), formula: (Dá»‹ch vá»¥ chá»‘t / Dá»‹ch vá»¥ tÆ° váº¥n) Ã— 100% |
| TB/dá»‹ch vá»¥     | 120px  | right  | VND compact format - Average revenue per service                       |

---

### 1.5 DetailPanel Component

**File**: `src/features/reports/sales/components/DetailPanel.tsx` âœ…

**Purpose**: Hiá»ƒn thá»‹ danh sÃ¡ch chi tiáº¿t cÃ¡c ConsultedService records khi user click vÃ o row trong Summary Tabs

**Key Design Decisions**:

- **Always visible**: Component luÃ´n render (khÃ´ng conditional)
- **Empty state**: Hiá»ƒn thá»‹ guidance khi chÆ°a chá»n row
- **Fixed columns**: 8 columns cá»‘ Ä‘á»‹nh cho táº¥t cáº£ tabs (KHÃ”NG cÃ²n dynamic columns)
- **Table styling**: `size="small"` and `bordered` (consistent with project pattern)
- **Simplified**: Export button removed (will be centralized later)
- **Optional props**: All props are optional Ä‘á»ƒ support empty state

**Layout**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Quay láº¡i  |  Chi tiáº¿t ngÃ y: 01/01/2025            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Tá»•ng sá»‘: 15 dá»‹ch vá»¥  |  Tá»•ng doanh sá»‘: 125,000,000 â‚« â”‚
â”‚                                                      â”‚
â”‚  <Table: size="small", bordered - 8 fixed columns>  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**8 Fixed Columns** (Same for ALL tabs):

| Column        | Width | Fixed | Description                             | Key Feature                                      |
| ------------- | ----- | ----- | --------------------------------------- | ------------------------------------------------ |
| NgÃ y tÆ° váº¥n   | 110px | left  | consultationDate (DD/MM/YYYY)           | Required field                                   |
| NgÃ y chá»‘t     | 110px | -     | serviceConfirmDate (DD/MM/YYYY or "-")  | Nullable - only if status closed                 |
| Dá»‹ch vá»¥       | 200px | -     | dentalService.name                      | -                                                |
| KhÃ¡ch hÃ ng    | 150px | -     | customer.fullName                       | **Clickable Link** to /customers/:id, blue color |
| Nguá»“n khÃ¡ch   | 130px | -     | customer.source (or "KhÃ´ng rÃµ")         | -                                                |
| Sale tÆ° váº¥n   | 140px | -     | consultingSale.fullName (or "-")        | Nullable                                         |
| BÃ¡c sÄ© tÆ° váº¥n | 140px | -     | consultingDoctor.fullName (or "-")      | Nullable                                         |
| GiÃ¡ trá»‹       | 130px | -     | finalPrice (VND format, blue bold)      | Right aligned                                    |
| Tráº¡ng thÃ¡i    | 110px | -     | serviceStatus (Tag: green if "ÄÃ£ chá»‘t") | -                                                |

**Query Logic** (Backend):

- **Base filter**: `consultationDate` in selected month (KHÃ”NG filter serviceStatus)
- **Additional filter per tab**:
  - `daily`: AND `consultationDate = key` (date string)
  - `source`: AND `customer.source = key`
  - `service`: AND `dentalService.serviceGroup = key` (or category)
  - `sale`: AND `consultingSaleId = key`
  - `doctor`: AND `consultingDoctorId = key`

**Features**:

- **Header summary**:
  - Dynamic title: "Chi tiáº¿t [tab label]: [selected item name]"
  - Stats: Total records + Total revenue
- **Columns**: Fixed 8 columns (NO conditional rendering based on tab)
- **Customer Link**: Next.js Link component wrapping customer.fullName, styled blue with cursor pointer
- **Pagination**: 20 rows/page
- **No Export Button**: Removed from component (export will be centralized later)
- **Empty State**:
  - Custom Empty component with InfoCircleOutlined icon
  - Message: "ChÆ°a cÃ³ dá»¯ liá»‡u chi tiáº¿t"
  - Guidance: "Vui lÃ²ng chá»n má»™t dÃ²ng trong báº£ng tá»•ng há»£p bÃªn trÃªn Ä‘á»ƒ xem chi tiáº¿t"

**Props**:

```typescript
interface DetailPanelProps {
  activeTab?: TabType | null; // 'daily' | 'source' | 'service' | 'sale' | 'doctor'
  selectedRowLabel?: string; // Display name for selected item
  data?: {
    records: ConsultedServiceDetail[];
    totalRecords: number;
    totalRevenue: number;
  } | null;
  loading?: boolean;
  // onExport removed - will be centralized later
}

interface ConsultedServiceDetail {
  id: string;
  consultationDate: string; // ISO date (required)
  serviceConfirmDate: string | null; // ISO date (nullable)
  finalPrice: number;
  serviceStatus: string;
  customer: {
    id: string;
    fullName: string;
    phone: string | null;
    source: string | null;
  };
  dentalService: {
    id: string;
    name: string;
    serviceGroup: string | null;
  };
  consultingSale: {
    id: string;
    fullName: string;
  } | null;
  consultingDoctor: {
    id: string;
    fullName: string;
  } | null;
}
```

**State Management**:

```typescript
// In SalesReportView.tsx
const [selectedRow, setSelectedRow] = useState<{
  tab: TabType | null;
  key: string | null;
  label: string;
}>({
  tab: null,
  key: null,
  label: "",
});

const handleRowSelect = (tab: TabType, rowId: string) => {
  // Get label from data based on tab
  let label = rowId;
  // ... extract display name from data based on tab
  setSelectedRow({ tab, key: rowId, label });
};

const handleFilterChange = (newFilters: Partial<typeof filters>) => {
  setFilters((prev) => ({ ...prev, ...newFilters }));
  // Clear selected row to prevent stale detail data
  setSelectedRow({ tab: null, key: null, label: "" });
};
```

**Styling**:

- Card: `variant="borderless"`, with title and extra (export button)
- Table: Bordered, size="middle", scroll={{ x: 1200 }}
- Summary row: Background #fafafa vá»›i bold text
- Loading: Ant Design Table built-in loading skeleton

**Card Wrapper**:

- Title: Dynamic based on selected row (e.g., "Chi tiáº¿t ngÃ y: 01/01/2025")
- Extra: Back button (text button with LeftOutlined icon) + Export button (only if data exists)
- Loading state khi fetch data

### 1.6 SummaryTable Component (Reusable)

**File**: `src/features/reports/sales/components/SummaryTable.tsx` âœ…

**Purpose**: Reusable table component used by all 5 tabs in SummaryTabs to eliminate code duplication

**Table Styling**: `size="small"` and `bordered` props (consistent with project pattern)

**Impact**: Reduced SummaryTabs code from 516 lines â†’ 93 lines (85% reduction)

**Generic Design**:

- Accepts generic type `T extends BaseSummaryData`
- Configurable `nameColumn` prop for tab-specific first column
- Optional `rank` field support (for tabs with ranking)

**Base Interface**:

```typescript
interface BaseSummaryData {
  id: string;
  rank?: number; // Optional for daily tab
  customersVisited: number;
  consultations: number;
  closed: number;
  revenue: number;
  closingRate: number;
  averagePerService: number;
  revenuePercentage: number;
}
```

**Props**:

```typescript
interface SummaryTableProps<T extends BaseSummaryData> {
  data: T[];
  loading?: boolean;
  nameColumn: {
    title: string;
    dataIndex: string;
    width?: number;
  };
  onRowClick?: (record: T) => void;
  pagination?: false | { pageSize: number };
}
```

**Standard Columns** (8 columns):

1. **Ranking** (conditional - only if record.rank exists):
   - Width: 110px
   - Render: RankingTag component
     - Top 3: Trophy icon (Gold #1, Blue #2, Green #3)
     - Line 1: Trophy + rank number
     - Line 2: Revenue percentage (gray text)
2. **[Name Column]** (configurable via props):
   - Title/dataIndex/width from props
   - Fixed column (for horizontal scroll)
3. **KhÃ¡ch Ä‘áº¿n**: 120px, center
4. **Dá»‹ch vá»¥ tÆ° váº¥n**: 110px, center
5. **Dá»‹ch vá»¥ chá»‘t**: 100px, center, green bold
6. **Doanh sá»‘**: 140px, right, blue bold, sortable
7. **Tá»· lá»‡ chá»‘t %**: 110px, center, Progress bar
8. **TB/dá»‹ch vá»¥**: 120px, right, VND compact format

**Summary Row** (Table footer):

- **Display**: Fixed summary row at bottom with bold styling, light gray background
- **Calculations**:
  - Tá»•ng khÃ¡ch Ä‘áº¿n (sum of customersVisited)
  - Tá»•ng DV tÆ° váº¥n (sum of consultations)
  - Tá»•ng DV chá»‘t (sum of closed)
  - Tá»•ng doanh sá»‘ (sum of revenue) - **blue bold highlight**
  - Tá»· lá»‡ chá»‘t % (calculated from totals)
  - TB/dá»‹ch vá»¥ (calculated from totals)
- **Position**: Always visible at bottom (no pagination)

**RankingTag Component** (Internal):

```tsx
function RankingTag({
  rank,
  percentage,
}: {
  rank: number;
  percentage: number;
}) {
  const trophyIcon = rank <= 3 ? <TrophyOutlined /> : null;
  const color =
    rank === 1
      ? "gold"
      : rank === 2
      ? "blue"
      : rank === 3
      ? "green"
      : "default";

  return (
    <div>
      <Tag color={color} icon={trophyIcon}>
        #{rank}
      </Tag>
      <div style={{ fontSize: 12, color: "#8c8c8c" }}>
        {percentage.toFixed(1)}%
      </div>
    </div>
  );
}
```

**Features**:

- Row clickable: `onRow={(record) => ({ onClick: () => onRowClick?.(record) })}`
- Scroll horizontal: `scroll={{ x: 1200 }}`
- Pagination: Configurable (default 10 rows, or false)
- Size: "middle"
- Bordered: false

**Usage Examples**:

```tsx
// Daily tab
<SummaryTable
  data={data.byDate}
  loading={loading}
  nameColumn={{ title: "NgÃ y chá»‘t", dataIndex: "date", width: 120 }}
  onRowClick={(record) => onRowSelect("daily", record.id)}
/>

// Source tab (no pagination)
<SummaryTable
  data={data.bySource}
  loading={loading}
  nameColumn={{ title: "Nguá»“n", dataIndex: "source" }}
  onRowClick={(record) => onRowSelect("source", record.id)}
  pagination={false}
/>
```

---

### 1.6 KpiCards Component

**File**: `src/features/reports/sales/components/KpiCards.tsx` âœ… (Status: Pending full implementation)

**Layout**: Row vá»›i 4 columns responsive

- lg: 6 cols (4 cards/row)
- sm: 12 cols (2 cards/row)
- xs: 24 cols (1 card/row)

**Cards**:

1. **Tá»•ng doanh sá»‘**:

   - Icon: DollarOutlined (blue)
   - Value: VND format
   - Color: #1890ff
   - Growth indicators (2 lines):
     - Line 1: totalSalesGrowthMoM % â†‘/â†“ - "vs thÃ¡ng trÆ°á»›c"
     - Line 2: totalSalesGrowthYoY % â†‘/â†“ - "vs cÃ¹ng ká»³ nÄƒm trÆ°á»›c"

2. **Sá»‘ dá»‹ch vá»¥ chá»‘t**:

   - Icon: UserOutlined (green)
   - Value: Number
   - Color: #52c41a
   - Growth indicators (2 lines):
     - Line 1: closedDealsGrowthMoM % â†‘/â†“
     - Line 2: closedDealsGrowthYoY % â†‘/â†“

3. **Sá»‘ khÃ¡ch má»›i**:

   - Icon: UserAddOutlined (purple)
   - Value: Number (customers with createdAt in current month)
   - Color: #722ed1
   - Growth indicators (2 lines):
     - Line 1: newCustomersGrowthMoM % â†‘/â†“
     - Line 2: newCustomersGrowthYoY % â†‘/â†“

4. **KhÃ¡ch má»›i vs CÅ©**:
   - Dual display (revenue breakdown):
     - Má»›i: newCustomerSales â‚« (green, size 16px)
     - CÅ©: oldCustomerSales â‚« (blue, size 14px)
   - Growth: newCustomerGrowth % (for new customers)

**Styling**:

- Card: `variant="borderless"`, shadow, border-radius 12px
- Title: 14px, color #8c8c8c
- Value: 28px, bold, color-coded
- Growth indicators:
  - 2 lines per card (for cards 1, 2, 3)
  - Font size: 13px
  - Arrow icon (up/down) with color: green (positive) / red (negative)
  - Format: "[+/-]X.X% [â†‘/â†“] - [label]"

**Props**:

```typescript
interface KpiCardsProps {
  data: KpiData;
  loading?: boolean;
}
```

---

## 2. ğŸ“‹ TypeScript Types (âœ… ÄÃ£ Ä‘á»‹nh nghÄ©a Ä‘áº§y Ä‘á»§)

**File**: `src/shared/validation/sales-report.schema.ts` âœ…

**Zod Schemas** (Backend validation + Type inference):

### Query Schemas (Request)

```typescript
// GET /api/v1/reports/sales/summary
export const GetSalesSummaryQuerySchema = z.object({
  month: z.string().regex(/^\d{4}-\d{2}$/, "Month must be in YYYY-MM format"),
  clinicId: z.string().optional(), // Admin: optional, Employee: enforced backend
});

// GET /api/v1/reports/sales/detail
export const GetSalesDetailQuerySchema = z.object({
  month: z.string().regex(/^\d{4}-\d{2}$/, "Month must be in YYYY-MM format"),
  clinicId: z.string().optional(),
  tab: z.enum(["daily", "source", "service", "sale", "doctor"]),
  key: z.string(), // Date string, source name, category, employee ID, etc.
});
```

### Response Schemas

**KPI Data**:

```typescript
export const KpiDataSchema = z.object({
  totalSales: z.number(),
  totalSalesGrowthMoM: z.number(), // Month-over-Month
  totalSalesGrowthYoY: z.number(), // Year-over-Year

  closedDeals: z.number(),
  closedDealsGrowthMoM: z.number(),
  closedDealsGrowthYoY: z.number(),

  newCustomers: z.number(),
  newCustomersGrowthMoM: z.number(),
  newCustomersGrowthYoY: z.number(),

  newCustomerSales: z.number(),
  oldCustomerSales: z.number(),
  newCustomerGrowth: z.number(),
});
```

**Summary Tab Data** (5 types vá»›i shared structure):

```typescript
// Shared fields: id, customersVisited, consultations, closed, revenue, closingRate, averagePerService, revenuePercentage

export const DailyDetailDataSchema = z.object({
  id: z.string(), // Date in YYYY-MM-DD
  date: z.string(), // Display DD/MM/YYYY
  rank: z.number(), // Revenue-based ranking
  // ... + shared fields
});

export const SourceDetailDataSchema = z.object({
  id: z.string(),
  source: z.string(),
  // ... + shared fields
});

export const ServiceDetailDataSchema = z.object({
  id: z.string(),
  service: z.string(),
  // ... + shared fields
});

export const SaleDetailDataSchema = z.object({
  id: z.string(),
  saleName: z.string(),
  // ... + shared fields
});

export const DoctorDetailDataSchema = z.object({
  id: z.string(),
  doctorName: z.string(),
  // ... + shared fields
});

export const SummaryTabsDataSchema = z.object({
  byDate: z.array(DailyDetailDataSchema),
  bySource: z.array(SourceDetailDataSchema),
  byService: z.array(ServiceDetailDataSchema),
  bySale: z.array(SaleDetailDataSchema),
  byDoctor: z.array(DoctorDetailDataSchema),
});
```

**Full Summary Response**:

```typescript
export const SalesSummaryResponseSchema = z.object({
  kpi: KpiDataSchema,
  summaryTabs: SummaryTabsDataSchema,
});
```

**Detail Panel Data**:

```typescript
export const ConsultedServiceDetailSchema = z.object({
  id: z.string(),
  consultationDate: z.string(), // ISO date (required) - ngÃ y tÆ° váº¥n
  serviceConfirmDate: z.string().nullable(), // ISO date (nullable) - ngÃ y chá»‘t
  finalPrice: z.number(),
  serviceStatus: z.string(),

  customer: z.object({
    id: z.string(),
    fullName: z.string(),
    phone: z.string().nullable(),
    source: z.string().nullable(),
  }),

  dentalService: z.object({
    id: z.string(),
    name: z.string(),
    serviceGroup: z.string().nullable(),
  }),

  consultingSale: z
    .object({
      id: z.string(),
      fullName: z.string(),
    })
    .nullable(),

  consultingDoctor: z
    .object({
      id: z.string(),
      fullName: z.string(),
    })
    .nullable(),
});

export const SalesDetailResponseSchema = z.object({
  records: z.array(ConsultedServiceDetailSchema),
  totalRecords: z.number(),
  totalRevenue: z.number(),
});
```

**TypeScript Inferred Types**:

```typescript
export type KpiData = z.infer<typeof KpiDataSchema>;
export type DailyDetailData = z.infer<typeof DailyDetailDataSchema>;
export type SourceDetailData = z.infer<typeof SourceDetailDataSchema>;
export type ServiceDetailData = z.infer<typeof ServiceDetailDataSchema>;
export type SaleDetailData = z.infer<typeof SaleDetailDataSchema>;
export type DoctorDetailData = z.infer<typeof DoctorDetailDataSchema>;
export type SummaryTabsData = z.infer<typeof SummaryTabsDataSchema>;
export type SalesSummaryResponse = z.infer<typeof SalesSummaryResponseSchema>;
export type ConsultedServiceDetail = z.infer<
  typeof ConsultedServiceDetailSchema
>;
export type SalesDetailResponse = z.infer<typeof SalesDetailResponseSchema>;
```

**Frontend Hook Types**:

```typescript
// File: src/features/reports/sales/hooks/useSalesDetail.ts
export type TabType = "daily" | "source" | "service" | "sale" | "doctor";
```

---

## 3. ğŸ”„ Data Flow & API Integration

### 3.1 Summary API (KPI + Tabs aggregated data)

**Endpoint**: `GET /api/reports/sales/summary`

**Query Params**:

```typescript
{
  month: string;          // "YYYY-MM" (required)
  clinicId?: string;      // ADMIN: optional (all clinics if omitted), EMPLOYEE: auto-enforced backend
}
```

**Response Structure**:

```typescript
interface SalesSummaryResponse {
  kpi: KpiData; // 9 metrics vá»›i growth
  tabs: {
    daily: DailyDetailData[]; // ~30 rows (aggregated)
    source: SourceDetailData[]; // ~5-10 rows
    service: ServiceDetailData[]; // ~20-50 rows
    sale: SaleDetailData[]; // ~5-20 rows
    doctor: DoctorDetailData[]; // ~5-20 rows
  };
}
```

**Backend Logic**:

- **Admin**: Query all data if `clinicId` omitted, or filter by `clinicId` if provided
- **Employee**: Force `clinicId = user.clinicId` (backend enforced)
- Data source: `ConsultedService` vá»›i `serviceStatus = "ÄÃ£ chá»‘t"` + `serviceConfirmDate` trong month
- Aggregation: GROUP BY date/source/service/employee tÃ¹y tab

**Frontend Caching**:

- **Admin**: Query all data â†’ client-side filter by selected clinic (no refetch on clinic change)
- **Employee**: Query scoped data only
- **Stale Time**: Dynamic by month age (2 min current month, 2 hours past months)

### 3.2 Detail API (Chi tiáº¿t khi click row)

**Endpoint**: `GET /api/reports/sales/detail`

**Query Params**:

```typescript
{
  month: string;            // "YYYY-MM" (required)
  clinicId?: string;        // Same role-based logic as summary
  tab: TabType;             // "daily" | "source" | "service" | "sale" | "doctor" (required)
  key: string;              // Row identifier (required)
                            // Examples: "2025-01-15" (daily), "facebook" (source),
                            //           "sale-id-123" (sale), "doctor-id-456" (doctor)
}
```

**Response Structure**:

```typescript
interface SalesDetailResponse {
  tab: string;
  key: string;
  services: ConsultedServiceDetail[]; // 10-100 records
  totalRecords: number;
  totalRevenue: number;
}
```

**Backend Logic**:

- Base query: `ConsultedService` vá»›i `serviceStatus = "ÄÃ£ chá»‘t"` + `serviceConfirmDate` trong month
- Role-based scope: Same as summary API (admin all/filter, employee enforced)
- Additional filter theo `key`:
  - `daily`: WHERE `serviceConfirmDate = key`
  - `source`: WHERE `customer.source = key`
  - `service`: WHERE `dentalService.category = key`
  - `sale`: WHERE `assignedSaleId = key`
  - `doctor`: WHERE `consultedDoctorId = key`
- Include full relations: customer, dentalService, assignedSale, consultedDoctor
- **Lazy loading**: Chá»‰ fetch khi user click row (enabled by queryKey dependency)

**Frontend Caching**:

- **Query Key**: `['sales-report', 'detail', tab, key, month, clinicId]`
- **Enabled**: `!!tab && !!key` (only when row selected)
- **Stale Time**: Dynamic same as summary (2 min current, 2 hours past)
- **GC Time**: 5 hours (consistent with summary)

### 3.3 React Query Hooks

#### Hook 1: `useSalesSummary(filters)`

**File**: `src/features/reports/sales/hooks/useSalesSummary.ts`

```typescript
export function useSalesSummary(filters: DashboardFilters) {
  const { clinicId, month } = filters;
  const { employeeProfile } = useAuth();

  // Admin: no clinicId in API (query all), Employee: enforced backend
  const apiParams = useMemo(
    () => ({
      month,
      clinicId:
        employeeProfile?.role === "admin"
          ? undefined
          : employeeProfile?.clinicId,
    }),
    [month, employeeProfile]
  );

  const query = useQuery({
    queryKey: ["sales-report", "summary", apiParams],
    queryFn: () => getSalesSummaryApi(apiParams),
    staleTime: calculateStaleTime(month), // Dynamic: 2 min current, 2 hours past
    gcTime: 5 * 60 * 60 * 1000, // 5 hours
    refetchOnWindowFocus: false,
  });

  // Admin: Client-side filter by selected clinic
  const filteredData = useMemo(() => {
    if (!query.data || employeeProfile?.role !== "admin" || !clinicId) {
      return query.data;
    }
    return filterDataByClinic(query.data, clinicId);
  }, [query.data, clinicId, employeeProfile]);

  return { ...query, data: filteredData };
}
```

**Key Points**:

- âœ… Admin query all â†’ client filter (fast clinic switch)
- âœ… Employee query scoped (backend enforced)
- âœ… Dynamic stale time: 2 min (current), 2 hours (past months)

#### Hook 2: `useSalesDetail(tab, key, filters)`

**File**: `src/features/reports/sales/hooks/useSalesDetail.ts`

```typescript
export function useSalesDetail(
  tab: TabType | null,
  key: string | null,
  filters: DashboardFilters
) {
  const { month, clinicId } = filters;
  const { employeeProfile } = useAuth();

  // Same role-based logic
  const effectiveClinicId =
    employeeProfile?.role === "admin" ? clinicId : employeeProfile?.clinicId;

  return useQuery({
    queryKey: ["sales-report", "detail", tab, key, month, effectiveClinicId],
    queryFn: () =>
      getSalesDetailApi({
        tab: tab!,
        key: key!,
        month,
        clinicId: effectiveClinicId,
      }),
    enabled: !!tab && !!key, // Lazy load on row click
    staleTime: calculateStaleTime(month), // Same as summary: 2 min current, 2 hours past
    gcTime: 5 * 60 * 60 * 1000, // 5 hours
    refetchOnWindowFocus: false,
  });
}
```

**Key Points**:

- âœ… Lazy loading vá»›i `enabled: !!tab && !!key`
- âœ… Separate cache per tab/key combination
- âœ… Dynamic stale time: 2 min (current), 2 hours (past months)
- âœ… Consistent caching strategy vá»›i summary data

### 3.4 Optimization Utilities

#### A. Dynamic Stale Time

```typescript
// File: src/features/reports/sales/utils/caching.ts

export function calculateStaleTime(month: string): number {
  const selected = dayjs(month, "YYYY-MM");
  const now = dayjs();

  if (selected.isSame(now, "month")) return 2 * 60 * 1000; // 2 min (current month - updating)
  return 2 * 60 * 60 * 1000; // 2 hours (past months - rarely change)
}
```

#### B. Client-side Clinic Filter (Admin only)

```typescript
// File: src/features/reports/sales/utils/filtering.ts

export function filterDataByClinic(
  data: SalesSummaryResponse,
  clinicId: string
): SalesSummaryResponse {
  return {
    kpi: filterKpiByClinic(data.kpi, clinicId),
    tabs: {
      daily: data.tabs.daily.filter((row) => row.clinicId === clinicId),
      source: data.tabs.source.filter((row) => row.clinicId === clinicId),
      service: data.tabs.service.filter((row) => row.clinicId === clinicId),
      sale: data.tabs.sale.filter((row) => row.clinicId === clinicId),
      doctor: data.tabs.doctor.filter((row) => row.clinicId === clinicId),
    },
  };
}
```

#### C. Prefetch Adjacent Months

```typescript
// File: src/features/reports/sales/utils/prefetch.ts

export function prefetchAdjacentMonths(
  queryClient: QueryClient,
  currentMonth: string,
  employeeProfile: Employee
) {
  const isAdmin = employeeProfile.role === "admin";
  const baseParams = {
    clinicId: isAdmin ? undefined : employeeProfile.clinicId,
  };

  const prevMonth = dayjs(currentMonth).subtract(1, "month").format("YYYY-MM");
  queryClient.prefetchQuery({
    queryKey: ["sales-report", "summary", { ...baseParams, month: prevMonth }],
    queryFn: () => getSalesSummaryApi({ ...baseParams, month: prevMonth }),
  });
}
```

## 4. ğŸ“Š Performance & Data Transfer

### Transfer Size Estimates

| **Scenario**        | **Summary** | **Detail (5 opens)** | **Total**  |
| ------------------- | ----------- | -------------------- | ---------- |
| Admin (3 clinics)   | 120 KB      | 125 KB               | 245 KB     |
| Employee (1 clinic) | 40 KB       | 125 KB               | 165 KB     |
| **VS All Upfront**  | -           | -                    | ~500 KB    |
| **Savings**         | -           | -                    | **50-67%** |

### Caching Benefits

- **Admin clinic switch**: 0ms (client filter)
- **Month navigation**: ~100ms (prefetch)
- **Historical months**: 90%+ cache hit

---

## 5. âœ… Implementation Checklist

### Backend APIs (âœ… Implemented with Optimizations)

- [x] `GET /api/v1/reports/sales/summary` - Role-based clinicId enforcement
  - [x] API Route implementation
  - [x] Service layer with Zod validation, ServiceError, safeParse, auth checks
  - [x] Repository layer using Zod types (GetSalesSummaryQuery)
  - [x] **Optimization**: 12 queries â†’ 5 queries (queryAllAggregationData + groupByDimension)
  - [x] Full integration testing
- [x] `GET /api/v1/reports/sales/detail` - Tab/key dynamic filtering
  - [x] API Route implementation
  - [x] Service layer with Zod validation
  - [x] Repository layer using Zod types (GetSalesDetailQuery)
  - [x] Full integration testing
- [x] Service: Aggregation logic (5 tabs)
  - [x] Daily tab: Sort by revenue for ranking â†’ re-sort by date for display
  - [x] Filter by consultationDate (not serviceConfirmDate)
  - [x] Include both "ÄÃ£ chá»‘t" and "ChÆ°a chá»‘t" services
  - [x] Performance optimization: Generic groupByDimension function (DRY principle)
- [x] Service: Detail query vá»›i full relations (customer, dentalService, consultingSale, consultingDoctor)
- [x] Repo: Date parsing fix (new Date(year, month-1, day))
- [x] Zod schemas validation (âœ… Defined in shared/validation/sales-report.schema.ts)
- [x] Repository type safety: Using Zod types instead of custom interfaces
- [x] **Mapper Pattern**: Created `_mappers.ts` with 7 functions (guideline compliant)
  - [x] Type definitions: RawKpiData, RawDetailRecord
  - [x] Comments tiáº¿ng Viá»‡t cho táº¥t cáº£ functions
  - [x] Transform only - no validation
  - [x] Consistent vá»›i customer/\_mappers.ts, employee/\_mappers.ts

### Frontend Hooks (ğŸ”„ Pending)

- [ ] `useSalesSummary()` - Admin client filter + dynamic stale time
- [ ] `useSalesDetail()` - Lazy loading enabled by key
- [ ] `calculateStaleTime()` utility (2 min current, 2 hours past)
- [ ] `filterDataByClinic()` utility (admin only)
- [ ] `prefetchAdjacentMonths()` utility (optional optimization)

### UI Components (âœ… Completed)

- [x] `PageHeaderWithMonthNav.tsx` - Shared component for monthly reports (NEW)
- [x] `SummaryTabs.tsx` - Using items API, imports SummaryTable, default line tabs
- [x] `SummaryTable.tsx` - Reusable component with generic type, size="small", bordered
- [x] `DetailPanel.tsx` - Always visible, fixed 8 columns, optional props, customer link, no export button
- [x] `SalesReportStats.tsx` - 4 cards with 2 growth indicators each (renamed from KpiCards)
- [x] `SalesReportView.tsx` - Main view orchestrator, clears selectedRow on filter change (renamed from SalesDashboardView)
- [x] Loading states for detail panel
- [x] Empty states handling

### Data Flow (ğŸ”„ Pending)

- [ ] Replace mock data with API calls
- [ ] Implement useSalesSummary hook with React Query
- [ ] Implement useSalesDetail hook with React Query
- [ ] Test Admin: all-clinic query + client filter
- [ ] Test Employee: scoped query
- [ ] Test Detail lazy loading
- [ ] Test Cache with different months
- [ ] Test Prefetch navigation (optional)

### Export Feature (ğŸ”„ Pending)

- [ ] Install ExcelJS library
- [ ] Implement export for summary data (5 tabs)
- [ ] Implement export for detail data
- [ ] Add proper formatting (headers, number formats, colors)

### Testing & Validation (ğŸ”„ Pending)

- [ ] Test with real data in dev environment
- [ ] Verify timezone fixes work correctly
- [ ] Verify clinic filtering (admin vs employee)
- [ ] Verify unclosed services display properly
- [ ] Test customer link navigation
- [ ] Test selectedRow clear on filter change
- [ ] Responsive testing (mobile/tablet)
- [ ] Performance testing (large datasets)

### Code Quality (âœ… Completed)

- [x] No TypeScript compilation errors
- [x] All Ant Design 5.x API compliant (no deprecated warnings)
- [x] Proper error boundaries
- [x] Consistent code style
- [x] Component documentation
- [x] Repository uses Zod types for type consistency
- [x] Barrel exports include reusable components
- [x] Follows project guidelines (3-layer architecture, type safety)

---

## 6. ğŸ“ Implementation Notes

### âœ¨ Nhá»¯ng Cáº£i Tiáº¿n HÃ´m Nay (2025-11-19)

**Backend Optimization:**

- âœ… Repository: Giáº£m 12 queries â†’ 5 queries (58% reduction, ~40-50% nhanh hÆ¡n)
- âœ… Generic function `groupByDimension()` thay tháº¿ 5 functions trÃ¹ng láº·p
- âœ… Method `queryAllAggregationData()` - 1 láº§n query vá»›i Ä‘áº§y Ä‘á»§ relations
- âœ… Code reduction: Repository 38%, Service 68%

**Guideline Compliance:**

- âœ… Service layer: ServiceError, safeParse, authentication checks, comments tiáº¿ng Viá»‡t
- âœ… Mapper pattern: 7 functions vá»›i type definitions, consistent vá»›i cÃ¡c feature khÃ¡c
- âœ… Transform only - khÃ´ng validation trong mappers
- âœ… Nested structure preserved (customer, dentalService, consultingSale, consultingDoctor)

**Architecture:**

- âœ… 3-layer tuÃ¢n thá»§ guideline: Repository â†’ Service â†’ API
- âœ… Type safety: Zod types tá»« shared/validation
- âœ… DRY principle: Generic functions, reusable mappers

---

### Key Bug Fixes Applied

1. **Deprecated API Migration**:

   - `Card`: `bordered={false}` â†’ `variant="borderless"`
   - `Tabs`: `<TabPane>` â†’ `items` prop

2. **Timezone Issue**:

   - Old: `new Date(dateString)` (parsed as UTC)
   - Fixed: `new Date(year, month-1, day)` (local timezone)

3. **Daily Tab Sorting**:

   - Ranking: Sort by revenue DESC â†’ assign rank
   - Display: Re-sort by date ASC
   - Shows: Chronological dates with revenue-based ranks

4. **Data Scope**:

   - Changed from: serviceStatus="ÄÃ£ chá»‘t" + serviceConfirmDate filter
   - Changed to: consultationDate filter + all statuses
   - Reason: Show full picture including pending services

5. **Column Clarification**:

   - Changed: "NgÃ y" (ambiguous)
   - To: "NgÃ y chá»‘t" (clear it's serviceConfirmDate)

6. **DetailPanel Improvements**:

   - Always visible (not conditional)
   - Fixed 8 columns (not dynamic per tab)
   - Customer name clickable to `/customers/:id`
   - Empty state with guidance message

7. **Clinic Filter Enhancement**:

   - Fetches clinic data via useClinics hook
   - Displays clinic names (not IDs)
   - Width increased to 200px for longer names
   - Clears selectedRow when clinic changes

8. **Repository Type Safety** (NEW):

   - Changed from custom interfaces to Zod types
   - `SummaryParams` â†’ `GetSalesSummaryQuery`
   - `DetailParams` â†’ `GetSalesDetailQuery`
   - Ensures type consistency across all layers

9. **Barrel Export Enhancement** (NEW):

   - Added exports for reusable components
   - Includes: SalesReportStats (renamed from KpiCards), SummaryTabs, SummaryTable, DetailPanel
   - Added utils exports (caching)
   - Better component reusability

10. **PageHeaderWithMonthNav Creation** (NEW):

    - Created shared component for month-based reports
    - Replaces ReportFilters component in SalesReportView
    - Features: Month picker, clinic selector, auto-labels
    - Reusable for Revenue Report and other monthly features

11. **UI Consistency Improvements** (NEW):

    - SummaryTabs: Removed `type="card"` â†’ default line tabs (matches ClinicTabs, CustomerDetailView)
    - Tables: Added `size="small"` and `bordered` props (consistent with TreatmentLogTable, EmployeeTable)
    - Component naming: KpiCards â†’ SalesReportStats (consistent with EmployeeStats pattern)
    - DetailPanel: Removed export button (will be centralized later)

12. **View Component Naming** (NEW):

    - Renamed: SalesDashboardView â†’ SalesReportView
    - Follows guideline pattern: `{Feature}{Type}View` (e.g., CustomerDailyView, PaymentDailyView)
    - "Report" more accurately describes the feature than "Dashboard"
    - File: `SalesDashboardView.tsx` â†’ `SalesReportView.tsx`
    - Updated barrel export and page import

13. **API Error Handling** (NEW):

    - API routes now use ServiceError pattern
    - Proper HTTP status codes (e.g., 400, 401, 500)
    - Consistent error response structure: `{ error, code }`
    - Matches project guideline template

14. **Customer Source Display Mapping** (NEW):

    - Backend (service layer): Maps raw source values to labels using `CUSTOMER_SOURCES`
    - Example: "facebook" â†’ "Facebook", "tiktok" â†’ "Tiktok"
    - Frontend (DetailPanel): Also maps source values for consistency
    - Ensures user-friendly display across Summary and Detail views

15. **Summary Table Improvements** (NEW):
    - **No Pagination**: All tabs display all records without pagination
    - **Summary Row**: Added totals footer with bold styling and gray background
    - **Calculations**: Shows sum of all metrics (customers, consultations, closed, revenue)
    - **Always Visible**: Summary row always at bottom, highlighting total revenue in blue
    - Better overview of total performance across all records

### Performance Optimizations

1. **Code Reduction**:

   - Created reusable SummaryTable component
   - Eliminated 85% duplication (516â†’93 lines)

2. **Backend Optimization - Repository Layer** (NEW):

   - **Query Consolidation**: 12 queries â†’ 5 queries (58% reduction)
   - **Method**: Single `queryAllAggregationData()` function
     - 1 láº§n query closedServices + allConsultations vá»›i Ä‘áº§y Ä‘á»§ relations
     - Relations: customer.source, dentalService.serviceGroup, consultingSale, consultingDoctor
   - **Generic Helper**: `groupByDimension<T>()` function
     - DRY principle: Táº¥t cáº£ 5 dimension functions dÃ¹ng chung
     - Config-based: getKey, mapResult, filterNull parameters
     - Type-safe vá»›i generic parameter
   - **Service Layer**: Query 1 láº§n, group 5 láº§n trong memory (~5ms)
   - **Performance Gain**: ~40-50% nhanh hÆ¡n, data consistency Ä‘áº£m báº£o
   - **Code Metrics**:
     - Repository: 860 lines â†’ 530 lines (38% reduction)
     - Service: 312 lines â†’ 100 lines (68% reduction)

3. **Mapper Pattern Implementation** (NEW):

   - **File**: `src/server/services/sales-report/_mappers.ts` (269 lines)
   - **Functions**: 7 mappers (KPI, Daily, Source, Service, Sale, Doctor, DetailRecords)
   - **Benefits**:
     - Separation of concerns (transform logic riÃªng)
     - Reusable across service functions
     - Service layer reduced from 312 â†’ 100 lines (68% reduction)
   - **Guideline Compliance**:
     - Type definitions cho input (RawKpiData, RawDetailRecord)
     - Comments tiáº¿ng Viá»‡t mÃ´ táº£ rÃµ chá»©c nÄƒng
     - Transform only - khÃ´ng validation
     - Nested structure (customer, dentalService, consultingSale, consultingDoctor)
     - Date conversion: `.toISOString()` hoáº·c `null`
     - Consistent vá»›i customer/\_mappers.ts, employee/\_mappers.ts

4. **React Query Strategy**:

   - **Benefits**:
     - Separation of concerns (transform logic riÃªng)
     - Reusable across service functions
     - Service layer reduced from 312 â†’ 100 lines
   - **Guideline Compliance**:
     - Type definitions cho input (RawKpiData, RawDetailRecord)
     - Comments tiáº¿ng Viá»‡t mÃ´ táº£ rÃµ chá»©c nÄƒng
     - Transform only - khÃ´ng validation
     - Consistent vá»›i customer/\_mappers.ts, employee/\_mappers.ts

5. **React Query Strategy**:

   - Dynamic stale time: 2 min (current), 2 hours (past)
   - GC time: 5 hours
   - Lazy loading for detail data (enabled by key)
   - Client-side filter for admin (no refetch on clinic change)

6. **Memo Opportunities** (if needed):
   - SummaryTable component (if re-render issues)
   - DetailPanel columns (already memoized)
   - KpiCards (consider if performance issues)

---

## 7. ğŸ”® Future Enhancements

### Phase 2 Features (After MVP)

1. **Advanced Filters**:

   - Date range picker (custom periods)
   - Service group filter
   - Status filter (for detail panel)
   - Employee filter (multi-select)

2. **Export Enhancements**:

   - PDF export with charts
   - Email scheduled reports
   - Custom export templates

3. **Visualizations**:

   - Add Chart.js line chart for daily trend
   - Pie chart for source distribution
   - Bar chart for top services

4. **Performance**:

   - Virtualized tables for large datasets
   - Progressive loading with infinite scroll
   - WebWorker for heavy calculations

5. **Analytics**:
   - Conversion funnel analysis
   - Customer lifetime value tracking
   - Predictive revenue forecasting

---
