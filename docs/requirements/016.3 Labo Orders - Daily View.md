# 016.3 Labo Orders - Daily View

## ğŸ“‹ Tá»•ng Quan

**Feature**: MÃ n hÃ¬nh theo dÃµi hÃ ng ngÃ y - Máº«u gá»­i Ä‘i vÃ  nháº­n vá»

**Má»¥c Ä‘Ã­ch**:

- Theo dÃµi máº«u gá»­i xÆ°á»Ÿng hÃ´m nay
- Theo dÃµi máº«u xÆ°á»Ÿng tráº£ vá» hÃ´m nay
- Checklist cÃ´ng viá»‡c hÃ ng ngÃ y
- Quick access Ä‘á»ƒ update status

**Route**: `/labo-orders/daily` (default route cá»§a Labo)

**Status**: âœ… **IMPLEMENTED** (2025-12-08)

## ğŸ“Š Tham kháº£o

- Prisma Model: `prisma/schema.prisma` â†’ LaboOrder
- Related Requirements:
  - `016.1 Labo Item Master.md` - LaboItem reference
  - `016.2 Labo Service Prices.md` - Pricing snapshot
  - `007 Customer.md` - Customer reference
  - `005 Employee.md` - Doctor reference
  - `015.2 Supplier Management.md` - Supplier reference
- Guidelines: `docs/GUIDELINES.md` â†’ Nested Structure Pattern

---

## ğŸ¯ User Stories

### US-1: Xem máº«u gá»­i Ä‘i hÃ´m nay

**LÃ ** NhÃ¢n viÃªn/BÃ¡c sÄ©  
**TÃ´i muá»‘n** xem danh sÃ¡ch máº«u gá»­i xÆ°á»Ÿng hÃ´m nay  
**Äá»ƒ** kiá»ƒm tra vÃ  Ä‘Ã³ng gÃ³i gá»­i Ä‘i

**Acceptance Criteria**:

- [x] Collapsible Table "ğŸ“¤ Máº«u Gá»­i Äi" hiá»ƒn thá»‹ orders cÃ³ `sentDate` = date
- [x] Badge Ä‘áº¿m sá»‘ lÆ°á»£ng: "Máº«u Gá»­i Äi (5)"
- [x] Table columns: KhÃ¡ch hÃ ng, BÃ¡c sÄ©, NgÃ y Ä‘iá»u trá»‹, Loáº¡i Ä‘Æ¡n hÃ ng, XÆ°á»Ÿng, Loáº¡i rÄƒng, SL, NgÃ y gá»­i máº«u, NgÃ y háº¹n láº¯p, YÃªu cáº§u, Thao tÃ¡c
- [x] Sort máº·c Ä‘á»‹nh: `createdAt desc` (má»›i nháº¥t trÆ°á»›c)
- [x] Máº·c Ä‘á»‹nh: Má»Ÿ (expanded)

### US-2: Xem máº«u nháº­n vá» hÃ´m nay

**LÃ ** NhÃ¢n viÃªn/BÃ¡c sÄ©  
**TÃ´i muá»‘n** xem danh sÃ¡ch máº«u xÆ°á»Ÿng tráº£ vá» hÃ´m nay  
**Äá»ƒ** kiá»ƒm tra vÃ  xÃ¡c nháº­n nháº­n hÃ ng

**Acceptance Criteria**:

- [x] Collapsible Table "ğŸ“¥ Máº«u Nháº­n Vá»" hiá»ƒn thá»‹ orders cÃ³ `returnDate` = date
- [x] Badge Ä‘áº¿m sá»‘ lÆ°á»£ng: "Máº«u Nháº­n Vá» (3)"
- [x] Table columns: TÆ°Æ¡ng tá»± table gá»­i Ä‘i
- [x] Sort máº·c Ä‘á»‹nh: `returnDate asc` (sá»›m nháº¥t trÆ°á»›c)
- [x] Máº·c Ä‘á»‹nh: Má»Ÿ (expanded)

### US-3: Äiá»u hÆ°á»›ng ngÃ y

**LÃ ** NhÃ¢n viÃªn  
**TÃ´i muá»‘n** xem máº«u cá»§a ngÃ y khÃ¡c  
**Äá»ƒ** tracking cÃ´ng viá»‡c quÃ¡ khá»©/tÆ°Æ¡ng lai

**Acceptance Criteria**:

- [x] Date navigation: Previous Day | Today | Next Day + DatePicker
- [x] URL sync: `/labo-orders/daily?date=2025-12-03`
- [x] Default: HÃ´m nay
- [x] Reload cáº£ 2 tables + statistics khi Ä‘á»•i ngÃ y

### US-4: Xem thá»‘ng kÃª tá»•ng quan

**LÃ ** Manager  
**TÃ´i muá»‘n** xem thá»‘ng kÃª hÃ´m nay  
**Äá»ƒ** náº¯m tÃ¬nh hÃ¬nh cÃ´ng viá»‡c

**Acceptance Criteria**:

- [x] Statistics cards:
  - Gá»­i Ä‘i hÃ´m nay (count + totalCost)
  - Nháº­n vá» hÃ´m nay (count + totalCost)
- [x] Auto refresh khi Ä‘á»•i ngÃ y hoáº·c clinic

### US-5: Filter theo clinic

**LÃ ** Admin  
**TÃ´i muá»‘n** chá»n clinic Ä‘á»ƒ xem data  
**Äá»ƒ** quáº£n lÃ½ tá»«ng chi nhÃ¡nh

**Acceptance Criteria**:

- [x] Clinic Tabs hiá»ƒn thá»‹ vá»›i `clinicCode`
- [x] Employee: Auto-locked session clinic
- [x] Admin: Chá»n Ä‘Æ°á»£c báº¥t ká»³ clinic
- [x] Reload data khi chuyá»ƒn clinic

### US-6: Táº¡o Ä‘Æ¡n hÃ ng labo má»›i

**LÃ ** NhÃ¢n viÃªn/BÃ¡c sÄ©  
**TÃ´i muá»‘n** táº¡o Ä‘Æ¡n hÃ ng labo má»›i  
**Äá»ƒ** gá»­i yÃªu cáº§u lÃ m rÄƒng cho khÃ¡ch hÃ ng

**Acceptance Criteria**:

- [x] Button "Táº¡o Ä‘Æ¡n hÃ ng" má»Ÿ CreateLaboOrderModal
- [x] Form fields (Row 1): KhÃ¡ch hÃ ng (_), BÃ¡c sÄ© (_), XÆ°á»Ÿng (_), Loáº¡i hÃ ng labo (_)
- [x] Form fields (Row 2): NgÃ y Ä‘iá»u trá»‹ (_), Loáº¡i Ä‘Æ¡n hÃ ng (_), NgÆ°á»i gá»­i máº«u (\*)
- [x] Form fields (Row 3): Sá»‘ lÆ°á»£ng (\*), NgÃ y háº¹n láº¯p, YÃªu cáº§u chi tiáº¿t
- [x] Auto-fill pricing: Chá»n XÆ°á»Ÿng + Loáº¡i hÃ ng â†’ Auto load giÃ¡ vÃ  báº£o hÃ nh tá»« LaboService
- [x] Auto-calculate: Tá»•ng tiá»n = ÄÆ¡n giÃ¡ Ã— Sá»‘ lÆ°á»£ng (hiá»ƒn thá»‹ read-only)
- [x] Validation: Táº¥t cáº£ required fields, unique constraint (supplierId + laboItemId pháº£i tá»“n táº¡i trong LaboService)
- [x] Success: Refresh table, toast "ÄÃ£ táº¡o Ä‘Æ¡n hÃ ng labo"

### US-7: Sá»­a Ä‘Æ¡n hÃ ng labo

**LÃ ** NhÃ¢n viÃªn/Admin  
**TÃ´i muá»‘n** sá»­a thÃ´ng tin Ä‘Æ¡n hÃ ng  
**Äá»ƒ** cáº­p nháº­t khi cÃ³ thay Ä‘á»•i

**Acceptance Criteria**:

- [x] Click Edit button â†’ Má»Ÿ UpdateLaboOrderModal vá»›i data hiá»‡n táº¡i
- [x] Hiá»ƒn thá»‹ fields (disabled): KhÃ¡ch hÃ ng, BÃ¡c sÄ©, XÆ°á»Ÿng, Loáº¡i hÃ ng, NgÃ y Ä‘iá»u trá»‹, Loáº¡i Ä‘Æ¡n hÃ ng, NgÆ°á»i gá»­i
- [x] Cho phÃ©p sá»­a: Sá»‘ lÆ°á»£ng, NgÃ y háº¹n láº¯p, YÃªu cáº§u chi tiáº¿t
- [x] Permission logic:
  - Admin: LuÃ´n cho phÃ©p sá»­a
  - Employee: Chá»‰ sá»­a Ä‘Æ°á»£c khi returnDate === null (chÆ°a nháº­n máº«u)
- [x] Auto-recalculate: Tá»•ng tiá»n = ÄÆ¡n giÃ¡ Ã— Sá»‘ lÆ°á»£ng má»›i
- [x] Success: Update table, toast "ÄÃ£ cáº­p nháº­t Ä‘Æ¡n hÃ ng"

### US-8: Nháº­n máº«u vá» tá»« xÆ°á»Ÿng

**LÃ ** NhÃ¢n viÃªn  
**TÃ´i muá»‘n** xÃ¡c nháº­n Ä‘Ã£ nháº­n máº«u tá»« xÆ°á»Ÿng  
**Äá»ƒ** tracking tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng

**Acceptance Criteria**:

- [x] Button "Nháº­n máº«u" hiá»ƒn thá»‹ khi returnDate === null
- [x] Popconfirm: "Báº¡n cÃ³ cháº¯c cháº¯n Ä‘Ã£ nháº­n máº«u nÃ y tá»« xÆ°á»Ÿng?"
- [x] Action: Set returnDate = now, receivedById = currentUserId
- [x] Success: Button biáº¿n máº¥t, toast "ÄÃ£ xÃ¡c nháº­n nháº­n máº«u", table refresh

### US-9: XÃ³a Ä‘Æ¡n hÃ ng

**LÃ ** Admin  
**TÃ´i muá»‘n** xÃ³a Ä‘Æ¡n hÃ ng nháº­p nháº§m  
**Äá»ƒ** dá»n dáº¹p dá»¯ liá»‡u

**Acceptance Criteria**:

- [x] Button Delete (chá»‰ Admin)
- [x] Popconfirm: "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y?"
- [x] Action: Soft delete (hoáº·c hard delete náº¿u chÆ°a cÃ³ rÃ ng buá»™c)
- [x] Success: XÃ³a khá»i table, toast "ÄÃ£ xÃ³a Ä‘Æ¡n hÃ ng"

---

## ğŸ¨ UI Design

### Structure

- **Component**: `LaboOrderDailyView.tsx` (client component)
- **Page**: `/labo-orders/daily`
- **Route**: `src/app/(private)/labo-orders/daily/page.tsx` (SSR with session)

### Components Hierarchy

```
LaboOrderDailyView
â”œâ”€â”€ PageHeaderWithDateNav (shared component)
â”œâ”€â”€ ClinicTabs (admin chá»n clinic)
â”œâ”€â”€ LaboOrderStatistics (KPI cards - 3 metrics)
â”œâ”€â”€ LaboOrderFilters (search + create button)
â””â”€â”€ CollapsibleTables (2 tables: Gá»­i Ä‘i + Nháº­n vá»)
```

### Date Navigation

- Component: `PageHeaderWithDateNav` (shared component)
- Hook: `useDateNavigation()`
- Default: Today
- Controls: Previous Day | Today | Next Day + DatePicker
- Format: YYYY-MM-DD (ISO) gá»­i lÃªn API

### Clinic Selection (Admin Only)

- Component: `ClinicTabs` (shared component)
- Display: Tabs vá»›i `clinicCode` vÃ  `colorCode`
- Employee: Auto-locked to session clinic
- Admin: Chá»n clinic Ä‘á»ƒ xem data

### Statistics (KPI) - 3 Cards

Component: `LaboOrderStatistics`:

| Metric          | Logic                               | Display     |
| --------------- | ----------------------------------- | ----------- |
| Gá»­i Ä‘i hÃ´m nay  | Count orders cÃ³ `sentDate` = date   | Count + VND |
| Nháº­n vá» hÃ´m nay | Count orders cÃ³ `returnDate` = date | Count + VND |

### Filters & Actions

- Component: `LaboOrderFilters`
- **BÃªn trÃ¡i**: Search Input (tÃ¬m theo tÃªn khÃ¡ch, tÃªn xÆ°á»Ÿng - filter local)
- **BÃªn pháº£i**:
  - Export Excel button (optional)
  - Create button: Má»Ÿ `CreateLaboOrderModal`

### Collapsible Tables - 2 Tables

#### Table 1: Máº«u Gá»­i Äi (Máº·c Ä‘á»‹nh má»Ÿ)

- **Title**: "ğŸ“¤ Máº«u Gá»­i Äi ({count})"
- **Data**: Orders cÃ³ `sentDate` = date
- **Sort**: Fixed `createdAt desc` (má»›i nháº¥t trÆ°á»›c)

#### Table 2: Máº«u Nháº­n Vá» (Máº·c Ä‘á»‹nh má»Ÿ)

- **Title**: "ğŸ“¥ Máº«u Nháº­n Vá» ({count})"
- **Data**: Orders cÃ³ `returnDate` = date
- **Sort**: Fixed `returnDate asc` (sá»›m nháº¥t trÆ°á»›c)

**Shared Features:**

- No pagination: Load táº¥t cáº£ trong 1 trang
- Loading state: Skeleton
- Empty state: "KhÃ´ng cÃ³ máº«u {gá»­i Ä‘i/nháº­n vá»} trong ngÃ y"

### ğŸ“Š Table Columns (Both Tables)

| Column        | Width | Type    | Description                                                                                                     |
| ------------- | ----- | ------- | --------------------------------------------------------------------------------------------------------------- |
| KhÃ¡ch hÃ ng    | 170px | Mixed   | Line 1: `{fullName}` **clickable link** â†’ navigate to `/customers/{customerId}`<br>Line 2: Tag `{customerCode}` |
| BÃ¡c sÄ©        | 120px | Text    | `{doctor.fullName}`                                                                                             |
| NgÃ y Ä‘iá»u trá»‹ | 120px | Date    | Format: `DD/MM/YYYY` - `{treatmentDate}`                                                                        |
| Loáº¡i Ä‘Æ¡n hÃ ng | 100px | Text    | `{orderType}` - "LÃ m má»›i" hoáº·c "Báº£o hÃ nh"                                                                       |
| XÆ°á»Ÿng         | 120px | Text    | `{supplier.shortName}` or `{supplier.name}`                                                                     |
| Loáº¡i rÄƒng     | 140px | Text    | Line 1: `{laboItem.name}`<br>Line 2: Secondary text `{serviceGroupLabel}` (nhá» hÆ¡n, mÃ u xÃ¡m)                    |
| SL            | 50px  | Number  | `{quantity}`                                                                                                    |
| NgÃ y gá»­i máº«u  | 140px | Date    | Format: `DD/MM/YYYY HH:mm` - `{sentDate}`                                                                       |
| NgÃ y háº¹n láº¯p  | 120px | Date    | Format: `DD/MM/YYYY` - `{expectedFitDate}` (nullable)                                                           |
| NgÃ y nháº­n máº«u | 140px | Date    | Format: `DD/MM/YYYY HH:mm` - `{returnDate}` (nullable)                                                          |
| YÃªu cáº§u       | 150px | Text    | `{detailRequirement}` - Truncate vá»›i tooltip                                                                    |
| Thao tÃ¡c      | 150px | Actions | Space with Divider: Nháº­n máº«u (Popconfirm), Edit button, Delete button                                           |

**Note:**

- KhÃ´ng cÃ³ sorter/filter (dá»¯ liá»‡u Ã­t, load fixed)
- Scroll width: ~910px
- Mobile: Responsive collapse

### Row Actions

**Layout**: Space with vertical dividers between actions

**Actions:**

1. **Nháº­n máº«u** (`CheckOutlined`):

   - Hiá»ƒn thá»‹: Chá»‰ khi `returnDate === null` (chÆ°a nháº­n máº«u)
   - Popconfirm: "Báº¡n cÃ³ cháº¯c cháº¯n Ä‘Ã£ nháº­n máº«u nÃ y tá»« xÆ°á»Ÿng?"
   - Action: Call Server Action `receiveLaboOrder(id)`
   - Result: Cáº­p nháº­t `returnDate = now`, `receivedById = currentUserId`

2. **Edit** (`EditOutlined`):

   - Permission: `labo-orders:update`
   - Conditional Display:
     - Admin: LuÃ´n hiá»ƒn thá»‹ (cÃ³ thá»ƒ sá»­a má»i tráº¡ng thÃ¡i)
     - Employee: Chá»‰ hiá»ƒn thá»‹ khi `returnDate === null` (chÆ°a nháº­n máº«u)
   - Tooltip:
     - Admin: "Sá»­a"
     - Employee + Ä‘Ã£ nháº­n máº«u: "Chá»‰ admin má»›i sá»­a Ä‘Æ°á»£c Ä‘Æ¡n Ä‘Ã£ nháº­n máº«u"
   - Disabled: Employee khi `returnDate !== null`
   - Action: Má»Ÿ modal edit vá»›i full form (navigate to management page)

3. **Delete** (`DeleteOutlined`):
   - Permission: `labo-orders:delete`
   - Popconfirm: "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y?"
   - Action: Soft delete

### Query Logic

**Máº«u gá»­i Ä‘i**: Filter `sentDate = selected date`

**Máº«u nháº­n vá»**: Filter `returnDate = selected date`

### Response Type

```typescript
DailyLaboOrderResponse {
  id: string

  customer: {
    id: string
    fullName: string
    customerCode: string
  }

  doctor: {
    id: string
    fullName: string
  }

  treatmentDate: string          // "2025-12-08" (YYYY-MM-DD)
  orderType: string              // "LÃ m má»›i" | "Báº£o hÃ nh"

  sentBy: {
    id: string
    fullName: string
  }

  supplier: {
    id: string
    name: string
    shortName: string | null
  }

  laboItem: {
    name: string
    serviceGroup: string         // "rang-toan-su"
    serviceGroupLabel: string    // "RÄƒng toÃ n sá»©"
  }

  quantity: number
  totalCost: number

  sentDate: string               // ISO DateTime
  returnDate: string | null      // ISO DateTime
  expectedFitDate: string | null // "2025-12-15" (YYYY-MM-DD)

  detailRequirement: string | null
}
```

### Statistics Response

```typescript
DailyStatistics {
  sentToday: {
    count: number
    totalCost: number
  }

  returnedToday: {
    count: number
    totalCost: number
  }
}
```

---

## ğŸ’¾ Data Model

### Prisma Model

```prisma
model LaboOrder {
  id String @id @default(uuid())

  // References
  customerId String
  doctorId   String
  supplierId String
  laboItemId String
  clinicId   String

  // Business Fields (NEW)
  treatmentDate DateTime  @db.Date       // NgÃ y bÃ¡c sÄ© Ä‘iá»u trá»‹ (required)
  orderType     String                   // "LÃ m má»›i" | "Báº£o hÃ nh" (required)
  sentById      String                   // NhÃ¢n viÃªn gá»­i máº«u Ä‘i xÆ°á»Ÿng (required)

  // Pricing (Snapshot from LaboService at creation time)
  unitPrice  Int    // Snapshot price per unit
  quantity   Int    // Sá»‘ lÆ°á»£ng
  totalCost  Int    // = unitPrice * quantity
  warranty   String // Snapshot warranty: "5-nam"

  // Dates
  sentDate        DateTime  @default(now()) @db.Timestamptz // NgÃ y gá»­i máº«u Ä‘i xÆ°á»Ÿng (auto-set)
  returnDate      DateTime? @db.Timestamptz // NgÃ y nháº­n máº«u vá» tá»« xÆ°á»Ÿng (nullable)
  expectedFitDate DateTime? @db.Date // NgÃ y dá»± kiáº¿n láº¯p cho khÃ¡ch (optional, nullable)

  // Details
  detailRequirement String? // Ghi chÃº yÃªu cáº§u chi tiáº¿t cho xÆ°á»Ÿng

  // Tracking
  receivedById String? // NhÃ¢n viÃªn xÃ¡c nháº­n nháº­n máº«u

  // Metadata
  createdById String
  updatedById String
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Relations
  customer Customer @relation(fields: [customerId], references: [id])
  doctor   Employee @relation("DoctorLaboOrders", fields: [doctorId], references: [id])
  sentBy   Employee @relation("SentLaboOrders", fields: [sentById], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])
  laboItem LaboItem @relation(fields: [laboItemId], references: [id])
  clinic   Clinic   @relation(fields: [clinicId], references: [id])

  receivedBy Employee? @relation("ReceivedLaboOrders", fields: [receivedById], references: [id])
  createdBy  Employee  @relation("CreatedLaboOrders", fields: [createdById], references: [id])
  updatedBy  Employee  @relation("UpdatedLaboOrders", fields: [updatedById], references: [id])

  // Indexes
  @@index([clinicId, sentDate])
  @@index([clinicId, returnDate])
  @@index([customerId])
  @@index([supplierId])
}
```

**Key Design Decisions:**

- **Business Fields (NEW)**:
  - `treatmentDate`: DateTime @db.Date - NgÃ y bÃ¡c sÄ© Ä‘iá»u trá»‹ (required, chá»‰ ngÃ y)
  - `orderType`: String - "LÃ m má»›i" hoáº·c "Báº£o hÃ nh" (required, lÆ°u trá»±c tiáº¿p tiáº¿ng Viá»‡t)
  - `sentById`: String - NhÃ¢n viÃªn gá»­i máº«u Ä‘i xÆ°á»Ÿng (required, relation to Employee)
- **Snapshot Pricing**: `unitPrice`, `warranty` lÆ°u giÃ¡ táº¡i thá»i Ä‘iá»ƒm táº¡o order (khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng khi LaboService thay Ä‘á»•i giÃ¡)
- **Date Fields**:
  - `treatmentDate`: DateTime @db.Date (required, chá»‰ ngÃ y)
  - `sentDate`: DateTime @db.Timestamptz (auto-set to now(), bao gá»“m giá» phÃºt giÃ¢y)
  - `returnDate`: DateTime? @db.Timestamptz (nullable, bao gá»“m giá» phÃºt giÃ¢y)
  - `expectedFitDate`: DateTime? @db.Date (nullable, chá»‰ ngÃ y)
- **Tracking**:
  - `sentById`: NhÃ¢n viÃªn gá»­i máº«u (required, set khi táº¡o order)
  - `receivedById`: NhÃ¢n viÃªn xÃ¡c nháº­n nháº­n máº«u (nullable - chá»‰ set khi nháº­n)
- **Indexes**: Optimize queries theo clinic + date range

---

## ğŸ”„ Server Actions & API

### Server Actions

**Location**: `src/server/actions/labo-orders/`

#### `getLaboOrdersDaily`

- **Input**: `{ date, type: 'sent' | 'returned', clinicId? }`
- **Permission**: `labo-orders:view-daily`
- **Returns**: `{ items: DailyLaboOrderResponse[], total: number }`

#### `getDailyStatistics`

- **Input**: `{ date, clinicId? }`
- **Returns**: `DailyStatistics`

#### `receiveLaboOrder`

- **Input**: `{ orderId }`
- **Permission**: `labo-orders:receive`
- **Logic**:
  - Update `returnDate = now`
  - Update `receivedById = currentUserId`
- **Validation**: Order must exist, `returnDate` must be null
- **Returns**: `{ success: boolean }`

---

## ğŸ” Permissions

### View

```typescript
"labo-orders:view-daily";
```

- Roles: admin, employee

### Receive Order

```typescript
"labo-orders:receive";
```

- Roles: admin, employee

### Update Order

```typescript
"labo-orders:update";
```

- Roles: admin, employee
- Business Rule:
  - Admin: CÃ³ thá»ƒ sá»­a má»i order (ká»ƒ cáº£ Ä‘Ã£ nháº­n máº«u)
  - Employee: Chá»‰ sá»­a Ä‘Æ°á»£c order chÆ°a nháº­n máº«u (`returnDate === null`)

### Delete Order

```typescript
"labo-orders:delete";
```

- Roles: admin

### Create Order

```typescript
"labo-orders:create";
```

- Roles: admin, employee

---

## ğŸ§ª Test Cases

### TC-1: View Sent Today

```
Given: CÃ³ 5 orders vá»›i sentDate = hÃ´m nay
When: Má»Ÿ tab "Máº«u gá»­i Ä‘i"
Then:
  - Hiá»ƒn thá»‹ 5 orders
  - Badge "Máº«u gá»­i Ä‘i (5)"
  - Statistics card: 5 Ä‘Æ¡n
```

### TC-2: View Returned Today

```
Given: CÃ³ 3 orders vá»›i returnDate = hÃ´m nay
When: Má»Ÿ tab "Máº«u nháº­n vá»"
Then:
  - Hiá»ƒn thá»‹ 3 orders
  - Badge "Máº«u nháº­n vá» (3)"
```

### TC-3: Navigate to Yesterday

```
Given: HÃ´m nay cÃ³ 5 orders gá»­i Ä‘i
And: HÃ´m qua cÃ³ 3 orders gá»­i Ä‘i
When: Click "â—€ HÃ´m qua"
Then:
  - URL: ?date=2025-12-02
  - Hiá»ƒn thá»‹ 3 orders cá»§a hÃ´m qua
  - Date picker: "02/12/2025"
```

### TC-4: Receive Sample

```
Given: Order cÃ³ returnDate = null (chÆ°a nháº­n máº«u)
When: Click "Nháº­n máº«u" vÃ  xÃ¡c nháº­n popconfirm
Then:
  - returnDate = now
  - receivedById = current user
  - Button "Nháº­n máº«u" biáº¿n máº¥t
  - Toast success "ÄÃ£ xÃ¡c nháº­n nháº­n máº«u"
  - Table refresh
```

### TC-5: Filter by Clinic

```
Given: PNK cÃ³ 5 orders, HCM cÃ³ 3 orders
When: Click tab "PNK (5)"
Then: Chá»‰ hiá»ƒn thá»‹ 5 orders cá»§a PNK
```

### TC-6: Edit Order - Admin Can Edit Returned Order

```
Given: Admin user, order cÃ³ returnDate !== null (Ä‘Ã£ nháº­n máº«u)
When: Click button Edit
Then:
  - Button enabled, khÃ´ng bá»‹ disable
  - Navigate to management page vá»›i order ID
  - Modal/form edit hiá»ƒn thá»‹ vá»›i dá»¯ liá»‡u order
```

### TC-6.1: Edit Order - Employee Cannot Edit Returned Order

```
Given: Employee user, order cÃ³ returnDate !== null (Ä‘Ã£ nháº­n máº«u)
When: Hover button Edit
Then:
  - Button disabled
  - Tooltip: "Chá»‰ admin má»›i sá»­a Ä‘Æ°á»£c Ä‘Æ¡n Ä‘Ã£ nháº­n máº«u"
  - Click khÃ´ng cÃ³ tÃ¡c dá»¥ng
```

### TC-6.2: Edit Order - Employee Can Edit Pending Order

```
Given: Employee user, order cÃ³ returnDate === null (chÆ°a nháº­n máº«u)
When: Click button Edit
Then:
  - Button enabled
  - Navigate to management page vá»›i order ID
  - Modal/form edit hiá»ƒn thá»‹ vá»›i dá»¯ liá»‡u order
```

### TC-7: Delete Order

```
Given: Admin user, order tá»“n táº¡i
When: Click Delete button vÃ  xÃ¡c nháº­n popconfirm
Then:
  - Order bá»‹ soft delete
  - Toast success "ÄÃ£ xÃ³a Ä‘Æ¡n hÃ ng"
  - Table refresh, order biáº¿n máº¥t khá»i danh sÃ¡ch
```

---

## ğŸ’¡ Business Logic

### Daily Tracking Workflow

```mermaid
graph LR
  A[Táº¡o Order] --> B[Gá»­i máº«u - sentDate]
  B --> C[XÆ°á»Ÿng lÃ m]
  C --> D[Tráº£ vá» - returnDate]
  D --> E[Láº¯p cho khÃ¡ch]
```

### Customer Notification Reminder

**Rule**: Khi order cÃ³ `returnDate` = hÃ´m nay, hiá»ƒn thá»‹ reminder "âœ… Gá»i nháº¯c khÃ¡ch Ä‘áº¿n láº¯p"

**Implementation** (Future):

- Auto SMS/Zalo notification
- Track notification sent status

---

## ğŸ“Š Related Features

### Integration Points

1. **Customer Detail - Tab Labo**:

   - Link tá»« customer name â†’ Customer detail
   - Hiá»ƒn thá»‹ táº¥t cáº£ orders cá»§a khÃ¡ch

2. **Labo Reports (016.4)**:

   - Daily view chá»‰ tracking, Reports Ä‘á»ƒ phÃ¢n tÃ­ch

3. **Calendar Integration** (Future):
   - returnDate sync vá»›i Calendar
   - Remind doctor/staff

---

## ğŸ“‹ Implementation Checklist

### Backend

- [x] Repository: `getDailyLaboOrders(date, type, clinicId)` - Query with date range filter
- [x] Repository: `receiveLaboOrder(id, receivedById)` - Update returnDate & receivedById
- [x] Repository: `create(data)` - Create new LaboOrder with snapshot pricing
- [x] Repository: `update(id, data)` - Update LaboOrder fields
- [x] Repository: `delete(id)` - Delete LaboOrder
- [x] Service: Business logic layer for daily operations
- [x] Server Action: `createLaboOrder` - Táº¡o Ä‘Æ¡n hÃ ng má»›i vá»›i snapshot pricing
- [x] Server Action: `updateLaboOrder` - Cáº­p nháº­t Ä‘Æ¡n hÃ ng
- [x] Server Action: `receiveLaboOrder` - XÃ¡c nháº­n nháº­n máº«u
- [x] Server Action: `deleteLaboOrder` - XÃ³a Ä‘Æ¡n hÃ ng
- [x] Mappers: Transform Prisma entities to API responses

### Frontend

- [x] API Routes (`src/app/api/v1/labo-orders/`):
  - [x] `daily/route.ts` - GET daily orders list
- [x] Hooks (`src/features/labo-orders/hooks/`):
  - [x] `useDailyLaboOrders` - Query hook wrap API route
  - [x] `useReceiveLaboOrder` - Mutation hook with invalidation
  - [x] `useDeleteLaboOrder` - Mutation hook with invalidation
- [x] Components (`src/features/labo-orders/components/`):
  - [x] `LaboOrderStatistics.tsx` - 2 KPI cards (Gá»­i Ä‘i + Nháº­n vá»)
  - [x] `LaboOrderFilters.tsx` - Search + Create button
  - [x] `LaboOrderTable.tsx` - Table with all columns + actions
  - [x] `CreateLaboOrderModal.tsx` - Form táº¡o Ä‘Æ¡n hÃ ng má»›i
  - [x] `UpdateLaboOrderModal.tsx` - Form cáº­p nháº­t Ä‘Æ¡n hÃ ng
- [x] View: `LaboOrdersDailyView.tsx` - Main daily view component
- [x] Constants: LABO_ORDER_TYPE_OPTIONS, query keys
- [x] Schemas: Zod validation (CreateLaboOrderRequest, UpdateLaboOrderRequest, DailyLaboOrderResponse)

### UI/UX

- [x] Responsive table (horizontal scroll on mobile)
- [x] Loading skeletons for tables and statistics
- [x] Empty states ("KhÃ´ng cÃ³ dá»¯ liá»‡u")
- [x] Error handling with user-friendly messages
- [x] Toast notifications for success/error actions
- [x] Popconfirm for destructive actions (Nháº­n máº«u, XÃ³a)
- [x] Permission-based UI (Admin vs Employee for Edit/Delete buttons)

---

## ğŸ¯ Future Enhancements

### Phase 2

- [ ] Calendar view (monthly view vá»›i dots)
- [ ] Drag-and-drop to reschedule returnDate
- [ ] Print delivery notes (phiáº¿u gá»­i xÆ°á»Ÿng)

### Phase 3

- [ ] Auto SMS reminder to customers
- [ ] WhatsApp/Zalo integration
- [ ] Track delivery status with supplier API
- [ ] Photo upload (trÆ°á»›c/sau láº¯p rÄƒng)

---

## ğŸ”— Related Requirements

- **016.1 Labo Item Master**: Reference LaboItem
- **016.2 Labo Service Prices**: Get pricing info
- **016.4 Labo Reports**: Analytics vÃ  phÃ¢n tÃ­ch
- **008 Appointment**: returnDate cÃ³ thá»ƒ sync vá»›i appointment
- **007.1 Customer Detail**: Link to customer tá»« daily view

---

**Version**: 2.0  
**Last Updated**: 2025-12-08  
**Status**: âœ… Implemented

---

## ğŸ² Decision Log

### Database & Business Rules

- âœ… **Denormalization Strategy** (Added 2025-12-08):
  - `laboServiceId`: Link to LaboService for audit trail (which pricing version was used)
  - `supplierId`, `laboItemId`: Denormalized for query performance (avoid joins in common queries)
  - Trade-off: +2 redundant fields for +100% query speed improvement
- âœ… **Snapshot Pricing Strategy**:
  - LÆ°u `unitPrice`, `warranty` tá»« LaboService táº¡i thá»i Ä‘iá»ƒm táº¡o order
  - Order khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng khi xÆ°á»Ÿng thay Ä‘á»•i giÃ¡
  - BÃ¡o cÃ¡o chÃ­nh xÃ¡c chi phÃ­ thá»±c táº¿ Ä‘Ã£ phÃ¡t sinh
- âœ… **Business Fields** (Added 2025-12-08):
  - `treatmentDate` (required): NgÃ y bÃ¡c sÄ© Ä‘iá»u trá»‹ - DateTime @db.Date
  - `orderType` (required): "LÃ m má»›i" | "Báº£o hÃ nh" - LÆ°u trá»±c tiáº¿p tiáº¿ng Viá»‡t (khÃ´ng dÃ¹ng code)
  - `sentById` (required): NhÃ¢n viÃªn gá»­i máº«u - relation to Employee
- âœ… **Date Fields**:
  - `sentDate` (required): NgÃ y gá»­i máº«u Ä‘i xÆ°á»Ÿng - Auto-set to now()
  - `returnDate` (nullable): NgÃ y nháº­n máº«u vá» - set khi click "Nháº­n máº«u"
  - `expectedFitDate` (nullable): NgÃ y dá»± kiáº¿n láº¯p - optional field
  - `treatmentDate` (required): NgÃ y Ä‘iá»u trá»‹ - required field
- âœ… **Tracking Fields**:
  - `sentById`: NhÃ¢n viÃªn gá»­i máº«u (required - set khi táº¡o order)
  - `receivedById`: NhÃ¢n viÃªn xÃ¡c nháº­n nháº­n máº«u (nullable - set khi click "Nháº­n máº«u")
- âŒ **Removed**: `toothPositions` - KhÃ´ng cáº§n thiáº¿t cho labo orders
- âœ… **Daily View Queries**:
  - Máº«u gá»­i Ä‘i: Filter `sentDate = date`
  - Máº«u nháº­n vá»: Filter `returnDate = date`
  - No pagination: Load all orders trong ngÃ y

### Repository Pattern

```typescript
// Complex + Server Fields pattern
type LaboOrderCreateInput = CreateLaboOrderRequest & {
  unitPrice: number; // Snapshot from LaboService
  totalCost: number; // Calculated: unitPrice * quantity
  warranty: string; // Snapshot from LaboService
  createdById: string; // Current user
  updatedById: string; // Current user
  clinicId: string; // Current user's clinic
};
```

### Permission Rules

**Quyá»n dá»±a trÃªn: Role + returnDate status**

#### CREATE

- Employee/Admin: Táº¡o cho clinic cá»§a mÃ¬nh
- **RÃ ng buá»™c**: Pháº£i chá»n supplier type = "labo-xuong-rang-gia"

#### UPDATE

| User Type | Condition                     | Allowed                       |
| --------- | ----------------------------- | ----------------------------- |
| Admin     | Always                        | âœ… Sá»­a táº¥t cáº£ fields          |
| Employee  | returnDate === null           | âœ… Sá»­a (trá»« pricing snapshot) |
| Employee  | returnDate !== null (Ä‘Ã£ nháº­n) | âŒ KhÃ´ng sá»­a                  |

#### DELETE

| User Type | Permission    |
| --------- | ------------- |
| Admin     | âœ… XÃ³a táº¥t cáº£ |
| Employee  | âŒ KhÃ´ng xÃ³a  |

#### QUICK ACTIONS (Receive Sample)

- Employee/Admin: XÃ¡c nháº­n nháº­n máº«u cho clinic cá»§a mÃ¬nh
- **Action**: Set `returnDate = now`, `receivedById = currentUserId`
- **Validation**: Order must exist, `returnDate` must be null

### Architecture

- âœ… **Hybrid**: GET qua API Routes + Mutations qua Server Actions
- âœ… **Daily View Pattern**: 2 collapsible tables (Sent/Returned)
- âœ… **Statistics**: Real-time KPI cards
- âœ… **Date Navigation**: Shared component `PageHeaderWithDateNav`
- âœ… **Clinic Tabs**: Admin can switch, Employee locked to own clinic

---
