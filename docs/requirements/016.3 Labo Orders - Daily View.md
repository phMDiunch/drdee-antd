# 016.3 Labo Orders - Daily View

## ğŸ“‹ Tá»•ng Quan

**Feature**: MÃ n hÃ¬nh theo dÃµi hÃ ng ngÃ y - Máº«u gá»­i Ä‘i vÃ  nháº­n vá»

**Má»¥c Ä‘Ã­ch**:

- Theo dÃµi máº«u gá»­i xÆ°á»Ÿng hÃ´m nay
- Theo dÃµi máº«u xÆ°á»Ÿng tráº£ vá» hÃ´m nay
- Checklist cÃ´ng viá»‡c hÃ ng ngÃ y
- Quick access Ä‘á»ƒ update status

**Route**: `/labo-orders/daily` (default route cá»§a Labo)

---

## ğŸ¯ User Stories

### US-1: Xem máº«u gá»­i Ä‘i hÃ´m nay

**LÃ ** NhÃ¢n viÃªn/BÃ¡c sÄ©  
**TÃ´i muá»‘n** xem danh sÃ¡ch máº«u gá»­i xÆ°á»Ÿng hÃ´m nay  
**Äá»ƒ** kiá»ƒm tra vÃ  Ä‘Ã³ng gÃ³i gá»­i Ä‘i

**Acceptance Criteria**:

- [ ] Collapsible Table "ğŸ“¤ Máº«u Gá»­i Äi" hiá»ƒn thá»‹ orders cÃ³ `sendDate` = date
- [ ] Badge Ä‘áº¿m sá»‘ lÆ°á»£ng: "Máº«u Gá»­i Äi (5)"
- [ ] Table columns: KhÃ¡ch hÃ ng, BÃ¡c sÄ©, XÆ°á»Ÿng, Loáº¡i rÄƒng, SL, GiÃ¡, Thao tÃ¡c
- [ ] Sort máº·c Ä‘á»‹nh: `createdAt desc` (má»›i nháº¥t trÆ°á»›c)
- [ ] Máº·c Ä‘á»‹nh: Má»Ÿ (expanded)

### US-2: Xem máº«u nháº­n vá» hÃ´m nay

**LÃ ** NhÃ¢n viÃªn/BÃ¡c sÄ©  
**TÃ´i muá»‘n** xem danh sÃ¡ch máº«u xÆ°á»Ÿng tráº£ vá» hÃ´m nay  
**Äá»ƒ** kiá»ƒm tra vÃ  xÃ¡c nháº­n nháº­n hÃ ng

**Acceptance Criteria**:

- [ ] Collapsible Table "ğŸ“¥ Máº«u Nháº­n Vá»" hiá»ƒn thá»‹ orders cÃ³ `returnDate` = date
- [ ] Badge Ä‘áº¿m sá»‘ lÆ°á»£ng: "Máº«u Nháº­n Vá» (3)"
- [ ] Table columns: TÆ°Æ¡ng tá»± table gá»­i Ä‘i
- [ ] Sort máº·c Ä‘á»‹nh: `returnDate asc` (sá»›m nháº¥t trÆ°á»›c)
- [ ] Máº·c Ä‘á»‹nh: Má»Ÿ (expanded)

### US-3: Äiá»u hÆ°á»›ng ngÃ y

**LÃ ** NhÃ¢n viÃªn  
**TÃ´i muá»‘n** xem máº«u cá»§a ngÃ y khÃ¡c  
**Äá»ƒ** tracking cÃ´ng viá»‡c quÃ¡ khá»©/tÆ°Æ¡ng lai

**Acceptance Criteria**:

- [ ] Date navigation: Previous Day | Today | Next Day + DatePicker
- [ ] URL sync: `/labo-orders/daily?date=2025-12-03`
- [ ] Default: HÃ´m nay
- [ ] Reload cáº£ 2 tables + statistics khi Ä‘á»•i ngÃ y

### US-4: Xem thá»‘ng kÃª tá»•ng quan

**LÃ ** Manager  
**TÃ´i muá»‘n** xem thá»‘ng kÃª hÃ´m nay  
**Äá»ƒ** náº¯m tÃ¬nh hÃ¬nh cÃ´ng viá»‡c

**Acceptance Criteria**:

- [ ] Statistics cards:
  - Gá»­i Ä‘i hÃ´m nay (count + totalCost)
  - Nháº­n vá» hÃ´m nay (count + totalCost)
- [ ] Auto refresh khi Ä‘á»•i ngÃ y hoáº·c clinic

### US-5: Filter theo clinic

**LÃ ** Admin  
**TÃ´i muá»‘n** chá»n clinic Ä‘á»ƒ xem data  
**Äá»ƒ** quáº£n lÃ½ tá»«ng chi nhÃ¡nh

**Acceptance Criteria**:

- [ ] Clinic Tabs hiá»ƒn thá»‹ vá»›i `clinicCode`
- [ ] Employee: Auto-locked session clinic
- [ ] Admin: Chá»n Ä‘Æ°á»£c báº¥t ká»³ clinic
- [ ] Reload data khi chuyá»ƒn clinic

---

## ğŸ¨ UI Design

### Structure

- **Component**: `LaboOrderDailyView.tsx` (client component)
- **Page**: `/labo-orders/daily`
- **Route**: `src/app/(private)/labo-orders/daily/page.tsx` (SSR with session)

### Components Hierarchy

```
LaboOrderDailyView
â”œâ”€â”€ PageHeaderWithDateNav (shared component)
â”œâ”€â”€ ClinicTabs (admin chá»n clinic)
â”œâ”€â”€ LaboOrderStatistics (KPI cards - 3 metrics)
â”œâ”€â”€ LaboOrderFilters (search + create button)
â””â”€â”€ CollapsibleTables (2 tables: Gá»­i Ä‘i + Nháº­n vá»)
```

### Date Navigation

- Component: `PageHeaderWithDateNav` (shared component)
- Hook: `useDateNavigation()`
- Default: Today
- Controls: Previous Day | Today | Next Day + DatePicker
- Format: YYYY-MM-DD (ISO) gá»­i lÃªn API

### Clinic Selection (Admin Only)

- Component: `ClinicTabs` (shared component)
- Display: Tabs vá»›i `clinicCode` vÃ  `colorCode`
- Employee: Auto-locked to session clinic
- Admin: Chá»n clinic Ä‘á»ƒ xem data

### Statistics (KPI) - 3 Cards

Component: `LaboOrderStatistics`:

| Metric          | Logic                               | Display     |
| --------------- | ----------------------------------- | ----------- |
| Gá»­i Ä‘i hÃ´m nay  | Count orders cÃ³ `sendDate` = date   | Count + VND |
| Nháº­n vá» hÃ´m nay | Count orders cÃ³ `returnDate` = date | Count + VND |

### Filters & Actions

- Component: `LaboOrderFilters`
- **BÃªn trÃ¡i**: Search Input (tÃ¬m theo tÃªn khÃ¡ch, tÃªn xÆ°á»Ÿng - filter local)
- **BÃªn pháº£i**:
  - Export Excel button (optional)
  - Create button: Má»Ÿ `CreateLaboOrderModal`

### Collapsible Tables - 2 Tables

#### Table 1: Máº«u Gá»­i Äi (Máº·c Ä‘á»‹nh má»Ÿ)

- **Title**: "ğŸ“¤ Máº«u Gá»­i Äi ({count})"
- **Data**: Orders cÃ³ `sendDate` = date
- **Sort**: Fixed `createdAt desc` (má»›i nháº¥t trÆ°á»›c)

#### Table 2: Máº«u Nháº­n Vá» (Máº·c Ä‘á»‹nh má»Ÿ)

- **Title**: "ğŸ“¥ Máº«u Nháº­n Vá» ({count})"
- **Data**: Orders cÃ³ `returnDate` = date
- **Sort**: Fixed `returnDate asc` (sá»›m nháº¥t trÆ°á»›c)

**Shared Features:**

- No pagination: Load táº¥t cáº£ trong 1 trang
- Loading state: Skeleton
- Empty state: "KhÃ´ng cÃ³ máº«u {gá»­i Ä‘i/nháº­n vá»} trong ngÃ y"

### ğŸ“Š Table Columns (Both Tables)

| Column     | Width | Type    | Description                                                                                                     |
| ---------- | ----- | ------- | --------------------------------------------------------------------------------------------------------------- |
| KhÃ¡ch hÃ ng | 170px | Mixed   | Line 1: `{fullName}` **clickable link** â†’ navigate to `/customers/{customerId}`<br>Line 2: Tag `{customerCode}` |
| BÃ¡c sÄ©     | 120px | Text    | `{doctor.fullName}`                                                                                             |
| XÆ°á»Ÿng      | 120px | Text    | `{supplier.name}`                                                                                               |
| Loáº¡i rÄƒng  | 140px | Text    | Line 1: `{laboItem.name}`<br>Line 2: Secondary text `{serviceGroupLabel}` (nhá» hÆ¡n, mÃ u xÃ¡m)                    |
| SL         | 50px  | Number  | `{quantity}`                                                                                                    |
| GiÃ¡        | 100px | Text    | Format VND: `{totalCost.toLocaleString()} â‚«`                                                                    |
| Thao tÃ¡c   | 150px | Actions | Space with Divider: Nháº­n máº«u (Popconfirm), Edit button, Delete button                                           |

**Note:**

- KhÃ´ng cÃ³ sorter/filter (dá»¯ liá»‡u Ã­t, load fixed)
- Scroll width: ~910px
- Mobile: Responsive collapse

### Row Actions

**Layout**: Space with vertical dividers between actions

**Actions:**

1. **Nháº­n máº«u** (`CheckOutlined`):

   - Hiá»ƒn thá»‹: Chá»‰ khi `returnDate === null` (chÆ°a nháº­n máº«u)
   - Popconfirm: "Báº¡n cÃ³ cháº¯c cháº¯n Ä‘Ã£ nháº­n máº«u nÃ y tá»« xÆ°á»Ÿng?"
   - Action: Call Server Action `receiveLaboOrder(id)`
   - Result: Cáº­p nháº­t `returnDate = now`, `receivedById = currentUserId`

2. **Edit** (`EditOutlined`):

   - Permission: `labo-orders:update`
   - Action: Má»Ÿ modal edit vá»›i full form (navigate to management page)

3. **Delete** (`DeleteOutlined`):
   - Permission: `labo-orders:delete`
   - Popconfirm: "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a Ä‘Æ¡n hÃ ng nÃ y?"
   - Action: Soft delete

### Query Logic

**Máº«u gá»­i Ä‘i**: Filter `sendDate = selected date`

**Máº«u nháº­n vá»**: Filter `returnDate = selected date`

### Response Type

```typescript
DailyLaboOrderResponse {
  id: string

  customer: {
    id: string
    fullName: string
    customerCode: string
  }

  doctor: {
    id: string
    fullName: string
  }

  supplier: {
    id: string
    name: string
  }

  laboItem: {
    name: string
    serviceGroup: string         // "rang-toan-su"
    serviceGroupLabel: string    // "RÄƒng toÃ n sá»©"
  }

  quantity: number
  totalCost: number

  sendDate: string
  returnDate: string | null
  expectedFitDate: string | null

  detailRequirement: string | null
}
```

### Statistics Response

```typescript
DailyStatistics {
  sentToday: {
    count: number
    totalCost: number
  }

  returnedToday: {
    count: number
    totalCost: number
  }
}
```

---

## ğŸ”„ Server Actions & API

### Server Actions

**Location**: `src/server/actions/labo-orders/`

#### `getLaboOrdersDaily`

- **Input**: `{ date, type: 'sent' | 'returned', clinicId? }`
- **Permission**: `labo-orders:view-daily`
- **Returns**: `{ items: DailyLaboOrderResponse[], total: number }`

#### `getDailyStatistics`

- **Input**: `{ date, clinicId? }`
- **Returns**: `DailyStatistics`

#### `receiveLaboOrder`

- **Input**: `{ orderId }`
- **Permission**: `labo-orders:receive`
- **Logic**:
  - Update `returnDate = now`
  - Update `receivedById = currentUserId`
- **Validation**: Order must exist, `returnDate` must be null
- **Returns**: `{ success: boolean }`

---

## ğŸ” Permissions

### View

```typescript
"labo-orders:view-daily";
```

- Roles: admin, employee

### Receive Order

```typescript
"labo-orders:receive";
```

- Roles: admin, employee

### Update Order

```typescript
"labo-orders:update";
```

- Roles: admin, employee

### Delete Order

```typescript
"labo-orders:delete";
```

- Roles: admin

### Create Order

```typescript
"labo-orders:create";
```

- Roles: admin, employee

---

## ğŸ§ª Test Cases

### TC-1: View Sent Today

```
Given: CÃ³ 5 orders vá»›i sendDate = hÃ´m nay
When: Má»Ÿ tab "Máº«u gá»­i Ä‘i"
Then:
  - Hiá»ƒn thá»‹ 5 orders
  - Badge "Máº«u gá»­i Ä‘i (5)"
  - Statistics card: 5 Ä‘Æ¡n
```

### TC-2: View Returned Today

```
Given: CÃ³ 3 orders vá»›i returnDate = hÃ´m nay
When: Má»Ÿ tab "Máº«u nháº­n vá»"
Then:
  - Hiá»ƒn thá»‹ 3 orders
  - Badge "Máº«u nháº­n vá» (3)"
```

### TC-3: Navigate to Yesterday

```
Given: HÃ´m nay cÃ³ 5 orders gá»­i Ä‘i
And: HÃ´m qua cÃ³ 3 orders gá»­i Ä‘i
When: Click "â—€ HÃ´m qua"
Then:
  - URL: ?date=2025-12-02
  - Hiá»ƒn thá»‹ 3 orders cá»§a hÃ´m qua
  - Date picker: "02/12/2025"
```

### TC-4: Receive Sample

```
Given: Order cÃ³ returnDate = null (chÆ°a nháº­n máº«u)
When: Click "Nháº­n máº«u" vÃ  xÃ¡c nháº­n popconfirm
Then:
  - returnDate = now
  - receivedById = current user
  - Button "Nháº­n máº«u" biáº¿n máº¥t
  - Toast success "ÄÃ£ xÃ¡c nháº­n nháº­n máº«u"
  - Table refresh
```

### TC-5: Filter by Clinic

```
Given: PNK cÃ³ 5 orders, HCM cÃ³ 3 orders
When: Click tab "PNK (5)"
Then: Chá»‰ hiá»ƒn thá»‹ 5 orders cá»§a PNK
```

### TC-6: Edit Order

```
Given: User cÃ³ permission "labo-orders:update"
When: Click button Edit
Then:
  - Navigate to management page vá»›i order ID
  - Modal/form edit hiá»ƒn thá»‹ vá»›i dá»¯ liá»‡u order
```

### TC-7: Delete Order

```
Given: Admin user, order tá»“n táº¡i
When: Click Delete button vÃ  xÃ¡c nháº­n popconfirm
Then:
  - Order bá»‹ soft delete
  - Toast success "ÄÃ£ xÃ³a Ä‘Æ¡n hÃ ng"
  - Table refresh, order biáº¿n máº¥t khá»i danh sÃ¡ch
```

---

## ğŸ’¡ Business Logic

### Daily Tracking Workflow

```mermaid
graph LR
  A[Táº¡o Order] --> B[Gá»­i máº«u - sendDate]
  B --> C[XÆ°á»Ÿng lÃ m]
  C --> D[Tráº£ vá» - returnDate]
  D --> E[Láº¯p cho khÃ¡ch]
```

### Customer Notification Reminder

**Rule**: Khi order cÃ³ `returnDate` = hÃ´m nay, hiá»ƒn thá»‹ reminder "âœ… Gá»i nháº¯c khÃ¡ch Ä‘áº¿n láº¯p"

**Implementation** (Future):

- Auto SMS/Zalo notification
- Track notification sent status

---

## ğŸ“Š Related Features

### Integration Points

1. **Customer Detail - Tab Labo**:

   - Link tá»« customer name â†’ Customer detail
   - Hiá»ƒn thá»‹ táº¥t cáº£ orders cá»§a khÃ¡ch

2. **Labo Reports (016.4)**:

   - Daily view chá»‰ tracking, Reports Ä‘á»ƒ phÃ¢n tÃ­ch

3. **Calendar Integration** (Future):
   - returnDate sync vá»›i Calendar
   - Remind doctor/staff

---

## ğŸ“‹ Implementation Checklist

### Backend

- [ ] Repository: `getDailyLaboOrders(date, type, clinicId)` - Query with date range filter
- [ ] Repository: `getDailyStatistics(date, clinicId)` - Aggregate sent/returned counts
- [ ] Repository: `receiveLaboOrder(id, receivedById)` - Update returnDate & receivedById
- [ ] Repository: `deleteLaboOrder(id)` - Soft delete
- [ ] Service: Business logic layer for daily operations
- [ ] Server Action: `getLaboOrdersDaily` - Get daily orders list
- [ ] Server Action: `getDailyStatistics` - Get statistics
- [ ] Server Action: `receiveLaboOrder` - XÃ¡c nháº­n nháº­n máº«u
- [ ] Server Action: `deleteLaboOrder` - XÃ³a Ä‘Æ¡n hÃ ng

### Frontend

- [ ] Hooks (`src/features/labo-orders/hooks/`):
  - [ ] `useLaboOrdersDaily` - Query hook wrap getLaboOrdersDaily
  - [ ] `useDailyStatistics` - Query hook wrap getDailyStatistics
  - [ ] `useReceiveLaboOrder` - Mutation hook with invalidation
  - [ ] `useDeleteLaboOrder` - Mutation hook with invalidation
- [ ] Components (`src/features/labo-orders/components/`):
  - [ ] `LaboOrderStatistics.tsx` - 2 KPI cards
  - [ ] `LaboOrderFilters.tsx` - Search + Create button
  - [ ] `LaboOrderCollapsibleTables.tsx` - 2 collapsible tables (Sent/Returned)
- [ ] View: `LaboDailyView.tsx` - Main daily view component
- [ ] Constants: Query keys, messages

### UI/UX

- [ ] Responsive table (mobile friendly)
- [ ] Loading skeletons for tables and statistics
- [ ] Empty states ("KhÃ´ng cÃ³ máº«u gá»­i Ä‘i hÃ´m nay")
- [ ] Error handling with user-friendly messages
- [ ] Toast notifications for success/error actions

---

## ğŸ¯ Future Enhancements

### Phase 2

- [ ] Calendar view (monthly view vá»›i dots)
- [ ] Drag-and-drop to reschedule returnDate
- [ ] Print delivery notes (phiáº¿u gá»­i xÆ°á»Ÿng)

### Phase 3

- [ ] Auto SMS reminder to customers
- [ ] WhatsApp/Zalo integration
- [ ] Track delivery status with supplier API
- [ ] Photo upload (trÆ°á»›c/sau láº¯p rÄƒng)

---

## ğŸ”— Related Requirements

- **016.1 Labo Item Master**: Reference LaboItem
- **016.2 Labo Service Prices**: Get pricing info
- **016.4 Labo Reports**: Analytics vÃ  phÃ¢n tÃ­ch
- **008 Appointment**: returnDate cÃ³ thá»ƒ sync vá»›i appointment
- **007.1 Customer Detail**: Link to customer tá»« daily view

---

**Version**: 1.0  
**Last Updated**: 2025-12-03  
**Status**: Ready for Implementation
