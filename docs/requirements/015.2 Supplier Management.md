# ğŸ¢ Requirements: Supplier Management

> **ğŸ“‹ STATUS: PENDING** - Giai Ä‘oáº¡n 1, TÃ­nh nÄƒng 2  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`  
> **ğŸ“„ Implementation**: `src/features/suppliers/`  
> **âš ï¸ Dependencies**: `015.1 Master Data.md` (category: 'nhom-nha-cung-cap')

## ğŸ¯ Má»¥c TiÃªu

Quáº£n lÃ½ nhÃ  cung cáº¥p (NCC) cho module Inventory. Sá»­ dá»¥ng pattern tÆ°Æ¡ng tá»± Dental Service: PageView + Table + FormModal, React Hook Form + Zod, Server Actions cho mutations.

## ğŸ“Š Database Model

```prisma
model Supplier {
  id              String   @id @default(uuid())
  name            String   @unique
  shortName       String?

  // Store MasterData.key (String), NOT id (UUID)
  // NO FK relation â†’ Allows MasterData to be deleted
  // Frontend: Display MasterData.value if found, else display key itself
  supplierGroup String?   // e.g., 'ncc-chinh', 'ncc-phu'

  phone           String?
  email           String?
  address         String?
  taxCode         String?
  note            String?

  archivedAt      DateTime? @db.Timestamptz  // Soft delete
  createdAt       DateTime  @default(now()) @db.Timestamptz
  updatedAt       DateTime  @updatedAt @db.Timestamptz

  createdById     String // ID cá»§a ngÆ°á»i táº¡o
  updatedById     String // ID cá»§a ngÆ°á»i cáº­p nháº­t

  createdBy       Employee @relation("CreatedSuppliers", fields: [createdById], references: [id])
  updatedBy       Employee @relation("UpdatedSuppliers", fields: [updatedById], references: [id])

  goodsReceipts   GoodsReceipt[]

  @@index([name])
  @@index([supplierGroup, archivedAt])
  @@map("suppliers")
}
```

**Ghi chÃº mÃ´ hÃ¬nh:**

- DÃ¹ng `archivedAt DateTime?` Ä‘á»ƒ soft-delete (Ä‘á»“ng bá»™ vá»›i Dental Service pattern)
- `createdById`, `updatedById` track audit trail (tÆ°Æ¡ng tá»± Dental Service)

**Design Decision: Store `key` (String) instead of FK**

- âœ… Semantic & Portable: Store `'ncc-chinh'` instead of UUID
- âœ… No FK constraint â†’ Master Data can be deleted without blocking
- âœ… Frontend handles gracefully: Display `value` if found, else display `key`
- âœ… Immutable `key` â†’ Stable reference

---

## ğŸ¯ Core Requirements

### 1. â• Táº¡o NhÃ  Cung Cáº¥p (Create)

#### ğŸ” Permissions

- Chá»‰ **Admin** má»›i Ä‘Æ°á»£c táº¡o NCC
- **Employee khÃ´ng cÃ³ quyá»n truy cáº­p** feature nÃ y
- Kiá»ƒm tra quyá»n á»Ÿ cáº£ client (hide menu/button) vÃ  server

#### ğŸ¨ UI/UX

- **Modal form** responsive (85% width mobile, 65% width desktop)
- **Real-time validation** vá»›i error feedback

#### ğŸ“ Form Layout (5 hÃ ng)

```
HÃ ng 1: [supplierGroup ]  // Optional
HÃ ng 2: [name ] [shortName ]
HÃ ng 3: [phone ] [email ]
HÃ ng 4: [address ] [taxCode ]
HÃ ng 5: [note ]
```

**Ghi chÃº:**

- `supplierGroup`: Chá»n tá»« MasterData (category='nhom-nha-cung-cap') hoáº·c Ä‘á»ƒ trá»‘ng
- `archivedAt` khÃ´ng hiá»ƒn thá»‹ trong Create; chá»‰ hiá»ƒn thá»‹ read-only á»Ÿ Edit khi Ä‘Ã£ bá»‹ lÆ°u trá»¯

#### âœ… Validation Rules

- `name`: Required, unique, 2-200 kÃ½ tá»±
- `shortName`: Optional, max 50 kÃ½ tá»±
- `supplierGroup`: Optional, select from MasterData (category = 'nhom-nha-cung-cap')
- `phone`: Optional, regex `/^[0-9+\-\s()]*$/`, max 20
- `email`: Optional, email format
- `address`: Optional, max 500 kÃ½ tá»±
- `taxCode`: Optional, max 20 kÃ½ tá»±
- `note`: Optional, max 1000 kÃ½ tá»±

---

### 2. ğŸ“‹ Danh SÃ¡ch NCC (List)

#### ğŸ” Permissions

- Chá»‰ **Admin** má»›i Ä‘Æ°á»£c xem danh sÃ¡ch NCC
- **Employee**: Hide menu item trong sidebar

#### ğŸ“Š Table Features

- KhÃ´ng phÃ¢n trang (dataset nhá», tÆ°Æ¡ng tá»± Dental Service)
- KhÃ´ng search backend. Sá»­ dá»¥ng filter/sorter sáºµn cÃ³ cá»§a AntD Table á»Ÿ frontend
- Filter theo cá»™t: NhÃ³m NCC (`supplierGroup`)
- Sorter theo cá»™t: TÃªn NCC (`name`)
- Toggle "Hiá»ƒn thá»‹ archived" â€” param `includeArchived=0|1` khi gá»i API
- Action buttons: Edit, Archive/Unarchive, Delete (kÃ¨m tooltips + Popconfirm)

#### ğŸ—‚ï¸ Table Columns

| Column       | Width | Type    | Description                       |
| ------------ | ----- | ------- | --------------------------------- |
| TÃªn NCC      | Auto  | Text    | `name` (Sorter)                   |
| TÃªn viáº¿t táº¯t | 140px | Text    | `shortName`                       |
| NhÃ³m NCC     | 180px | Text    | `supplierGroup` (Filter)          |
| SÄT          | 140px | Text    | `phone`                           |
| Email        | 200px | Text    | `email`                           |
| Tráº¡ng thÃ¡i   | 140px | Tag     | Active/Archived (tá»« `archivedAt`) |
| Thao tÃ¡c     | 180px | Actions | Edit/Archive/Unarchive/Delete     |

#### ğŸ”§ Components

- `SupplierTable.tsx` â€” reusable table component
- `SuppliersPageView.tsx` â€” page wrapper (filters/sorters + toggle + table + create button)

---

### 3. âœï¸ Chá»‰nh Sá»­a NCC (Edit)

#### ğŸ¨ UI/UX

- DÃ¹ng chung modal nhÆ° Create
- Pre-populate dá»¯ liá»‡u theo item Ä‘Æ°á»£c chá»n
- Hiá»ƒn thá»‹ admin metadata: `createdAt`, `updatedAt`, `archivedAt` (read-only)

#### ğŸ”„ Behavior

- Cho phÃ©p chá»‰nh sá»­a táº¥t cáº£ fields trá»« `archivedAt` (chá»‰ thay Ä‘á»•i qua action Archive/Unarchive)
- Unique validation cho `name` (exclude current record)
- Success feedback + auto-close modal + invalidate list/detail queries

---

### 4. ğŸ—„ï¸ Archive/Delete Operations

#### ğŸ“¦ Archive System (Ä‘á»“ng bá»™ Dental Service)

- Soft delete báº±ng `archivedAt` timestamp
- Archive: set `archivedAt = now()`
- Unarchive: set `archivedAt = null`

#### âŒ Delete Logic

```typescript
if (hasLinkedData) {
  throw new Error("NCC Ä‘ang cÃ³ dá»¯ liá»‡u liÃªn káº¿t, chá»‰ Ä‘Æ°á»£c phÃ©p Archive");
} else {
  // Hard delete allowed
}
```

Linked data bao gá»“m:

- `GoodsReceipt.supplierId`
- (TÆ°Æ¡ng lai) cÃ¡c liÃªn káº¿t khÃ¡c vá»›i inventory

#### ğŸ¨ UI Actions

- Archive button: `<InboxOutlined />` â€” LÆ°u trá»¯
- Unarchive button: `<RollbackOutlined />` â€” KhÃ´i phá»¥c
- Delete button: `<DeleteOutlined />` + Popconfirm

---

### 5. ğŸ“ Layout Integration

#### Sidebar Navigation

- Location: DÆ°á»›i nhÃ³m "CÃ i Ä‘áº·t (Settings)"
- Menu item: "NhÃ  cung cáº¥p"
- Route: `/suppliers`
- Icon: liÃªn quan supplier/vendor (sáº½ cÃ³ trong menu.config.tsx)
- Visibility: Admin only

---

## ğŸ”§ Technical Implementation

### API Endpoints

```
GET    /api/v1/suppliers?includeArchived=0|1
GET    /api/v1/suppliers/:id
```

**Ghi chÃº:**

- KhÃ´ng há»— trá»£ search backend. Lá»c/sáº¯p xáº¿p thá»±c hiá»‡n táº¡i frontend dá»±a trÃªn dá»¯ liá»‡u Ä‘Ã£ táº£i
- `includeArchived` = 0 (máº·c Ä‘á»‹nh) chá»‰ tráº£ vá» Active; = 1 tráº£ vá» cáº£ Archived
- POST, PUT, DELETE removed - Use Server Actions instead

### API Client

```typescript
// src/features/suppliers/api.ts

/**
 * Get suppliers list
 * GET /api/v1/suppliers
 * @param includeArchived - Include archived suppliers in the list
 * @returns Array of suppliers
 */
export async function getSuppliersApi(includeArchived: boolean);

/**
 * Get supplier detail by ID
 * GET /api/v1/suppliers/[id]
 * @param id - Supplier ID
 * @returns Full supplier detail
 */
export async function getSupplierByIdApi(id: string);
```

### Server Actions

```typescript
// src/server/actions/supplier.actions.ts

/**
 * Server Action: Create new supplier
 * Usage: const result = await createSupplierAction(data);
 */
export async function createSupplierAction(data: CreateSupplierRequest);

/**
 * Server Action: Update existing supplier
 * Usage: const result = await updateSupplierAction(supplierId, data);
 */
export async function updateSupplierAction(
  supplierId: string,
  data: UpdateSupplierRequest
);

/**
 * Server Action: Delete supplier (hard delete - permanently remove)
 * Usage: await deleteSupplierAction(id);
 */
export async function deleteSupplierAction(supplierId: string);

/**
 * Server Action: Archive supplier (soft delete)
 * Usage: await archiveSupplierAction(id);
 */
export async function archiveSupplierAction(supplierId: string);

/**
 * Server Action: Unarchive supplier (restore)
 * Usage: await unarchiveSupplierAction(id);
 */
export async function unarchiveSupplierAction(supplierId: string);
```

### Architecture

```
UI Components + Custom Hooks + API Client + Routes + Services + Repository + Database
```

### State Management

- React Query cho server state
- Query keys: `['suppliers', { includeArchived }]`, `['supplier', id]`

### Service Layer

```typescript
// src/server/services/supplier.service.ts

export const supplierService = {
  async list(currentUser: UserCore | null, includeArchived: boolean),
  async getById(currentUser: UserCore | null, id: string),
  async create(currentUser: UserCore | null, body: unknown),
  async update(currentUser: UserCore | null, body: unknown),
  async remove(currentUser: UserCore | null, id: string),
  async archive(currentUser: UserCore | null, id: string),
  async unarchive(currentUser: UserCore | null, id: string),
};
```

**Business Logic:**

- `create`: requireAdmin, validate unique name, track createdById/updatedById
- `update`: requireAdmin, validate unique name (exclude current), track updatedById
- `remove`: requireAdmin, check linked data (GoodsReceipts), throw error if exists
- `archive/unarchive`: requireAdmin, set archivedAt timestamp

### Validation Stack

- Client: React Hook Form + Zod resolver
- Server: Zod schemas táº¡i `src/shared/validation/supplier.schema.ts`
- Database: Prisma constraints (unique name, archivedAt soft-delete)

---

## âœ… Validation (Zod Schema)

```typescript
// src/shared/validation/supplier.schema.ts
import { z } from "zod";

/**
 * Supplier Base Schema
 * DÃ¹ng lÃ m ná»n cho CreateSupplierRequestSchema vÃ  UpdateSupplierRequestSchema
 */
export const SupplierBaseSchema = z.object({
  name: z.string().trim().min(2, "TÃªn NCC lÃ  báº¯t buá»™c").max(200),
  shortName: z.string().trim().max(50).optional().nullable(),
  supplierGroup: z.string().trim().optional().nullable(), // Optional - from MasterData category='nhom-nha-cung-cap'
  phone: z
    .string()
    .regex(/^[0-9+\-\s()]*$/, "SÄT khÃ´ng há»£p lá»‡")
    .max(20)
    .optional()
    .nullable(),
  email: z.string().email("Email khÃ´ng há»£p lá»‡").optional().nullable(),
  address: z.string().trim().max(500).optional().nullable(),
  taxCode: z.string().trim().max(20).optional().nullable(),
  note: z.string().trim().max(1000).optional().nullable(),
  archivedAt: z.date().optional().nullable(),
});

/**
 * Create Supplier Request Schema
 * DÃ¹ng á»Ÿ: Form create supplier (admin)
 * Omit archivedAt (server tá»± set khi archive)
 */
export const CreateSupplierRequestSchema = SupplierBaseSchema.omit({
  archivedAt: true,
});

/**
 * Update Supplier Request Schema
 * DÃ¹ng á»Ÿ: Form edit supplier (admin)
 * Cho phÃ©p cáº­p nháº­t táº¥t cáº£ fields + archivedAt
 */
export const UpdateSupplierRequestSchema = SupplierBaseSchema.extend({
  id: z.string().uuid("ID khÃ´ng há»£p lá»‡"),
});

/**
 * Supplier Response Schema
 * DÃ¹ng á»Ÿ: Service layer validate response trÆ°á»›c khi tráº£ vá» API
 */
export const SupplierResponseSchema = z.object({
  id: z.string().uuid(),
  name: z.string(),
  shortName: z.string().nullable().optional(),
  supplierGroup: z.string().nullable().optional(),
  phone: z.string().nullable().optional(),
  email: z.string().nullable().optional(),
  address: z.string().nullable().optional(),
  taxCode: z.string().nullable().optional(),
  note: z.string().nullable().optional(),
  archivedAt: z.string().datetime().nullable().optional(),
  createdById: z.string().uuid(),
  updatedById: z.string().uuid(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
  // Nested objects
  createdBy: z
    .object({
      id: z.string().uuid(),
      fullName: z.string(),
    })
    .nullable()
    .optional(),
  updatedBy: z
    .object({
      id: z.string().uuid(),
      fullName: z.string(),
    })
    .nullable()
    .optional(),
});

export const SuppliersResponseSchema = z.array(SupplierResponseSchema);

// TypeScript types
export type CreateSupplierRequest = z.infer<typeof CreateSupplierRequestSchema>;
export type UpdateSupplierRequest = z.infer<typeof UpdateSupplierRequestSchema>;
export type SupplierResponse = z.infer<typeof SupplierResponseSchema>;
export type SuppliersResponse = z.infer<typeof SuppliersResponseSchema>;
```

---

## ğŸ“‹ Constants

```typescript
// src/features/suppliers/constants.ts

export const SUPPLIER_ENDPOINTS = {
  ROOT: "/api/v1/suppliers",
  BY_ID: (id: string) => `/api/v1/suppliers/${id}`,
} as const;

export const SUPPLIER_QUERY_KEYS = {
  list: (includeArchived: boolean) =>
    ["suppliers", { includeArchived }] as const,
  byId: (id: string) => ["supplier", id] as const,
} as const;

export const SUPPLIER_MESSAGES = {
  CREATE_SUCCESS: "Táº¡o nhÃ  cung cáº¥p thÃ nh cÃ´ng.",
  UPDATE_SUCCESS: "Cáº­p nháº­t nhÃ  cung cáº¥p thÃ nh cÃ´ng.",
  DELETE_SUCCESS: "XoÃ¡ nhÃ  cung cáº¥p thÃ nh cÃ´ng.",
  ARCHIVE_SUCCESS: "ÄÃ£ lÆ°u trá»¯ nhÃ  cung cáº¥p.",
  UNARCHIVE_SUCCESS: "ÄÃ£ khÃ´i phá»¥c nhÃ  cung cáº¥p.",
} as const;
```

---

## ğŸ—ï¸ Folder Structure

```
src/features/suppliers/
â”œâ”€â”€ index.ts                        # Barrel export
â”œâ”€â”€ constants.ts                    # Endpoints, query keys, messages
â”œâ”€â”€ api.ts                          # API client (GET only)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useSuppliers.ts            # Query: List
â”‚   â”œâ”€â”€ useSupplierById.ts         # Query: By ID
â”‚   â”œâ”€â”€ useCreateSupplier.ts       # Mutation: Create
â”‚   â”œâ”€â”€ useUpdateSupplier.ts       # Mutation: Update
â”‚   â”œâ”€â”€ useDeleteSupplier.ts       # Mutation: Delete
â”‚   â”œâ”€â”€ useArchiveSupplier.ts      # Mutation: Archive
â”‚   â””â”€â”€ useUnarchiveSupplier.ts    # Mutation: Unarchive
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SupplierTable.tsx          # Dumb component - Table
â”‚   â””â”€â”€ SupplierFormModal.tsx      # React Hook Form modal
â””â”€â”€ views/
    â””â”€â”€ SuppliersPageView.tsx      # Smart component - Main page

src/server/
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ supplier.actions.ts         # Server Actions (5 actions)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ supplier.service.ts         # Business logic
â”‚   â””â”€â”€ supplier/_mappers.ts        # DTO mapping
â””â”€â”€ repos/
    â””â”€â”€ supplier.repo.ts             # Prisma queries

src/app/api/v1/suppliers/
â”œâ”€â”€ route.ts                         # GET list
â””â”€â”€ [id]/
    â””â”€â”€ route.ts                     # GET by ID

src/app/(private)/suppliers/
â””â”€â”€ page.tsx                         # Route page
```

---

## ğŸ”’ Security & Permissions

- Admin: Create, Update, Delete, Archive, Unarchive (server-side guard `requireAdmin()`)
- Authenticated users: View list, View details (for dropdown selections in Goods Receipt)
- Measures: Session validation, server-side role checking, input sanitization, Prisma query safety

---

## ğŸš€ Performance & Optimization

- React Query cache: `staleTime` 60s cho list, 60s cho detail (master data cache strategy)
- Smart invalidation sau mutations
- Index gá»£i Ã½ (DB): `@@index([supplierGroup])`, `@@index([archivedAt])`, tÃ¹y nhu cáº§u filter tÆ°Æ¡ng lai

---

## ğŸ§ª Test Cases

### TC-1: Unique name validation

- **Input**: name Ä‘Ã£ tá»“n táº¡i
- **Expected**: Status 400, "TÃªn NCC Ä‘Ã£ tá»“n táº¡i"

### TC-2: Archive cascade check

- **Setup**: Supplier cÃ³ GoodsReceipts
- **Action**: Hard delete
- **Expected**: Status 400, "NCC Ä‘ang cÃ³ dá»¯ liá»‡u liÃªn káº¿t..."

### TC-3: Filter by group

- **Action**: Table filter by supplierGroup
- **Expected**: Chá»‰ hiá»ƒn thá»‹ NCC thuá»™c group Ä‘Ã£ chá»n

### TC-4: Archive toggle

- **Action**: Toggle "Hiá»ƒn thá»‹ archived"
- **Expected**: Hiá»ƒn thá»‹/áº©n NCC cÃ³ archivedAt

---

## ğŸ¯ Acceptance Criteria

### Testing Checklist

- [ ] Admin cÃ³ thá»ƒ táº¡o/sá»­a/xoÃ¡/archive/unarchive nhÃ  cung cáº¥p
- [ ] User Ä‘Äƒng nháº­p cÃ³ thá»ƒ xem list vÃ  chi tiáº¿t (for Goods Receipt)
- [ ] **Employee khÃ´ng tháº¥y menu** "NhÃ  cung cáº¥p" trong sidebar
- [ ] Server-side permission check cho táº¥t cáº£ mutations vÃ  queries
- [ ] Validation hoáº¡t Ä‘á»™ng Ä‘Ãºng: name unique; táº¥t cáº£ fields optional trá»« name
- [ ] MÃ n hÃ¬nh list vá»›i toggle "Hiá»ƒn thá»‹ archived"
- [ ] Table filter theo nhÃ³m NCC (frontend filter) vÃ  sorter (name) hoáº¡t Ä‘á»™ng
- [ ] Select "NhÃ³m NCC" láº¥y tá»« MasterData (category='nhom-nha-cung-cap')
- [ ] Archive/Unarchive: cáº­p nháº­t tráº¡ng thÃ¡i vÃ  pháº£n Ã¡nh trÃªn UI
- [ ] Delete: cháº·n khi cÃ³ dá»¯ liá»‡u liÃªn káº¿t (GoodsReceipts); cho phÃ©p khi khÃ´ng cÃ³
- [ ] Modal responsive, loading/error/success states rÃµ rÃ ng

### Quality Standards

- TypeScript strict mode, Zod validation á»Ÿ client/server
- Error mapping thÃ¢n thiá»‡n, dÃ¹ng notify utils
- Accessibility cÆ¡ báº£n, hiá»‡u nÄƒng á»•n Ä‘á»‹nh
- Äá»“ng bá»™ pattern vá»›i Dental Service (PageView + Table + Modal)

---

## ğŸ“¦ Seed Data

```typescript
// YÃªu cáº§u MasterData cÃ³ sáºµn:
// - category='nhom-nha-cung-cap': 'vt-yte', 'labo', 'van-phong'

const suppliers = [
  {
    name: "CÃ´ng ty TNHH Váº­t TÆ° Y Táº¿ ABC",
    shortName: "ABC Medical",
    supplierGroup: "vt-yte", // Key tá»« MasterData (category='nhom-nha-cung-cap')
    phone: "0901234567",
    email: "contact@abc-medical.com",
    address: "123 Nguyá»…n VÄƒn A, Q1, HCM",
    taxCode: "0123456789",
  },
  {
    name: "Labo RÄƒng Sá»© XYZ",
    shortName: "XYZ Labo",
    supplierGroup: "labo", // Key tá»« MasterData (category='nhom-nha-cung-cap')
    phone: "0909876543",
    email: "info@xyzlabo.vn",
    address: "456 LÃª VÄƒn B, Q3, HCM",
  },
];
```

---

**Priority**: ğŸ”´ High  
**Estimated Effort**: 2-3 ngÃ y  
**Dependencies**: 015.1 Master Data (category='nhom-nha-cung-cap')  
**Pattern**: Dental Service (PageView + Table + Modal)  
**Architecture**: UI Components â†’ Custom Hooks â†’ API Client â†’ Routes â†’ Services â†’ Repository â†’ Database
