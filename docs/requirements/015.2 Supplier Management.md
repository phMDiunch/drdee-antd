# ğŸ¢ Requirements: Supplier Management

> **ğŸ“‹ STATUS: PENDING** - Giai Ä‘oáº¡n 1, TÃ­nh nÄƒng 2  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`  
> **ğŸ“„ Implementation**: `src/features/suppliers/`  
> **âš ï¸ Dependencies**: `015.1 Master Data.md` (SUPPLIER_GROUP type)

## ğŸ¯ Má»¥c TiÃªu

Quáº£n lÃ½ nhÃ  cung cáº¥p (NCC) cho module Inventory. Sá»­ dá»¥ng pattern Clinic/Dental-Service: PageView + Table + FormModal, React Hook Form + Zod, Server Actions cho mutations.

## ğŸ“Š Database Model

````prisma
model Supplier {
  id              String   @id @default(uuid())
  name            String   @unique
  shortName       String?

  // Store MasterData.key (String), NOT id (UUID)
  // NO FK relation â†’ Allows MasterData to be deleted
  // Frontend: Display MasterData.value if found, else display key itself
  supplierGroupKey String   // e.g., 'ncc-chinh', 'ncc-phu'

  phone           String?
  email           String?
  address         String?
  taxCode         String?
  note            String?

  archivedAt      DateTime? @db.Timestamptz  // Soft delete
  createdAt       DateTime  @default(now()) @db.Timestamptz
  updatedAt       DateTime  @updatedAt @db.Timestamptz

  goodsReceipts   GoodsReceipt[]

  @@index([name])
  @@index([supplierGroupKey, archivedAt])
  @@map("suppliers")
}
```

**Design Decision: Store `key` (String) instead of FK**

- âœ… Semantic & Portable: Store `'ncc-chinh'` instead of UUID
- âœ… No FK constraint â†’ Master Data can be soft-deleted without blocking
- âœ… Frontend handles gracefully: Display `value` if found, else display `key`
- âœ… Immutable `key` â†’ Stable reference---

## ğŸ¯ Core Requirements

### 1. â• Táº¡o NhÃ  Cung Cáº¥p (Create)

#### ğŸ” Permissions

- Chá»‰ **Admin** má»›i Ä‘Æ°á»£c táº¡o NCC
- **Employee khÃ´ng cÃ³ quyá»n truy cáº­p** feature nÃ y
- Kiá»ƒm tra quyá»n á»Ÿ cáº£ client (hide menu/button) vÃ  server

#### ğŸ¨ UI/UX

- **Modal form** responsive (85% width mobile, 65% width desktop)
- **Real-time validation** vá»›i error feedback

#### ğŸ“ Form Layout (4 hÃ ng)

````

HÃ ng 1: [name ] [shortName ]
HÃ ng 2: [supplierGroup ]
HÃ ng 3: [phone ] [email ]
HÃ ng 4: [address ] [taxCode ]
HÃ ng 5: [note ]

````

#### âœ… Validation Rules

- `name`: Required, unique, 2-200 kÃ½ tá»±
- `shortName`: Optional, max 50 kÃ½ tá»±
- `supplierGroupKey`: Required, select from MasterData (filter by root category for "NhÃ³m NCC", isActive=true only)
- `phone`: Optional, regex `/^[0-9+\-\s()]*$/`, max 20
- `email`: Optional, email format
- `address`: Optional, max 500 kÃ½ tá»±
- `taxCode`: Optional, max 20 kÃ½ tá»±
- `note`: Optional, max 1000 kÃ½ tá»±

---

### 2. ğŸ“‹ Danh SÃ¡ch NCC (List)

#### ğŸ” Permissions

- Chá»‰ **Admin** má»›i Ä‘Æ°á»£c xem danh sÃ¡ch NCC
- **Employee**: Hide menu item trong sidebar

#### ğŸ“Š Table Features

- **No pagination** (dataset nhá» - vÃ i chá»¥c NCC)
- **No backend search** (dÃ¹ng Ant Design Table filter/sorter)
- **Archive toggle**: "Hiá»ƒn thá»‹ archived" checkbox
- **Action buttons**: Edit, Archive/Unarchive, Delete (tooltips + Popconfirm)

#### ğŸ—‚ï¸ Table Columns

| Column     | Width | Type    | Description                    |
| ---------- | ----- | ------- | ------------------------------ |
| TÃªn        | Auto  | Text    | `name` (Sorter)                |
| TÃªn VT     | 140px | Text    | `shortName`                    |
| NhÃ³m       | 180px | Text    | `supplierGroup` (Filter)       |
| SÄT        | 140px | Text    | `phone`                        |
| Email      | 200px | Text    | `email`                        |
| Tráº¡ng thÃ¡i | 120px | Tag     | Active/Archived                |
| Thao tÃ¡c   | 180px | Actions | Edit/Archive/Unarchive/Delete  |

#### ğŸ”§ Components

- `SupplierTable.tsx` - Reusable table
- `SuppliersPageView.tsx` - Main page wrapper

---

### 3. âœï¸ Chá»‰nh Sá»­a NCC (Edit)

#### ğŸ¨ UI/UX

- **Same modal** nhÆ° Create
- **Pre-populated data**
- **Admin metadata**: Hiá»ƒn thá»‹ createdAt, updatedAt, archivedAt (read-only)

#### ğŸ”„ Behavior

- Cho phÃ©p chá»‰nh sá»­a táº¥t cáº£ fields trá»« `archivedAt`
- **Unique validation**: name (exclude current record)
- **Success feedback** + auto-close modal

---

### 4. ğŸ—„ï¸ Archive/Delete Operations

#### ğŸ“¦ Archive System

- **Soft delete** vá»›i `archivedAt` timestamp
- **Archive**: Set `archivedAt = now()`
- **Unarchive**: Set `archivedAt = null`

#### âŒ Delete Logic

```typescript
// Hard delete - Chá»‰ khi chÆ°a cÃ³ GoodsReceipt liÃªn quan
if (hasGoodsReceipts) {
  throw ERR.CONFLICT(
    "KhÃ´ng thá»ƒ xÃ³a NCC Ä‘Ã£ cÃ³ phiáº¿u nháº­p kho. Vui lÃ²ng archive."
  );
}
await supplierRepo.hardDelete(id);
````

---

## ğŸ”§ Technical Implementation

### API Endpoints

**Route Handlers** (GET only):

````
GET  /api/v1/suppliers?includeArchived=1
GET  /api/v1/suppliers/:id
```**Server Actions** (Mutations):

```typescript
// src/server/actions/supplier.actions.ts
createSupplierAction(data: CreateSupplierRequest)
updateSupplierAction(data: UpdateSupplierRequest)
deleteSupplierAction(id: string)
archiveSupplierAction(id: string)
unarchiveSupplierAction(id: string)
````

---

## âœ… Validation (Zod Schema)

```typescript
// src/shared/validation/supplier.schema.ts
export const SupplierBaseSchema = z.object({
  name: z.string().trim().min(2).max(200),
  shortName: z.string().max(50).optional().nullable(),
  supplierGroup: z.string().min(1, { message: "Vui lÃ²ng chá»n nhÃ³m NCC" }),
  phone: z
    .string()
    .regex(/^[0-9+\-\s()]*$/)
    .max(20)
    .optional()
    .nullable(),
  email: z.string().email().optional().nullable(),
  address: z.string().max(500).optional().nullable(),
  taxCode: z.string().max(20).optional().nullable(),
  note: z.string().max(1000).optional().nullable(),
});

export const CreateSupplierRequestSchema = SupplierBaseSchema;
export const UpdateSupplierRequestSchema = SupplierBaseSchema.extend({
  id: z.string().uuid(),
});
```

---

## ğŸ—ï¸ Folder Structure

```
src/features/suppliers/
â”œâ”€â”€ index.ts                        # Barrel export
â”œâ”€â”€ constants.ts                    # Endpoints, query keys, messages
â”œâ”€â”€ api.ts                          # API client (GET only)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useSuppliers.ts            # Query: List
â”‚   â”œâ”€â”€ useSupplierById.ts         # Query: By ID
â”‚   â”œâ”€â”€ useCreateSupplier.ts       # Mutation: Create
â”‚   â”œâ”€â”€ useUpdateSupplier.ts       # Mutation: Update
â”‚   â”œâ”€â”€ useDeleteSupplier.ts       # Mutation: Delete
â”‚   â”œâ”€â”€ useArchiveSupplier.ts      # Mutation: Archive
â”‚   â””â”€â”€ useUnarchiveSupplier.ts    # Mutation: Unarchive
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SupplierTable.tsx          # Dumb component - Table
â”‚   â””â”€â”€ SupplierFormModal.tsx      # React Hook Form modal
â””â”€â”€ views/
    â””â”€â”€ SuppliersPageView.tsx      # Smart component - Main page

src/server/
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ supplier.actions.ts         # Server Actions (5 actions)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ supplier.service.ts         # Business logic
â”‚   â””â”€â”€ supplier/_mappers.ts        # DTO mapping
â””â”€â”€ repos/
    â””â”€â”€ supplier.repo.ts             # Prisma queries

src/app/api/v1/suppliers/
â”œâ”€â”€ route.ts                         # GET list
â””â”€â”€ [id]/
    â””â”€â”€ route.ts                     # GET by ID

src/app/(private)/suppliers/
â””â”€â”€ page.tsx                         # Route page
```

---

## ğŸ§ª Test Cases

### TC-1: Unique name validation

- **Input**: name Ä‘Ã£ tá»“n táº¡i
- **Expected**: Status 400, "TÃªn NCC Ä‘Ã£ tá»“n táº¡i"

### TC-2: Archive cascade check

- **Setup**: Supplier cÃ³ GoodsReceipts
- **Action**: Hard delete
- **Expected**: Status 400, "KhÃ´ng thá»ƒ xÃ³a..."

### TC-3: Filter by group

- **Action**: Table filter by supplierGroup
- **Expected**: Chá»‰ hiá»ƒn thá»‹ NCC thuá»™c group Ä‘Ã£ chá»n

### TC-4: Archive toggle

- **Action**: Toggle "Hiá»ƒn thá»‹ archived"
- **Expected**: Hiá»ƒn thá»‹/áº©n NCC cÃ³ archivedAt

---

## ğŸ¯ Acceptance Criteria

- [ ] **Employee khÃ´ng tháº¥y menu** "NhÃ  cung cáº¥p" trong sidebar
- [ ] **Admin-only permissions**: create, view, edit, delete, archive
- [ ] Server-side permission check cho táº¥t cáº£ mutations vÃ  queries
- [ ] MÃ n hÃ¬nh list vá»›i toggle "Hiá»ƒn thá»‹ archived"
- [ ] Table filter theo nhÃ³m NCC (frontend filter)
- [ ] Select "NhÃ³m NCC" láº¥y tá»« MasterData (type=SUPPLIER_GROUP, isActive=true)
- [ ] Validate unique name
- [ ] Archive system (soft delete)
- [ ] Hard delete check cascade (GoodsReceipts)
- [ ] React Query cache vá»›i staleTime: Infinity

---

## ğŸ“¦ Seed Data

```typescript
// YÃªu cáº§u MasterData cÃ³ sáºµn:
// - SUPPLIER_GROUP: 'vt-yte', 'labo', 'van-phong'

const suppliers = [
  {
    name: "CÃ´ng ty TNHH Váº­t TÆ° Y Táº¿ ABC",
    shortName: "ABC Medical",
    supplierGroup: "vt-yte", // Key tá»« MasterData
    phone: "0901234567",
    email: "contact@abc-medical.com",
    address: "123 Nguyá»…n VÄƒn A, Q1, HCM",
    taxCode: "0123456789",
  },
  {
    name: "Labo RÄƒng Sá»© XYZ",
    shortName: "XYZ Labo",
    supplierGroup: "labo", // Key tá»« MasterData
    phone: "0909876543",
    email: "info@xyzlabo.vn",
    address: "456 LÃª VÄƒn B, Q3, HCM",
  },
];
```

---

**Priority**: ğŸ”´ High  
**Estimated Effort**: 2-3 ngÃ y  
**Dependencies**: 015.1 Master Data (SUPPLIER_GROUP)  
**Pattern**: Clinic/Dental-Service (PageView + Table + Modal)
