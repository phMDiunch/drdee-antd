# ğŸ§© Requirements: Consulted Service by Dental Service View

> **ğŸ“‹ STATUS: ğŸ”„ PENDING** - Backend + Frontend implementation needed  
> **ğŸ”— Implementation**: `src/features/consulted-services/`  
> **ğŸ”§ Created**: 2025-12-10  
> **ğŸ”— Parent**: `009 Consulted-Service.md`

## ğŸ“Š Tham kháº£o

- Prisma Model: `prisma/schema.prisma` â†’ ConsultedService, DentalService
- Parent Spec: `009 Consulted-Service.md`
- Similar View: `ConsultedServiceDailyView.tsx` (tham kháº£o layout pattern)

## ğŸ¯ Má»¥c TiÃªu

- View riÃªng Ä‘á»ƒ xem lá»‹ch sá»­ dá»‹ch vá»¥ tÆ° váº¥n theo **tÃªn dá»‹ch vá»¥ nha khoa**
- Filter chÃ­nh: Dental Service selector (thay vÃ¬ date navigation)
- Giá»¯ nguyÃªn layout, table, actions nhÆ° Daily View
- Há»— trá»£ phÃ¢n tÃ­ch theo tá»«ng loáº¡i dá»‹ch vá»¥

---

## ğŸ² Decision Log

### Architecture

- âœ… **TÃ¡i sá»­ dá»¥ng tá»‘i Ä‘a tá»« Daily View**:

  - `ConsultedServiceStatistics` (giá»¯ nguyÃªn)
  - `ConsultedServiceTable` (giá»¯ nguyÃªn - reuse 100%)
  - `UpdateConsultedServiceModal` (giá»¯ nguyÃªn)
  - Actions: confirm, edit, delete (giá»¯ nguyÃªn logic)
  - Export Excel utility (giá»¯ nguyÃªn)

- âœ… **Components má»›i (tá»‘i thiá»ƒu)**:

  - `ConsultedServiceByServiceFilters` - Filter má»›i vá»›i Dental Service selector
  - `ConsultedServiceByServiceView` - View component má»›i

- âœ… **Backend má»›i**:
  - API Route: `GET /api/v1/consulted-services/by-service` (endpoint má»›i)
  - Query hook: `useConsultedServicesByService` (hook má»›i)
  - Schema: `GetConsultedServicesByServiceQuery` (validation má»›i)

### Data Flow

```
User chá»n Dental Service
    â†“
Frontend call API vá»›i dentalServiceId
    â†“
Backend query: WHERE dentalServiceId = X AND clinicId = Y
    â†“
Return items + statistics (tÆ°Æ¡ng tá»± daily)
    â†“
Hiá»ƒn thá»‹ table + statistics
```

### Key Differences vs Daily View

| Aspect                | Daily View                         | By Service View (009.1)                       |
| --------------------- | ---------------------------------- | --------------------------------------------- |
| **Header**            | Date Navigation (prev/today/next)  | Static title "Theo dá»‹ch vá»¥"                   |
| **Primary Filter**    | `date` (required)                  | `dentalServiceId` (required)                  |
| **Filters Component** | `ConsultedServiceFilters`          | `ConsultedServiceByServiceFilters` (má»›i)      |
| **Query Hook**        | `useConsultedServicesDaily()`      | `useConsultedServicesByService()` (má»›i)       |
| **API Endpoint**      | `/api/v1/consulted-services/daily` | `/api/v1/consulted-services/by-service` (má»›i) |
| **Statistics**        | âœ… Reuse component                 | âœ… Reuse component                            |
| **Table**             | âœ… Reuse component                 | âœ… Reuse component                            |
| **Actions**           | âœ… Reuse logic                     | âœ… Reuse logic                                |

---

## ğŸ“‹ Technical Requirements

### 1. Zod Schema (Backend Validation)

**File**: `src/shared/validation/consulted-service.schema.ts`

**ThÃªm schema má»›i** (khÃ´ng sá»­a cÃ¡c schema cÅ©):

```typescript
/**
 * Query schema: Get consulted services by dental service
 */
export const GetConsultedServicesByServiceQuerySchema = z.object({
  dentalServiceId: z.string().uuid("Invalid dental service ID"),
  clinicId: z.string().uuid("Invalid clinic ID"),
});

export type GetConsultedServicesByServiceQuery = z.infer<
  typeof GetConsultedServicesByServiceQuerySchema
>;

// Response dÃ¹ng láº¡i schema hiá»‡n táº¡i
export type ConsultedServicesByServiceResponse = ConsultedServicesDailyResponse;
```

**Notes**:

- KhÃ´ng cáº§n thÃªm field má»›i vÃ o response (dÃ¹ng láº¡i `ConsultedServicesDailyResponse`)
- Statistics format giá»‘ng daily view

---

### 2. Repository Layer

**File**: `src/server/repos/consulted-service.repo.ts`

**ThÃªm method má»›i**:

```typescript
/**
 * Get consulted services by dental service (raw Prisma query)
 * @param dentalServiceId - Dental service ID filter
 * @param clinicId - Clinic context
 * @returns Raw Prisma data with relations
 */
async listByDentalService(params: {
  dentalServiceId: string;
  clinicId: string;
}) {
  const { dentalServiceId, clinicId } = params;

  const where: Prisma.ConsultedServiceWhereInput = {
    dentalServiceId,
    clinicId,
    deletedAt: null,
  };

  const [items, totalAmount, totalPaid, totalDebt] = await Promise.all([
    // Items vá»›i relations Ä‘áº§y Ä‘á»§ (giá»‘ng listDaily)
    this.prisma.consultedService.findMany({
      where,
      include: {
        customer: {
          select: {
            id: true,
            fullName: true,
            customerCode: true,
            dob: true,
            phone: true,
            clinicId: true, // For permission checks
          },
        },
        dentalService: {
          select: {
            id: true,
            name: true,
            unit: true,
            price: true,
            minPrice: true,
          },
        },
        consultingDoctor: { select: { id: true, fullName: true } },
        treatingDoctor: { select: { id: true, fullName: true } },
        consultingSale: { select: { id: true, fullName: true } },
        createdBy: { select: { id: true, fullName: true } },
        updatedBy: { select: { id: true, fullName: true } },
        clinic: { select: { id: true, name: true } },
      },
      orderBy: [
        { consultationDate: "desc" },
        { createdAt: "desc" },
      ],
    }),

    // Statistics (aggregate)
    this.prisma.consultedService.aggregate({
      where,
      _sum: { finalPrice: true },
    }),

    this.prisma.consultedService.aggregate({
      where,
      _sum: { amountPaid: true },
    }),

    this.prisma.consultedService.aggregate({
      where,
      _sum: { debt: true },
    }),
  ]);

  return {
    items, // Raw Prisma data (chÆ°a map)
    count: items.length,
    statistics: {
      totalAmount: totalAmount._sum.finalPrice ?? 0,
      totalPaid: totalPaid._sum.amountPaid ?? 0,
      totalDebt: totalDebt._sum.debt ?? 0,
    },
  };
}
```

**Notes**:

- Return **raw Prisma data** (chÆ°a transform) - Service layer sáº½ map
- Query WHERE: `dentalServiceId + clinicId + deletedAt = null`
- Order: `consultationDate DESC, createdAt DESC` (má»›i nháº¥t trÃªn cÃ¹ng)
- Include relations giá»‘ng `listDaily()` (consistency)

---

### 3. Service Layer

**File**: `src/server/services/consulted-service.service.ts`

**ThÃªm method má»›i**:

```typescript
/**
 * Get consulted services by dental service
 */
async listByDentalService(currentUser: UserCore | null, query: unknown) {
  requireAuth(currentUser);

  const parsed = GetConsultedServicesByServiceQuerySchema.safeParse(query);
  if (!parsed.success) {
    throw new ServiceError(
      "VALIDATION_ERROR",
      "Tham sá»‘ truy váº¥n khÃ´ng há»£p lá»‡",
      400
    );
  }

  const { dentalServiceId, clinicId } = parsed.data;

  // Scope clinic access (giá»‘ng listDaily)
  let effectiveClinicId: string | undefined = clinicId;
  if (currentUser?.role !== "admin") {
    effectiveClinicId = currentUser?.clinicId ?? undefined;
  }

  if (!effectiveClinicId) {
    throw new ServiceError("MISSING_CLINIC", "Vui lÃ²ng chá»n chi nhÃ¡nh", 400);
  }

  // Query data tá»« repository
  const result = await consultedServiceRepo.listByDentalService({
    dentalServiceId,
    clinicId: effectiveClinicId,
  });

  // Map Prisma data â†’ Response format
  const response = {
    items: result.items.map(mapConsultedServiceToResponse),
    count: result.count,
    statistics: result.statistics,
  };

  return ConsultedServicesByServiceResponseSchema.parse(response);
}
```

**Notes**:

- Business logic: auth, permission, clinic scoping
- Call `consultedServiceRepo.listByDentalService()`
- Map qua `mapConsultedServiceToResponse()` (reuse mapper)
- Validate response vá»›i Zod

---

### 4. Mapper (No Changes Needed)

**File**: `src/server/services/consulted-service/_mappers.ts`

âœ… **KHÃ”NG Cáº¦N THAY Äá»”I** - Reuse 100% mapper hiá»‡n táº¡i:

- `mapConsultedServiceToResponse()` - Transform Prisma â†’ Response

Mapper Ä‘Ã£ cÃ³ sáºµn vÃ  xá»­ lÃ½ Ä‘áº§y Ä‘á»§ relations.

---

### 5. API Route (GET)

**File má»›i**: `src/app/api/v1/consulted-services/by-service/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { verifySession } from "@/server/utils/sessionCache";
import { consultedServiceService } from "@/server/services/consulted-service.service";
import { handleApiError } from "@/server/utils/handleApiError";

/**
 * GET /api/v1/consulted-services/by-service
 * Get consulted services filtered by dental service
 */
export async function GET(req: NextRequest) {
  try {
    // Auth
    const session = await verifySession();
    const currentUser = session?.userId
      ? {
          userId: session.userId,
          employeeId: session.employeeId,
          role: session.role,
          clinicId: session.clinicId,
        }
      : null;

    // Parse query params
    const { searchParams } = new URL(req.url);
    const query = {
      dentalServiceId: searchParams.get("dentalServiceId"),
      clinicId: searchParams.get("clinicId"),
    };

    // Service layer handles: validation, auth, permission, mapping
    const data = await consultedServiceService.listByDentalService(
      currentUser,
      query
    );

    return NextResponse.json(data);
  } catch (error) {
    return handleApiError(error);
  }
}
```

**Notes**:

- Thin API layer - delegate to Service
- Service handles: validation, auth, permission, clinic scoping, mapping
- Error handling via `handleApiError()`

---

### 6. API Client (Frontend)

**File**: `src/features/consulted-services/api.ts`

**ThÃªm function má»›i**:

```typescript
/**
 * Get consulted services by dental service
 */
export async function getConsultedServicesByServiceApi(
  params: GetConsultedServicesByServiceQuery
): Promise<ConsultedServicesByServiceResponse> {
  const query = new URLSearchParams(params as Record<string, string>);
  const res = await fetch(`${CONSULTED_SERVICE_ENDPOINTS.BY_SERVICE}?${query}`);
  if (!res.ok) {
    const error = await res.text();
    throw new Error(error);
  }
  return res.json();
}
```

---

### 7. Constants

**File**: `src/features/consulted-services/constants.ts`

**ThÃªm endpoint má»›i**:

```typescript
export const CONSULTED_SERVICE_ENDPOINTS = {
  // ... existing endpoints
  BY_SERVICE: "/api/v1/consulted-services/by-service", // NEW
};
```

---

### 8. React Query Hook

**File**: `src/features/consulted-services/hooks/useConsultedServicesByService.ts` **(Má»šI)**

```typescript
import { useQuery } from "@tanstack/react-query";
import { getConsultedServicesByServiceApi } from "../api";
import type { GetConsultedServicesByServiceQuery } from "@/shared/validation/consulted-service.schema";

export const CONSULTED_SERVICE_BY_SERVICE_QUERY_KEY =
  "consulted-services-by-service";

/**
 * React Query hook: Get consulted services by dental service
 */
export function useConsultedServicesByService(
  params: GetConsultedServicesByServiceQuery
) {
  return useQuery({
    queryKey: [CONSULTED_SERVICE_BY_SERVICE_QUERY_KEY, params],
    queryFn: () => getConsultedServicesByServiceApi(params),
    enabled: !!params.dentalServiceId && !!params.clinicId,
    staleTime: 30_000, // 30s (cÃ³ thá»ƒ adjust)
  });
}
```

**Notes**:

- `enabled`: Chá»‰ fetch khi cÃ³ Ä‘á»§ `dentalServiceId` vÃ  `clinicId`
- `staleTime`: 30s (data Ã­t thay Ä‘á»•i theo realtime)

---

### 9. UI Component - Filters

**File**: `src/features/consulted-services/components/ConsultedServiceByServiceFilters.tsx` **(Má»šI)**

```typescript
"use client";

import React from "react";
import { Button, Space, Typography, Select } from "antd";
import { FileExcelOutlined } from "@ant-design/icons";
import { useDentalServices } from "@/features/dental-services";

const { Text } = Typography;

type Props = {
  loading?: boolean;
  count: number;
  selectedDentalServiceId?: string;
  onDentalServiceChange: (id: string | undefined) => void;
  onExport?: () => void;
};

export default function ConsultedServiceByServiceFilters({
  loading,
  count,
  selectedDentalServiceId,
  onDentalServiceChange,
  onExport,
}: Props) {
  // Load dental services (cached)
  const { data: dentalServices, isLoading: servicesLoading } =
    useDentalServices();

  return (
    <div
      style={{
        display: "flex",
        flexDirection: "column",
        gap: 16,
        marginBottom: 16,
      }}
    >
      {/* Row 1: Dental Service Selector */}
      <div
        style={{
          display: "flex",
          alignItems: "center",
          gap: 16,
        }}
      >
        <Text strong>Chá»n dá»‹ch vá»¥:</Text>
        <Select
          style={{ flex: 1, maxWidth: 400 }}
          placeholder="Chá»n dá»‹ch vá»¥ nha khoa"
          value={selectedDentalServiceId}
          onChange={onDentalServiceChange}
          loading={servicesLoading}
          showSearch
          filterOption={(input, option) =>
            (option?.label ?? "").toLowerCase().includes(input.toLowerCase())
          }
          options={dentalServices?.map((service) => ({
            label: service.name,
            value: service.id,
          }))}
          allowClear
        />
      </div>

      {/* Row 2: Count + Export */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        {/* Left side: Count display */}
        <Text strong>
          {selectedDentalServiceId
            ? `${count} dá»‹ch vá»¥ tÆ° váº¥n`
            : "Vui lÃ²ng chá»n dá»‹ch vá»¥"}
        </Text>

        {/* Right side: Export button */}
        <Space>
          <Button
            icon={<FileExcelOutlined />}
            onClick={onExport}
            loading={loading}
            disabled={count === 0 || !selectedDentalServiceId}
          >
            Xuáº¥t Excel
          </Button>
        </Space>
      </div>
    </div>
  );
}
```

**Notes**:

- **Select Dental Service**:
  - Data tá»« `useDentalServices()` (cached toÃ n bá»™)
  - `showSearch` + `filterOption` (client-side filter)
  - `allowClear` Ä‘á»ƒ bá» chá»n
- **Count text**: Hiá»ƒn thá»‹ "Vui lÃ²ng chá»n dá»‹ch vá»¥" náº¿u chÆ°a chá»n
- **Export button**: Disabled náº¿u chÆ°a chá»n hoáº·c count = 0

---

### 10. UI Component - View

**File**: `src/features/consulted-services/views/ConsultedServiceByServiceView.tsx` **(Má»šI)**

```typescript
"use client";

import React, { useCallback, useState } from "react";
import { Typography } from "antd";
import ClinicTabs from "@/shared/components/ClinicTabs";
import {
  ConsultedServiceStatistics,
  ConsultedServiceTable,
  UpdateConsultedServiceModal,
  useConsultedServicesByService,
  useConfirmConsultedService,
  useDeleteConsultedService,
  useUpdateConsultedService,
  exportConsultedServicesToExcel,
} from "@/features/consulted-services";
import ConsultedServiceByServiceFilters from "../components/ConsultedServiceByServiceFilters";
import { useCurrentUser } from "@/shared/providers";
import { useNotify } from "@/shared/hooks/useNotify";
import type {
  ConsultedServiceResponse,
  UpdateConsultedServiceRequest,
} from "@/shared/validation/consulted-service.schema";

const { Title } = Typography;

export default function ConsultedServiceByServiceView() {
  const { user: currentUser } = useCurrentUser();
  const notify = useNotify();

  // State: Clinic + Dental Service
  const [selectedClinicId, setSelectedClinicId] = useState<string | undefined>(
    currentUser?.clinicId || undefined
  );
  const [selectedDentalServiceId, setSelectedDentalServiceId] = useState<
    string | undefined
  >();

  // Query data
  const { data, isLoading } = useConsultedServicesByService({
    dentalServiceId: selectedDentalServiceId!,
    clinicId: selectedClinicId!,
  });

  const services = React.useMemo(() => data?.items ?? [], [data?.items]);

  // Modal state
  const [editingService, setEditingService] =
    useState<ConsultedServiceResponse | null>(null);

  // Mutations (reuse tá»« daily view)
  const confirmMutation = useConfirmConsultedService();
  const deleteMutation = useDeleteConsultedService();
  const updateMutation = useUpdateConsultedService();

  // Handlers (reuse logic tá»« daily view)
  const handleConfirm = useCallback(
    (id: string) => {
      confirmMutation.mutate(id);
    },
    [confirmMutation]
  );

  const handleEdit = useCallback((service: ConsultedServiceResponse) => {
    setEditingService(service);
  }, []);

  const handleDelete = useCallback(
    (id: string) => {
      deleteMutation.mutate(id);
    },
    [deleteMutation]
  );

  const handleUpdateSubmit = useCallback(
    (id: string, data: UpdateConsultedServiceRequest) => {
      updateMutation.mutate(
        { id, data },
        {
          onSuccess: () => {
            setEditingService(null);
          },
        }
      );
    },
    [updateMutation]
  );

  const handleCloseEditModal = useCallback(() => {
    setEditingService(null);
  }, []);

  const handleExportExcel = useCallback(async () => {
    if (!services.length) {
      notify.warning("KhÃ´ng cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t");
      return;
    }

    try {
      // Find service name for filename
      const serviceName = services[0]?.dentalService?.name || "dich-vu-tu-van";
      const filename = `${serviceName.toLowerCase().replace(/\s+/g, "-")}.xlsx`;
      await exportConsultedServicesToExcel(services, filename);
      notify.success(`ÄÃ£ xuáº¥t ${services.length} dá»‹ch vá»¥ tÆ° váº¥n`);
    } catch (error) {
      console.error("Export error:", error);
      notify.error(error, { fallback: "CÃ³ lá»—i xáº£y ra khi xuáº¥t file Excel" });
    }
  }, [services, notify]);

  return (
    <div>
      {/* Header */}
      <Title level={2} style={{ marginBottom: 24 }}>
        Dá»‹ch vá»¥ tÆ° váº¥n theo dá»‹ch vá»¥
      </Title>

      {/* Clinic Tabs */}
      <ClinicTabs
        value={selectedClinicId}
        onChange={(id) => setSelectedClinicId(id)}
      />

      {/* Statistics */}
      <ConsultedServiceStatistics
        statistics={data?.statistics}
        loading={isLoading}
      />

      {/* Filters: Dental Service Selector + Export */}
      <ConsultedServiceByServiceFilters
        count={services.length}
        loading={isLoading}
        selectedDentalServiceId={selectedDentalServiceId}
        onDentalServiceChange={setSelectedDentalServiceId}
        onExport={handleExportExcel}
      />

      {/* Table (reuse 100%) */}
      <ConsultedServiceTable
        data={services}
        loading={isLoading}
        onConfirm={handleConfirm}
        onEdit={handleEdit}
        onDelete={handleDelete}
        actionLoading={confirmMutation.isPending || deleteMutation.isPending}
      />

      {/* Edit Modal (reuse 100%) */}
      {editingService && (
        <UpdateConsultedServiceModal
          service={editingService}
          open={!!editingService}
          onCancel={handleCloseEditModal}
          onSubmit={handleUpdateSubmit}
          confirmLoading={updateMutation.isPending}
        />
      )}
    </div>
  );
}
```

**Notes**:

- **Header**: Static title "Dá»‹ch vá»¥ tÆ° váº¥n theo dá»‹ch vá»¥" (khÃ´ng cÃ³ date navigation)
- **State**: `selectedClinicId` + `selectedDentalServiceId`
- **Query hook**: `useConsultedServicesByService()` (chá»‰ fetch khi cÃ³ Ä‘á»§ IDs)
- **Reuse components**: Statistics, Table, Modal (100%)
- **Export filename**: Dynamic theo tÃªn dá»‹ch vá»¥ (VD: "rang-su-tham-my.xlsx")

---

### 11. Barrel Export

**File**: `src/features/consulted-services/index.ts`

**ThÃªm exports má»›i**:

```typescript
// ... existing exports

// By Service View (009.1)
export { default as ConsultedServiceByServiceView } from "./views/ConsultedServiceByServiceView";
export { default as ConsultedServiceByServiceFilters } from "./components/ConsultedServiceByServiceFilters";
export { useConsultedServicesByService } from "./hooks/useConsultedServicesByService";
```

---

### 12. Route Setup

**File má»›i**: `src/app/(private)/consulted-services/by-service/page.tsx`

```typescript
import { ConsultedServiceByServiceView } from "@/features/consulted-services";

export default function ConsultedServiceByServicePage() {
  return <ConsultedServiceByServiceView />;
}
```

**Metadata** (optional):

```typescript
export const metadata = {
  title: "Dá»‹ch vá»¥ tÆ° váº¥n theo dá»‹ch vá»¥",
};
```

---

## ğŸ“‹ Testing Checklist

### Backend

- [ ] Validate query schema vá»›i invalid dentalServiceId/clinicId â†’ 400
- [ ] Test clinic permission: User khÃ´ng thuá»™c clinic â†’ 403
- [ ] Query tráº£ vá» Ä‘Ãºng items theo dentalServiceId filter
- [ ] Statistics tÃ­nh toÃ¡n Ä‘Ãºng (totalAmount, totalPaid, totalDebt)
- [ ] Soft delete: KhÃ´ng tráº£ vá» items cÃ³ deletedAt != null

### Frontend

- [ ] Dental Service Select load Ä‘Ãºng data (cached)
- [ ] Chá»n service â†’ Query tá»± Ä‘á»™ng fetch
- [ ] Count hiá»ƒn thá»‹ Ä‘Ãºng sá»‘ lÆ°á»£ng
- [ ] Statistics cards hiá»ƒn thá»‹ Ä‘Ãºng sá»‘ liá»‡u
- [ ] Table render Ä‘Ãºng (giá»‘ng daily view)
- [ ] Actions (confirm, edit, delete) hoáº¡t Ä‘á»™ng (reuse logic)
- [ ] Export Excel vá»›i filename theo tÃªn dá»‹ch vá»¥
- [ ] Disabled export khi chÆ°a chá»n service hoáº·c count = 0

### UX

- [ ] Loading states hiá»ƒn thá»‹ Ä‘Ãºng (query, export, actions)
- [ ] Empty state khi chÆ°a chá»n service: "Vui lÃ²ng chá»n dá»‹ch vá»¥"
- [ ] Empty state khi khÃ´ng cÃ³ data: Table empty
- [ ] Select cÃ³ search hoáº¡t Ä‘á»™ng (client-side filter)
- [ ] Clear select â†’ Reset view

---

## ğŸ¨ UI/UX Notes

### Layout Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Title: "Dá»‹ch vá»¥ tÆ° váº¥n theo dá»‹ch vá»¥"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Clinic A] [Clinic B] [Clinic C]            â”‚ â† ClinicTabs
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tá»•ng tiá»n  â”‚ ÄÃ£ thanh   â”‚ CÃ´ng ná»£    â”‚ â† Statistics
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chá»n dá»‹ch vá»¥: [Select vá»›i search]          â”‚ â† Filters Row 1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "X dá»‹ch vá»¥ tÆ° váº¥n"        [Xuáº¥t Excel]      â”‚ â† Filters Row 2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Table: Columns giá»‘ng Daily View             â”‚
â”‚ - NgÃ y tÆ° váº¥n, KhÃ¡ch hÃ ng, Dá»‹ch vá»¥...       â”‚
â”‚ - Actions: Confirm, Edit, Delete            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mobile Responsive

- Filters stack vertically (flex-direction: column)
- Select width: 100% on mobile
- Table horizontal scroll

---

## ğŸ“¦ Files Summary

### Táº O Má»šI (9 files)

#### Backend (4 files)

1. **Zod Schema**: `src/shared/validation/consulted-service.schema.ts`

   - ThÃªm: `GetConsultedServicesByServiceQuerySchema` + type
   - ThÃªm: `ConsultedServicesByServiceResponseSchema` (alias)

2. **Repository**: `src/server/repos/consulted-service.repo.ts`

   - ThÃªm method: `listByDentalService()` - Return raw Prisma data

3. **Service**: `src/server/services/consulted-service.service.ts`

   - ThÃªm method: `listByDentalService()` - Business logic + mapping

4. **API Route**: `src/app/api/v1/consulted-services/by-service/route.ts`
   - GET handler (thin layer, delegate to Service)

#### Frontend (5 files)

5. **API Client**: `src/features/consulted-services/api.ts`

   - ThÃªm: `getConsultedServicesByServiceApi()`

6. **Constants**: `src/features/consulted-services/constants.ts`

   - ThÃªm: `CONSULTED_SERVICE_ENDPOINTS.BY_SERVICE`

7. **Hook**: `src/features/consulted-services/hooks/useConsultedServicesByService.ts`

   - Query hook má»›i

8. **Filters Component**: `src/features/consulted-services/components/ConsultedServiceByServiceFilters.tsx`

   - UI vá»›i Dental Service selector + Export

9. **View Component**: `src/features/consulted-services/views/ConsultedServiceByServiceView.tsx`

   - Main view vá»›i logic hoÃ n chá»‰nh

10. **Route**: `src/app/(private)/consulted-services/by-service/page.tsx`
    - Next.js page route

### Táº¬N Dá»¤NG (Reuse 100%)

#### Backend

- âœ… `mapConsultedServiceToResponse()` - Mapper (transform Prisma â†’ Response)

#### Components

- âœ… `ConsultedServiceStatistics` (display statistics)
- âœ… `ConsultedServiceTable` (table vá»›i actions)
- âœ… `UpdateConsultedServiceModal` (edit modal)

#### Hooks/Utils

- âœ… `useConfirmConsultedService` (mutation)
- âœ… `useDeleteConsultedService` (mutation)
- âœ… `useUpdateConsultedService` (mutation)
- âœ… `exportConsultedServicesToExcel` (export utility)
- âœ… `useDentalServices` (load master data)

## ğŸš€ Implementation Order

1. **Backend First** (Bottom-up: Repository â†’ Service â†’ API):

   - âœ… Zod schema (validation)
   - âœ… Repository method `listByDentalService()` (data access)
   - âœ… Service method `listByDentalService()` (business logic + mapping)
   - âœ… API Route (thin layer)
   - Test vá»›i Postman/Thunder Client

2. **Frontend Second**:

   - âœ… API client + constants
   - âœ… React Query hook
   - âœ… Filters component (UI vá»›i Select)
   - âœ… View component (layout + logic)
   - âœ… Route setup (Next.js page)

3. **Integration**:

   - âœ… Test full flow: chá»n service â†’ fetch â†’ display â†’ actions
   - âœ… Test export Excel
   - âœ… Test permissions (Employee vs Admin)t
   - âœ… View component
   - âœ… Route setup

4. **Integration**:
   - âœ… Test full flow: chá»n service â†’ fetch â†’ display â†’ actions
   - âœ… Test export Excel
   - âœ… Test permissions

---

## ğŸ“š Related Documentation

- **Parent**: `009 Consulted-Service.md` (core requirements)
- **Similar Pattern**: `007.2 Customer Detail - Appointments.md` (filter by relation)
- **Guidelines**: `GUIDELINES.md` (architecture patterns)
