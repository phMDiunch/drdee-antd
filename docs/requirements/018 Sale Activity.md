# 018 Sale Activity

## ğŸ“‹ Tá»•ng Quan

**Module**: Sales Activity Log - Nháº­t kÃ½ liÃªn há»‡ Sale

**Má»¥c Ä‘Ã­ch**: Ghi láº¡i vÃ  quáº£n lÃ½ hoáº¡t Ä‘á»™ng liÃªn há»‡ giá»¯a sale staff vÃ  khÃ¡ch hÃ ng cho tá»«ng dá»‹ch vá»¥ tÆ° váº¥n (ConsultedService), há»— trá»£ follow-up vÃ  tÄƒng conversion rate.

**Implementation Status**: âœ… Phase 1 MVP Completed

**Pháº¡m vi**:

- Ghi nháº­t kÃ½ liÃªn há»‡ (call, message, meet) do sale staff táº¡o thá»§ cÃ´ng
- Theo dÃµi lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c theo tá»«ng dá»‹ch vá»¥ (service-centric)
- Hiá»ƒn thá»‹ trong Customer Detail tab "Sale follow-up"

---

## ğŸ¯ Business Goals

### Primary Objectives

1. **Traceability**: Ghi láº¡i Ä‘áº§y Ä‘á»§ lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c vá»›i khÃ¡ch hÃ ng
2. **Follow-up Management**: Äáº£m báº£o khÃ´ng bá» sÃ³t khÃ¡ch hÃ ng tiá»m nÄƒng
3. **Performance Tracking**: Äo lÆ°á»ng hiá»‡u quáº£ lÃ m viá»‡c cá»§a sales team
4. **Conversion Optimization**: TÄƒng tá»· lá»‡ chá»‘t sale thÃ´ng qua follow-up cÃ³ káº¿ hoáº¡ch

### Key Metrics

- Sá»‘ láº§n contact trung bÃ¬nh trÆ°á»›c khi chá»‘t
- Response time (thá»i gian tá»« láº§n contact nÃ y Ä‘áº¿n láº§n tiáº¿p theo)
- Follow-up completion rate
- Lost deal reasons analysis

---

## ğŸ² Decision Log

### Architecture Decisions

#### âœ… **Service-Centric Data Model**

- Má»—i activity log gáº¯n vá»›i 1 `ConsultedService` (khÃ´ng pháº£i Customer)
- **LÃ½ do**:
  - 1 khÃ¡ch hÃ ng cÃ³ thá»ƒ tÆ° váº¥n nhiá»u dá»‹ch vá»¥ khÃ¡c nhau
  - Má»—i dá»‹ch vá»¥ cÃ³ timeline riÃªng, sale phá»¥ trÃ¡ch riÃªng
  - Dá»… track conversion funnel theo tá»«ng service
- **Trade-off**: View theo customer cáº§n JOIN/GROUP nhiá»u hÆ¡n

#### âœ… **Separated from Stage History**

- SalesActivityLog: Track contact activities (call, message...)
- StageHistory: Track stage transitions (QUOTED â†’ DEPOSIT...)
- **LÃ½ do**: TÃ¡ch concerns, flexible stage changes khÃ´ng cáº§n activity
- **Reference**: Salesforce pattern (Task/Event vs OpportunityHistory)

#### âœ… **Manual Logs Only**

- Táº¥t cáº£ logs Ä‘á»u do sale staff tá»± ghi nháº­t kÃ½ khi cÃ³ tÆ°Æ¡ng tÃ¡c thá»±c táº¿ vá»›i khÃ¡ch hÃ ng
- KhÃ´ng cÃ³ auto-generated logs tá»« system events
- **LÃ½ do**:
  - ÄÆ¡n giáº£n hÃ³a data model (khÃ´ng cáº§n field `isAutoGenerated`)
  - Focus vÃ o tracking actual sales activities (call, message, meet)
  - System events Ä‘Ã£ Ä‘Æ°á»£c track á»Ÿ cÃ¡c module khÃ¡c (ConsultedService history, StageHistory)

#### âœ… **Single Sale Ownership**

- Má»—i activity chá»‰ cÃ³ 1 `saleId` (ngÆ°á»i thá»±c hiá»‡n contact)
- KhÃ´ng support team collaboration trong Phase 1
- **LÃ½ do**: ÄÆ¡n giáº£n hÃ³a permission, Ä‘á»§ cho 80% use cases

### Database Design

```prisma
model SalesActivityLog {
  id String @id @default(uuid())

  // LiÃªn káº¿t (Service-centric)
  consultedServiceId String
  consultedService   ConsultedService @relation(...)

  saleId String  // NgÆ°á»i thá»±c hiá»‡n contact
  sale   Employee @relation(...)

  // ThÃ´ng tin liÃªn há»‡
  contactType    String   // "call" | "message" | "meet"
  contactDate    DateTime @default(now()) @db.Timestamptz

  // Ná»™i dung
  content String  // TÃ³m táº¯t cuá»™c trao Ä‘á»•i (báº¯t buá»™c)

  // Follow-up plan
  nextContactDate DateTime? @db.Date

  // Metadata
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Indexes
  @@index([consultedServiceId, contactDate(sort: Desc)])
  @@index([saleId, contactDate(sort: Desc)])
  @@index([nextContactDate]) // For follow-up queries
}
```

### Permission Rules

**Quyá»n dá»±a trÃªn: Role + Service Ownership + Record Ownership**

**Roles**: Employee, Admin (2 roles only)

#### CREATE

| Role     | Permission                                                     |
| -------- | -------------------------------------------------------------- |
| Employee | âœ… Náº¿u `consultingSaleId` hoáº·c `saleOnlineId` = currentUser.id |
| Admin    | âœ… Táº¡o cho báº¥t ká»³ service nÃ o                                  |

**Validation**:

- `contactDate` khÃ´ng Ä‘Æ°á»£c > now
- `nextContactDate` pháº£i > `contactDate` (náº¿u cÃ³)
- `content` min 10 characters

#### UPDATE

| Role     | Permission                                              |
| -------- | ------------------------------------------------------- |
| Employee | âœ… Chá»‰ edit record cá»§a mÃ¬nh (`saleId = currentUser.id`) |
| Admin    | âœ… Edit báº¥t ká»³ record nÃ o                               |

**RÃ ng buá»™c**:

- Chá»‰ edit Ä‘Æ°á»£c trong 7 ngÃ y ká»ƒ tá»« khi táº¡o

#### DELETE

| Role     | Permission                           |
| -------- | ------------------------------------ |
| Employee | âœ… Chá»‰ xÃ³a record cá»§a mÃ¬nh trong 24h |
| Admin    | âœ… XÃ³a báº¥t ká»³ record nÃ o             |

**Validation**:

- Same day check: `contactDate.date === today.date`

#### VIEW

| Role     | Permission                                                                 |
| -------- | -------------------------------------------------------------------------- |
| Employee | âœ… Xem logs cá»§a services mÃ¬nh phá»¥ trÃ¡ch (consultingSaleId or saleOnlineId) |
| Admin    | âœ… Xem táº¥t cáº£ logs (cross-clinic)                                          |

### Architecture

- âœ… **Hybrid Architecture**: GET qua API Routes + Mutations qua Server Actions
- âœ… **Modal Pattern**: Single modal `SalesActivityModal` vá»›i mode (add/edit)
- âœ… **Permission**: Service ownership + record ownership checks
- âœ… **Data Flow**: React Query (GET) + Server Actions (CUD)

---

## ğŸ–¥ï¸ View Structure

### 1. Customer Detail â†’ Sales Activity Tab â­ PRIMARY VIEW

**Route**: `/customers/[id]` â†’ Tab "Sale follow-up"

**Layout**:

**Header:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ Nguyá»…n VÄƒn A - 0912345678                                              â”‚
â”‚  Tabs: [ThÃ´ng tin] [Lá»‹ch háº¹n] [Dá»‹ch vá»¥ tÆ° váº¥n]                            â”‚
â”‚        [ğŸ†• Sale follow-up] [Phiáº¿u thu] ...                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3 dá»‹ch vá»¥ cáº§n follow-up                              [+ ThÃªm hoáº¡t Ä‘á»™ng]  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Activities Table:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NgÃ y giá»    â”‚Dá»‹ch vá»¥        â”‚HÃ¬nh thá»©câ”‚Ná»™i dung          â”‚Follow-upâ”‚NV â”‚âš™ï¸  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚19/12 14:00  â”‚Niá»ng Invisalignâ”‚ğŸ“ Call â”‚KH Ä‘á»“ng Ã½ cá»c 50%â”‚22/12    â”‚Maiâ”‚âœï¸ğŸ—‘ï¸â”‚
â”‚             â”‚(QUOTED)        â”‚        â”‚háº¹n Ä‘áº¿n...        â”‚         â”‚   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚19/12 11:30  â”‚Implant HÃ m     â”‚ğŸ’¬ Zalo â”‚Gá»­i hÃ¬nh áº£nh ca..â”‚         â”‚HÃ¹ngâ”‚âœï¸ğŸ—‘ï¸â”‚
â”‚             â”‚(DEPOSIT)       â”‚        â”‚                  â”‚         â”‚   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚19/12 09:00  â”‚Bá»c rÄƒng sá»©     â”‚ğŸ‘¥ Meet â”‚Check-up Ä‘á»‹nh ká»³ â”‚25/12    â”‚Lanâ”‚âœï¸ğŸ—‘ï¸â”‚
â”‚             â”‚(TREATING)      â”‚        â”‚                  â”‚         â”‚   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚18/12 16:00  â”‚Niá»ng Invisalignâ”‚ğŸ’¬ Zalo â”‚Gá»­i bÃ¡o giÃ¡ chi..â”‚         â”‚Maiâ”‚âœï¸ğŸ—‘ï¸â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚18/12 10:15  â”‚Implant HÃ m     â”‚ğŸ“§ Emailâ”‚Gá»­i há»“ sÆ¡ ca lÃ¢m.â”‚         â”‚HÃ¹ngâ”‚âœï¸ğŸ—‘ï¸â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features**:

- **Header Layout** (pattern giá»‘ng cÃ¡c tab khÃ¡c):
  - **BÃªn trÃ¡i**: "X dá»‹ch vá»¥ cáº§n follow-up" (dynamic count - chá»‰ services cÃ³ nextContactDate)
  - **BÃªn pháº£i**: Button "+ ThÃªm hoáº¡t Ä‘á»™ng"
- **Activities Table**: Table thuáº§n, sort DESC (newest first)
- **Table Columns**:
  - **NgÃ y giá»**: Full datetime (DD/MM HH:mm)
  - **Dá»‹ch vá»¥**: Service name + stage badge (filterable)
  - **HÃ¬nh thá»©c**: contactType icon + label (filterable)
  - **Ná»™i dung**: content (truncated, max 50 chars, expandable)
  - **Follow-up**: nextContactDate (DD/MM)
  - **NV**: Sale staff fullName
  - **âš™ï¸**: Edit âœï¸ + Delete ğŸ—‘ï¸ actions
- **Pagination**: Client-side pagination vá»›i Ant Design Table (default pageSize: 10, showSizeChanger: true)
- **Use case**: Timeline view, xem táº¥t cáº£ hoáº¡t Ä‘á»™ng theo thá»i gian

**Components**:

- `SalesActivitiesTab.tsx`: Main container
  - **Header Row** (Space with justify="space-between"):
    - Left: `Typography.Text` - "X dá»‹ch vá»¥ cáº§n follow-up"
    - Right: `Button` - "+ ThÃªm hoáº¡t Ä‘á»™ng" (opens SalesActivityModal)
  - `SalesActivityTable.tsx`: Single flat table with all activities
    - Ant Design Table
    - Sort by contactDate DESC
    - Expandable content rows
    - Client-side pagination: `pagination={{ pageSize: 10, showSizeChanger: true, pageSizeOptions: ['10', '20', '50', '100'] }}`
- **Modals**:
  - `SalesActivityModal.tsx`: Single modal for both create & edit (mode: "add" | "edit")

---

### 2. Sales Activity Modal (Create/Edit)

**Component**: `SalesActivityModal.tsx` (mode: "add" | "edit")

**Layout**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ghi nháº­t kÃ½ liÃªn há»‡                             [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  KhÃ¡ch hÃ ng: Nguyá»…n VÄƒn A - 0912345678                â”‚
â”‚  Dá»‹ch vá»¥:    Niá»ng RÄƒng Invisalign                    â”‚
â”‚                                                        â”‚
â”‚  Loáº¡i liÃªn há»‡ *                                        â”‚
â”‚  [â—‹ Gá»i Ä‘iá»‡n (Call)] [â—‹ Nháº¯n tin (Message)] [â—‹ Gáº·p máº·t (Meet)] â”‚
â”‚                                                        â”‚
â”‚  NgÃ y giá» liÃªn há»‡ *                                    â”‚
â”‚  [20/12/2025] [14:30] â† Pre-filled = now              â”‚
â”‚                                                        â”‚
â”‚  Ná»™i dung trao Ä‘á»•i *                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ KH há»i vá» thá»i gian Ä‘iá»u trá»‹...                  â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  â˜‘ Äáº·t lá»‹ch follow-up                                  â”‚
â”‚    NgÃ y: [22/12/2025â–¼]                                 â”‚
â”‚                                                        â”‚
â”‚                              [Há»§y]  [LÆ°u nháº­t kÃ½]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Validation**:

- `contactType`: Required
- `contactDate`: Required, <= now
- `content`: Required, min 10 chars, max 5000 chars
- `nextContactDate`: Optional, > contactDate

**Components**:

- `SalesActivityModal.tsx`: Single modal for create & edit
  - Props: `mode: 'add' | 'edit'`, `initialData?`, `appointmentId?`
  - Form: React Hook Form + Zod validation
  - Conditional: Schema & behavior based on mode

---

## ğŸ“Š Daily View (Theo dÃµi hoáº¡t Ä‘á»™ng sale hÃ ng ngÃ y)

### Structure

```
<PageHeaderWithDateNav />           // Shared component with date navigation
<ClinicTabs />                      // Admin chá»n clinic
<SalesActivityStatistics />         // 4 KPI cards
<SalesActivityFilters />            // Display count + Export
<SalesActivityTable />              // Data table
```

### Statistics (4 Cards)

| Metric                  | Logic                                                    | Display Format  |
| ----------------------- | -------------------------------------------------------- | --------------- |
| Tá»•ng sá»‘ liÃªn há»‡         | Count all sales activities hÃ´m nay                       | "45 liÃªn há»‡"    |
| Sá»‘ khÃ¡ch Ä‘Æ°á»£c liÃªn há»‡   | Count unique customers cÃ³ sales activity hÃ´m nay         | "32 khÃ¡ch"      |
| Sá»‘ dá»‹ch vá»¥ Ä‘Æ°á»£c follow  | Count unique consultedServices cÃ³ sales activity hÃ´m nay | "28 dá»‹ch vá»¥"    |
| Tá»· lá»‡ theo loáº¡i liÃªn há»‡ | Distribution: Call / Message / Meet                      | "ğŸ“ 20 ğŸ’¬ 15 ğŸ‘¥ 10" |

**Query Logic**:

- **Tá»•ng sá»‘ liÃªn há»‡**: `SELECT COUNT(*) FROM SalesActivityLog WHERE DATE(contactDate) = TODAY AND clinicId = ?`
- **Sá»‘ khÃ¡ch Ä‘Æ°á»£c liÃªn há»‡**: `SELECT COUNT(DISTINCT consultedService.customerId) FROM SalesActivityLog JOIN ConsultedService WHERE DATE(contactDate) = TODAY`
- **Sá»‘ dá»‹ch vá»¥ Ä‘Æ°á»£c follow**: `SELECT COUNT(DISTINCT consultedServiceId) FROM SalesActivityLog WHERE DATE(contactDate) = TODAY`
- **Tá»· lá»‡ theo loáº¡i**: Frontend calculation - group by contactType

### Filters

- **Display**: "X hoáº¡t Ä‘á»™ng liÃªn há»‡ hÃ´m nay" (X = sá»‘ sales activities)
- **Actions**:
  - Button "Xuáº¥t Excel" (export daily data)
- **No Search, No Create, No Refresh button** (táº¡o tá»« Customer Detail; React Query auto-refetch)

### Table Columns

**Component**: Reuse `SalesActivityTable` tá»« Customer Detail (same component, different props)

| Column           | Width | Sort/Filter | Description                                                                                    |
| ---------------- | ----- | ----------- | ---------------------------------------------------------------------------------------------- |
| Giá» liÃªn há»‡      | 100px | âœ… Sort     | `contactDate` (HH:mm) - Sort by: contactDate DESC (default)                                   |
| KhÃ¡ch hÃ ng       | 180px | -           | Line 1: TÃªn (link)<br>Line 2: MÃ£ + SÄT (text-muted)                                           |
| Dá»‹ch vá»¥          | 200px | âœ… Filter   | `consultedService.consultedServiceName` + stage badge                                          |
| Loáº¡i liÃªn há»‡     | 120px | âœ… Filter   | Icon + Label: ğŸ“ Call / ğŸ’¬ Message / ğŸ‘¥ Meet                                                   |
| Ná»™i dung         | 300px | -           | `content` (truncate at 60 chars, tooltip on hover)                                             |
| Follow-up        | 100px | âœ… Filter   | `nextContactDate` (DD/MM) hoáº·c "-"                                                             |
| Sale staff       | 140px | âœ… Filter   | `sale.fullName`                                                                                |
| Thao tÃ¡c         | 120px | -           | Edit âœï¸ \| Delete ğŸ—‘ï¸ (fixed="right", conditional by permission)                               |

**Notes**:

- **Reuse existing component**: `SalesActivityTable` Ä‘Ã£ implement á»Ÿ Customer Detail
  - Pass props: `showCustomerColumn={true}` + `showDateColumn={false}` + `showTimeColumn={true}`
  - Cá»™t "KhÃ¡ch hÃ ng" CHá»ˆ hiá»‡n á»Ÿ Daily View (cáº§n biáº¿t ai lÃ  khÃ¡ch)
  - Cá»™t "NgÃ y liÃªn há»‡" áº¨N á»Ÿ Daily View (vÃ¬ Ä‘Ã£ filter theo 1 ngÃ y, redundant)
  - Cá»™t "Giá» liÃªn há»‡" HIá»†N á»Ÿ Daily View (hiá»ƒn thá»‹ timeline trong ngÃ y)
- **KhÃ¡ch hÃ ng**:
  - TÃªn: Link â†’ navigate to `/customers/{customerId}?tab=sales-activities` (Customer Detail - Sales Activity Tab)
  - SÄT: Hiá»ƒn thá»‹ phone number tá»« customer
- **Ná»™i dung**:
  - Truncate at 60 chars vá»›i "..."
  - Tooltip hiá»ƒn thá»‹ full content on hover (maxWidth: 400px)
- **Sort/Filter**: Client-side (dá»¯ liá»‡u daily < 500 records)
- **Default sort**: Contact Date DESC (newest first) - `defaultSortOrder: "descend"` on Giá» liÃªn há»‡ column
- **Total width**: ~1400px (compact, focus vÃ o content)

### Permissions

- **View Access**:
  - Employee: Xem sales activities cá»§a clinic mÃ¬nh
  - Admin: Chá»n clinic vÃ  xem
- **Actions**:
  - Edit: Conditional display (show náº¿u Admin hoáº·c Employee + saleId match)
  - Delete: Conditional display (same as Edit)

### Navigation

**Sidebar Menu**: ThÃªm menu item má»›i

```
ğŸ“‹ Quáº£n lÃ½ (Section)
  â”œâ”€â”€ ğŸ“… Lá»‹ch háº¹n
  â”œâ”€â”€ ğŸ¦· Dá»‹ch vá»¥ tÆ° váº¥n
  â”œâ”€â”€ ğŸ’Š Lá»‹ch sá»­ Ä‘iá»u trá»‹
  â”œâ”€â”€ ğŸ“ Hoáº¡t Ä‘á»™ng Sale  â† NEW
  â””â”€â”€ ...
```

**Menu Config**:

- Label: "Hoáº¡t Ä‘á»™ng Sale"
- Icon: PhoneOutlined (hoáº·c CustomerServiceOutlined)
- Path: `/sales-activities`
- Permission: Accessible by all authenticated users (Employee + Admin)

---

## API Routes & Server Actions

### API Routes (Queries - GET)

#### GET /api/v1/sales-activities/daily

**Description**: Láº¥y sales activities cá»§a 1 ngÃ y cá»¥ thá»ƒ cho Daily View

**Query params**:

```typescript
{
  date: string;     // YYYY-MM-DD format (required)
  clinicId: string; // UUID (required for Employee, optional for Admin)
}
```

**Response**:

```typescript
{
  items: SalesActivityLog[];
  statistics: {
    totalActivities: number;        // Tá»•ng sá»‘ liÃªn há»‡
    totalCustomers: number;         // Sá»‘ khÃ¡ch Ä‘Æ°á»£c liÃªn há»‡
    totalServices: number;          // Sá»‘ dá»‹ch vá»¥ Ä‘Æ°á»£c follow
    contactTypeDistribution: {      // PhÃ¢n bá»‘ theo loáº¡i
      call: number;
      message: number;
      meet: number;
    };
  };
}
```

**Business Logic**:

- Filter: `DATE(contactDate) = params.date AND clinicId = params.clinicId`
- Include: consultedService (consultedServiceName, customer with fullName + phone + customerCode), sale (fullName)
- Sort: `contactDate DESC` (newest first)
- **Statistics Calculation**:
  - `totalActivities`: Count all filtered activities
  - `totalCustomers`: Count distinct `consultedService.customerId` from filtered activities
  - `totalServices`: Count distinct `consultedServiceId` from filtered activities
  - `contactTypeDistribution`: Group by contactType and count

**Permission Check**:

- Employee: Auto-filter by user's clinicId (ignore params.clinicId)
- Admin: Use params.clinicId (required)

**Caching**: No cache (sales activity data changes frequently during the day)

---

#### GET /api/v1/sales-activities

**Description**: Láº¥y danh sÃ¡ch sales activities vá»›i filtering

**Query params**:

- `customerId`: Filter by customer (optional)
- `consultedServiceId`: Filter by service (optional)
- `saleId`: Filter by sale staff (optional)
- `pageSize`: Limit sá»‘ records (default: 200, max: 500)
- `sortField`: "contactDate" | "createdAt" (default: "contactDate")
- `sortDirection`: "asc" | "desc" (default: "desc")

**Note**: Load all activities trong limit, frontend xá»­ lÃ½ pagination vá»›i Ant Design Table.

**Response**:

```typescript
{
  items: SalesActivityLog[],
  total: number
}
```

**Permission**:

- **Employee**: Xem activities cá»§a services mÃ¬nh phá»¥ trÃ¡ch
  - Filter: `consultedService.consultingSaleId = currentUser.id` OR `consultedService.saleOnlineId = currentUser.id`
- **Admin**: Xem táº¥t cáº£ (cross-clinic)

**Example**:

```
GET /api/v1/sales-activities?customerId=xxx&pageSize=200&sortField=contactDate&sortDirection=desc
```

**Caching**: No cache

---

### Server Actions (Mutations - CUD)

#### `createSalesActivityAction(data: CreateSalesActivityRequest)`

**Input**:

```typescript
{
  consultedServiceId: string,
  contactType: "call" | "message" | "meet",
  contactDate: Date, // Must be <= now
  content: string, // Min 10, max 5000 chars
  nextContactDate?: Date | null // Must be > contactDate
}
```

**Process**:

1. Get session user
2. Validate consultedService exists
3. **Permission check**: Employee must be service owner (consultingSaleId or saleOnlineId), Admin allowed
4. Validate contactDate, nextContactDate, content
5. Set saleId = currentUser.id
6. Create record
7. Return created record (201)

**Error Codes**:

- 403: Permission denied
- 400: Validation error
- 404: ConsultedService not found

---

#### `updateSalesActivityAction(id: string, data: UpdateSalesActivityRequest)`

**Input**: Same as create (partial update allowed)

**Process**:

1. Get session user
2. Fetch existing record
3. **Permission check**: Employee must be record owner + within 7 days, Admin allowed
4. Validate new data
5. Update record
6. Return updated record (200)

**Error Codes**:

- 403: Permission denied
- 400: Validation error
- 404: Record not found

---

#### `deleteSalesActivityAction(id: string)`

**Process**:

1. Get session user
2. Fetch existing record
3. **Permission check**: Employee must be record owner + within 24h, Admin allowed
4. Delete record (hard delete)
5. Return 204

**Error Codes**:

- 403: Permission denied
- 404: Record not found

---

## ğŸ—„ï¸ Implementation Details

### Frontend Architecture

#### Daily View Hooks

##### `useDailySalesActivities(date: string, clinicId: string)`

**Purpose**: Fetch daily sales activities vá»›i statistics

**Query Key**: `["sales-activities", "daily", date, clinicId]`

**API Call**: `GET /api/v1/sales-activities/daily?date=&clinicId=`

**Return**:

```typescript
{
  data: {
    items: SalesActivityLog[];
    statistics: {
      totalActivities: number;
      totalCustomers: number;
      totalServices: number;
      contactTypeDistribution: {
        call: number;
        message: number;
        meet: number;
      };
    };
  };
  isLoading: boolean;
  error: Error | null;
}
```

**Caching Strategy**:

```typescript
staleTime: 60 * 1000,             // 1 phÃºt (transactional data)
gcTime: 5 * 60 * 1000,            // 5 phÃºt
refetchOnWindowFocus: true,       // Fetch láº¡i khi chuyá»ƒn tab
```

**Usage**:

```typescript
// In SalesActivityDailyView component
const { user } = useCurrentUser();
const { selectedDate } = useDateNavigation();
const [selectedClinicId, setSelectedClinicId] = useState(user?.clinicId);

const { data, isLoading } = useDailySalesActivities(selectedDate, selectedClinicId);
```

---

### File Structure

```
src/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ actions/
â”‚   â”‚   â””â”€â”€ sales-activity.actions.ts        # Server Actions (CUD)
â”‚   â”œâ”€â”€ repos/
â”‚   â”‚   â””â”€â”€ sales-activity.repo.ts          # Database operations
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ sales-activity/
â”‚           â”œâ”€â”€ service.ts                  # Business logic
â”‚           â””â”€â”€ _mappers.ts                 # Data transformation
â”œâ”€â”€ app/api/v1/
â”‚   â””â”€â”€ sales-activities/
â”‚       â”œâ”€â”€ route.ts                        # GET /api/v1/sales-activities
â”‚       â””â”€â”€ daily/
â”‚           â””â”€â”€ route.ts                    # GET /api/v1/sales-activities/daily â­ NEW
â””â”€â”€ features/sales-activities/
    â”œâ”€â”€ api.ts                             # React Query hooks
    â”œâ”€â”€ constants.ts                       # Contact type labels
    â”œâ”€â”€ hooks/                             # Mutation hooks
    â”‚   â”œâ”€â”€ useCreateSalesActivity.ts
    â”‚   â”œâ”€â”€ useUpdateSalesActivity.ts
    â”‚   â”œâ”€â”€ useDeleteSalesActivity.ts
    â”‚   â”œâ”€â”€ useSalesActivities.ts
    â”‚   â””â”€â”€ useDailySalesActivities.ts     # â­ NEW - Daily View hook
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ SalesActivityModal.tsx         # Create/Edit modal
    â”‚   â”œâ”€â”€ SalesActivityTable.tsx         # Table with actions (reusable)
    â”‚   â”œâ”€â”€ SalesActivityStatistics.tsx    # â­ NEW - Daily View statistics
    â”‚   â””â”€â”€ SalesActivityFilters.tsx       # â­ NEW - Daily View filters
    â”œâ”€â”€ views/
    â”‚   â””â”€â”€ SalesActivityDailyView.tsx     # â­ NEW - Daily View page
    â””â”€â”€ index.ts                           # Public exports
```

### Data Transformation

**Mapper** (`_mappers.ts`):

- Convert Date â†’ ISO strings
- Convert nextContactDate â†’ YYYY-MM-DD format
- Type cast contactType to enum

**No computed fields** - hiá»ƒn thá»‹ fullName trá»±c tiáº¿p.

---

## ğŸ¨ UI Components

```
CustomerDetailView â†’ SalesActivitiesTab
â”œâ”€â”€ Header (Space justify="space-between")
â”‚   â”œâ”€â”€ Typography: "X dá»‹ch vá»¥ cáº§n follow-up"
â”‚   â””â”€â”€ Button: "+ ThÃªm hoáº¡t Ä‘á»™ng"
â”œâ”€â”€ SalesActivityTable
â”‚   â”œâ”€â”€ Ant Design Table (client-side pagination)
â”‚   â”œâ”€â”€ Columns: NgÃ y giá», Dá»‹ch vá»¥, HÃ¬nh thá»©c, Ná»™i dung, Follow-up, NV
â”‚   â””â”€â”€ Actions: Edit/Delete (permission-based)
â””â”€â”€ SalesActivityModal (mode: add | edit)
```

---

## ğŸ§ª Testing Checklist

### Create

- [x] Táº¡o activity cho service mÃ¬nh phá»¥ trÃ¡ch
- [x] Permission denied khi khÃ´ng pháº£i service owner
- [x] Validation: contactDate, nextContactDate, content

### View

- [x] Xem activities cá»§a services mÃ¬nh phá»¥ trÃ¡ch
- [x] Table hiá»ƒn thá»‹ Ä‘Ãºng, sort DESC
- [x] Client-side pagination hoáº¡t Ä‘á»™ng

### Edit/Delete

- [x] Edit activity cá»§a mÃ¬nh trong 7 ngÃ y
- [x] Delete activity cá»§a mÃ¬nh trong 24h
- [x] Admin cÃ³ full permission

---

## ğŸ“Š Future Enhancements

### Analytics & Reports

- Activity volume tracking
- Conversion funnel analysis
- Sales performance metrics
- Follow-up completion rate

### Features

- Activity templates (call scripts)
- SMS/Email integration
- Calendar sync
- Mobile app support
- AI suggestions

---

## ğŸš€ Implementation Plan

### Phase 1: MVP âœ… COMPLETED

- [x] Database schema: SalesActivityLog model
- [x] Zod validation schemas
- [x] **Backend - Repository Layer** (`src/server/repos/sales-activity.repo.ts`)
  - [x] Database operations with proper includes
- [x] **Backend - Service Layer** (`src/server/services/sales-activity.service.ts`)
  - [x] Business logic + permission checks
  - [x] CRUD operations with validation
- [x] **Backend - Mappers** (`src/server/services/sales-activity/_mappers.ts`)
  - [x] Transform Prisma data to response DTOs
- [x] **Backend - Server Actions** (`src/server/actions/sales-activity.actions.ts`)
  - [x] `createSalesActivityAction()`
  - [x] `updateSalesActivityAction()`
  - [x] `deleteSalesActivityAction()`
- [x] **Backend - API Routes**
  - [x] `GET /api/v1/sales-activities` - List with filters
- [x] **Frontend - API Hooks** (`src/features/sales-activities/api.ts`)
  - [x] `useSalesActivities()` - React Query for GET
  - [x] Mutation hooks for Server Actions
- [x] **Frontend - Components**
  - [x] `SalesActivityModal.tsx` - Single modal for create/edit
  - [x] `SalesActivityTable.tsx` - Table with actions
  - [x] `SalesActivitiesTab.tsx` - Container in Customer Detail
- [x] Customer Detail â†’ Sales Activity Tab integration
- [x] Permission logic (backend + frontend)

### Phase 2: Daily View (Planned)

- [ ] **Backend - Repository Layer** (`src/server/repos/sales-activity.repo.ts`)
  - [ ] Add `listDaily()` method with date range filter
  - [ ] Add statistics calculation queries
- [ ] **Backend - Service Layer** (`src/server/services/sales-activity/service.ts`)
  - [ ] Add `listDaily()` with business logic
  - [ ] Calculate statistics (totalActivities, totalCustomers, totalServices, contactTypeDistribution)
- [ ] **Backend - API Routes**
  - [ ] `GET /api/v1/sales-activities/daily` - Daily view with statistics
- [ ] **Frontend - API Client** (`src/features/sales-activities/api.ts`)
  - [ ] `getDailySalesActivitiesApi()` - Fetch daily data
- [ ] **Frontend - Hooks** (`src/features/sales-activities/hooks/`)
  - [ ] `useDailySalesActivities()` - React Query hook for daily view
- [ ] **Frontend - Components**
  - [ ] `SalesActivityDailyView.tsx` - Main daily view page
  - [ ] `SalesActivityStatistics.tsx` - 4 KPI cards
  - [ ] `SalesActivityFilters.tsx` - Display count + Export button
  - [ ] Update `SalesActivityTable.tsx` - Add props for Daily View mode
- [ ] **Navigation**
  - [ ] Add sidebar menu item "Hoáº¡t Ä‘á»™ng Sale"
  - [ ] Configure route `/sales-activities`
- [ ] **Testing**
  - [ ] Manual testing: Statistics accuracy
  - [ ] Manual testing: Table display and filters
  - [ ] Manual testing: Permission checks (Employee/Admin)
  - [ ] Manual testing: Date navigation

### Phase 3: Enhanced Features (Future)

- [ ] Activity templates
- [ ] Bulk operations
- [ ] Notifications
- [ ] Export Excel

### Phase 3: Analytics (Future)

- [ ] Volume charts
- [ ] Conversion funnel
- [ ] Performance reports

---

## ğŸ“ Notes

### Known Limitations

- Phase 1: KhÃ´ng support team collaboration (1 activity = 1 sale)
- Phase 1: KhÃ´ng cÃ³ reminder notifications
- Phase 1: KhÃ´ng cÃ³ call recording integration
- Phase 1: Chá»‰ manual logs (khÃ´ng auto-track system events)

### Future Enhancements

- Activity templates & call scripts
- SMS/Email integration (auto-create activity)
- Calendar sync (Google Calendar)
- Call recording integration
- AI suggestions for next actions
- Mobile app support

### Related Modules

- **Stage History** (019): Track stage transitions
- **Consulted Service** (009): Core entity
- **Customer** (007): Customer Detail integration
- **Reports** (011): Analytics dashboard

---

## ğŸ”— References

- Database: `prisma/schema.prisma` â†’ SalesActivityLog model
- Schemas: `src/shared/validation/sales-activity.schema.ts`
- Service: `src/server/services/sales-activity/`
- Actions: `src/server/actions/sales-activity.actions.ts`
- API: `src/app/api/v1/sales-activities/route.ts`
- UI: `src/features/sales-activities/`

---

**Status**: âœ… IMPLEMENTED  
**Last Updated**: 2025-12-21  
**Author**: AI Assistant  
**Approved By**: _Completed_
