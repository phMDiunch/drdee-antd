# 018 Sale Activity

## ğŸ“‹ Tá»•ng Quan

**Module**: Sales Activity Log - Nháº­t kÃ½ liÃªn há»‡ Sale

**Má»¥c Ä‘Ã­ch**: Ghi láº¡i vÃ  quáº£n lÃ½ hoáº¡t Ä‘á»™ng liÃªn há»‡ giá»¯a sale staff vÃ  khÃ¡ch hÃ ng cho tá»«ng dá»‹ch vá»¥ tÆ° váº¥n (ConsultedService), há»— trá»£ follow-up vÃ  tÄƒng conversion rate.

**Implementation Status**: âœ… Phase 1 MVP Completed

**Pháº¡m vi**:

- Ghi nháº­t kÃ½ liÃªn há»‡ (call, message, meet) do sale staff táº¡o thá»§ cÃ´ng
- Theo dÃµi lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c theo tá»«ng dá»‹ch vá»¥ (service-centric)
- Hiá»ƒn thá»‹ trong Customer Detail tab "Sale follow-up"

---

## ğŸ¯ Business Goals

### Primary Objectives

1. **Traceability**: Ghi láº¡i Ä‘áº§y Ä‘á»§ lá»‹ch sá»­ tÆ°Æ¡ng tÃ¡c vá»›i khÃ¡ch hÃ ng
2. **Follow-up Management**: Äáº£m báº£o khÃ´ng bá» sÃ³t khÃ¡ch hÃ ng tiá»m nÄƒng
3. **Performance Tracking**: Äo lÆ°á»ng hiá»‡u quáº£ lÃ m viá»‡c cá»§a sales team
4. **Conversion Optimization**: TÄƒng tá»· lá»‡ chá»‘t sale thÃ´ng qua follow-up cÃ³ káº¿ hoáº¡ch

### Key Metrics

- Sá»‘ láº§n contact trung bÃ¬nh trÆ°á»›c khi chá»‘t
- Response time (thá»i gian tá»« láº§n contact nÃ y Ä‘áº¿n láº§n tiáº¿p theo)
- Follow-up completion rate
- Lost deal reasons analysis

---

## ğŸ² Decision Log

### Architecture Decisions

#### âœ… **Service-Centric Data Model**

- Má»—i activity log gáº¯n vá»›i 1 `ConsultedService` (khÃ´ng pháº£i Customer)
- **LÃ½ do**:
  - 1 khÃ¡ch hÃ ng cÃ³ thá»ƒ tÆ° váº¥n nhiá»u dá»‹ch vá»¥ khÃ¡c nhau
  - Má»—i dá»‹ch vá»¥ cÃ³ timeline riÃªng, sale phá»¥ trÃ¡ch riÃªng
  - Dá»… track conversion funnel theo tá»«ng service
- **Trade-off**: View theo customer cáº§n JOIN/GROUP nhiá»u hÆ¡n

#### âœ… **Separated from Stage History**

- SalesActivityLog: Track contact activities (call, message...)
- StageHistory: Track stage transitions (QUOTED â†’ DEPOSIT...)
- **LÃ½ do**: TÃ¡ch concerns, flexible stage changes khÃ´ng cáº§n activity
- **Reference**: Salesforce pattern (Task/Event vs OpportunityHistory)

#### âœ… **Manual Logs Only**

- Táº¥t cáº£ logs Ä‘á»u do sale staff tá»± ghi nháº­t kÃ½ khi cÃ³ tÆ°Æ¡ng tÃ¡c thá»±c táº¿ vá»›i khÃ¡ch hÃ ng
- KhÃ´ng cÃ³ auto-generated logs tá»« system events
- **LÃ½ do**:
  - ÄÆ¡n giáº£n hÃ³a data model (khÃ´ng cáº§n field `isAutoGenerated`)
  - Focus vÃ o tracking actual sales activities (call, message, meet)
  - System events Ä‘Ã£ Ä‘Æ°á»£c track á»Ÿ cÃ¡c module khÃ¡c (ConsultedService history, StageHistory)

#### âœ… **Single Sale Ownership**

- Má»—i activity chá»‰ cÃ³ 1 `saleId` (ngÆ°á»i thá»±c hiá»‡n contact)
- KhÃ´ng support team collaboration trong Phase 1
- **LÃ½ do**: ÄÆ¡n giáº£n hÃ³a permission, Ä‘á»§ cho 80% use cases

### Database Design

```prisma
model SalesActivityLog {
  id String @id @default(uuid())

  // LiÃªn káº¿t (Service-centric)
  consultedServiceId String
  consultedService   ConsultedService @relation(...)

  saleId String  // NgÆ°á»i thá»±c hiá»‡n contact
  sale   Employee @relation(...)

  // ThÃ´ng tin liÃªn há»‡
  contactType    String   // "call" | "message" | "meet"
  contactDate    DateTime @default(now()) @db.Timestamptz

  // Ná»™i dung
  content String  // TÃ³m táº¯t cuá»™c trao Ä‘á»•i (báº¯t buá»™c)

  // Follow-up plan
  nextContactDate DateTime? @db.Date

  // Metadata
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Indexes
  @@index([consultedServiceId, contactDate(sort: Desc)])
  @@index([saleId, contactDate(sort: Desc)])
  @@index([nextContactDate]) // For follow-up queries
}
```

### Permission Rules

**Quyá»n dá»±a trÃªn: Role + Service Ownership + Record Ownership**

**Roles**: Employee, Admin (2 roles only)

#### CREATE

| Role     | Permission                                                     |
| -------- | -------------------------------------------------------------- |
| Employee | âœ… Náº¿u `consultingSaleId` hoáº·c `saleOnlineId` = currentUser.id |
| Admin    | âœ… Táº¡o cho báº¥t ká»³ service nÃ o                                  |

**Validation**:

- `contactDate` khÃ´ng Ä‘Æ°á»£c > now
- `nextContactDate` pháº£i > `contactDate` (náº¿u cÃ³)
- `content` min 10 characters

#### UPDATE

| Role     | Permission                                              |
| -------- | ------------------------------------------------------- |
| Employee | âœ… Chá»‰ edit record cá»§a mÃ¬nh (`saleId = currentUser.id`) |
| Admin    | âœ… Edit báº¥t ká»³ record nÃ o                               |

**RÃ ng buá»™c**:

- Chá»‰ edit Ä‘Æ°á»£c trong 7 ngÃ y ká»ƒ tá»« khi táº¡o

#### DELETE

| Role     | Permission                           |
| -------- | ------------------------------------ |
| Employee | âœ… Chá»‰ xÃ³a record cá»§a mÃ¬nh trong 24h |
| Admin    | âœ… XÃ³a báº¥t ká»³ record nÃ o             |

**Validation**:

- Same day check: `contactDate.date === today.date`

#### VIEW

| Role     | Permission                                                                 |
| -------- | -------------------------------------------------------------------------- |
| Employee | âœ… Xem logs cá»§a services mÃ¬nh phá»¥ trÃ¡ch (consultingSaleId or saleOnlineId) |
| Admin    | âœ… Xem táº¥t cáº£ logs (cross-clinic)                                          |

### Architecture

- âœ… **Hybrid Architecture**: GET qua API Routes + Mutations qua Server Actions
- âœ… **Modal Pattern**: Single modal `SalesActivityModal` vá»›i mode (add/edit)
- âœ… **Permission**: Service ownership + record ownership checks
- âœ… **Data Flow**: React Query (GET) + Server Actions (CUD)

---

## ğŸ–¥ï¸ View Structure

### 1. Customer Detail â†’ Sales Activity Tab â­ PRIMARY VIEW

**Route**: `/customers/[id]` â†’ Tab "Sale follow-up"

**Layout**:

**Header:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ Nguyá»…n VÄƒn A - 0912345678                                              â”‚
â”‚  Tabs: [ThÃ´ng tin] [Lá»‹ch háº¹n] [Dá»‹ch vá»¥ tÆ° váº¥n]                            â”‚
â”‚        [ğŸ†• Sale follow-up] [Phiáº¿u thu] ...                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3 dá»‹ch vá»¥ cáº§n follow-up                              [+ ThÃªm hoáº¡t Ä‘á»™ng]  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Activities Table:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NgÃ y giá»    â”‚Dá»‹ch vá»¥        â”‚HÃ¬nh thá»©câ”‚Ná»™i dung          â”‚Follow-upâ”‚NV â”‚âš™ï¸  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚19/12 14:00  â”‚Niá»ng Invisalignâ”‚ğŸ“ Call â”‚KH Ä‘á»“ng Ã½ cá»c 50%â”‚22/12    â”‚Maiâ”‚âœï¸ğŸ—‘ï¸â”‚
â”‚             â”‚(QUOTED)        â”‚        â”‚háº¹n Ä‘áº¿n...        â”‚         â”‚   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚19/12 11:30  â”‚Implant HÃ m     â”‚ğŸ’¬ Zalo â”‚Gá»­i hÃ¬nh áº£nh ca..â”‚         â”‚HÃ¹ngâ”‚âœï¸ğŸ—‘ï¸â”‚
â”‚             â”‚(DEPOSIT)       â”‚        â”‚                  â”‚         â”‚   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚19/12 09:00  â”‚Bá»c rÄƒng sá»©     â”‚ğŸ‘¥ Meet â”‚Check-up Ä‘á»‹nh ká»³ â”‚25/12    â”‚Lanâ”‚âœï¸ğŸ—‘ï¸â”‚
â”‚             â”‚(TREATING)      â”‚        â”‚                  â”‚         â”‚   â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚18/12 16:00  â”‚Niá»ng Invisalignâ”‚ğŸ’¬ Zalo â”‚Gá»­i bÃ¡o giÃ¡ chi..â”‚         â”‚Maiâ”‚âœï¸ğŸ—‘ï¸â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚18/12 10:15  â”‚Implant HÃ m     â”‚ğŸ“§ Emailâ”‚Gá»­i há»“ sÆ¡ ca lÃ¢m.â”‚         â”‚HÃ¹ngâ”‚âœï¸ğŸ—‘ï¸â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features**:

- **Header Layout** (pattern giá»‘ng cÃ¡c tab khÃ¡c):
  - **BÃªn trÃ¡i**: "X dá»‹ch vá»¥ cáº§n follow-up" (dynamic count - chá»‰ services cÃ³ nextContactDate)
  - **BÃªn pháº£i**: Button "+ ThÃªm hoáº¡t Ä‘á»™ng"
- **Activities Table**: Table thuáº§n, sort DESC (newest first)
- **Table Columns**:
  - **NgÃ y giá»**: Full datetime (DD/MM HH:mm)
  - **Dá»‹ch vá»¥**: Service name + stage badge (filterable)
  - **HÃ¬nh thá»©c**: contactType icon + label (filterable)
  - **Ná»™i dung**: content (truncated, max 50 chars, expandable)
  - **Follow-up**: nextContactDate (DD/MM)
  - **NV**: Sale staff fullName
  - **âš™ï¸**: Edit âœï¸ + Delete ğŸ—‘ï¸ actions
- **Pagination**: Client-side pagination vá»›i Ant Design Table (default pageSize: 10, showSizeChanger: true)
- **Use case**: Timeline view, xem táº¥t cáº£ hoáº¡t Ä‘á»™ng theo thá»i gian

**Components**:

- `SalesActivitiesTab.tsx`: Main container
  - **Header Row** (Space with justify="space-between"):
    - Left: `Typography.Text` - "X dá»‹ch vá»¥ cáº§n follow-up"
    - Right: `Button` - "+ ThÃªm hoáº¡t Ä‘á»™ng" (opens SalesActivityModal)
  - `SalesActivityTable.tsx`: Single flat table with all activities
    - Ant Design Table
    - Sort by contactDate DESC
    - Expandable content rows
    - Client-side pagination: `pagination={{ pageSize: 10, showSizeChanger: true, pageSizeOptions: ['10', '20', '50', '100'] }}`
- **Modals**:
  - `SalesActivityModal.tsx`: Single modal for both create & edit (mode: "add" | "edit")

---

### 2. Sales Activity Modal (Create/Edit)

**Component**: `SalesActivityModal.tsx` (mode: "add" | "edit")

**Layout**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ghi nháº­t kÃ½ liÃªn há»‡                             [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  KhÃ¡ch hÃ ng: Nguyá»…n VÄƒn A - 0912345678                â”‚
â”‚  Dá»‹ch vá»¥:    Niá»ng RÄƒng Invisalign                    â”‚
â”‚                                                        â”‚
â”‚  Loáº¡i liÃªn há»‡ *                                        â”‚
â”‚  [â—‹ Gá»i Ä‘iá»‡n (Call)] [â—‹ Nháº¯n tin (Message)] [â—‹ Gáº·p máº·t (Meet)] â”‚
â”‚                                                        â”‚
â”‚  NgÃ y giá» liÃªn há»‡ *                                    â”‚
â”‚  [20/12/2025] [14:30] â† Pre-filled = now              â”‚
â”‚                                                        â”‚
â”‚  Ná»™i dung trao Ä‘á»•i *                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ KH há»i vá» thá»i gian Ä‘iá»u trá»‹...                  â”‚ â”‚
â”‚  â”‚                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                        â”‚
â”‚  â˜‘ Äáº·t lá»‹ch follow-up                                  â”‚
â”‚    NgÃ y: [22/12/2025â–¼]                                 â”‚
â”‚                                                        â”‚
â”‚                              [Há»§y]  [LÆ°u nháº­t kÃ½]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Validation**:

- `contactType`: Required
- `contactDate`: Required, <= now
- `content`: Required, min 10 chars, max 5000 chars
- `nextContactDate`: Optional, > contactDate

**Components**:

- `SalesActivityModal.tsx`: Single modal for create & edit
  - Props: `mode: 'add' | 'edit'`, `initialData?`, `appointmentId?`
  - Form: React Hook Form + Zod validation
  - Conditional: Schema & behavior based on mode

---

## API Routes & Server Actions

### API Routes (Queries - GET)

#### GET /api/v1/sales-activities

**Description**: Láº¥y danh sÃ¡ch sales activities vá»›i filtering

**Query params**:

- `customerId`: Filter by customer (optional)
- `consultedServiceId`: Filter by service (optional)
- `saleId`: Filter by sale staff (optional)
- `pageSize`: Limit sá»‘ records (default: 200, max: 500)
- `sortField`: "contactDate" | "createdAt" (default: "contactDate")
- `sortDirection`: "asc" | "desc" (default: "desc")

**Note**: Load all activities trong limit, frontend xá»­ lÃ½ pagination vá»›i Ant Design Table.

**Response**:

```typescript
{
  items: SalesActivityLog[],
  total: number
}
```

**Permission**:

- **Employee**: Xem activities cá»§a services mÃ¬nh phá»¥ trÃ¡ch
  - Filter: `consultedService.consultingSaleId = currentUser.id` OR `consultedService.saleOnlineId = currentUser.id`
- **Admin**: Xem táº¥t cáº£ (cross-clinic)

**Example**:

```
GET /api/v1/sales-activities?customerId=xxx&pageSize=200&sortField=contactDate&sortDirection=desc
```

**Caching**: No cache

---

### Server Actions (Mutations - CUD)

#### `createSalesActivityAction(data: CreateSalesActivityRequest)`

**Input**:

```typescript
{
  consultedServiceId: string,
  contactType: "call" | "message" | "meet",
  contactDate: Date, // Must be <= now
  content: string, // Min 10, max 5000 chars
  nextContactDate?: Date | null // Must be > contactDate
}
```

**Process**:

1. Get session user
2. Validate consultedService exists
3. **Permission check**: Employee must be service owner (consultingSaleId or saleOnlineId), Admin allowed
4. Validate contactDate, nextContactDate, content
5. Set saleId = currentUser.id
6. Create record
7. Return created record (201)

**Error Codes**:

- 403: Permission denied
- 400: Validation error
- 404: ConsultedService not found

---

#### `updateSalesActivityAction(id: string, data: UpdateSalesActivityRequest)`

**Input**: Same as create (partial update allowed)

**Process**:

1. Get session user
2. Fetch existing record
3. **Permission check**: Employee must be record owner + within 7 days, Admin allowed
4. Validate new data
5. Update record
6. Return updated record (200)

**Error Codes**:

- 403: Permission denied
- 400: Validation error
- 404: Record not found

---

#### `deleteSalesActivityAction(id: string)`

**Process**:

1. Get session user
2. Fetch existing record
3. **Permission check**: Employee must be record owner + within 24h, Admin allowed
4. Delete record (hard delete)
5. Return 204

**Error Codes**:

- 403: Permission denied
- 404: Record not found

---

## ğŸ—„ï¸ Implementation Details

### File Structure

```
src/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ actions/
â”‚   â”‚   â””â”€â”€ sales-activity.actions.ts        # Server Actions (CUD)
â”‚   â”œâ”€â”€ repos/
â”‚   â”‚   â””â”€â”€ sales-activity.repo.ts          # Database operations
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ sales-activity/
â”‚           â”œâ”€â”€ service.ts                  # Business logic
â”‚           â””â”€â”€ _mappers.ts                 # Data transformation
â”œâ”€â”€ app/api/v1/
â”‚   â””â”€â”€ sales-activities/
â”‚       â””â”€â”€ route.ts                        # GET endpoint
â””â”€â”€ features/sales-activities/
    â”œâ”€â”€ api.ts                             # React Query hooks
    â”œâ”€â”€ constants.ts                       # Contact type labels
    â”œâ”€â”€ hooks/                             # Mutation hooks
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ SalesActivityModal.tsx         # Create/Edit modal
    â”‚   â””â”€â”€ SalesActivityTable.tsx         # Table with actions
    â””â”€â”€ index.ts                           # Public exports
```

### Data Transformation

**Mapper** (`_mappers.ts`):

- Convert Date â†’ ISO strings
- Convert nextContactDate â†’ YYYY-MM-DD format
- Type cast contactType to enum

**No computed fields** - hiá»ƒn thá»‹ fullName trá»±c tiáº¿p.

---

## ğŸ¨ UI Components

```
CustomerDetailView â†’ SalesActivitiesTab
â”œâ”€â”€ Header (Space justify="space-between")
â”‚   â”œâ”€â”€ Typography: "X dá»‹ch vá»¥ cáº§n follow-up"
â”‚   â””â”€â”€ Button: "+ ThÃªm hoáº¡t Ä‘á»™ng"
â”œâ”€â”€ SalesActivityTable
â”‚   â”œâ”€â”€ Ant Design Table (client-side pagination)
â”‚   â”œâ”€â”€ Columns: NgÃ y giá», Dá»‹ch vá»¥, HÃ¬nh thá»©c, Ná»™i dung, Follow-up, NV
â”‚   â””â”€â”€ Actions: Edit/Delete (permission-based)
â””â”€â”€ SalesActivityModal (mode: add | edit)
```

---

## ğŸ§ª Testing Checklist

### Create

- [x] Táº¡o activity cho service mÃ¬nh phá»¥ trÃ¡ch
- [x] Permission denied khi khÃ´ng pháº£i service owner
- [x] Validation: contactDate, nextContactDate, content

### View

- [x] Xem activities cá»§a services mÃ¬nh phá»¥ trÃ¡ch
- [x] Table hiá»ƒn thá»‹ Ä‘Ãºng, sort DESC
- [x] Client-side pagination hoáº¡t Ä‘á»™ng

### Edit/Delete

- [x] Edit activity cá»§a mÃ¬nh trong 7 ngÃ y
- [x] Delete activity cá»§a mÃ¬nh trong 24h
- [x] Admin cÃ³ full permission

---

## ğŸ“Š Future Enhancements

### Analytics & Reports

- Activity volume tracking
- Conversion funnel analysis
- Sales performance metrics
- Follow-up completion rate

### Features

- Activity templates (call scripts)
- SMS/Email integration
- Calendar sync
- Mobile app support
- AI suggestions

---

## ğŸš€ Implementation Plan

### Phase 1: MVP âœ… COMPLETED

- [x] Database schema: SalesActivityLog model
- [x] Zod validation schemas
- [x] **Backend - Repository Layer** (`src/server/repos/sales-activity.repo.ts`)
  - [x] Database operations with proper includes
- [x] **Backend - Service Layer** (`src/server/services/sales-activity.service.ts`)
  - [x] Business logic + permission checks
  - [x] CRUD operations with validation
- [x] **Backend - Mappers** (`src/server/services/sales-activity/_mappers.ts`)
  - [x] Transform Prisma data to response DTOs
- [x] **Backend - Server Actions** (`src/server/actions/sales-activity.actions.ts`)
  - [x] `createSalesActivityAction()`
  - [x] `updateSalesActivityAction()`
  - [x] `deleteSalesActivityAction()`
- [x] **Backend - API Routes**
  - [x] `GET /api/v1/sales-activities` - List with filters
- [x] **Frontend - API Hooks** (`src/features/sales-activities/api.ts`)
  - [x] `useSalesActivities()` - React Query for GET
  - [x] Mutation hooks for Server Actions
- [x] **Frontend - Components**
  - [x] `SalesActivityModal.tsx` - Single modal for create/edit
  - [x] `SalesActivityTable.tsx` - Table with actions
  - [x] `SalesActivitiesTab.tsx` - Container in Customer Detail
- [x] Customer Detail â†’ Sales Activity Tab integration
- [x] Permission logic (backend + frontend)

### Phase 2: Enhanced Features (Future)

- [ ] Activity templates
- [ ] Bulk operations
- [ ] Notifications
- [ ] Export Excel

### Phase 3: Analytics (Future)

- [ ] Volume charts
- [ ] Conversion funnel
- [ ] Performance reports

---

## ğŸ“ Notes

### Known Limitations

- Phase 1: KhÃ´ng support team collaboration (1 activity = 1 sale)
- Phase 1: KhÃ´ng cÃ³ reminder notifications
- Phase 1: KhÃ´ng cÃ³ call recording integration
- Phase 1: Chá»‰ manual logs (khÃ´ng auto-track system events)

### Future Enhancements

- Activity templates & call scripts
- SMS/Email integration (auto-create activity)
- Calendar sync (Google Calendar)
- Call recording integration
- AI suggestions for next actions
- Mobile app support

### Related Modules

- **Stage History** (019): Track stage transitions
- **Consulted Service** (009): Core entity
- **Customer** (007): Customer Detail integration
- **Reports** (011): Analytics dashboard

---

## ğŸ”— References

- Database: `prisma/schema.prisma` â†’ SalesActivityLog model
- Schemas: `src/shared/validation/sales-activity.schema.ts`
- Service: `src/server/services/sales-activity/`
- Actions: `src/server/actions/sales-activity.actions.ts`
- API: `src/app/api/v1/sales-activities/route.ts`
- UI: `src/features/sales-activities/`

---

**Status**: âœ… IMPLEMENTED  
**Last Updated**: 2025-12-21  
**Author**: AI Assistant  
**Approved By**: _Completed_
