# ğŸ”§ Requirements: Master Data (Dá»¯ Liá»‡u Chá»§)

> **ğŸ“‹ STATUS: PENDING** - Giai Ä‘oáº¡n 1, TÃ­nh nÄƒng 1  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`  
> **ğŸ“„ Implementation**: `src/features/master-data/` (Shared toÃ n app)  
> **ğŸ“š Tham kháº£o kiáº¿n trÃºc**: `src/features/clinics/`, `src/features/dental-services/`

## ğŸ¯ Má»¥c TiÃªu

XÃ¢y dá»±ng há»‡ thá»‘ng quáº£n lÃ½ dá»¯ liá»‡u chá»§ (master data) cho **TOÃ€N Bá»˜ á»¨NG Dá»¤NG** - khÃ´ng chá»‰ riÃªng module Inventory. Sá»­ dá»¥ng báº£ng `MasterData` vá»›i cÆ¡ cháº¿ phÃ¢n loáº¡i theo `type` vÃ  há»— trá»£ cáº¥u trÃºc phÃ¢n cáº¥p (cha-con).

**âš ï¸ Quan trá»ng**: Feature nÃ y lÃ  **SHARED INFRASTRUCTURE** cho toÃ n app, quáº£n lÃ½ cÃ¡c dá»¯ liá»‡u Ä‘á»™ng mÃ  Admin cáº§n thÃªm/sá»­a/xÃ³a qua UI:

**Hiá»‡n táº¡i (Inventory module):**

- âœ… NhÃ³m nhÃ  cung cáº¥p (cÃ³ thá»ƒ thÃªm má»›i)
- âœ… NhÃ³m váº­t tÆ° / PhÃ¢n nhÃ³m (cÃ³ cáº¥u trÃºc phÃ¢n cáº¥p)
- âœ… Bá»™ mÃ´n (phÃ²ng khÃ¡m cÃ³ thá»ƒ má»Ÿ thÃªm)

**CÃ³ thá»ƒ má»Ÿ rá»™ng cho modules khÃ¡c:**

- ğŸ“‹ Nguá»“n khÃ¡ch hÃ ng (Customer Source)
- ğŸ“‹ Loáº¡i dá»‹ch vá»¥ Ä‘iá»u trá»‹ (Treatment Category)
- ğŸ“‹ PhÆ°Æ¡ng thá»©c thanh toÃ¡n tÃ¹y chá»‰nh (Custom Payment Methods)

**KhÃ´ng dÃ¹ng MasterData cho**:

- âŒ Status (DRAFT, POSTED) â†’ DÃ¹ng Prisma Enum (logic cá»©ng, khÃ´ng Ä‘á»•i)
- âŒ Loáº¡i váº­t tÆ° (4 loáº¡i cá»‘ Ä‘á»‹nh) â†’ DÃ¹ng Constants (business logic phá»¥ thuá»™c vÃ o key)

## ğŸ“‹ User Stories

### US-1: Quáº£n lÃ½ Danh má»¥c (Admin)

**LÃ  Admin**, tÃ´i muá»‘n:

- Xem danh sÃ¡ch cÃ¡c má»¥c cáº¥u hÃ¬nh, lá»c theo loáº¡i (type)
- ThÃªm má»›i má»™t má»¥c cáº¥u hÃ¬nh
- Chá»‰nh sá»­a thÃ´ng tin má»¥c cáº¥u hÃ¬nh
- VÃ´ hiá»‡u hÃ³a (khÃ´ng xÃ³a cá»©ng) má»¥c khÃ´ng cÃ²n sá»­ dá»¥ng
- Táº¡o cáº¥u trÃºc phÃ¢n cáº¥p (vÃ­ dá»¥: NhÃ³m váº­t tÆ° â†’ PhÃ¢n nhÃ³m váº­t tÆ°)

### US-2: Sá»­ dá»¥ng trong cÃ¡c Form khÃ¡c

**LÃ  User**, khi táº¡o/sá»­a NhÃ  cung cáº¥p, Váº­t tÆ°, hoáº·c báº¥t ká»³ form nÃ o trong app:

- TÃ´i chá»n tá»« cÃ¡c dropdown Ä‘Æ°á»£c láº¥y tá»« Master Data
- Dropdown chá»‰ hiá»ƒn thá»‹ cÃ¡c má»¥c Ä‘ang active
- Vá»›i dropdown cÃ³ phÃ¢n cáº¥p (TreeSelect), tÃ´i cÃ³ thá»ƒ chá»n cáº£ node cha hoáº·c con

## ğŸ¨ UI/UX Requirements

### Vá»‹ trÃ­ trong Menu

**Navigation Path**: `CÃ i Äáº·t > Dá»¯ Liá»‡u Há»‡ Thá»‘ng`

```
Sidebar Menu:
â”œâ”€â”€ Dashboard
â”œâ”€â”€ Lá»‹ch háº¹n
â”œâ”€â”€ KhÃ¡ch hÃ ng
â”œâ”€â”€ Dá»‹ch vá»¥
â”œâ”€â”€ Kho váº­t tÆ° â–¼
â”‚   â”œâ”€â”€ NhÃ  cung cáº¥p
â”‚   â”œâ”€â”€ Váº­t tÆ°
â”‚   â”œâ”€â”€ Phiáº¿u nháº­p kho
â”‚   â”œâ”€â”€ Phiáº¿u xuáº¥t kho
â”‚   â””â”€â”€ BÃ¡o cÃ¡o tá»“n kho
â””â”€â”€ âš™ï¸ CÃ i Äáº·t â–¼
    â”œâ”€â”€ PhÃ²ng khÃ¡m
    â”œâ”€â”€ NhÃ¢n viÃªn
    â”œâ”€â”€ ğŸ“‹ Dá»¯ Liá»‡u Há»‡ Thá»‘ng        â† â­ TÃ­nh nÄƒng nÃ y
    â””â”€â”€ Há»“ sÆ¡ & Báº£o máº­t
```

**Icon**: ğŸ“‹ (hoáº·c `<DatabaseOutlined />` tá»« Ant Design Icons)  
**Route**: `/settings/master-data`  
**Permission**: Chá»‰ Admin má»›i tháº¥y menu nÃ y

### MÃ n hÃ¬nh Danh sÃ¡ch

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Dá»¯ Liá»‡u Há»‡ Thá»‘ng (Master Data)              [+ ThÃªm Má»›i] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Lá»c theo loáº¡i: [Dropdown: Táº¥t cáº£ â–¼]                        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Type          â”‚ Key        â”‚ Value       â”‚ Active â”‚ âš™  â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”‚  â”‚
â”‚  â”‚ SUPPLIER_GROUPâ”‚ vt-ytĞµ     â”‚ VT Y Táº¿     â”‚   âœ“   â”‚ âœ â”‚  â”‚
â”‚  â”‚ SUPPLIER_GROUPâ”‚ labo       â”‚ Labo RÄƒng   â”‚   âœ“   â”‚ âœ â”‚  â”‚
â”‚  â”‚ UNIT          â”‚ cai        â”‚ CÃ¡i         â”‚   âœ“   â”‚ âœ â”‚  â”‚
â”‚  â”‚ UNIT          â”‚ hop        â”‚ Há»™p         â”‚   âœ“   â”‚ âœ â”‚  â”‚
â”‚  â”‚ MATERIAL_TYPE â”‚ tieu-hao   â”‚ TiÃªu hao    â”‚   âœ“   â”‚ âœ â”‚  â”‚
â”‚  â”‚ DEPARTMENT    â”‚ noi-nha    â”‚ Ná»™i nha     â”‚   âœ“   â”‚ âœ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Modal ThÃªm/Sá»­a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœï¸  ThÃªm Má»¥c Cáº¥u HÃ¬nh              [Ã—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  Loáº¡i (Type) *                               â”‚
â”‚  [Dropdown: Chá»n loáº¡i â–¼]                     â”‚
â”‚    - NhÃ³m nhÃ  cung cáº¥p                       â”‚
â”‚    - ÄÆ¡n vá»‹ tÃ­nh                             â”‚
â”‚    - Loáº¡i váº­t tÆ°                             â”‚
â”‚    - Bá»™ mÃ´n                                  â”‚
â”‚    - NhÃ³m váº­t tÆ°                             â”‚
â”‚                                              â”‚
â”‚  MÃ£ (Key) *                                  â”‚
â”‚  [_________________]                         â”‚
â”‚  (slug: vt-yte, noi-nha...)                  â”‚
â”‚                                              â”‚
â”‚  TÃªn hiá»ƒn thá»‹ (Value) *                      â”‚
â”‚  [_________________]                         â”‚
â”‚                                              â”‚
â”‚  MÃ´ táº£                                       â”‚
â”‚  [_________________]                         â”‚
â”‚                                              â”‚
â”‚  Thuá»™c nhÃ³m cha (Parent) - Optional          â”‚
â”‚  [TreeSelect: Chá»n parent â–¼]                 â”‚
â”‚                                              â”‚
â”‚  â˜‘ Äang hoáº¡t Ä‘á»™ng                            â”‚
â”‚                                              â”‚
â”‚         [Há»§y]          [LÆ°u]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Functional Requirements

### FR-1: CÃ¡c Loáº¡i Dictionary Cáº§n Quáº£n LÃ½

**DÃ¹ng MasterData (Database - Äá»™ng)**:

```typescript
// src/shared/constants/master-data.ts
// âš ï¸ KhÃ´ng dÃ¹ng Prisma Enum - dÃ¹ng String Ä‘á»ƒ linh hoáº¡t thÃªm type má»›i khÃ´ng cáº§n migration

export const MASTER_DATA_TYPES = {
  // === Inventory Module ===
  SUPPLIER_GROUP: "SUPPLIER_GROUP", // NhÃ³m nhÃ  cung cáº¥p
  DEPARTMENT: "DEPARTMENT", // Bá»™ mÃ´n (Ná»™i nha, Phá»¥c hÃ¬nh, Nha chu, Implant...)
  MATERIAL_CATEGORY: "MATERIAL_CATEGORY", // NhÃ³m & PhÃ¢n nhÃ³m váº­t tÆ° (cÃ³ cáº¥u trÃºc cÃ¢y)
  UNIT: "UNIT", // ÄÆ¡n vá»‹ tÃ­nh (CÃ¡i, Há»™p, Chai, Kg...) - Admin cÃ³ thá»ƒ thÃªm má»›i

  // === Future Modules (thÃªm trá»±c tiáº¿p vÃ o constants, khÃ´ng cáº§n migration) ===
  // CUSTOMER_SOURCE: "CUSTOMER_SOURCE",   // Nguá»“n khÃ¡ch hÃ ng
  // TREATMENT_CATEGORY: "TREATMENT_CATEGORY", // NhÃ³m Ä‘iá»u trá»‹
  // PAYMENT_METHOD: "PAYMENT_METHOD",     // PhÆ°Æ¡ng thá»©c thanh toÃ¡n tÃ¹y chá»‰nh
} as const;

export type MasterDataType =
  (typeof MASTER_DATA_TYPES)[keyof typeof MASTER_DATA_TYPES];

// Helper Ä‘á»ƒ láº¥y danh sÃ¡ch types hiá»‡n táº¡i
export const MASTER_DATA_TYPE_LIST = Object.values(MASTER_DATA_TYPES);
```

**DÃ¹ng Constants (Code - Cá»‘ Ä‘á»‹nh)**:

```typescript
// src/shared/constants/inventory.ts
export const MATERIAL_TYPES = {
  CONSUMABLE: { key: "CONSUMABLE", value: "Váº­t tÆ° tiÃªu hao" },
  NON_CONSUMABLE: { key: "NON_CONSUMABLE", value: "Váº­t tÆ° khÃ´ng tiÃªu hao" },
  TOOLS: { key: "TOOLS", value: "CÃ´ng cá»¥ dá»¥ng cá»¥" },
  FIXED_ASSET: { key: "FIXED_ASSET", value: "TÃ i sáº£n cá»‘ Ä‘á»‹nh" },
} as const;

export const GOODS_RECEIPT_STATUS = {
  DRAFT: "DRAFT",
  POSTED: "POSTED",
} as const;
```

**Prisma Schema sáº½ dÃ¹ng Enum cho Status**:

```prisma
enum GoodsReceiptStatus {
  DRAFT
  POSTED
}

model GoodsReceipt {
  id     String              @id @default(uuid())
  status GoodsReceiptStatus  @default(DRAFT)
  // ...
}
```

### FR-2: Business Rules

1. **Unique Key per Type**: Trong cÃ¹ng má»™t `type`, `key` pháº£i duy nháº¥t
2. **Soft Delete**: KhÃ´ng xÃ³a cá»©ng, chá»‰ set `isActive = false`
3. **PhÃ¢n cáº¥p (Hierarchy)**:
   - `MATERIAL_CATEGORY` há»— trá»£ cáº¥u trÃºc cha-con (self-referencing)
   - Má»™t node cÃ³ thá»ƒ lÃ  cha cá»§a nhiá»u node khÃ¡c
   - Khi chá»n parent, chá»‰ hiá»ƒn thá»‹ cÃ¡c node cÃ¹ng type
4. **Validation**:
   - `key`: lowercase, khÃ´ng dáº¥u, cho phÃ©p dáº¥u gáº¡ch ngang `-` - **KHÃ”NG BAO GIá»œ Sá»¬A** sau khi táº¡o (dÃ¹ng lÃ m identifier trong code)
   - `value`: Báº¯t buá»™c, tá»‘i thiá»ƒu 2 kÃ½ tá»± - **CÃ“ THá»‚ Sá»¬A** báº¥t cá»© lÃºc nÃ o (chá»‰ lÃ  label hiá»ƒn thá»‹)
   - KhÃ´ng cho phÃ©p táº¡o vÃ²ng láº·p phÃ¢n cáº¥p (A â†’ B â†’ A)
5. **Immutability Rule**:
   - âš ï¸ **`key` lÃ  IMMUTABLE** - Má»™t khi Ä‘Ã£ táº¡o, khÃ´ng Ä‘Æ°á»£c phÃ©p sá»­a (vÃ¬ code logic cÃ³ thá»ƒ hardcode check key)
   - âœ… **`value` lÃ  MUTABLE** - Sá»­a thoáº£i mÃ¡i, chá»‰ áº£nh hÆ°á»Ÿng UI
   - ğŸ”„ Náº¿u cáº§n Ä‘á»•i `key`: Táº¡o record má»›i â†’ Migrate data â†’ Soft delete record cÅ©

### FR-3: API Endpoints

**Route Handlers** (GET only - cho client fetch):

```
GET    /api/v1/master-data?type=SUPPLIER_GROUP    # List by type
GET    /api/v1/master-data/:id                    # Get by ID (Ã­t dÃ¹ng)
GET    /api/v1/master-data/tree?type=MATERIAL_CATEGORY  # Get tree structure
```

**Server Actions** (Mutations):

```typescript
// src/server/actions/master-data.actions.ts
createMasterDataAction(data: CreateMasterDataRequest)
updateMasterDataAction(id: string, data: UpdateMasterDataRequest)
deleteMasterDataAction(id: string)  // Soft delete
```

**LÃ½ do**: Theo pattern cá»§a Clinic/DentalService - GET dÃ¹ng API route (cache Ä‘Æ°á»£c), POST/PUT/DELETE dÃ¹ng Server Actions (táº­n dá»¥ng server component).

## ğŸ’¾ Data Model (Prisma)

```prisma
// prisma/schema.prisma

// âš ï¸ KHÃ”NG dÃ¹ng enum cho MasterDataType - dÃ¹ng String Ä‘á»ƒ linh hoáº¡t
// Validation sáº½ Ä‘Æ°á»£c xá»­ lÃ½ á»Ÿ Zod schema (application layer)

// Enum cho Goods Receipt Status (riÃªng biá»‡t - khÃ´ng dÃ¹ng MasterData)
enum GoodsReceiptStatus {
  DRAFT
  POSTED
}

enum GoodsIssueStatus {
  DRAFT
  POSTED
}

model MasterData {
  id          String  @id @default(uuid())
  type        String  // Loáº¡i danh má»¥c (SUPPLIER_GROUP, DEPARTMENT, MATERIAL_CATEGORY...)
  key         String         // MÃ£ Ä‘á»‹nh danh (slug: 'implant', 'noi-nha')
  value       String         // TÃªn hiá»ƒn thá»‹ ('Implant', 'Ná»™i nha')
  description String?        // MÃ´ táº£ thÃªm
  isActive    Boolean        @default(true)

  // Tá»± tham chiáº¿u Ä‘á»ƒ xá»­ lÃ½ cáº¥p cha-con (NhÃ³m â†’ PhÃ¢n nhÃ³m)
  parentId    String?
  parent      MasterData?  @relation("MasterDataHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    MasterData[] @relation("MasterDataHierarchy")

  // Timestamps
  createdAt   DateTime       @default(now()) @db.Timestamptz
  updatedAt   DateTime       @updatedAt @db.Timestamptz

  // CÃ¡c quan há»‡ ngÆ°á»£c láº¡i vá»›i báº£ng chÃ­nh
  suppliers              Supplier[]   @relation("SupplierGroup")
  materialsAsDepartment  Material[]   @relation("MaterialDepartment")
  materialsAsCategory    Material[]   @relation("MaterialCategory")

  // Unique constraint: Trong cÃ¹ng type, key pháº£i unique
  @@unique([type, key], name: "unique_type_key")
  @@index([type, isActive])

  @@map("master_data")
}
```

**LÆ°u Ã½**:

- ID dÃ¹ng `uuid()` thay vÃ¬ `autoincrement()` (theo chuáº©n app)
- `archivedAt` khÃ´ng cáº§n (dÃ¹ng `isActive` Ä‘Æ¡n giáº£n hÆ¡n)
- Timestamp dÃ¹ng `@db.Timestamptz` (PostgreSQL timezone-aware)

## âœ… Validation (Zod Schema)

```typescript
// src/shared/validation/master-data.schema.ts
import { z } from "zod";
import { MASTER_DATA_TYPE_LIST } from "@/shared/constants/master-data";

/**
 * Base Schema - Shared fields
 */
export const MasterDataBaseSchema = z.object({
  type: z.enum(MASTER_DATA_TYPE_LIST as [string, ...string[]], {
    required_error: "Vui lÃ²ng chá»n loáº¡i danh má»¥c",
  }),

  key: z
    .string()
    .trim()
    .min(2, "MÃ£ pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±")
    .max(50, "MÃ£ khÃ´ng Ä‘Æ°á»£c quÃ¡ 50 kÃ½ tá»±")
    .regex(/^[a-z0-9-]+$/, "MÃ£ chá»‰ chá»©a chá»¯ thÆ°á»ng, sá»‘ vÃ  dáº¥u gáº¡ch ngang"),

  value: z
    .string()
    .trim()
    .min(2, "TÃªn hiá»ƒn thá»‹ pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±")
    .max(100, "TÃªn khÃ´ng Ä‘Æ°á»£c quÃ¡ 100 kÃ½ tá»±"),

  description: z.string().trim().max(500).optional().nullable(),

  parentId: z.string().uuid().optional().nullable(),

  isActive: z.boolean().default(true),
});

/**
 * Create Schema
 */
export const CreateMasterDataRequestSchema = MasterDataBaseSchema.omit({
  // KhÃ´ng cáº§n omit gÃ¬ - táº¥t cáº£ field Ä‘á»u cáº§n khi táº¡o má»›i
});

/**
 * Update Schema
 */
export const UpdateMasterDataRequestSchema = MasterDataBaseSchema.extend({
  id: z.string().uuid("ID khÃ´ng há»£p lá»‡"),
});

/**
 * Response Schema (Single)
 */
export const MasterDataResponseSchema = z.object({
  id: z.string().uuid(),
  type: z.string(),
  key: z.string(),
  value: z.string(),
  description: z.string().nullable().optional(),
  isActive: z.boolean(),
  parentId: z.string().uuid().nullable().optional(),
  createdAt: z.string().datetime(),
  updatedAt: z.string().datetime(),
});

/**
 * Response Schema (List)
 */
export const MasterDataListResponseSchema = z.array(MasterDataResponseSchema);

/**
 * Query Schema (for GET /api/v1/master-data)
 */
export const GetMasterDataQuerySchema = z.object({
  type: z.enum(MASTER_DATA_TYPE_LIST as [string, ...string[]]).optional(),
  includeInactive: z.union([z.literal("0"), z.literal("1")]).optional(),
});

/**
 * Types
 */
export type CreateMasterDataRequest = z.infer<
  typeof CreateMasterDataRequestSchema
>;
export type UpdateMasterDataRequest = z.infer<
  typeof UpdateMasterDataRequestSchema
>;
export type MasterDataResponse = z.infer<typeof MasterDataResponseSchema>;
```

## ğŸ§ª Test Cases

### TC-1: Táº¡o má»›i thÃ nh cÃ´ng

- **Input**: Valid data (type=UNIT, key=cai, value=CÃ¡i)
- **Expected**: Status 201, tráº£ vá» record Ä‘Ã£ táº¡o

### TC-2: Validate key trÃ¹ng trong cÃ¹ng type

- **Input**: type=UNIT, key=cai (Ä‘Ã£ tá»“n táº¡i)
- **Expected**: Status 400, message "MÃ£ nÃ y Ä‘Ã£ tá»“n táº¡i"

### TC-3: Táº¡o phÃ¢n cáº¥p

- **Input**: type=MATERIAL_CATEGORY, key=implant-1, parentId=<nhÃ³m implant>
- **Expected**: Status 201, record con Ä‘Æ°á»£c link vá»›i cha

### TC-4: NgÄƒn cháº·n circular reference

- **Input**: Update node A set parentId = B, trong khi B lÃ  con cá»§a A
- **Expected**: Status 400, message "KhÃ´ng thá»ƒ táº¡o vÃ²ng láº·p phÃ¢n cáº¥p"

### TC-5: Soft delete

- **Input**: DELETE /api/inventory/dictionary/123
- **Expected**: isActive = false, record váº«n tá»“n táº¡i trong DB

## ğŸ¯ Acceptance Criteria

- [ ] MÃ n hÃ¬nh hiá»ƒn thá»‹ danh sÃ¡ch Ä‘áº§y Ä‘á»§ cÃ¡c loáº¡i dictionary
- [ ] Lá»c theo type hoáº¡t Ä‘á»™ng chÃ­nh xÃ¡c
- [ ] Modal thÃªm/sá»­a validate Ä‘Ãºng táº¥t cáº£ trÆ°á»ng
- [ ] TreeSelect hiá»ƒn thá»‹ Ä‘Ãºng cáº¥u trÃºc phÃ¢n cáº¥p (cho MATERIAL_CATEGORY)
- [ ] API kiá»ƒm tra duplicate key trong cÃ¹ng type
- [ ] API ngÄƒn cháº·n circular reference
- [ ] Soft delete khÃ´ng lÃ m máº¥t dá»¯ liá»‡u liÃªn quan
- [ ] Chá»‰ hiá»ƒn thá»‹ item active trong cÃ¡c dropdown cá»§a module khÃ¡c

## ğŸ“¦ Dá»¯ Liá»‡u Máº«u (Seed Data)

```typescript
// NhÃ³m nhÃ  cung cáº¥p
{ type: 'SUPPLIER_GROUP', key: 'vt-yte', value: 'Váº­t tÆ° thiáº¿t bá»‹ y táº¿' }
{ type: 'SUPPLIER_GROUP', key: 'labo', value: 'Labo - XÆ°á»Ÿng rÄƒng giáº£' }
{ type: 'SUPPLIER_GROUP', key: 'van-phong', value: 'Váº­t tÆ° vÄƒn phÃ²ng' }

// Bá»™ mÃ´n
{ type: 'DEPARTMENT', key: 'noi-nha', value: 'Ná»™i nha' }
{ type: 'DEPARTMENT', key: 'phuc-hinh', value: 'Phá»¥c hÃ¬nh' }
{ type: 'DEPARTMENT', key: 'nha-chu', value: 'Nha chu' }
{ type: 'DEPARTMENT', key: 'nho-rang', value: 'Nhá»• rÄƒng' }
{ type: 'DEPARTMENT', key: 'implant', value: 'Implant' }
{ type: 'DEPARTMENT', key: 'chinh-nha', value: 'Chá»‰nh nha' }

// ÄÆ¡n vá»‹ tÃ­nh
{ type: 'UNIT', key: 'cai', value: 'CÃ¡i' }
{ type: 'UNIT', key: 'hop', value: 'Há»™p' }
{ type: 'UNIT', key: 'vi', value: 'Vá»‰' }
{ type: 'UNIT', key: 'chai', value: 'Chai' }
{ type: 'UNIT', key: 'kg', value: 'Kilogram' }
{ type: 'UNIT', key: 'lit', value: 'LÃ­t' }
{ type: 'UNIT', key: 'goi', value: 'GÃ³i' }

// NhÃ³m váº­t tÆ° (vÃ­ dá»¥ phÃ¢n cáº¥p cho Implant)
{ type: 'MATERIAL_CATEGORY', key: 'implant-group', value: 'NhÃ³m Implant', parentId: null }
{ type: 'MATERIAL_CATEGORY', key: 'implant-tru', value: 'Trá»¥ Implant', parentId: <implant-group-id> }
{ type: 'MATERIAL_CATEGORY', key: 'implant-abutment', value: 'Abutment', parentId: <implant-group-id> }
```

---

## ğŸ—ï¸ Kiáº¿n TrÃºc Code (Theo Pattern Clinic/DentalService)

### ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

```
src/features/master-data/                 # â­ SHARED cho toÃ n app
â”œâ”€â”€ index.ts                          # Barrel export
â”œâ”€â”€ constants.ts                      # Endpoints, query keys, messages
â”œâ”€â”€ api.ts                            # API client functions (GET only)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useMasterData.ts             # Query: List
â”‚   â”œâ”€â”€ useMasterDataById.ts         # Query: By ID
â”‚   â”œâ”€â”€ useCreateMasterData.ts       # Mutation: Create
â”‚   â”œâ”€â”€ useUpdateMasterData.ts       # Mutation: Update
â”‚   â””â”€â”€ useDeleteMasterData.ts       # Mutation: Delete (soft)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ MasterDataTable.tsx          # Antd Table
â”‚   â”œâ”€â”€ MasterDataFormModal.tsx      # Create/Edit Modal
â”‚   â”œâ”€â”€ MasterDataSelect.tsx         # Reusable Select component
â”‚   â””â”€â”€ MasterDataTreeSelect.tsx     # TreeSelect for hierarchical data
â””â”€â”€ views/
    â””â”€â”€ MasterDataPageView.tsx       # Main page view

src/server/
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ master-data.actions.ts       # Server Actions (SHARED)
â”œâ”€â”€ services/
â”‚   â””â”€â”€ master-data.service.ts       # Business logic (SHARED)
â””â”€â”€ repos/
    â””â”€â”€ master-data.repo.ts           # Prisma queries (SHARED)

src/app/api/v1/master-data/
â”œâ”€â”€ route.ts           # GET /api/v1/master-data
â””â”€â”€ [id]/
    â””â”€â”€ route.ts       # GET /api/v1/master-data/[id]

src/shared/
â”œâ”€â”€ validation/
â”‚   â””â”€â”€ master-data.schema.ts         # Zod schemas
â””â”€â”€ constants/
    â””â”€â”€ master-data.ts                # MASTER_DATA_TYPES, type helpers
```

### ğŸ“„ Code Examples

#### 1. Constants (`src/features/master-data/constants.ts`)

```typescript
import { MASTER_DATA_TYPES } from "@/shared/constants/master-data";

export const MASTER_DATA_ENDPOINTS = {
  ROOT: "/api/v1/master-data",
  BY_ID: (id: string) => `/api/v1/master-data/${id}`,
} as const;

export const MASTER_DATA_QUERY_KEYS = {
  list: (type?: string, includeInactive?: boolean) =>
    ["master-data", { type, includeInactive }] as const,
  byId: (id: string) => ["master-data", id] as const,
} as const;

export const MASTER_DATA_MESSAGES = {
  CREATE_SUCCESS: "Táº¡o dá»¯ liá»‡u chá»§ thÃ nh cÃ´ng.",
  UPDATE_SUCCESS: "Cáº­p nháº­t dá»¯ liá»‡u chá»§ thÃ nh cÃ´ng.",
  DELETE_SUCCESS: "XÃ³a dá»¯ liá»‡u chá»§ thÃ nh cÃ´ng.",
  UNKNOWN_ERROR: "ÄÃ£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i.",
} as const;

// Type options cho UI (dá»… thÃªm label tiáº¿ng Viá»‡t)
export const MASTER_DATA_TYPE_OPTIONS = [
  { value: MASTER_DATA_TYPES.SUPPLIER_GROUP, label: "NhÃ³m nhÃ  cung cáº¥p" },
  { value: MASTER_DATA_TYPES.DEPARTMENT, label: "Bá»™ mÃ´n" },
  { value: MASTER_DATA_TYPES.MATERIAL_CATEGORY, label: "NhÃ³m váº­t tÆ°" },
  { value: MASTER_DATA_TYPES.UNIT, label: "ÄÆ¡n vá»‹ tÃ­nh" },
  // ThÃªm type má»›i á»Ÿ Ä‘Ã¢y khi cáº§n, khÃ´ng cáº§n migration
] as const;
```

#### 2. API Client (`src/features/master-data/api.ts`)

```typescript
import {
  MasterDataListResponseSchema,
  MasterDataResponseSchema,
} from "@/shared/validation/master-data.schema";
import { COMMON_MESSAGES } from "@/shared/constants/messages";
import { MASTER_DATA_ENDPOINTS } from "./constants";

export async function getMasterDataApi(
  type?: string,
  includeInactive?: boolean
) {
  const params = new URLSearchParams();
  if (type) params.append("type", type);
  if (includeInactive) params.append("includeInactive", "1");

  const url = `${MASTER_DATA_ENDPOINTS.ROOT}?${params.toString()}`;
  const res = await fetch(url, { cache: "no-store" });
  const json = await res.json();

  if (!res.ok) throw new Error(json?.error || COMMON_MESSAGES.UNKNOWN_ERROR);

  const parsed = MasterDataListResponseSchema.safeParse(json);
  if (!parsed.success)
    throw new Error("Pháº£n há»“i danh sÃ¡ch dá»¯ liá»‡u chá»§ khÃ´ng há»£p lá»‡.");

  return parsed.data;
}

export async function getMasterDataByIdApi(id: string) {
  const res = await fetch(MASTER_DATA_ENDPOINTS.BY_ID(id), {
    cache: "no-store",
  });
  const json = await res.json();

  if (!res.ok) throw new Error(json?.error || COMMON_MESSAGES.UNKNOWN_ERROR);

  const parsed = MasterDataResponseSchema.safeParse(json);
  if (!parsed.success) throw new Error("Pháº£n há»“i dá»¯ liá»‡u chá»§ khÃ´ng há»£p lá»‡.");

  return parsed.data;
}
```

#### 3. React Query Hook (`src/features/master-data/hooks/useMasterData.ts`)

```typescript
"use client";

import { useQuery } from "@tanstack/react-query";
import { getMasterDataApi } from "../api";
import { MASTER_DATA_QUERY_KEYS } from "../constants";

export function useMasterData(type?: string, includeInactive?: boolean) {
  return useQuery({
    queryKey: MASTER_DATA_QUERY_KEYS.list(type, includeInactive),
    queryFn: () => getMasterDataApi(type, includeInactive),
    staleTime: 5 * 60 * 1000, // 5 phÃºt
    gcTime: 30 * 60 * 1000, // 30 phÃºt
  });
}
```

#### 4. Mutation Hook (`src/features/master-data/hooks/useCreateMasterData.ts`)

```typescript
"use client";

import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useNotify } from "@/shared/hooks/useNotify";
import { createMasterDataAction } from "@/server/actions/master-data.actions";
import { MASTER_DATA_MESSAGES } from "../constants";
import { COMMON_MESSAGES } from "@/shared/constants/messages";
import type { CreateMasterDataRequest } from "@/shared/validation/master-data.schema";

export function useCreateMasterData() {
  const qc = useQueryClient();
  const notify = useNotify();

  return useMutation({
    mutationFn: (data: CreateMasterDataRequest) => createMasterDataAction(data),
    onSuccess: () => {
      notify.success(MASTER_DATA_MESSAGES.CREATE_SUCCESS);
      qc.invalidateQueries({
        queryKey: ["master-data"],
      });
    },
    onError: (e: unknown) =>
      notify.error(e, { fallback: COMMON_MESSAGES.UNKNOWN_ERROR }),
  });
}
```

#### 5. Server Action (`src/server/actions/master-data.actions.ts`)

```typescript
"use server";

import { getSessionUser } from "@/server/utils/sessionCache";
import { masterDataService } from "@/server/services/master-data.service";
import type {
  CreateMasterDataRequest,
  UpdateMasterDataRequest,
} from "@/shared/validation/master-data.schema";

export async function createMasterDataAction(data: CreateMasterDataRequest) {
  const user = await getSessionUser();
  return await masterDataService.create(user, data);
}

export async function updateMasterDataAction(
  id: string,
  data: UpdateMasterDataRequest
) {
  const user = await getSessionUser();
  return await masterDataService.update(user, { ...data, id });
}

export async function deleteMasterDataAction(id: string) {
  const user = await getSessionUser();
  return await masterDataService.remove(user, id);
}
```

#### 6. Service Layer (`src/server/services/master-data.service.ts`)

```typescript
import { masterDataRepo } from "@/server/repos/master-data.repo";
import { ERR } from "./errors";
import { requireAdmin } from "./auth.service";
import {
  CreateMasterDataRequestSchema,
  UpdateMasterDataRequestSchema,
  type CreateMasterDataRequest,
} from "@/shared/validation/master-data.schema";
import type { UserCore } from "@/shared/types/user";
import { mapMasterDataToResponse } from "./mappers";

function normalizeKey(key: string) {
  return key.trim().toLowerCase();
}

export const masterDataService = {
  async list(
    currentUser: UserCore | null,
    type?: string,
    includeInactive?: boolean
  ) {
    const rows = await masterDataRepo.list(type, includeInactive);
    return rows.map(mapMasterDataToResponse);
  },

  async getById(currentUser: UserCore | null, id: string) {
    const row = await masterDataRepo.getById(id);
    if (!row) throw ERR.NOT_FOUND("Dá»¯ liá»‡u chá»§ khÃ´ng tá»“n táº¡i.");
    return mapMasterDataToResponse(row);
  },

  async create(currentUser: UserCore | null, body: unknown) {
    requireAdmin(currentUser);

    const parsed = CreateMasterDataRequestSchema.safeParse(body);
    if (!parsed.success) {
      throw ERR.INVALID(
        parsed.error.issues[0]?.message ?? "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡."
      );
    }

    const data: CreateMasterDataRequest = {
      ...parsed.data,
      key: normalizeKey(parsed.data.key),
    };

    // Check unique key per type
    const existing = await masterDataRepo.getByTypeAndKey(data.type, data.key);
    if (existing) throw ERR.CONFLICT("MÃ£ nÃ y Ä‘Ã£ tá»“n táº¡i trong loáº¡i danh má»¥c.");

    // Validate parentId if provided
    if (data.parentId) {
      const parent = await masterDataRepo.getById(data.parentId);
      if (!parent) throw ERR.INVALID("Parent khÃ´ng tá»“n táº¡i.");
      if (parent.type !== data.type)
        throw ERR.INVALID("Parent pháº£i cÃ¹ng type.");
    }

    const created = await masterDataRepo.create(data);
    return mapMasterDataToResponse(created);
  },

  async update(currentUser: UserCore | null, body: unknown) {
    requireAdmin(currentUser);

    const parsed = UpdateMasterDataRequestSchema.safeParse(body);
    if (!parsed.success) {
      throw ERR.INVALID(
        parsed.error.issues[0]?.message ?? "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡."
      );
    }

    const { id } = parsed.data;
    const existing = await masterDataRepo.getById(id);
    if (!existing) throw ERR.NOT_FOUND("Dá»¯ liá»‡u chá»§ khÃ´ng tá»“n táº¡i.");

    const data = {
      ...parsed.data,
      key: normalizeKey(parsed.data.key),
    };

    // Check unique key per type (exclude self)
    if (data.key !== existing.key || data.type !== existing.type) {
      const dup = await masterDataRepo.getByTypeAndKey(data.type, data.key);
      if (dup && dup.id !== id)
        throw ERR.CONFLICT("MÃ£ nÃ y Ä‘Ã£ tá»“n táº¡i trong loáº¡i danh má»¥c.");
    }

    // Validate circular reference
    if (data.parentId) {
      if (data.parentId === id) throw ERR.INVALID("KhÃ´ng thá»ƒ tá»± tham chiáº¿u.");

      const hasCircular = await masterDataRepo.checkCircularReference(
        id,
        data.parentId
      );
      if (hasCircular) throw ERR.INVALID("KhÃ´ng thá»ƒ táº¡o vÃ²ng láº·p phÃ¢n cáº¥p.");
    }

    const updated = await masterDataRepo.update(id, data);
    return mapMasterDataToResponse(updated);
  },

  async remove(currentUser: UserCore | null, id: string) {
    requireAdmin(currentUser);

    const existing = await masterDataRepo.getById(id);
    if (!existing) throw ERR.NOT_FOUND("Dá»¯ liá»‡u chá»§ khÃ´ng tá»“n táº¡i.");

    // Check if has children
    const children = await masterDataRepo.getChildren(id);
    if (children.length > 0)
      throw ERR.CONFLICT("KhÃ´ng thá»ƒ xÃ³a má»¥c cÃ³ má»¥c con.");

    // Soft delete (set isActive = false)
    const updated = await masterDataRepo.softDelete(id);
    return mapMasterDataToResponse(updated);
  },
};
```

#### 7. Repository Layer (`src/server/repos/master-data.repo.ts`)

```typescript
import { prisma } from "@/services/prisma/prisma";
import type {
  CreateMasterDataRequest,
  UpdateMasterDataRequest,
} from "@/shared/validation/master-data.schema";

export const masterDataRepo = {
  async list(type?: string, includeInactive?: boolean) {
    return prisma.masterData.findMany({
      where: {
        ...(type && { type: type as any }),
        ...(includeInactive ? {} : { isActive: true }),
      },
      orderBy: { createdAt: "desc" },
    });
  },

  async getById(id: string) {
    return prisma.masterData.findUnique({ where: { id } });
  },

  async getByTypeAndKey(type: string, key: string) {
    return prisma.masterData.findUnique({
      where: { unique_type_key: { type: type as any, key } },
    });
  },

  async getChildren(parentId: string) {
    return prisma.masterData.findMany({
      where: { parentId },
    });
  },

  async create(data: CreateMasterDataRequest) {
    return prisma.masterData.create({ data });
  },

  async update(id: string, data: Partial<Omit<UpdateMasterDataRequest, "id">>) {
    return prisma.masterData.update({ where: { id }, data });
  },

  async softDelete(id: string) {
    return prisma.masterData.update({
      where: { id },
      data: { isActive: false },
    });
  },

  // Check circular reference: A -> B -> ... -> A
  async checkCircularReference(
    childId: string,
    proposedParentId: string
  ): Promise<boolean> {
    let current = proposedParentId;
    const visited = new Set<string>();

    while (current) {
      if (current === childId) return true; // Found cycle
      if (visited.has(current)) return false; // Safety: Infinite loop

      visited.add(current);
      const parent = await this.getById(current);
      if (!parent || !parent.parentId) break;
      current = parent.parentId;
    }

    return false;
  },
};
```

#### 8. Mapper (`src/server/services/mappers.ts` hoáº·c `master-data.service.ts`)

```typescript
import type { MasterData } from "@prisma/client";
import type { MasterDataResponse } from "@/shared/validation/master-data.schema";

export function mapMasterDataToResponse(data: MasterData): MasterDataResponse {
  return {
    id: data.id,
    type: data.type,
    key: data.key,
    value: data.value,
    description: data.description,
    isActive: data.isActive,
    parentId: data.parentId,
    createdAt: data.createdAt.toISOString(),
    updatedAt: data.updatedAt.toISOString(),
  };
}
```

#### 9. API Route Handler (`src/app/api/v1/master-data/route.ts`)

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getSessionUser } from "@/server/utils/sessionCache";
import { masterDataService } from "@/server/services/master-data.service";
import { handleApiError } from "@/server/utils/errorHandler";

/**
 * GET /api/v1/master-data
 * Query params: ?type=SUPPLIER_GROUP&includeInactive=1
 */
export async function GET(req: NextRequest) {
  try {
    const user = await getSessionUser();
    const { searchParams } = new URL(req.url);

    const type = searchParams.get("type") || undefined;
    const includeInactive = searchParams.get("includeInactive") === "1";

    const data = await masterDataService.list(user, type, includeInactive);

    return NextResponse.json(data);
  } catch (error) {
    return handleApiError(error);
  }
}
```

#### 10. Page View (`src/features/master-data/views/MasterDataPageView.tsx`)

```typescript
"use client";

import React, { useMemo, useState, useCallback } from "react";
import { Typography, Space, Button, Select } from "antd";
import { PlusOutlined } from "@ant-design/icons";
import { useMasterData } from "../hooks/useMasterData";
import { useCreateMasterData } from "../hooks/useCreateMasterData";
import { useUpdateMasterData } from "../hooks/useUpdateMasterData";
import { useDeleteMasterData } from "../hooks/useDeleteMasterData";
import { MASTER_DATA_TYPE_OPTIONS } from "../constants";
import MasterDataTable from "../components/MasterDataTable";
import MasterDataFormModal from "../components/MasterDataFormModal";
import type {
  MasterDataResponse,
  CreateMasterDataRequest,
  UpdateMasterDataRequest,
} from "@/shared/validation/master-data.schema";

const { Title } = Typography;

type Props = { isAdmin?: boolean };

export default function MasterDataPageView({ isAdmin }: Props) {
  const [selectedType, setSelectedType] = useState<string | undefined>(
    undefined
  );
  const { data, isLoading } = useMasterData(selectedType);

  const [modalOpen, setModalOpen] = useState(false);
  const [mode, setMode] = useState<"create" | "edit">("create");
  const [editing, setEditing] = useState<MasterDataResponse | null>(null);

  const create = useCreateMasterData();
  const update = useUpdateMasterData(editing?.id || "");
  const del = useDeleteMasterData();

  const list = useMemo(() => data ?? [], [data]);

  const closeModal = useCallback(() => setModalOpen(false), []);

  const openCreate = useCallback(() => {
    setMode("create");
    setEditing(null);
    setModalOpen(true);
  }, []);

  const openEdit = useCallback((row: MasterDataResponse) => {
    setMode("edit");
    setEditing(row);
    setModalOpen(true);
  }, []);

  const handleSubmit = useCallback(
    async (payload: CreateMasterDataRequest | UpdateMasterDataRequest) => {
      try {
        if (mode === "create") {
          await create.mutateAsync(payload as CreateMasterDataRequest);
        } else if (mode === "edit" && editing) {
          await update.mutateAsync(payload as UpdateMasterDataRequest);
        }
        closeModal();
      } catch {
        // Error already handled in hook
      }
    },
    [mode, create, update, editing, closeModal]
  );

  const handleDelete = useCallback(
    (row: MasterDataResponse) => {
      del.mutate(row.id);
    },
    [del]
  );

  return (
    <div>
      <Space
        style={{
          width: "100%",
          justifyContent: "space-between",
          marginBottom: 16,
        }}
      >
        <Title level={3}>ğŸ“‹ Dá»¯ Liá»‡u Há»‡ Thá»‘ng (Master Data)</Title>
        {isAdmin && (
          <Button type="primary" icon={<PlusOutlined />} onClick={openCreate}>
            ThÃªm Má»›i
          </Button>
        )}
      </Space>

      <Space style={{ marginBottom: 16 }}>
        <Select
          placeholder="Lá»c theo loáº¡i"
          style={{ width: 200 }}
          allowClear
          value={selectedType}
          onChange={setSelectedType}
          options={MASTER_DATA_TYPE_OPTIONS}
        />
      </Space>

      <MasterDataTable
        data={list}
        loading={isLoading}
        onEdit={openEdit}
        onDelete={handleDelete}
      />

      <MasterDataFormModal
        open={modalOpen}
        mode={mode}
        initial={editing}
        confirmLoading={create.isPending || update.isPending}
        onCancel={closeModal}
        onSubmit={handleSubmit}
      />
    </div>
  );
}
```

### ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

```
src/features/master-data/              # â­ SHARED cho toÃ n app
â”œâ”€â”€ index.ts                          # Barrel export
â”œâ”€â”€ constants.ts                      # Endpoints, query keys, messages
â”œâ”€â”€ api.ts                            # API client functions (GET only)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useMasterData.ts             # Query: List
â”‚   â”œâ”€â”€ useMasterDataById.ts         # Query: By ID
â”‚   â”œâ”€â”€ useCreateMasterData.ts       # Mutation: Create
â”‚   â”œâ”€â”€ useUpdateMasterData.ts       # Mutation: Update
â”‚   â””â”€â”€ useDeleteMasterData.ts       # Mutation: Delete (soft)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ MasterDataTable.tsx          # Antd Table
â”‚   â”œâ”€â”€ MasterDataFormModal.tsx      # Create/Edit Modal
â”‚   â”œâ”€â”€ MasterDataSelect.tsx         # Reusable Select component
â”‚   â””â”€â”€ MasterDataTreeSelect.tsx     # TreeSelect for hierarchical data
â””â”€â”€ views/
    â””â”€â”€ MasterDataPageView.tsx       # Main page view

src/server/
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ master-data.actions.ts       # Server Actions (SHARED)
â”œâ”€â”€ services/
â”‚   â””â”€â”€ master-data.service.ts       # Business logic (SHARED)
â””â”€â”€ repos/
    â””â”€â”€ master-data.repo.ts           # Prisma queries (SHARED)

src/app/api/v1/master-data/
â”œâ”€â”€ route.ts           # GET /api/v1/master-data
â””â”€â”€ [id]/
    â””â”€â”€ route.ts       # GET /api/v1/master-data/[id]

src/shared/
â”œâ”€â”€ validation/
â”‚   â””â”€â”€ master-data.schema.ts         # Zod schemas
â””â”€â”€ constants/
    â””â”€â”€ inventory.ts                  # MATERIAL_TYPES, UOM_OPTIONS, etc.
```

---

**Priority**: ğŸ”´ Critical (Pháº£i lÃ m Ä‘áº§u tiÃªn)  
**Estimated Effort**: 3-4 ngÃ y  
**Dependencies**: None (TÃ­nh nÄƒng ná»n táº£ng)

---

## ğŸš€ Performance Optimization

### 1. React Query Caching Strategy

```typescript
// src/features/master-data/hooks/useMasterData.ts
export function useMasterData(type?: string, includeInactive?: boolean) {
  return useQuery({
    queryKey: MASTER_DATA_QUERY_KEYS.list(type, includeInactive),
    queryFn: () => getMasterDataApi(type, includeInactive),
    staleTime: Infinity, // Cache vÄ©nh viá»…n - chá»‰ reload khi F5 hoáº·c invalidate thá»§ cÃ´ng
    gcTime: Infinity, // Giá»¯ trong memory vÄ©nh viá»…n
    refetchOnWindowFocus: false, // KhÃ´ng refetch khi focus láº¡i window
    refetchOnMount: false, // KhÃ´ng refetch khi component mount láº¡i
    refetchOnReconnect: false, // KhÃ´ng refetch khi reconnect internet
  });
}
```

### 2. Preload MasterData khi App khá»Ÿi Ä‘á»™ng

```typescript
// src/app/providers.tsx hoáº·c layout
export function usePreloadMasterData() {
  const queryClient = useQueryClient();

  useEffect(() => {
    // Prefetch táº¥t cáº£ master data types
    const types = ["SUPPLIER_GROUP", "DEPARTMENT", "MATERIAL_CATEGORY", "UNIT"];
    types.forEach((type) => {
      queryClient.prefetchQuery({
        queryKey: ["master-data", { type, includeInactive: false }],
        queryFn: () => getMasterDataApi(type, false),
      });
    });
  }, [queryClient]);
}
```

### 3. Reusable Select Component

```typescript
// src/features/master-data/components/MasterDataSelect.tsx
"use client";

import { Select } from "antd";
import { useMasterData } from "../hooks/useMasterData";
import type { MasterDataType } from "@/shared/constants/master-data";

type Props = {
  type: MasterDataType;
  value?: string;
  onChange?: (value: string) => void;
  placeholder?: string;
  allowClear?: boolean;
};

/**
 * Reusable Select component for MasterData
 * Usage:
 * <MasterDataSelect
 *   type="DEPARTMENT"
 *   value={value}
 *   onChange={setValue}
 * />
 */
export default function MasterDataSelect({
  type,
  value,
  onChange,
  placeholder,
  allowClear = true,
}: Props) {
  const { data, isLoading } = useMasterData(type);

  const options =
    data?.map((item) => ({
      label: item.value,
      value: item.id,
    })) ?? [];

  return (
    <Select
      showSearch
      placeholder={placeholder || "Chá»n..."}
      value={value}
      onChange={onChange}
      loading={isLoading}
      options={options}
      allowClear={allowClear}
      filterOption={(input, option) =>
        (option?.label ?? "").toLowerCase().includes(input.toLowerCase())
      }
    />
  );
}
```

### 4. TreeSelect cho MATERIAL_CATEGORY

```typescript
// src/features/master-data/components/MasterDataTreeSelect.tsx
"use client";

import { TreeSelect } from "antd";
import { useMasterData } from "../hooks/useMasterData";
import type { MasterDataResponse } from "@/shared/validation/master-data.schema";

type TreeNode = {
  title: string;
  value: string;
  key: string;
  children?: TreeNode[];
};

function buildTree(items: MasterDataResponse[]): TreeNode[] {
  const map = new Map<string, TreeNode>();
  const roots: TreeNode[] = [];

  // Build nodes
  items.forEach((item) => {
    map.set(item.id, {
      title: item.value,
      value: item.id,
      key: item.id,
      children: [],
    });
  });

  // Build hierarchy
  items.forEach((item) => {
    const node = map.get(item.id)!;
    if (item.parentId) {
      const parent = map.get(item.parentId);
      if (parent) {
        parent.children!.push(node);
      } else {
        roots.push(node); // Fallback if parent not found
      }
    } else {
      roots.push(node);
    }
  });

  return roots;
}

export default function MasterDataTreeSelect({
  value,
  onChange,
}: {
  value?: string;
  onChange?: (value: string) => void;
}) {
  const { data, isLoading } = useMasterData("MATERIAL_CATEGORY");
  const treeData = buildTree(data ?? []);

  return (
    <TreeSelect
      showSearch
      placeholder="Chá»n nhÃ³m váº­t tÆ°"
      value={value}
      onChange={onChange}
      loading={isLoading}
      treeData={treeData}
      treeDefaultExpandAll
      allowClear
      filterTreeNode={(input, node) =>
        (node.title as string).toLowerCase().includes(input.toLowerCase())
      }
    />
  );
}
```

## ğŸ“ Usage Examples (Sá»­ dá»¥ng trong features khÃ¡c)

### Trong Supplier Form:

```tsx
import { MasterDataSelect } from "@/features/master-data";

function SupplierFormModal() {
  const [groupId, setGroupId] = useState<string>();

  return (
    <Form.Item label="NhÃ³m nhÃ  cung cáº¥p">
      <MasterDataSelect
        type="SUPPLIER_GROUP"
        value={groupId}
        onChange={setGroupId}
        placeholder="Chá»n nhÃ³m nhÃ  cung cáº¥p"
      />
    </Form.Item>
  );
}
```

### Trong Material Form:

```tsx
import { MasterDataSelect, MasterDataTreeSelect } from "@/features/master-data";

function MaterialFormModal() {
  const [departmentId, setDepartmentId] = useState<string>();
  const [categoryId, setCategoryId] = useState<string>();

  return (
    <>
      <Form.Item label="Bá»™ mÃ´n">
        <MasterDataSelect
          type="DEPARTMENT"
          value={departmentId}
          onChange={setDepartmentId}
        />
      </Form.Item>

      <Form.Item label="NhÃ³m váº­t tÆ°">
        <MasterDataTreeSelect value={categoryId} onChange={setCategoryId} />
      </Form.Item>
    </>
  );
}
```

---

## âš¡ Benchmark & Performance Metrics

**Má»¥c tiÃªu**:

- âœ… Query 100 records: < 10ms (vá»›i index)
- âœ… Vá»›i React Query cache: 0ms (instant)
- âœ… Page load vá»›i 3 dictionary types: < 200ms
- âœ… TreeSelect vá»›i 50 nodes: Smooth rendering

**Database Index** (Ä‘Ã£ cÃ³ trong Prisma schema):

```prisma
@@index([type, isActive])  // Fast filter by type + active
@@unique([type, key])      // Fast unique check
```
