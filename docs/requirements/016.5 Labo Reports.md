# 016.5 Labo Reports - BÃ¡o CÃ¡o & PhÃ¢n TÃ­ch

## ğŸ“‹ Tá»•ng Quan

**Feature**: BÃ¡o cÃ¡o vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u Labo - Multi-dimension vá»›i drill-down

**Má»¥c Ä‘Ã­ch**:

- PhÃ¢n tÃ­ch chi phÃ­ labo theo nhiá»u chiá»u
- Tracking hiá»‡u suáº¥t xÆ°á»Ÿng
- ÄÃ¡nh giÃ¡ bÃ¡c sÄ© theo volume
- Há»— trá»£ quyáº¿t Ä‘á»‹nh kinh doanh

**Route**: `/reports/labo`

**Status**: ğŸ—’ï¸ **PLANNING** - Phase 2

---

## ğŸ¯ User Stories

### US-1: Xem bÃ¡o cÃ¡o tá»•ng quan

**LÃ ** Admin  
**TÃ´i muá»‘n** xem bÃ¡o cÃ¡o tá»•ng quan chi phÃ­ labo  
**Äá»ƒ** náº¯m tÃ¬nh hÃ¬nh kinh doanh

**Acceptance Criteria**:

- [ ] Month Picker: Chá»n thÃ¡ng cáº§n xem bÃ¡o cÃ¡o (format MM/YYYY)
- [ ] Clinic Selector: Admin chá»n chi nhÃ¡nh cá»¥ thá»ƒ hoáº·c "Táº¥t cáº£ chi nhÃ¡nh" (Employee khÃ´ng hiá»ƒn thá»‹)
- [ ] Auto-label: Hiá»ƒn thá»‹ "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", hoáº·c "ThÃ¡ng MM/YYYY"
- [ ] Hiá»ƒn thá»‹ 3 KPI cards vá»›i growth % so vá»›i thÃ¡ng trÆ°á»›c
- [ ] Hiá»ƒn thá»‹ table vá»›i 4 dimension tabs (Theo xÆ°á»Ÿng, Theo bÃ¡c sÄ©, Theo dá»‹ch vá»¥, Theo ngÃ y nháº­n máº«u)
- [ ] Export Excel button
- [ ] Drill-down detail panel khi click row

### US-2: PhÃ¢n tÃ­ch theo xÆ°á»Ÿng

**LÃ ** Admin  
**TÃ´i muá»‘n** so sÃ¡nh chi phÃ­ giá»¯a cÃ¡c xÆ°á»Ÿng  
**Äá»ƒ** Ä‘Ã¡nh giÃ¡ vÃ  tá»‘i Æ°u chi phÃ­

**Acceptance Criteria**:

- [ ] Group by xÆ°á»Ÿng
- [ ] Metrics: Sá»‘ lÆ°á»£ng Ä‘Æ¡n, Tá»•ng chi phÃ­, Chi phÃ­ TB
- [ ] Sort theo chi phÃ­
- [ ] Click row Ä‘á»ƒ expand detail panel bÃªn dÆ°á»›i

### US-3: PhÃ¢n tÃ­ch theo bÃ¡c sÄ©

**LÃ ** Admin  
**TÃ´i muá»‘n** xem volume cÃ´ng viá»‡c cá»§a tá»«ng bÃ¡c sÄ©  
**Äá»ƒ** Ä‘Ã¡nh giÃ¡ hiá»‡u suáº¥t

**Acceptance Criteria**:

- [ ] Group by bÃ¡c sÄ©
- [ ] Metrics: Sá»‘ Ä‘Æ¡n, Chi phÃ­ phÃ¡t sinh
- [ ] Sort theo volume
- [ ] Click row Ä‘á»ƒ expand detail panel

### US-4: PhÃ¢n tÃ­ch theo dá»‹ch vá»¥

**LÃ ** Admin  
**TÃ´i muá»‘n** xem dá»‹ch vá»¥ nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t  
**Äá»ƒ** planning vÃ  marketing

**Acceptance Criteria**:

- [ ] Group by nhÃ³m dá»‹ch vá»¥ hoáº·c LaboItem
- [ ] Metrics: Sá»‘ lÆ°á»£ng, Tá»•ng giÃ¡ trá»‹
- [ ] Chart: Pie chart hoáº·c bar chart
- [ ] Click row Ä‘á»ƒ expand detail panel

### US-5: Export Excel

**LÃ ** Admin  
**TÃ´i muá»‘n** export bÃ¡o cÃ¡o ra Excel  
**Äá»ƒ** phÃ¢n tÃ­ch thÃªm hoáº·c bÃ¡o cÃ¡o cáº¥p trÃªn

**Acceptance Criteria**:

- [ ] Button "Xuáº¥t Excel"
- [ ] File gá»“m: Summary sheet + Detail sheet
- [ ] Format: NgÃ y VN, sá»‘ tiá»n VND
- [ ] File name: `Bao-cao-Labo-{date}.xlsx`

---

## ğŸ¨ UI Design

### Report Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š BÃ¡o cÃ¡o Labo - ThÃ¡ng nÃ y                          [ğŸ—“ï¸ 11/2025] [ğŸ¥ Chi nhÃ¡nh A â–¼] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ Tá»•ng Ä‘Æ¡n  â”‚  â”‚ ğŸ’° Tá»•ng chi  â”‚  â”‚ ğŸ“Š Chi phÃ­ TBâ”‚
â”‚   125        â”‚  â”‚ 95.5M â‚«      â”‚  â”‚  764k â‚«      â”‚
â”‚              â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ ğŸŸ¢ â†‘ +12.5%  â”‚  â”‚ ğŸŸ¢ â†‘ +15.3%  â”‚  â”‚ ğŸŸ¢ â†‘ +8.2%   â”‚
â”‚ vs T.trÆ°á»›c   â”‚  â”‚ vs T.trÆ°á»›c   â”‚  â”‚ vs T.trÆ°á»›c   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Tá»•ng há»£p                                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ [Theo xÆ°á»Ÿng] [Theo bÃ¡c sÄ©] [Theo dá»‹ch vá»¥] [Theo ngÃ y nháº­n máº«u]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tab: Theo xÆ°á»Ÿng                                                                        â”‚
â”‚                                                                                        â”‚
â”‚ Ranking â”‚ XÆ°á»Ÿng         â”‚ Sá»‘ Ä‘Æ¡n â”‚ Tá»•ng chi phÃ­ â”‚ Chi phÃ­ TB â”‚ % Tá»•ng â”‚               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥‡ #1   â”‚ Tung Dentalab â”‚   38   â”‚  41,800,000  â”‚ 1,100,000  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 43.8% â”‚           â”‚
â”‚  43.8%  â”‚               â”‚        â”‚              â”‚            â”‚            â”‚           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥ˆ #2   â”‚ Anh Nam Labo  â”‚   45   â”‚  35,500,000  â”‚   789,000  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 37.2% â”‚           â”‚
â”‚  37.2%  â”‚               â”‚        â”‚              â”‚            â”‚            â”‚           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥‰ #3   â”‚ Giang Lab     â”‚   42   â”‚  18,200,000  â”‚   433,000  â”‚ â–ˆâ–ˆ 19.0%   â”‚           â”‚
â”‚  19.0%  â”‚               â”‚        â”‚              â”‚            â”‚            â”‚           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  #4     â”‚ Lab Viá»‡t      â”‚   15   â”‚   8,500,000  â”‚   567,000  â”‚ â–ˆ 8.9%     â”‚           â”‚
â”‚   8.9%  â”‚               â”‚        â”‚              â”‚            â”‚            â”‚           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Tá»”NG    â”‚               â”‚  125   â”‚  95,500,000  â”‚   764,000  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 100%  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dimension: Theo XÆ°á»Ÿng

| Ranking | XÆ°á»Ÿng         | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ | Chi phÃ­ TB | % Tá»•ng |
| ------- | ------------- | ------ | ------------ | ---------- | ------ |
| ğŸ¥‡ #1   | Tung Dentalab | 38     | 41.8M â‚«      | 1.1M â‚«     | 43.8%  |
| ğŸ¥ˆ #2   | Anh Nam Labo  | 45     | 35.5M â‚«      | 789k â‚«     | 37.2%  |
| ğŸ¥‰ #3   | Giang Lab     | 42     | 18.2M â‚«      | 433k â‚«     | 19.0%  |

### Dimension: Theo BÃ¡c sÄ©

| Ranking | BÃ¡c sÄ©         | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ | % Tá»•ng |
| ------- | -------------- | ------ | ------------ | ------ |
| ğŸ¥‡ #1   | Dr. Nguyá»…n VÄƒn | 52     | 42.3M â‚«      | 44.3%  |
| ğŸ¥ˆ #2   | Dr. Tráº§n Thá»‹   | 38     | 28.7M â‚«      | 30.0%  |
| ğŸ¥‰ #3   | Dr. LÃª Minh    | 35     | 24.5M â‚«      | 25.7%  |

### Dimension: Theo NhÃ³m Dá»‹ch Vá»¥

| NhÃ³m dá»‹ch vá»¥       | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ |
| ------------------ | ------ | ------------ |
| RÄƒng toÃ n sá»©       | 68     | 58.2M â‚«      |
| RÄƒng sá»© kim loáº¡i   | 42     | 26.8M â‚«      |
| Chá»‰nh nha          | 10     | 7.2M â‚«       |
| Phá»¥c hÃ¬nh thÃ¡o láº¯p | 5      | 3.3M â‚«       |

### Drill-down Detail Panel

Khi click vÃ o row, hiá»ƒn thá»‹ detail panel bÃªn dÆ°á»›i (expand/collapse):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chi Tiáº¿t ÄÆ¡n HÃ ng: Anh Nam Labo (45 Ä‘Æ¡n)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KhÃ¡ch hÃ ng   â”‚ BÃ¡c sÄ© â”‚ Dá»‹ch vá»¥        â”‚ Loáº¡i ÄH â”‚ SL â”‚ GiÃ¡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nguyá»…n Thá»‹ A â”‚ Dr. N  â”‚ RÄƒng sá»© Katana â”‚ LÃ m má»›i â”‚ 2  â”‚ 1.4M â‚«    â”‚
â”‚ Tráº§n VÄƒn B   â”‚ Dr. T  â”‚ RÄƒng sá»© Zr     â”‚ Báº£o hÃ nh â”‚ 4  â”‚ 2.8M â‚«    â”‚
â”‚ ...          â”‚        â”‚                â”‚          â”‚    â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Data Structure

### Report Query

```typescript
LaboReportQuery {
  month: string              // YYYY-MM format (e.g., "2025-11")
  clinicId?: string          // Optional: Admin cÃ³ thá»ƒ chá»n clinic hoáº·c "all"
  dimension: 'supplier' | 'doctor' | 'service' | 'date'
}
```

### Report Response

```typescript
LaboReportResponse {
  summary: {
    totalOrders: number
    totalCost: number
    avgCost: number

    // Growth vs previous month
    totalOrdersGrowth: number    // % change
    totalCostGrowth: number       // % change
    avgCostGrowth: number         // % change
  }

  items: LaboReportItem[]
}

LaboReportItem {
  key: string              // supplierId | doctorId | serviceGroup | date
  label: string            // Supplier name | Doctor name | Service group label | Date
  orderCount: number
  totalCost: number
  avgCost?: number
  percentage: number       // % of total cost
  rank?: number            // Ranking position (1, 2, 3, ...) - Only for supplier/doctor/service dimensions

  // Drill-down data (optional, load on demand)
  orders?: LaboOrderSummary[]
}

LaboOrderSummary {
  id: string
  customerName: string
  doctorName: string
  laboItemName: string
  treatmentDate: string      // Date YYYY-MM-DD (NEW)
  orderType: string          // "LÃ m má»›i" | "Báº£o hÃ nh" (NEW)
  quantity: number
  totalCost: number
  sendDate: string
  returnDate: string | null
}
```

---

## ğŸ”„ API Specification

### GET `/api/v1/reports/labo`

**Query**: `LaboReportQuery`

**Response**: `LaboReportResponse`

**Note**: Backend aggregate query vá»›i Prisma

### GET `/api/v1/reports/labo/export`

**Query**: Same as above

**Response**: Excel file (binary)

**Headers**:

```
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="Bao-cao-Labo-2025-11.xlsx"
```

---

## ğŸ“Š Business Logic

### Data Source

- **Báº£ng**: `LaboOrder`
- **Filter field**: `sentDate` (ngÃ y gá»­i Ä‘Æ¡n)
- **Relations**: `supplier`, `laboItem`, `laboService`, `sentBy`, `customer`, `appointment â†’ clinic`

### Query & Aggregation

1. **Base Filter:**

   - `sentDate` trong thÃ¡ng (YYYY-MM-01 00:00 â†’ YYYY-MM-31 23:59)
   - Admin: `clinicId` optional | Employee: Force `clinicId = user.clinicId`

2. **KPI Metrics:**

   - Total orders = COUNT(\*)
   - Total cost = SUM(totalCost)
   - Average cost = Total cost / Total orders
   - MoM Growth = ((Current - Previous) / Previous) Ã— 100%

3. **Aggregate by Dimensions:**

   - **Theo ngÃ y nháº­n máº«u**: GROUP BY `returnDate`, sort ASC, no rank
   - **Theo xÆ°á»Ÿng**: GROUP BY `supplierId`, sort DESC, assign rank (1, 2, 3...)
   - **Theo bÃ¡c sÄ©**: GROUP BY `sentById`, sort DESC, assign rank
   - **Theo dá»‹ch vá»¥**: GROUP BY `laboServiceId`, sort DESC, assign rank
   - Percentage = (Dimension total / Grand total) Ã— 100%

4. **Detail Query:**
   - Base filter + dimension filter (date/supplier/doctor/service)
   - Pagination: 20 rows/page

### Backend Pattern (3-Layer)

**Repository** (`labo-report.repo.ts`):

- Public: `getKpiData`, `getDailyData` (by returnDate), `getSupplierData`, `getDoctorData`, `getServiceData`, `getDetailRecords`
- Private: Helpers for query, aggregate, sort, rank
- Sort & rank táº¡i repo layer

**Service** (`labo-report.service.ts`):

- Validate (Zod), auth check, parallel queries (`Promise.all`), mappers
- No sort, no rank

**Mappers** (`_mappers.ts`):

- 6 functions: Transform only, no logic
- Comments tiáº¿ng Viá»‡t

### Performance

- **Index**: `sentDate`, `clinicId`, `supplierId`, `sentById`, `laboServiceId`
- **Cache**: Summary (2min current / 2h past), Detail (lazy load), gcTime 5h
- **Parallel**: Service gá»i 5 repo methods cÃ¹ng lÃºc

---

## ğŸ”„ Data Flow

### API Endpoints

#### GET `/api/v1/reports/labo/summary`

**Query**: `{ month, clinicId? }`

**Response**:

```typescript
{
  kpi: LaboKpiData,
  summaryTabs: {
    byDate: DailyLaboData[],
    bySupplier: SupplierLaboData[],
    byDoctor: DoctorLaboData[],
    byService: ServiceLaboData[],
  }
}
```

#### GET `/api/v1/reports/labo/detail`

**Query**: `{ month, clinicId?, tab, key }`

**Response**:

```typescript
{
  records: LaboOrderDetailRecord[],
  totalRecords: number,
  totalCost: number,
}
```

### React Query Hooks

#### useLaboReportSummary(filters)

```typescript
queryKey: ["labo-report", "summary", month, clinicId]
staleTime: 2min (current) / 2h (past)
gcTime: 5h
enabled: !!month
```

#### useLaboReportDetail(tab, key, filters)

```typescript
queryKey: ["labo-report", "detail", tab, key, month, clinicId]
staleTime: 2min (current) / 2h (past)
gcTime: 5h
enabled: !!tab && !!key && !!month // Lazy load
```

---

## ğŸ—ï¸ Architecture

### Backend (3-Layer)

**Repository** (`src/server/repos/labo-report.repo.ts`):

- 6 public methods: `getKpiData`, `getDailyData`, `getSupplierData`, `getDoctorData`, `getServiceData`, `getDetailRecords`
- Private helpers: Query, aggregate, sort, rank

**Service** (`src/server/services/labo-report.service.ts`):

- `getLaboReportSummary(query, userId)` - Validate â†’ parallel queries â†’ mappers
- `getLaboReportDetail(query, userId)` - Validate â†’ filter â†’ mappers

**Mappers** (`src/server/services/labo-report/_mappers.ts`):

- 6 functions: `mapKpiData`, `mapDailyData`, `mapSupplierData`, `mapDoctorData`, `mapServiceData`, `mapDetailRecords`
- Transform only, no logic

### Frontend

**Structure** (`src/features/reports/labo/`):

```
â”œâ”€â”€ views/LaboReportView.tsx          # Main orchestrator
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ LaboReportStats.tsx           # 3 KPI cards
â”‚   â”œâ”€â”€ SummaryTabs.tsx               # 4 tabs wrapper
â”‚   â”œâ”€â”€ SummaryTable.tsx              # Reusable table
â”‚   â””â”€â”€ DetailPanel.tsx               # Detail luÃ´n hiá»ƒn thá»‹
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useLaboReportSummary.ts
â”‚   â””â”€â”€ useLaboReportDetail.ts
â”œâ”€â”€ utils/caching.ts
â”œâ”€â”€ api.ts
â””â”€â”€ index.ts
```

---

## ğŸ” Permissions

```typescript
"labo-reports:view";
```

- Roles: admin

```typescript
"labo-reports:export";
```

- Roles: admin

---

## ğŸ§ª Test Cases

### TC-1: Report by Supplier (Ranking)

```
Given: CÃ³ 3 xÆ°á»Ÿng vá»›i orders trong thÃ¡ng 11:
  - Anh Nam Labo: 45 Ä‘Æ¡n, 120M
  - XÆ°á»Ÿng Viá»‡t: 30 Ä‘Æ¡n, 80M
  - Labo 24h: 15 Ä‘Æ¡n, 50M
When: Chá»n tab "Theo XÆ°á»Ÿng", thÃ¡ng 11/2025
Then:
  - Row 1: ğŸ¥‡ Anh Nam Labo: 45 Ä‘Æ¡n, 120M, 48.0%
  - Row 2: ğŸ¥ˆ XÆ°á»Ÿng Viá»‡t: 30 Ä‘Æ¡n, 80M, 32.0%
  - Row 3: ğŸ¥‰ Labo 24h: 15 Ä‘Æ¡n, 50M, 20.0%
  - Sort DESC by totalCost
  - Ranking: 1, 2, 3 (display with medals)
```

### TC-2: Detail Panel (Lazy Load)

```
Given: Report tab "Theo XÆ°á»Ÿng"
When: Click vÃ o row "Anh Nam Labo"
Then:
  - DetailPanel hiá»ƒn thá»‹: "Chi tiáº¿t xÆ°á»Ÿng: Anh Nam Labo"
  - Load danh sÃ¡ch 45 orders cá»§a xÆ°á»Ÿng Ä‘Ã³
  - Columns: NgÃ y gá»­i, KhÃ¡ch hÃ ng (MÃ£), BÃ¡c sÄ© gá»­i, Dá»‹ch vá»¥, Loáº¡i ÄH, GiÃ¡
  - Pagination: 20 rows/page
  - Click row khÃ¡c â†’ Update detail vá»›i xÆ°á»Ÿng má»›i
  - Äá»•i tab â†’ Clear selection, empty state
```

### TC-3: MoM Growth Indicator

```
Given:
  - ThÃ¡ng 10/2025: 100 Ä‘Æ¡n, 200M
  - ThÃ¡ng 11/2025: 115 Ä‘Æ¡n, 250M
When: Chá»n thÃ¡ng 11/2025
Then:
  - Card "Tá»•ng Ä‘Æ¡n": 115 | ğŸŸ¢ â†‘ +15.0%
  - Card "Tá»•ng chi phÃ­": 250M | ğŸŸ¢ â†‘ +25.0%
  - Card "Chi phÃ­ TB": 2.17M | ğŸŸ¢ â†‘ +8.7%
```

### TC-4: Employee Clinic Lock

```
Given: User lÃ  Employee thuá»™c Chi nhÃ¡nh B
When: Truy cáº­p Labo Reports
Then:
  - Header: "BÃ¡o cÃ¡o Labo - ThÃ¡ng nÃ y [ğŸ—“ï¸ 11/2025]"
  - KhÃ´ng cÃ³ Clinic Selector
  - Data chá»‰ hiá»ƒn thá»‹ orders cá»§a Chi nhÃ¡nh B
  - API query forced: clinicId = user.clinicId
```

### TC-5: Admin Multi-Clinic View

```
Given: User lÃ  Admin, cÃ³ 3 chi nhÃ¡nh
When: Chá»n "Táº¥t cáº£ chi nhÃ¡nh", thÃ¡ng 11/2025
Then:
  - Hiá»ƒn thá»‹ tá»•ng há»£p data tá»« 3 chi nhÃ¡nh
  - KPI: Tá»•ng Ä‘Æ¡n, tá»•ng chi phÃ­ cá»§a all clinics
  - Dimension tables: Aggregate cross-clinic
  - Detail panel: Hiá»ƒn thá»‹ clinicName trong má»—i order
```

---

## ğŸ“‹ Implementation Checklist

### Backend (3-Layer Pattern)

**Repository Layer:**

- [ ] Create `src/server/repos/labo-report.repo.ts`
- [ ] Public methods (6):
  - [ ] `getKpiData(params)` - Aggregate KPI + MoM
  - [ ] `getDailyData(params)` - Daily breakdown by returnDate, sort ASC
  - [ ] `getSupplierData(params)` - Supplier breakdown, sort DESC, assign rank
  - [ ] `getDoctorData(params)` - Doctor breakdown, sort DESC, assign rank
  - [ ] `getServiceData(params)` - Service breakdown, sort DESC, assign rank
  - [ ] `getDetailRecords(params)` - Detail orders for drill-down
- [ ] Private helpers (9):
  - [ ] `getMonthDateRange()` - Parse month to date range
  - [ ] `queryLaboOrders()` - Base query vá»›i relations
  - [ ] `getPreviousMonthData()` - Query previous month
  - [ ] `calculateKpiMetrics()` - Aggregate KPI from orders
  - [ ] `aggregateByDate()` - GROUP BY returnDate (ngÃ y nháº­n máº«u)
  - [ ] `aggregateBySupplier()` - GROUP BY supplierId + ranking
  - [ ] `aggregateByDoctor()` - GROUP BY sentById + ranking
  - [ ] `aggregateByService()` - GROUP BY laboServiceId + ranking
  - [ ] `filterDetailsByDimension()` - Filter by tab + key

**Service Layer:**

- [ ] Create `src/server/services/labo-report.service.ts`
- [ ] Methods:
  - [ ] `getLaboReportSummary(query, userId)` - Validate + parallel queries + mappers
  - [ ] `getLaboReportDetail(query, userId)` - Validate + filter + mappers
- [ ] Zod validation vá»›i `safeParse`
- [ ] Authentication checks (admin only)
- [ ] Employee clinic filter enforcement
- [ ] Parallel queries: `Promise.all([getKpiData, getDailyData, getSupplierData, getDoctorData, getServiceData])`
- [ ] ServiceError pattern

**Mapper Functions:**

- [ ] Create `src/server/services/labo-report/_mappers.ts`
- [ ] 6 pure functions:
  - [ ] `mapKpiData(raw)` - Transform KPI vá»›i growth
  - [ ] `mapDailyData(raw)` - Transform daily (no rank)
  - [ ] `mapSupplierData(raw)` - Transform supplier (rank preserved)
  - [ ] `mapDoctorData(raw)` - Transform doctor (rank preserved)
  - [ ] `mapServiceData(raw)` - Transform service (rank preserved)
  - [ ] `mapDetailRecords(raw)` - Transform detail orders
- [ ] Comments tiáº¿ng Viá»‡t
- [ ] No validation, no sorting, no ranking logic

**API Routes:**

- [ ] Create `src/app/api/v1/reports/labo/summary/route.ts`
- [ ] Create `src/app/api/v1/reports/labo/detail/route.ts`
- [ ] Validation: Zod schemas cho query params
- [ ] Error handling: Try-catch with NextResponse

**Type Definitions:**

- [ ] Create `src/shared/validation/labo-report.schema.ts`
- [ ] Query schemas: `GetLaboReportSummaryQuerySchema`, `GetLaboReportDetailQuerySchema`
- [ ] Response schemas: 11 Zod schemas (KPI, Daily, Supplier, Doctor, Service, Detail)
- [ ] Export types

### Frontend (Feature-based)

**Shared Components:**

- [ ] Reuse `src/shared/components/PageHeaderWithMonthNav.tsx` (tá»« Sales/Revenue Report)
- [ ] Month Picker vá»›i auto-label (ThÃ¡ng nÃ y, ThÃ¡ng trÆ°á»›c, ThÃ¡ng MM/YYYY)
- [ ] Clinic Selector (Admin only, Employee locked)

**Feature Structure:**

- [ ] Create `src/features/reports/labo/` folder
- [ ] `views/LaboReportView.tsx` - Main orchestrator
  - [ ] State management: selectedMonth, selectedClinic, selectedTab, selectedRow
  - [ ] Data fetching: useLaboReportSummary
  - [ ] Layout: Header + Stats + SummaryTabs + DetailPanel
- [ ] `components/LaboReportStats.tsx` - 3 KPI cards
  - [ ] Card 1: Tá»•ng Ä‘Æ¡n vá»›i growth (ğŸŸ¢ â†‘ +15.0%)
  - [ ] Card 2: Tá»•ng chi phÃ­ vá»›i growth
  - [ ] Card 3: Chi phÃ­ TB vá»›i growth
- [ ] `components/SummaryTabs.tsx` - 4 tabs wrapper
  - [ ] Tab change handler â†’ Clear selection
- [ ] `components/SummaryTable.tsx` - Reusable table
  - [ ] 4 configs: Daily, Supplier, Doctor, Service
  - [ ] Ranking column (ğŸ¥‡ğŸ¥ˆğŸ¥‰) for Supplier/Doctor/Service
  - [ ] Percentage column with progress bar
  - [ ] Summary footer row
  - [ ] Click row â†’ Update selectedRow state
- [ ] `components/DetailPanel.tsx` - LuÃ´n hiá»ƒn thá»‹
  - [ ] Empty state: "ChÆ°a cÃ³ dá»¯ liá»‡u chi tiáº¿t"
  - [ ] Data state: Báº£ng chi tiáº¿t vá»›i 6 cá»™t
  - [ ] Dynamic title: "Chi tiáº¿t [dimension]: [key]"
  - [ ] Pagination: 20 rows/page

**React Query Hooks:**

- [ ] Create `src/features/reports/labo/hooks/useLaboReportSummary.ts`
  - [ ] Query key: `["labo-report", "summary", month, clinicId]`
  - [ ] Stale time: Dynamic (2min current, 2h past)
  - [ ] GC time: 5 hours
  - [ ] Enabled: `!!month`
- [ ] Create `src/features/reports/labo/hooks/useLaboReportDetail.ts`
  - [ ] Query key: `["labo-report", "detail", tab, key, month, clinicId]`
  - [ ] Stale time: Dynamic
  - [ ] GC time: 5 hours
  - [ ] Enabled: `!!tab && !!key && !!month` (lazy)

**API Client:**

- [ ] Create `src/features/reports/labo/api.ts`
- [ ] Functions:
  - [ ] `fetchLaboReportSummary(query)` - Fetch summary data
  - [ ] `fetchLaboReportDetail(query)` - Fetch detail data
- [ ] Error handling vá»›i try-catch

**Utilities:**

- [ ] Create `src/features/reports/labo/utils/caching.ts`
- [ ] `calculateStaleTime(month)` - 2min (current) vs 2h (past)

**Barrel Export:**

- [ ] Create `src/features/reports/labo/index.ts`
- [ ] Export view, hooks, types

### Integration

- [ ] Add route: `src/app/(private)/reports/labo/page.tsx`
- [ ] Link tá»« Dashboard â†’ Labo Reports
- [ ] Link tá»« Labo Daily View â†’ Reports
- [ ] Permission check: `labo-reports:view`
- [ ] Navigation breadcrumb

### Testing

- [ ] Backend unit tests:
  - [ ] Repo methods: aggregation logic, ranking logic
  - [ ] Service methods: validation, permission checks
  - [ ] Mappers: transformation accuracy
- [ ] API integration tests:
  - [ ] Summary endpoint: correct data structure
  - [ ] Detail endpoint: correct filtering + pagination
- [ ] Frontend unit tests:
  - [ ] Components: rendering, interactions
  - [ ] Hooks: query keys, enabled logic
- [ ] E2E tests:
  - [ ] Admin multi-clinic flow
  - [ ] Employee locked clinic flow
  - [ ] Drill-down interaction flow

---

## ğŸ”— Related Features

- **016.3 Labo Orders - Daily View**: Daily tracking
- **011.1 Sales Report**: Pattern reference (drill-down)
- **011.2 Revenue Report**: Multi-dimension pattern

---

**Version**: 1.0  
**Last Updated**: 2025-12-03  
**Status**: Draft - Future Implementation
