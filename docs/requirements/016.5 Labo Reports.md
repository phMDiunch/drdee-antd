# 016.5 Labo Reports - BÃ¡o CÃ¡o & PhÃ¢n TÃ­ch

## ğŸ“‹ Tá»•ng Quan

**Feature**: BÃ¡o cÃ¡o vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u Labo - Multi-dimension vá»›i drill-down

**Má»¥c Ä‘Ã­ch**:

- PhÃ¢n tÃ­ch chi phÃ­ labo theo nhiá»u chiá»u
- Tracking hiá»‡u suáº¥t xÆ°á»Ÿng
- ÄÃ¡nh giÃ¡ bÃ¡c sÄ© theo volume
- Há»— trá»£ quyáº¿t Ä‘á»‹nh kinh doanh

**Route**: `/reports/labo`

**Status**: âœ… **IMPLEMENTED** - Live in Production

---

## ğŸ¯ User Stories

### US-1: Xem bÃ¡o cÃ¡o tá»•ng quan

**LÃ ** Admin  
**TÃ´i muá»‘n** xem bÃ¡o cÃ¡o tá»•ng quan chi phÃ­ labo  
**Äá»ƒ** náº¯m tÃ¬nh hÃ¬nh kinh doanh

**Acceptance Criteria**:

- [x] Month Picker: Chá»n thÃ¡ng cáº§n xem bÃ¡o cÃ¡o (format MM/YYYY)
- [x] Clinic Selector: Admin chá»n chi nhÃ¡nh cá»¥ thá»ƒ hoáº·c "Táº¥t cáº£ chi nhÃ¡nh" (Employee khÃ´ng hiá»ƒn thá»‹)
- [x] Auto-label: Hiá»ƒn thá»‹ "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", hoáº·c "ThÃ¡ng MM/YYYY"
- [x] Hiá»ƒn thá»‹ 3 KPI cards vá»›i growth % so vá»›i thÃ¡ng trÆ°á»›c
- [x] Hiá»ƒn thá»‹ table vá»›i 4 dimension tabs (Theo ngÃ y nháº­n máº«u, Theo xÆ°á»Ÿng, Theo bÃ¡c sÄ©, Theo dá»‹ch vá»¥)
- [ ] Export Excel button (Not implemented yet)
- [x] Drill-down detail panel khi click row

### US-2: PhÃ¢n tÃ­ch theo xÆ°á»Ÿng

**LÃ ** Admin  
**TÃ´i muá»‘n** so sÃ¡nh chi phÃ­ giá»¯a cÃ¡c xÆ°á»Ÿng  
**Äá»ƒ** Ä‘Ã¡nh giÃ¡ vÃ  tá»‘i Æ°u chi phÃ­

**Acceptance Criteria**:

- [x] Group by xÆ°á»Ÿng
- [x] Metrics: Sá»‘ lÆ°á»£ng Ä‘Æ¡n, Tá»•ng chi phÃ­ (removed avgCost for performance)
- [x] Sort theo chi phÃ­ DESC
- [x] Click row Ä‘á»ƒ expand detail panel bÃªn dÆ°á»›i

### US-3: PhÃ¢n tÃ­ch theo bÃ¡c sÄ©

**LÃ ** Admin  
**TÃ´i muá»‘n** xem volume cÃ´ng viá»‡c cá»§a tá»«ng bÃ¡c sÄ©  
**Äá»ƒ** Ä‘Ã¡nh giÃ¡ hiá»‡u suáº¥t

**Acceptance Criteria**:

- [x] Group by bÃ¡c sÄ©
- [x] Metrics: Sá»‘ Ä‘Æ¡n, Chi phÃ­ phÃ¡t sinh
- [x] Sort theo volume DESC
- [x] Click row Ä‘á»ƒ expand detail panel

### US-4: PhÃ¢n tÃ­ch theo dá»‹ch vá»¥

**LÃ ** Admin  
**TÃ´i muá»‘n** xem dá»‹ch vá»¥ nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t  
**Äá»ƒ** planning vÃ  marketing

**Acceptance Criteria**:

- [x] Group by LaboService (displays serviceName, supplierName, itemName)
- [x] Metrics: Sá»‘ lÆ°á»£ng, Tá»•ng giÃ¡ trá»‹
- [ ] Chart: Pie chart or bar chart (Not implemented - table only)
- [x] Click row Ä‘á»ƒ expand detail panel

### US-5: Export Excel

**LÃ ** Admin  
**TÃ´i muá»‘n** export bÃ¡o cÃ¡o ra Excel  
**Äá»ƒ** phÃ¢n tÃ­ch thÃªm hoáº·c bÃ¡o cÃ¡o cáº¥p trÃªn

**Acceptance Criteria**:

- [ ] Button "Xuáº¥t Excel" (Not implemented yet)
- [ ] File gá»“m: Summary sheet + Detail sheet
- [ ] Format: NgÃ y VN, sá»‘ tiá»n VND
- [ ] File name: `Bao-cao-Labo-{date}.xlsx`

---

## ğŸ¨ UI Design

### Report Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š BÃ¡o cÃ¡o Labo - ThÃ¡ng nÃ y                          [ğŸ—“ï¸ 11/2025] [ğŸ¥ Chi nhÃ¡nh A â–¼] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ Tá»•ng Ä‘Æ¡n  â”‚  â”‚ ğŸ’° Tá»•ng chi  â”‚
â”‚   125        â”‚  â”‚ 95.5M â‚«      â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ ğŸŸ¢ â†‘ +12.5%  â”‚  â”‚ ğŸŸ¢ â†‘ +15.3%  â”‚
â”‚ vs T.trÆ°á»›c   â”‚  â”‚ vs T.trÆ°á»›c   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Note**: Removed "Chi phÃ­ TB" (Average Cost) card for performance optimization

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Tá»•ng há»£p                                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ [Theo xÆ°á»Ÿng] [Theo bÃ¡c sÄ©] [Theo dá»‹ch vá»¥] [Theo ngÃ y nháº­n máº«u]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tab: Theo xÆ°á»Ÿng                                                                        â”‚
â”‚                                                                                        â”‚
â”‚ Ranking â”‚ XÆ°á»Ÿng         â”‚ Sá»‘ Ä‘Æ¡n â”‚ Tá»•ng chi phÃ­ â”‚ % Tá»•ng â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥‡ #1   â”‚ Tung Dentalab â”‚   38   â”‚  41,800,000  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 43.8% â”‚
â”‚  43.8%  â”‚               â”‚        â”‚              â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥ˆ #2   â”‚ Anh Nam Labo  â”‚   45   â”‚  35,500,000  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 37.2% â”‚
â”‚  37.2%  â”‚               â”‚        â”‚              â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ ğŸ¥‰ #3   â”‚ Giang Lab     â”‚   42   â”‚  18,200,000  â”‚ â–ˆâ–ˆ 19.0%   â”‚
â”‚  19.0%  â”‚               â”‚        â”‚              â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  #4     â”‚ Lab Viá»‡t      â”‚   15   â”‚   8,500,000  â”‚ â–ˆ 8.9%     â”‚
â”‚   8.9%  â”‚               â”‚        â”‚              â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Tá»”NG    â”‚               â”‚  125   â”‚  95,500,000  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ 100%  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Note**: Removed "Chi phÃ­ TB" (Average Cost) column - not computed for performance
```

### Dimension: Theo XÆ°á»Ÿng

| Ranking | XÆ°á»Ÿng         | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ | % Tá»•ng |
| ------- | ------------- | ------ | ------------ | ------ |
| ğŸ¥‡ #1   | Tung Dentalab | 38     | 41.8M â‚«      | 43.8%  |
| ğŸ¥ˆ #2   | Anh Nam Labo  | 45     | 35.5M â‚«      | 37.2%  |
| ğŸ¥‰ #3   | Giang Lab     | 42     | 18.2M â‚«      | 19.0%  |

**Note**: Removed "Chi phÃ­ TB" (Average Cost) column

### Dimension: Theo BÃ¡c sÄ©

| Ranking | BÃ¡c sÄ©         | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ | % Tá»•ng |
| ------- | -------------- | ------ | ------------ | ------ |
| ğŸ¥‡ #1   | Dr. Nguyá»…n VÄƒn | 52     | 42.3M â‚«      | 44.3%  |
| ğŸ¥ˆ #2   | Dr. Tráº§n Thá»‹   | 38     | 28.7M â‚«      | 30.0%  |
| ğŸ¥‰ #3   | Dr. LÃª Minh    | 35     | 24.5M â‚«      | 25.7%  |

### Dimension: Theo NhÃ³m Dá»‹ch Vá»¥

| Ranking | NhÃ³m dá»‹ch vá»¥ (Service/Supplier/Item)  | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ | % Tá»•ng |
| ------- | ------------------------------------- | ------ | ------------ | ------ |
| ğŸ¥‡ #1   | RÄƒng sá»© Katana / Anh Nam / RÄƒng toÃ n  | 68     | 58.2M â‚«      | 60.9%  |
| ğŸ¥ˆ #2   | RÄƒng sá»© Zr / Tung Lab / RÄƒng kim loáº¡i | 42     | 26.8M â‚«      | 28.1%  |
| ğŸ¥‰ #3   | Invisalign / Giang / Chá»‰nh nha        | 10     | 7.2M â‚«       | 7.5%   |

**Note**: Groups by LaboService (service name, supplier short name, item name)

### Drill-down Detail Panel

Khi click vÃ o row, hiá»ƒn thá»‹ detail panel bÃªn dÆ°á»›i (expand/collapse):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chi Tiáº¿t: Anh Nam Labo (45 Ä‘Æ¡n)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NgÃ y gá»­i â”‚ KhÃ¡ch hÃ ng â”‚ BÃ¡c sÄ© â”‚ Dá»‹ch vá»¥ â”‚ Loáº¡i ÄH â”‚ SL â”‚ GiÃ¡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 15/11    â”‚ A (KH001)  â”‚ Dr. N  â”‚ Katana  â”‚ LÃ m má»›i â”‚ 2  â”‚ 1.4Mâ”‚
â”‚ 18/11    â”‚ B (KH002)  â”‚ Dr. T  â”‚ Zr Full â”‚ Báº£o hÃ nhâ”‚ 4  â”‚ 2.8Mâ”‚
â”‚ ...      â”‚            â”‚        â”‚         â”‚         â”‚    â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation**:

- Always visible panel below summary table (not modal)
- Empty state when no row selected: "Vui lÃ²ng chá»n má»™t dÃ²ng Ä‘á»ƒ xem chi tiáº¿t"
- Pagination: 20 rows per page (frontend pagination)
- Data source: `useLaboReportDetail` (lazy query, enabled when row selected)

---

## ğŸ’¾ Data Structure

### Report Query

```typescript
LaboReportQuery {
  month: string              // YYYY-MM format (e.g., "2025-11")
  clinicId?: string          // Optional: Admin cÃ³ thá»ƒ chá»n clinic hoáº·c "all"
  dimension: 'supplier' | 'doctor' | 'service' | 'date'
}
```

### Report Response

```typescript
LaboReportSummaryResponse {
  kpi: {
    totalOrders: number
    totalCost: number
    totalOrdersGrowth: number    // % change vs previous month
    totalCostGrowth: number       // % change vs previous month
  }

  summaryTabs: {
    byDate: DailyLaboData[]
    bySupplier: SupplierLaboData[]
    byDoctor: DoctorLaboData[]
    byService: ServiceLaboData[]
  }
}

DailyLaboData {
  date: string              // YYYY-MM-DD
  orderCount: number
  totalCost: number
  percentage: number        // % of total cost
}

SupplierLaboData {
  supplierId: string
  supplierShortName: string
  orderCount: number
  totalCost: number
  percentage: number
  rank: number             // 1, 2, 3, ...
}

DoctorLaboData {
  doctorId: string
  doctorName: string
  orderCount: number
  totalCost: number
  percentage: number
  rank: number
}

ServiceLaboData {
  serviceId: string
  serviceName: string      // LaboService name
  supplierShortName: string
  itemName: string         // LaboItem name
  orderCount: number
  totalCost: number
  percentage: number
  rank: number
}

LaboOrderDetailRecord {
  id: string
  sentDate: string         // YYYY-MM-DD
  returnDate: string | null
  customerName: string
  customerCode: string
  customerId: string
  doctorName: string
  serviceName: string | null
  supplierShortName: string
  itemName: string
  orderType: string        // "LÃ m má»›i" | "Báº£o hÃ nh"
  quantity: number
  totalCost: number
  treatmentDate: string | null  // YYYY-MM-DD
}
```

**Note**: Removed `avgCost` from all types for performance optimization (3x query reduction)

---

## ğŸ”„ API Specification

### GET `/api/v1/reports/labo/summary`

**Query**: `{ month: string, clinicId?: string }`

**Response**: `LaboReportSummaryResponse`

**Implementation**: Backend aggregate vá»›i optimized pattern

### GET `/api/v1/reports/labo/detail`

**Query**: `{ month: string, clinicId?: string, tab: string, key: string, page: number, pageSize: number }`

**Response**:

```typescript
{
  records: LaboOrderDetailRecord[],
  totalRecords: number,
  totalCost: number,
}
```

**Implementation**: Backend filter tá»« base query

### GET `/api/v1/reports/labo/export`

**Status**: âŒ Not implemented yet

---

## ğŸ“Š Business Logic

### Data Source

- **Báº£ng**: `LaboOrder`
- **Filter field**: `returnDate` (ngÃ y nháº­n máº«u vá» tá»« xÆ°á»Ÿng) - **CRITICAL**: DÃ¹ng `returnDate` chá»© KHÃ”NG pháº£i `sentDate`
- **Relations**: `supplier`, `laboItem`, `laboService`, `sentBy`, `customer`

### Query & Aggregation Pattern (Optimized)

**Performance Optimization** - Query once, compute multiple times:

1. **Base Query (Single DB call):**

   ```typescript
   queryAllOrders(month, clinicId?)
   ```

   - Filter: `returnDate` trong thÃ¡ng (YYYY-MM-01 00:00 â†’ YYYY-MM-31 23:59)
   - Admin: `clinicId` optional | Employee: Force `clinicId = user.clinicId`
   - Includes ALL relations needed for all dimensions
   - Returns: Array of orders with full data

2. **Compute Functions (Pure, in-memory):**

   - `computeKpiData(orders, prevOrders, prevCost)` - Calculate KPI + MoM growth
   - `computeDailyData(orders)` - GROUP BY `returnDate`, sort ASC
   - `computeSupplierData(orders)` - GROUP BY `supplierId`, sort DESC, assign rank
   - `computeDoctorData(orders)` - GROUP BY `sentById`, sort DESC, assign rank
   - `computeServiceData(orders)` - GROUP BY `laboServiceId`, sort DESC, assign rank
   - `filterDetailsByTabAndKey(orders, tab, key)` - Filter for detail panel

3. **Total DB Queries:**
   - Summary endpoint: **2 queries** (current month + previous month)
   - Detail endpoint: **1 query** (current month only, then filter in memory)
   - **Result**: 66% reduction from original 6-query pattern

### Business Rules

- **Removed avgCost**: Not computed for performance (avoid redundant calculations)
- **Percentage**: (Dimension total / Grand total) Ã— 100%
- **Ranking**: Only for supplier, doctor, service dimensions (not daily)
- **Sort**:
  - Daily: ASC by date
  - Supplier/Doctor/Service: DESC by totalCost
- **Pagination**: Detail panel uses frontend pagination (20 rows/page)

---

## ğŸ”„ Data Flow

### API Endpoints

#### GET `/api/v1/reports/labo/summary`

**Query**: `{ month, clinicId? }`

**Response**:

```typescript
{
  kpi: LaboKpiData,
  summaryTabs: {
    byDate: DailyLaboData[],
    bySupplier: SupplierLaboData[],
    byDoctor: DoctorLaboData[],
    byService: ServiceLaboData[],
  }
}
```

#### GET `/api/v1/reports/labo/detail`

**Query**: `{ month, clinicId?, tab, key }`

**Response**:

```typescript
{
  records: LaboOrderDetailRecord[],
  totalRecords: number,
  totalCost: number,
}
```

### React Query Hooks

#### useLaboReportSummary(filters)

```typescript
queryKey: ["labo-report", "summary", month, clinicId]
staleTime: 2min (current) / 2h (past)
gcTime: 5h
enabled: !!month
```

#### useLaboReportDetail(tab, key, filters)

```typescript
queryKey: ["labo-report", "detail", tab, key, month, clinicId]
staleTime: 2min (current) / 2h (past)
gcTime: 5h
enabled: !!tab && !!key && !!month // Lazy load
```

---

## ğŸ—ï¸ Architecture

### Backend (3-Layer Pattern - Optimized)

**Repository** (`src/server/repos/labo-report.repo.ts`):

- **1 Query Method** (public):
  - `queryAllOrders(month, clinicId?)` - Single DB query vá»›i Ä‘áº§y Ä‘á»§ relations
- **6 Compute Methods** (public, pure functions):
  - `computeKpiData(orders, prevOrders, prevCost)` - Aggregate KPI + MoM growth
  - `computeDailyData(orders)` - Daily breakdown by returnDate
  - `computeSupplierData(orders)` - Supplier breakdown + ranking
  - `computeDoctorData(orders)` - Doctor breakdown + ranking
  - `computeServiceData(orders)` - Service breakdown + ranking
  - `getDetailRecords(params)` - Detail query with pagination (separate query for details)
- **Private helpers** (2):
  - `getMonthDateRange(month)` - Parse month to date range
  - `buildWhereClause(startDate, endDate, clinicId?)` - Build Prisma where clause

**Key Innovation**: Query once, compute many times â†’ 66% fewer DB queries

**Service** (`src/server/services/labo-report.service.ts`):

- `getSummary(query, userId)`:
  - Validate (Zod), auth check (admin only)
  - Query DB 2x parallel: current month + previous month
  - Call 5 compute methods with same data
  - Apply mappers
- `getDetail(query, userId)`:
  - Validate, auth check
  - Query detail records (separate optimized query)
  - Apply mapper

**Mappers** (`src/server/services/labo-report/_mappers.ts`):

- 6 pure functions (transform only, no logic):
  - `mapKpiData(raw)`
  - `mapDailyData(raw, totalCost)`
  - `mapSupplierData(raw, totalCost)`
  - `mapDoctorData(raw, totalCost)`
  - `mapServiceData(raw, totalCost)`
  - `mapDetailRecords(raw)`
- Comments tiáº¿ng Viá»‡t

### Frontend (Feature-based Structure)

**Structure** (`src/features/reports/labo/`):

```
â”œâ”€â”€ views/LaboReportView.tsx          # Main orchestrator
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ LaboReportStats.tsx           # 2 KPI cards (removed avgCost)
â”‚   â”œâ”€â”€ SummaryTabs.tsx               # 4 tabs wrapper
â”‚   â”œâ”€â”€ SummaryTable.tsx              # Reusable table (4 configs)
â”‚   â””â”€â”€ DetailPanel.tsx               # Always visible, lazy load
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useLaboReportSummary.ts       # Query summary data
â”‚   â””â”€â”€ useLaboReportDetail.ts        # Query detail data (lazy)
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ caching.ts                    # Dynamic stale time
â”œâ”€â”€ api.ts                             # API client functions
â””â”€â”€ index.ts                           # Barrel exports
```

**Components**:

- `LaboReportView`: State management (selectedMonth, selectedClinic, selectedTab, selectedRow)
- `LaboReportStats`: 2 KPI cards (Tá»•ng Ä‘Æ¡n, Tá»•ng chi phÃ­) vá»›i growth indicators
- `SummaryTabs`: 4 tabs (Daily, Supplier, Doctor, Service) - tab change clears selection
- `SummaryTable`: Reusable with 4 dimension configs, click row â†’ update selectedRow
- `DetailPanel`: Always below table, empty state when no selection, pagination 20/page

**React Query Hooks**:

- `useLaboReportSummary`:
  - Query key: `["labo-report", "summary", month, clinicId]`
  - Stale time: Dynamic (2min current, 2h past)
  - GC time: 5 hours
  - Enabled: `!!month`
- `useLaboReportDetail`:
  - Query key: `["labo-report", "detail", tab, key, month, clinicId, page, pageSize]`
  - Stale time: Dynamic
  - GC time: 5 hours
  - Enabled: `!!tab && !!key && !!month` (lazy load)

---

## ğŸ” Permissions

```typescript
"labo-reports:view";
```

- Roles: **admin only**
- Employee: Cannot access (403 Forbidden)

```typescript
"labo-reports:export";
```

- Roles: admin
- Status: âŒ Not implemented yet

---

## ğŸ§ª Test Cases

### TC-1: Report by Supplier (Ranking)

```
Given: CÃ³ 3 xÆ°á»Ÿng vá»›i orders trong thÃ¡ng 11:
  - Anh Nam Labo: 45 Ä‘Æ¡n, 120M
  - XÆ°á»Ÿng Viá»‡t: 30 Ä‘Æ¡n, 80M
  - Labo 24h: 15 Ä‘Æ¡n, 50M
When: Chá»n tab "Theo XÆ°á»Ÿng", thÃ¡ng 11/2025
Then:
  - Row 1: ğŸ¥‡ Anh Nam Labo: 45 Ä‘Æ¡n, 120M, 48.0%
  - Row 2: ğŸ¥ˆ XÆ°á»Ÿng Viá»‡t: 30 Ä‘Æ¡n, 80M, 32.0%
  - Row 3: ğŸ¥‰ Labo 24h: 15 Ä‘Æ¡n, 50M, 20.0%
  - Sort DESC by totalCost
  - Ranking: 1, 2, 3 (display with medals)
```

### TC-2: Detail Panel (Lazy Load)

```
Given: Report tab "Theo XÆ°á»Ÿng"
When: Click vÃ o row "Anh Nam Labo"
Then:
  - DetailPanel hiá»ƒn thá»‹: "Chi tiáº¿t: Anh Nam Labo"
  - Load danh sÃ¡ch 45 orders cá»§a xÆ°á»Ÿng Ä‘Ã³
  - Columns: NgÃ y gá»­i, KhÃ¡ch hÃ ng (MÃ£), BÃ¡c sÄ©, Dá»‹ch vá»¥, Loáº¡i ÄH, SL, GiÃ¡
  - Pagination: 20 rows/page (frontend)
  - Click row khÃ¡c â†’ Update detail vá»›i xÆ°á»Ÿng má»›i
  - Äá»•i tab â†’ Clear selection, empty state
```

**Actual Implementation**: DetailPanel always visible, empty state shows "Vui lÃ²ng chá»n má»™t dÃ²ng"

### TC-3: MoM Growth Indicator

```
Given:
  - ThÃ¡ng 10/2025: 100 Ä‘Æ¡n, 200M
  - ThÃ¡ng 11/2025: 115 Ä‘Æ¡n, 250M
When: Chá»n thÃ¡ng 11/2025
Then:
  - Card "Tá»•ng Ä‘Æ¡n": 115 | ğŸŸ¢ â†‘ +15.0%
  - Card "Tá»•ng chi phÃ­": 250M | ğŸŸ¢ â†‘ +25.0%
```

**Note**: Removed "Chi phÃ­ TB" card (avgCost not computed)

### TC-4: Admin-Only Access

```
Given: User lÃ  Employee
When: Truy cáº­p /reports/labo
Then:
  - Response: 403 Forbidden
  - Message: "Chá»‰ admin Ä‘Æ°á»£c xem bÃ¡o cÃ¡o labo"
```

**Note**: Different from original spec - Employee CANNOT access, only Admin

### TC-5: Admin Multi-Clinic View

```
Given: User lÃ  Admin, cÃ³ 3 chi nhÃ¡nh
When: Chá»n "Táº¥t cáº£ chi nhÃ¡nh", thÃ¡ng 11/2025
Then:
  - Hiá»ƒn thá»‹ tá»•ng há»£p data tá»« 3 chi nhÃ¡nh
  - KPI: Tá»•ng Ä‘Æ¡n, tá»•ng chi phÃ­ cá»§a all clinics
  - Dimension tables: Aggregate cross-clinic
  - Detail panel: Hiá»ƒn thá»‹ clinicName trong má»—i order
```

---

## ğŸ“‹ Implementation Checklist

### âœ… Backend (Completed)

**Repository Layer:**

- [x] Created `src/server/repos/labo-report.repo.ts`
- [x] **Optimized Pattern**: Query once, compute multiple times
- [x] Public method: `queryAllOrders(params)` - Single DB query
- [x] Compute methods (6):
  - [x] `computeKpiData(orders, prevOrders, prevCost)` - KPI + MoM growth
  - [x] `computeDailyData(orders)` - Daily by returnDate, sort ASC
  - [x] `computeSupplierData(orders)` - Supplier + rank, sort DESC
  - [x] `computeDoctorData(orders)` - Doctor + rank, sort DESC
  - [x] `computeServiceData(orders)` - Service + rank, sort DESC
  - [x] `getDetailRecords(params)` - Detail with pagination
- [x] Private helpers: `getMonthDateRange()`, `buildWhereClause()`
- [x] **Critical Fix**: Filter by `returnDate` not `sentDate`
- [x] **Performance**: Removed `avgCost` calculations

**Service Layer:**

- [x] Created `src/server/services/labo-report.service.ts`
- [x] Methods:
  - [x] `getSummary(query, userId)` - Validate + 2 parallel queries + compute + mappers
  - [x] `getDetail(query, userId)` - Validate + query + mapper
- [x] Zod validation vá»›i `safeParse`
- [x] Authentication: Admin-only (403 for Employee)
- [x] Optimized: 2 queries for summary (current + previous month)

**Mapper Functions:**

- [x] Created `src/server/services/labo-report/_mappers.ts`
- [x] 6 pure functions:
  - [x] `mapKpiData(raw)` - KPI + growth
  - [x] `mapDailyData(raw, totalCost)` - Daily with %
  - [x] `mapSupplierData(raw, totalCost)` - Supplier with % + rank
  - [x] `mapDoctorData(raw, totalCost)` - Doctor with % + rank
  - [x] `mapServiceData(raw, totalCost)` - Service with % + rank
  - [x] `mapDetailRecords(raw)` - Detail orders
- [x] Comments tiáº¿ng Viá»‡t

**API Routes:**

- [x] Created `src/app/api/v1/reports/labo/summary/route.ts`
- [x] Created `src/app/api/v1/reports/labo/detail/route.ts`
- [x] Validation: Zod schemas
- [x] Error handling: Try-catch with NextResponse

**Type Definitions:**

- [x] Created `src/shared/validation/labo-report.schema.ts`
- [x] Query schemas: `GetLaboReportSummaryQuerySchema`, `GetLaboReportDetailQuerySchema`
- [x] Response schemas: 9 Zod schemas (removed avgCost-related)
- [x] Export types

### âœ… Frontend (Completed)

**Feature Structure:**

- [x] Created `src/features/reports/labo/` folder
- [x] `views/LaboReportView.tsx` - Main orchestrator
  - [x] State: selectedMonth, selectedClinic, selectedTab, selectedRow
  - [x] Data fetching: useLaboReportSummary, useLaboReportDetail
  - [x] Layout: Header + Stats + SummaryTabs + DetailPanel
- [x] `components/LaboReportStats.tsx` - 2 KPI cards (removed avgCost)
  - [x] Card 1: Tá»•ng Ä‘Æ¡n vá»›i growth
  - [x] Card 2: Tá»•ng chi phÃ­ vá»›i growth
- [x] `components/SummaryTabs.tsx` - 4 tabs wrapper
  - [x] Tab change â†’ Clear selection
- [x] `components/SummaryTable.tsx` - Reusable table
  - [x] 4 configs: Daily, Supplier, Doctor, Service
  - [x] Ranking column (ğŸ¥‡ğŸ¥ˆğŸ¥‰) for Supplier/Doctor/Service
  - [x] Percentage column with progress bar
  - [x] Summary footer row
  - [x] Click row â†’ Update selectedRow
- [x] `components/DetailPanel.tsx` - Always visible
  - [x] Empty state: "Vui lÃ²ng chá»n má»™t dÃ²ng..."
  - [x] Data state: Table vá»›i 7 cá»™t
  - [x] Dynamic title: "Chi tiáº¿t: [key]"
  - [x] Pagination: 20 rows/page (frontend)

**React Query Hooks:**

- [x] Created `src/features/reports/labo/hooks/useLaboReportSummary.ts`
  - [x] Query key: `["labo-report", "summary", month, clinicId]`
  - [x] Stale time: Dynamic (2min current, 2h past)
  - [x] GC time: 5 hours
  - [x] Enabled: `!!month`
- [x] Created `src/features/reports/labo/hooks/useLaboReportDetail.ts`
  - [x] Query key: `["labo-report", "detail", tab, key, month, clinicId, page, pageSize]`
  - [x] Stale time: Dynamic
  - [x] GC time: 5 hours
  - [x] Enabled: `!!tab && !!key && !!month`

**API Client:**

- [x] Created `src/features/reports/labo/api.ts`
- [x] Functions:
  - [x] `fetchLaboReportSummary(query)`
  - [x] `fetchLaboReportDetail(query)`
- [x] Error handling

**Utilities:**

- [x] Created `src/features/reports/labo/utils/caching.ts`
- [x] `calculateStaleTime(month)` - Dynamic stale time

**Barrel Export:**

- [x] Created `src/features/reports/labo/index.ts`
- [x] Export view, hooks, types

### âœ… Integration (Completed)

- [x] Added route: `src/app/(private)/reports/labo/page.tsx`
- [x] Link tá»« navigation menu
- [x] Permission check: `labo-reports:view` (admin only)
- [x] Breadcrumb navigation

### â³ Pending Features

- [ ] Excel export functionality
- [ ] Chart visualization for service dimension
- [ ] Employee clinic-locked access (currently admin-only)

---

## ğŸ”— Related Features

- **016.3 Labo Orders - Daily View**: Daily tracking
- **011.1 Sales Report**: Pattern reference (drill-down)
- **011.2 Revenue Report**: Multi-dimension pattern (also refactored with same optimization)

## ğŸ¯ Performance Optimization Summary

**Pattern**: Query once, compute multiple times

**Impact**:

- Summary endpoint: 6 queries â†’ 2 queries (**66% reduction**)
- Detail endpoint: 2 queries â†’ 1 query (**50% reduction**)
- Removed `avgCost`: Eliminates redundant calculations
- Memory efficient: Single dataset reused for 5 compute operations
- Cache effective: 2 queries can be cached vs 6 separate caches

**Trade-offs**:

- âœ… Pros: Lower DB load, faster response, scalable, easier to maintain
- âš ï¸ Cons: Slightly higher memory usage (acceptable for dental clinic scale)

---

**Version**: 2.0  
**Last Updated**: 2025-12-08  
**Status**: âœ… Production - Live with Optimized Pattern
