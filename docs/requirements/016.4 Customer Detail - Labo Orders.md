# 016.4 Customer Detail - Labo Orders Tab

> **üìä STATUS: PLANNING** - Phase 2 implementation  
> **üìÑ Feature Documentation**: To be created  
> **üîó Implementation**: `src/features/customers/components/detail-tabs/LaboOrdersTab.tsx`  
> **üîó Dependencies**: Feature Labo Orders (completed), Customer Detail base (completed)

## üìä Tham kh·∫£o

- **Base Feature**: `docs/requirements/016.3 Labo Orders - Daily View.md` (completed)
- **Customer Detail Base**: `docs/requirements/007.1 Customer Detail.md` (Phase 1 completed)
- **Appointments Tab**: `docs/requirements/007.2 Customer Detail - Appointments.md` (reference pattern)
- **Labo Overview**: `docs/requirements/016 Labo Management - Overview.md`
- **Current Implementation**:
  - Labo Orders feature: `src/features/labo-orders/` (completed)
  - Customer Detail: `src/features/customers/views/CustomerDetailView.tsx` (tab placeholder exists)

---

## üéØ M·ª•c Ti√™u & Ph·∫°m Vi

### M·ª•c ƒë√≠ch

Tab "Labo" trong Customer Detail cung c·∫•p:

- ‚úÖ **Xem ƒë∆°n h√†ng labo**: Danh s√°ch t·∫•t c·∫£ labo orders c·ªßa customer (sent + returned)
- ‚úÖ **T·∫°o ƒë∆°n h√†ng**: Quick action ƒë·ªÉ t·∫°o order cho customer n√†y
- ‚úÖ **Qu·∫£n l√Ω ƒë∆°n h√†ng**: Edit, Delete, Receive (nh·∫≠n m·∫´u)
- ‚úÖ **Th·ªëng k√™ t·ªïng quan**: S·ªë l∆∞·ª£ng v√† chi ph√≠ labo c·ªßa customer
- ‚úÖ **Integration**: T√≠ch h·ª£p v·ªõi Labo Orders feature, reuse components

### Scope

- ‚úÖ **LaboOrdersTab Component**: Replace placeholder, hi·ªÉn th·ªã labo order table
- ‚úÖ **Summary Card Update**: Th√™m labo statistics v√†o financial card (Phase 2+)
- ‚úÖ **Tab Count**: Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng orders `(N)`
- ‚úÖ **Modal Integration**: Reuse `CreateLaboOrderModal`, `UpdateLaboOrderModal`
- ‚úÖ **Quick Actions**: Nh·∫≠n m·∫´u, Edit, Delete t·ª´ table
- ‚úÖ **Data Sync**: Real-time updates sau CRUD operations

---

## üé≤ Decision Log

### Component Reuse Strategy

- ‚úÖ **Reuse LaboOrderTable**: Import t·ª´ `@/features/labo-orders`
- ‚úÖ **Hide customer column**: V√¨ ƒë√£ ·ªü customer detail, kh√¥ng c·∫ßn hi·ªÉn th·ªã customer info
- ‚úÖ **Reuse modals**: `CreateLaboOrderModal`, `UpdateLaboOrderModal` (TODO) t·ª´ labo-orders feature
- ‚úÖ **Reuse hooks**: `useLaboOrders`, `useCreateLaboOrder`, `useUpdateLaboOrder`, `useDeleteLaboOrder`, `useReceiveLaboOrder`

### Data Flow

- ‚úÖ **API Integration**: D√πng existing API `GET /api/v1/labo-orders?customerId=...`
- ‚úÖ **Query filtering**: Client-side filter labo orders by customerId
- ‚úÖ **Real-time sync**: Invalidate queries sau create/update/delete/receive
- ‚úÖ **Customer refetch**: Refetch customer detail ƒë·ªÉ update tab count

### Cross-Clinic View Strategy

- ‚úÖ **Customer-Centric Approach**: Khi filter theo `customerId` ‚Üí Hi·ªÉn th·ªã T·∫§T C·∫¢ orders (cross-clinic)
- ‚úÖ **Business Rationale**:
  - Customer c√≥ th·ªÉ ƒëi·ªÅu tr·ªã ·ªü nhi·ªÅu c∆° s·ªü
  - Tracking warranty v√† l·ªãch s·ª≠ l√†m rƒÉng gi·∫£
  - Tr√°nh l√†m tr√πng/xung ƒë·ªôt v·ªõi orders ·ªü clinic kh√°c
- ‚úÖ **Scope**: Ch·ªâ √°p d·ª•ng cho Customer Detail view, kh√¥ng ·∫£nh h∆∞·ªüng Daily view
- ‚úÖ **Security**: Employee v·∫´n ch·ªâ create/edit orders c·ªßa clinic m√¨nh (view-only cho clinic kh√°c)

### Table Display Strategy

- ‚úÖ **No Date Grouping**: Kh√°c v·ªõi Daily View (c√≥ 2 collapsed tables: sent/returned), Customer Detail hi·ªÉn th·ªã 1 table duy nh·∫•t
- ‚úÖ **Full History**: Hi·ªÉn th·ªã t·∫•t c·∫£ orders (sent + returned, all dates)
- ‚úÖ **Sort**: Default `sendDate desc` (m·ªõi nh·∫•t tr∆∞·ªõc)
- ‚úÖ **Show Full Datetime**: Kh√¥ng ch·ªâ ng√†y, hi·ªÉn th·ªã c·∫£ gi·ªù (kh√°c Daily View)
- ‚úÖ **Status Column**: Th√™m c·ªôt tr·∫°ng th√°i ƒë·ªÉ ph√¢n bi·ªát ƒë√£ nh·∫≠n/ch∆∞a nh·∫≠n

---

## 1. üìä Backend Requirements

### 1.1 API Endpoint Enhancement

**GET /api/v1/labo-orders**

Query params ƒë·ªÉ filter by customer:

```typescript
interface GetLaboOrdersQuery {
  customerId?: string; // Filter by specific customer
  clinicId?: string; // Optional clinic filter
  date?: string; // Optional date filter (YYYY-MM-DD) - d√πng cho Daily View
  type?: "sent" | "returned"; // Optional type filter - d√πng cho Daily View
  page?: number; // Pagination
  pageSize?: number;
  sortField?: string;
  sortDirection?: "asc" | "desc";
}
```

**Backend Logic - Cross-Clinic View:**

```typescript
// labo-order.service.ts - list()

async list(currentUser: UserCore | null, query: unknown) {
  requireAuth(currentUser);
  const parsed = GetLaboOrdersQuerySchema.parse(query);
  const { customerId, clinicId, date, type, /* ... */ } = parsed;

  // NEW LOGIC: Customer-centric view
  let effectiveClinicId: string | undefined;

  if (customerId) {
    // CASE 1: Filter by customerId (Customer Detail view)
    // ‚Üí Show ALL orders c·ªßa customer (cross-clinic)
    effectiveClinicId = undefined; // ‚Üê No clinic filter

  } else {
    // CASE 2: General list (Daily/Management view)
    // ‚Üí Employee ch·ªâ th·∫•y orders c·ªßa clinic m√¨nh
    effectiveClinicId =
      currentUser?.role === "admin" ? clinicId : currentUser?.clinicId;

    if (!effectiveClinicId && currentUser?.role !== "admin") {
      throw new ServiceError(
        "MISSING_CLINIC",
        "Nh√¢n vi√™n ph·∫£i thu·ªôc v·ªÅ m·ªôt chi nh√°nh",
        403
      );
    }
  }

  const { items, count } = await laboOrderRepo.list({
    customerId,
    clinicId: effectiveClinicId, // ‚Üê Conditional clinic filter
    date,
    type,
    // ... other params
  });
  // ...
}
```

**Response:**

```typescript
interface LaboOrdersListResponse {
  items: LaboOrderResponse[]; // May include orders from multiple clinics
  count: number;
  page: number;
  pageSize: number;
  totalPages: number;
}

interface LaboOrderResponse {
  id: string;

  // Customer info (optional in customer detail context)
  customer: {
    id: string;
    fullName: string;
    customerCode: string;
  };

  // Doctor & Clinic
  doctor: {
    id: string;
    fullName: string;
  };
  clinic: {
    id: string;
    name: string;
    code: string;
  };

  // Supplier & Item
  supplier: {
    id: string;
    name: string;
  };
  laboItem: {
    id: string;
    name: string;
    serviceGroup: string; // "rang-toan-su"
    serviceGroupLabel: string; // "RƒÉng to√†n s·ª©"
  };

  // Order details
  quantity: number;
  unitPrice: number;
  totalCost: number;
  warranty: string; // "5-nam"
  warrantyLabel: string; // "5 nƒÉm"

  // Dates
  sendDate: string; // ISO date
  returnDate: string | null; // ISO date
  expectedFitDate: string | null; // ISO date

  // Details
  detailRequirement: string | null;

  // Metadata
  createdAt: string;
  updatedAt: string;
}
```

### 1.2 Customer Detail API Enhancement

**GET /api/v1/customers/[id]** - Add labo orders relation

Response includes labo orders count:

```typescript
interface CustomerDetailResponse {
  // ... existing fields
  laboOrders?: LaboOrderResponse[]; // Full labo orders list with relations
  _count?: {
    appointments: number;
    laboOrders: number; // Count for tab badge
    // ... other relations
  };
}
```

**Backend Implementation:**

```typescript
// customer.service.ts - getDetail()

async getDetail(currentUser: UserCore | null, id: string) {
  // ... existing logic

  // Include labo orders with relations
  const customer = await customerRepo.findById(id, {
    include: {
      // ... existing includes
      laboOrders: {
        include: {
          doctor: { select: { id: true, fullName: true } },
          clinic: { select: { id: true, name: true, code: true } },
          supplier: { select: { id: true, name: true } },
          laboItem: {
            select: {
              id: true,
              name: true,
              serviceGroup: true,
            },
          },
        },
        orderBy: { sendDate: "desc" },
      },
    },
  });

  // Transform laboItem.serviceGroup ‚Üí serviceGroupLabel
  const transformedLaboOrders = customer.laboOrders?.map((order) => ({
    ...order,
    laboItem: {
      ...order.laboItem,
      serviceGroupLabel: masterData.lookup(
        "nhom-dich-vu-labo",
        order.laboItem.serviceGroup
      ),
    },
  }));

  return {
    ...customer,
    laboOrders: transformedLaboOrders,
    _count: {
      appointments: customer.appointments?.length || 0,
      laboOrders: customer.laboOrders?.length || 0,
    },
  };
}
```

---

## 2. üé® Frontend Architecture

### 2.1 Component Structure

```
src/features/customers/components/detail-tabs/
‚îî‚îÄ‚îÄ LaboOrdersTab.tsx                   # Main tab component

Uses from @/features/labo-orders:
‚îú‚îÄ‚îÄ LaboOrderTable                      # Table with actions
‚îú‚îÄ‚îÄ CreateLaboOrderModal                # Create order modal
‚îú‚îÄ‚îÄ UpdateLaboOrderModal                # Edit order modal (TODO)
‚îú‚îÄ‚îÄ useLaboOrders                       # Query orders (NEW hook)
‚îú‚îÄ‚îÄ useCreateLaboOrder                  # Mutation
‚îú‚îÄ‚îÄ useUpdateLaboOrder                  # Mutation (TODO)
‚îú‚îÄ‚îÄ useDeleteLaboOrder                  # Mutation
‚îî‚îÄ‚îÄ useReceiveLaboOrder                 # Mutation (receive sample)
```

### 2.2 LaboOrdersTab Component

**Location**: `src/features/customers/components/detail-tabs/LaboOrdersTab.tsx`

**Props Interface:**

```typescript
interface LaboOrdersTabProps {
  customerId: string; // Customer ID ƒë·ªÉ filter orders
  customerName: string; // Hi·ªÉn th·ªã trong modals
  clinicId: string; // Default clinic cho new orders
  onOrderChange?: () => void; // Callback ƒë·ªÉ refetch customer
}
```

**Features:**

- ‚úÖ Header v·ªõi Add button v√† statistics cards
- ‚úÖ LaboOrderTable v·ªõi `isCustomerDetailView={true}` (hide customer + show full datetime + show clinic)
- ‚úÖ Modal states (create, edit)
- ‚úÖ CRUD operations + Receive action
- ‚úÖ Loading & error states
- ‚úÖ Empty state khi ch∆∞a c√≥ orders

**Template Structure:**

```tsx
export default function LaboOrdersTab({
  customerId,
  customerName,
  clinicId,
  onOrderChange,
}: LaboOrdersTabProps) {
  // States
  const [openCreate, setOpenCreate] = useState(false);
  const [editingOrder, setEditingOrder] = useState<LaboOrderResponse | null>(
    null
  );

  // Queries
  const { data, isLoading } = useLaboOrders({
    customerId, // Filter by customer
    pageSize: 100, // Load all for customer detail
    sortField: "sendDate",
    sortDirection: "desc",
  });

  // Mutations
  const createMutation = useCreateLaboOrder();
  const updateMutation = useUpdateLaboOrder(); // TODO
  const deleteMutation = useDeleteLaboOrder();
  const receiveMutation = useReceiveLaboOrder();

  // Handlers
  const handleCreateSuccess = () => {
    setOpenCreate(false);
    onOrderChange?.(); // Refetch customer ƒë·ªÉ update count
  };

  const handleUpdateSuccess = () => {
    setEditingOrder(null);
    onOrderChange?.();
  };

  const handleDeleteSuccess = () => {
    onOrderChange?.();
  };

  const handleReceiveSuccess = () => {
    onOrderChange?.();
  };

  // Statistics calculation
  const stats = useMemo(() => {
    if (!data?.items) return { total: 0, totalCost: 0, returned: 0 };

    const total = data.items.length;
    const totalCost = data.items.reduce(
      (sum, order) => sum + order.totalCost,
      0
    );
    const returned = data.items.filter((o) => o.returnDate !== null).length;

    return { total, totalCost, returned };
  }, [data?.items]);

  return (
    <Space direction="vertical" size="middle" style={{ width: "100%" }}>
      {/* Statistics Cards */}
      <Row gutter={16}>
        <Col span={8}>
          <Card>
            <Statistic
              title="T·ªïng ƒë∆°n h√†ng"
              value={stats.total}
              prefix={<ShoppingOutlined />}
            />
          </Card>
        </Col>
        <Col span={8}>
          <Card>
            <Statistic
              title="T·ªïng chi ph√≠"
              value={stats.totalCost}
              formatter={(value) => `${value.toLocaleString()} ‚Ç´`}
              prefix={<DollarOutlined />}
            />
          </Card>
        </Col>
        <Col span={8}>
          <Card>
            <Statistic
              title="ƒê√£ nh·∫≠n m·∫´u"
              value={stats.returned}
              suffix={`/ ${stats.total}`}
              prefix={<CheckCircleOutlined />}
              valueStyle={{ color: "#52c41a" }}
            />
          </Card>
        </Col>
      </Row>

      {/* Header */}
      <Row justify="space-between" align="middle">
        <Col>
          <Typography.Title level={5}>
            L·ªãch s·ª≠ ƒë∆°n h√†ng Labo ({data?.count || 0})
          </Typography.Title>
        </Col>
        <Col>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => setOpenCreate(true)}
          >
            Th√™m ƒë∆°n h√†ng
          </Button>
        </Col>
      </Row>

      {/* Table */}
      <LaboOrderTable
        data={data?.items || []}
        loading={isLoading}
        isCustomerDetailView={true} // Hide customer column, show clinic, show full datetime
        onReceive={(id) =>
          receiveMutation.mutate(
            { orderId: id },
            { onSuccess: handleReceiveSuccess }
          )
        }
        onEdit={(order) => setEditingOrder(order)} // TODO: UpdateLaboOrderModal
        onDelete={(id) =>
          deleteMutation.mutate(id, {
            onSuccess: handleDeleteSuccess,
          })
        }
      />

      {/* Create Modal */}
      <CreateLaboOrderModal
        open={openCreate}
        selectedClinicId={clinicId}
        prefilledCustomerId={customerId} // Auto-fill customer
        confirmLoading={createMutation.isPending}
        onCancel={() => setOpenCreate(false)}
        onSubmit={(data) =>
          createMutation.mutate(data, {
            onSuccess: handleCreateSuccess,
          })
        }
      />

      {/* Update Modal - TODO */}
      {/* <UpdateLaboOrderModal
        open={!!editingOrder}
        order={editingOrder}
        confirmLoading={updateMutation.isPending}
        onCancel={() => setEditingOrder(null)}
        onSubmit={(data) =>
          updateMutation.mutate(
            { id: editingOrder.id, body: data },
            { onSuccess: handleUpdateSuccess }
          )
        }
      /> */}
    </Space>
  );
}
```

---

## 3. üìä LaboOrderTable Enhancements

### 3.1 Props Interface Update

**File**: `src/features/labo-orders/components/LaboOrderTable.tsx`

Add new prop:

```typescript
interface LaboOrderTableProps {
  data: LaboOrderResponse[];
  loading?: boolean;
  isCustomerDetailView?: boolean; // NEW: Hide customer column, show clinic, show full datetime
  onReceive: (orderId: string) => void;
  onEdit: (order: LaboOrderResponse) => void;
  onDelete: (orderId: string) => void;
  actionLoading?: boolean;
}
```

### 3.2 Columns Configuration

**Conditional Rendering:**

```tsx
const columns: ColumnsType<LaboOrderResponse> = [
  // Customer column - HIDE trong customer detail
  ...(!isCustomerDetailView
    ? [
        {
          title: "Kh√°ch h√†ng",
          width: 170,
          render: (record) => (
            <Space direction="vertical" size={0}>
              <Link href={`/customers/${record.customer.id}`}>
                {record.customer.fullName}
              </Link>
              <Tag>{record.customer.customerCode}</Tag>
            </Space>
          ),
        },
      ]
    : []),

  // Clinic column - SHOW trong customer detail (cross-clinic orders)
  ...(isCustomerDetailView
    ? [
        {
          title: "C∆° s·ªü",
          width: 100,
          dataIndex: ["clinic", "code"],
          render: (code) => <Tag color="blue">{code}</Tag>,
        },
      ]
    : []),

  // Status column - ADD ƒë·ªÉ ph√¢n bi·ªát sent/returned
  ...(isCustomerDetailView
    ? [
        {
          title: "Tr·∫°ng th√°i",
          width: 120,
          dataIndex: "returnDate",
          render: (returnDate) =>
            returnDate ? (
              <Tag color="success" icon={<CheckCircleOutlined />}>
                ƒê√£ nh·∫≠n m·∫´u
              </Tag>
            ) : (
              <Tag color="processing" icon={<ClockCircleOutlined />}>
                ƒêang ch·ªù
              </Tag>
            ),
        },
      ]
    : []),

  // Doctor
  {
    title: "B√°c sƒ©",
    width: 120,
    dataIndex: ["doctor", "fullName"],
  },

  // Supplier
  {
    title: "X∆∞·ªüng",
    width: 120,
    dataIndex: ["supplier", "name"],
  },

  // Labo Item
  {
    title: "Lo·∫°i rƒÉng",
    width: 140,
    render: (record) => (
      <Space direction="vertical" size={0}>
        <Text>{record.laboItem.name}</Text>
        <Text type="secondary" style={{ fontSize: 12 }}>
          {record.laboItem.serviceGroupLabel}
        </Text>
      </Space>
    ),
  },

  // Quantity
  {
    title: "SL",
    width: 50,
    dataIndex: "quantity",
    align: "center",
  },

  // Dates - Show full datetime trong customer detail
  ...(isCustomerDetailView
    ? [
        {
          title: "Ng√†y g·ª≠i",
          width: 150,
          dataIndex: "sendDate",
          render: (date) => formatDateTime(date), // "DD/MM/YYYY HH:mm"
        },
        {
          title: "Ng√†y nh·∫≠n",
          width: 150,
          dataIndex: "returnDate",
          render: (date) => (date ? formatDateTime(date) : "‚Äî"),
        },
      ]
    : []),

  // Actions (same as Daily View)
  {
    title: "Thao t√°c",
    width: 150,
    fixed: "right",
    render: (record) => (
      <Space split={<Divider type="vertical" />}>
        {/* Receive button - only if not yet received */}
        {!record.returnDate && (
          <Popconfirm
            title="X√°c nh·∫≠n nh·∫≠n m·∫´u"
            description="B·∫°n c√≥ ch·∫Øc ch·∫Øn ƒë√£ nh·∫≠n m·∫´u n√†y t·ª´ x∆∞·ªüng?"
            onConfirm={() => onReceive(record.id)}
          >
            <Button
              type="link"
              size="small"
              icon={<CheckOutlined />}
              loading={actionLoading}
            >
              Nh·∫≠n m·∫´u
            </Button>
          </Popconfirm>
        )}

        {/* Edit button */}
        <Button
          type="link"
          size="small"
          icon={<EditOutlined />}
          onClick={() => onEdit(record)}
        >
          S·ª≠a
        </Button>

        {/* Delete button */}
        <Popconfirm
          title="X√≥a ƒë∆°n h√†ng"
          description="B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng n√†y?"
          onConfirm={() => onDelete(record.id)}
        >
          <Button
            type="link"
            size="small"
            danger
            icon={<DeleteOutlined />}
            loading={actionLoading}
          >
            X√≥a
          </Button>
        </Popconfirm>
      </Space>
    ),
  },
];
```

---

## 4. üîÑ State Management

### 4.1 New Hook: useLaboOrders

**File**: `src/features/labo-orders/hooks/useLaboOrders.ts` (NEW)

```typescript
export function useLaboOrders(params: {
  customerId?: string;
  clinicId?: string;
  date?: string;
  type?: "sent" | "returned";
  page?: number;
  pageSize?: number;
  sortField?: string;
  sortDirection?: "asc" | "desc";
}) {
  return useQuery({
    queryKey: ["labo-orders", "list", params],
    queryFn: () => getLaboOrdersApi(params),
    enabled: !!params.customerId || !!params.clinicId || !!params.date,
    staleTime: 2 * 60 * 1000, // 2 minutes
  });
}
```

### 4.2 API Client Function

**File**: `src/features/labo-orders/api.ts`

Add new function:

```typescript
export async function getLaboOrdersApi(params: {
  customerId?: string;
  clinicId?: string;
  date?: string;
  type?: "sent" | "returned";
  page?: number;
  pageSize?: number;
  sortField?: string;
  sortDirection?: "asc" | "desc";
}) {
  const query = new URLSearchParams();

  if (params.customerId) query.set("customerId", params.customerId);
  if (params.clinicId) query.set("clinicId", params.clinicId);
  if (params.date) query.set("date", params.date);
  if (params.type) query.set("type", params.type);
  if (params.page) query.set("page", params.page.toString());
  if (params.pageSize) query.set("pageSize", params.pageSize.toString());
  if (params.sortField) query.set("sortField", params.sortField);
  if (params.sortDirection) query.set("sortDirection", params.sortDirection);

  const url = `${LABO_ORDER_ENDPOINTS.BASE}?${query.toString()}`;
  const res = await fetch(url, { cache: "no-store" });
  const json = await res.json();

  if (!res.ok) throw new Error(json?.error || COMMON_MESSAGES.UNKNOWN_ERROR);

  const parsed = LaboOrdersListResponseSchema.safeParse(json);
  if (!parsed.success) {
    throw new Error("Ph·∫£n h·ªìi danh s√°ch ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá.");
  }

  return parsed.data;
}
```

### 4.3 Response Schema

**File**: `src/shared/validation/labo-order.schema.ts`

Add new schema:

```typescript
export const LaboOrdersListResponseSchema = z.object({
  items: z.array(LaboOrderResponseSchema),
  count: z.number(),
  page: z.number(),
  pageSize: z.number(),
  totalPages: z.number(),
});

export type LaboOrdersListResponse = z.infer<
  typeof LaboOrdersListResponseSchema
>;
```

### 4.4 Mutation Hooks (Existing)

**Reuse from labo-orders feature:**

- `useCreateLaboOrder` - Already exists
- `useUpdateLaboOrder` - TODO: Implement
- `useDeleteLaboOrder` - Already exists
- `useReceiveLaboOrder` - Already exists

---

## 5. üì¶ CreateLaboOrderModal Enhancement

### 5.1 Props Update

**File**: `src/features/labo-orders/components/CreateLaboOrderModal.tsx`

Add optional prop:

```typescript
interface CreateLaboOrderModalProps {
  open: boolean;
  selectedClinicId?: string;
  prefilledCustomerId?: string; // NEW: Auto-fill customer trong customer detail context
  confirmLoading?: boolean;
  onCancel: () => void;
  onSubmit: (data: CreateLaboOrderRequest) => void;
}
```

### 5.2 Logic Update

```tsx
export function CreateLaboOrderModal({
  open,
  selectedClinicId,
  prefilledCustomerId, // NEW
  confirmLoading,
  onCancel,
  onSubmit,
}: CreateLaboOrderModalProps) {
  const form = useForm<CreateLaboOrderFormData>({
    resolver: zodResolver(CreateLaboOrderFormSchema),
  });

  // Reset form khi m·ªü modal
  useEffect(() => {
    if (open) {
      form.reset({
        clinicId: selectedClinicId,
        customerId: prefilledCustomerId || undefined, // Auto-fill customer
        // ... other defaults
      });
    }
  }, [open, selectedClinicId, prefilledCustomerId, form]);

  return (
    <Modal
      title="Th√™m ƒë∆°n h√†ng Labo"
      open={open}
      onCancel={onCancel}
      confirmLoading={confirmLoading}
      onOk={form.handleSubmit(onSubmit)}
      width={700}
    >
      <Form layout="vertical">
        {/* Customer field */}
        <Form.Item label="Kh√°ch h√†ng" required>
          <Controller
            name="customerId"
            control={form.control}
            render={({ field }) => (
              <CustomerSelect
                {...field}
                disabled={!!prefilledCustomerId} // Disable n·∫øu ƒë√£ ƒë∆∞·ª£c prefill
                placeholder="T√¨m kh√°ch h√†ng..."
              />
            )}
          />
        </Form.Item>

        {/* ... rest of form fields */}
      </Form>
    </Modal>
  );
}
```

---

## 6. üé® Customer Detail View Integration

### 6.1 Update CustomerDetailView

**File**: `src/features/customers/views/CustomerDetailView.tsx`

**Changes:**

1. Import LaboOrdersTab
2. Add labo orders to tabs array
3. Update tab count from customer data

```tsx
import { LaboOrdersTab } from "../components/detail-tabs/LaboOrdersTab";

export default function CustomerDetailView({ customerId }: Props) {
  const { data: customer, isLoading, refetch } = useCustomerDetail(customerId);

  const tabs = [
    {
      key: "info",
      label: "Th√¥ng tin chung",
      children: customer ? (
        <CustomerInfoTab customer={customer} onEditSuccess={refetch} />
      ) : null,
    },
    {
      key: "appointments",
      label: `L·ªãch h·∫πn (${customer?._count?.appointments || 0})`,
      children: customer ? (
        <AppointmentsTab
          customerId={customerId}
          customerName={customer.fullName}
          clinicId={customer.clinicId}
          onAppointmentChange={refetch}
        />
      ) : null,
    },
    {
      key: "labo-orders", // NEW TAB
      label: `Labo (${customer?._count?.laboOrders || 0})`,
      children: customer ? (
        <LaboOrdersTab
          customerId={customerId}
          customerName={customer.fullName}
          clinicId={customer.clinicId}
          onOrderChange={refetch}
        />
      ) : null,
    },
    // ... other tabs (consulted-services, payments, treatment-logs, treatment-care)
  ];

  // ... rest of component
}
```

### 6.2 Update Tab Order

**Recommended Tab Order:**

1. Th√¥ng tin chung
2. L·ªãch h·∫πn (N)
3. D·ªãch v·ª• ƒë√£ t∆∞ v·∫•n (N)
4. **Labo (N)** ‚Üê NEW
5. L·ªãch s·ª≠ ƒëi·ªÅu tr·ªã (N)
6. ChƒÉm s√≥c sau ƒëi·ªÅu tr·ªã (N)
7. Phi·∫øu thu (N)

---

## 7. üíæ Backend Implementation Checklist

### Repository Layer

**File**: `src/server/repos/labo-order.repo.ts`

Add/Update methods:

```typescript
class LaboOrderRepo {
  // NEW: General list method with flexible filters
  async list(params: {
    customerId?: string;
    clinicId?: string;
    date?: string;
    type?: "sent" | "returned";
    page: number;
    pageSize: number;
    sortField: string;
    sortDirection: "asc" | "desc";
  }) {
    const where: Prisma.LaboOrderWhereInput = {};

    // Customer filter (no clinic restriction)
    if (params.customerId) {
      where.customerId = params.customerId;
    }

    // Clinic filter (only if no customerId)
    if (!params.customerId && params.clinicId) {
      where.clinicId = params.clinicId;
    }

    // Date & type filters (for Daily View)
    if (params.date && params.type === "sent") {
      where.sendDate = new Date(params.date);
    }
    if (params.date && params.type === "returned") {
      where.returnDate = new Date(params.date);
    }

    const [items, count] = await Promise.all([
      prisma.laboOrder.findMany({
        where,
        include: {
          customer: {
            select: { id: true, fullName: true, customerCode: true },
          },
          doctor: { select: { id: true, fullName: true } },
          clinic: { select: { id: true, name: true, code: true } },
          supplier: { select: { id: true, name: true } },
          laboItem: {
            select: { id: true, name: true, serviceGroup: true },
          },
        },
        orderBy: { [params.sortField]: params.sortDirection },
        skip: (params.page - 1) * params.pageSize,
        take: params.pageSize,
      }),
      prisma.laboOrder.count({ where }),
    ]);

    return { items, count };
  }
}
```

### Service Layer

**File**: `src/server/services/labo-order.service.ts`

Update list method:

```typescript
class LaboOrderService {
  async list(currentUser: UserCore | null, query: unknown) {
    requireAuth(currentUser);
    const parsed = GetLaboOrdersQuerySchema.parse(query);
    const {
      customerId,
      clinicId,
      date,
      type,
      page,
      pageSize,
      sortField,
      sortDirection,
    } = parsed;

    // Cross-clinic logic
    let effectiveClinicId: string | undefined;

    if (customerId) {
      // Customer Detail view: Show all orders (cross-clinic)
      effectiveClinicId = undefined;
    } else {
      // Daily/Management view: Employee only sees own clinic
      effectiveClinicId =
        currentUser?.role === "admin" ? clinicId : currentUser?.clinicId;

      if (!effectiveClinicId && currentUser?.role !== "admin") {
        throw new ServiceError(
          "MISSING_CLINIC",
          "Nh√¢n vi√™n ph·∫£i thu·ªôc v·ªÅ m·ªôt chi nh√°nh",
          403
        );
      }
    }

    const { items, count } = await laboOrderRepo.list({
      customerId,
      clinicId: effectiveClinicId,
      date,
      type,
      page: page || 1,
      pageSize: pageSize || 20,
      sortField: sortField || "sendDate",
      sortDirection: sortDirection || "desc",
    });

    // Transform serviceGroup ‚Üí serviceGroupLabel
    const transformedItems = items.map((item) => ({
      ...item,
      laboItem: {
        ...item.laboItem,
        serviceGroupLabel: masterData.lookup(
          "nhom-dich-vu-labo",
          item.laboItem.serviceGroup
        ),
      },
    }));

    const totalPages = Math.ceil(count / (pageSize || 20));

    return {
      items: transformedItems,
      count,
      page: page || 1,
      pageSize: pageSize || 20,
      totalPages,
    };
  }
}
```

### API Route

**File**: `src/app/api/v1/labo-orders/route.ts`

Update GET handler:

```typescript
export async function GET(request: NextRequest) {
  const session = await getServerSession();
  const query = Object.fromEntries(request.nextUrl.searchParams);

  const result = await laboOrderService.list(session?.user || null, query);

  return NextResponse.json(result, { status: 200 });
}
```

---

## 8. üß™ Test Cases

### TC-1: View Customer Labo Orders

```
Given: Customer c√≥ 5 labo orders (3 ƒë√£ nh·∫≠n m·∫´u, 2 ch∆∞a nh·∫≠n)
When: M·ªü tab "Labo" trong Customer Detail
Then:
  - Hi·ªÉn th·ªã 5 orders trong table
  - Tab badge: "Labo (5)"
  - Statistics: 5 ƒë∆°n, 2 ƒëang ch·ªù, 3 ƒë√£ nh·∫≠n
  - Table sorted by sendDate desc (m·ªõi nh·∫•t tr∆∞·ªõc)
```

### TC-2: Cross-Clinic Orders Display

```
Given: Customer c√≥ 3 orders ·ªü PNK, 2 orders ·ªü HCM
And: Current user ·ªü PNK
When: M·ªü tab "Labo"
Then:
  - Hi·ªÉn th·ªã c·∫£ 5 orders (cross-clinic)
  - C·ªôt "C∆° s·ªü" hi·ªÉn th·ªã: PNK (3), HCM (2)
  - User ch·ªâ edit/delete ƒë∆∞·ª£c orders c·ªßa PNK
```

### TC-3: Create Order from Customer Detail

```
Given: ƒêang ·ªü Customer Detail
When: Click "Th√™m ƒë∆°n h√†ng"
Then:
  - Modal CreateLaboOrderModal m·ªü
  - Field "Kh√°ch h√†ng" ƒë√£ ƒë∆∞·ª£c auto-fill v√† disabled
  - C√°c field kh√°c r·ªóng, ready ƒë·ªÉ nh·∫≠p
```

### TC-4: Receive Sample

```
Given: Order c√≥ returnDate = null (ch∆∞a nh·∫≠n m·∫´u)
When: Click "Nh·∫≠n m·∫´u" v√† confirm
Then:
  - returnDate = now, receivedById = currentUserId
  - Button "Nh·∫≠n m·∫´u" bi·∫øn m·∫•t
  - Tag "Tr·∫°ng th√°i" ƒë·ªïi t·ª´ "ƒêang ch·ªù" ‚Üí "ƒê√£ nh·∫≠n m·∫´u"
  - Statistics card "ƒê√£ nh·∫≠n m·∫´u" tƒÉng 1
  - Toast success
```

### TC-5: Edit Order

```
Given: Admin user, order t·ªìn t·∫°i
When: Click button "S·ª≠a"
Then:
  - Modal UpdateLaboOrderModal m·ªü (TODO)
  - Form prefilled v·ªõi d·ªØ li·ªáu order
  - Sau khi submit th√†nh c√¥ng: Modal ƒë√≥ng, table refresh, toast success
```

### TC-6: Delete Order

```
Given: Admin user, order t·ªìn t·∫°i
When: Click "X√≥a" v√† confirm
Then:
  - Order b·ªã soft delete
  - Table refresh, order bi·∫øn m·∫•t
  - Tab count gi·∫£m 1
  - Statistics cards update
  - Toast success
```

### TC-7: Empty State

```
Given: Customer ch∆∞a c√≥ labo order n√†o
When: M·ªü tab "Labo"
Then:
  - Hi·ªÉn th·ªã Empty component v·ªõi message "Ch∆∞a c√≥ ƒë∆°n h√†ng Labo"
  - Button "Th√™m ƒë∆°n h√†ng" v·∫´n hi·ªÉn th·ªã
  - Statistics: 0 ƒë∆°n, 0 ‚Ç´, 0/0 nh·∫≠n m·∫´u
```

---

## 9. üìã Implementation Checklist

### Backend

- [ ] **Repository**: `laboOrderRepo.list()` - Support customerId filter (cross-clinic)
- [ ] **Service**: `laboOrderService.list()` - Implement cross-clinic logic
- [ ] **API Route**: `GET /api/v1/labo-orders` - Update to support new query params
- [ ] **Customer Service**: Include laboOrders relation trong `getDetail()`
- [ ] **Schema**: Add `GetLaboOrdersQuerySchema`, `LaboOrdersListResponseSchema`

### Frontend - Hooks

- [ ] **useLaboOrders** - New query hook cho general list
- [ ] **useLaboOrdersDaily** - Existing hook (keep for Daily View backward compatibility)
- [ ] **useCreateLaboOrder** - Existing (reuse)
- [ ] **useUpdateLaboOrder** - TODO: Implement mutation hook
- [ ] **useDeleteLaboOrder** - Existing (reuse)
- [ ] **useReceiveLaboOrder** - Existing (reuse)

### Frontend - Components

- [ ] **LaboOrdersTab.tsx** - Main tab component
- [ ] **LaboOrderTable.tsx** - Update to support `isCustomerDetailView` prop
  - [ ] Hide customer column
  - [ ] Show clinic column
  - [ ] Show status column
  - [ ] Show full datetime (not just date)
- [ ] **CreateLaboOrderModal.tsx** - Add `prefilledCustomerId` prop
- [ ] **UpdateLaboOrderModal.tsx** - TODO: Create component
- [ ] **CustomerDetailView.tsx** - Add labo orders tab

### Frontend - API Client

- [ ] **getLaboOrdersApi()** - New function with flexible params
- [ ] **LaboOrdersListResponseSchema** - Validation schema

### UI/UX

- [ ] Statistics cards (3 cards: Total, Cost, Returned/Total)
- [ ] Responsive table
- [ ] Loading skeletons
- [ ] Empty state
- [ ] Error handling
- [ ] Toast notifications

### Integration

- [ ] Tab count badge update
- [ ] Customer refetch after CRUD operations
- [ ] Query invalidation strategy
- [ ] Cross-clinic view testing

---

## 10. üéØ Future Enhancements

### Phase 2

- [ ] **UpdateLaboOrderModal**: Complete edit functionality
- [ ] **Financial Summary Card**: Integrate labo costs v√†o customer financial card
- [ ] **Warranty Tracking**: Highlight orders nearing warranty expiration
- [ ] **Photos**: Upload photos c·ªßa m·∫´u rƒÉng (before/after)

### Phase 3

- [ ] **Timeline View**: Visual timeline c·ªßa labo order lifecycle
- [ ] **Quality Tracking**: Track issues, revisions, customer satisfaction
- [ ] **Supplier Performance**: Rating x∆∞·ªüng d·ª±a tr√™n quality/timeliness
- [ ] **Payment Integration**: Link labo orders v·ªõi payment vouchers (phi·∫øu chi)

---

## üîó Related Requirements

- **016 Labo Management - Overview**: Overview v√† business flow
- **016.1 Labo Item Master**: LaboItem reference
- **016.2 Labo Service Prices**: SupplierLaboPrice reference
- **016.3 Labo Orders - Daily View**: Daily operations (existing)
- **007.1 Customer Detail**: Base customer detail structure
- **007.2 Customer Detail - Appointments**: Pattern reference

---

**Version**: 1.0  
**Last Updated**: 2025-12-04  
**Status**: Draft - Ready for Review

---

## üìù Notes

### Pattern Consistency with Appointments Tab

LaboOrdersTab follows the same pattern as AppointmentsTab:

- ‚úÖ Same component structure (header + table + modals)
- ‚úÖ Same state management (React Query + mutations)
- ‚úÖ Same cross-clinic view logic (customer-centric)
- ‚úÖ Same modal integration (reuse feature components)
- ‚úÖ Same callback pattern (`onOrderChange` refetches customer)

### Key Differences from Daily View

| Feature         | Daily View                    | Customer Detail View                |
| --------------- | ----------------------------- | ----------------------------------- |
| Data scope      | Single date                   | All dates (full history)            |
| Grouping        | 2 tables (sent/returned)      | 1 table (all orders)                |
| Customer column | Visible                       | Hidden (redundant)                  |
| Clinic column   | Hidden (same clinic)          | Visible (cross-clinic)              |
| Status column   | Implicit (by table)           | Explicit (tag: ƒêang ch·ªù/ƒê√£ nh·∫≠n)    |
| Date display    | Date only                     | Full datetime                       |
| Statistics      | Sent/Returned today           | Total orders/cost, received/total   |
| Clinic filter   | Employee locked, Admin select | Show all (customer-centric)         |
| Create modal    | Empty customer field          | Pre-filled & disabled customer      |
| Sort default    | createdAt desc (sent table)   | sendDate desc (all orders together) |

### Implementation Priority

**P0 (Critical - Must Have):**

- LaboOrdersTab component
- useLaboOrders hook
- LaboOrderTable `isCustomerDetailView` support
- Backend cross-clinic logic
- Tab count display

**P1 (High - Should Have):**

- Statistics cards
- CreateLaboOrderModal prefill
- Empty state
- Error handling

**P2 (Medium - Nice to Have):**

- UpdateLaboOrderModal (full edit)
- Financial summary integration
- Advanced statistics

**P3 (Low - Future):**

- Photos upload
- Warranty tracking
- Quality tracking
- Timeline view
