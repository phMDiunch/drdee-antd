# 016.4 Labo Reports - BÃ¡o CÃ¡o & PhÃ¢n TÃ­ch

## ğŸ“‹ Tá»•ng Quan

**Feature**: BÃ¡o cÃ¡o vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u Labo - Multi-dimension vá»›i drill-down

**Má»¥c Ä‘Ã­ch**:

- PhÃ¢n tÃ­ch chi phÃ­ labo theo nhiá»u chiá»u
- Tracking hiá»‡u suáº¥t xÆ°á»Ÿng
- ÄÃ¡nh giÃ¡ bÃ¡c sÄ© theo volume
- Há»— trá»£ quyáº¿t Ä‘á»‹nh kinh doanh

**Route**: `/reports/labo`

---

## ğŸ¯ User Stories

### US-1: Xem bÃ¡o cÃ¡o tá»•ng quan

**LÃ ** Manager/Admin  
**TÃ´i muá»‘n** xem bÃ¡o cÃ¡o tá»•ng quan chi phÃ­ labo  
**Äá»ƒ** náº¯m tÃ¬nh hÃ¬nh kinh doanh

**Acceptance Criteria**:

- [ ] Filter theo: NgÃ y (from-to), Clinic, XÆ°á»Ÿng, BÃ¡c sÄ©, NhÃ³m DV
- [ ] Hiá»ƒn thá»‹ table vá»›i nhiá»u dimensions
- [ ] Export Excel vá»›i full details
- [ ] Drill-down detail panel (tÆ°Æ¡ng tá»± Sales Report)

### US-2: PhÃ¢n tÃ­ch theo xÆ°á»Ÿng

**LÃ ** Manager  
**TÃ´i muá»‘n** so sÃ¡nh chi phÃ­ giá»¯a cÃ¡c xÆ°á»Ÿng  
**Äá»ƒ** Ä‘Ã¡nh giÃ¡ vÃ  tá»‘i Æ°u chi phÃ­

**Acceptance Criteria**:

- [ ] Group by xÆ°á»Ÿng
- [ ] Metrics: Sá»‘ lÆ°á»£ng Ä‘Æ¡n, Tá»•ng chi phÃ­, Chi phÃ­ TB
- [ ] Sort theo chi phÃ­
- [ ] Click row Ä‘á»ƒ expand detail panel bÃªn dÆ°á»›i

### US-3: PhÃ¢n tÃ­ch theo bÃ¡c sÄ©

**LÃ ** Manager  
**TÃ´i muá»‘n** xem volume cÃ´ng viá»‡c cá»§a tá»«ng bÃ¡c sÄ©  
**Äá»ƒ** Ä‘Ã¡nh giÃ¡ hiá»‡u suáº¥t

**Acceptance Criteria**:

- [ ] Group by bÃ¡c sÄ©
- [ ] Metrics: Sá»‘ Ä‘Æ¡n, Chi phÃ­ phÃ¡t sinh
- [ ] Sort theo volume
- [ ] Click row Ä‘á»ƒ expand detail panel

### US-4: PhÃ¢n tÃ­ch theo dá»‹ch vá»¥

**LÃ ** Manager  
**TÃ´i muá»‘n** xem dá»‹ch vá»¥ nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u nháº¥t  
**Äá»ƒ** planning vÃ  marketing

**Acceptance Criteria**:

- [ ] Group by nhÃ³m dá»‹ch vá»¥ hoáº·c LaboItem
- [ ] Metrics: Sá»‘ lÆ°á»£ng, Tá»•ng giÃ¡ trá»‹
- [ ] Chart: Pie chart hoáº·c bar chart
- [ ] Click row Ä‘á»ƒ expand detail panel

### US-5: Export Excel

**LÃ ** Manager  
**TÃ´i muá»‘n** export bÃ¡o cÃ¡o ra Excel  
**Äá»ƒ** phÃ¢n tÃ­ch thÃªm hoáº·c bÃ¡o cÃ¡o cáº¥p trÃªn

**Acceptance Criteria**:

- [ ] Button "Xuáº¥t Excel"
- [ ] File gá»“m: Summary sheet + Detail sheet
- [ ] Format: NgÃ y VN, sá»‘ tiá»n VND
- [ ] File name: `Bao-cao-Labo-{date}.xlsx`

---

## ğŸ¨ UI Design

### Report Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÃ¡o CÃ¡o Labo                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filters:                                                   â”‚
â”‚ [From: 01/11/2025] [To: 30/11/2025]                       â”‚
â”‚ [Clinic: Táº¥t cáº£ â–¼] [XÆ°á»Ÿng: Táº¥t cáº£ â–¼]                     â”‚
â”‚ [BÃ¡c sÄ©: Táº¥t cáº£ â–¼] [NhÃ³m DV: Táº¥t cáº£ â–¼]                   â”‚
â”‚                           [TÃ¬m kiáº¿m] [Xuáº¥t Excel]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Dimension Tabs:                                            â”‚
â”‚ [Theo XÆ°á»Ÿng] [Theo BÃ¡c sÄ©] [Theo Dá»‹ch vá»¥] [Theo NgÃ y]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Summary Cards:                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚ â”‚ Tá»•ng Ä‘Æ¡n â”‚ Tá»•ng chi â”‚ Chi phÃ­  â”‚                       â”‚
â”‚ â”‚   125    â”‚ 95.5M â‚« â”‚  764k â‚« â”‚                       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Report Table (Group by selected dimension)                â”‚
â”‚                                                            â”‚
â”‚ [Detailed data table here...]                             â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dimension: Theo XÆ°á»Ÿng

| XÆ°á»Ÿng         | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ | Chi phÃ­ TB |
| ------------- | ------ | ------------ | ---------- |
| Anh Nam Labo  | 45     | 35.5M â‚«      | 789k â‚«     |
| Tung Dentalab | 38     | 41.8M â‚«      | 1.1M â‚«     |
| Giang Lab     | 42     | 18.2M â‚«      | 433k â‚«     |

### Dimension: Theo BÃ¡c sÄ©

| BÃ¡c sÄ©         | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ |
| -------------- | ------ | ------------ |
| Dr. Nguyá»…n VÄƒn | 52     | 42.3M â‚«      |
| Dr. Tráº§n Thá»‹   | 38     | 28.7M â‚«      |
| Dr. LÃª Minh    | 35     | 24.5M â‚«      |

### Dimension: Theo NhÃ³m Dá»‹ch Vá»¥

| NhÃ³m dá»‹ch vá»¥       | Sá»‘ Ä‘Æ¡n | Tá»•ng chi phÃ­ |
| ------------------ | ------ | ------------ |
| RÄƒng toÃ n sá»©       | 68     | 58.2M â‚«      |
| RÄƒng sá»© kim loáº¡i   | 42     | 26.8M â‚«      |
| Chá»‰nh nha          | 10     | 7.2M â‚«       |
| Phá»¥c hÃ¬nh thÃ¡o láº¯p | 5      | 3.3M â‚«       |

### Drill-down Detail Panel

Khi click vÃ o row, hiá»ƒn thá»‹ detail panel bÃªn dÆ°á»›i (expand/collapse):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chi Tiáº¿t ÄÆ¡n HÃ ng: Anh Nam Labo (45 Ä‘Æ¡n)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KhÃ¡ch hÃ ng   â”‚ BÃ¡c sÄ© â”‚ Dá»‹ch vá»¥        â”‚ SL â”‚ GiÃ¡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nguyá»…n Thá»‹ A â”‚ Dr. N  â”‚ RÄƒng sá»© Katana â”‚ 2  â”‚ 1.4M â‚«    â”‚
â”‚ Tráº§n VÄƒn B   â”‚ Dr. T  â”‚ RÄƒng sá»© Zr     â”‚ 4  â”‚ 2.8M â‚«    â”‚
â”‚ ...          â”‚        â”‚                â”‚    â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Data Structure

### Report Query

```typescript
LaboReportQuery {
  dateFrom: string        // YYYY-MM-DD
  dateTo: string
  clinicId?: string
  supplierId?: string
  doctorId?: string
  serviceGroup?: string   // "rang-toan-su"
  dimension: 'supplier' | 'doctor' | 'service' | 'date'
}
```

### Report Response

```typescript
LaboReportResponse {
  summary: {
    totalOrders: number
    totalCost: number
    avgCost: number
  }

  items: LaboReportItem[]
}

LaboReportItem {
  key: string              // supplierId | doctorId | serviceGroup | date
  label: string            // Supplier name | Doctor name | Service group label | Date
  orderCount: number
  totalCost: number
  avgCost?: number

  // Drill-down data (optional, load on demand)
  orders?: LaboOrderSummary[]
}

LaboOrderSummary {
  id: string
  customerName: string
  doctorName: string
  laboItemName: string
  quantity: number
  totalCost: number
  sendDate: string
  returnDate: string | null
}
```

---

## ğŸ”„ API Specification

### GET `/api/v1/reports/labo`

**Query**: `LaboReportQuery`

**Response**: `LaboReportResponse`

**Note**: Backend aggregate query vá»›i Prisma

### GET `/api/v1/reports/labo/export`

**Query**: Same as above

**Response**: Excel file (binary)

**Headers**:

```
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="Bao-cao-Labo-2025-11.xlsx"
```

---

## ğŸ“Š Business Logic

### Aggregation Rules

1. **Date Range**: Filter `returnDate BETWEEN dateFrom AND dateTo`
2. **Group by Dimension**: SQL GROUP BY hoáº·c Prisma groupBy
3. **Sorting**: Default DESC by totalCost
4. **Drill-down**: Lazy load orders on demand (khÃ´ng load háº¿t upfront)

### Metrics Calculation

```typescript
totalCost = SUM(LaboOrder.totalCost);
orderCount = COUNT(LaboOrder.id);
avgCost = totalCost / orderCount;
```

### Performance Optimization

- **Index**: `returnDate`, `clinicId`, `supplierId`, `doctorId`
- **Cache**: Report results 5 minutes (staleTime)
- **Pagination**: Drill-down detail cÃ³ pagination (10 items/page)

---

## ğŸ” Permissions

```typescript
"labo-reports:view";
```

- Roles: admin, manager

```typescript
"labo-reports:export";
```

- Roles: admin, manager

---

## ğŸ§ª Test Cases

### TC-1: Report by Supplier

```
Given: CÃ³ 45 orders tá»« Anh Nam Labo trong thÃ¡ng 11
When: Chá»n dimension "Theo XÆ°á»Ÿng", thÃ¡ng 11
Then:
  - Hiá»ƒn thá»‹ Anh Nam Labo: 45 Ä‘Æ¡n, totalCost
  - Sort DESC by totalCost
```

### TC-2: Drill-down Detail

```
Given: Report dimension "Theo XÆ°á»Ÿng"
When: Click vÃ o row "Anh Nam Labo"
Then:
  - Row expand, hiá»ƒn thá»‹ detail panel bÃªn dÆ°á»›i
  - Load danh sÃ¡ch 45 orders cá»§a xÆ°á»Ÿng Ä‘Ã³
  - Columns: KhÃ¡ch hÃ ng, BÃ¡c sÄ©, Dá»‹ch vá»¥, SL, GiÃ¡
  - Click láº¡i Ä‘á»ƒ collapse
```

### TC-3: Export Excel

```
Given: Report cÃ³ 3 suppliers, tá»•ng 125 Ä‘Æ¡n
When: Click "Xuáº¥t Excel"
Then:
  - Download file `Bao-cao-Labo-2025-11.xlsx`
  - Sheet 1: Summary (3 rows suppliers)
  - Sheet 2: Detail (125 rows orders)
```

### TC-4: Filter by Date Range

```
Given: CÃ³ orders tá»« 01/11 Ä‘áº¿n 30/11
When: Filter from=15/11, to=30/11
Then: Chá»‰ hiá»ƒn thá»‹ orders cÃ³ returnDate trong range
```

---

## ğŸ“‹ Implementation Checklist

### Backend

- [ ] Repository: `getLaboReport(query)` - Aggregate query
- [ ] Service: Business logic for reports
- [ ] API Route: `/api/v1/labo-reports`
- [ ] Excel Export: Using `exceljs` library
- [ ] Validation: Zod schema for query

### Frontend

- [ ] React Query hooks: `useLaboReport`, `useExportLaboReport`
- [ ] Components:
  - [ ] `LaboReportFilters.tsx`
  - [ ] `LaboReportSummaryCards.tsx`
  - [ ] `LaboReportTable.tsx`
  - [ ] `LaboReportDrillDown.tsx`
- [ ] View: `LaboReportsView.tsx`
- [ ] Charts (optional): Pie/Bar chart using recharts

### Integration

- [ ] Link tá»« Dashboard â†’ Labo Reports
- [ ] Link tá»« Labo Daily View â†’ Reports

---

## ğŸ”— Related Features

- **016.3 Labo Orders - Daily View**: Daily tracking
- **011.1 Sales Report**: Pattern reference (drill-down)
- **011.2 Revenue Report**: Multi-dimension pattern

---

**Version**: 1.0  
**Last Updated**: 2025-12-03  
**Status**: Draft - Future Implementation
