# 016.1 Labo Item Master - Danh Má»¥c RÄƒng Giáº£

## ğŸ“‹ Tá»•ng Quan

**Feature**: Quáº£n lÃ½ danh má»¥c rÄƒng giáº£ (Labo Item Master Data)

**Má»¥c Ä‘Ã­ch**:

- CRUD danh má»¥c cÃ¡c loáº¡i rÄƒng giáº£, phá»¥c hÃ¬nh
- PhÃ¢n nhÃ³m theo dá»‹ch vá»¥ labo
- Chuáº©n hÃ³a Ä‘Æ¡n vá»‹ tÃ­nh
- LÃ m master data cho báº£ng giÃ¡ vÃ  Ä‘Æ¡n hÃ ng

**Route**: `/labo-items`

---

## ğŸ¯ User Stories

### US-1: Xem danh sÃ¡ch

**LÃ ** Admin  
**TÃ´i muá»‘n** xem danh sÃ¡ch táº¥t cáº£ cÃ¡c loáº¡i rÄƒng giáº£  
**Äá»ƒ** quáº£n lÃ½ vÃ  tra cá»©u thÃ´ng tin

**Acceptance Criteria**:

- [ ] Hiá»ƒn thá»‹ table vá»›i columns: TÃªn, NhÃ³m dá»‹ch vá»¥, ÄÆ¡n vá»‹, Tráº¡ng thÃ¡i, Actions
- [ ] Search theo tÃªn (real-time, filter á»Ÿ frontend)
- [ ] Load táº¥t cáº£ dá»¯ liá»‡u (khÃ´ng phÃ¢n trang)
- [ ] Sort theo tÃªn (A-Z, Z-A)

### US-2: Táº¡o má»›i

**LÃ ** Admin  
**TÃ´i muá»‘n** thÃªm loáº¡i rÄƒng giáº£ má»›i  
**Äá»ƒ** cáº­p nháº­t danh má»¥c khi cÃ³ sáº£n pháº©m má»›i

**Acceptance Criteria**:

- [ ] Button "ThÃªm danh má»¥c" má»Ÿ modal
- [ ] Form fields: TÃªn (_), NhÃ³m dá»‹ch vá»¥ (_), ÄÆ¡n vá»‹ (\*), MÃ´ táº£
- [ ] Validation: TÃªn unique, khÃ´ng trÃ¹ng láº·p
- [ ] NhÃ³m dá»‹ch vá»¥: Dropdown tá»« `nhom-dich-vu-labo`
- [ ] ÄÆ¡n vá»‹: Dropdown tá»« `don-vi-tinh-labo`
- [ ] Success: Hiá»ƒn thá»‹ toast, refresh table
- [ ] Error: Hiá»ƒn thá»‹ lá»—i validation

### US-3: Sá»­a thÃ´ng tin

**LÃ ** Admin  
**TÃ´i muá»‘n** sá»­a thÃ´ng tin rÄƒng giáº£  
**Äá»ƒ** cáº­p nháº­t khi cÃ³ thay Ä‘á»•i

**Acceptance Criteria**:

- [ ] Click icon Edit â†’ má»Ÿ modal vá»›i data hiá»‡n táº¡i
- [ ] Cho phÃ©p sá»­a táº¥t cáº£ fields
- [ ] Validation tÃªn unique (trá»« chÃ­nh nÃ³)
- [ ] Success: Update table, hiá»ƒn thá»‹ toast

### US-4: LÆ°u trá»¯ (Archive)

**LÃ ** Admin  
**TÃ´i muá»‘n** lÆ°u trá»¯ rÄƒng giáº£ khÃ´ng cÃ²n dÃ¹ng  
**Äá»ƒ** áº©n khá»i danh sÃ¡ch hoáº¡t Ä‘á»™ng nhÆ°ng giá»¯ láº¡i lá»‹ch sá»­

**Acceptance Criteria**:

- [ ] Button "LÆ°u trá»¯" vá»›i confirmation
- [ ] Confirm message: "LÆ°u trá»¯ [TÃªn]? Dá»‹ch vá»¥ nÃ y sáº½ khÃ´ng hiá»ƒn thá»‹ trong dropdown má»›i."
- [ ] Sau archive: Item bá»‹ áº©n khá»i dropdown (LaboOrder, SupplierLaboPrice)
- [ ] Váº«n hiá»ƒn thá»‹ trong table khi filter "ÄÃ£ lÆ°u trá»¯"
- [ ] CÃ³ button "KÃ­ch hoáº¡t láº¡i" Ä‘á»ƒ unarchive

### US-5: XÃ³a

**LÃ ** Admin  
**TÃ´i muá»‘n** xÃ³a rÄƒng giáº£ chÆ°a Ä‘Æ°á»£c sá»­ dá»¥ng  
**Äá»ƒ** dá»n dáº¹p data test hoáº·c nháº­p nháº§m

**Acceptance Criteria**:

- [ ] Chá»‰ cho xÃ³a náº¿u: ChÆ°a cÃ³ SupplierLaboPrice vÃ  chÆ°a cÃ³ LaboOrder
- [ ] Náº¿u Ä‘Ã£ dÃ¹ng: Hiá»ƒn thá»‹ error, gá»£i Ã½ dÃ¹ng "LÆ°u trá»¯"
- [ ] Confirmation: "XÃ³a vÄ©nh viá»…n [TÃªn]?"
- [ ] Success: XÃ³a khá»i database, refresh table

---

## ğŸ¨ UI Design

### Table View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Danh Má»¥c RÄƒng Giáº£               [ğŸ” TÃ¬m kiáº¿m...] [+ ThÃªm danh má»¥c] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TÃªn                    â”‚ NhÃ³m DV        â”‚ ÄÆ¡n vá»‹ â”‚ Actions    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RÄƒng sá»© kim loáº¡i       â”‚ RÄƒng sá»© KL    â”‚ RÄƒng   â”‚ [âœï¸][ğŸ“¦][ğŸ—‘ï¸] â”‚
â”‚ RÄƒng sá»© titan          â”‚ RÄƒng sá»© KL    â”‚ RÄƒng   â”‚ [âœï¸][ğŸ“¦][ğŸ—‘ï¸] â”‚
â”‚ RÄƒng sá»© Zirconia       â”‚ RÄƒng toÃ n sá»©  â”‚ RÄƒng   â”‚ [âœï¸][ğŸ“¦][ğŸ—‘ï¸] â”‚
â”‚ RÄƒng sá»© Katana         â”‚ RÄƒng toÃ n sá»©  â”‚ RÄƒng   â”‚ [âœï¸][ğŸ“¦][ğŸ—‘ï¸] â”‚
â”‚ HÃ m duy trÃ¬ Hawley     â”‚ Chá»‰nh nha     â”‚ CÃ¡i    â”‚ [âœï¸][ğŸ“¦][ğŸ—‘ï¸] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Hiá»ƒn thá»‹ 15 items                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Create/Edit Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [X] ThÃªm Danh Má»¥c RÄƒng Giáº£              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ TÃªn rÄƒng giáº£ *                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ RÄƒng sá»© Cercon                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚ NhÃ³m dá»‹ch vá»¥ *                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ RÄƒng toÃ n sá»©              â–¼         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚   (Dropdown tá»« MasterData: nhom-dich-vu-labo)â”‚
â”‚   LÆ°u key string: "rang-toan-su"       â”‚
â”‚   Options:                               â”‚
â”‚   - RÄƒng sá»© kim loáº¡i                    â”‚
â”‚   - RÄƒng toÃ n sá»©                        â”‚
â”‚   - Chá»‰nh nha                           â”‚
â”‚   - Phá»¥c hÃ¬nh thÃ¡o láº¯p                  â”‚
â”‚                                          â”‚
â”‚ ÄÆ¡n vá»‹ tÃ­nh *                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ RÄƒng                      â–¼         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚   (Dropdown tá»« MasterData: don-vi-tinh-labo)â”‚
â”‚   LÆ°u key string: "rang"                â”‚
â”‚   Options: RÄƒng, CÃ¡i, Bá»™, HÃ m          â”‚
â”‚                                          â”‚
â”‚ MÃ´ táº£                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ RÄƒng sá»© Cercon cao cáº¥p, mÃ u tá»±      â”‚ â”‚
â”‚ â”‚ nhiÃªn, bá»n bá»‰                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                          â”‚
â”‚          [Há»§y]  [LÆ°u]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Data Schema

### Prisma Model

```prisma
model LaboItem {
  id          String    @id @default(uuid())
  name        String    @unique

  // String values (not FK to MasterData)
  serviceGroup String  // "rang-toan-su"
  unit         String  // "rang"

  description String?
  archivedAt  DateTime? @db.Timestamptz

  // Metadata
  createdById String
  updatedById String
  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime  @updatedAt @db.Timestamptz

  // Relations
  createdBy        Employee             @relation("LaboItemCreatedBy", fields: [createdById], references: [id])
  updatedBy        Employee             @relation("LaboItemUpdatedBy", fields: [updatedById], references: [id])
  supplierPrices   SupplierLaboPrice[]
  orders           LaboOrder[]

  @@index([serviceGroup])
  @@index([archivedAt])
}
```

### Constants (Frontend)

**Note**: serviceGroupId vÃ  unitId lÆ°u trá»±c tiáº¿p string value (khÃ´ng pháº£i FK), tÆ°Æ¡ng tá»± pattern cá»§a CustomerSource.

#### LABO_SERVICE_GROUPS

```typescript
export const LABO_SERVICE_GROUPS = [
  {
    value: "rang-su-kim-loai",
    label: "RÄƒng sá»© kim loáº¡i",
    description: "RÄƒng sá»© phá»§ kim loáº¡i (IPL)",
  },
  {
    value: "rang-toan-su",
    label: "RÄƒng toÃ n sá»©",
    description: "RÄƒng sá»© nguyÃªn khá»‘i (Zirconia, Katana...)",
  },
  {
    value: "chinh-nha",
    label: "Chá»‰nh nha",
    description: "HÃ m duy trÃ¬, khÃ­ cá»¥ chá»‰nh nha",
  },
  {
    value: "phuc-hinh-thao-lap",
    label: "Phá»¥c hÃ¬nh thÃ¡o láº¯p",
    description: "HÃ m giáº£, khung hÃ m...",
  },
] as const;
```

#### LABO_UNITS

```typescript
export const LABO_UNITS = [
  { value: "rang", label: "RÄƒng" },
  { value: "cai", label: "CÃ¡i" },
  { value: "bo", label: "Bá»™" },
  { value: "ham", label: "HÃ m" },
] as const;
```

---

## ğŸ”„ API Specification

### Endpoints

#### GET `/api/v1/labo-items`

**Query**:

```typescript
{
  includeArchived?: boolean // Default false
}
```

**Response**:

```typescript
{
  items: LaboItemResponse[]
}
```

**Note**: Load táº¥t cáº£ dá»¯ liá»‡u, search vÃ  filter thá»±c hiá»‡n á»Ÿ frontend

#### POST `/api/v1/labo-items`

**Body**: `CreateLaboItemRequest`

```typescript
{
  name: string
  serviceGroup: string
  unit: string
  description?: string
}
```

#### PUT `/api/v1/labo-items/:id`

**Body**: `UpdateLaboItemRequest`

```typescript
{
  name?: string
  serviceGroup?: string
  unit?: string
  description?: string
}
```

#### PATCH `/api/v1/labo-items/:id/archive`

**Body**: Empty
**Response**: Success message

#### DELETE `/api/v1/labo-items/:id`

**Business Rule**: Chá»‰ xÃ³a náº¿u khÃ´ng cÃ³ SupplierLaboPrice vÃ  LaboOrder

---

## ğŸ” Permissions

### View

```typescript
"labo-items:view";
```

- Roles: admin only

### Create

```typescript
"labo-items:create";
```

- Roles: admin only

### Update

```typescript
"labo-items:update";
```

- Roles: admin only

### Delete

```typescript
"labo-items:delete";
```

- Roles: admin only

### Archive

```typescript
"labo-items:archive";
```

- Roles: admin only

---

## ğŸ” Validation Rules

### Create/Update

```typescript
CreateLaboItemRequestSchema = z.object({
  name: z
    .string()
    .min(2, "TÃªn pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±")
    .max(200, "TÃªn khÃ´ng quÃ¡ 200 kÃ½ tá»±"),

  serviceGroup: z.string().min(1, "Vui lÃ²ng chá»n nhÃ³m dá»‹ch vá»¥"),

  unit: z.string().min(1, "Vui lÃ²ng chá»n Ä‘Æ¡n vá»‹ tÃ­nh"),

  description: z.string().max(500, "MÃ´ táº£ khÃ´ng quÃ¡ 500 kÃ½ tá»±").optional(),
});
```

### Business Rules

1. **Unique name**: TÃªn khÃ´ng Ä‘Æ°á»£c trÃ¹ng (case-insensitive)
2. **Valid serviceGroup**: serviceGroup pháº£i lÃ  key há»£p lá»‡ tá»« MasterData group `nhom-dich-vu-labo`
3. **Valid unit**: unit pháº£i lÃ  key há»£p lá»‡ tá»« MasterData group `don-vi-tinh-labo`
4. **Cannot delete if used**: KhÃ´ng xÃ³a náº¿u cÃ³ liÃªn káº¿t vá»›i SupplierLaboPrice hoáº·c LaboOrder
5. **Archive instead**: Gá»£i Ã½ dÃ¹ng archive thay vÃ¬ xÃ³a

---

## ğŸ§ª Test Cases

### TC-1: Create Success

```
Given: User cÃ³ quyá»n táº¡o
When: Nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin há»£p lá»‡
Then:
  - LaboItem Ä‘Æ°á»£c táº¡o
  - Toast success
  - Table refresh
  - Modal Ä‘Ã³ng
```

### TC-2: Create - Duplicate Name

```
Given: ÄÃ£ tá»“n táº¡i "RÄƒng sá»© Katana"
When: Nháº­p name = "rÄƒng sá»© katana" (khÃ¡c case)
Then: Error "TÃªn Ä‘Ã£ tá»“n táº¡i"
```

### TC-3: Archive Success

```
Given: LaboItem Ä‘ang active
When: Click Archive â†’ Confirm
Then:
  - archivedAt = now()
  - Item áº©n khá»i dropdown
  - Váº«n hiá»ƒn thá»‹ trong table (filter archived)
```

### TC-4: Delete - Cannot Delete

```
Given: LaboItem Ä‘Ã£ cÃ³ SupplierLaboPrice
When: Click Delete
Then: Error "KhÃ´ng thá»ƒ xÃ³a. Vui lÃ²ng lÆ°u trá»¯ thay vÃ¬ xÃ³a."
```

### TC-5: Search Real-time (Frontend)

```
Given: CÃ³ 15 items Ä‘Ã£ load
When: Nháº­p "sá»©" vÃ o search box
Then:
  - Filter frontend chá»‰ hiá»ƒn thá»‹ items cÃ³ "sá»©" trong tÃªn
  - KhÃ´ng gá»i API
  - Cáº­p nháº­t sá»‘ lÆ°á»£ng hiá»ƒn thá»‹
```

---

## ğŸ“‹ Implementation Checklist

### Backend

- [ ] Prisma model: LaboItem
- [ ] Repository: `labo-item.repo.ts`
- [ ] Service: `labo-item.service.ts`
- [ ] Server Actions: `labo-item.actions.ts`
- [ ] API Routes: `/api/v1/labo-items/*`
- [ ] Validation: Zod schemas

### Frontend

- [ ] API client: `api.ts`
- [ ] React Query hooks: `useLaboItems`, `useCreateLaboItem`...
- [ ] Components:
  - [ ] `LaboItemTable.tsx`
  - [ ] `CreateLaboItemModal.tsx`
  - [ ] `EditLaboItemModal.tsx`
- [ ] View: `LaboItemsView.tsx`
- [ ] Constants: `labo-items/constants.ts`

### Master Data Setup

- [ ] Seed `nhom-dich-vu-labo` values
- [ ] Seed `don-vi-tinh-labo` values

---

## ğŸ”— Related Features

- **016.2 Labo Service Prices**: Sá»­ dá»¥ng LaboItem lÃ m reference
- **016.3 Labo Orders - Daily View**: Select LaboItem khi táº¡o order
- **016.4 Labo Reports**: Group by serviceGroup

---

**Version**: 1.0  
**Last Updated**: 2025-12-03  
**Status**: Ready for Implementation
