# ğŸ§© Requirements: Customer Detail - Appointments Tab

> **ğŸ“Š STATUS: PLANNING** - Phase 2 implementation  
> **ğŸ“„ Feature Documentation**: `docs/features/007.2_Customer_Detail_Appointments.md` (to be created)  
> **ğŸ”— Implementation**: `src/features/customers/components/detail-tabs/AppointmentsTab.tsx`  
> **ğŸ”— Dependencies**: Feature Appointment (completed), Customer Detail base (completed)

## ğŸ“Š Tham kháº£o

- **Base Feature**: `docs/requirements/008 Appointment.md` (completed)
- **Customer Detail Base**: `docs/requirements/007.1 Customer Detail.md` (Phase 1 completed)
- **Old Requirements**:
  - `docs/Dá»± Ã¡n cÅ©/07. customers/CUSTOMER_DETAIL_REQUIREMENTS.md`
  - `docs/Dá»± Ã¡n cÅ©/08. appointment/appointment-old-claude.md`
  - `docs/Dá»± Ã¡n cÅ©/08. appointment/appointment-old-codex.md`
- **Current Implementation**:
  - Appointment feature: `src/features/appointments/` (completed)
  - Customer Detail: `src/features/customers/views/CustomerDetailView.tsx` (tab placeholder exists)

## ğŸ¯ Má»¥c TiÃªu & Pháº¡m Vi

### Má»¥c Ä‘Ã­ch

Tab "Lá»‹ch háº¹n" trong Customer Detail cung cáº¥p:

- âœ… **Xem lá»‹ch háº¹n**: Danh sÃ¡ch appointments cá»§a customer (táº¥t cáº£: past, today, future)
- âœ… **Táº¡o lá»‹ch háº¹n**: Quick action Ä‘á»ƒ táº¡o appointment cho customer nÃ y
- âœ… **Quáº£n lÃ½ lá»‹ch háº¹n**: Edit, Delete, Confirm, Check-in, Check-out
- âœ… **Check-in status**: Hiá»ƒn thá»‹ tráº¡ng thÃ¡i check-in hÃ´m nay á»Ÿ Summary Card
- âœ… **Integration**: TÃ­ch há»£p vá»›i Appointment feature, reuse components

### Scope

- âœ… **AppointmentsTab Component**: Replace placeholder, hiá»ƒn thá»‹ appointment table
- âœ… **Summary Card Update**: ThÃªm check-in status display
- âœ… **Tab Count**: Hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng appointments `(N)`
- âœ… **Modal Integration**: Reuse `CreateAppointmentModal`, `UpdateAppointmentModal`
- âœ… **Quick Actions**: Táº¥t cáº£ appointment actions tá»« table
- âœ… **Data Sync**: Real-time updates sau CRUD operations

---

## ğŸ² Decision Log

### Component Reuse Strategy

- âœ… **Reuse AppointmentTable**: Import tá»« `@/features/appointments`
- âœ… **Hide customer column**: VÃ¬ Ä‘Ã£ á»Ÿ customer detail, khÃ´ng cáº§n hiá»ƒn thá»‹ thÃ´ng tin customer
- âœ… **Reuse modals**: `CreateAppointmentModal`, `UpdateAppointmentModal` tá»« appointments feature
- âœ… **Reuse hooks**: `useAppointments`, `useCreateAppointment`, `useUpdateAppointment`, `useDeleteAppointment`

### Data Flow

- âœ… **API Integration**: DÃ¹ng existing API `GET /api/v1/appointments?customerId=...`
- âœ… **Query filtering**: Client-side filter appointments by customerId
- âœ… **Real-time sync**: Invalidate queries sau create/update/delete
- âœ… **Customer refetch**: Refetch customer detail Ä‘á»ƒ update tab count

### Cross-Clinic View Strategy â­ **NEW**

- âœ… **Customer-Centric Approach**: Khi filter theo `customerId` â†’ Hiá»ƒn thá»‹ Táº¤T Cáº¢ appointments (cross-clinic)
- âœ… **Business Rationale**:
  - Customer cÃ³ thá»ƒ di chuyá»ƒn giá»¯a cÃ¡c cÆ¡ sá»Ÿ (VD: LÃ m 1 buá»•i á»Ÿ cÆ¡ sá»Ÿ khÃ¡c)
  - Employee cáº§n full context Ä‘á»ƒ tÆ° váº¥n tá»‘t hÆ¡n
  - TrÃ¡nh Ä‘áº·t trÃ¹ng lá»‹ch khi customer cÃ³ appointment á»Ÿ clinic khÃ¡c
- âœ… **Scope**: Chá»‰ Ã¡p dá»¥ng cho Customer Detail view, khÃ´ng áº£nh hÆ°á»Ÿng Daily/List view
- âœ… **Security**: Employee váº«n chá»‰ create/edit appointments cá»§a clinic mÃ¬nh (view-only cho clinic khÃ¡c)

### Check-in Status Logic

- âœ… **Source**: Customer's appointments array, filter by today
- âœ… **Calculation**: Check `appointmentDateTime` hÃ´m nay vÃ  `checkInTime !== null`
- âœ… **Display location**: Summary Card 1 (Customer info card)
- âœ… **UI**: Icon + text status (ÄÃ£ check-in / ChÆ°a check-in / KhÃ´ng cÃ³ lá»‹ch)

---

## 1. ğŸ“Š Backend Requirements

### 1.1 API Endpoint (Already Exists)

**GET /api/v1/appointments**

Query params Ä‘á»ƒ filter by customer:

```typescript
interface GetAppointmentsQuery {
  customerId?: string; // Filter by specific customer
  clinicId?: string; // Optional clinic filter
  page?: number; // Pagination
  pageSize?: number;
  sortField?: string;
  sortDirection?: "asc" | "desc";
}
```

**Backend Logic - Cross-Clinic View:** â­ **NEW**

```typescript
// appointment.service.ts - list()

async list(currentUser: UserCore | null, query: unknown) {
  requireAuth(currentUser);
  const parsed = GetAppointmentsQuerySchema.parse(query);
  const { customerId, clinicId, /* ... */ } = parsed;

  // NEW LOGIC: Customer-centric view
  let effectiveClinicId: string | undefined;

  if (customerId) {
    // CASE 1: Filter by customerId (Customer Detail view)
    // â†’ Show ALL appointments cá»§a customer (cross-clinic)
    effectiveClinicId = undefined; // â† No clinic filter

  } else {
    // CASE 2: General list (Appointments Daily/List view)
    // â†’ Employee chá»‰ tháº¥y appointments cá»§a clinic mÃ¬nh
    effectiveClinicId =
      currentUser?.role === "admin" ? clinicId : currentUser?.clinicId;

    if (!effectiveClinicId && currentUser?.role !== "admin") {
      throw new ServiceError(
        "MISSING_CLINIC",
        "NhÃ¢n viÃªn pháº£i thuá»™c vá» má»™t chi nhÃ¡nh",
        403
      );
    }
  }

  const { items, count } = await appointmentRepo.list({
    customerId,
    clinicId: effectiveClinicId, // â† Conditional clinic filter
    // ... other params
  });
  // ...
}
```

**Response:**

```typescript
interface AppointmentsListResponse {
  items: AppointmentResponse[]; // May include appointments from multiple clinics
  count: number;
  page: number;
  pageSize: number;
  totalPages: number;
}
```

### 1.2 Customer Detail API Enhancement

**GET /api/v1/customers/[id]** - ÄÃ£ cÃ³ appointments relation

Response includes appointments count:

```typescript
interface CustomerDetailResponse {
  // ... existing fields
  appointments: AppointmentResponse[]; // Full appointments list with relations
  _count?: {
    appointments: number; // Count for tab badge
  };
}
```

---

## 2. ğŸ¨ Frontend Architecture

### 2.1 Component Structure

```
src/features/customers/components/detail-tabs/
â””â”€â”€ AppointmentsTab.tsx                 # Main tab component

Uses from @/features/appointments:
â”œâ”€â”€ AppointmentTable                    # Table with actions
â”œâ”€â”€ CreateAppointmentModal              # Create appointment modal
â”œâ”€â”€ UpdateAppointmentModal              # Edit appointment modal
â”œâ”€â”€ useAppointments                     # Query appointments
â”œâ”€â”€ useCreateAppointment                # Mutation
â”œâ”€â”€ useUpdateAppointment                # Mutation
â””â”€â”€ useDeleteAppointment                # Mutation
```

### 2.2 AppointmentsTab Component

**Location**: `src/features/customers/components/detail-tabs/AppointmentsTab.tsx`

**Props Interface:**

```typescript
interface AppointmentsTabProps {
  customerId: string; // Customer ID Ä‘á»ƒ filter appointments
  customerName: string; // Hiá»ƒn thá»‹ trong modals
  clinicId: string; // Default clinic cho new appointments
  onAppointmentChange?: () => void; // Callback Ä‘á»ƒ refetch customer
}
```

**Features:**

- âœ… Header vá»›i Add button
- âœ… AppointmentTable vá»›i `isCustomerDetailView={true}` (hide customer + show full datetime)
- âœ… Modal states (create, edit)
- âœ… CRUD operations
- âœ… Loading & error states
- âœ… Empty state khi chÆ°a cÃ³ appointments

**Template Structure:**

```tsx
export default function AppointmentsTab({
  customerId,
  customerName,
  clinicId,
  onAppointmentChange,
}: AppointmentsTabProps) {
  // States
  const [openCreate, setOpenCreate] = useState(false);
  const [editingAppointment, setEditingAppointment] =
    useState<AppointmentResponse | null>(null);

  // Queries
  const { data, isLoading } = useAppointments({
    customerId, // Filter by customer
    pageSize: 100, // Load all for customer detail
    sortField: "appointmentDateTime",
    sortDirection: "desc",
  });

  // Mutations
  const createMutation = useCreateAppointment();
  const updateMutation = useUpdateAppointment();
  const deleteMutation = useDeleteAppointment();

  // Handlers
  const handleCreateSuccess = () => {
    setOpenCreate(false);
    onAppointmentChange?.(); // Refetch customer Ä‘á»ƒ update count
  };

  const handleUpdateSuccess = () => {
    setEditingAppointment(null);
    onAppointmentChange?.();
  };

  const handleDeleteSuccess = () => {
    onAppointmentChange?.();
  };

  return (
    <Space direction="vertical" size="middle" style={{ width: "100%" }}>
      {/* Header */}
      <Row justify="space-between" align="middle">
        <Col>
          <Typography.Title level={5}>
            Danh sÃ¡ch lá»‹ch háº¹n ({data?.count || 0})
          </Typography.Title>
        </Col>
        <Col>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => setOpenCreate(true)}
          >
            ThÃªm lá»‹ch háº¹n
          </Button>
        </Col>
      </Row>

      {/* Table */}
      <AppointmentTable
        data={data?.items || []}
        loading={isLoading}
        isCustomerDetailView={true} // Customer Detail context: hide customer + show full datetime
        onEdit={(apt) => setEditingAppointment(apt)}
        onDelete={(id) =>
          deleteMutation.mutate(id, {
            onSuccess: handleDeleteSuccess,
          })
        }
        onCheckIn={(id) =>
          updateMutation.mutate({
            id,
            body: { checkInTime: new Date() },
          })
        }
        onCheckOut={(id) =>
          updateMutation.mutate({
            id,
            body: { checkOutTime: new Date() },
          })
        }
        onConfirm={(id) =>
          updateMutation.mutate({
            id,
            body: { status: "ÄÃ£ xÃ¡c nháº­n" },
          })
        }
        onMarkNoShow={(id) =>
          updateMutation.mutate({
            id,
            body: { status: "KhÃ´ng Ä‘áº¿n" },
          })
        }
      />

      {/* Create Modal */}
      <CreateAppointmentModal
        open={openCreate}
        onCancel={() => setOpenCreate(false)}
        onSubmit={(payload) =>
          createMutation.mutate(payload, {
            onSuccess: handleCreateSuccess,
          })
        }
        defaultValues={{
          customerId, // Pre-fill customer
          clinicId, // Pre-fill clinic
        }}
      />

      {/* Edit Modal */}
      {editingAppointment && (
        <UpdateAppointmentModal
          open={!!editingAppointment}
          appointment={editingAppointment}
          onCancel={() => setEditingAppointment(null)}
          onSubmit={(payload, id) =>
            updateMutation.mutate(
              {
                id,
                body: payload,
              },
              {
                onSuccess: handleUpdateSuccess,
              }
            )
          }
        />
      )}
    </Space>
  );
}
```

---

## 3. ğŸ“ˆ Summary Card Enhancement

### 3.1 Check-in Status Display

**Location**: `src/features/customers/views/CustomerDetailView.tsx`

**Update Card 1** - Customer Basic Info Card:

```tsx
// Add check-in status calculation
const getTodayCheckInStatus = (customer: CustomerDetailResponse) => {
  const today = dayjs().format("YYYY-MM-DD");

  const todayAppointment = customer.appointments?.find((apt) => {
    const aptDate = dayjs(apt.appointmentDateTime).format("YYYY-MM-DD");
    return aptDate === today;
  });

  if (!todayAppointment) {
    return {
      status: "none",
      text: "KhÃ´ng cÃ³ lá»‹ch hÃ´m nay",
      color: "default",
    };
  }

  if (todayAppointment.checkInTime) {
    return {
      status: "checked-in",
      text: `ÄÃ£ check-in lÃºc ${dayjs(todayAppointment.checkInTime).format(
        "HH:mm"
      )}`,
      color: "success",
    };
  }

  return {
    status: "not-checked-in",
    text: "ChÆ°a check-in",
    color: "warning",
  };
};

// In render
const checkInStatus = getTodayCheckInStatus(customer);

// Display in Card 1
<Space>
  <ClockCircleOutlined />
  <Text type={checkInStatus.color}>{checkInStatus.text}</Text>
</Space>;
```

### 3.2 Tab Count Update

**Update Tabs** - Show appointment count:

```tsx
{
  key: "appointments",
  label: `Lá»‹ch háº¹n (${customer.appointments?.length || 0})`,
  children: (
    <AppointmentsTab
      customerId={customer.id}
      customerName={customer.fullName}
      clinicId={customer.clinicId}
      onAppointmentChange={() => refetch()}
    />
  )
}
```

---

## 4. ğŸ”„ Data Flow & State Management

### 4.1 Query Keys Strategy

```typescript
// Appointments filtered by customer
const appointmentsQueryKey = [
  "appointments",
  {
    customerId,
    pageSize: 100,
    sortField: "appointmentDateTime",
    sortDirection: "desc",
  },
];

// Customer detail query
const customerQueryKey = ["customer", customerId];
```

### 4.2 Mutation Side Effects

**After Create/Update/Delete Appointment:**

```typescript
// 1. Invalidate appointments list
queryClient.invalidateQueries(["appointments"]);

// 2. Refetch customer detail Ä‘á»ƒ update:
//    - Tab count
//    - Check-in status
//    - Summary data
queryClient.invalidateQueries(["customer", customerId]);

// 3. Show success notification
message.success(APPOINTMENT_MESSAGES.CREATE_SUCCESS);

// 4. Close modal
setOpenCreate(false);
```

### 4.3 Optimistic Updates (Optional Enhancement)

```typescript
// For instant UI feedback before API response
const updateMutation = useUpdateAppointment({
  onMutate: async (variables) => {
    // Cancel outgoing refetches
    await queryClient.cancelQueries(["appointments"]);

    // Snapshot previous value
    const previousData = queryClient.getQueryData(appointmentsQueryKey);

    // Optimistically update
    queryClient.setQueryData(appointmentsQueryKey, (old) => {
      // ... update logic
    });

    return { previousData };
  },
  onError: (err, variables, context) => {
    // Rollback on error
    queryClient.setQueryData(appointmentsQueryKey, context?.previousData);
  },
});
```

---

## 5. ğŸ¨ UI/UX Specifications

### 5.1 AppointmentsTab Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Danh sÃ¡ch lá»‹ch háº¹n (5)                    [+ ThÃªm lá»‹ch háº¹n] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  [AppointmentTable]                                          â”‚
â”‚  - Columns: Thá»i gian háº¹n, BÃ¡c sÄ© chÃ­nh, BÃ¡c sÄ© phá»¥,        â”‚
â”‚             Ghi chÃº, Tráº¡ng thÃ¡i, Check-in, Check-out,        â”‚
â”‚             Thao tÃ¡c                                          â”‚
â”‚  - NO Customer column (already in detail page)               â”‚
â”‚  - Sorted by appointmentDateTime DESC (má»›i nháº¥t trÆ°á»›c)       â”‚
â”‚  - All actions: Edit, Delete, Confirm, Check-in, Check-out  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Summary Card Enhancement

**Card 1 - Customer Basic Info (Updated):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ Nguyá»…n VÄƒn A (35 tuá»•i)              â”‚
â”‚ ğŸ†” MÃ£ KH: MK-2511-001                  â”‚
â”‚ ğŸ“ 0912345678                           â”‚
â”‚ ğŸ• ÄÃ£ check-in lÃºc 09:30               â”‚ â† NEW
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Card 2 - Financial (Unchanged for Phase 2):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ğŸ“‹ ChÆ°a cÃ³ dá»‹ch vá»¥ nÃ o Ä‘Æ°á»£c chá»‘t    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Empty State

Khi chÆ°a cÃ³ appointments:

```tsx
<Empty
  image={Empty.PRESENTED_IMAGE_SIMPLE}
  description={
    <>
      <Typography.Text type="secondary">
        KhÃ¡ch hÃ ng chÆ°a cÃ³ lá»‹ch háº¹n nÃ o
      </Typography.Text>
      <br />
      <Button type="link" onClick={() => setOpenCreate(true)}>
        Táº¡o lá»‹ch háº¹n Ä‘áº§u tiÃªn
      </Button>
    </>
  }
/>
```

### 5.4 Loading State

```tsx
<Spin tip="Äang táº£i danh sÃ¡ch lá»‹ch háº¹n...">
  <div style={{ minHeight: 300 }} />
</Spin>
```

---

## 6. ğŸ”§ Technical Implementation Details

### 6.1 AppointmentTable Props Configuration

```typescript
<AppointmentTable
  data={appointments}
  loading={isLoading}
  isCustomerDetailView={true} // â† Key prop: Customer Detail context
  // Pass all action handlers
  onEdit={handleEdit}
  onDelete={handleDelete}
  onCheckIn={handleCheckIn}
  onCheckOut={handleCheckOut}
  onConfirm={handleConfirm}
  onMarkNoShow={handleMarkNoShow}
  // Optional: customize action permissions
  actionLoading={updateMutation.isPending || deleteMutation.isPending}
/>
```

**Note on Cross-Clinic Permissions:** â­ **NEW**

AppointmentTable sáº½ tá»± Ä‘á»™ng disable action buttons cho appointments khÃ´ng thuá»™c clinic cá»§a employee:

```typescript
// In AppointmentTable component
const canEdit = (appointment: AppointmentResponse) => {
  const isAdmin = currentUser?.role === "admin";
  const isOwnClinic = appointment.clinicId === currentUser?.clinicId;

  // Admin: edit all
  if (isAdmin) return true;

  // Employee: only own clinic
  return isOwnClinic;
};

// Apply to action buttons
<Button
  onClick={() => onEdit(record)}
  disabled={!canEdit(record)} // â† Conditional disable
>
  Sá»­a
</Button>;
```

### 6.2 CreateAppointmentModal Pre-fill

```typescript
<CreateAppointmentModal
  open={openCreate}
  selectedClinicId={clinicId} // Pre-fill clinic
  prefilledCustomer={{
    // Pre-fill customer (disabled field)
    id: customer.id,
    customerCode: customer.customerCode,
    fullName: customer.fullName,
    phone: customer.phone,
  }}
  onCancel={handleCancel}
  onSubmit={handleSubmit}
  confirmLoading={createMutation.isPending}
/>
```

**Pattern**: Pass full customer object (not just ID) Ä‘á»ƒ hiá»ƒn thá»‹ label trong disabled Select field. Consistent vá»›i UpdateAppointmentModal pattern.

### 6.3 Modal Behavior

**Create Modal:**

- Pre-fill `customerId` (disabled field - khÃ´ng cho Ä‘á»•i)
- Pre-fill `clinicId` (cÃ³ thá»ƒ Ä‘á»•i náº¿u admin)
- User chá»n: `appointmentDateTime`, `primaryDentistId`, `duration`, etc.
- Submit â†’ Create appointment â†’ Refetch customer â†’ Show success

**Edit Modal:**

- Load existing appointment data
- Follow standard permission rules (timeline-based)
- Submit â†’ Update appointment â†’ Refetch customer â†’ Show success

---

## 7. ğŸ”’ Permissions & Business Rules

### 7.1 View Permissions

- âœ… **Employee**:
  - **Customer Detail context**: Xem Táº¤T Cáº¢ appointments cá»§a customer Ä‘Ã³ (cross-clinic) â­
  - **Daily/List context**: Chá»‰ xem appointments cá»§a clinic mÃ¬nh
  - **Rationale**: Customer-centric view - Employee cáº§n full context Ä‘á»ƒ tÆ° váº¥n
- âœ… **Admin**: Xem táº¥t cáº£ appointments (khÃ´ng giá»›i háº¡n)

### 7.2 Action Permissions

**Create Appointment:**

- âœ… Employee & Admin Ä‘á»u cÃ³ thá»ƒ táº¡o
- âœ… Employee chá»‰ táº¡o cho clinic cá»§a mÃ¬nh (khÃ´ng thá»ƒ táº¡o cho clinic khÃ¡c)
- âœ… Validation: KhÃ´ng táº¡o past appointments
- âœ… Conflict check: 1 customer/1 appointment/day (cross-clinic check)

**Edit Appointment:**

- âœ… Employee chá»‰ edit appointments cá»§a clinic mÃ¬nh (view-only cho clinic khÃ¡c)
- âœ… Past: Admin only
- âœ… Today: Both (limited fields for Employee, own clinic only)
- âœ… Future: Both (full edit, own clinic only)

**Delete Appointment:**

- âœ… Employee chá»‰ delete appointments cá»§a clinic mÃ¬nh
- âœ… Past/Today: Admin only
- âœ… Future: Both (own clinic only for Employee)

**Quick Actions (Check-in, Check-out, Confirm, No-show):**

- âœ… Employee chá»‰ thá»±c hiá»‡n actions trÃªn appointments cá»§a clinic mÃ¬nh
- âœ… Follow standard appointment business rules
- âœ… Check-in: Today appointments, allowed statuses
- âœ… No-show: After appointment time, not checked-in

**Permission Summary:**

- ğŸ‘ï¸ **VIEW**: All appointments (cross-clinic)
- âœï¸ **EDIT/DELETE/ACTIONS**: Own clinic only (Employee), All clinics (Admin)

### 7.3 Validation Rules (Inherited from Appointment Feature)

- âœ… **1 Customer/1 Appointment/Day**: Enforced at service layer
- âœ… **No Past Appointments**: Cannot create appointment in past
- âœ… **Reschedule Logic**: Change date â†’ reset status + clear check-in/out
- âœ… **Check-in Rules**: Auto-set status = "ÄÃ£ Ä‘áº¿n"
- âœ… **Status Transitions**: Follow allowed transitions

---

## 8. ğŸ§ª Testing Considerations

### 8.1 Component Testing

```typescript
describe("AppointmentsTab", () => {
  it("should render empty state when no appointments", () => {
    // Test empty state display
  });

  it("should hide customer column and show full datetime in table", () => {
    // Verify isCustomerDetailView prop working (hides customer + shows DD/MM/YYYY HH:mm)
  });

  it("should open create modal with pre-filled values", () => {
    // Test modal with customerId, clinicId pre-filled
  });

  it("should handle create appointment success", () => {
    // Test onAppointmentChange callback called
  });

  it("should display appointments sorted by date DESC", () => {
    // Test sorting logic
  });
});
```

### 8.2 Integration Testing

```typescript
describe("Customer Detail - Appointments Integration", () => {
  it("should update tab count after create appointment", () => {
    // Create appointment â†’ verify count increases
  });

  it("should update check-in status after check-in", () => {
    // Check-in â†’ verify summary card shows status
  });

  it("should refetch customer data after CRUD operations", () => {
    // Verify queryClient invalidation working
  });
});
```

### 8.3 E2E Testing Scenarios

```typescript
// Scenario 1: Create first appointment
- Navigate to customer detail
- Open Appointments tab
- Click "ThÃªm lá»‹ch háº¹n"
- Fill form (pre-filled customer)
- Submit
- Verify: Tab count = 1, table shows new appointment

// Scenario 2: Check-in from customer detail
- Customer has appointment today
- Summary card shows "ChÆ°a check-in"
- Click check-in in table
- Verify: Summary card shows "ÄÃ£ check-in lÃºc HH:mm"

// Scenario 3: Edit appointment
- Click edit button
- Modify appointment details
- Submit
- Verify: Table updated, customer refetched
```

---

## 9. ğŸ“Š Performance Considerations

### 9.1 Data Loading Strategy

```typescript
// Load all customer appointments at once (acceptable for detail page)
const { data } = useAppointments({
  customerId,
  pageSize: 100, // Reasonable limit for single customer
  sortField: "appointmentDateTime",
  sortDirection: "desc",
});
```

**Rationale:**

- Single customer typically has < 100 appointments
- No pagination needed (display all in table)
- Client-side sorting/filtering works well

### 9.2 Query Caching

```typescript
// Cache appointments query for 5 minutes
const { data } = useAppointments(params, {
  staleTime: 5 * 60 * 1000, // 5 minutes
  cacheTime: 10 * 60 * 1000, // 10 minutes
});
```

### 9.3 Optimizations

- âœ… **Reuse AppointmentTable**: Avoid duplicate code
- âœ… **Conditional rendering**: Only render modals when open
- âœ… **Memoization**: Memo expensive calculations (check-in status, counts)
- âœ… **Lazy loading**: Tab content only renders when active

```typescript
// Memo check-in status calculation
const checkInStatus = useMemo(
  () => getTodayCheckInStatus(customer),
  [customer.appointments]
);
```

---

## 10. ğŸš€ Implementation Checklist

### Phase 2.1: Core Implementation

- [ ] **Update AppointmentsTab.tsx**: Replace placeholder vá»›i full implementation
- [ ] **Props interface**: Define AppointmentsTabProps
- [ ] **Import components**: AppointmentTable, modals tá»« appointments feature
- [ ] **Import hooks**: useAppointments, mutations tá»« appointments feature
- [ ] **State management**: Modal states (create, edit)
- [ ] **Query setup**: useAppointments vá»›i customerId filter (cross-clinic) â­
- [ ] **Handlers**: Create, update, delete handlers vá»›i clinic permission check â­
- [ ] **Table integration**: Render AppointmentTable vá»›i isCustomerDetailView
- [ ] **Modal integration**: CreateAppointmentModal vá»›i pre-fill
- [ ] **Modal integration**: UpdateAppointmentModal
- [ ] **Empty state**: Handle no appointments case
- [ ] **Loading state**: Spinner during data fetch
- [ ] **Permission handling**: Disable actions cho appointments cá»§a clinic khÃ¡c â­

### Phase 2.2: Summary Card Enhancement

- [ ] **Check-in status function**: getTodayCheckInStatus implementation
- [ ] **Summary Card update**: Add check-in status display
- [ ] **Icon selection**: Choose appropriate icons (ClockCircleOutlined, CheckCircleOutlined)
- [ ] **Color coding**: Warning (chÆ°a check-in), Success (Ä‘Ã£ check-in), Default (khÃ´ng cÃ³ lá»‹ch)

### Phase 2.3: Tab Count

- [ ] **CustomerDetailView update**: Calculate appointment count
- [ ] **Tab label update**: Show count `Lá»‹ch háº¹n (N)`
- [ ] **Pass refetch callback**: onAppointmentChange prop

### Phase 2.4: Testing & Polish

- [ ] **Component tests**: AppointmentsTab unit tests
- [ ] **Integration tests**: Data sync, refetch behavior
- [ ] **Manual testing**: All CRUD operations
- [ ] **Permission testing**: Employee vs Admin actions
- [ ] **Cross-clinic testing**: Employee view all, edit own clinic only â­
- [ ] **Error handling**: Test error scenarios
- [ ] **Performance testing**: Load customer with many appointments

### Phase 2.5: Documentation

- [ ] **Feature doc**: Create `007.2_Customer_Detail_Appointments.md`
- [ ] **Code comments**: Document complex logic
- [ ] **Props documentation**: JSDoc for AppointmentsTab props

---

## 11. ğŸ”® Future Enhancements (Phase 3+)

### 11.1 Quick Check-in from Customer List

**Feature**: Check-in button trong Customer List/Daily view

```typescript
// Customer List/Daily: Add check-in button
<Button
  size="small"
  onClick={() => handleQuickCheckIn(customer.id)}
  disabled={!customer.todayAppointment || customer.todayAppointment.checkInTime}
>
  Check-in
</Button>
```

**API**: `POST /api/v1/customers/{id}/checkin`

**Logic:**

- CÃ³ lá»‹ch hÃ´m nay â†’ Update appointment (set checkInTime, status = "ÄÃ£ Ä‘áº¿n")
- KhÃ´ng cÃ³ lá»‹ch (walk-in) â†’ Táº¡o appointment má»›i vá»›i status "Äáº¿n Ä‘á»™t xuáº¥t"

### 11.2 Advanced Features

- **Calendar view**: Display appointments trong calendar
- **Appointment reminders**: Email/SMS notifications
- **Recurring appointments**: Support for recurring schedules
- **Appointment notes**: Rich text editor for notes
- **File attachments**: Attach documents to appointments
- **Appointment history timeline**: Visual timeline view

### 11.3 Analytics

- **Show statistics**: Appointment completion rate, no-show rate
- **Trend charts**: Appointments over time
- **Dentist workload**: Appointments by dentist

---

## 12. ğŸ“ API Contract Summary

### GET /api/v1/appointments (Existing)

```typescript
// Query
interface GetAppointmentsQuery {
  customerId?: string; // â† Key param for customer detail
  clinicId?: string;
  page?: number;
  pageSize?: number;
  sortField?: string;
  sortDirection?: "asc" | "desc";
}

// Response
interface AppointmentsListResponse {
  items: AppointmentResponse[];
  count: number;
  page: number;
  pageSize: number;
  totalPages: number;
}
```

### GET /api/v1/customers/[id] (Existing)

```typescript
// Response includes appointments
interface CustomerDetailResponse {
  // ... customer fields
  appointments: AppointmentResponse[];
  _count?: {
    appointments: number;
  };
}
```

### POST /api/v1/appointments (Existing)

```typescript
// Request
interface CreateAppointmentRequest {
  customerId: string; // â† Pre-filled in customer detail
  appointmentDateTime: Date;
  duration: number;
  primaryDentistId: string;
  secondaryDentistId?: string;
  clinicId: string; // â† Pre-filled
  status: string;
  notes?: string;
}

// Response
interface AppointmentResponse {
  id: string;
  // ... all appointment fields
}
```

### PUT /api/v1/appointments/[id] (Existing)

```typescript
// Request (partial update)
interface UpdateAppointmentRequest {
  appointmentDateTime?: Date;
  duration?: number;
  primaryDentistId?: string;
  secondaryDentistId?: string;
  status?: string;
  checkInTime?: Date;
  checkOutTime?: Date;
  notes?: string;
}

// Response
interface AppointmentResponse {
  // ... updated appointment
}
```

---

## 13. ğŸ¯ Acceptance Criteria

### Core Functionality

âœ… **View Appointments**

- [ ] Tab "Lá»‹ch háº¹n" hiá»ƒn thá»‹ táº¥t cáº£ appointments cá»§a customer (cross-clinic) â­
- [ ] Table khÃ´ng hiá»ƒn thá»‹ customer column vÃ  hiá»ƒn thá»‹ full datetime (isCustomerDetailView=true)
- [ ] Appointments sorted by appointmentDateTime DESC (má»›i nháº¥t trÆ°á»›c)
- [ ] Hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§: thá»i gian (DD/MM/YYYY HH:mm), bÃ¡c sÄ©, tráº¡ng thÃ¡i, check-in/out, actions
- [ ] Employee xem Ä‘Æ°á»£c appointments á»Ÿ táº¥t cáº£ cÆ¡ sá»Ÿ (view-only cho cÆ¡ sá»Ÿ khÃ¡c) â­

âœ… **Create Appointment**

- [ ] Button "ThÃªm lá»‹ch háº¹n" má»Ÿ CreateAppointmentModal
- [ ] Modal pre-fill customerId (disabled), clinicId
- [ ] Submit táº¡o appointment thÃ nh cÃ´ng
- [ ] Tab count tá»± Ä‘á»™ng tÄƒng
- [ ] Table hiá»ƒn thá»‹ appointment má»›i

âœ… **Edit Appointment**

- [ ] Click edit button má»Ÿ UpdateAppointmentModal
- [ ] Modal load existing data
- [ ] Submit update thÃ nh cÃ´ng
- [ ] Table cáº­p nháº­t real-time

âœ… **Delete Appointment**

- [ ] Click delete button â†’ Confirmation
- [ ] Delete thÃ nh cÃ´ng
- [ ] Tab count tá»± Ä‘á»™ng giáº£m
- [ ] Table remove appointment

âœ… **Quick Actions**

- [ ] Check-in button (today appointments) â†’ Update checkInTime + status
- [ ] Check-out button (checked-in appointments) â†’ Update checkOutTime
- [ ] Confirm button (Chá» xÃ¡c nháº­n) â†’ Update status = "ÄÃ£ xÃ¡c nháº­n"
- [ ] No-show button (after time + not checked-in) â†’ Update status = "KhÃ´ng Ä‘áº¿n"

âœ… **Check-in Status Display**

- [ ] Summary Card hiá»ƒn thá»‹ "ÄÃ£ check-in lÃºc HH:mm" (today + checked-in)
- [ ] Summary Card hiá»ƒn thá»‹ "ChÆ°a check-in" (today + not checked-in)
- [ ] Summary Card hiá»ƒn thá»‹ "KhÃ´ng cÃ³ lá»‹ch hÃ´m nay" (no today appointment)
- [ ] Status color: Success (Ä‘Ã£ check-in), Warning (chÆ°a check-in), Default (khÃ´ng cÃ³)

âœ… **Tab Count**

- [ ] Tab label hiá»ƒn thá»‹ count: "Lá»‹ch háº¹n (N)"
- [ ] Count update sau create/delete
- [ ] Count khá»›p vá»›i sá»‘ appointments trong table

âœ… **Data Sync**

- [ ] Sau create â†’ Refetch customer â†’ Update count + check-in status
- [ ] Sau update â†’ Refetch customer â†’ Update check-in status náº¿u cáº§n
- [ ] Sau delete â†’ Refetch customer â†’ Update count
- [ ] Query invalidation working correctly

### Edge Cases

âœ… **Empty State**

- [ ] Hiá»ƒn thá»‹ empty state khi chÆ°a cÃ³ appointments
- [ ] Empty state cÃ³ button "Táº¡o lá»‹ch háº¹n Ä‘áº§u tiÃªn"

âœ… **Loading State**

- [ ] Spinner hiá»ƒn thá»‹ khi Ä‘ang load appointments
- [ ] Button loading state khi Ä‘ang submit

âœ… **Error Handling**

- [ ] Error message khi API fail
- [ ] Validation errors display correctly
- [ ] Network error handling

âœ… **Permissions**

- [ ] Employee xem Ä‘Æ°á»£c all appointments (cross-clinic) nhÆ°ng chá»‰ edit appointments cá»§a clinic mÃ¬nh â­
- [ ] Admin cÃ³ full access (view & edit all)
- [ ] Action buttons disabled theo permission rules (clinic-based for Employee)

---

## 14. ğŸ’¡ Tips & Best Practices

### Code Organization

```typescript
// âœ… Good: Reuse existing components
import { AppointmentTable } from "@/features/appointments";

// âŒ Bad: Copy-paste appointment table code
// Don't duplicate logic
```

### State Management

```typescript
// âœ… Good: Single source of truth
const { data } = useAppointments({ customerId });

// âŒ Bad: Multiple state copies
// Avoid duplicating appointment state
```

### Performance

```typescript
// âœ… Good: Memo expensive calculations
const checkInStatus = useMemo(
  () => getTodayCheckInStatus(customer),
  [customer.appointments]
);

// âŒ Bad: Calculate on every render
// Avoid recalculating in render
```

### Error Handling

```typescript
// âœ… Good: Graceful error handling
if (error) {
  return <Alert type="error" message={error.message} />;
}

// âŒ Bad: Let app crash
// Always handle errors
```

---

## 15. ğŸ“š Related Documentation

- **Base Feature**: `008 Appointment.md` - Appointment feature requirements
- **Customer Detail Base**: `007.1 Customer Detail.md` - Customer detail Phase 1
- **Customer List**: `007 Customer.md` - Customer management base feature
- **Guidelines**: `docs/GUIDELINES.md` - Project coding standards
- **Old Requirements**:
  - `CUSTOMER_DETAIL_REQUIREMENTS.md` - Original customer detail spec
  - `appointment-old-claude.md` - Original appointment spec (Claude)
  - `appointment-old-codex.md` - Original appointment spec (Codex)

---

## 16. ğŸ‰ Conclusion

Phase 2 implementation sáº½ hoÃ n thiá»‡n tab "Lá»‹ch háº¹n" trong Customer Detail báº±ng cÃ¡ch:

âœ… **Reuse existing components**: AppointmentTable, modals tá»« appointments feature  
âœ… **Integrate seamlessly**: Query filtering, data sync, permission checks  
âœ… **Enhance UX**: Check-in status display, tab counts, quick actions  
âœ… **Maintain consistency**: Follow established patterns, guidelines  
âœ… **Customer-centric view**: Employee xem Ä‘Æ°á»£c all appointments (cross-clinic) Ä‘á»ƒ cÃ³ full context â­  
âœ… **Smart permissions**: View all, edit own clinic only - CÃ¢n báº±ng giá»¯a transparency vÃ  security â­

Implementation nÃ y Ä‘áº£m báº£o code reusability, maintainability vÃ  user experience tá»‘t nháº¥t, Ä‘á»“ng thá»i giáº£i quyáº¿t use case thá»±c táº¿ khi customer di chuyá»ƒn giá»¯a cÃ¡c cÆ¡ sá»Ÿ.---

**Document Version**: 1.0  
**Created**: November 3, 2025  
**Author**: GitHub Copilot  
**Project**: Dr. Dee Dental Clinic Management System
