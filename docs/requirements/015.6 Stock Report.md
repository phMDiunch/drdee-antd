# üìä Requirements: Stock Balance Report - B√°o C√°o T·ªìn Kho

> **üìã STATUS: PENDING** - Giai ƒëo·∫°n 1, T√≠nh nƒÉng 6 (Ho√†n thi·ªán Core)  
> **üîó Parent**: `015 Inventory - Overview.md`  
> **üìÑ Implementation**: `src/features/inventory/reports/stock-balance/`  
> **‚ö†Ô∏è Dependencies**: 015.4 GRN, 015.5 GIN (ph·∫£i c√≥ d·ªØ li·ªáu StockQuant)

## üéØ M·ª•c Ti√™u

Cung c·∫•p "c·∫∑p m·∫Øt" ƒë·ªÉ ng∆∞·ªùi qu·∫£n l√Ω kho v√† ch·ªß ph√≤ng kh√°m:

- Bi·∫øt ch√≠nh x√°c **hi·ªán t·∫°i** trong kho c√≥ g√¨, bao nhi√™u
- T√≠nh ƒë∆∞·ª£c **t·ªïng gi√° tr·ªã t·ªìn kho** (quan tr·ªçng cho k·∫ø to√°n)
- Truy xu·∫•t chi ti·∫øt ƒë·∫øn t·ª´ng l√¥ nh·∫≠p ƒë·ªÉ ki·ªÉm tra ngu·ªìn g·ªëc
- Ch·ª©ng minh h·ªá th·ªëng FIFO ƒëang ho·∫°t ƒë·ªông ƒë√∫ng

## üìä Hai C·∫•p ƒê·ªô B√°o C√°o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  C·∫§P 1: T·ªîNG H·ª¢P THEO V·∫¨T T∆Ø          ‚îÇ
‚îÇ  (Summary by Material)                 ‚îÇ
‚îÇ  - Implant X: 50 c√°i - 5,000,000ƒë      ‚îÇ
‚îÇ  - GƒÉng tay M: 200 h·ªôp - 1,000,000ƒë    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  Click v√†o Implant X ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  C·∫§P 2: CHI TI·∫æT THEO L√î                           ‚îÇ
‚îÇ  (Detail by Batch/Receipt)                         ‚îÇ
‚îÇ  Implant X:                                        ‚îÇ
‚îÇ  - L√¥ t·ª´ PN-001: 10 c√°i @ 100k = 1,000k (HSD...)  ‚îÇ
‚îÇ  - L√¥ t·ª´ PN-005: 20 c√°i @ 110k = 2,200k (HSD...)  ‚îÇ
‚îÇ  - L√¥ t·ª´ PN-008: 20 c√°i @ 90k  = 1,800k (HSD...)  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ
‚îÇ  T·ªïng: 50 c√°i - 5,000,000ƒë                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã User Stories

### US-1: Xem B√°o C√°o T·ªïng H·ª£p

**L√† Qu·∫£n l√Ω**, t√¥i mu·ªën:

- Xem danh s√°ch t·∫•t c·∫£ v·∫≠t t∆∞ ƒëang c√≥ t·ªìn kho
- Bi·∫øt t·ªïng s·ªë l∆∞·ª£ng v√† t·ªïng gi√° tr·ªã c·ªßa t·ª´ng v·∫≠t t∆∞
- L·ªçc theo: Lo·∫°i v·∫≠t t∆∞, B·ªô m√¥n, Nh√≥m
- T√¨m ki·∫øm theo t√™n/m√£ v·∫≠t t∆∞
- S·∫Øp x·∫øp theo: Gi√° tr·ªã t·ªìn (cao ‚Üí th·∫•p), S·ªë l∆∞·ª£ng, T√™n

### US-2: Xem Chi Ti·∫øt Theo L√¥

**L√† Th·ªß Kho**, khi click v√†o 1 v·∫≠t t∆∞, t√¥i mu·ªën:

- Xem danh s√°ch t·∫•t c·∫£ "l√¥ n·ªôi b·ªô" c√≤n t·ªìn
- Bi·∫øt m·ªói l√¥:
  - Nh·∫≠p t·ª´ phi·∫øu n√†o, ng√†y n√†o
  - S·ªë L√¥ NSX & HSD
  - S·ªë l∆∞·ª£ng c√≤n l·∫°i
  - Gi√° v·ªën c·ªßa l√¥ ƒë√≥
  - Gi√° tr·ªã t·ªìn (qty √ó cost)
- S·∫Øp x·∫øp m·∫∑c ƒë·ªãnh theo FIFO (receiptDetailId ASC)

### US-3: Xu·∫•t Excel

**L√† K·∫ø To√°n**, t√¥i mu·ªën:

- Xu·∫•t b√°o c√°o t·ªïng h·ª£p ra Excel
- Xu·∫•t b√°o c√°o chi ti·∫øt (t·∫•t c·∫£ l√¥) ra Excel
- File Excel c√≥ format ƒë·∫πp, ƒë·ªß th√¥ng tin

### US-4: Dashboard Widget

**L√† Ch·ªß Ph√≤ng Kh√°m**, t√¥i mu·ªën:

- Xem t·ªïng gi√° tr·ªã t·ªìn kho hi·ªán t·∫°i (1 con s·ªë l·ªõn)
- Xem top 5 v·∫≠t t∆∞ gi√° tr·ªã t·ªìn cao nh·∫•t
- C·∫£nh b√°o s·ªë l∆∞·ª£ng v·∫≠t t∆∞ d∆∞·ªõi ƒë·ªãnh m·ª©c

## üé® UI/UX Requirements

### M√†n h√¨nh B√°o C√°o T·ªïng H·ª£p

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìä B√°o C√°o T·ªìn Kho                         [üì• Xu·∫•t Excel] [üîÑ Refresh] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üí∞ T·ªïng Gi√° Tr·ªã T·ªìn Kho: 125,450,000 VNƒê                                ‚îÇ
‚îÇ  üì¶ T·ªïng S·ªë Lo·∫°i V·∫≠t T∆∞: 45                                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Lo·∫°i: [T·∫•t c·∫£ ‚ñº] B·ªô m√¥n: [T·∫•t c·∫£ ‚ñº] Nh√≥m: [T·∫•t c·∫£ ‚ñº] üîç [T√¨m ki·∫øm...]  ‚îÇ
‚îÇ                                                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ M√£ VT   ‚îÇ T√™n V·∫≠t T∆∞        ‚îÇ ƒêVT‚îÇ T·ªìn ‚îÇ ƒê∆°n gi√° TB‚îÇ T·ªïng GT  ‚îÇ üëÅ ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ MAT0001 ‚îÇ Implant Nobel A.. ‚îÇC√°i‚îÇ  50 ‚îÇ  100,000  ‚îÇ5,000,000 ‚îÇüîç ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ MAT0003 ‚îÇ Composite 3M A3   ‚îÇL·ªç ‚îÇ  10 ‚îÇ  450,000  ‚îÇ4,500,000 ‚îÇüîç ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ MAT0002 ‚îÇ GƒÉng tay Latex M  ‚îÇH·ªôp‚îÇ 200 ‚îÇ    5,000  ‚îÇ1,000,000 ‚îÇüîç ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ MAT0005 ‚îÇ Abutment Straum.. ‚îÇC√°i‚îÇ  30 ‚îÇ   80,000  ‚îÇ2,400,000 ‚îÇüîç ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ...                                                                ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                       [‚óÄ] Trang 1 / 3 [‚ñ∂]                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Modal Chi Ti·∫øt Theo L√¥ (Click icon üîç)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üì¶ Chi Ti·∫øt T·ªìn Kho: Implant Nobel Active 4.3x10mm          [√ó]      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  M√£: MAT0001  |  ƒêVT: C√°i  |  T·ªïng t·ªìn: 50  |  T·ªïng GT: 5,000,000ƒë   ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ CHI TI·∫æT THEO L√î NH·∫¨P (S·∫Øp x·∫øp FIFO) ‚îÅ‚îÅ‚îÅ          [üì• Xu·∫•t Excel]‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Phi·∫øu Nh·∫≠p    ‚îÇ Ng√†y  ‚îÇ L√¥ NSX ‚îÇ HSD    ‚îÇ T·ªìn‚îÇ Gi√°  ‚îÇ T·ªïng GT ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ GRN-...-010   ‚îÇ15/1/25‚îÇLOT123  ‚îÇ12/2026 ‚îÇ 10 ‚îÇ100k  ‚îÇ1,000k   ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ GRN-...-015   ‚îÇ18/1/25‚îÇLOT456  ‚îÇ03/2027 ‚îÇ 20 ‚îÇ110k  ‚îÇ2,200k   ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îÇ GRN-...-020   ‚îÇ20/1/25‚îÇLOT789  ‚îÇ06/2027 ‚îÇ 20 ‚îÇ 90k  ‚îÇ1,800k   ‚îÇ ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  üí° L∆∞u √Ω: Khi xu·∫•t kho, h·ªá th·ªëng s·∫Ω ∆∞u ti√™n l·∫•y t·ª´ l√¥ tr√™n c√πng      ‚îÇ
‚îÇ           (FIFO: nh·∫≠p tr∆∞·ªõc xu·∫•t tr∆∞·ªõc)                                 ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  üìä Bi·ªÉu ƒë·ªì gi√° nh·∫≠p theo th·ªùi gian:                                   ‚îÇ
‚îÇ  [Mini chart showing price trend]                                       ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ                                            [ƒê√≥ng]                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dashboard Widget (T√≠ch h·ª£p v√†o Dashboard ch√≠nh)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üí∞ T·ªïng Gi√° Tr·ªã T·ªìn Kho                    ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ          125,450,000 VNƒê                    ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  üìä Top 5 V·∫≠t T∆∞ Gi√° Tr·ªã Cao:               ‚îÇ
‚îÇ  1. Implant Nobel A... 5,000,000ƒë  ‚ñà‚ñà‚ñà‚ñà‚ñà    ‚îÇ
‚îÇ  2. Composite 3M A3    4,500,000ƒë  ‚ñà‚ñà‚ñà‚ñà‚ñå    ‚îÇ
‚îÇ  3. Abutment Straum... 2,400,000ƒë  ‚ñà‚ñà‚ñå      ‚îÇ
‚îÇ  4. ...                                      ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  ‚ö†Ô∏è  3 v·∫≠t t∆∞ d∆∞·ªõi ƒë·ªãnh m·ª©c t·ªëi thi·ªÉu       ‚îÇ
‚îÇ                                              ‚îÇ
‚îÇ  [Xem Chi Ti·∫øt ‚Üí]                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Functional Requirements

### FR-1: Query B√°o C√°o T·ªïng H·ª£p

**Logic**: Aggregate t·ª´ b·∫£ng `StockQuant`

```typescript
async function getStockBalanceSummary(filters: {
  materialTypeId?: number;
  departmentId?: number;
  categoryId?: number;
  search?: string;
}) {
  // S·ª≠ d·ª•ng Prisma aggregate
  const summary = await prisma.stockQuant.groupBy({
    by: ["materialId"],
    where: {
      quantity: { gt: 0 }, // Ch·ªâ l·∫•y v·∫≠t t∆∞ c√≤n t·ªìn
      material: {
        isActive: true,
        ...(filters.materialTypeId && {
          materialTypeId: filters.materialTypeId,
        }),
        ...(filters.departmentId && { departmentId: filters.departmentId }),
        ...(filters.search && {
          OR: [
            { name: { contains: filters.search, mode: "insensitive" } },
            { code: { contains: filters.search, mode: "insensitive" } },
          ],
        }),
      },
    },
    _sum: {
      quantity: true,
    },
  });

  // Enrich v·ªõi th√¥ng tin v·∫≠t t∆∞ v√† t√≠nh gi√° tr·ªã
  const enriched = await Promise.all(
    summary.map(async (item) => {
      const material = await prisma.material.findUnique({
        where: { id: item.materialId },
        include: { uom: true, materialType: true, department: true },
      });

      // T√≠nh t·ªïng gi√° tr·ªã = sum(qty * unitPrice c·ªßa t·ª´ng quant)
      const totalValue = await prisma.stockQuant.aggregate({
        where: { materialId: item.materialId, quantity: { gt: 0 } },
        _sum: {
          // C·∫ßn join v·ªõi receiptDetail ƒë·ªÉ l·∫•y unitPrice
          // Prisma kh√¥ng h·ªó tr·ª£ computed field trong aggregate
          // ‚Üí C·∫ßn raw query ho·∫∑c t√≠nh b·∫±ng code
        },
      });

      return {
        materialId: item.materialId,
        materialCode: material.code,
        materialName: material.name,
        uom: material.uom.value,
        totalQuantity: item._sum.quantity,
        averageUnitPrice: totalValue / item._sum.quantity,
        totalValue: totalValue,
      };
    })
  );

  return enriched;
}
```

**L∆∞u √Ω**: Do Prisma c√≥ gi·ªõi h·∫°n trong aggregate ph·ª©c t·∫°p, c√≥ th·ªÉ c·∫ßn:

- Raw SQL query v·ªõi JOIN
- Ho·∫∑c t·∫°o database VIEW
- Ho·∫∑c t√≠nh to√°n ·ªü application layer

### FR-2: Query B√°o C√°o Chi Ti·∫øt Theo L√¥

**Logic**: L·∫•y tr·ª±c ti·∫øp t·ª´ `StockQuant` v·ªõi JOIN

```typescript
async function getStockBalanceDetail(materialId: number) {
  const details = await prisma.stockQuant.findMany({
    where: {
      materialId: materialId,
      quantity: { gt: 0 },
    },
    include: {
      receiptDetail: {
        include: {
          goodsReceipt: {
            select: {
              code: true,
              receiptDate: true,
              supplier: { select: { name: true } },
            },
          },
        },
      },
    },
    orderBy: {
      goodsReceiptDetailId: "asc", // FIFO order
    },
  });

  return details.map((quant) => ({
    goodsReceiptCode: quant.receiptDetail.goodsReceipt.code,
    receiptDate: quant.receiptDetail.goodsReceipt.receiptDate,
    supplierName: quant.receiptDetail.goodsReceipt.supplier.name,
    batchNo: quant.receiptDetail.batchNo,
    expiryDate: quant.receiptDetail.expiryDate,
    quantity: quant.quantity,
    unitCost: quant.receiptDetail.unitPrice,
    totalValue: quant.quantity * quant.receiptDetail.unitPrice,
  }));
}
```

### FR-3: T√≠nh T·ªïng Gi√° Tr·ªã T·ªìn Kho (Dashboard)

```typescript
async function getTotalStockValue(): Promise<number> {
  // Raw query ƒë·ªÉ performance t·ªët h∆°n
  const result = await prisma.$queryRaw`
    SELECT SUM(sq.quantity * grd.unit_price) as total_value
    FROM stock_quant sq
    JOIN goods_receipt_detail grd ON sq.goods_receipt_detail_id = grd.id
    WHERE sq.quantity > 0
  `;

  return result[0].total_value || 0;
}
```

### FR-4: API Endpoints

```
GET    /api/inventory/reports/stock-balance/summary?typeId=&deptId=&categoryId=&search=
GET    /api/inventory/reports/stock-balance/detail/:materialId
GET    /api/inventory/reports/stock-balance/total-value
GET    /api/inventory/reports/stock-balance/export-excel?format=summary|detail
GET    /api/inventory/reports/stock-balance/low-stock    # V·∫≠t t∆∞ d∆∞·ªõi ƒë·ªãnh m·ª©c
```

### FR-5: Xu·∫•t Excel

**Library**: `exceljs` ho·∫∑c `xlsx`

```typescript
import ExcelJS from "exceljs";

async function exportStockBalanceToExcel(data: StockBalanceSummary[]) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet("T·ªìn Kho");

  // Header
  worksheet.columns = [
    { header: "M√£ VT", key: "code", width: 12 },
    { header: "T√™n V·∫≠t T∆∞", key: "name", width: 30 },
    { header: "ƒêVT", key: "uom", width: 10 },
    { header: "S·ªë L∆∞·ª£ng T·ªìn", key: "qty", width: 15 },
    { header: "ƒê∆°n Gi√° TB", key: "avgPrice", width: 15 },
    { header: "T·ªïng Gi√° Tr·ªã", key: "totalValue", width: 15 },
  ];

  // Data
  data.forEach((item) => {
    worksheet.addRow({
      code: item.materialCode,
      name: item.materialName,
      uom: item.uom,
      qty: item.totalQuantity,
      avgPrice: item.averageUnitPrice,
      totalValue: item.totalValue,
    });
  });

  // Styling
  worksheet.getRow(1).font = { bold: true };
  worksheet.getRow(1).fill = {
    type: "pattern",
    pattern: "solid",
    fgColor: { argb: "FFD9D9D9" },
  };

  // Number format
  worksheet.getColumn("avgPrice").numFmt = "#,##0";
  worksheet.getColumn("totalValue").numFmt = "#,##0";

  // Total row
  const lastRow = worksheet.lastRow.number + 1;
  worksheet.getCell(`E${lastRow}`).value = "T·ªîNG C·ªòNG:";
  worksheet.getCell(`F${lastRow}`).value = {
    formula: `SUM(F2:F${lastRow - 1})`,
  };
  worksheet.getRow(lastRow).font = { bold: true };

  return workbook;
}
```

## üíæ Data Model

**Kh√¥ng c·∫ßn b·∫£ng m·ªõi**. B√°o c√°o n√†y query t·ª´:

- `StockQuant` (t·ªìn kho hi·ªán t·∫°i)
- `GoodsReceiptDetail` (gi√° v·ªën, l√¥ NSX, HSD)
- `GoodsReceipt` (ng√†y nh·∫≠p, NCC)
- `Material` (th√¥ng tin v·∫≠t t∆∞)

### Database View (Optional - T·ªëi ∆∞u performance)

```sql
CREATE VIEW vw_stock_balance_summary AS
SELECT
  m.id as material_id,
  m.code as material_code,
  m.name as material_name,
  uom.value as uom_name,
  SUM(sq.quantity) as total_quantity,
  SUM(sq.quantity * grd.unit_price) as total_value,
  SUM(sq.quantity * grd.unit_price) / NULLIF(SUM(sq.quantity), 0) as avg_unit_price
FROM stock_quant sq
JOIN goods_receipt_detail grd ON sq.goods_receipt_detail_id = grd.id
JOIN material m ON sq.material_id = m.id
JOIN system_dictionary uom ON m.uom_id = uom.id
WHERE sq.quantity > 0 AND m.is_active = true
GROUP BY m.id, m.code, m.name, uom.value;
```

**L·ª£i √≠ch**: Query nhanh h∆°n, Prisma c√≥ th·ªÉ map view nh∆∞ table

## üß™ Test Cases

### TC-1: Query t·ªïng h·ª£p

- **Input**: GET /stock-balance/summary
- **Expected**: Tr·∫£ v·ªÅ danh s√°ch v·∫≠t t∆∞ v·ªõi qty, value ƒë√∫ng

### TC-2: Filter theo b·ªô m√¥n

- **Input**: GET /stock-balance/summary?deptId=1
- **Expected**: Ch·ªâ hi·ªÉn th·ªã v·∫≠t t∆∞ thu·ªôc b·ªô m√¥n 1

### TC-3: Search theo t√™n

- **Input**: GET /stock-balance/summary?search=implant
- **Expected**: Tr·∫£ v·ªÅ v·∫≠t t∆∞ c√≥ t√™n ch·ª©a "implant"

### TC-4: Chi ti·∫øt theo l√¥ - s·∫Øp x·∫øp FIFO

- **Input**: GET /stock-balance/detail/1
- **Expected**: Danh s√°ch l√¥ s·∫Øp x·∫øp theo goodsReceiptDetailId ASC

### TC-5: T·ªïng gi√° tr·ªã kho

- **Input**: GET /stock-balance/total-value
- **Expected**: Tr·∫£ v·ªÅ 1 s·ªë (t·ªïng ti·ªÅn)

### TC-6: Xu·∫•t Excel

- **Input**: GET /stock-balance/export-excel
- **Expected**: Download file .xlsx, format ƒë√∫ng

### TC-7: Low stock alert

- **Input**: GET /stock-balance/low-stock
- **Expected**: Tr·∫£ v·ªÅ v·∫≠t t∆∞ c√≥ qty < minStockLevel

### TC-8: Verify t√≠nh to√°n

- **Setup**:
  - Material A: Quant 1 (10@100k), Quant 2 (20@110k)
- **Expected**:
  - Total qty = 30
  - Total value = 3,200,000
  - Avg price = 106,667

## üéØ Acceptance Criteria

- [ ] B√°o c√°o t·ªïng h·ª£p hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß: M√£, T√™n, ƒêVT, T·ªìn, Gi√° TB, T·ªïng GT
- [ ] Filter theo Lo·∫°i/B·ªô m√¥n/Nh√≥m ho·∫°t ƒë·ªông
- [ ] Search theo t√™n/m√£ ho·∫°t ƒë·ªông
- [ ] Click icon xem chi ti·∫øt m·ªü modal ƒë√∫ng
- [ ] Modal chi ti·∫øt hi·ªÉn th·ªã t·∫•t c·∫£ l√¥ c√≤n t·ªìn
- [ ] L√¥ s·∫Øp x·∫øp theo FIFO (receiptDetailId ASC)
- [ ] Hi·ªÉn th·ªã: S·ªë phi·∫øu nh·∫≠p, Ng√†y, L√¥ NSX, HSD, T·ªìn, Gi√°, GT
- [ ] T√≠nh t·ªïng gi√° tr·ªã t·ªìn kho ch√≠nh x√°c
- [ ] Xu·∫•t Excel v·ªõi format ƒë·∫πp, ƒë·∫ßy ƒë·ªß
- [ ] Dashboard widget hi·ªÉn th·ªã t·ªïng gi√° tr·ªã
- [ ] C·∫£nh b√°o v·∫≠t t∆∞ d∆∞·ªõi ƒë·ªãnh m·ª©c
- [ ] Performance t·ªët (< 1s v·ªõi 1000 v·∫≠t t∆∞)

## üöÄ Performance Optimization

### Strategies:

1. **Database View**: T·∫°o view cho summary query
2. **Indexing**: Index tr√™n `StockQuant(materialId, quantity)`
3. **Caching**: Cache total value (refresh m·ªói 5 ph√∫t)
4. **Pagination**: Lu√¥n lu√¥n paginate cho summary
5. **Background Job**: T√≠nh to√°n n·∫∑ng ch·∫°y background

```typescript
// Redis cache example
async function getCachedTotalValue(): Promise<number> {
  const cached = await redis.get("stock:total_value");
  if (cached) return parseFloat(cached);

  const value = await getTotalStockValue();
  await redis.setex("stock:total_value", 300, value.toString()); // 5 min
  return value;
}
```

## üìà Bi·ªÉu ƒê·ªì & Visualization (Phase 4)

**ƒê·ªÅ xu·∫•t cho t∆∞∆°ng lai**:

- Line chart: Gi√° nh·∫≠p theo th·ªùi gian (theo v·∫≠t t∆∞)
- Pie chart: Ph√¢n b·ªë gi√° tr·ªã t·ªìn theo b·ªô m√¥n
- Bar chart: Top 10 v·∫≠t t∆∞ gi√° tr·ªã cao
- Heatmap: T·ªìn kho theo th√°ng

---

**Priority**: üü° High (C·∫ßn ƒë·ªÉ verify FIFO ho·∫°t ƒë·ªông ƒë√∫ng)  
**Estimated Effort**: 2-3 ng√†y  
**Dependencies**: 015.4 GRN, 015.5 GIN (c·∫ßn c√≥ d·ªØ li·ªáu StockQuant)
