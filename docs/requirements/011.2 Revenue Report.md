# ğŸ§© Requirements: Revenue Report System (BÃ¡o cÃ¡o Doanh thu)

> **ğŸ“‹ STATUS: ğŸ”„ IN PROGRESS** - New implementation needed  
> **ğŸ”— Implementation**: `src/features/reports/revenue/`  
> **ğŸ”§ Last Updated**: 2025-11-14 - New design version

## ğŸ“Š Tham kháº£o

- Prisma Models: `PaymentVoucher`, `PaymentVoucherDetail`, `ConsultedService`, `Customer`, `Employee`, `DentalService`, `Clinic`
- Related: `010 Payment.md`, `009 Consulted-Service.md`, `006 Dental Service.md`
- Old Spec: `docs/requirements/011 Report.md` (deprecated)

## ğŸ¯ Má»¥c TiÃªu

BÃ¡o cÃ¡o Doanh thu lÃ  há»‡ thá»‘ng phÃ¢n tÃ­ch **tiá»n thá»±c thu tá»« thanh toÃ¡n** (PaymentVoucherDetail) trong khoáº£ng thá»i gian Ä‘Æ°á»£c chá»n, phÃ¢n tÃ­ch theo nhiá»u chiá»u:

- ğŸ“… **Theo ngÃ y**: Xu hÆ°á»›ng doanh thu hÃ ng ngÃ y
- ğŸ‘¥ **Theo nguá»“n khÃ¡ch hÃ ng**: Nguá»“n nÃ o mang láº¡i doanh thu cao nháº¥t
- ğŸ¦· **Theo dá»‹ch vá»¥ & nhÃ³m dá»‹ch vá»¥**: Dá»‹ch vá»¥ nÃ o thu Ä‘Æ°á»£c nhiá»u tiá»n nháº¥t
- ğŸ‘¨â€âš•ï¸ **Theo BÃ¡c sÄ© Ä‘iá»u trá»‹**: ÄÃ³ng gÃ³p doanh thu cá»§a tá»«ng bÃ¡c sÄ© Ä‘iá»u trá»‹

**Äá»‘i tÆ°á»£ng ngÆ°á»i dÃ¹ng**:

- **Admin**: Xem táº¥t cáº£ clinics + tá»«ng clinic riÃªng láº»
- **Employee (non-admin)**: Chá»‰ xem clinic cá»§a mÃ¬nh

**LÆ°u Ã½ quan trá»ng**:

- Revenue â‰  Sales: Revenue lÃ  tiá»n thá»±c thu (cÃ³ thá»ƒ thanh toÃ¡n tá»«ng pháº§n), Sales lÃ  giÃ¡ trá»‹ dá»‹ch vá»¥ khi chá»‘t
- Filter theo `paymentDate` (ngÃ y thanh toÃ¡n), khÃ´ng pháº£i `serviceConfirmDate`
- Chá»‰ tÃ­nh payment details cÃ³ liÃªn káº¿t vá»›i ConsultedService (bá» qua cÃ¡c khoáº£n thanh toÃ¡n khÃ¡c)

---

## ğŸ² Decision Log

### Business Rules

- âœ… **Data Source**: `PaymentVoucherDetail` vá»›i Ä‘iá»u kiá»‡n:
  - `paymentVoucher.paymentDate` trong thÃ¡ng Ä‘Æ°á»£c chá»n (YYYY-MM)
  - `consultedServiceId IS NOT NULL` (chá»‰ tÃ­nh thanh toÃ¡n cho dá»‹ch vá»¥)
- âœ… **Metric Calculation**:

  - **Total Revenue**: `SUM(detail.amount)` - Tá»•ng tiá»n thá»±c thu
  - **Total Transactions**: `COUNT(DISTINCT paymentVoucherId)` - Sá»‘ giao dá»‹ch
  - **Average Transaction**: `totalRevenue / totalTransactions` - Trung bÃ¬nh má»—i giao dá»‹ch
  - **Payment Method Breakdown**: Group by `detail.paymentMethod`

- âœ… **Date Filtering**:

  - Filter theo `PaymentVoucher.paymentDate` (ngÃ y thanh toÃ¡n)
  - User chá»n thÃ¡ng (YYYY-MM format)
  - Date range: tá»« Ä‘áº§u thÃ¡ng (00:00:00) Ä‘áº¿n cuá»‘i thÃ¡ng (23:59:59)
  - UTC timezone cho database queries

- âœ… **Comparison Periods**:

  - **Previous Month**: ThÃ¡ng trÆ°á»›c (full month)
  - **Same Month Last Year**: CÃ¹ng thÃ¡ng nÄƒm ngoÃ¡i
  - Growth calculation: `((current - previous) / previous) * 100`

- âœ… **Service & Customer Data**:
  - Láº¥y thÃ´ng tin service/customer tá»« `consultedService` relation
  - Group theo service, customer source, treating doctor

### Payment Method Standardization

**Database Values** (tá»« `payment-voucher.schema.ts`):

```typescript
export const PAYMENT_METHODS = [
  "Tiá»n máº·t",
  "Quáº¹t tháº» thÆ°á»ng",
  "Quáº¹t tháº» Visa",
  "Chuyá»ƒn khoáº£n",
] as const;
```

**Note**:

- Data Ä‘Ã£ Ä‘Æ°á»£c chuáº©n hÃ³a (dropdown selection)
- No normalization needed
- Direct mapping cho reports

### Permission & Data Scoping

**Admin**:

- Xem "Táº¥t cáº£ chi nhÃ¡nh" (aggregated data)
- Switch qua tá»«ng clinic riÃªng láº» via Tabs
- Chá»n thÃ¡ng Ä‘á»ƒ xem bÃ¡o cÃ¡o
- Export Excel

**Non-admin (Employee)**:

- CHá»ˆ xem clinic cá»§a mÃ¬nh (`employeeProfile.clinicId`)
- KhÃ´ng cÃ³ tabs clinic selector
- Chá»n thÃ¡ng Ä‘á»ƒ xem bÃ¡o cÃ¡o
- Export Excel cho clinic cá»§a mÃ¬nh

**Backend Implementation**:

- API filter theo `clinicId` tá»« `consultedService.clinicId`
- Frontend controls permission logic
- No server-side permission validation (trust frontend)

### Architecture Decisions

- âœ… **New API Endpoints**: TÃ¡ch riÃªng Revenue Report APIs
- âœ… **Server-side Filtering**: All filtering at database level
- âœ… **React Query Caching**: Smart cache vá»›i staleTime based on date freshness
- âœ… **Modern UI**: Card-based layout, interactive charts, responsive design
- âœ… **Component Structure**: Feature-based organization (`features/reports/revenue/`)

---

## 1. ğŸ“Š Core Metrics & Calculations

### 1.1 Base Query

```typescript
// Fetch payment details trong thÃ¡ng cÃ³ liÃªn káº¿t vá»›i consulted service
const paymentDetails = await prisma.paymentVoucherDetail.findMany({
  where: {
    paymentVoucher: {
      paymentDate: {
        gte: startOfMonth, // YYYY-MM-01T00:00:00.000Z
        lte: endOfMonth, // YYYY-MM-31T23:59:59.999Z
      },
    },
    consultedServiceId: {
      not: null, // Chá»‰ láº¥y payments cho services
    },
    ...(clinicId && {
      consultedService: {
        clinicId, // Filter by clinic if provided
      },
    }),
  },
  include: {
    paymentVoucher: {
      select: {
        id: true,
        paymentNumber: true,
        paymentDate: true,
        customerId: true,
      },
    },
    consultedService: {
      include: {
        customer: {
          select: {
            id: true,
            code: true,
            name: true,
            customerSource: true,
            customerSourceNotes: true,
          },
        },
        dentalService: {
          select: {
            id: true,
            name: true,
            category: true,
          },
        },
        treatingDoctor: {
          select: {
            id: true,
            name: true,
          },
        },
        clinic: {
          select: {
            id: true,
            name: true,
          },
        },
      },
    },
  },
  orderBy: {
    paymentVoucher: {
      paymentDate: "desc",
    },
  },
});
```

### 1.2 Overall Metrics

```typescript
type RevenueOverallMetrics = {
  totalRevenue: number; // SUM(detail.amount)
  totalTransactions: number; // COUNT(DISTINCT paymentVoucherId)
  averageTransaction: number; // totalRevenue / totalTransactions
  totalPaymentDetails: number; // COUNT(details)

  byPaymentMethod: {
    "Tiá»n máº·t": number;
    "Quáº¹t tháº» thÆ°á»ng": number;
    "Quáº¹t tháº» Visa": number;
    "Chuyá»ƒn khoáº£n": number;
  };

  comparison: {
    previousMonth: {
      totalRevenue: number;
      totalTransactions: number;
      revenueGrowth: number; // percentage
      transactionsGrowth: number; // percentage
      periodLabel: string; // "MM/YYYY"
    };
    sameMonthLastYear: {
      totalRevenue: number;
      totalTransactions: number;
      revenueGrowth: number;
      transactionsGrowth: number;
      periodLabel: string; // "MM/YYYY"
    };
  };
};
```

### 1.3 Breakdown Dimensions

#### 1.3.1 By Date (Theo ngÃ y)

```typescript
type RevenueByDateData = {
  date: string; // YYYY-MM-DD
  totalRevenue: number; // Sum detail.amount
  totalTransactions: number; // Count unique vouchers
  totalPayments: number; // Count payment details
  averageTransaction: number; // totalRevenue / totalTransactions
  byPaymentMethod: {
    "Tiá»n máº·t": number;
    "Quáº¹t tháº» thÆ°á»ng": number;
    "Quáº¹t tháº» Visa": number;
    "Chuyá»ƒn khoáº£n": number;
  };
  topService: {
    // Service thu nhiá»u tiá»n nháº¥t trong ngÃ y
    serviceName: string;
    revenue: number;
    paymentCount: number;
  } | null;
};

// Query logic
const byDate = paymentDetails.reduce((acc, detail) => {
  const date = dayjs(detail.paymentVoucher.paymentDate).format("YYYY-MM-DD");

  if (!acc[date]) {
    acc[date] = {
      date,
      totalRevenue: 0,
      voucherIds: new Set(),
      totalPayments: 0,
      byPaymentMethod: {
        "Tiá»n máº·t": 0,
        "Quáº¹t tháº» thÆ°á»ng": 0,
        "Quáº¹t tháº» Visa": 0,
        "Chuyá»ƒn khoáº£n": 0,
      },
      services: new Map(),
    };
  }

  const dayData = acc[date];
  dayData.totalRevenue += detail.amount;
  dayData.voucherIds.add(detail.paymentVoucherId);
  dayData.totalPayments += 1;
  dayData.byPaymentMethod[detail.paymentMethod] += detail.amount;

  // Track services for top service calculation
  const serviceName = detail.consultedService.dentalService.name;
  if (!dayData.services.has(serviceName)) {
    dayData.services.set(serviceName, { revenue: 0, count: 0 });
  }
  const svcData = dayData.services.get(serviceName);
  svcData.revenue += detail.amount;
  svcData.count += 1;

  return acc;
}, {});
```

#### 1.3.2 By Customer Source (Theo nguá»“n khÃ¡ch hÃ ng)

```typescript
type RevenueBySourceData = {
  source: string | null; // customer.customerSource
  totalRevenue: number; // Sum detail.amount
  totalTransactions: number; // Count unique vouchers
  totalCustomers: number; // Count unique customers
  averagePerCustomer: number; // totalRevenue / totalCustomers
  percentageOfTotal: number; // (totalRevenue / grandTotal) * 100
  topCustomers: Array<{
    // Top 5 khÃ¡ch hÃ ng Ä‘Ã³ng tiá»n nhiá»u nháº¥t
    customerId: string;
    customerName: string;
    customerCode: string;
    totalRevenue: number;
    transactionCount: number;
  }>;
};

// Query logic
const bySource = paymentDetails.reduce((acc, detail) => {
  const source =
    detail.consultedService.customer.customerSource || "KhÃ´ng xÃ¡c Ä‘á»‹nh";

  if (!acc[source]) {
    acc[source] = {
      source,
      totalRevenue: 0,
      voucherIds: new Set(),
      customerIds: new Set(),
      customers: new Map(),
    };
  }

  const sourceData = acc[source];
  sourceData.totalRevenue += detail.amount;
  sourceData.voucherIds.add(detail.paymentVoucherId);
  sourceData.customerIds.add(detail.paymentVoucher.customerId);

  // Track per customer
  const customerId = detail.paymentVoucher.customerId;
  if (!sourceData.customers.has(customerId)) {
    sourceData.customers.set(customerId, {
      customerId,
      customerName: detail.consultedService.customer.name,
      customerCode: detail.consultedService.customer.code,
      totalRevenue: 0,
      voucherIds: new Set(),
    });
  }

  const customerData = sourceData.customers.get(customerId);
  customerData.totalRevenue += detail.amount;
  customerData.voucherIds.add(detail.paymentVoucherId);

  return acc;
}, {});
```

#### 1.3.3 By Service & Service Category (Theo dá»‹ch vá»¥ & nhÃ³m dá»‹ch vá»¥)

```typescript
type RevenueByServiceData = {
  serviceId: string;
  serviceName: string;
  category: string | null;
  totalRevenue: number; // Sum detail.amount
  paymentCount: number; // Count payment details
  transactionCount: number; // Count unique vouchers
  averagePerPayment: number; // totalRevenue / paymentCount
  percentageOfTotal: number; // (totalRevenue / grandTotal) * 100
  customerCount: number; // Count unique customers
};

type RevenueByCategoryData = {
  category: string | null;
  totalRevenue: number;
  paymentCount: number;
  transactionCount: number;
  percentageOfTotal: number;
  services: RevenueByServiceData[]; // Services trong category nÃ y
};

// Query logic - By Individual Service
const byService = paymentDetails.reduce((acc, detail) => {
  const serviceId = detail.consultedService.dentalServiceId;
  const serviceName = detail.consultedService.dentalService.name;
  const category = detail.consultedService.dentalService.category;

  if (!acc[serviceId]) {
    acc[serviceId] = {
      serviceId,
      serviceName,
      category,
      totalRevenue: 0,
      paymentCount: 0,
      voucherIds: new Set(),
      customerIds: new Set(),
    };
  }

  const svcData = acc[serviceId];
  svcData.totalRevenue += detail.amount;
  svcData.paymentCount += 1;
  svcData.voucherIds.add(detail.paymentVoucherId);
  svcData.customerIds.add(detail.paymentVoucher.customerId);

  return acc;
}, {});

// Query logic - By Category (grouped)
const byCategory = paymentDetails.reduce((acc, detail) => {
  const category =
    detail.consultedService.dentalService.category || "KhÃ´ng phÃ¢n loáº¡i";

  if (!acc[category]) {
    acc[category] = {
      category,
      totalRevenue: 0,
      paymentCount: 0,
      voucherIds: new Set(),
      services: new Map(),
    };
  }

  const catData = acc[category];
  catData.totalRevenue += detail.amount;
  catData.paymentCount += 1;
  catData.voucherIds.add(detail.paymentVoucherId);

  return acc;
}, {});
```

#### 1.3.4 By Treating Doctor (Theo BÃ¡c sÄ© Ä‘iá»u trá»‹)

```typescript
type RevenueByDoctorData = {
  doctorId: string | null;
  doctorName: string;
  totalRevenue: number; // Sum detail.amount
  paymentCount: number; // Count payment details
  transactionCount: number; // Count unique vouchers
  customerCount: number; // Count unique customers
  averagePerTransaction: number; // totalRevenue / transactionCount
  averagePerCustomer: number; // totalRevenue / customerCount
  percentageOfTotal: number;
  byPaymentMethod: {
    // Breakdown by payment method
    "Tiá»n máº·t": number;
    "Quáº¹t tháº» thÆ°á»ng": number;
    "Quáº¹t tháº» Visa": number;
    "Chuyá»ƒn khoáº£n": number;
  };
  topServices: Array<{
    // Top 5 services cá»§a doctor nÃ y
    serviceName: string;
    revenue: number;
    paymentCount: number;
  }>;
};

// Query logic
const byDoctor = paymentDetails.reduce((acc, detail) => {
  const doctorId = detail.consultedService.treatingDoctorId || "unassigned";
  const doctorName =
    detail.consultedService.treatingDoctor?.name || "ChÆ°a phÃ¢n cÃ´ng";

  if (!acc[doctorId]) {
    acc[doctorId] = {
      doctorId: doctorId === "unassigned" ? null : doctorId,
      doctorName,
      totalRevenue: 0,
      paymentCount: 0,
      voucherIds: new Set(),
      customerIds: new Set(),
      byPaymentMethod: {
        "Tiá»n máº·t": 0,
        "Quáº¹t tháº» thÆ°á»ng": 0,
        "Quáº¹t tháº» Visa": 0,
        "Chuyá»ƒn khoáº£n": 0,
      },
      services: new Map(),
    };
  }

  const docData = acc[doctorId];
  docData.totalRevenue += detail.amount;
  docData.paymentCount += 1;
  docData.voucherIds.add(detail.paymentVoucherId);
  docData.customerIds.add(detail.paymentVoucher.customerId);
  docData.byPaymentMethod[detail.paymentMethod] += detail.amount;

  // Track top services
  const serviceName = detail.consultedService.dentalService.name;
  if (!docData.services.has(serviceName)) {
    docData.services.set(serviceName, {
      serviceName,
      revenue: 0,
      paymentCount: 0,
    });
  }
  const svcData = docData.services.get(serviceName);
  svcData.revenue += detail.amount;
  svcData.paymentCount += 1;

  return acc;
}, {});
```

---

## 2. ğŸ“¡ API Endpoints

### GET `/api/reports/revenue/overview`

**Purpose**: Tá»•ng quan doanh thu thÃ¡ng vá»›i comparisons

**Query Params**:

- `selectedMonth`: string (YYYY-MM, required)
- `clinicId`: string (optional) - null = all clinics for admin

**Response**:

```typescript
{
  period: {
    month: string;        // "YYYY-MM"
    monthLabel: string;   // "ThÃ¡ng 11/2024"
    clinicId: string | null;
    clinicName: string | null;
  },
  metrics: {
    totalRevenue: number;
    totalTransactions: number;
    averageTransaction: number;
    totalPaymentDetails: number;
    byPaymentMethod: {
      "Tiá»n máº·t": number;
      "Quáº¹t tháº» thÆ°á»ng": number;
      "Quáº¹t tháº» Visa": number;
      "Chuyá»ƒn khoáº£n": number;
    };
  },
  comparison: {
    previousMonth: {
      totalRevenue: number;
      totalTransactions: number;
      revenueGrowth: number;
      transactionsGrowth: number;
      periodLabel: string;
    },
    sameMonthLastYear: {
      totalRevenue: number;
      totalTransactions: number;
      revenueGrowth: number;
      transactionsGrowth: number;
      periodLabel: string;
    }
  }
}
```

### GET `/api/reports/revenue/by-date`

**Purpose**: Doanh thu theo tá»«ng ngÃ y trong thÃ¡ng

**Query Params**:

- `selectedMonth`: string (YYYY-MM, required)
- `clinicId`: string (optional)

**Response**:

```typescript
{
  period: { month, clinicId, clinicName },
  data: RevenueByDateData[],  // Array sorted by date desc
  summary: {
    totalRevenue: number;
    totalTransactions: number;
    averageDailyRevenue: number;
    peakDay: {
      date: string;
      revenue: number;
      transactions: number;
    }
  }
}
```

### GET `/api/reports/revenue/by-source`

**Purpose**: Doanh thu theo nguá»“n khÃ¡ch hÃ ng

**Query Params**:

- `selectedMonth`: string (YYYY-MM, required)
- `clinicId`: string (optional)

**Response**:

```typescript
{
  period: { month, clinicId, clinicName },
  data: RevenueBySourceData[],  // Array sorted by totalRevenue desc
  summary: {
    totalRevenue: number;
    totalSources: number;
    topSource: {
      source: string;
      revenue: number;
      percentage: number;
    }
  }
}
```

### GET `/api/reports/revenue/by-service`

**Purpose**: Doanh thu theo dá»‹ch vá»¥ & nhÃ³m dá»‹ch vá»¥

**Query Params**:

- `selectedMonth`: string (YYYY-MM, required)
- `clinicId`: string (optional)
- `groupBy`: "service" | "category" (default: "service")

**Response**:

```typescript
{
  period: { month, clinicId, clinicName },
  groupBy: "service" | "category",

  // If groupBy = "service"
  byService: RevenueByServiceData[],  // Sorted by totalRevenue desc

  // If groupBy = "category"
  byCategory: RevenueByCategoryData[], // Sorted by totalRevenue desc

  summary: {
    totalRevenue: number;
    totalPayments: number;
    uniqueServiceCount: number;
    topService: {
      serviceName: string;
      revenue: number;
      paymentCount: number;
    }
  }
}
```

### GET `/api/reports/revenue/by-doctor`

**Purpose**: Doanh thu theo BÃ¡c sÄ© Ä‘iá»u trá»‹

**Query Params**:

- `selectedMonth`: string (YYYY-MM, required)
- `clinicId`: string (optional)

**Response**:

```typescript
{
  period: { month, clinicId, clinicName },
  data: RevenueByDoctorData[],  // Sorted by totalRevenue desc
  summary: {
    totalRevenue: number;
    totalPayments: number;
    activeDoctorsCount: number;
    topDoctor: {
      doctorName: string;
      revenue: number;
      transactions: number;
    }
  }
}
```

---

## 3. ğŸ¨ Frontend Components

### 3.1 Layout Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° BÃ¡o cÃ¡o Doanh thu                                     â”‚
â”‚  PhÃ¢n tÃ­ch tiá»n thá»±c thu tá»« thanh toÃ¡n                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  <RevenueReportFilters />                                 â”‚
â”‚  [Chá»n thÃ¡ng: 11/2024 â–¼]  [Refresh ğŸ”„]  [Export Excel]   â”‚
â”‚                                                           â”‚
â”‚  Admin only:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Táº¥t cáº£  â”‚ HN      â”‚ HCM     â”‚ DN      â”‚  (Tabs)       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  <RevenueOverviewCards />                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Tá»•ng doanh  â”‚ â”‚ Sá»‘ giao dá»‹châ”‚ â”‚ Trung bÃ¬nh  â”‚        â”‚
â”‚  â”‚ thu         â”‚ â”‚             â”‚ â”‚ /giao dá»‹ch  â”‚        â”‚
â”‚  â”‚ 280,000,000Ä‘â”‚ â”‚ 98          â”‚ â”‚ 2,857,143Ä‘  â”‚        â”‚
â”‚  â”‚ â†‘ +15.8%    â”‚ â”‚ â†‘ +12.2%    â”‚ â”‚ â†‘ +3.2%     â”‚        â”‚
â”‚  â”‚ vs thÃ¡ng    â”‚ â”‚             â”‚ â”‚             â”‚        â”‚
â”‚  â”‚ trÆ°á»›c       â”‚ â”‚             â”‚ â”‚             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Tiá»n máº·t    â”‚ â”‚ Quáº¹t tháº»    â”‚ â”‚ Chuyá»ƒn khoáº£nâ”‚        â”‚
â”‚  â”‚ 140M        â”‚ â”‚ thÆ°á»ng: 80M â”‚ â”‚ 60M         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ So vá»›i thÃ¡ngâ”‚ â”‚ So vá»›i cÃ¹ng â”‚                        â”‚
â”‚  â”‚ trÆ°á»›c       â”‚ â”‚ ká»³ nÄƒm ngoÃ¡iâ”‚                        â”‚
â”‚  â”‚ 10/2024     â”‚ â”‚ 11/2023     â”‚                        â”‚
â”‚  â”‚ +15.8%      â”‚ â”‚ +32.5%      â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  <RevenueReportTabs />                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Theo ngÃ y â”‚ Nguá»“n KH â”‚ Dá»‹ch vá»¥ â”‚ BÃ¡c sÄ© Ä‘iá»u trá»‹â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  <ActiveTabContent />                             â”‚   â”‚
â”‚  â”‚  - Chart                                          â”‚   â”‚
â”‚  â”‚  - Table                                          â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 RevenueReportFilters Component

**File**: `src/features/reports/revenue/components/RevenueReportFilters.tsx`

**Props**:

```typescript
type RevenueReportFiltersProps = {
  selectedMonth: string; // YYYY-MM
  clinicId: string | null;
  onMonthChange: (month: string) => void;
  onClinicChange: (clinicId: string | null) => void;
  onRefresh: () => void;
  onExport: () => void;
  loading?: boolean;
  isAdmin: boolean;
};
```

**Features**:

1. **Month Picker**:

   - Ant Design DatePicker vá»›i picker="month"
   - Format display: "ThÃ¡ng MM/YYYY"
   - Default: Current month
   - Disable future months

2. **Clinic Tabs** (Admin only):

   - First tab: "Táº¥t cáº£ chi nhÃ¡nh" (clinicId = null)
   - Dynamic tabs from `/api/clinics`
   - Active tab highlight

3. **Action Buttons**:
   - Refresh: Icon button vá»›i loading state
   - Export Excel: Primary button

### 3.3 RevenueOverviewCards Component

**File**: `src/features/reports/revenue/components/RevenueOverviewCards.tsx`

**Props**:

```typescript
type RevenueOverviewCardsProps = {
  data: {
    metrics: RevenueOverallMetrics["metrics"];
    comparison: RevenueOverallMetrics["comparison"];
  };
  loading?: boolean;
};
```

**Cards**:

1. **Tá»•ng doanh thu**:

   - Large number (VND format)
   - Comparison vá»›i thÃ¡ng trÆ°á»›c (Tag vá»›i arrow + percentage)
   - Color: Green (positive) / Red (negative)

2. **Sá»‘ giao dá»‹ch**:
   - Count number
   - Comparison vá»›i thÃ¡ng trÆ°á»›c
3. **Trung bÃ¬nh/giao dá»‹ch**:

   - VND format
   - Comparison vá»›i thÃ¡ng trÆ°á»›c

4. **Payment Method Cards** (4 small cards):

   - Tiá»n máº·t, Quáº¹t tháº» thÆ°á»ng, Quáº¹t tháº» Visa, Chuyá»ƒn khoáº£n
   - Show amount vá»›i icon vÃ  color coding

5. **Comparison Cards** (2 cards):
   - Previous Month comparison
   - Same Month Last Year comparison
   - Show growth percentage vá»›i color coding

### 3.4 Report Tabs & Content

#### Tab 1: Theo NgÃ y (By Date)

**Component**: `RevenueByDateTab`

**Chart**: Line + Bar combo chart (Recharts)

- Line: Daily revenue trend
- Bars: Payment method breakdown stacked
- X-axis: Dates trong thÃ¡ng
- Y-axis: Revenue amount
- Tooltip: Date, Revenue, Transactions, Payment method breakdown

**Table**: `RevenueByDateTable`

| Column          | Width | Sort | Description |
| --------------- | ----- | ---- | ----------- |
| NgÃ y            | 120px | âœ…   | DD/MM/YYYY  |
| Doanh thu       | 150px | âœ…   | VND format  |
| Giao dá»‹ch       | 100px | âœ…   | Count       |
| TB/giao dá»‹ch    | 150px | -    | VND format  |
| Tiá»n máº·t        | 130px | -    | VND format  |
| Quáº¹t tháº» thÆ°á»ng | 130px | -    | VND format  |
| Quáº¹t tháº» Visa   | 130px | -    | VND format  |
| Chuyá»ƒn khoáº£n    | 130px | -    | VND format  |

**Features**:

- Highlight peak day (max revenue)
- Export to Excel

#### Tab 2: Theo Nguá»“n KhÃ¡ch HÃ ng (By Source)

**Component**: `RevenueBySourceTab`

**Chart**: Horizontal bar chart

- Show top 10 sources
- Color coding by source
- Percentage labels

**Table**: `RevenueBySourceTable`

| Column           | Width | Sort | Description    |
| ---------------- | ----- | ---- | -------------- |
| Nguá»“n khÃ¡ch hÃ ng | 180px | -    | customerSource |
| Doanh thu        | 150px | âœ…   | VND format     |
| Giao dá»‹ch        | 100px | âœ…   | Count          |
| KhÃ¡ch hÃ ng       | 100px | -    | Unique count   |
| TB/khÃ¡ch         | 150px | -    | VND format     |
| % Tá»•ng           | 100px | âœ…   | Percentage     |

**Expandable Row**: Show top customers cá»§a source Ä‘Ã³

#### Tab 3: Theo Dá»‹ch Vá»¥ (By Service)

**Component**: `RevenueByServiceTab`

**Toggle**: Switch giá»¯a "Theo dá»‹ch vá»¥" vÃ  "Theo nhÃ³m dá»‹ch vá»¥"

**Chart**: Horizontal bar chart (top 15)

- Sorted by revenue descending
- Color: Category-based

**Table (By Service)**: `RevenueByServiceTable`

| Column        | Width | Sort | Filter | Description   |
| ------------- | ----- | ---- | ------ | ------------- |
| Dá»‹ch vá»¥       | 250px | -    | âœ…     | Service name  |
| NhÃ³m          | 150px | -    | âœ…     | Category      |
| Doanh thu     | 150px | âœ…   | -      | VND format    |
| Sá»‘ thanh toÃ¡n | 120px | âœ…   | -      | Payment count |
| TB/thanh toÃ¡n | 150px | -    | -      | VND format    |
| % Tá»•ng        | 100px | âœ…   | -      | Percentage    |

**Table (By Category)**: `RevenueByCategoryTable`

| Column        | Width | Sort | Description   |
| ------------- | ----- | ---- | ------------- |
| NhÃ³m dá»‹ch vá»¥  | 250px | -    | Category name |
| Doanh thu     | 150px | âœ…   | VND format    |
| Sá»‘ thanh toÃ¡n | 120px | âœ…   | Payment count |
| % Tá»•ng        | 100px | âœ…   | Percentage    |

**Expandable Row (Category)**: Show services trong category Ä‘Ã³

#### Tab 4: Theo BÃ¡c SÄ© Äiá»u Trá»‹ (By Treating Doctor)

**Component**: `RevenueByDoctorTab`

**Chart**: Bar chart vá»›i payment method breakdown

- X-axis: Doctor names
- Y-axis: Revenue
- Stacked bars: Payment methods
- Color coding by payment method

**Table**: `RevenueByDoctorTable`

| Column          | Width | Sort | Description  |
| --------------- | ----- | ---- | ------------ |
| BÃ¡c sÄ© Ä‘iá»u trá»‹ | 180px | -    | Name         |
| Doanh thu       | 150px | âœ…   | VND format   |
| Giao dá»‹ch       | 100px | âœ…   | Count        |
| KhÃ¡ch hÃ ng      | 100px | -    | Unique count |
| TB/giao dá»‹ch    | 150px | -    | VND format   |
| Tiá»n máº·t        | 130px | -    | VND format   |
| Quáº¹t tháº» thÆ°á»ng | 130px | -    | VND format   |
| Quáº¹t tháº» Visa   | 130px | -    | VND format   |
| Chuyá»ƒn khoáº£n    | 130px | -    | VND format   |
| % Tá»•ng          | 100px | âœ…   | Percentage   |

**Expandable Row**: Show top services cá»§a Doctor

---

## 4. ğŸ£ Frontend Hooks

### useRevenueOverview(filters)

**Purpose**: Fetch overall revenue metrics vá»›i comparison

**Query Key**: `['revenue-overview', filters]`

**Cache Strategy**:

```typescript
const getCacheTime = (selectedMonth: string) => {
  const now = dayjs();
  const target = dayjs(selectedMonth, "YYYY-MM");

  if (target.isSame(now, "month")) {
    return { staleTime: 2 * 60 * 1000 }; // 2 phÃºt (current month)
  }
  if (target.diff(now, "month") > 3) {
    return { staleTime: 60 * 60 * 1000 }; // 60 phÃºt (old data)
  }
  return { staleTime: 10 * 60 * 1000 }; // 10 phÃºt (recent)
};
```

**Return**: `{ data, loading, error, refetch }`

### useRevenueByDate(filters)

**Purpose**: Fetch daily revenue breakdown

**Query Key**: `['revenue-by-date', filters]`

**Return**: `{ data, loading, error, refetch }`

### useRevenueBySource(filters)

**Purpose**: Fetch revenue by customer source

**Query Key**: `['revenue-by-source', filters]`

**Return**: `{ data, loading, error, refetch }`

### useRevenueByService(filters)

**Purpose**: Fetch revenue by service/category

**Query Key**: `['revenue-by-service', filters]`

**Params**: Include `groupBy` in filters

**Return**: `{ data, loading, error, refetch }`

### useRevenueByDoctor(filters)

**Purpose**: Fetch revenue by treating doctor

**Query Key**: `['revenue-by-doctor', filters]`

**Return**: `{ data, loading, error, refetch }`

### useRevenueReportPrefetch()

**Purpose**: Prefetch adjacent months

**Functions**:

```typescript
const prefetchAdjacentMonths = (
  currentMonth: string,
  clinicId: string | null
) => {
  const nextMonth = dayjs(currentMonth).add(1, "month").format("YYYY-MM");
  const prevMonth = dayjs(currentMonth).subtract(1, "month").format("YYYY-MM");

  const filters = { clinicId };

  // Prefetch all report types for adjacent months
  queryClient.prefetchQuery([
    "revenue-overview",
    { ...filters, selectedMonth: nextMonth },
  ]);
  queryClient.prefetchQuery([
    "revenue-overview",
    { ...filters, selectedMonth: prevMonth },
  ]);
};
```

---

## 5. ğŸ“‹ Types

```typescript
// src/features/reports/revenue/types.ts

export type RevenueReportFilters = {
  selectedMonth: string; // YYYY-MM
  clinicId?: string | null;
};

export type PaymentMethodBreakdown = {
  "Tiá»n máº·t": number;
  "Quáº¹t tháº» thÆ°á»ng": number;
  "Quáº¹t tháº» Visa": number;
  "Chuyá»ƒn khoáº£n": number;
};

export type RevenueOverallMetrics = {
  totalRevenue: number;
  totalTransactions: number;
  averageTransaction: number;
  totalPaymentDetails: number;
  byPaymentMethod: PaymentMethodBreakdown;

  comparison: {
    previousMonth: {
      totalRevenue: number;
      totalTransactions: number;
      revenueGrowth: number;
      transactionsGrowth: number;
      periodLabel: string;
    };
    sameMonthLastYear: {
      totalRevenue: number;
      totalTransactions: number;
      revenueGrowth: number;
      transactionsGrowth: number;
      periodLabel: string;
    };
  };
};

export type RevenueByDateData = {
  date: string;
  totalRevenue: number;
  totalTransactions: number;
  totalPayments: number;
  averageTransaction: number;
  byPaymentMethod: PaymentMethodBreakdown;
  topService: {
    serviceName: string;
    revenue: number;
    paymentCount: number;
  } | null;
};

export type TopCustomerData = {
  customerId: string;
  customerName: string;
  customerCode: string;
  totalRevenue: number;
  transactionCount: number;
};

export type RevenueBySourceData = {
  source: string | null;
  totalRevenue: number;
  totalTransactions: number;
  totalCustomers: number;
  averagePerCustomer: number;
  percentageOfTotal: number;
  topCustomers: TopCustomerData[];
};

export type RevenueByServiceData = {
  serviceId: string;
  serviceName: string;
  category: string | null;
  totalRevenue: number;
  paymentCount: number;
  transactionCount: number;
  averagePerPayment: number;
  percentageOfTotal: number;
  customerCount: number;
};

export type RevenueByCategoryData = {
  category: string | null;
  totalRevenue: number;
  paymentCount: number;
  transactionCount: number;
  percentageOfTotal: number;
  services: RevenueByServiceData[];
};

export type TopServiceData = {
  serviceName: string;
  revenue: number;
  paymentCount: number;
};

export type RevenueByDoctorData = {
  doctorId: string | null;
  doctorName: string;
  totalRevenue: number;
  paymentCount: number;
  transactionCount: number;
  customerCount: number;
  averagePerTransaction: number;
  averagePerCustomer: number;
  percentageOfTotal: number;
  byPaymentMethod: PaymentMethodBreakdown;
  topServices: TopServiceData[];
};
```

---

## 6. ğŸ§ª Testing Checklist

### Unit Tests

- [ ] Date range calculation: Month start/end, previous month, same month last year
- [ ] Growth calculation: Positive, negative, zero, division by zero
- [ ] Percentage calculation: Correct rounding, edge cases
- [ ] Data aggregation functions: Sum, count, average calculations
- [ ] Payment method mapping: All methods handled correctly

### Integration Tests

- [ ] API `/revenue/overview`: Correct metrics, comparison accuracy, payment method breakdown
- [ ] API `/revenue/by-date`: All dates included, sorted correctly, payment method breakdown per day
- [ ] API `/revenue/by-source`: Aggregation by source, top customers
- [ ] API `/revenue/by-service`: Service vs category grouping, revenue calculation
- [ ] API `/revenue/by-doctor`: Doctor aggregation, payment method breakdown, top services
- [ ] Clinic filtering: Admin sees all, employee sees own clinic only
- [ ] Null handling: consultedServiceId null filtered out correctly

### E2E Tests

- [ ] Admin: Switch between "Táº¥t cáº£" and individual clinics
- [ ] Admin: Change month â†’ all tabs update
- [ ] Employee: Cannot see clinic selector, only own data
- [ ] Charts render correctly with data
- [ ] Tables: Sorting, expandable rows work
- [ ] Export Excel: File downloads with correct data
- [ ] Prefetch: Adjacent months load on hover
- [ ] Payment method cards: Show correct amounts and colors

---

## 7. ğŸš€ Implementation Phases

### Phase 1: Backend APIs

- [ ] `/api/reports/revenue/overview`
- [ ] `/api/reports/revenue/by-date`
- [ ] `/api/reports/revenue/by-source`
- [ ] `/api/reports/revenue/by-service`
- [ ] `/api/reports/revenue/by-doctor`
- [ ] Shared utilities: Date range, growth calculation, aggregation helpers

### Phase 2: Frontend Core

- [ ] Types (`types.ts`)
- [ ] Hooks (all `useRevenue*` hooks)
- [ ] Utilities (`utils/`)
- [ ] Constants (`constants.ts`)

### Phase 3: UI Components - Base

- [ ] `RevenueReportFilters`
- [ ] `RevenueOverviewCards`
- [ ] Base layout structure

### Phase 4: UI Components - Tabs

- [ ] `RevenueByDateTab` + Table + Chart
- [ ] `RevenueBySourceTab` + Table + Chart
- [ ] `RevenueByServiceTab` + Tables + Chart
- [ ] `RevenueByDoctorTab` + Table + Chart

### Phase 5: Features & Polish

- [ ] Export Excel functionality (all tabs)
- [ ] Chart interactions (tooltips, legends, zoom)
- [ ] Expandable rows (source â†’ customers, category â†’ services, doctor â†’ services)
- [ ] Loading states, error handling
- [ ] Responsive design (mobile/tablet)
- [ ] Prefetch optimization
- [ ] Permission enforcement

### Phase 6: Testing & Documentation

- [ ] Unit tests
- [ ] Integration tests
- [ ] E2E tests
- [ ] Feature documentation
- [ ] API documentation

---

## 8. ğŸ“ Notes & Considerations

### Performance Optimization

- **Database Indexes**:

  - `PaymentVoucher.paymentDate` (for date range queries)
  - `PaymentVoucherDetail.consultedServiceId` (not null filter)
  - `ConsultedService.clinicId` (filter by clinic)
  - Composite index: `(paymentDate, consultedServiceId)`

- **Query Optimization**:

  - Use `select` to limit fields returned
  - Proper `include` to avoid N+1 queries
  - Consider pagination for large result sets
  - Filter `consultedServiceId IS NOT NULL` at query level

- **Caching Strategy**:
  - Current month: Short staleTime (2-5 minutes)
  - Past months: Long staleTime (60 minutes)
  - Prefetch adjacent months on hover

### Revenue vs Sales Clarification

**Revenue (Doanh thu)**:

- âœ… Money actually received (PaymentVoucherDetail.amount)
- âœ… Filter by paymentDate (when money came in)
- âœ… Can be partial payments (same service paid multiple times)
- âœ… Shows cash flow reality

**Sales (Doanh sá»‘)** - See `011.1 Sales Report.md`:

- âœ… Value of services confirmed (ConsultedService.finalPrice)
- âœ… Filter by serviceConfirmDate (when service confirmed)
- âœ… Full service value counted once
- âœ… Shows business performance

**Example**:

```
Service: Niá»ng rÄƒng - 100M (confirmed 01/11/2024)
Payment 1: 40M (paid 01/11/2024)
Payment 2: 30M (paid 15/11/2024)
Payment 3: 30M (paid 01/12/2024)

November Sales Report: 100M (full service value)
November Revenue Report: 70M (40M + 30M payments in November)
December Revenue Report: 30M (final payment)
```

### UI/UX Enhancements

- **Interactive Charts**:

  - Click on chart element â†’ filter table
  - Payment method breakdown in tooltips
  - Zoom/pan for date charts

- **Smart Filters**:

  - Save last selected filters (localStorage)
  - Quick filters: "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", "CÃ¹ng ká»³ nÄƒm ngoÃ¡i"

- **Export Options**:
  - Excel: Formatted with colors, formulas
  - PDF: Include charts and summary
  - CSV: Raw data for further analysis

### Future Enhancements

- **Advanced Analytics**:

  - Cash flow trend analysis
  - Payment method preference trends
  - Doctor performance benchmarking

- **Custom Reports**:

  - Report builder: Custom date ranges
  - Saved reports: Templates
  - Scheduled exports: Email automation

- **Real-time Updates**:
  - WebSocket for live data (current day only)
  - Notification when new payment recorded

### Migration from Old Report

**Breaking Changes**:

- New API endpoints (old endpoints deprecated)
- Separate Revenue and Sales reports
- Different data structure

**Migration Path**:

1. Create new APIs alongside old ones
2. Build new frontend with feature flag
3. Test with real data
4. Switch feature flag
5. Deprecate old endpoints

**Data Validation**:

- Compare old vs new calculations
- Verify payment method totals match
- Check edge cases (no payments, partial payments)
