# ğŸ’° Revenue Report (BÃ¡o cÃ¡o Doanh thu)

> **Status**: âœ… IMPLEMENTED & Optimized  
> **Route**: `/reports/revenue`  
> **Last Updated**: 2025-12-08

## ğŸ¯ Má»¥c ÄÃ­ch & Pháº¡m Vi

### Má»¥c Ä‘Ã­ch

BÃ¡o cÃ¡o tá»•ng há»£p vÃ  phÃ¢n tÃ­ch **doanh thu thá»±c thu** tá»« thanh toÃ¡n, giÃºp quáº£n lÃ½:

- Theo dÃµi tiá»n thá»±c thu theo thÃ¡ng (cash flow)
- So sÃ¡nh tÄƒng trÆ°á»Ÿng vá»›i thÃ¡ng trÆ°á»›c
- PhÃ¢n tÃ­ch doanh thu theo nhiá»u gÃ³c Ä‘á»™: ngÃ y, nguá»“n khÃ¡ch, dá»‹ch vá»¥, bÃ¡c sÄ© Ä‘iá»u trá»‹
- Xem chi tiáº¿t tá»«ng giao dá»‹ch thanh toÃ¡n

### Dá»¯ liá»‡u nguá»“n

- **Báº£ng**: `PaymentVoucherDetail` (chi tiáº¿t phiáº¿u thu)
- **Äiá»u kiá»‡n**: Filter theo `paymentVoucher.paymentDate` (ngÃ y thanh toÃ¡n) trong thÃ¡ng
- **LÃ½ do**: Äá»ƒ xem tiá»n thá»±c thu, cash flow thá»±c táº¿

### KhÃ¡c biá»‡t vá»›i Sales Report

| Aspect           | Sales Report                      | Revenue Report         |
| ---------------- | --------------------------------- | ---------------------- |
| **Data source**  | ConsultedService                  | PaymentVoucherDetail   |
| **Filter field** | consultationDate                  | paymentDate            |
| **Metric**       | GiÃ¡ trá»‹ dá»‹ch vá»¥ chá»‘t (finalPrice) | Tiá»n thá»±c thu (amount) |
| **Use case**     | Doanh sá»‘ kinh doanh               | Cash flow thá»±c táº¿      |

**VÃ­ dá»¥**:

```
Dá»‹ch vá»¥: Niá»ng rÄƒng - 100M (chá»‘t ngÃ y 01/11)
- Thanh toÃ¡n láº§n 1: 40M (ngÃ y 01/11)
- Thanh toÃ¡n láº§n 2: 30M (ngÃ y 15/11)
- Thanh toÃ¡n láº§n 3: 30M (ngÃ y 01/12)

â†’ Sales Report thÃ¡ng 11: 100M (full service value)
â†’ Revenue Report thÃ¡ng 11: 70M (40M + 30M thá»±c thu)
â†’ Revenue Report thÃ¡ng 12: 30M (thanh toÃ¡n cuá»‘i)
```

### PhÃ¢n quyá»n

- **Admin**:
  - Xem Ä‘Æ°á»£c táº¥t cáº£ chi nhÃ¡nh
  - CÃ³ dropdown chá»n chi nhÃ¡nh cá»¥ thá»ƒ hoáº·c "Táº¥t cáº£ chi nhÃ¡nh"
- **Employee**:
  - Chá»‰ xem chi nhÃ¡nh mÃ¬nh thuá»™c vá»
  - KhÃ´ng cÃ³ clinic selector

---

## ğŸ–¼ï¸ Mock Giao Diá»‡n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° BÃ¡o cÃ¡o Doanh thu - ThÃ¡ng nÃ y                     [ğŸ—“ï¸ 11/2025] [ğŸ¥ Chi nhÃ¡nh A â–¼] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° Tá»•ng DT  â”‚  â”‚ ğŸ’µ Tiá»n máº·t â”‚  â”‚ ğŸ’³ Quáº¹t TH  â”‚  â”‚ ğŸ’³ Quáº¹t Visaâ”‚  â”‚ ğŸ¦ CK       â”‚
â”‚ 280,000,000â‚«â”‚  â”‚ 140,000,000â‚«â”‚  â”‚ 80,000,000â‚« â”‚  â”‚ 40,000,000â‚« â”‚  â”‚ 20,000,000â‚« â”‚
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚ ğŸŸ¢ â†‘ +15.8% â”‚  â”‚ 50.0% tá»•ng  â”‚  â”‚ 28.6% tá»•ng  â”‚  â”‚ 14.3% tá»•ng  â”‚  â”‚ 7.1% tá»•ng   â”‚
â”‚ vs T.trÆ°á»›c  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Tá»•ng há»£p                                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ [Theo ngÃ y] [Theo nguá»“n] [Theo dá»‹ch vá»¥] [Theo bÃ¡c sÄ© Ä‘iá»u trá»‹]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tab: Theo ngÃ y                                                                         â”‚
â”‚                                                                                        â”‚
â”‚ NgÃ y       â”‚ Tiá»n máº·t    â”‚ Quáº¹t TH    â”‚ Quáº¹t Visa  â”‚ CK         â”‚ Doanh thu   â”‚ %    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 01/11/2025 â”‚  5,000,000  â”‚  3,000,000 â”‚  2,000,000 â”‚  1,000,000 â”‚ 11,000,000  â”‚ 3.9% â”‚
â”‚ 02/11/2025 â”‚  6,000,000  â”‚  4,000,000 â”‚  2,000,000 â”‚  1,000,000 â”‚ 13,000,000  â”‚ 4.6% â”‚
â”‚ 03/11/2025 â”‚  7,000,000  â”‚  5,000,000 â”‚  3,000,000 â”‚  2,000,000 â”‚ 17,000,000  â”‚ 6.1% â”‚
â”‚ ...        â”‚  ...        â”‚  ...       â”‚  ...       â”‚  ...       â”‚  ...        â”‚ ...  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Tá»”NG       â”‚140,000,000  â”‚ 80,000,000 â”‚ 40,000,000 â”‚ 20,000,000 â”‚280,000,000  â”‚ 100% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ Chi tiáº¿t ngÃ y: 01/11/2025                                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Tá»•ng sá»‘: 25 giao dá»‹ch â”‚ Tá»•ng doanh thu: 11,000,000â‚«                                   â”‚
â”‚                                                                                        â”‚
â”‚ NgÃ y thu â”‚ Dá»‹ch vá»¥        â”‚ KH (MÃ£)    â”‚ BS Ä‘iá»u trá»‹ â”‚ Sá»‘ tiá»n thu â”‚ % thanh toÃ¡n   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ 01/11/25 â”‚ Nhá»• rÄƒng khÃ´n  â”‚ NG001      â”‚ Dr. Anh    â”‚   3,000,000 â”‚ 100% (3M/3M)   â”‚
â”‚ 01/11/25 â”‚ Niá»ng rÄƒng     â”‚ TR002      â”‚ Dr. BÃ¬nh   â”‚   5,000,000 â”‚  20% (5M/25M)  â”‚
â”‚ 01/11/25 â”‚ Bá»c rÄƒng sá»©    â”‚ LE003      â”‚ Dr. Chi    â”‚   8,500,000 â”‚ 100% (8.5M/8.5M)â”‚
â”‚ ...      â”‚ ...            â”‚ ...        â”‚ ...        â”‚ ...         â”‚ ...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š YÃªu Cáº§u Chá»©c NÄƒng

### 1. Bá»™ lá»c (Page Header)

**YÃªu cáº§u**:

- [x] Month Picker: Chá»n thÃ¡ng cáº§n xem bÃ¡o cÃ¡o (format MM/YYYY)
- [x] Clinic Selector: Admin chá»n chi nhÃ¡nh cá»¥ thá»ƒ hoáº·c "Táº¥t cáº£ chi nhÃ¡nh" (Employee khÃ´ng hiá»ƒn thá»‹)
- [x] Auto-label: Hiá»ƒn thá»‹ "ThÃ¡ng nÃ y", "ThÃ¡ng trÆ°á»›c", hoáº·c "ThÃ¡ng MM/YYYY" tÃ¹y thÃ¡ng chá»n
- [x] Layout responsive: Title bÃªn trÃ¡i, controls bÃªn pháº£i

**Implementation**: Reuse `src/shared/components/PageHeaderWithMonthNav.tsx`

### 2. Tháº» KPI (5 cards)

**YÃªu cáº§u**:

- [x] Card 1 - **Tá»•ng doanh thu**: Icon ğŸ’°, mÃ u xanh dÆ°Æ¡ng

  - Hiá»ƒn thá»‹ tá»•ng doanh thu format VND
  - Growth MoM: % so vá»›i thÃ¡ng trÆ°á»›c (mÅ©i tÃªn â†‘/â†“, xanh/Ä‘á»)
  - KhÃ´ng cÃ³ YoY comparison

- [x] Card 2 - **Tiá»n máº·t**: Icon ğŸ’µ, mÃ u xanh lÃ¡

  - Hiá»ƒn thá»‹ tá»•ng tiá»n máº·t format VND
  - % trÃªn tá»•ng doanh thu (vÃ­ dá»¥: "50.0% tá»•ng")
  - KhÃ´ng cÃ³ growth indicator

- [x] Card 3 - **Quáº¹t tháº» thÆ°á»ng**: Icon ğŸ’³, mÃ u cam

  - Hiá»ƒn thá»‹ tá»•ng quáº¹t tháº» thÆ°á»ng format VND
  - % trÃªn tá»•ng doanh thu
  - KhÃ´ng cÃ³ growth indicator

- [x] Card 4 - **Quáº¹t tháº» Visa**: Icon ğŸ’³, mÃ u tÃ­m

  - Hiá»ƒn thá»‹ tá»•ng quáº¹t tháº» Visa format VND
  - % trÃªn tá»•ng doanh thu
  - KhÃ´ng cÃ³ growth indicator

- [x] Card 5 - **Chuyá»ƒn khoáº£n**: Icon ğŸ¦, mÃ u xanh dÆ°Æ¡ng nháº¡t
  - Hiá»ƒn thá»‹ tá»•ng chuyá»ƒn khoáº£n format VND
  - % trÃªn tá»•ng doanh thu
  - KhÃ´ng cÃ³ growth indicator

**Payment Method Values** (tá»« database):

```typescript
"Tiá»n máº·t" | "Quáº¹t tháº» thÆ°á»ng" | "Quáº¹t tháº» Visa" | "Chuyá»ƒn khoáº£n";
```

**Layout**: Grid 5 cá»™t responsive (desktop: 5/row, tablet: 3/row + 2/row, mobile: 1/row)

**Implementation**: `src/features/reports/revenue/components/RevenueReportStats.tsx`

### 3. Báº£ng Tá»•ng Há»£p (4 Tabs)

**YÃªu cáº§u**:

**Tab 1 - Theo ngÃ y**:

- [x] Hiá»ƒn thá»‹ breakdown theo tá»«ng ngÃ y trong thÃ¡ng
- [x] Cá»™t: NgÃ y | Tiá»n máº·t | Quáº¹t TH | Quáº¹t Visa | CK | Doanh thu | %
- [x] Sáº¯p xáº¿p: Theo ngÃ y chronological ASC (computed at repo layer)
- [x] "Doanh thu" = Tá»•ng cá»§a 4 payment methods
- [x] "%" = (Doanh thu ngÃ y / Tá»•ng thÃ¡ng) Ã— 100%
- [x] KhÃ´ng phÃ¢n trang (tá»‘i Ä‘a 31 rows)
- [x] **No ranking field** (khÃ¡c vá»›i Sales Report)

**Tab 2 - Theo nguá»“n**:

- [x] Hiá»ƒn thá»‹ breakdown theo nguá»“n khÃ¡ch hÃ ng (tá»« `customer.source`)
- [x] Cá»™t: Nguá»“n | Sá»‘ phiáº¿u thu | Sá»‘ KH thanh toÃ¡n | Doanh thu | %
- [x] "Sá»‘ phiáº¿u thu" = COUNT(DISTINCT paymentVoucherId)
- [x] "Sá»‘ KH thanh toÃ¡n" = COUNT(DISTINCT customerId)
- [x] "%" = (Doanh thu nguá»“n / Tá»•ng) Ã— 100%
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (computed at repo layer)
- [x] KhÃ´ng phÃ¢n trang (thÆ°á»ng 5-10 nguá»“n)
- [x] **No ranking field**

**Tab 3 - Theo dá»‹ch vá»¥**:

- [x] Hiá»ƒn thá»‹ breakdown theo dá»‹ch vá»¥
- [x] Cá»™t: Dá»‹ch vá»¥ | Doanh thu | % tá»•ng DT | % thanh toÃ¡n
- [x] "% tá»•ng DT" = (Doanh thu dá»‹ch vá»¥ / Tá»•ng doanh thu) Ã— 100%
- [x] "% thanh toÃ¡n" = (Tá»•ng Ä‘Ã£ thu / Tá»•ng finalPrice) Ã— 100% (aggregate all payments)
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (computed at repo layer)
- [x] PhÃ¢n trang: 20 rows/page
- [x] **No ranking field**
- [x] **Note**: KhÃ´ng cÃ³ group by serviceGroup (simplified implementation)

**Tab 4 - Theo bÃ¡c sÄ© Ä‘iá»u trá»‹**:

- [x] Hiá»ƒn thá»‹ breakdown theo bÃ¡c sÄ© Ä‘iá»u trá»‹ (tá»« `consultedService.treatingDoctorId`)
- [x] Cá»™t: BÃ¡c sÄ© Ä‘iá»u trá»‹ | Doanh thu | %
- [x] "%" = (Doanh thu BS / Tá»•ng) Ã— 100%
- [x] Sáº¯p xáº¿p: Theo doanh thu DESC (repo layer)
- [x] PhÃ¢n trang: 10 rows/page
- [x] **No ranking field**

**Summary Row (Footer)**:

- [x] Hiá»ƒn thá»‹ luÃ´n á»Ÿ cuá»‘i báº£ng (khÃ´ng scroll)
- [x] Tá»•ng táº¥t cáº£ metrics tÃ¹y theo tab
- [x] Style: Bold text, background xÃ¡m nháº¡t, doanh thu mÃ u xanh dÆ°Æ¡ng

**Interaction**:

- [x] Click vÃ o báº¥t ká»³ row nÃ o â†’ Hiá»ƒn thá»‹ DetailPanel vá»›i data tÆ°Æ¡ng á»©ng
- [x] Click vÃ o row khÃ¡c â†’ Update DetailPanel vá»›i data má»›i
- [x] Khi Ä‘á»•i thÃ¡ng/chi nhÃ¡nh â†’ Clear selection, DetailPanel vá» empty state
- [x] Khi Ä‘á»•i tab â†’ Clear selection, DetailPanel vá» empty state

**Implementation**:

- `src/features/reports/revenue/components/SummaryTabs.tsx` (wrapper)
- `src/features/reports/revenue/components/SummaryTable.tsx` (reusable table component)

### 4. Panel Chi Tiáº¿t (LuÃ´n Hiá»ƒn Thá»‹)

**YÃªu cáº§u**:

**Tráº¡ng thÃ¡i hiá»ƒn thá»‹**:

- [x] LuÃ´n render (khÃ´ng áº©n/hiá»‡n)
- [x] **Khi chÆ°a chá»n row**: Hiá»ƒn thá»‹ empty state vá»›i icon â„¹ï¸, message "ChÆ°a cÃ³ dá»¯ liá»‡u chi tiáº¿t", guidance "Vui lÃ²ng chá»n má»™t dÃ²ng trong báº£ng tá»•ng há»£p bÃªn trÃªn"
- [x] **Khi Ä‘Ã£ chá»n row**: Hiá»ƒn thá»‹ báº£ng chi tiáº¿t

**Header**:

- [x] Title Ä‘á»™ng: "Chi tiáº¿t [tab label]: [selected item name]" (VD: "Chi tiáº¿t ngÃ y: 15/11/2025")
- [x] Khi chÆ°a chá»n: Hiá»ƒn thá»‹ "Chi tiáº¿t thanh toÃ¡n" (generic title)
- [x] Summary info: "Tá»•ng sá»‘: X giao dá»‹ch | Tá»•ng doanh thu: XXX â‚«" (hiá»ƒn thá»‹ khi cÃ³ data)

**Báº£ng chi tiáº¿t** (6 cá»™t cá»‘ Ä‘á»‹nh):

1. **NgÃ y thu**: `paymentVoucher.paymentDate`, DD/MM/YYYY, fixed left
2. **Dá»‹ch vá»¥**: `consultedService.dentalService.name`, width 200px
3. **KhÃ¡ch hÃ ng (MÃ£)**: `customer.fullName (customer.code)`, **clickable link** navigate to `/customers/:id`, mÃ u xanh dÆ°Æ¡ng
4. **BÃ¡c sÄ© Ä‘iá»u trá»‹**: `consultedService.treatingDoctor.fullName`, nullable â†’ "-"
5. **Sá»‘ tiá»n thu**: `paymentVoucherDetail.amount`, format VND, mÃ u xanh dÆ°Æ¡ng bold, align right
6. **% thanh toÃ¡n**: Hiá»ƒn thá»‹ progress vá»›i format "X% (ÄÃ£Thu/Tá»•ngGiÃ¡)"
   - CÃ´ng thá»©c: `(Tá»•ngÄÃ£Thu / consultedService.finalPrice) Ã— 100%`
   - Tá»•ngÄÃ£Thu = SUM(all payments for this consultedService)
   - Display: "100% (3M/3M)" hoáº·c "20% (5M/25M)"
   - Color: Green if 100%, Blue if < 100%

**Query logic**:

- **Base filter**: `paymentVoucher.paymentDate` trong thÃ¡ng Ä‘ang xem
- **Additional filter theo tab**:
  - Tab NgÃ y: AND `paymentDate = selected_date`
  - Tab Nguá»“n: AND `customer.source = selected_source`
  - Tab Dá»‹ch vá»¥: AND `consultedService.dentalServiceId = selected_service_id`
  - Tab BÃ¡c sÄ©: AND `consultedService.treatingDoctorId = selected_doctor_id`
- **Aggregation cho % thanh toÃ¡n**: Computed tá»« `computePaymentAggregations()` helper

**PhÃ¢n trang**: 20 rows/page (frontend pagination)

**Implementation**: `src/features/reports/revenue/components/DetailPanel.tsx`

---

## ğŸ“‹ TypeScript Types

**File**: `src/shared/validation/revenue-report.schema.ts`

### Query Schemas

```typescript
export const GetRevenueSummaryQuerySchema = z.object({
  month: z.string().regex(/^\d{4}-\d{2}$/),
  clinicId: z.string().optional(),
});

export const GetRevenueDetailQuerySchema = z.object({
  month: z.string().regex(/^\d{4}-\d{2}$/),
  clinicId: z.string().optional(),
  tab: z.enum(["daily", "source", "service", "doctor"]),
  key: z.string(), // date, source, serviceId, doctorId
});

export type GetRevenueSummaryQuery = z.infer<
  typeof GetRevenueSummaryQuerySchema
>;
export type GetRevenueDetailQuery = z.infer<typeof GetRevenueDetailQuerySchema>;
```

### Response Schemas

```typescript
// KPI Data
export const RevenueKpiDataSchema = z.object({
  totalRevenue: z.number(),
  cash: z.number(),
  cardRegular: z.number(),
  cardVisa: z.number(),
  transfer: z.number(),

  // Growth for total revenue only
  totalRevenueGrowthMoM: z.number().nullable(),

  // Percentages for payment methods
  cashPercentage: z.number(),
  cardRegularPercentage: z.number(),
  cardVisaPercentage: z.number(),
  transferPercentage: z.number(),

  // Previous month data for comparison
  previousMonthRevenue: z.number().nullable(),
});

// Daily Detail
export const DailyRevenueDataSchema = z.object({
  id: z.string(), // date as YYYY-MM-DD
  date: z.string(), // DD/MM/YYYY display
  cash: z.number(),
  cardRegular: z.number(),
  cardVisa: z.number(),
  transfer: z.number(),
  totalRevenue: z.number(),
  percentage: z.number(),
  // NOTE: No rank field (different from Sales Report)
});

// Source Detail
export const SourceRevenueDataSchema = z.object({
  id: z.string(),
  source: z.string(),
  voucherCount: z.number(),
  customerCount: z.number(),
  totalRevenue: z.number(),
  percentage: z.number(),
  // NOTE: No rank field
});

// Service Detail
export const ServiceRevenueDataSchema = z.object({
  id: z.string(),
  serviceId: z.string(),
  serviceName: z.string(),
  serviceGroup: z.string().nullable(),
  totalRevenue: z.number(),
  percentageOfTotal: z.number(),
  paymentPercentage: z.number(), // (paid / finalPrice) * 100
  totalPaid: z.number(),
  totalFinalPrice: z.number(),
  // NOTE: No rank field
});

// Doctor Detail
export const DoctorRevenueDataSchema = z.object({
  id: z.string(),
  doctorId: z.string(),
  doctorName: z.string(),
  totalRevenue: z.number(),
  percentage: z.number(),
  // NOTE: No rank field
});

// Payment Detail Record (for detail panel)
export const PaymentDetailRecordSchema = z.object({
  id: z.string(),
  paymentDate: z.string(), // ISO date
  paymentDateDisplay: z.string(), // DD/MM/YYYY
  serviceName: z.string(),
  customerName: z.string(),
  customerCode: z.string(),
  customerId: z.string(),
  treatingDoctorName: z.string().nullable(),
  amount: z.number(),
  paymentPercentage: z.number(),
  totalPaid: z.number(),
  finalPrice: z.number(),
  consultedServiceId: z.string(),
});

export type RevenueKpiData = z.infer<typeof RevenueKpiDataSchema>;
export type DailyRevenueData = z.infer<typeof DailyRevenueDataSchema>;
export type SourceRevenueData = z.infer<typeof SourceRevenueDataSchema>;
export type ServiceRevenueData = z.infer<typeof ServiceRevenueDataSchema>;
export type DoctorRevenueData = z.infer<typeof DoctorRevenueDataSchema>;
export type PaymentDetailRecord = z.infer<typeof PaymentDetailRecordSchema>;
```

---

## ğŸ”„ Data Flow

### API Endpoints

#### GET `/api/v1/reports/revenue/summary`

**Query**: `{ month, clinicId? }`

**Response**:

```typescript
{
  kpi: RevenueKpiData,
  summaryTabs: {
    byDate: DailyRevenueData[],
    bySource: SourceRevenueData[],
    byService: ServiceRevenueData[],
    byDoctor: DoctorRevenueData[],
  }
}
```

**Backend Logic**:

- Admin: Query all if no clinicId, or filter by clinicId
- Employee: Force clinicId = user.clinicId
- Data source: PaymentVoucherDetail
  - WHERE `paymentVoucher.paymentDate` IN month range
  - AND `consultedServiceId IS NOT NULL`
  - AND `consultedService.clinicId` = clinicId (if specified)
- Include relations: paymentVoucher, consultedService (with customer, dentalService, treatingDoctor)

#### GET `/api/v1/reports/revenue/detail`

**Query**: `{ month, clinicId?, tab, key }`

**Response**:

```typescript
{
  records: PaymentDetailRecord[],
  totalRecords: number,
  totalRevenue: number,
}
```

**Backend Logic**:

- Base filter: Same as summary + additional filter:
  - daily: WHERE `paymentVoucher.paymentDate` = key (YYYY-MM-DD)
  - source: WHERE `customer.source` = key
  - service: WHERE `consultedService.dentalServiceId` = key
  - doctor: WHERE `consultedService.treatingDoctorId` = key
- For each record, calculate payment percentage:
  - Aggregate all payments for the consultedServiceId
  - Calculate: (totalPaid / finalPrice) Ã— 100%
- Return with pagination (20/page)

### React Query Hooks

#### useRevenueSummary(filters)

**File**: `src/features/reports/revenue/hooks/useRevenueSummary.ts`

```typescript
queryKey: ["revenue-report", "summary", month, clinicId]
staleTime: calculateStaleTime(month) // 2min current, 2h past
gcTime: 5 hours
enabled: !!month
```

#### useRevenueDetail(tab, key, filters)

**File**: `src/features/reports/revenue/hooks/useRevenueDetail.ts`

```typescript
queryKey: ["revenue-report", "detail", tab, key, month, clinicId]
staleTime: calculateStaleTime(month)
gcTime: 5 hours
enabled: !!tab && !!key && !!month // Lazy load
```

**Dynamic Stale Time**:

- Current month: 2 minutes (data updating frequently)
- Past months: 2 hours (rarely change)

---

## ğŸ—ï¸ Kiáº¿n TrÃºc Há»‡ Thá»‘ng

### Backend (3-Layer Architecture - Optimized)

**Repository Layer**: `src/server/repos/revenue-report.repo.ts`

- Data access layer, follows GUIDELINES.md Pattern 2
- **Optimized Pattern**: Query once, compute multiple times (similar to Labo Report)
- **1 Query Method** (public):
  - `queryAllPaymentDetails(startDate, endDate, clinicId?)` - Single DB query vá»›i Ä‘áº§y Ä‘á»§ relations
- **7 Compute Methods** (public, pure functions):
  - `computeKpiMetrics(paymentDetails, previousMonthRevenue)` - KPI vá»›i MoM growth
  - `computeDailyData(paymentDetails)` - Daily breakdown, sort by date ASC
  - `computeSourceData(paymentDetails)` - Source breakdown, sort by revenue DESC
  - `computeServiceData(paymentDetails, aggregations)` - Service breakdown vá»›i payment %, sort DESC
  - `computeDepartmentData(paymentDetails, aggregations)` - Department breakdown
  - `computeDoctorData(paymentDetails)` - Doctor breakdown, sort DESC
  - `computePaymentAggregations(paymentDetails)` - Helper compute payment totals by consultedServiceId
  - `filterDetailsByTabAndKey(paymentDetails, tab, key)` - Filter details for panel (pure function)
- **Private helper** (1):
  - `getMonthDateRange(month)` - Utility method

**Key Innovation**:

- **Before**: 6 separate async query methods (6 DB calls)
- **After**: 1 query + 6 compute functions (2 DB calls: current + previous month)
- **Performance**: 66% reduction in DB queries

**Service Layer**: `src/server/services/revenue-report.service.ts`

- Business logic layer, follows GUIDELINES.md Pattern 2
- Zod validation vá»›i `safeParse`
- ServiceError pattern cho error handling
- Authentication checks (admin vs employee)
- **Optimized Query Strategy**:

  ```typescript
  // Query DB 2 láº§n parallel (current + previous month)
  const [paymentDetails, prevMonthDetails] = await Promise.all([...]);

  // Compute táº¥t cáº£ dimensions tá»« data cÃ³ sáºµn (NO DB queries)
  const paymentAggregations = computePaymentAggregations(paymentDetails);
  const kpiData = computeKpiMetrics(paymentDetails, prevRevenue);
  const dailyData = computeDailyData(paymentDetails);
  const sourceData = computeSourceData(paymentDetails);
  const serviceData = computeServiceData(paymentDetails, aggregations);
  const doctorData = computeDoctorData(paymentDetails);
  ```

- Gá»i mappers Ä‘á»ƒ transform data (data Ä‘Ã£ Ä‘Æ°á»£c sorted tá»« compute functions)
- **No ranking logic**: Mappers chá»‰ transform

**Mapper Functions**: `src/server/services/revenue-report/_mappers.ts`

- 6 pure functions:
  - `mapKpiData`: Transform KPI metrics with payment method breakdown
  - `mapDailyData`: Transform daily revenue with 4 payment methods (no sorting, no ranking)
  - `mapSourceData`: Transform source breakdown (no ranking)
  - `mapServiceData`: Transform service breakdown with payment percentage (no ranking)
  - `mapDoctorData`: Transform doctor breakdown (no ranking)
  - `mapDetailRecords`: Transform payment detail records with percentage
- Transform only (khÃ´ng validation, khÃ´ng sort, khÃ´ng ranking)
- Comments tiáº¿ng Viá»‡t cho tá»«ng function
- Consistent pattern vá»›i cÃ¡c features khÃ¡c

**API Routes**:

- `src/app/api/v1/reports/revenue/summary/route.ts` - KPI + Summary Tabs
- `src/app/api/v1/reports/revenue/detail/route.ts` - Detail records

### Frontend (Feature-based Structure)

**Structure**: `src/features/reports/revenue/`

```
â”œâ”€â”€ views/
â”‚   â””â”€â”€ RevenueReportView.tsx         # Main orchestrator, state management
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ RevenueReportStats.tsx        # 5 KPI cards
â”‚   â”œâ”€â”€ SummaryTabs.tsx               # 4 tabs wrapper
â”‚   â”œâ”€â”€ SummaryTable.tsx              # Reusable table cho cÃ¡c tabs
â”‚   â””â”€â”€ DetailPanel.tsx               # Chi tiáº¿t luÃ´n hiá»ƒn thá»‹
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useRevenueSummary.ts          # React Query hook cho summary
â”‚   â””â”€â”€ useRevenueDetail.ts           # React Query hook cho detail (lazy)
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ caching.ts                    # Dynamic stale time calculation
â”œâ”€â”€ api.ts                            # API client functions
â””â”€â”€ index.ts                          # Barrel exports
```

### Caching Strategy

**React Query Configuration**:

- **Summary data**:

  - Query key: `["revenue-report", "summary", month, clinicId]`
  - Stale time: 2 phÃºt (thÃ¡ng hiá»‡n táº¡i), 2 giá» (thÃ¡ng cÅ©)
  - GC time: 5 giá»
  - Enabled: `!!month`

- **Detail data**:
  - Query key: `["revenue-report", "detail", tab, key, month, clinicId]`
  - Stale time: TÆ°Æ¡ng tá»± summary
  - GC time: 5 giá»
  - Enabled: `!!tab && !!key && !!month` (lazy load khi chá»n row)

**Logic**:

- ThÃ¡ng hiá»‡n táº¡i: Stale time = 2 phÃºt (payments Ä‘ang diá»…n ra)
- ThÃ¡ng cÅ©: Stale time = 2 giá» (data Ã­t khi thay Ä‘á»•i)

---

## âœ… Checklist Triá»ƒn Khai

### âœ… Backend (Completed & Optimized)

- [x] Schema: Zod schemas cho query vÃ  response types
- [x] Repository: **Optimized pattern** - 1 query + 7 compute functions
  - [x] `queryAllPaymentDetails()` - Single DB query vá»›i full relations
  - [x] `computeKpiMetrics()` - Pure compute function
  - [x] `computeDailyData()` - Pure compute, sort ASC
  - [x] `computeSourceData()` - Pure compute, sort DESC
  - [x] `computeServiceData()` - Pure compute vá»›i payment %
  - [x] `computeDepartmentData()` - Pure compute
  - [x] `computeDoctorData()` - Pure compute, sort DESC
  - [x] `computePaymentAggregations()` - Helper for payment totals
  - [x] `filterDetailsByTabAndKey()` - Pure filter function
- [x] Service: Business logic, authentication, validation
  - [x] Query 2x parallel (current + previous month)
  - [x] Call compute methods vá»›i shared data
  - [x] **Performance**: 6 queries â†’ 2 queries = 66% reduction
- [x] Mappers: Transform data cho responses (6 mappers)
- [x] API Routes: `/api/v1/reports/revenue/summary` vÃ  `/detail`
- [x] Role-based filtering (admin vs employee)
- [x] Payment percentage calculation vá»›i aggregation
- [x] Zod validation cho táº¥t cáº£ inputs/outputs

### âœ… Frontend (Completed)

- [x] Reuse PageHeaderWithMonthNav tá»« Sales Report
- [x] RevenueReportStats: 5 KPI cards (1 with growth, 4 with %)
- [x] SummaryTabs: 4 tabs vá»›i SummaryTable reusable
- [x] SummaryTable: Columns tÃ¹y theo tab + summary row
- [x] DetailPanel: Always visible, 6 columns, customer link, payment %
- [x] React Query hooks: useRevenueSummary + useRevenueDetail
- [x] Dynamic stale time: 2min current, 2h past
- [x] Lazy loading detail data
- [x] Clear selection on filter change

### âœ… UI/UX (Completed)

- [x] Ant Design 5.x modern API (variant, items)
- [x] Consistent table styling (size="small", bordered)
- [x] Responsive grid layout (5/3+2/1 columns for cards)
- [x] Empty state vá»›i guidance message
- [x] Loading states cho táº¥t cáº£ data fetching
- [x] Customer name clickable navigate
- [x] Payment percentage progress bar vá»›i format "(Paid/Total)"
- [x] **Note**: Service grouping by serviceGroup khÃ´ng implement (simplified)

### â³ Pending Features

- [ ] Excel export functionality
- [ ] Advanced filters (date range, payment method filter)
- [ ] Charts (trend line, pie chart, bar chart)
- [ ] Service grouping with expand/collapse

---

## ğŸ“ Ghi ChÃº Ká»¹ Thuáº­t

### Quyáº¿t Ä‘á»‹nh quan trá»ng

1. **Data source**: Filter theo `paymentDate` Ä‘á»ƒ xem tiá»n thá»±c thu theo thÃ¡ng
2. **Payment percentage**: Aggregate all payments per consultedService Ä‘á»ƒ tÃ­nh % thanh toÃ¡n
3. **Detail panel aggregation**: Show individual payment records, nhÆ°ng % thanh toÃ¡n lÃ  aggregate
4. **4 tabs instead of 5**: KhÃ´ng cÃ³ tab "Theo sale" nhÆ° Sales Report (Revenue focus on payment methods, not sales)
5. **Growth indicator**: Chá»‰ cÃ³ cho tá»•ng doanh thu, khÃ´ng cÃ³ cho payment methods
6. **Dynamic stale time**: ThÃ¡ng hiá»‡n táº¡i 2min, thÃ¡ng cÅ© 2h Ä‘á»ƒ tá»‘i Æ°u caching
7. **No ranking fields**: Revenue Report khÃ´ng cÃ³ rank field trong schemas vÃ  UI (khÃ¡c vá»›i Sales Report)
   - LÃ½ do: Revenue focus on payment methods breakdown, not competition ranking
   - All tabs: Data sorted by revenue DESC (computed) hoáº·c date ASC (daily) nhÆ°ng khÃ´ng cÃ³ rank field
8. **Architecture**: Follows GUIDELINES.md Pattern 2
   - Public API methods accept Zod params
   - Private helper methods marked with comments
   - Sort logic at compute layer (not in mappers)
   - Service calls public query method once, then compute methods
9. **Optimized Query Pattern** (Dec 2025 refactor):
   - **Old**: 6 separate async query methods â†’ 6 DB calls per summary request
   - **New**: 1 query method + 7 compute functions â†’ 2 DB calls (current + previous month)
   - **Performance**: 66% reduction in database queries
   - **Pattern**: Query once, compute many times (same as Labo Report optimization)
10. **Service grouping**: Simplified implementation - khÃ´ng cÃ³ expand/collapse by serviceGroup
11. **consultedServiceId filter**: Removed from WHERE clause (accepts all payments, not just service payments)
    - Allows showing all revenue sources, not just dental services
    - Payment percentage only relevant for service-related payments

### Payment Percentage Calculation

**Formula**: `(TotalPaid / FinalPrice) Ã— 100%`

**Implementation** (Optimized):

```typescript
// In repo compute function
export function computePaymentAggregations(
  paymentDetails: RawPaymentDetail[]
): Map<string, number> {
  const aggregations = new Map<string, number>();

  paymentDetails.forEach((detail) => {
    if (!detail.consultedServiceId) return;

    const current = aggregations.get(detail.consultedServiceId) || 0;
    aggregations.set(detail.consultedServiceId, current + detail.amount);
  });

  return aggregations;
}

// Used in detail filtering
const totalPaid = aggregationsMap.get(detail.consultedServiceId) || 0;
const finalPrice = detail.consultedService.finalPrice;
const percentage = finalPrice > 0 ? (totalPaid / finalPrice) * 100 : 0;
```

**Key advantage**: Compute once, reuse for all dimensions (no repeated queries)

### Database Query Optimization

**Current Pattern** (Post-refactor):

```typescript
// Service layer - 2 queries total
const [paymentDetails, prevMonthDetails] = await Promise.all([
  revenueReportRepo.queryAllPaymentDetails(startDate, endDate, clinicId), // Query 1
  revenueReportRepo.queryAllPaymentDetails(prevStart, prevEnd, clinicId), // Query 2
]);

// All dimensions computed from these 2 query results (0 additional queries)
const aggregations = computePaymentAggregations(paymentDetails);
const kpiData = computeKpiMetrics(paymentDetails, prevRevenue);
const dailyData = computeDailyData(paymentDetails);
const sourceData = computeSourceData(paymentDetails);
const departmentData = computeDepartmentData(paymentDetails, aggregations);
const serviceData = computeServiceData(paymentDetails, aggregations);
const doctorData = computeDoctorData(paymentDetails);
```

**Indexes needed**:

- `PaymentVoucher.paymentDate` - Range queries
- `PaymentVoucher.clinicId` - Clinic filtering
- Composite: `(clinicId, paymentDate)` - Combined filter

**Performance comparison**:

| Metric          | Old Pattern     | New Pattern       | Improvement |
| --------------- | --------------- | ----------------- | ----------- |
| Summary queries | 6 parallel      | 2 parallel        | -66%        |
| Detail queries  | 2 (base + agg)  | 1 (filter in-mem) | -50%        |
| Data transfer   | 6x same data    | 2x unique data    | -66%        |
| Memory usage    | Lower (6 small) | Higher (2 large)  | Trade-off   |
| Compute time    | ~0ms (DB agg)   | ~5-10ms (JS)      | Acceptable  |

---

## ğŸ”® TÃ­nh NÄƒng TÆ°Æ¡ng Lai

### Phase 2

- [ ] **Export Excel**: Formatted with payment method colors, formulas
- [ ] **Advanced Filters**: Date range custom, payment method filter
- [ ] **Charts**:
  - Daily trend line chart (stacked by payment methods)
  - Payment method pie chart
  - Top services bar chart
- [ ] **Comparison View**: Side-by-side vá»›i Sales Report
- [ ] **Cash Flow Analysis**: Projection, trend analysis

### Phase 3

- [ ] **Scheduled Reports**: Email bÃ¡o cÃ¡o Ä‘á»‹nh ká»³
- [ ] **Analytics Dashboard**: Visual insights, anomaly detection
- [ ] **Payment Plan Tracking**: Monitor installment payments
- [ ] **Revenue Forecasting**: ML-based predictions

---

## ğŸ“– Related Documents

- **Sales Report**: `011.1 Sales Report.md` - So sÃ¡nh vá»›i Revenue Report
- **Payment Feature**: `010 Payment.md` - Payment data structure
- **Consulted Service**: `009 Consulted-Service.md` - Service confirmation flow
- **Old Revenue Report**: `011.2 Revenue Report OLD.md` - Deprecated version

---

## ğŸ¯ Success Metrics

### Performance

- [ ] Page load < 2s cho current month
- [ ] Query execution < 500ms cho summary
- [ ] Detail panel load < 300ms

### Accuracy

- [ ] Payment totals match PaymentVoucher records
- [ ] Payment percentage calculation verified
- [ ] No data inconsistencies between tabs

### UX

- [ ] All interactions smooth (no jank)
- [ ] Loading states clear and informative
- [ ] Error messages helpful
- [ ] Mobile responsive works well
