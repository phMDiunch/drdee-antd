# üì§ Requirements: Goods Issue Note - Phi·∫øu Xu·∫•t Kho (GIN)

> **üìã STATUS: PENDING** - Giai ƒëo·∫°n 1, T√≠nh nƒÉng 5 (FIFO Engine - Ph·∫ßn xu·∫•t)  
> **üîó Parent**: `015 Inventory - Overview.md`  
> **üìÑ Implementation**: `src/features/inventory/goods-issues/`  
> **‚ö†Ô∏è Dependencies**: 015.4 Goods Receipt (ph·∫£i c√≥ t·ªìn kho tr∆∞·ªõc), Employee & Customer tables

## üéØ M·ª•c Ti√™u

Ghi nh·∫≠n vi·ªác xu·∫•t h√†ng h√≥a ra kh·ªèi kho. ƒê√¢y l√† n∆°i **FIFO Engine th·ª±c s·ª± ho·∫°t ƒë·ªông**:

- H·ªá th·ªëng **T·ª∞ ƒê·ªòNG** ch·ªçn l√¥ h√†ng c≈© nh·∫•t ƒë·ªÉ xu·∫•t (theo goodsReceiptDetailId)
- T√≠nh **gi√° v·ªën ƒë√≠ch danh** ch√≠nh x√°c t·ª´ l√¥ ngu·ªìn
- Truy xu·∫•t ƒë∆∞·ª£c h√†ng xu·∫•t cho ai (B√°c sƒ©/B·ªánh nh√¢n)

## üîë Nguy√™n T·∫Øc C·ªët L√µi

### ‚ö†Ô∏è Ng∆∞·ªùi d√πng KH√îNG ch·ªçn l√¥

```
‚ùå SAI:                          ‚úÖ ƒê√öNG:
User ch·ªçn:                       User ch·ªâ nh·∫≠p:
- Implant X                      - Implant X
- L√¥ ABC (manual)                - S·ªë l∆∞·ª£ng: 15
- S·ªë l∆∞·ª£ng: 15
                                 H·ªá th·ªëng T·ª∞ ƒê·ªòNG:
                                 - Query StockQuant
                                 - Sort by goodsReceiptDetailId ASC
                                 - L·∫•y 10 t·ª´ l√¥ c≈© nh·∫•t
                                 - L·∫•y 5 t·ª´ l√¥ ti·∫øp theo
                                 - T√≠nh gi√° v·ªën ƒë√≠ch danh
```

### üéØ FIFO Algorithm (Simplified)

```
C·∫ßn xu·∫•t: Implant X - 15 c√°i

Step 1: Query t·ªìn kho
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ID ‚îÇ goodsReceiptDetailId ‚îÇ quantity ‚îÇ unitPrice‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1  ‚îÇ 100 (nh·∫≠p 1/1)       ‚îÇ 10       ‚îÇ 100,000  ‚îÇ ‚Üê Nh·∫≠p tr∆∞·ªõc
‚îÇ 2  ‚îÇ 105 (nh·∫≠p 5/1)       ‚îÇ 20       ‚îÇ 110,000  ‚îÇ
‚îÇ 3  ‚îÇ 108 (nh·∫≠p 8/1)       ‚îÇ 15       ‚îÇ 105,000  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Step 2: Ph√¢n b·ªï t·ª± ƒë·ªông
C·∫ßn 15:
- L·∫•y H·∫æT 10 t·ª´ ID=1 (receiptDetailId=100) ‚Üí C√≤n thi·∫øu 5
- L·∫•y 5 t·ª´ ID=2 (receiptDetailId=105) ‚Üí ƒê·ªß

Step 3: K·∫øt qu·∫£
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ D√≤ng xu·∫•t ‚îÇ T·ª´ l√¥ n√†o ‚îÇ SL ‚îÇ Gi√° v·ªën ‚îÇ T·ªïng     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1         ‚îÇ Detail 100‚îÇ 10 ‚îÇ 100,000 ‚îÇ1,000,000 ‚îÇ
‚îÇ 2         ‚îÇ Detail 105‚îÇ 5  ‚îÇ 110,000 ‚îÇ  550,000 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
T·ªïng gi√° v·ªën: 1,550,000 VNƒê
```

## üìã User Stories

### US-1: T·∫°o Phi·∫øu Xu·∫•t (Nh√°p)

**L√† User**, t√¥i mu·ªën:

- T·∫°o phi·∫øu xu·∫•t v·ªõi tr·∫°ng th√°i Nh√°p
- H·ªá th·ªëng t·ª± sinh s·ªë phi·∫øu (GIN-YYYYMMDD-XXXX)
- Ch·ªçn ng√†y xu·∫•t kho
- Ch·ªçn ƒë·ªëi t∆∞·ª£ng nh·∫≠n h√†ng (B√°c sƒ© HO·∫∂C B·ªánh nh√¢n)

### US-2: Nh·∫≠p Y√™u C·∫ßu Xu·∫•t Kho

**L√† User**, t√¥i mu·ªën:

- Th√™m nhi·ªÅu d√≤ng v·∫≠t t∆∞ c·∫ßn xu·∫•t
- V·ªõi m·ªói d√≤ng, t√¥i ch·ªâ c·∫ßn nh·∫≠p:
  - **V·∫≠t t∆∞** (ch·ªçn t·ª´ danh s√°ch)
  - **S·ªë l∆∞·ª£ng ƒë·ªÅ ngh·ªã**
- T√¥i KH√îNG nh·∫≠p: ƒê∆°n gi√°, L√¥, H·∫°n s·ª≠ d·ª•ng (h·ªá th·ªëng t·ª± x·ª≠ l√Ω)

### US-3: X√°c Nh·∫≠n Xu·∫•t Kho

**L√† User**, khi b·∫•m "X√°c nh·∫≠n xu·∫•t kho":

- H·ªá th·ªëng ki·ªÉm tra t·ªìn kho
- N·∫øu **ƒë·ªß h√†ng**:
  - Phi·∫øu chuy·ªÉn sang "ƒê√£ x√°c nh·∫≠n"
  - T·ªìn kho t·ª± ƒë·ªông gi·∫£m
  - Hi·ªÉn th·ªã chi ti·∫øt: h√†ng l·∫•y t·ª´ l√¥ n√†o, gi√° v·ªën bao nhi√™u
- N·∫øu **kh√¥ng ƒë·ªß**:
  - B√°o l·ªói: "Kh√¥ng ƒë·ªß t·ªìn kho. Hi·ªán c√≥ X, c·∫ßn Y"
  - Kh√¥ng cho x√°c nh·∫≠n

### US-4: Xem Chi Ti·∫øt Phi·∫øu Xu·∫•t (Sau khi x√°c nh·∫≠n)

**L√† User**, t√¥i mu·ªën xem:

- V·∫≠t t∆∞ n√†o ƒë√£ xu·∫•t
- Xu·∫•t cho ai (B√°c sƒ©/B·ªánh nh√¢n)
- L·∫•y t·ª´ nh·ªØng phi·∫øu nh·∫≠p n√†o (truy xu·∫•t ngu·ªìn)
- L√¥ NSX & HSD c·ªßa t·ª´ng ph·∫ßn (ƒë·ªÉ ki·ªÉm tra)
- Gi√° v·ªën chi ti·∫øt

## üé® UI/UX Requirements

### M√†n h√¨nh Danh S√°ch

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üì§ Phi·∫øu Xu·∫•t Kho                                [+ T·∫°o Phi·∫øu M·ªõi]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  T·ª´: [üìÖ] ƒê·∫øn: [üìÖ] ƒê·ªëi t∆∞·ª£ng: [T·∫•t c·∫£ ‚ñº] TT: [T·∫•t c·∫£ ‚ñº] üîç [...]   ‚îÇ
‚îÇ                                                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ S·ªë GIN      ‚îÇ Ng√†y    ‚îÇ Xu·∫•t cho        ‚îÇ T·ªïng gi√° v·ªën‚îÇ TT  ‚îÇ‚öô ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ GIN-...-001 ‚îÇ 20/1/25 ‚îÇ üë® BS Nguy·ªÖn A  ‚îÇ 2,500,000   ‚îÇüìù  ‚îÇ‚úé‚îÇ  ‚îÇ
‚îÇ  ‚îÇ GIN-...-002 ‚îÇ 21/1/25 ‚îÇ üßë BN Tr·∫ßn B    ‚îÇ 1,800,000   ‚îÇ‚úÖ  ‚îÇüëÅ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ GIN-...-003 ‚îÇ 21/1/25 ‚îÇ üë® BS L√™ C      ‚îÇ   950,000   ‚îÇ‚úÖ  ‚îÇüëÅ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Form T·∫°o Phi·∫øu Xu·∫•t (Nh·∫≠p Y√™u C·∫ßu)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úèÔ∏è  Phi·∫øu Xu·∫•t Kho [GIN-20250121-005]      [Tr·∫°ng th√°i: üìù]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚îÅ‚îÅ‚îÅ TH√îNG TIN CHUNG ‚îÅ‚îÅ‚îÅ                                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  S·ªë phi·∫øu                    Ng√†y xu·∫•t kho *                    ‚îÇ
‚îÇ  [GIN-20250121-005]          [üìÖ 21/01/2025]                    ‚îÇ
‚îÇ  (T·ª± sinh)                                                       ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ ƒê·ªêI T∆Ø·ª¢NG NH·∫¨N H√ÄNG ‚îÅ‚îÅ‚îÅ                                    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üë® B√°c sƒ© / Nh√¢n vi√™n                                           ‚îÇ
‚îÇ  [Dropdown: T√¨m b√°c sƒ©... ‚ñº]                                    ‚îÇ
‚îÇ   üîç Nguy·ªÖn VƒÉn A - B√°c sƒ© Implant                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ              --- HO·∫∂C ---                                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üßë B·ªánh nh√¢n                                                    ‚îÇ
‚îÇ  [Dropdown: T√¨m b·ªánh nh√¢n... ‚ñº]                                 ‚îÇ
‚îÇ   üîç Tr·∫ßn Th·ªã B - 0901234567                                    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  Ghi ch√∫ / L√Ω do xu·∫•t                                           ‚îÇ
‚îÇ  [_________________________________]                             ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ Y√äU C·∫¶U XU·∫§T H√ÄNG ‚îÅ‚îÅ‚îÅ                         [+ Th√™m]     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ V·∫≠t t∆∞                    ‚îÇ S·ªë l∆∞·ª£ng ƒë·ªÅ ngh·ªã ‚îÇ T·ªìn ‚îÇ üóë ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Implant Nobel Active... ‚ñº ‚îÇ       15         ‚îÇ 50  ‚îÇ √ó ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ GƒÉng tay Latex M        ‚ñº ‚îÇ      100         ‚îÇ 200 ‚îÇ √ó ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ [Ch·ªçn v·∫≠t t∆∞...        ‚ñº] ‚îÇ                  ‚îÇ     ‚îÇ √ó ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üí° L∆∞u √Ω: H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n b·ªï theo FIFO khi x√°c nh·∫≠n   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [H·ªßy]       [üíæ L∆∞u Nh√°p]       [‚úÖ X√°c Nh·∫≠n Xu·∫•t Kho]        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### View Chi Ti·∫øt (Sau X√°c Nh·∫≠n - Hi·ªÉn th·ªã k·∫øt qu·∫£ FIFO)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìÑ Chi Ti·∫øt Phi·∫øu Xu·∫•t #GIN-20250121-002      [‚úÖ ƒê√É X√ÅC NH·∫¨N] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Ng√†y xu·∫•t: 21/01/2025                                          ‚îÇ
‚îÇ  Xu·∫•t cho: üßë B·ªánh nh√¢n Tr·∫ßn Th·ªã B                              ‚îÇ
‚îÇ  Ghi ch√∫: Xu·∫•t v·∫≠t t∆∞ ph·∫´u thu·∫≠t Implant                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ CHI TI·∫æT H√ÄNG ƒê√É XU·∫§T (T·ª± ƒë·ªông ph√¢n b·ªï FIFO) ‚îÅ‚îÅ‚îÅ          ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  V·∫≠t t∆∞: Implant Nobel Active 4.3x10mm                          ‚îÇ
‚îÇ  Y√™u c·∫ßu: 15 c√°i ‚Üí ƒê√£ xu·∫•t: 15 c√°i                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Ngu·ªìn g·ªëc      ‚îÇ L√¥ NSX ‚îÇ HSD    ‚îÇ SL ‚îÇ ƒê∆°n gi√°‚îÇ T·ªïng  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ PN-GRN-...-010 ‚îÇLOT123  ‚îÇ12/2026 ‚îÇ 10 ‚îÇ100,000 ‚îÇ1,000k ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ PN-GRN-...-015 ‚îÇLOT456  ‚îÇ03/2027 ‚îÇ  5 ‚îÇ110,000 ‚îÇ  550k ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  T·ªïng gi√° v·ªën: 1,550,000 VNƒê                                   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  V·∫≠t t∆∞: GƒÉng tay Latex M                                       ‚îÇ
‚îÇ  Y√™u c·∫ßu: 100 h·ªôp ‚Üí ƒê√£ xu·∫•t: 100 h·ªôp                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Ngu·ªìn g·ªëc      ‚îÇ L√¥ NSX ‚îÇ HSD    ‚îÇ SL ‚îÇ ƒê∆°n gi√°‚îÇ T·ªïng  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ PN-GRN-...-008 ‚îÇGLOVE20 ‚îÇ06/2025 ‚îÇ 50 ‚îÇ  5,000 ‚îÇ  250k ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ PN-GRN-...-012 ‚îÇGLOVE21 ‚îÇ09/2025 ‚îÇ 50 ‚îÇ  5,200 ‚îÇ  260k ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  T·ªïng gi√° v·ªën: 510,000 VNƒê                                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚îÇ
‚îÇ  T·ªîNG GI√Å TR·ªä PHI·∫æU XU·∫§T: 2,060,000 VNƒê                        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [üóëÔ∏è H·ªßy Phi·∫øu] (N·∫øu c√≥ quy·ªÅn & h√†ng c√≥ th·ªÉ ho√†n tr·∫£)   [ƒê√≥ng]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Functional Requirements

### FR-1: T·ª± ƒê·ªông Sinh S·ªë Phi·∫øu

**Format**: `GIN-YYYYMMDD-XXXX`

- Logic t∆∞∆°ng t·ª± GRN

### FR-2: Business Rules

1. **ƒê·ªëi t∆∞·ª£ng nh·∫≠n**: Ph·∫£i ch·ªçn √≠t nh·∫•t 1 trong 2 (B√°c sƒ© HO·∫∂C B·ªánh nh√¢n)
2. **Chi ti·∫øt phi·∫øu**: T·ªëi thi·ªÉu 1 d√≤ng v·∫≠t t∆∞, s·ªë l∆∞·ª£ng > 0
3. **FIFO b·∫Øt bu·ªôc**: H·ªá th·ªëng t·ª± ƒë·ªông ph√¢n b·ªï, user kh√¥ng can thi·ªáp
4. **Kh√¥ng x√©t HSD**: FIFO thu·∫ßn t√∫y theo th·ªùi gian nh·∫≠p (goodsReceiptDetailId ASC)
5. **Validate t·ªìn kho**: Tr∆∞·ªõc khi POST, check ƒë·ªß h√†ng hay kh√¥ng
6. **H·ªßy phi·∫øu**: Ch·ªâ khi h√†ng c√≥ th·ªÉ ho√†n tr·∫£ v·ªÅ kho (logic ph·ª©c t·∫°p h∆°n GRN)

### FR-3: FIFO Engine - Core Algorithm

**ƒê√¢y l√† tr√°i tim c·ªßa h·ªá th·ªëng**

```typescript
async function allocateStock(
  materialId: number,
  requestedQty: number
): Promise<AllocationResult[]> {
  // Step 1: Query t·ªìn kho hi·ªán t·∫°i, s·∫Øp x·∫øp FIFO
  const availableStock = await prisma.stockQuant.findMany({
    where: {
      materialId: materialId,
      quantity: { gt: 0 }, // Ch·ªâ l·∫•y l√¥ c√≤n h√†ng
    },
    include: {
      receiptDetail: {
        include: {
          goodsReceipt: true, // ƒê·ªÉ l·∫•y ng√†y nh·∫≠p
        },
      },
    },
    orderBy: {
      goodsReceiptDetailId: "asc", // FIFO: Nh·∫≠p tr∆∞·ªõc (ID nh·ªè) xu·∫•t tr∆∞·ªõc
    },
  });

  // Step 2: Ph√¢n b·ªï l·∫ßn l∆∞·ª£t
  let remaining = requestedQty;
  const allocations: AllocationResult[] = [];

  for (const quant of availableStock) {
    if (remaining <= 0) break;

    const takeQty = Math.min(remaining, quant.quantity);

    allocations.push({
      stockQuantId: quant.id,
      goodsReceiptDetailId: quant.goodsReceiptDetailId,
      materialId: materialId,
      quantity: takeQty,
      unitCost: quant.receiptDetail.unitPrice, // Gi√° v·ªën ƒë√≠ch danh
      batchNo: quant.receiptDetail.batchNo,
      expiryDate: quant.receiptDetail.expiryDate,
    });

    remaining -= takeQty;
  }

  // Step 3: Validate ƒë·ªß h√†ng
  if (remaining > 0) {
    throw new Error(
      `Kh√¥ng ƒë·ªß t·ªìn kho. C√≤n thi·∫øu ${remaining} ${material.uom.value}`
    );
  }

  return allocations;
}
```

### FR-4: Logic X√°c Nh·∫≠n Xu·∫•t Kho (Posting)

```typescript
async function confirmGoodsIssue(issueId: number) {
  return await prisma.$transaction(async (tx) => {
    const issue = await tx.goodsIssue.findUnique({
      where: { id: issueId },
      include: { details: true },
    });

    if (issue.status !== "DRAFT") {
      throw new Error("Ch·ªâ x√°c nh·∫≠n ƒë∆∞·ª£c phi·∫øu ·ªü tr·∫°ng th√°i Nh√°p");
    }

    // Process t·ª´ng d√≤ng y√™u c·∫ßu
    for (const requestLine of issue.details) {
      // Ch·∫°y FIFO Engine
      const allocations = await allocateStock(
        requestLine.materialId,
        requestLine.requestedQuantity
      );

      // X·ª≠ l√Ω t·ª´ng allocation
      for (const alloc of allocations) {
        // 1. Tr·ª´ t·ªìn kho
        await tx.stockQuant.update({
          where: { id: alloc.stockQuantId },
          data: { quantity: { decrement: alloc.quantity } },
        });

        // 2. T·∫°o chi ti·∫øt phi·∫øu xu·∫•t (1 d√≤ng y√™u c·∫ßu ‚Üí N d√≤ng k·∫øt qu·∫£)
        await tx.goodsIssueDetail.create({
          data: {
            goodsIssueId: issueId,
            materialId: alloc.materialId,
            quantity: alloc.quantity,
            costPrice: alloc.unitCost,
            totalCost: alloc.quantity * alloc.unitCost,
            goodsReceiptDetailId: alloc.goodsReceiptDetailId, // Link ngu·ªìn
          },
        });

        // 3. Ghi StockMove
        await tx.stockMove.create({
          data: {
            type: issue.customerId ? "OUT_PATIENT" : "OUT_DEPARTMENT",
            materialId: alloc.materialId,
            quantityChange: -alloc.quantity, // S·ªë √¢m
            goodsIssueId: issueId,
            goodsReceiptDetailId: alloc.goodsReceiptDetailId,
          },
        });
      }
    }

    // Update header
    const totalCost = await calculateTotalCost(issueId);
    await tx.goodsIssue.update({
      where: { id: issueId },
      data: {
        status: "POSTED",
        totalCost: totalCost,
      },
    });
  });
}
```

### FR-5: API Endpoints

```
GET    /api/inventory/goods-issues?page=1&limit=20&status=&employeeId=&customerId=
GET    /api/inventory/goods-issues/:id
GET    /api/inventory/goods-issues/:id/preview-allocation  # Preview FIFO tr∆∞·ªõc khi POST
POST   /api/inventory/goods-issues                         # Create draft
PUT    /api/inventory/goods-issues/:id                     # Update draft
DELETE /api/inventory/goods-issues/:id                     # Delete draft
POST   /api/inventory/goods-issues/:id/confirm             # Posting (run FIFO)
POST   /api/inventory/goods-issues/:id/cancel              # Cancel posted
```

## üíæ Data Model (Prisma)

```prisma
enum GoodsIssueStatus {
  DRAFT
  POSTED
  CANCELLED
}

model GoodsIssue {
  id           Int              @id @default(autoincrement())
  code         String           @unique // GIN-YYYYMMDD-XXXX
  issueDate    DateTime         @default(now())

  // ƒê·ªëi t∆∞·ª£ng nh·∫≠n (Ch·ªçn 1 trong 2 ho·∫∑c c·∫£ 2)
  employeeId   Int?
  employee     Employee?        @relation(fields: [employeeId], references: [id])

  customerId   Int?
  customer     Customer?        @relation(fields: [customerId], references: [id])

  status       GoodsIssueStatus @default(DRAFT)
  note         String?
  totalCost    Decimal          @default(0) @db.Decimal(15, 2) // T·ªïng gi√° v·ªën

  createdById  Int?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Quan h·ªá
  requestLines GoodsIssueRequest[] // D√≤ng y√™u c·∫ßu (user nh·∫≠p)
  details      GoodsIssueDetail[]  // D√≤ng k·∫øt qu·∫£ (sau FIFO)
  stockMoves   StockMove[]

  @@index([code])
  @@index([issueDate, status])
  @@index([employeeId])
  @@index([customerId])
}

// B·∫£ng l∆∞u y√™u c·∫ßu xu·∫•t (input t·ª´ user)
model GoodsIssueRequest {
  id                Int          @id @default(autoincrement())
  goodsIssueId      Int
  goodsIssue        GoodsIssue   @relation(fields: [goodsIssueId], references: [id], onDelete: Cascade)

  materialId        Int
  material          Material     @relation(fields: [materialId], references: [id])

  requestedQuantity Decimal      @db.Decimal(15, 2) // S·ªë l∆∞·ª£ng user mu·ªën xu·∫•t
}

// B·∫£ng l∆∞u k·∫øt qu·∫£ sau khi ch·∫°y FIFO (1 request ‚Üí N details)
model GoodsIssueDetail {
  id                   Int                @id @default(autoincrement())
  goodsIssueId         Int
  goodsIssue           GoodsIssue         @relation(fields: [goodsIssueId], references: [id], onDelete: Cascade)

  materialId           Int
  material             Material           @relation(fields: [materialId], references: [id])

  quantity             Decimal            @db.Decimal(15, 2) // S·ªë l∆∞·ª£ng th·ª±c xu·∫•t
  costPrice            Decimal            @db.Decimal(15, 2) // Gi√° v·ªën ƒë√≠ch danh
  totalCost            Decimal            @db.Decimal(15, 2)

  // TRUY XU·∫§T NGU·ªíN G·ªêC: Xu·∫•t t·ª´ phi·∫øu nh·∫≠p n√†o?
  goodsReceiptDetailId Int
  sourceReceiptDetail  GoodsReceiptDetail @relation(fields: [goodsReceiptDetailId], references: [id])

  @@index([goodsIssueId])
  @@index([goodsReceiptDetailId])
}
```

## ‚úÖ Validation (Zod Schema)

```typescript
import { z } from "zod";

// Schema cho d√≤ng y√™u c·∫ßu (user input)
export const goodsIssueRequestSchema = z.object({
  materialId: z.number({ required_error: "Vui l√≤ng ch·ªçn v·∫≠t t∆∞" }).positive(),
  requestedQuantity: z.number().positive("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0").max(999999),
});

// Schema cho c·∫£ phi·∫øu
export const goodsIssueSchema = z
  .object({
    issueDate: z.date(),

    // √çt nh·∫•t 1 trong 2 ph·∫£i c√≥
    employeeId: z.number().int().positive().optional().nullable(),
    customerId: z.number().int().positive().optional().nullable(),

    note: z.string().max(1000).optional(),

    requestLines: z
      .array(goodsIssueRequestSchema)
      .min(1, "Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 d√≤ng v·∫≠t t∆∞"),
  })
  .refine((data) => data.employeeId || data.customerId, {
    message: "Vui l√≤ng ch·ªçn ƒë·ªëi t∆∞·ª£ng nh·∫≠n (B√°c sƒ© ho·∫∑c B·ªánh nh√¢n)",
  });
```

## üß™ Test Cases

### TC-1: Preview FIFO allocation

- **Input**: GET /goods-issues/preview?materialId=1&qty=15
- **Expected**: Tr·∫£ v·ªÅ danh s√°ch allocations d·ª± ki·∫øn (kh√¥ng l∆∞u DB)

### TC-2: X√°c nh·∫≠n xu·∫•t - ƒë·ªß h√†ng

- **Setup**: T·ªìn kho = 50
- **Input**: POST /goods-issues/123/confirm v·ªõi qty=15
- **Expected**:
  - Status POSTED
  - GoodsIssueDetail ƒë∆∞·ª£c t·∫°o theo FIFO
  - StockQuant gi·∫£m ƒë√∫ng
  - StockMove ghi log

### TC-3: X√°c nh·∫≠n xu·∫•t - kh√¥ng ƒë·ªß h√†ng

- **Setup**: T·ªìn kho = 10
- **Input**: Y√™u c·∫ßu xu·∫•t 15
- **Expected**: Status 400, "Kh√¥ng ƒë·ªß t·ªìn kho. C√≤n thi·∫øu 5..."

### TC-4: FIFO ƒë√∫ng th·ª© t·ª±

- **Setup**:
  - Quant 1: receiptDetailId=100, qty=10
  - Quant 2: receiptDetailId=105, qty=20
- **Input**: Xu·∫•t 15
- **Expected**: L·∫•y 10 t·ª´ quant 1, 5 t·ª´ quant 2

### TC-5: T√≠nh gi√° v·ªën ƒë√≠ch danh

- **Setup**:
  - L√¥ 1: 10 c√°i @ 100k
  - L√¥ 2: 5 c√°i @ 110k
- **Input**: Xu·∫•t 15
- **Expected**: T·ªïng gi√° v·ªën = 1,550,000

### TC-6: Validate ƒë·ªëi t∆∞·ª£ng nh·∫≠n

- **Input**: Kh√¥ng ch·ªçn c·∫£ employeeId v√† customerId
- **Expected**: Status 400, "Vui l√≤ng ch·ªçn ƒë·ªëi t∆∞·ª£ng"

### TC-7: Truy xu·∫•t ngu·ªìn g·ªëc

- **Action**: Xem chi ti·∫øt phi·∫øu xu·∫•t
- **Expected**: Hi·ªÉn th·ªã s·ªë phi·∫øu nh·∫≠p, l√¥ NSX, HSD g·ªëc

## üéØ Acceptance Criteria

- [ ] Danh s√°ch phi·∫øu xu·∫•t v·ªõi filter
- [ ] Form ch·ªâ y√™u c·∫ßu: V·∫≠t t∆∞ + S·ªë l∆∞·ª£ng (kh√¥ng nh·∫≠p gi√°/l√¥)
- [ ] Dropdown ch·ªçn B√°c sƒ©/B·ªánh nh√¢n t·ª´ b·∫£ng c√≥ s·∫µn
- [ ] API preview FIFO allocation tr∆∞·ªõc khi x√°c nh·∫≠n
- [ ] Validate t·ªìn kho ƒë·ªß tr∆∞·ªõc khi POST
- [ ] FIFO Engine ch·∫°y ƒë√∫ng (sort by goodsReceiptDetailId ASC)
- [ ] T√≠nh gi√° v·ªën ƒë√≠ch danh t·ª´ng allocation
- [ ] View chi ti·∫øt hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß: ngu·ªìn g·ªëc, l√¥ NSX, HSD, gi√° v·ªën
- [ ] GoodsIssueDetail link ch√≠nh x√°c v·ªõi GoodsReceiptDetail
- [ ] StockMove ghi log ƒë·∫ßy ƒë·ªß
- [ ] H·ªßy phi·∫øu (n·∫øu c√≥ th·ªÉ ho√†n tr·∫£)

## üîó Integration v·ªõi Phase 2

### C·∫£nh B√°o HSD (015.8)

- Khi ch·∫°y FIFO, **KH√îNG** ch·∫∑n xu·∫•t h√†ng h·∫øt h·∫°n
- Ch·ªâ c·∫£nh b√°o tr√™n dashboard/b√°o c√°o
- User t·ª± quy·∫øt ƒë·ªãnh c√≥ xu·∫•t hay kh√¥ng

---

**Priority**: üî¥ Critical (C·∫∑p v·ªõi GRN ƒë·ªÉ ho√†n thi·ªán FIFO)  
**Estimated Effort**: 4-5 ng√†y  
**Dependencies**: 015.4 Goods Receipt, Employee table, Customer table
