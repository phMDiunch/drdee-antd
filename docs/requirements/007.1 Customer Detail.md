# ğŸ§© Requirements: Customer Detail View

> **ğŸ“Š STATUS: PLANNING** - Specification phase  
> **ğŸ“„ Feature Documentation**: `docs/features/007.1_Customer_Detail.md` (to be created)  
> **ğŸ”— Implementation**: `src/features/customers/`, `src/app/(private)/customers/[id]/`

## ğŸ“Š Tham kháº£o

- **Requirements gá»‘c**: `docs/Dá»± Ã¡n cÅ©/07. customers/CUSTOMER_DETAIL_REQUIREMENTS.md`
- **Prisma Model**: `prisma/schema.prisma` (Customer model)
- **Customer List**: `docs/requirements/007 Customer.md` (base feature)
- **Current Implementation**: Customer List, Daily View, Create Ä‘Ã£ hoÃ n thÃ nh

## ğŸ¯ Má»¥c TiÃªu & Pháº¡m Vi

### Má»¥c Ä‘Ã­ch

Customer Detail Page lÃ  trang chi tiáº¿t khÃ¡ch hÃ ng toÃ n diá»‡n, hiá»ƒn thá»‹:

- âœ… **ThÃ´ng tin cÃ¡ nhÃ¢n**: Profile Ä‘áº§y Ä‘á»§ cá»§a khÃ¡ch hÃ ng (edit via modal)
- ğŸ”œ **Lá»‹ch háº¹n**: Danh sÃ¡ch appointments (chá» Appointment module)
- ğŸ”œ **Dá»‹ch vá»¥ Ä‘Ã£ tÆ° váº¥n**: Consulted services (chá» Consulted Service module)
- ğŸ”œ **Lá»‹ch sá»­ Ä‘iá»u trá»‹**: Treatment logs (chá» Treatment module)
- ğŸ”œ **Phiáº¿u thu**: Payment vouchers (chá» Payment module)
- ğŸ”œ **ChÄƒm sÃ³c sau Ä‘iá»u trá»‹**: Treatment care (chá» Treatment Care module)

### Pháº¡m Vi Phase 1 (Current)

Do cÃ¡c module liÃªn quan chÆ°a Ä‘Æ°á»£c implement, Phase 1 sáº½ táº­p trung vÃ o:

- âœ… **Route structure**: `/customers/[id]`
- âœ… **Page layout**: Summary Cards + Tab system (6 tabs)
- âœ… **Tab 1 - ThÃ´ng tin chung**: View customer info + Edit modal
- âœ… **Summary Cards**: Customer info + Financial placeholder
- ğŸ”œ **Other tabs**: Placeholder vá»›i "Coming soon" message

### Äá»‘i tÆ°á»£ng sá»­ dá»¥ng

- **NhÃ¢n viÃªn**: Xem & edit customer cá»§a clinic mÃ¬nh
- **Admin**: Full access, edit customer báº¥t ká»³ clinic + xem metadata

---

## ğŸ² Decision Log

### Route & Navigation

- âœ… **URL structure**: `/customers/[id]` - Dynamic route vá»›i UUID

### Page Architecture

- âœ… **SSR Pattern**: Page khÃ´ng fetch user (láº¥y tá»« context)
- âœ… **Client View**: `CustomerDetailView` dÃ¹ng `useCurrentUser()` hook
- âœ… **Layout**: Summary Cards (2 cards) + Tabs + Tab Content
- âœ… **Tab system**: 6 tabs vá»›i count badges (placeholder 0 cho chÆ°a implement)
- âœ… **Edit mode**: Reuse `CreateCustomerModal` vá»›i `mode="edit"`

### Data Loading Strategy

- âœ… **API endpoint**: `GET /api/v1/customers/[id]`
- âœ… **Backend populate**: Service tá»± Ä‘á»™ng include `primaryContact`, `sourceEmployee`, `sourceCustomer`
- âœ… **Phase 1 Response**: Customer + primaryContact + source relations
- ğŸ”œ **Phase 2+**: Include appointments, consultedServices, payments

---

## 1. ğŸ”Œ API Requirements

### 1.1 GET /api/v1/customers/[id]

#### Request

```typescript
// No query params needed - endpoint returns full detail by default
// GET /api/v1/customers/[id]
```

#### Response - Phase 1

```typescript
interface CustomerDetailResponse {
  // Core fields
  id: string;
  customerCode: string;
  fullName: string;
  dob: string; // ISO date
  gender: "male" | "female";
  phone: string | null;
  email: string | null;
  address: string;
  city: string;
  district: string;
  occupation: string | null;
  serviceOfInterest: string;
  source: string;
  sourceNotes: string | null;

  // Relations
  clinicId: string;
  clinic: {
    id: string;
    name: string;
    code: string;
  };

  // Primary Contact (populated)
  primaryContactId: string | null;
  primaryContactRole: string | null;
  primaryContact?: {
    id: string;
    fullName: string;
    phone: string;
    customerCode: string;
  } | null;

  // Source Relations (populated by backend)
  sourceEmployee?: {
    id: string;
    fullName: string;
    phone: string | null;
  } | null; // Náº¿u source = 'employee_referral'

  sourceCustomer?: {
    id: string;
    fullName: string;
    phone: string | null;
    customerCode: string;
  } | null; // Náº¿u source = 'customer_referral'

  // Metadata (admin only)
  createdAt: string;
  updatedAt: string;
  createdById?: string;
  updatedById?: string;
  createdBy?: { id: string; fullName: string };
  updatedBy?: { id: string; fullName: string };
}
```

#### Response - Phase 2+ (With Related Data)

```typescript
interface CustomerDetailResponseFull extends CustomerDetailResponse {
  // Chá» implement modules
  appointments?: Appointment[];
  consultedServices?: ConsultedService[];
  paymentVouchers?: PaymentVoucher[];
  treatmentLogs?: TreatmentLog[];
  treatmentCares?: TreatmentCare[];
}
```

#### Business Rules

- **Backend populate**: Service tá»± Ä‘á»™ng include `primaryContact`, `sourceEmployee`, `sourceCustomer` dá»±a trÃªn `source` type
- **Conditional fields**: `sourceEmployee` chá»‰ cÃ³ khi `source = 'employee_referral'`
- **Metadata**: `createdBy`, `updatedBy` chá»‰ tráº£ vá» khi `currentUser.role === 'admin'`

#### Error Responses

```typescript
interface ErrorResponses {
  404: "KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng";
  403: "KhÃ´ng cÃ³ quyá»n truy cáº­p khÃ¡ch hÃ ng nÃ y"; // Cross-clinic access
  500: "Lá»—i server";
}
```

### 1.2 PATCH /api/v1/customers/[id] (Update)

#### Request

```typescript
// Body: Partial customer update (reuse CreateCustomerRequest schema)
interface UpdateCustomerRequest {
  fullName?: string;
  dob?: string; // ISO date
  gender?: "male" | "female";
  phone?: string | null;
  email?: string | null;
  address?: string;
  city?: string;
  district?: string;
  occupation?: string | null;
  serviceOfInterest?: string;
  source?: string;
  sourceNotes?: string | null;
  primaryContactId?: string | null;
  primaryContactRole?: string | null;
  // clinicId: KHÃ”NG cho phÃ©p update (immutable)
  // customerCode: KHÃ”NG cho phÃ©p update (immutable)
}
```

#### Validation Rules

- Same validation rules as Create (ref: `007 Customer.md`)
- **Immutable fields**: `customerCode`, `clinicId` bá»‹ reject náº¿u cÃ³ trong request
- Phone/Email uniqueness check exclude current customer ID
- Conditional validation: phone â†” primaryContact logic (reuse from Create)

#### Response

```typescript
// Tráº£ vá» CustomerDetailResponse Ä‘Ã£ update (same structure as GET)
```

#### Error Responses

```typescript
interface UpdateErrorResponses {
  400: "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡";
  404: "KhÃ´ng tÃ¬m tháº¥y khÃ¡ch hÃ ng";
  409: "Sá»‘ Ä‘iá»‡n thoáº¡i/Email Ä‘Ã£ tá»“n táº¡i";
  403: "KhÃ´ng cÃ³ quyá»n cáº­p nháº­t khÃ¡ch hÃ ng nÃ y";
}
```

---

## 2. ğŸ¨ UI/UX Architecture

### 2.1 Page Structure

**Route**: `/customers/[id]/page.tsx` (SSR)

```tsx
// SSR Page - No user fetch needed (available via context)
export default async function CustomerDetailPage({
  params,
}: {
  params: { id: string };
}) {
  return <CustomerDetailView customerId={params.id} />;
}
```

**Main Component**: `CustomerDetailView.tsx` (Client)

```tsx
"use client";
import { useCurrentUser } from "@/shared/providers/user-provider";

export default function CustomerDetailView({
  customerId,
}: {
  customerId: string;
}) {
  const { user: currentUser } = useCurrentUser();
  const isAdmin = currentUser?.role === "admin";

  // ... fetch customer detail
  // ... render layout
}
```

Layout trá»±c tiáº¿p trong component (khÃ´ng tÃ¡ch sub-components):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Card 1: Customer Info     â”‚  â”‚ Card 2: Financial        â”‚ â”‚
â”‚ â”‚ - Há» tÃªn (Tuá»•i)          â”‚  â”‚ - Placeholder Phase 1    â”‚ â”‚
â”‚ â”‚ - MÃ£ KH                  â”‚  â”‚ "ChÆ°a cÃ³ dá»‹ch vá»¥..."    â”‚ â”‚
â”‚ â”‚ - SÄT                    â”‚  â”‚                          â”‚ â”‚
â”‚ â”‚ - Check-in status (P2)   â”‚  â”‚                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ [ThÃ´ng tin chung] [Lá»‹ch háº¹n (0)] [Dá»‹ch vá»¥ (0)]       â”‚   â”‚
â”‚ â”‚ [Lá»‹ch sá»­ Ä‘iá»u trá»‹] [ChÄƒm sÃ³c sau Ä‘iá»u trá»‹] [Phiáº¿u thu]â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              TAB CONTENT (Dynamic)                      â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Component Hierarchy

```typescript
interface ComponentStructure {
  page: "app/(private)/customers/[id]/page.tsx"; // SSR

  mainView: "CustomerDetailView.tsx"; // Client component - all layout inline
  // Layout trá»±c tiáº¿p: Row/Col cho cards, Tabs, dynamic tab content

  tabComponents: {
    // TÃ¡ch riÃªng, trong folder detail-tabs/
    tab1: "CustomerInfoTab.tsx"; // âœ… Phase 1 - View + Edit button
    tab2: "AppointmentsTab.tsx"; // ğŸ”œ Placeholder
    tab3: "ConsultedServicesTab.tsx"; // ğŸ”œ Placeholder
    tab4: "TreatmentLogsTab.tsx"; // ğŸ”œ Placeholder
    tab5: "TreatmentCareTab.tsx"; // ğŸ”œ Placeholder
    tab6: "PaymentsTab.tsx"; // ğŸ”œ Placeholder
  };

  modal: "CreateCustomerModal"; // Reuse for edit mode
}
```

### 2.3 Summary Cards Detail

#### Card 1: Customer Basic Info

```tsx
interface CustomerInfoCardDisplay {
  fields: [
    {
      label: "{fullName} ({age} tuá»•i)"; // TÃ­nh age tá»« dob
      style: "large, bold";
      icon: "UserOutlined";
    },
    {
      label: "MÃ£ KH: {customerCode}";
      style: "secondary";
      icon: "IdcardOutlined";
    },
    {
      label: "{phone || 'â€”'}";
      icon: "PhoneOutlined";
    },
    {
      // Phase 2: Check-in status
      label: "ChÆ°a check-in"; // hoáº·c "ÄÃ£ check-in HH:mm"
      icon: "ClockCircleOutlined";
      color: "warning | success";
    }
  ];
}
```

**Age Calculation**: `dayjs().diff(dayjs(dob), 'year')`

#### Card 2: Financial Summary (Phase 1 Placeholder)

```tsx
<Empty
  image={Empty.PRESENTED_IMAGE_SIMPLE}
  description="ğŸ“‹ ChÆ°a cÃ³ dá»‹ch vá»¥ nÃ o Ä‘Æ°á»£c chá»‘t"
/>
```

**Phase 2+**: TÃ­nh tá»« `consultedServices` cÃ³ `serviceStatus === 'ÄÃ£ chá»‘t'`

---

## 3. ğŸ“‹ Tab 1: ThÃ´ng Tin Chung

### 3.1 Component: `CustomerInfoTab.tsx`

**Location**: `src/features/customers/components/detail-tabs/CustomerInfoTab.tsx`

**Props**:

```typescript
interface CustomerInfoTabProps {
  customer: CustomerDetailResponse;
  onEditSuccess: () => void; // Callback to refetch data
}
```

**Note**: Component tá»± láº¥y `currentUser` tá»« `useCurrentUser()` hook

### 3.2 Layout Structure

```tsx
import { useCurrentUser } from "@/shared/providers/user-provider";

export default function CustomerInfoTab({
  customer,
  onEditSuccess,
}: CustomerInfoTabProps) {
  const { user: currentUser } = useCurrentUser();
  const isAdmin = currentUser?.role === "admin";

  return (
    <Space direction="vertical" size="large" style={{ width: "100%" }}>
      {/* Metadata Section (Admin Only) */}
      {isAdmin && (
        <Alert
          type="info"
          message={
            <>
              <Text type="secondary">
                Táº¡o bá»Ÿi: {customer.createdBy?.fullName} vÃ o{" "}
                {formatDateTime(customer.createdAt)}
              </Text>
              <Divider type="vertical" />
              <Text type="secondary">
                Cáº­p nháº­t bá»Ÿi: {customer.updatedBy?.fullName} vÃ o{" "}
                {formatDateTime(customer.updatedAt)}
              </Text>
            </>
          }
        />
      )}

      {/* Title + Edit Button */}
      <Row justify="space-between" align="middle">
        <Title level={4}>ThÃ´ng tin chi tiáº¿t</Title>
        <Button type="primary" icon={<EditOutlined />} onClick={handleEdit}>
          Sá»­a
        </Button>
      </Row>

      {/* Descriptions */}
      <Descriptions bordered column={2} size="small">
        {/* ... fields ... */}
      </Descriptions>
    </Space>
  );
}
```

### 3.3 Descriptions Fields

| Label               | Field               | Display Logic                               | Span |
| ------------------- | ------------------- | ------------------------------------------- | ---- |
| MÃ£ khÃ¡ch hÃ ng       | `customerCode`      | Text (read-only)                            | 1    |
| Há» vÃ  tÃªn           | `fullName`          | Text                                        | 1    |
| NgÃ y sinh           | `dob`               | Format `DD/MM/YYYY`                         | 1    |
| Giá»›i tÃ­nh           | `gender`            | `"Nam" \| "Ná»¯"`                             | 1    |
| Sá»‘ Ä‘iá»‡n thoáº¡i       | `phone`             | `phone \|\| "â€”"`                            | 1    |
| Email               | `email`             | `email \|\| "â€”"`                            | 1    |
| Äá»‹a chá»‰             | `address`           | Text                                        | 2    |
| ThÃ nh phá»‘           | `city`              | Label tá»« Vietnam data                       | 1    |
| Quáº­n/Huyá»‡n          | `district`          | Label tá»« Vietnam data                       | 1    |
| Nghá» nghiá»‡p         | `occupation`        | `occupation \|\| "â€”"`                       | 2    |
| Dá»‹ch vá»¥ quan tÃ¢m    | `serviceOfInterest` | Label tá»« `SERVICES_OF_INTEREST`             | 2    |
| Nguá»“n khÃ¡ch         | `source`            | Label tá»« `CUSTOMER_SOURCES`                 | 1    |
| Ghi chÃº nguá»“n       | `sourceNotes`       | **Special rendering** (xem bÃªn dÆ°á»›i)        | 1    |
| NgÆ°á»i liÃªn há»‡ chÃ­nh | `primaryContact`    | `"{name} â€” {phone}"` náº¿u cÃ³, `"â€”"` náº¿u null | 2    |
| PhÃ²ng khÃ¡m          | `clinic.name`       | Text (read-only)                            | 2    |

### 3.4 Source Notes Display Logic

**Backend Ä‘Ã£ populate**: `sourceEmployee` vÃ  `sourceCustomer` trong response

```typescript
function renderSourceNotes() {
  const sourceMeta = CUSTOMER_SOURCES.find((s) => s.value === customer.source);

  if (!sourceMeta || sourceMeta.noteType === "none") {
    return "â€”";
  }

  if (customer.source === "employee_referral" && customer.sourceEmployee) {
    return `${customer.sourceEmployee.fullName}${
      customer.sourceEmployee.phone ? ` â€” ${customer.sourceEmployee.phone}` : ""
    }`;
  }

  if (customer.source === "customer_referral" && customer.sourceCustomer) {
    return `${customer.sourceCustomer.fullName}${
      customer.sourceCustomer.phone ? ` â€” ${customer.sourceCustomer.phone}` : ""
    } (${customer.sourceCustomer.customerCode})`;
  }

  // Text input types
  return customer.sourceNotes || "â€”";
}
```

### 3.5 Edit Modal Integration

**Modal**: Reuse `CreateCustomerModal` vá»›i `mode="edit"`

```typescript
<CreateCustomerModal
  open={editModalOpen}
  onCancel={() => setEditModalOpen(false)}
  onSuccess={handleEditSuccess}
  mode="edit"
  initialData={{
    ...customer,
    dob: dayjs(customer.dob), // Convert to dayjs for DatePicker
  }}
/>
```

**Note**: Modal tá»± láº¥y `currentUser` tá»« `useCurrentUser()` hook

**CreateCustomerModal Updates** (cáº§n modify):

- Accept `mode?: 'create' | 'edit'` prop
- Accept `initialData?: Partial<Customer>` prop
- When `mode === 'edit'`:
  - Disable fields: `customerCode`, `clinicId` (set `disabled={true}`)
  - Form default values = `initialData`
  - Submit calls `PATCH /api/v1/customers/[id]` instead of POST
  - Success callback: `onSuccess()` to refetch data

---

## 4. ğŸ”œ Tab 2-6: Placeholder Tabs

### Components

**Location**: `src/features/customers/components/detail-tabs/`

- `AppointmentsTab.tsx`
- `ConsultedServicesTab.tsx`
- `TreatmentLogsTab.tsx`
- `TreatmentCareTab.tsx`
- `PaymentsTab.tsx`

**Content** (Phase 1):

```tsx
export default function AppointmentsTab() {
  return (
    <Empty
      image={Empty.PRESENTED_IMAGE_SIMPLE}
      description={
        <>
          <Typography.Title level={4}>
            TÃ­nh nÄƒng Ä‘ang phÃ¡t triá»ƒn
          </Typography.Title>
          <Typography.Text type="secondary">
            Tab "Lá»‹ch háº¹n" sáº½ Ä‘Æ°á»£c bá»• sung trong phiÃªn báº£n tiáº¿p theo
          </Typography.Text>
        </>
      }
    />
  );
}
```

---

## 5. âš™ï¸ State Management

### 5.1 React Query Hook

**File**: `src/features/customers/hooks/useCustomerDetail.ts`

```typescript
export function useCustomerDetail(id: string) {
  return useQuery({
    queryKey: ["customers", "detail", id],
    queryFn: () => getCustomerDetailApi(id),
    enabled: !!id,
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
}
```

### 5.2 Update Mutation Hook

**File**: `src/features/customers/hooks/useUpdateCustomer.ts`

```typescript
export function useUpdateCustomer(id: string) {
  const queryClient = useQueryClient();
  const notify = useNotify();

  return useMutation({
    mutationFn: (data: UpdateCustomerRequest) => updateCustomerApi(id, data),
    onSuccess: () => {
      // Invalidate detail query
      queryClient.invalidateQueries({ queryKey: ["customers", "detail", id] });
      // Invalidate list queries
      queryClient.invalidateQueries({ queryKey: ["customers"] });

      notify.success("Cáº­p nháº­t thÃ´ng tin khÃ¡ch hÃ ng thÃ nh cÃ´ng");
    },
    onError: (error) => {
      notify.error(error, {
        fallback: "CÃ³ lá»—i xáº£y ra khi cáº­p nháº­t khÃ¡ch hÃ ng",
      });
    },
  });
}
```

### 5.3 Local State (in CustomerDetailView)

```typescript
const [activeTab, setActiveTab] = useState<string>("info");
const [editModalOpen, setEditModalOpen] = useState(false);
```

---

## 6. ğŸ”’ Security & Permissions

### Access Control

**Server-side (API)**:

```typescript
interface AccessControl {
  rule: "User chá»‰ xem Ä‘Æ°á»£c customer trong clinic cá»§a mÃ¬nh";
  exception: "Admin cÃ³ thá»ƒ xem cross-clinic";

  implementation: {
    GET: "Service filter by clinicId tá»« currentUser.clinicId";
    PATCH: "Validate clinicId match vá»›i user session";
  };
}
```

**Client-side (UI)**:

```typescript
interface UIPermissions {
  viewCustomer: {
    employee: "Chá»‰ customer trong clinic cá»§a mÃ¬nh";
    admin: "Táº¥t cáº£ customers";
  };

  editCustomer: {
    employee: "Chá»‰ customer trong clinic cá»§a mÃ¬nh";
    admin: "Táº¥t cáº£ customers";
    validation: "Server-side enforcement";
  };

  viewMetadata: {
    employee: false; // KhÃ´ng hiá»ƒn thá»‹ createdBy/updatedBy
    admin: true; // Hiá»ƒn thá»‹ metadata alert
  };
}
```

### Field-level Restrictions

```typescript
interface FieldRestrictions {
  immutableFields: [
    "customerCode", // KhÃ´ng bao giá» Ä‘Æ°á»£c edit
    "clinicId" // KhÃ´ng bao giá» Ä‘Æ°á»£c edit
  ];

  readOnlyDisplay: [
    "createdAt", // System generated
    "updatedAt", // System generated
    "createdBy", // System generated (admin only)
    "updatedBy" // System generated (admin only)
  ];
}
```

---

## 7. ğŸ¯ Acceptance Criteria

### AC1: Page Access

âœ… **Given** user click customer tá»« List view  
**When** navigate to `/customers/[id]`  
**Then** hiá»ƒn thá»‹ Customer Detail page vá»›i Ä‘Ãºng thÃ´ng tin

âœ… **Given** employee access customer khÃ¡c clinic  
**When** API call  
**Then** tráº£ 403 error

âœ… **Given** customer khÃ´ng tá»“n táº¡i  
**When** access URL  
**Then** hiá»ƒn thá»‹ 404 error vá»›i friendly message

### AC2: Summary Cards

âœ… **Given** customer data loaded  
**When** render cards  
**Then** Card 1 hiá»ƒn thá»‹ name (age), code, phone

âœ… **Given** Phase 1  
**When** render Card 2  
**Then** hiá»ƒn thá»‹ placeholder "ChÆ°a cÃ³ dá»‹ch vá»¥ nÃ o Ä‘Æ°á»£c chá»‘t"

### AC3: Tab System

âœ… **Given** page loaded  
**When** default state  
**Then** Tab "ThÃ´ng tin chung" active

âœ… **Given** click tab khÃ¡c  
**When** tab clicked  
**Then** hiá»ƒn thá»‹ placeholder "TÃ­nh nÄƒng Ä‘ang phÃ¡t triá»ƒn"

### AC4: Customer Info Tab - Display

âœ… **Given** tab active  
**When** render  
**Then** hiá»ƒn thá»‹ Descriptions vá»›i táº¥t cáº£ fields

âœ… **Given** field null/undefined  
**When** display  
**Then** hiá»ƒn thá»‹ "â€”"

âœ… **Given** source = employee_referral vÃ  cÃ³ sourceEmployee  
**When** display sourceNotes  
**Then** hiá»ƒn thá»‹ "{employee.fullName} â€” {phone}"

âœ… **Given** source = customer_referral vÃ  cÃ³ sourceCustomer  
**When** display sourceNotes  
**Then** hiá»ƒn thá»‹ "{customer.fullName} â€” {phone} ({code})"

âœ… **Given** admin user  
**When** render tab  
**Then** hiá»ƒn thá»‹ metadata alert (createdBy, updatedBy)

âœ… **Given** employee user  
**When** render tab  
**Then** khÃ´ng hiá»ƒn thá»‹ metadata alert

### AC5: Edit Modal

âœ… **Given** click "Sá»­a" button  
**When** clicked  
**Then** má»Ÿ CreateCustomerModal vá»›i mode="edit"

âœ… **Given** modal open vá»›i initialData  
**When** render  
**Then** form pre-filled vá»›i customer data

âœ… **Given** modal mode="edit"  
**When** render  
**Then** customerCode vÃ  clinicId fields bá»‹ disabled

âœ… **Given** form valid  
**When** submit  
**Then** call PATCH API, refetch data, close modal, show success toast

âœ… **Given** duplicate phone/email  
**When** submit  
**Then** hiá»ƒn thá»‹ error message tá»« API

---

## 8. ğŸ“ File Structure

```
src/features/customers/
â”œâ”€â”€ constants.ts                       # (existing)
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ getCustomers.ts               # (existing)
â”‚   â”œâ”€â”€ getCustomersDaily.ts          # (existing)
â”‚   â”œâ”€â”€ createCustomer.ts             # (existing)
â”‚   â”œâ”€â”€ searchCustomers.ts            # (existing)
â”‚   â”œâ”€â”€ getCustomerDetail.ts          # âœ¨ NEW
â”‚   â”œâ”€â”€ updateCustomer.ts             # âœ¨ NEW
â”‚   â””â”€â”€ index.ts                      # Barrel export
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ CreateCustomerModal.tsx       # (existing - UPDATE for edit mode)
â”‚   â”œâ”€â”€ CustomerTable.tsx             # (existing)
â”‚   â”œâ”€â”€ CustomerFilters.tsx           # (existing)
â”‚   â”œâ”€â”€ CustomerStatistics.tsx        # (existing)
â”‚   â””â”€â”€ detail-tabs/                  # âœ¨ NEW folder
â”‚       â”œâ”€â”€ CustomerInfoTab.tsx       # âœ¨ NEW
â”‚       â”œâ”€â”€ AppointmentsTab.tsx       # âœ¨ NEW (placeholder)
â”‚       â”œâ”€â”€ ConsultedServicesTab.tsx  # âœ¨ NEW (placeholder)
â”‚       â”œâ”€â”€ TreatmentLogsTab.tsx      # âœ¨ NEW (placeholder)
â”‚       â”œâ”€â”€ TreatmentCareTab.tsx      # âœ¨ NEW (placeholder)
â”‚       â””â”€â”€ PaymentsTab.tsx           # âœ¨ NEW (placeholder)
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useCustomers.ts               # (existing)
â”‚   â”œâ”€â”€ useCustomersDaily.ts          # (existing)
â”‚   â”œâ”€â”€ useCustomersSearch.ts         # (existing)
â”‚   â”œâ”€â”€ useCreateCustomer.ts          # (existing)
â”‚   â”œâ”€â”€ useCustomerDetail.ts          # âœ¨ NEW
â”‚   â”œâ”€â”€ useUpdateCustomer.ts          # âœ¨ NEW
â”‚   â””â”€â”€ index.ts                      # Barrel export
â””â”€â”€ views/
    â”œâ”€â”€ CustomerListView.tsx          # (existing)
    â”œâ”€â”€ CustomerDailyView.tsx         # (existing)
    â””â”€â”€ CustomerDetailView.tsx        # âœ¨ NEW

src/app/(private)/customers/
â”œâ”€â”€ page.tsx                          # (existing - List)
â”œâ”€â”€ daily/
â”‚   â””â”€â”€ page.tsx                      # (existing - Daily)
â””â”€â”€ [id]/
    â””â”€â”€ page.tsx                      # âœ¨ NEW - Detail (SSR)

src/app/api/v1/customers/
â”œâ”€â”€ route.ts                          # (existing - list)
â”œâ”€â”€ daily/route.ts                    # (existing - daily)
â”œâ”€â”€ search/route.ts                   # (existing - search)
â””â”€â”€ [id]/
    â””â”€â”€ route.ts                      # âœ¨ NEW - get/update detail

src/shared/validation/
â””â”€â”€ customer.schema.ts                # (UPDATE - add UpdateCustomerRequest schema)

src/server/
â”œâ”€â”€ repos/
â”‚   â””â”€â”€ customer.repo.ts              # (UPDATE - add findById, update methods)
â””â”€â”€ services/
    â””â”€â”€ customer.service.ts           # (UPDATE - add getById, update methods)
```

---

## 9. ğŸš€ Implementation Plan - Phase 1

### Backend (Priority 1)

- [ ] **Zod Schema**: `UpdateCustomerRequestSchema` (partial, exclude immutable fields)
- [ ] **Repo**: `customerRepo.findById()`, `customerRepo.update()` vá»›i Prisma includes
- [ ] **Service**: `customerService.getById()` vá»›i source relations populate
- [ ] **Service**: `customerService.update()` vá»›i validation + audit trail
- [ ] **API Route**: `GET /api/v1/customers/[id]` tráº£ vá» full detail vá»›i relations
- [ ] **API Route**: `PATCH /api/v1/customers/[id]` vá»›i validation
- [ ] **Permissions**: Clinic-based access control
- [ ] **Error handling**: 403, 404, 409 responses

### Frontend (Priority 2)

- [ ] **API Client**: `getCustomerDetailApi()`, `updateCustomerApi()`
- [ ] **Hooks**: `useCustomerDetail()`, `useUpdateCustomer()`
- [ ] **Page**: `/customers/[id]/page.tsx` (SSR)
- [ ] **View**: `CustomerDetailView.tsx` (main layout inline)
- [ ] **Tab Component**: `CustomerInfoTab.tsx` (view + edit button)
- [ ] **Placeholder Tabs**: 5 tab components vá»›i "Coming soon"
- [ ] **Modal Update**: `CreateCustomerModal` support edit mode
  - Accept `mode` vÃ  `initialData` props
  - Disable `customerCode`, `clinicId` fields khi edit
  - Call PATCH API thay vÃ¬ POST
- [ ] **Utils**: Age calculation, source notes rendering
- [ ] **Permissions**: Hide metadata cho employee
- [ ] **Loading/Error states**: Skeleton, error boundaries

### Testing (Priority 3)

- [ ] API tests: GET/PATCH endpoints + permissions
- [ ] UI tests: Tab switching, modal edit, validation
- [ ] Integration: Edit flow end-to-end
- [ ] Edge cases: 403, 404, 409 errors

---

## 10. ğŸ“Œ Future Phases

### Phase 2: Appointments Tab âœ… COMPLETED

- âœ… Backend include `appointments` relation
- âœ… Integrate `AppointmentsTable` component with `isCustomerDetailView` prop
- âœ… Check-in status calculation in summary card
- âœ… Create/Edit/Delete appointments for customer
- âœ… Quick actions: Check-in, Check-out, Confirm, Mark No-show
- âœ… Cross-clinic view: See all customer appointments regardless of clinic
- âœ… Clinic selection: Default to customer's clinic, can select any clinic
- âœ… **Multi-clinic access**:
  - Create: Employee & Admin cÃ³ thá»ƒ táº¡o cho báº¥t ká»³ clinic nÃ o
  - Update/Delete: Employee chá»‰ Ä‘Æ°á»£c sá»­a/xÃ³a lá»‹ch cá»§a clinic mÃ¬nh, Admin khÃ´ng giá»›i háº¡n

### Phase 3: Consulted Services Tab

- Backend include `consultedServices` relation
- Financial summary calculation
- Integrate consulted services management

### Phase 4-6: Other Tabs

- Treatment logs, treatment care, payments
- Each phase adds backend includes + replaces placeholder

---

## 11. ğŸ“‹ Technical Notes

### Age Calculation

```typescript
const age = dayjs().diff(dayjs(customer.dob), "year");
```

### Source Notes Rendering

```typescript
function getSourceNotesDisplay(customer: CustomerDetailResponse): string {
  const sourceMeta = CUSTOMER_SOURCES.find((s) => s.value === customer.source);
  if (!sourceMeta || sourceMeta.noteType === "none") return "â€”";

  if (customer.source === "employee_referral" && customer.sourceEmployee) {
    return `${customer.sourceEmployee.fullName}${
      customer.sourceEmployee.phone ? ` â€” ${customer.sourceEmployee.phone}` : ""
    }`;
  }

  if (customer.source === "customer_referral" && customer.sourceCustomer) {
    return `${customer.sourceCustomer.fullName}${
      customer.sourceCustomer.phone ? ` â€” ${customer.sourceCustomer.phone}` : ""
    } (${customer.sourceCustomer.customerCode})`;
  }

  return customer.sourceNotes || "â€”";
}
```

### Modal Reuse Pattern

```typescript
// In CreateCustomerModal.tsx
interface CreateCustomerModalProps {
  open: boolean;
  onCancel: () => void;
  onSuccess: () => void;
  mode?: "create" | "edit"; // âœ¨ NEW
  initialData?: Partial<CustomerDetailResponse>; // âœ¨ NEW
  // âŒ NO currentUser prop - use useCurrentUser() hook inside
}

// Usage in CustomerInfoTab
<CreateCustomerModal
  open={editModalOpen}
  mode="edit"
  initialData={{
    ...customer,
    dob: dayjs(customer.dob), // Convert to dayjs
  }}
  onSuccess={handleEditSuccess}
/>;
```

**Note**: Modal component tá»± láº¥y `currentUser` tá»« `useCurrentUser()` hook

---

## 12. âœ… Definition of Done

- [ ] Backend API tested vÃ  working
- [ ] Frontend components rendered correctly
- [ ] Edit modal reuse implemented
- [ ] Permissions enforced (server + client)
- [ ] Source notes display correctly
- [ ] Metadata visible cho admin only
- [ ] Loading/Error states handled
- [ ] Responsive design working
- [ ] Code reviewed
- [ ] Documentation updated

---

**Document Version**: 2.1  
**Updated**: October 27, 2025  
**Status**: Ready for Implementation  
**Estimated Effort**: 2-3 days (Backend 1 day, Frontend 1-2 days)
