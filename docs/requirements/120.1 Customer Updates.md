# ğŸ”„ Phase 0.1.1: Customer Updates for Lead Integration

> **Date**: 2025-12-13  
> **Status**: âœ… COMPLETED - All features fully implemented and tested  
> **Parent**: 120 Lead Management System  
> **Scope**: Customer model updates and ConvertLeadModal for Lead workflow

---

## ğŸ“Š OVERVIEW

Cáº­p nháº­t **Customer model vÃ  views** Ä‘á»ƒ há»— trá»£ Lead workflow:

1. âœ… Add `type` field to distinguish LEAD vs CUSTOMER
2. âœ… Add `note` and `firstVisitDate` fields
3. âœ… Update Customer repo/service to filter by `type="CUSTOMER"`
4. âœ… Add Convert Lead modal (LEAD â†’ CUSTOMER)
5. âœ… Update table columns (show type, firstVisitDate)

**Business Context:**

- Customer model Ä‘Æ°á»£c share vá»›i Lead (same table)
- Customer repo/service chá»‰ lÃ m viá»‡c vá»›i `type="CUSTOMER"`
- Reception cáº§n tÃ¬m Lead vÃ  convert thÃ nh Customer khi check-in

---

## ğŸ—„ï¸ SCHEMA CHANGES

### Customer Model Updates

```prisma
model Customer {
  id   String @id @default(uuid())

  // â­ NEW: Type field distinguishes LEAD vs CUSTOMER
  type String // "LEAD" | "CUSTOMER" (backend validation)

  // â­ NEW: General notes field
  note String?

  // â­ NEW: First visit date (for CUSTOMER only, NULL for LEAD)
  firstVisitDate DateTime? @db.Timestamptz

  // EXISTING: Conditional fields based on type
  customerCode   String?   @unique      // NULL for LEAD, auto-generated for CUSTOMER
  clinicId       String?                // NULL for LEAD, required for CUSTOMER

  // ... all other existing fields unchanged

  @@index([type, clinicId, createdAt])
  @@index([phone])
  @@map("Customer")
}
```

**Migration:**

```prisma
-- Add new fields to Customer table
ALTER TABLE "Customer" ADD COLUMN "type" TEXT NOT NULL DEFAULT 'CUSTOMER';
ALTER TABLE "Customer" ADD COLUMN "note" TEXT;
ALTER TABLE "Customer" ADD COLUMN "firstVisitDate" TIMESTAMPTZ;

-- Create indexes
CREATE INDEX "Customer_type_clinicId_createdAt_idx" ON "Customer"("type", "clinicId", "createdAt");
CREATE INDEX "Customer_phone_idx" ON "Customer"("phone");

-- Set all existing records to CUSTOMER type
UPDATE "Customer" SET "type" = 'CUSTOMER' WHERE "type" IS NULL;

-- Set firstVisitDate for existing customers (use createdAt as fallback)
UPDATE "Customer" SET "firstVisitDate" = "createdAt" WHERE "firstVisitDate" IS NULL AND "type" = 'CUSTOMER';
```

---

## ğŸ”§ BACKEND CHANGES

### 1. Update Customer Validation Schema

**File:** âœ… `src/shared/validation/customer.schema.ts`

#### A. CustomerCommonFieldsSchema

**Added:**

```typescript
note: z.string().trim().optional().nullable(),
```

#### B. CustomerResponseSchema

**Added:**

```typescript
type: z.string(), // "LEAD" | "CUSTOMER"
firstVisitDate: z.string().datetime().nullable(),
```

#### C. ConvertLeadRequestSchema (New)

**File:** âœ… `src/shared/validation/lead.schema.ts`

**Implementation:**

```typescript
export const ConvertLeadRequestSchema = z
  .object({
    fullName: z.string().trim().min(2).max(200),
    dob: z.coerce.date().nullable().optional(),
    gender: z.string().trim().min(1, "Vui lÃ²ng chá»n giá»›i tÃ­nh"),
    phone: z
      .string()
      .transform((val) => (val === "" ? null : val))
      .nullable()
      .refine((val) => val === null || VN_PHONE_RE.test(val)),
    email: z
      .string()
      .transform((val) => (val === "" ? null : val))
      .nullable()
      .refine(
        (val) => val === null || z.string().email().safeParse(val).success
      ),
    address: z.string().trim().min(1, "Vui lÃ²ng nháº­p Ä‘á»‹a chá»‰"),
    city: z.string().trim().min(1, "Vui lÃ²ng chá»n tá»‰nh/thÃ nh phá»‘"),
    district: z.string().trim().min(1, "Vui lÃ²ng chá»n quáº­n/huyá»‡n"),
    primaryContactRole: z.string().trim().optional().nullable(),
    primaryContactId: z.string().uuid().optional().nullable(),
    clinicId: z.string().uuid("PhÃ²ng khÃ¡m khÃ´ng há»£p lá»‡"),
    serviceOfInterest: z
      .string()
      .trim()
      .min(1, "Vui lÃ²ng chá»n dá»‹ch vá»¥ quan tÃ¢m"),
    source: z.string().trim().min(1, "Vui lÃ²ng chá»n nguá»“n khÃ¡ch hÃ ng"),
    occupation: z.string().trim().optional().nullable(),
    sourceNotes: z.string().trim().optional().nullable(),
    note: z.string().trim().optional().nullable(),
  })
  .superRefine((data, ctx) => {
    // Conditional validation: If no phone â†’ require primaryContactId + primaryContactRole
    if (!data.phone) {
      if (!data.primaryContactId) {
        ctx.addIssue({
          code: "custom",
          message: "Nháº­p sá»‘ Ä‘iá»‡n thoáº¡i hoáº·c chá»n ngÆ°á»i liÃªn há»‡ chÃ­nh",
          path: ["primaryContactId"],
        });
      }
      if (!data.primaryContactRole) {
        ctx.addIssue({
          code: "custom",
          message: "Nháº­p vai trÃ² ngÆ°á»i liÃªn há»‡",
          path: ["primaryContactRole"],
        });
      }
    }
  });
```

**Validation Rules:** Identical to CustomerFormModal requirements

---

### 2. Update Customer Repository

**File:** `src/server/repos/customer.repo.ts`

**Add `type="CUSTOMER"` filter to all queries:**

```typescript
export const customerRepo = {
  // â­ UPDATE: Create - Set type="CUSTOMER"
  async create(data: Prisma.CustomerCreateInput) {
    return prisma.customer.create({
      data: {
        ...data,
        type: "CUSTOMER", // â­ Always CUSTOMER
      },
      include: {
        /* ... */
      },
    });
  },

  // â­ UPDATE: List - Add type filter
  async list(params: {
    /* ... */
  }) {
    const where: Prisma.CustomerWhereInput = {
      type: "CUSTOMER", // â­ Filter only CUSTOMER
      // ... rest of filters
    };

    return prisma.customer.findMany({ where /* ... */ });
  },

  // â­ UPDATE: findById - Add type filter
  async findById(id: string) {
    return prisma.customer.findFirst({
      where: {
        id,
        type: "CUSTOMER", // â­ Filter
      },
      include: {
        /* ... */
      },
    });
  },

  // â­ UPDATE: findByPhone - Add type filter
  async findByPhone(phone: string) {
    return prisma.customer.findFirst({
      where: {
        phone,
        type: "CUSTOMER", // â­ Filter
      },
    });
  },

  // â­ UPDATE: All other methods
  // - listDaily() - Add type="CUSTOMER" filter
  // - findByEmail() - Add type="CUSTOMER" filter
  // - update() - No filter needed (already validated by findById)
  // - delete() - No filter needed (already validated by findById)
};
```

---

### 3. Lead Service - Convert to Customer

**File:** âœ… `src/server/services/lead.service.ts`

**Implementation:**

```typescript
async convertToCustomer(currentUser, leadId, body) {
  // Parse and validate with ConvertLeadRequestSchema
  const parsed = ConvertLeadRequestSchema.safeParse(body);

  // Validate clinic access
  if (currentUser?.role !== "admin" &&
      parsed.data.clinicId !== currentUser?.clinicId) {
    throw new ServiceError("CLINIC_MISMATCH",
      "NhÃ¢n viÃªn chá»‰ cÃ³ thá»ƒ chuyá»ƒn Ä‘á»•i Lead cho chi nhÃ¡nh cá»§a mÃ¬nh", 403);
  }

  // Generate customer code
  const customerCode = await generateCustomerCode(parsed.data.clinicId);

  // Update record: LEAD â†’ CUSTOMER
  const customer = await prisma.customer.update({
    where: { id: leadId },
    data: {
      type: "CUSTOMER",
      customerCode,
      fullName: parsed.data.fullName,
      dob: parsed.data.dob,
      gender: parsed.data.gender,
      phone: parsed.data.phone,
      email: parsed.data.email,
      address: parsed.data.address,
      city: parsed.data.city,
      district: parsed.data.district,
      primaryContactRole: parsed.data.primaryContactRole,
      primaryContactId: parsed.data.primaryContactId,
      clinicId: parsed.data.clinicId,
      occupation: parsed.data.occupation,
      source: parsed.data.source,
      sourceNotes: parsed.data.sourceNotes,
      serviceOfInterest: parsed.data.serviceOfInterest,
      note: parsed.data.note,
      firstVisitDate: new Date(),
      updatedById: currentUser.employeeId,
    },
  });

  return mapCustomerToResponse(customer);
}
```

**Clinic Validation:**

- Admin: Can convert to any clinic
- Employee: Can only convert to their own clinic

````

---

### 4. Customer Server Actions

**File:** `src/server/actions/customer.actions.ts`

**âœ… NO CHANGES** - All existing actions stay the same. `createCustomerAction()` automatically sets `firstVisitDate` via service layer.

---

### 5. Customer API Routes

**Files:** `src/app/api/v1/customers/*.ts`

**âœ… NO CHANGES** - All existing routes stay the same:

- `GET /api/v1/customers` - works as before
- `GET /api/v1/customers/[id]` - works as before
- `GET /api/v1/customers/daily` - works as before

---

## ğŸ¨ FRONTEND CHANGES

### 1. ConvertLeadModal Component

**File:** âœ… `src/features/customers/components/ConvertLeadModal.tsx`

**Purpose:** Convert LEAD â†’ CUSTOMER when reception check-in

**Implementation:** Matches CustomerFormModal exactly (same layout, validation, fields)

**Form Layout (5 rows):**

- **H1 (Há» tÃªn | NgÃ y sinh | Giá»›i tÃ­nh)**:
  - fullName (12 cols, editable)
  - dob (6 cols, DatePicker)
  - gender (6 cols, Radio, required)

- **H2 (Sá»‘ Ä‘iá»‡n thoáº¡i | NgÆ°á»i liÃªn há»‡ | Vai trÃ²)**:
  - phone (8 cols, disabled - from Lead)
  - primaryContactId (8 cols, Select with search)
  - primaryContactRole (8 cols, Select)

- **H3 (Äá»‹a chá»‰ | Tá»‰nh/TP | Quáº­n/Huyá»‡n)**:
  - address (12 cols, required)
  - city (6 cols, editable)
  - district (6 cols, required, depends on city)

- **H4 (Email | Nghá» nghiá»‡p | Chi nhÃ¡nh)**:
  - email (8 cols, Email validation)
  - occupation (8 cols, Select with tags mode)
  - clinicId (8 cols, required, disabled for non-admin)

- **H5 (Dá»‹ch vá»¥ quan tÃ¢m | Nguá»“n khÃ¡ch | Ghi chÃº nguá»“n)**:
  - serviceOfInterest (8 cols, required, Select)
  - source (8 cols, required, editable)
  - sourceNotes (8 cols, conditional based on source type, editable)

- **H6 (Ghi chÃº)**:
  - note (24 cols, TextArea, 3 rows)

**Required Fields:**
- fullName, gender, address, city, district, clinicId, serviceOfInterest, source
- Conditional: If no phone â†’ must have primaryContactId + primaryContactRole

**Clinic Logic:**
- Admin: Can select any clinic
- Employee: Disabled, default to user's clinic, validated on backend

**Action:** `convertLeadToCustomerAction(leadId, data)`

**Auto-generated (backend):**
- customerCode (mÃ£ KH)
- firstVisitDate (hÃ´m nay)
- type: "LEAD" â†’ "CUSTOMER"

**Pattern:** Identical to CustomerFormModal structure

---

### 2. CustomerTable Column Updates

**File:** `src/features/customers/components/CustomerTable.tsx`

**Current columns:**

- MÃ£ KH, Há» tÃªn, SÄT, NgÆ°á»i liÃªn há»‡, Dá»‹ch vá»¥ quan tÃ¢m, Nguá»“n khÃ¡ch, Thá»i gian táº¡o, Lá»‹ch háº¹n hÃ´m nay, Thao tÃ¡c

**ADD new columns:**

#### A. Type Badge (after MÃ£ KH)

```tsx
{
  title: "Loáº¡i",
  key: "type",
  width: 80,
  render: (_, r) => (
    <Tag color={r.type === "LEAD" ? "orange" : "blue"}>
      {r.type === "LEAD" ? "LEAD" : "KH"}
    </Tag>
  ),
}
````

#### B. First Visit Date (after Thá»i gian táº¡o)

```tsx
{
  title: "NgÃ y khÃ¡m Ä‘áº§u",
  key: "firstVisitDate",
  width: 120,
  render: (_, r) =>
    r.firstVisitDate
      ? dayjs(r.firstVisitDate).format("DD/MM/YYYY")
      : "â€”",
}
```

#### C. Update Customer Code (handle NULL for LEADs)

```tsx
{
  title: "MÃ£ KH",
  dataIndex: "customerCode",
  key: "customerCode",
  width: 140,
  render: (code, r) => {
    if (r.type === "LEAD") return "â€”"; // LEADs don't have code
    return code || "â€”";
  },
}
```

---

### 3. Customer Detail View Updates

**File:** âœ… `src/features/customers/views/CustomerDetailView.tsx`

**Implemented:**

#### A. Type Badge in Header

- Shows "LEAD" (orange) or "KHÃCH HÃ€NG" (blue) tag next to customer name

#### B. Convert Button (only if type=LEAD)

- Button "Chuyá»ƒn thÃ nh KhÃ¡ch hÃ ng" appears when customer.type === "LEAD"
- Opens ConvertLeadModal with pre-filled Lead data
- Passes: id, phone, fullName, city, source, sourceEmployee, sourceCustomer, serviceOfInterest, sourceNotes

#### C. ConvertLeadModal Integration

- Modal receives lead data as props
- After successful conversion: refetch customer data
- Page automatically updates to show as CUSTOMER with customerCode

---

## ğŸ§ª TESTING

### Backend Tests

**Status:** âœ… COMPLETED

Lead service convertToCustomer includes:

- Clinic validation (employee can only convert to their own clinic)
- customerCode generation
- All field updates and type conversion
- firstVisitDate setting

### Frontend Tests

**Status:** âœ… COMPLETED

ConvertLeadModal tested with:

- All fields pre-populated from Lead data
- Validation matching CustomerFormModal exactly
- Clinic permissions (admin can change, employee cannot)
- Source options merging (sourceEmployee, sourceCustomer)
- Successful conversion and page refresh

---

## ğŸ“¦ ROLLOUT PLAN

### Phase 1: Database Migration âœ… COMPLETED

- âœ… Migration added: type, note, firstVisitDate fields
- âœ… Default values: type="CUSTOMER", firstVisitDate=createdAt
- âœ… Enum: CustomerType ("LEAD", "CUSTOMER")

### Phase 2: Backend Updates âœ… COMPLETED

- âœ… ConvertLeadRequestSchema created with full validation
- âœ… Customer repo: filters by type="CUSTOMER"
- âœ… Lead service: convertToCustomer() with clinic validation
- âœ… Customer service: sets firstVisitDate on create

### Phase 3: Frontend Updates âœ… COMPLETED

- âœ… ConvertLeadModal component (6 rows, 16 fields)
- âœ… CustomerTable: columns for type, note, firstVisitDate
- âœ… CustomerDetailView: type badge, convert button
- âœ… CustomerFormModal: added note field (H6 row)

### Phase 4: Integration âœ… COMPLETED

- âœ… useConvertLead hook with React Query
- âœ… Clinic permissions (admin/employee)
- âœ… Source data merging (sourceEmployee/sourceCustomer)
- âœ… Automatic page refresh after conversion

---

## ğŸ“‹ IMPLEMENTATION CHECKLIST

**Database:** âœ… COMPLETED

- âœ… Schema migration (type, note, firstVisitDate)
- âœ… Enum CustomerType ("LEAD" | "CUSTOMER")
- âœ… Default values set

**Backend:** âœ… COMPLETED

- âœ… ConvertLeadRequestSchema with full validation
- âœ… Customer repo filters by type="CUSTOMER"
- âœ… Lead service convertToCustomer() method
- âœ… Customer service sets firstVisitDate

**Frontend:** âœ… COMPLETED

- âœ… ConvertLeadModal component (6 rows matching CustomerFormModal)
- âœ… CustomerTable columns (type, note, firstVisitDate)
- âœ… CustomerDetailView (type badge, convert button)
- âœ… CustomerFormModal note field
- âœ… useConvertLead hook
- âœ… Clinic permissions logic

**Features:** âœ… COMPLETED

- âœ… All 16 fields editable except phone
- âœ… Validation matches CustomerFormModal exactly
- âœ… Source data merging (sourceEmployee/sourceCustomer)
- âœ… Admin can select any clinic, employee locked to their clinic
- âœ… Automatic customerCode generation
- âœ… Page refresh after conversion

---

## ğŸš€ SUMMARY

**Status:** âœ… FULLY IMPLEMENTED

**Database Changes:**

- Added CustomerType enum ("LEAD" | "CUSTOMER")
- Added fields: type (default "CUSTOMER"), note (optional), firstVisitDate (default createdAt)

**Backend Implementation:**

- ConvertLeadRequestSchema: Full validation matching CustomerFormModal
- Lead service: convertToCustomer() with clinic validation, customerCode generation
- Customer repo: Filters by type="CUSTOMER"
- Customer service: Sets firstVisitDate on create

**Frontend Implementation:**

- ConvertLeadModal: 6 rows (H1-H6), 16 fields matching CustomerFormModal exactly
- CustomerDetailView: Type badge, convert button (only for LEADs)
- CustomerFormModal: Added note field (H6 row, TextArea 3 rows)
- CustomerTable: Added columns for type, note, firstVisitDate

**Key Features:**

- All fields editable except phone (disabled)
- Clinic permissions: Admin can select any clinic, employee locked to their clinic
- Source data merging: sourceEmployee/sourceCustomer merged into options
- Conditional validation: If no phone â†’ require primaryContactId + primaryContactRole
- Automatic customerCode generation
- Page refresh after successful conversion

**Dependencies:** Integrated with Lead feature (120 Lead.md)
