# ğŸ“Š Follow-up Dashboard & KPIs

> **Part 2 of 2** - Reporting, Metrics & Analytics  
> **ğŸ‘¥ Audience**: Data analysts, report developers, managers  
> **ğŸ”— Core Feature**: [010 Follow-up.md](./010%20Follow-up.md)

## ğŸ“– Overview

TÃ i liá»‡u nÃ y mÃ´ táº£ cÃ¡c metrics, KPIs vÃ  bÃ¡o cÃ¡o cho há»‡ thá»‘ng follow-up:

- Follow-up performance metrics
- Sale performance KPIs (Service & Customer conversion rates)
- SQL queries vá»›i UNION ALL attribution logic
- Dashboard UI design
- Reporting requirements

---

## 1. ğŸ¯ Follow-up Performance KPIs

### 1.1 Core Metrics

**Track theo follow-up process**:

#### A. Conversion Rate

**Definition**: % follow-ups chuyá»ƒn tá»« pending â†’ success

**Formula**:

```typescript
Conversion Rate = (Follow-ups vá»›i status = "success" / Tá»•ng follow-ups) Ã— 100%
```

**Query**:

```sql
SELECT
  COUNT(CASE WHEN status = 'success' THEN 1 END)::numeric /
  COUNT(*)::numeric * 100 as conversionRate
FROM "CustomerFollowUp"
WHERE
  archivedAt IS NULL
  AND createdAt >= :startDate
  AND createdAt < :endDate;
```

#### B. Average Time to Convert

**Definition**: Thá»i gian trung bÃ¬nh tá»« táº¡o follow-up Ä‘áº¿n success

**Formula**:

```typescript
Avg Time = AVG(completedAt - createdAt) for status = "success"
```

**Query**:

```sql
SELECT
  AVG(EXTRACT(EPOCH FROM (completedAt - createdAt)) / 86400) as avgDaysToConvert
FROM "CustomerFollowUp"
WHERE
  status = 'success'
  AND createdAt >= :startDate
  AND createdAt < :endDate;
```

#### C. Activities per Success

**Definition**: Sá»‘ láº§n liÃªn há»‡ trung bÃ¬nh Ä‘á»ƒ chá»‘t Ä‘Æ°á»£c service

**Query**:

```sql
SELECT
  AVG(activity_count) as avgActivitiesPerSuccess
FROM (
  SELECT
    f.id,
    COUNT(a.id) as activity_count
  FROM "CustomerFollowUp" f
  LEFT JOIN "FollowUpActivity" a ON a.followUpId = f.id
  WHERE
    f.status = 'success'
    AND f.createdAt >= :startDate
    AND f.createdAt < :endDate
  GROUP BY f.id
) subquery;
```

#### D. Response Rate

**Definition**: % khÃ¡ch hÃ ng pháº£n há»“i (interested/callback_later) vs khÃ´ng pháº£n há»“i (no_contact/not_interested)

**Query**:

```sql
WITH activity_results AS (
  SELECT
    a.id,
    a.contactResult,
    CASE
      WHEN a.contactResult IN ('interested', 'callback_later') THEN 'responsive'
      WHEN a.contactResult IN ('no_contact', 'not_interested') THEN 'non_responsive'
    END as response_type
  FROM "FollowUpActivity" a
  JOIN "CustomerFollowUp" f ON f.id = a.followUpId
  WHERE
    f.createdAt >= :startDate
    AND f.createdAt < :endDate
)
SELECT
  COUNT(CASE WHEN response_type = 'responsive' THEN 1 END)::numeric /
  COUNT(*)::numeric * 100 as responseRate
FROM activity_results;
```

#### E. Overdue Rate

**Definition**: % follow-ups quÃ¡ háº¡n nextFollowUpDate

**Query**:

```sql
SELECT
  COUNT(CASE WHEN nextFollowUpDate < CURRENT_DATE THEN 1 END)::numeric /
  COUNT(*)::numeric * 100 as overdueRate
FROM "CustomerFollowUp"
WHERE
  status IN ('pending', 'in_progress')
  AND archivedAt IS NULL;
```

### 1.2 Dashboard Widget - Follow-up Summary

**Location**: Dashboard home page

**Content**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MY FOLLOW-UPS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â³ Pending: 5                              â”‚
â”‚  ğŸ”„ In Progress: 12                         â”‚
â”‚  âš ï¸ Overdue: 3                              â”‚
â”‚  ğŸ“… Due Today: 7                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  This Week:                                 â”‚
â”‚  âœ… Success: 8/15 (53%)                     â”‚
â”‚  âŒ Give Up: 2                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [View All Follow-ups â†’]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Query for Widget**:

```sql
-- My follow-up summary for current user
SELECT
  COUNT(CASE WHEN status = 'pending' THEN 1 END) as pendingCount,
  COUNT(CASE WHEN status = 'in_progress' THEN 1 END) as inProgressCount,
  COUNT(CASE WHEN status IN ('pending', 'in_progress')
         AND nextFollowUpDate < CURRENT_DATE THEN 1 END) as overdueCount,
  COUNT(CASE WHEN status IN ('pending', 'in_progress')
         AND nextFollowUpDate = CURRENT_DATE THEN 1 END) as dueTodayCount,
  COUNT(CASE WHEN status = 'success'
         AND completedAt >= date_trunc('week', CURRENT_DATE) THEN 1 END) as weekSuccessCount,
  COUNT(CASE WHEN status = 'give_up'
         AND completedAt >= date_trunc('week', CURRENT_DATE) THEN 1 END) as weekGiveUpCount,
  COUNT(CASE WHEN createdAt >= date_trunc('week', CURRENT_DATE) THEN 1 END) as weekTotalCount
FROM "CustomerFollowUp"
WHERE
  (assignedToSaleId = :currentUserId OR consultingDoctorId = :currentUserId)
  AND archivedAt IS NULL;
```

---

## 2. ğŸ’¼ Sale Performance KPIs

### 2.1 Service Conversion Rate

**Äá»‹nh nghÄ©a**: Tá»‰ lá»‡ % sá»‘ dá»‹ch vá»¥ tÆ° váº¥n Ä‘Ã£ chá»‘t / tá»•ng sá»‘ dá»‹ch vá»¥ tÆ° váº¥n

**Formula**:

```typescript
Service Conversion Rate = (Sá»‘ service Ä‘Ã£ chá»‘t / Tá»•ng sá»‘ service) Ã— 100%
```

**Business Rules**:

- âœ… **Äáº¿m service nÃ o?**

  - Chá»‰ service tá»« `DentalService.needsFollowUp = true`
  - ConsultedService káº¿ thá»«a needsFollowUp tá»« DentalService

- âœ… **GÃ¡n cho ai?** TÃ­nh cho **Cáº¢ sale VÃ€ doctor** (náº¿u cÃ³)

  - Náº¿u cÃ³ `consultingSaleId` â†’ Service nÃ y tÃ­nh cho sale
  - Náº¿u cÃ³ `consultingDoctorId` â†’ Service nÃ y tÃ­nh cho doctor
  - Náº¿u cÃ³ **Cáº¢ 2** â†’ Service nÃ y tÃ­nh cho **Cáº¢ 2 ngÆ°á»i**
  - **Rationale**: Cáº£ sale vÃ  doctor Ä‘á»u Ä‘Ã³ng gÃ³p vÃ o viá»‡c chá»‘t service

- âœ… **Thá»i gian tÃ­nh**: Dá»±a vÃ o `consultationDate` (ngÃ y tÆ° váº¥n)

- âœ… **Status**:
  - Total = Táº¥t cáº£ service (cáº£ "ChÆ°a chá»‘t" vÃ  "ÄÃ£ chá»‘t")
  - Success = Service cÃ³ `serviceStatus = "ÄÃ£ chá»‘t"`

**SQL Query**:

```sql
-- Service conversion rate by employee (sale and/or doctor)
-- Uses UNION ALL to count for both if both exist
WITH service_attributions AS (
  -- Count for sale (if exists)
  SELECT
    cs.id as serviceId,
    cs.serviceStatus,
    cs.consultationDate,
    ds.needsFollowUp,
    cs.consultingSaleId as employeeId,
    'sale' as role
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    cs.consultingSaleId IS NOT NULL
    AND ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL

  UNION ALL

  -- Count for doctor (if exists)
  SELECT
    cs.id as serviceId,
    cs.serviceStatus,
    cs.consultationDate,
    ds.needsFollowUp,
    cs.consultingDoctorId as employeeId,
    'doctor' as role
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    cs.consultingDoctorId IS NOT NULL
    AND ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL
)
SELECT
  sa.employeeId,
  e.fullName as employeeName,
  e.jobTitle,
  COUNT(DISTINCT sa.serviceId) as totalServices,
  COUNT(DISTINCT CASE WHEN sa.serviceStatus = 'ÄÃ£ chá»‘t' THEN sa.serviceId END) as closedServices,
  ROUND(
    COUNT(DISTINCT CASE WHEN sa.serviceStatus = 'ÄÃ£ chá»‘t' THEN sa.serviceId END)::numeric /
    NULLIF(COUNT(DISTINCT sa.serviceId), 0)::numeric * 100,
    2
  ) as serviceConversionRate
FROM service_attributions sa
JOIN "Employee" e ON e.id = sa.employeeId
GROUP BY sa.employeeId, e.fullName, e.jobTitle
ORDER BY serviceConversionRate DESC;
```

**Result Example**:

```
| Employee ID | Employee Name | Job Title | Total | Closed | Rate  |
|-------------|---------------|-----------|-------|--------|-------|
| emp-001     | Nguyá»…n A      | Sale      | 20    | 15     | 75.00%|
| emp-002     | Dr. Tráº§n B    | Dentist   | 15    | 12     | 80.00%|
| emp-003     | LÃª C          | Sale      | 18    | 9      | 50.00%|
```

**Important Notes**:

- Náº¿u 1 service cÃ³ cáº£ sale vÃ  doctor, nÃ³ sáº½ Ä‘Æ°á»£c Ä‘áº¿m cho **Cáº¢ 2 ngÆ°á»i**
- VD: Service ABC cÃ³ cáº£ sale Nguyá»…n A vÃ  doctor Tráº§n B
  â†’ Nguyá»…n A: totalServices +1
  â†’ Tráº§n B: totalServices +1
- ÄÃ¢y lÃ  **dual attribution**, khÃ´ng pháº£i priority-based

### 2.2 Customer Conversion Rate

**Äá»‹nh nghÄ©a**: Tá»‰ lá»‡ % sá»‘ khÃ¡ch hÃ ng Ä‘Ã£ chá»‘t Ã­t nháº¥t 1 service / tá»•ng sá»‘ khÃ¡ch Ä‘Æ°á»£c tÆ° váº¥n

**Formula**:

```typescript
Customer Conversion Rate = (Sá»‘ khÃ¡ch Ä‘Ã£ chá»‘t Ã­t nháº¥t 1 service / Tá»•ng sá»‘ khÃ¡ch tÆ° váº¥n) Ã— 100%
```

**Business Rules**:

- âœ… **Äáº¿m khÃ¡ch nÃ o?**

  - KhÃ¡ch cÃ³ Ã­t nháº¥t 1 service tá»« `DentalService.needsFollowUp = true` trong ká»³

- âœ… **GÃ¡n cho ai?** TÃ­nh cho **Cáº¢ sale VÃ€ doctor** tham gia tÆ° váº¥n **service Ä‘áº§u tiÃªn** cá»§a khÃ¡ch

  - Service Ä‘áº§u tiÃªn = Service cÃ³ `consultationDate` nhá» nháº¥t trong ká»³ bÃ¡o cÃ¡o
  - Náº¿u service Ä‘áº§u cÃ³ sale â†’ TÃ­nh cho sale
  - Náº¿u service Ä‘áº§u cÃ³ doctor â†’ TÃ­nh cho doctor
  - Náº¿u service Ä‘áº§u cÃ³ cáº£ 2 â†’ TÃ­nh cho Cáº¢ 2

- âœ… **Thá»i gian tÃ­nh**: Dá»±a vÃ o `consultationDate` cá»§a service Ä‘áº§u tiÃªn

- âœ… **KhÃ¡ch Ä‘Ã£ chá»‘t**: KhÃ¡ch cÃ³ **Ã­t nháº¥t 1 service** (báº¥t ká»³) cÃ³ `serviceStatus = "ÄÃ£ chá»‘t"` trong ká»³

**SQL Query**:

```sql
-- Customer conversion rate by employee (within date range)
WITH first_services AS (
  -- Get first service per customer in the date range
  SELECT DISTINCT ON (cs.customerId)
    cs.customerId,
    cs.id as firstServiceId,
    cs.consultingSaleId,
    cs.consultingDoctorId,
    cs.consultationDate
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL
  ORDER BY cs.customerId, cs.consultationDate ASC
),
customer_attributions AS (
  -- Attribute to sale if exists
  SELECT
    fs.customerId,
    fs.consultingSaleId as employeeId,
    'sale' as role
  FROM first_services fs
  WHERE fs.consultingSaleId IS NOT NULL

  UNION ALL

  -- Attribute to doctor if exists
  SELECT
    fs.customerId,
    fs.consultingDoctorId as employeeId,
    'doctor' as role
  FROM first_services fs
  WHERE fs.consultingDoctorId IS NOT NULL
),
customer_has_closed AS (
  -- Check if customer closed any service in the period
  SELECT
    cs.customerId,
    MAX(CASE WHEN cs.serviceStatus = 'ÄÃ£ chá»‘t' THEN 1 ELSE 0 END) as hasClosedService
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL
  GROUP BY cs.customerId
)
SELECT
  ca.employeeId,
  e.fullName as employeeName,
  e.jobTitle,
  COUNT(DISTINCT ca.customerId) as totalCustomers,
  COUNT(DISTINCT CASE WHEN chc.hasClosedService = 1 THEN ca.customerId END) as closedCustomers,
  ROUND(
    COUNT(DISTINCT CASE WHEN chc.hasClosedService = 1 THEN ca.customerId END)::numeric /
    NULLIF(COUNT(DISTINCT ca.customerId), 0)::numeric * 100,
    2
  ) as customerConversionRate
FROM customer_attributions ca
JOIN customer_has_closed chc ON chc.customerId = ca.customerId
JOIN "Employee" e ON e.id = ca.employeeId
GROUP BY ca.employeeId, e.fullName, e.jobTitle
ORDER BY customerConversionRate DESC;
```

**Result Example**:

```
| Employee ID | Employee Name | Job Title | Total Cust | Closed Cust | Rate  |
|-------------|---------------|-----------|------------|-------------|-------|
| emp-001     | Nguyá»…n A      | Sale      | 10         | 8           | 80.00%|
| emp-002     | Dr. Tráº§n B    | Dentist   | 12         | 9           | 75.00%|
| emp-003     | LÃª C          | Sale      | 15         | 6           | 40.00%|
```

**Important Notes**:

- Attribution dá»±a vÃ o **service Ä‘áº§u tiÃªn** cá»§a khÃ¡ch trong ká»³
- Náº¿u service Ä‘áº§u cÃ³ cáº£ sale vÃ  doctor â†’ KhÃ¡ch Ä‘Æ°á»£c tÃ­nh cho Cáº¢ 2
- KhÃ¡ch "Ä‘Ã£ chá»‘t" = cÃ³ **Báº¤T Ká»² service nÃ o** chá»‘t trong ká»³ (khÃ´ng nháº¥t thiáº¿t pháº£i service Ä‘áº§u)

### 2.3 Combined Query - Both KPIs

**For API Endpoint**: Return both service and customer conversion rates

```sql
-- Combined sale performance report
WITH service_attributions AS (
  -- Service attributions (UNION ALL for dual counting)
  SELECT
    cs.id as serviceId,
    cs.serviceStatus,
    cs.consultationDate,
    cs.consultingSaleId as employeeId,
    'sale' as role
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    cs.consultingSaleId IS NOT NULL
    AND ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL

  UNION ALL

  SELECT
    cs.id as serviceId,
    cs.serviceStatus,
    cs.consultationDate,
    cs.consultingDoctorId as employeeId,
    'doctor' as role
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    cs.consultingDoctorId IS NOT NULL
    AND ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL
),
first_services AS (
  SELECT DISTINCT ON (cs.customerId)
    cs.customerId,
    cs.consultingSaleId,
    cs.consultingDoctorId
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL
  ORDER BY cs.customerId, cs.consultationDate ASC
),
customer_attributions AS (
  SELECT customerId, consultingSaleId as employeeId, 'sale' as role
  FROM first_services WHERE consultingSaleId IS NOT NULL
  UNION ALL
  SELECT customerId, consultingDoctorId as employeeId, 'doctor' as role
  FROM first_services WHERE consultingDoctorId IS NOT NULL
),
customer_has_closed AS (
  SELECT
    cs.customerId,
    MAX(CASE WHEN cs.serviceStatus = 'ÄÃ£ chá»‘t' THEN 1 ELSE 0 END) as hasClosedService
  FROM "ConsultedService" cs
  JOIN "DentalService" ds ON ds.id = cs.dentalServiceId
  WHERE
    ds.needsFollowUp = true
    AND cs.consultationDate >= :startDate
    AND cs.consultationDate < :endDate
    AND cs.archivedAt IS NULL
  GROUP BY cs.customerId
),
service_metrics AS (
  SELECT
    sa.employeeId,
    COUNT(DISTINCT sa.serviceId) as totalServices,
    COUNT(DISTINCT CASE WHEN sa.serviceStatus = 'ÄÃ£ chá»‘t' THEN sa.serviceId END) as closedServices
  FROM service_attributions sa
  GROUP BY sa.employeeId
),
customer_metrics AS (
  SELECT
    ca.employeeId,
    COUNT(DISTINCT ca.customerId) as totalCustomers,
    COUNT(DISTINCT CASE WHEN chc.hasClosedService = 1 THEN ca.customerId END) as closedCustomers
  FROM customer_attributions ca
  JOIN customer_has_closed chc ON chc.customerId = ca.customerId
  GROUP BY ca.employeeId
)
SELECT
  e.id as employeeId,
  e.fullName as employeeName,
  e.jobTitle,
  COALESCE(sm.totalServices, 0) as totalServices,
  COALESCE(sm.closedServices, 0) as closedServices,
  ROUND(
    COALESCE(sm.closedServices, 0)::numeric /
    NULLIF(sm.totalServices, 0)::numeric * 100,
    2
  ) as serviceConversionRate,
  COALESCE(cm.totalCustomers, 0) as totalCustomers,
  COALESCE(cm.closedCustomers, 0) as closedCustomers,
  ROUND(
    COALESCE(cm.closedCustomers, 0)::numeric /
    NULLIF(cm.totalCustomers, 0)::numeric * 100,
    2
  ) as customerConversionRate
FROM "Employee" e
LEFT JOIN service_metrics sm ON sm.employeeId = e.id
LEFT JOIN customer_metrics cm ON cm.employeeId = e.id
WHERE
  e.archivedAt IS NULL
  AND (sm.totalServices > 0 OR cm.totalCustomers > 0)
ORDER BY serviceConversionRate DESC NULLS LAST;
```

---

## 3. ğŸ“ˆ Dashboard UI Design

### 3.1 Sale Performance Section

**Location**: `/dashboard` - Section "Sale Performance"

**Filters**:

- **Date Range**: Last 7 days / Last 30 days / This Month / Last Month / Custom
- **Clinic**: All / Specific Clinic (for Admin)
- **Employee**: All / Specific Employee
- **Job Title**: All / Sale / Dentist / Consultant

**Layout**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š SALE PERFORMANCE - ThÃ¡ng 11/2025                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Filters: [Last 30 days â–¼] [All Clinics â–¼] [All Employees â–¼]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Top Performers                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Name      â”‚ Title   â”‚ Services  â”‚ Customers â”‚ Serviceâ”‚ Cust  â”‚ â”‚
â”‚  â”‚           â”‚         â”‚ Closed    â”‚ Closed    â”‚ Rate   â”‚ Rate  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Nguyá»…n A  â”‚ Sale    â”‚ 15/20     â”‚  8/10     â”‚ 75% â¬† â”‚ 80% â¬†â”‚ â”‚
â”‚  â”‚ Dr.Tráº§n B â”‚ Dentist â”‚ 12/15     â”‚  9/12     â”‚ 80% â¬† â”‚ 75% â¬†â”‚ â”‚
â”‚  â”‚ LÃª C      â”‚ Sale    â”‚  9/18     â”‚  5/12     â”‚ 50% â¡ â”‚ 42% â¡â”‚ â”‚
â”‚  â”‚ Pháº¡m D    â”‚ Sale    â”‚  5/15     â”‚  3/10     â”‚ 33% â¬‡ â”‚ 30% â¬‡â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  Team Average: ğŸ“Š Service Rate: 60% | Customer Rate: 57%           â”‚
â”‚                                                                     â”‚
â”‚  [Export to Excel] [View Detailed Report â†’]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Trend Indicators**:

- â¬† Green arrow: Above team average
- â¡ Yellow dash: Near team average (Â±5%)
- â¬‡ Red arrow: Below team average

### 3.2 Charts & Visualizations

#### A. Bar Chart - Conversion Rates Comparison

```
Service Conversion Rate by Employee
100% â”¤
 90% â”¤     â–ˆâ–ˆ
 80% â”¤ â–ˆâ–ˆ  â–ˆâ–ˆ
 70% â”¤ â–ˆâ–ˆ  â–ˆâ–ˆ
 60% â”¤ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
 50% â”¤ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
 40% â”¤ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
 30% â”¤ â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆ
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       A   B   C   D
```

#### B. Line Chart - Trend Over Time

```
Conversion Rate Trend (Last 3 Months)
80% â”¤         â—â”€â”€â—
70% â”¤    â—â”€â”€â—
60% â”¤ â—â”€â”€â—
50% â”¤
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      Sep Oct Nov Dec
```

#### C. Pie Chart - Revenue Attribution

```
Total Revenue by Employee
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Nguyá»…n A     â”‚ 35%
â”‚    Dr. Tráº§n B   â”‚ 30%
â”‚    LÃª C         â”‚ 20%
â”‚    Others       â”‚ 15%
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Detailed Report Page

**URL**: `/dashboard/sale-performance-detail`

**Features**:

- Expandable rows to show individual services/customers
- Export to Excel/PDF
- Date range comparison (This Month vs Last Month)
- Drill-down by clinic, service type
- Individual employee detail view

---

## 4. ğŸ”Œ API Design for Reports

### 4.1 Sale Performance API

**Endpoint**: `GET /api/reports/sale-performance`

**Query Params**:

- `startDate`: ISO date string (required)
- `endDate`: ISO date string (required)
- `clinicId`: UUID (optional, Admin only)
- `employeeId`: UUID (optional, for specific employee)

**Response**:

```typescript
{
  salesPerformance: [
    {
      employeeId: string,
      employeeName: string,
      jobTitle: string,
      totalServices: number,
      closedServices: number,
      serviceConversionRate: number, // %
      totalCustomers: number,
      closedCustomers: number,
      customerConversionRate: number, // %
      totalRevenue: number, // Sum of finalPrice for closed services
    }
  ],
  teamAverage: {
    serviceConversionRate: number,
    customerConversionRate: number,
    totalRevenue: number,
  },
  periodComparison?: {
    previousPeriod: { /* same structure */ },
    change: {
      serviceConversionRate: number, // % change
      customerConversionRate: number,
      totalRevenue: number,
    }
  }
}
```

**Implementation**:

```typescript
// src/app/api/reports/sale-performance/route.ts
import { NextRequest, NextResponse } from "next/server";
import { salePerformanceService } from "@/server/services/reports/sale-performance-service";

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const startDate = new Date(searchParams.get("startDate")!);
    const endDate = new Date(searchParams.get("endDate")!);
    const clinicId = searchParams.get("clinicId") || undefined;
    const employeeId = searchParams.get("employeeId") || undefined;

    // Permission check
    if (clinicId && user.role !== "admin" && clinicId !== user.clinicId) {
      return NextResponse.json({ error: "Forbidden" }, { status: 403 });
    }

    const report = await salePerformanceService.generate({
      startDate,
      endDate,
      clinicId: clinicId || (user.role === "admin" ? undefined : user.clinicId),
      employeeId,
    });

    return NextResponse.json(report);
  } catch (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
```

### 4.2 Follow-up Stats API

**Endpoint**: `GET /api/reports/followup-stats`

**Query Params**:

- `startDate`: ISO date string (required)
- `endDate`: ISO date string (required)
- `assigneeId`: UUID (optional, for specific employee)

**Response**:

```typescript
{
  overview: {
    totalFollowUps: number,
    conversionRate: number,
    avgDaysToConvert: number,
    avgActivitiesPerSuccess: number,
  },
  byStatus: {
    pending: number,
    in_progress: number,
    success: number,
    give_up: number,
  },
  byPriority: {
    high: number,
    medium: number,
    low: number,
  },
  timeline: [
    { date: string, created: number, closed: number },
    // ... per day/week/month
  ]
}
```

---

## 5. ğŸ“Š KPI Calculation Rules Summary

### Service Conversion Rate

âœ… **Source**: Only `DentalService.needsFollowUp = true` services  
âœ… **Attribution**: Count for **BOTH** sale AND doctor (UNION ALL)  
âœ… **Date Filter**: `consultationDate`  
âœ… **Status**: "ÄÃ£ chá»‘t" vs Total

### Customer Conversion Rate

âœ… **Source**: Customers with â‰¥1 service from `needsFollowUp = true`  
âœ… **Attribution**: Based on **first service** in period (UNION ALL for both)  
âœ… **Date Filter**: `consultationDate` of first service  
âœ… **Closed**: Customer has â‰¥1 "ÄÃ£ chá»‘t" service (any) in period

### Follow-up Conversion Rate

âœ… **Source**: All CustomerFollowUp records  
âœ… **Success**: status = "success"  
âœ… **Date Filter**: `createdAt` or `completedAt`

---

## 6. ğŸš€ Implementation Tasks

### Phase 1: Core Queries (Priority: High)

- [ ] Implement service conversion rate query
- [ ] Implement customer conversion rate query
- [ ] Implement combined sale performance query
- [ ] Add proper indexes for performance
- [ ] Test with sample data

### Phase 2: API Layer (Priority: High)

- [ ] Create sale-performance-service.ts
- [ ] Create followup-stats-service.ts
- [ ] Create API routes
- [ ] Add caching for expensive queries
- [ ] Error handling and logging

### Phase 3: Dashboard UI (Priority: Medium)

- [ ] Sale performance widget on dashboard
- [ ] Top performers table with sorting
- [ ] Team average calculation and display
- [ ] Trend indicators (up/down arrows)
- [ ] Filter components

### Phase 4: Charts & Visualizations (Priority: Medium)

- [ ] Bar chart for conversion rates
- [ ] Line chart for trends over time
- [ ] Pie chart for revenue attribution
- [ ] Export to Excel/PDF functionality

### Phase 5: Detailed Reports (Priority: Low)

- [ ] Detailed report page with drill-down
- [ ] Period comparison (This Month vs Last Month)
- [ ] Individual employee detail view
- [ ] Service type analysis
- [ ] Advanced filtering options

---

## 7. ğŸ”® Future Enhancements

### Advanced Analytics

- [ ] Predictive analytics: Likelihood of customer conversion
- [ ] Best time to contact analysis
- [ ] Service bundling recommendations
- [ ] Customer lifetime value projections

### Automated Insights

- [ ] AI-powered insights and recommendations
- [ ] Anomaly detection (unusual patterns)
- [ ] Automated alerts for underperformance
- [ ] Coaching suggestions for sales team

### Integration

- [ ] Export to BI tools (Power BI, Tableau)
- [ ] Real-time dashboard updates
- [ ] Mobile app for managers
- [ ] Email digest reports

---

## ğŸ”— Related Documents

- [010 Follow-up.md](./010%20Follow-up.md) - Core feature & implementation

---

**âœï¸ Document History**

- 2025-11-11: Created Dashboard & KPI documentation with UNION ALL attribution logic
