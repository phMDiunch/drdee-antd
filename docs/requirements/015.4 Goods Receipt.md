# ğŸ“¥ Requirements: Goods Receipt Note - Phiáº¿u Nháº­p Kho (GRN)

> **ğŸ“‹ STATUS: PENDING** - Giai Ä‘oáº¡n 1, TÃ­nh nÄƒng 4 (Core FIFO Engine)  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`  
> **ğŸ“„ Implementation**: `src/features/inventory/goods-receipts/`  
> **âš ï¸ Dependencies**: 015.1 Dictionary, 015.2 Supplier, 015.3 Material

## ğŸ¯ Má»¥c TiÃªu

Ghi nháº­n viá»‡c nháº­p hÃ ng hÃ³a tá»« NhÃ  cung cáº¥p vÃ o kho. ÄÃ¢y lÃ  **"trÃ¡i tim" cá»§a há»‡ thá»‘ng FIFO** vÃ¬:

- Má»—i dÃ²ng nháº­p = 1 "lÃ´ ná»™i bá»™" vá»›i giÃ¡ vá»‘n cá»‘ Ä‘á»‹nh
- Ghi nháº­n Háº¡n sá»­ dá»¥ng náº¿u cÃ³ (Ä‘á»ƒ truy xuáº¥t nguá»“n gá»‘c)
- Táº¡o ná»n táº£ng dá»¯ liá»‡u cho xuáº¥t kho tá»± Ä‘á»™ng

## ğŸ“Š Quy TrÃ¬nh Nghiá»‡p Vá»¥

```
[Nháº­p liá»‡u]      [Validate]        [Káº¿t quáº£]
    â”‚                â”‚                 â”‚
    â–¼                â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nháº­p VT â”‚â”€â”€â”€â–¶â”‚ Kiá»ƒm tra â”‚â”€â”€â”€â–¶â”‚  Táº¡o Phiáº¿u â”‚
â”‚ & Info  â”‚    â”‚  Dá»¯ liá»‡u â”‚    â”‚  Nháº­p Kho  â”‚
â”‚         â”‚    â”‚          â”‚    â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Tá»“n kho +  â”‚
                              â”‚ Ghi ledger â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                              âš ï¸ Chá»‰ cho Há»¦Y
                              (Náº¿u hÃ ng chÆ°a xuáº¥t)
```

## ğŸ“‹ User Stories

### US-1: Táº¡o Phiáº¿u Nháº­p & Nháº­p Kho Trá»±c Tiáº¿p

**LÃ  Thá»§ Kho**, tÃ´i muá»‘n:

- Táº¡o phiáº¿u nháº­p má»›i
- **PhÃ²ng khÃ¡m**: Há»‡ thá»‘ng tá»± Ä‘á»™ng láº¥y tá»« clinic cá»§a user Ä‘ang Ä‘Äƒng nháº­p
  - Hiá»ƒn thá»‹ tÃªn phÃ²ng khÃ¡m (read-only, disabled)
  - NhÃ¢n viÃªn á»Ÿ clinic nÃ o sáº½ nháº­p vÃ o kho cá»§a clinic Ä‘Ã³
  - KhÃ´ng cho phÃ©p sá»­a (Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n dá»¯ liá»‡u)
- Há»‡ thá»‘ng tá»± sinh sá»‘ phiáº¿u ná»™i bá»™ ({clinicCode}-PN-YYMM-XXXX)
  - `clinicCode`: MÃ£ phÃ²ng khÃ¡m (láº¥y tá»« clinic hiá»‡n táº¡i)
  - `PN`: Phiáº¿u Nháº­p
  - `YYMM`: 2 sá»‘ cuá»‘i nÄƒm + 2 sá»‘ thÃ¡ng (VD: 2512 = thÃ¡ng 12/2025)
  - `XXXX`: Sá»‘ thá»© tá»± phiáº¿u nháº­p trong thÃ¡ng (0001, 0002...)
- Nháº­p sá»‘ hÃ³a Ä‘Æ¡n/chá»©ng tá»« cá»§a NCC
- Chá»n ngÃ y nháº­p kho (khÃ´ng quÃ¡ 7 ngÃ y)
- Chá»n NCC tá»« danh sÃ¡ch
- ThÃªm nhiá»u dÃ²ng váº­t tÆ° vÃ o phiáº¿u

### US-2: Nháº­p Chi Tiáº¿t HÃ ng HÃ³a

**LÃ  Thá»§ Kho**, tÃ´i muá»‘n:

- ThÃªm nhiá»u dÃ²ng váº­t tÆ° vÃ o phiáº¿u
- Vá»›i má»—i dÃ²ng, nháº­p:
  - Váº­t tÆ° (chá»n tá»« danh sÃ¡ch)
  - **Sá»‘ lÆ°á»£ng** (bao nhiÃªu Ä‘Æ¡n vá»‹)
  - **ThÃ nh tiá»n tá»•ng** (giÃ¡ trá»‹ sau chiáº¿t kháº¥u/táº·ng kÃ¨m)
  - Há»‡ thá»‘ng **tá»± tÃ­nh Ä‘Æ¡n giÃ¡** = ThÃ nh tiá»n / Sá»‘ lÆ°á»£ng
  - **Háº¡n sá»­ dá»¥ng** (chá»n ngÃ y tá»« vá» há»™p - khÃ´ng báº¯t buá»™c, cÃ³ thá»ƒ bá» trá»‘ng náº¿u hÃ ng khÃ´ng cÃ³ HSD)

**Giáº£i quyáº¿t case: "Mua 10 táº·ng 5"**

- Nháº­p: Sá»‘ lÆ°á»£ng = 15, ThÃ nh tiá»n = 1,000,000
- Há»‡ thá»‘ng tÃ­nh: ÄÆ¡n giÃ¡ = 66,667 VNÄ/cÃ¡i

### US-3: XÃ¡c Nháº­n Nháº­p Kho (Posting)

**LÃ  Thá»§ Kho**, sau khi kiá»ƒm Ä‘áº¿m hÃ ng thá»±c táº¿:

- TÃ´i báº¥m "XÃ¡c nháº­n nháº­p kho"
- Há»‡ thá»‘ng:
  - KhÃ³a phiáº¿u (khÃ´ng sá»­a Ä‘Æ°á»£c ná»¯a)
  - **Táº¡o StockQuant** (tá»“n kho hiá»‡n táº¡i) cho tá»«ng dÃ²ng
  - **Ghi StockMove** (lá»‹ch sá»­ giao dá»‹ch)
  - Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng

### US-4: Há»§y Phiáº¿u ÄÃ£ XÃ¡c Nháº­n (TrÆ°á»ng há»£p Ä‘áº·c biá»‡t)

**LÃ  Quáº£n lÃ½**, náº¿u phÃ¡t hiá»‡n nháº­p sai:

- TÃ´i cÃ³ thá»ƒ há»§y phiáº¿u **CHá»ˆ KHI**:
  - HÃ ng chÆ°a xuáº¥t ra (tá»“n kho >= sá»‘ lÆ°á»£ng Ä‘Ã£ nháº­p)
  - ChÆ°a cÃ³ nghiá»‡p vá»¥ phÃ¡t sinh khÃ¡c
- Há»‡ thá»‘ng tá»± Ä‘á»™ng trá»« tá»“n kho Ä‘i

## ğŸ¨ UI/UX Requirements

### MÃ n hÃ¬nh Danh SÃ¡ch Phiáº¿u Nháº­p

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¥ Phiáº¿u Nháº­p Kho                                [+ Táº¡o Phiáº¿u Má»›i]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tá»« ngÃ y: [ğŸ“…]  Äáº¿n: [ğŸ“…]  NCC: [Táº¥t cáº£ â–¼]  TT: [Táº¥t cáº£ â–¼] ğŸ” [...] â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Sá»‘ Phiáº¿u      â”‚ Sá»‘ HÄ  â”‚ NgÃ y    â”‚ NCC    â”‚ Tá»•ng tiá»n â”‚ âš™     â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ NK01-PN-..001 â”‚ HD123  â”‚ 20/1/25 â”‚ ABC    â”‚ 10,000k   â”‚ ğŸ‘    â”‚  â”‚
â”‚  â”‚ NK01-PN-..002 â”‚ HD124  â”‚ 21/1/25 â”‚ XYZ    â”‚  5,000k   â”‚ ğŸ‘    â”‚  â”‚
â”‚  â”‚ NK01-PN-..003 â”‚ HD125  â”‚ 21/1/25 â”‚ ABC    â”‚  8,000k   â”‚ ğŸ‘    â”‚  â”‚
â”‚  â”‚ NK01-PN-..004 â”‚ HD126  â”‚ 22/1/25 â”‚ MNO    â”‚  3,500k   â”‚ ğŸ‘    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Form Táº¡o Phiáº¿u Nháº­p (Direct Posting)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœï¸  Táº¡o Phiáº¿u Nháº­p Kho                                    [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”â”â” THÃ”NG TIN CHUNG â”â”â”                                       â”‚
â”‚                                                                 â”‚
â”‚  PhÃ²ng khÃ¡m *               Sá»‘ phiáº¿u ná»™i bá»™                    â”‚
â”‚  [Nha khoa NK01          ]  [NK01-PN-2501-0005]                â”‚
â”‚  (Disabled, auto-fill)      (Read-only, tá»± sinh)               â”‚
â”‚                                                                 â”‚
â”‚  Sá»‘ hÃ³a Ä‘Æ¡n NCC *           NgÃ y nháº­p kho *                    â”‚
â”‚  [________________]         [ğŸ“… 21/01/2025]                     â”‚
â”‚  (Nháº­p tay)                                                     â”‚
â”‚                                                                 â”‚
â”‚  NhÃ  cung cáº¥p *                                                 â”‚
â”‚  [Dropdown: Chá»n NCC â–¼]                                         â”‚
â”‚  ABC Medical Supply                                             â”‚
â”‚                                                                 â”‚
â”‚  Ghi chÃº                                                        â”‚
â”‚  [___________________________________]                          â”‚
â”‚                                                                 â”‚
â”‚  â”â”â” CHI TIáº¾T HÃ€NG HÃ“A â”â”â”                         [+ ThÃªm]    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Váº­t tÆ°      â”‚ SL â”‚ ThÃ nh tiá»nâ”‚ ÄÆ¡n giÃ¡ â”‚ HSD      â”‚ğŸ—‘â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”‚  â”‚
â”‚  â”‚ Implant A â–¼ â”‚ 10 â”‚ 1,000,000 â”‚100,000  â”‚12/2026   â”‚Ã—â”‚  â”‚
â”‚  â”‚ GÄƒng tay M â–¼â”‚ 15 â”‚ 1,000,000 â”‚ 66,667  â”‚(Trá»‘ng)   â”‚Ã—â”‚  â”‚
â”‚  â”‚ [Chá»n VT â–¼] â”‚    â”‚           â”‚         â”‚          â”‚Ã—â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Tá»•ng cá»™ng:                        2,000,000 VNÄ               â”‚
â”‚                                                                 â”‚
â”‚  â”â”â” HÃ€NH Äá»˜NG â”â”â”                                              â”‚
â”‚                                                                 â”‚
â”‚  [Há»§y]                              [âœ… Nháº­p Kho]               â”‚
â”‚  (ÄÃ³ng form)                        (POST â†’ Táº¡o phiáº¿u + Tá»“n)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LÆ°u Ã½ UI**:

- **PhÃ²ng khÃ¡m**: Tá»± Ä‘á»™ng Ä‘iá»n tá»« clinic cá»§a user, disabled (mÃ u xÃ¡m), khÃ´ng cho sá»­a
- **Sá»‘ phiáº¿u**: Read-only, tá»± sinh dá»±a trÃªn clinic code vÃ  thÃ¡ng hiá»‡n táº¡i
- **ÄÆ¡n giÃ¡**: Read-only, mÃ u xÃ¡m, tá»± tÃ­nh = ThÃ nh tiá»n / SL
- **HSD**: Optional, cÃ³ thá»ƒ bá» trá»‘ng náº¿u hÃ ng khÃ´ng cÃ³ háº¡n sá»­ dá»¥ng
- **Tooltip HSD**: "Nháº­p HSD tá»« vá» há»™p náº¿u cÃ³ (Ä‘á»ƒ truy xuáº¥t nguá»“n gá»‘c)"
- **KhÃ´ng cÃ³ nÃºt "LÆ°u NhÃ¡p"**: Chá»‰ cÃ³ nÃºt "Nháº­p Kho" - khi báº¥m sáº½ validate vÃ  táº¡o phiáº¿u ngay

### View Chi Tiáº¿t (ÄÃ£ Nháº­p - Read Only)

````
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ Chi Tiáº¿t Phiáº¿u Nháº­p #NK01-PN-2501-0002             [ÄÃ³ng]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PhÃ²ng khÃ¡m: Nha khoa NK01         Sá»‘ HÄ NCC: HD124            â”‚
â”‚  NCC: XYZ Labo                     NgÃ y: 21/01/2025            â”‚
â”‚  NgÆ°á»i táº¡o: Nguyá»…n VÄƒn A                                       â”‚
â”‚  Ghi chÃº: Nháº­p váº­t liá»‡u thÃ¡ng 1                                â”‚
â”‚                                                                 â”‚
â”‚  â”â”â” CHI TIáº¾T HÃ€NG HÃ“A â”â”â”                                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Váº­t tÆ°        â”‚ SL â”‚ ÄÆ¡n giÃ¡ â”‚ ThÃ nh tiá»nâ”‚ HSD      â”‚ â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚ Implant B     â”‚ 20 â”‚ 200,000 â”‚ 4,000,000 â”‚03/2026   â”‚ â”‚
â”‚  â”‚ Abutment C    â”‚ 10 â”‚ 100,000 â”‚ 1,000,000 â”‚(KhÃ´ng cÃ³)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  Tá»•ng cá»™ng:                           5,000,000 VNÄ            â”‚
â”‚                                                                 â”‚
â”‚  [ğŸ—‘ï¸ Há»§y Phiáº¿u]  (Chá»‰ hiá»‡n náº¿u user cÃ³ quyá»n vÃ  hÃ ng chÆ°a xuáº¥t)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
````

## ğŸ”§ Functional Requirements

### FR-1: Tá»± Äá»™ng Sinh Sá»‘ Phiáº¿u

**Format**: `{clinicCode}-PN-YYMM-XXXX`

- `clinicCode`: MÃ£ phÃ²ng khÃ¡m (láº¥y tá»« clinic cá»§a user Ä‘ang Ä‘Äƒng nháº­p)
- `PN`: Phiáº¿u Nháº­p (viáº¿t táº¯t cá»‘ Ä‘á»‹nh)
- `YYMM`: 2 sá»‘ cuá»‘i cá»§a nÄƒm + 2 sá»‘ thÃ¡ng (VD: 2501 = thÃ¡ng 1/2025, 2512 = thÃ¡ng 12/2025)
- `XXXX`: Sá»‘ thá»© tá»± phiáº¿u nháº­p trong thÃ¡ng (0001, 0002..., reset vá» 0001 khi sang thÃ¡ng má»›i)

**VÃ­ dá»¥**:

- `NK01-PN-2501-0001`: Phiáº¿u nháº­p Ä‘áº§u tiÃªn cá»§a phÃ²ng khÃ¡m NK01 trong thÃ¡ng 1/2025
- `NK01-PN-2501-0099`: Phiáº¿u nháº­p thá»© 99 cá»§a phÃ²ng khÃ¡m NK01 trong thÃ¡ng 1/2025
- `NK01-PN-2502-0001`: Phiáº¿u nháº­p Ä‘áº§u tiÃªn cá»§a thÃ¡ng 2/2025 (reset sequence)

```typescript
async function generateReceiptCode(
  clinicCode: string,
  currentUser: UserCore
): Promise<string> {
  const today = new Date();
  const yy = today.getFullYear().toString().slice(-2); // 25 (from 2025)
  const mm = (today.getMonth() + 1).toString().padStart(2, "0"); // 01-12
  const prefix = `${clinicCode}-PN-${yy}${mm}-`;

  // TÃ¬m phiáº¿u cuá»‘i cÃ¹ng trong thÃ¡ng hiá»‡n táº¡i cá»§a clinic nÃ y
  const lastReceipt = await prisma.goodsReceipt.findFirst({
    where: {
      code: { startsWith: prefix },
      clinicId: currentUser.clinicId, // Äáº£m báº£o cÃ¹ng clinic
    },
    orderBy: { code: "desc" },
  });

  if (!lastReceipt) return `${prefix}0001`;

  // Extract sequence tá»« code (pháº§n cuá»‘i sau dáº¥u - thá»© 3)
  const lastSeq = parseInt(lastReceipt.code.split("-")[3]);
  const nextSeq = lastSeq + 1;
  return `${prefix}${nextSeq.toString().padStart(4, "0")}`;
}

// Example usage:
// generateReceiptCode("NK01", currentUser) => "NK01-PN-2501-0001"
// generateReceiptCode("HCM2", currentUser) => "HCM2-PN-2512-0042"
```

### FR-2: Business Rules

1. **Phiáº¿u nháº­p kho**:
   - Phiáº¿u Ä‘Æ°á»£c táº¡o vÃ  ghi nháº­n vÃ o há»‡ thá»‘ng ngay láº­p tá»©c
   - **Clinic**: Tá»± Ä‘á»™ng láº¥y tá»« `currentUser.clinicId`, khÃ´ng cho phÃ©p thay Ä‘á»•i
   - Má»—i phÃ²ng khÃ¡m quáº£n lÃ½ kho riÃªng (multi-tenant isolation)
   - KhÃ´ng cÃ³ khÃ¡i niá»‡m tráº¡ng thÃ¡i (status)
   - Phiáº¿u khÃ´ng thá»ƒ sá»­a sau khi táº¡o
   - Chá»‰ cÃ³ thá»ƒ Há»¦Y náº¿u hÃ ng chÆ°a xuáº¥t (xÃ³a má»m báº±ng `cancelledAt`)
2. **Validate ngÃ y nháº­p**:
   - KhÃ´ng Ä‘Æ°á»£c chá»n tÆ°Æ¡ng lai
   - KhÃ´ng Ä‘Æ°á»£c quÃ¡ khá»© > 7 ngÃ y
3. **Chi tiáº¿t phiáº¿u**:
   - Tá»‘i thiá»ƒu 1 dÃ²ng váº­t tÆ°
   - Má»—i dÃ²ng: Sá»‘ lÆ°á»£ng > 0, ThÃ nh tiá»n >= 0
   - HSD: **KhÃ´ng báº¯t buá»™c** (cho phÃ©p NULL vÃ¬ nhiá»u hÃ ng khÃ´ng cÃ³ HSD)
4. **Há»§y phiáº¿u**:
   - Kiá»ƒm tra tá»“n kho Ä‘á»§ Ä‘á»ƒ trá»«
   - Set `cancelledAt = now()` (soft delete)

### FR-3: Logic Táº¡o Phiáº¿u Nháº­p Kho (Create & Post)

**ÄÃ¢y lÃ  logic quan trá»ng nháº¥t**. Khi user báº¥m "Nháº­p kho":

```typescript
async function createGoodsReceipt(data: CreateGoodsReceiptRequest) {
  return await prisma.$transaction(async (tx) => {
    // 1. Create receipt header
    const receipt = await tx.goodsReceipt.create({
      data: {
        code: data.code, // {clinicCode}-PN-YYMM-XXXX
        clinicId: currentUser.clinicId, // Auto-fill from user's clinic
        invoiceNo: data.invoiceNo,
        supplierId: data.supplierId,
        receiptDate: data.receiptDate,
        note: data.note,
        totalAmount: data.totalAmount,
        createdById: currentUser.id,
      },
    });

    // 2. Create details
    const details = await Promise.all(
      data.details.map((d) =>
        tx.goodsReceiptDetail.create({
          data: {
            goodsReceiptId: receipt.id,
            materialId: d.materialId,
            expiryDate: d.expiryDate || null, // Optional
            quantity: d.quantity,
            unitPrice: d.totalAmount / d.quantity, // Auto-calc
            totalAmount: d.totalAmount,
          },
        })
      )
    );

    // 3. Process each line - Create StockQuant & StockMove
    for (const detail of details) {
      // 3a. Create StockQuant (1:1 vá»›i receiptDetail)
      await tx.stockQuant.create({
        data: {
          materialId: detail.materialId,
          goodsReceiptDetailId: detail.id, // ÄÃ¢y lÃ  "lÃ´ ná»™i bá»™"
          quantity: detail.quantity,
        },
      });

      // 3b. Log StockMove (Ledger)
      await tx.stockMove.create({
        data: {
          transactionDate: receipt.receiptDate,
          type: "IN_RECEIPT",
          materialId: detail.materialId,
          quantityChange: detail.quantity, // Sá»‘ dÆ°Æ¡ng (+)
          goodsReceiptDetailId: detail.id,
          goodsReceiptId: receiptId,
        },
      });
    }

    return { success: true };
  });
}
```

### FR-4: Logic Há»§y Phiáº¿u (Cancellation)

```typescript
async function cancelGoodsReceipt(receiptId: number) {
  return await prisma.$transaction(async (tx) => {
    const details = await tx.goodsReceiptDetail.findMany({
      where: { goodsReceiptId: receiptId },
      include: { stockQuant: true },
    });

    // Validate: Kiá»ƒm tra tá»“n kho cÃ²n Ä‘á»§ khÃ´ng?
    for (const detail of details) {
      if (!detail.stockQuant) {
        throw new Error("StockQuant khÃ´ng tá»“n táº¡i");
      }
      if (detail.stockQuant.quantity < detail.quantity) {
        throw new Error(
          `KhÃ´ng thá»ƒ há»§y: ${detail.material.name} Ä‘Ã£ xuáº¥t má»™t pháº§n`
        );
      }
    }

    // OK, proceed to cancel
    for (const detail of details) {
      // Trá»« tá»“n kho
      await tx.stockQuant.update({
        where: { goodsReceiptDetailId: detail.id },
        data: { quantity: { decrement: detail.quantity } },
      });

      // Ghi StockMove Ä‘áº£o ngÆ°á»£c
      await tx.stockMove.create({
        data: {
          type: "IN_RECEIPT_CANCELLED",
          materialId: detail.materialId,
          quantityChange: -detail.quantity, // Sá»‘ Ã¢m (-)
          goodsReceiptDetailId: detail.id,
        },
      });
    }

    // Update header - set cancelledAt
    await tx.goodsReceipt.update({
      where: { id: receiptId },
      data: { cancelledAt: new Date() },
    });
  });
}
```

### FR-4: API Endpoints

```
GET    /api/v1/goods-receipts?fromDate=&toDate=&supplierId=
GET    /api/v1/goods-receipts/:id
```

**LÆ°u Ã½**: Táº¡o phiáº¿u nháº­p kho sá»­ dá»¥ng **Server Action**, khÃ´ng dÃ¹ng REST API POST

### Server Actions

```typescript
// src/server/actions/goods-receipt.actions.ts

export async function createGoodsReceiptAction(data: CreateGoodsReceiptRequest);
export async function cancelGoodsReceiptAction(receiptId: string);
```

## ğŸ’¾ Data Model (Prisma)

```prisma
model GoodsReceipt {
  id           Int                  @id @default(autoincrement())
  code         String               @unique // {clinicCode}-PN-YYMM-XXXX
  clinicId     String               // FK to Clinic - Báº¯t buá»™c, auto-fill tá»« user.clinicId, khÃ´ng cho sá»­a
  clinic       Clinic               @relation(fields: [clinicId], references: [id])
  invoiceNo    String?              // Sá»‘ hÃ³a Ä‘Æ¡n NCC (nháº­p tay)
  receiptDate  DateTime             @default(now())

  supplierId   Int
  supplier     Supplier             @relation(fields: [supplierId], references: [id])

  note         String?
  totalAmount  Decimal              @default(0) @db.Decimal(15, 2)

  cancelledAt  DateTime?            // Soft delete - phiáº¿u Ä‘Ã£ há»§y

  createdById  Int?                 // User ID (náº¿u cÃ³ auth)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  details      GoodsReceiptDetail[]
  stockMoves   StockMove[]

  @@index([code])
  @@index([clinicId])
  @@index([receiptDate])
  @@index([supplierId])
  @@index([cancelledAt])
  @@index([clinicId, receiptDate]) // For filtering by clinic and date
}

model GoodsReceiptDetail {
  id             Int           @id @default(autoincrement())
  goodsReceiptId Int
  goodsReceipt   GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)

  materialId     Int
  material       Material      @relation(fields: [materialId], references: [id])

  // Truy xuáº¥t nguá»“n gá»‘c (Traceability)
  expiryDate     DateTime?     // Háº¡n sá»­ dá»¥ng (Optional - nhiá»u hÃ ng khÃ´ng cÃ³ HSD)

  // Sá»‘ lÆ°á»£ng & GiÃ¡
  quantity       Decimal       @db.Decimal(15, 2) // Sá»‘ lÆ°á»£ng nháº­p
  unitPrice      Decimal       @db.Decimal(15, 2) // ÄÆ¡n giÃ¡ = totalAmount/quantity (tá»± tÃ­nh)
  totalAmount    Decimal       @db.Decimal(15, 2) // ThÃ nh tiá»n (user nháº­p)

  // Quan há»‡ 1:1 vá»›i StockQuant (má»—i dÃ²ng nháº­p = 1 lÃ´ ná»™i bá»™)
  stockQuant     StockQuant?

  // Quan há»‡ ngÆ°á»£c: dÃ²ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c xuáº¥t Ä‘i bao nhiÃªu láº§n
  issueDetails   GoodsIssueDetail[]
}

model StockQuant {
  id                   Int                @id @default(autoincrement())
  materialId           Int
  material             Material           @relation(fields: [materialId], references: [id])

  // QUAN Há»† 1:1 - ÄÃ‚Y LÃ€ "Sá» LÃ” Ná»˜I Bá»˜"
  goodsReceiptDetailId Int                @unique
  receiptDetail        GoodsReceiptDetail @relation(fields: [goodsReceiptDetailId], references: [id])

  quantity             Decimal            @default(0) @db.Decimal(15, 2) // Sá»‘ lÆ°á»£ng CÃ’N Láº I

  @@index([materialId, quantity])
  @@index([materialId, goodsReceiptDetailId(sort: Asc)]) // For FIFO query
}

enum StockMoveType {
  IN_RECEIPT               // Nháº­p mua
  IN_RECEIPT_CANCELLED     // Há»§y nháº­p
  OUT_PATIENT              // Xuáº¥t cho BN (phase 1.5)
  OUT_DEPARTMENT           // Xuáº¥t cho BS (phase 1.5)
  // ... more types in later phases
}

model StockMove {
  id               Int              @id @default(autoincrement())
  transactionDate  DateTime         @default(now())
  type             StockMoveType

  materialId       Int
  material         Material         @relation(fields: [materialId], references: [id])

  quantityChange   Decimal          @db.Decimal(15, 2) // + hoáº·c -

  // Link tá»›i chá»©ng tá»« gá»‘c
  goodsReceiptId   Int?
  goodsReceipt     GoodsReceipt?    @relation(fields: [goodsReceiptId], references: [id])
  goodsReceiptDetailId Int?

  @@index([materialId, transactionDate])
}
```

## âœ… Validation (Zod Schema)

```typescript
import { z } from "zod";

// Schema cho 1 dÃ²ng chi tiáº¿t
export const goodsReceiptDetailSchema = z.object({
  materialId: z.number({ required_error: "Vui lÃ²ng chá»n váº­t tÆ°" }).positive(),

  // Truy xuáº¥t nguá»“n gá»‘c - OPTIONAL
  expiryDate: z
    .date()
    .refine(
      (date) => {
        if (!date) return true; // Allow null/undefined
        return date > new Date();
      },
      {
        message: "Háº¡n sá»­ dá»¥ng pháº£i trong tÆ°Æ¡ng lai",
      }
    )
    .optional()
    .nullable(),

  quantity: z
    .number()
    .positive("Sá»‘ lÆ°á»£ng pháº£i lá»›n hÆ¡n 0")
    .max(999999, "Sá»‘ lÆ°á»£ng quÃ¡ lá»›n"),

  totalAmount: z
    .number()
    .min(0, "ThÃ nh tiá»n khÃ´ng Ä‘Æ°á»£c Ã¢m")
    .max(9999999999, "Sá»‘ tiá»n quÃ¡ lá»›n"),
});

// Schema cho cáº£ phiáº¿u
export const goodsReceiptSchema = z.object({
  clinicId: z
    .string({ required_error: "Clinic ID lÃ  báº¯t buá»™c" })
    .uuid("Clinic ID khÃ´ng há»£p lá»‡"),
  // Note: clinicId Ä‘Æ°á»£c auto-fill tá»« currentUser, khÃ´ng tá»« form input

  invoiceNo: z.string().max(50).optional(),

  supplierId: z
    .number({ required_error: "Vui lÃ²ng chá»n nhÃ  cung cáº¥p" })
    .positive(),

  receiptDate: z.date().refine(
    (date) => {
      const now = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(now.getDate() - 7);

      // Reset time
      date.setHours(0, 0, 0, 0);
      now.setHours(0, 0, 0, 0);
      sevenDaysAgo.setHours(0, 0, 0, 0);

      return date <= now && date >= sevenDaysAgo;
    },
    {
      message:
        "NgÃ y nháº­p pháº£i trong vÃ²ng 7 ngÃ y gáº§n Ä‘Ã¢y vÃ  khÃ´ng Ä‘Æ°á»£c lÃ  tÆ°Æ¡ng lai",
    }
  ),

  note: z.string().max(1000).optional(),

  details: z
    .array(goodsReceiptDetailSchema)
    .min(1, "Vui lÃ²ng nháº­p Ã­t nháº¥t 1 dÃ²ng hÃ ng hÃ³a"),
});
```

## ğŸ§ª Test Cases

### TC-1: Táº¡o phiáº¿u nháº­p kho

- **Action**: Create goods receipt
- **Expected**: Phiáº¿u Ä‘Æ°á»£c táº¡o, code tá»± sinh theo format {clinicCode}-PN-YYMM-XXXX, tá»“n kho tÄƒng ngay láº­p tá»©c

### TC-2: Tá»± Ä‘á»™ng tÃ­nh Ä‘Æ¡n giÃ¡

- **Input**: quantity=15, totalAmount=1,000,000
- **Expected**: unitPrice = 66,666.67 (lÃ m trÃ²n)

### TC-3: HSD optional - cho phÃ©p bá» trá»‘ng

- **Input**: Táº¡o phiáº¿u vá»›i detail khÃ´ng cÃ³ expiryDate
- **Expected**: Status 201, phiáº¿u Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng, expiryDate = null

### TC-4: Validate ngÃ y nháº­p (quÃ¡ khá»© > 7 ngÃ y)

- **Input**: receiptDate = 10 ngÃ y trÆ°á»›c
- **Expected**: Status 400, "NgÃ y nháº­p pháº£i trong vÃ²ng 7 ngÃ y"

### TC-5: Nháº­p kho ngay khi táº¡o phiáº¿u

- **Input**: Táº¡o phiáº¿u vá»›i valid data
- **Expected**:
  - Status 201
  - Phiáº¿u Ä‘Æ°á»£c táº¡o (khÃ´ng cÃ³ status)
  - StockQuant Ä‘Æ°á»£c táº¡o (1 record/detail)
  - StockMove Ä‘Æ°á»£c ghi log

### TC-6: KhÃ´ng sá»­a Ä‘Æ°á»£c phiáº¿u sau khi táº¡o

- **Input**: Attempt to update receipt
- **Expected**: KhÃ´ng cÃ³ API endpoint UPDATE, phiáº¿u khÃ´ng thá»ƒ sá»­a sau khi táº¡o

### TC-7: Há»§y phiáº¿u (tá»“n kho Ä‘á»§)

- **Setup**: Phiáº¿u Ä‘Ã£ táº¡o, tá»“n kho = sá»‘ lÆ°á»£ng nháº­p
- **Action**: Cancel receipt
- **Expected**: Status 200, tá»“n kho vá» 0, cancelledAt Ä‘Æ°á»£c set

### TC-8: Há»§y phiáº¿u (tá»“n kho khÃ´ng Ä‘á»§ - Ä‘Ã£ xuáº¥t)

- **Setup**: Tá»“n kho < sá»‘ lÆ°á»£ng nháº­p (Ä‘Ã£ xuáº¥t má»™t pháº§n)
- **Action**: POST /goods-receipts/123/cancel
- **Expected**: Status 400, "KhÃ´ng thá»ƒ há»§y: hÃ ng Ä‘Ã£ xuáº¥t"

## ğŸ¯ Acceptance Criteria

- [ ] Danh sÃ¡ch phiáº¿u nháº­p vá»›i filter theo ngÃ y, NCC
- [ ] Form táº¡o vá»›i Editable Table cho chi tiáº¿t
- [ ] **TrÆ°á»ng PhÃ²ng khÃ¡m**: Hiá»ƒn thá»‹ tÃªn clinic cá»§a user, disabled (khÃ´ng cho sá»­a)
- [ ] Code tá»± sinh theo format {clinicCode}-PN-YYMM-XXXX dá»±a trÃªn clinic cá»§a user
- [ ] Sequence reset má»—i thÃ¡ng má»›i (0001, 0002...)
- [ ] ÄÆ¡n giÃ¡ tá»± tÃ­nh = ThÃ nh tiá»n / Sá»‘ lÆ°á»£ng (read-only)
- [ ] HSD lÃ  optional, cho phÃ©p bá» trá»‘ng (nhiá»u hÃ ng khÃ´ng cÃ³ HSD)
- [ ] Validate ngÃ y nháº­p khÃ´ng quÃ¡ 7 ngÃ y
- [ ] NÃºt "Nháº­p kho" táº¡o phiáº¿u vÃ  cáº­p nháº­t tá»“n kho ngay
- [ ] Sau táº¡o phiáº¿u: táº¡o StockQuant vÃ  StockMove Ä‘Ãºng
- [ ] NÃºt "Há»§y" kiá»ƒm tra tá»“n kho trÆ°á»›c khi cho phÃ©p
- [ ] Phiáº¿u khÃ´ng cho edit sau khi táº¡o (chá»‰ view vÃ  há»§y)

---

**Priority**: ğŸ”´ Critical (Core cá»§a há»‡ thá»‘ng FIFO)  
**Estimated Effort**: 3-4 ngÃ y  
**Dependencies**: 015.1, 015.2, 015.3
