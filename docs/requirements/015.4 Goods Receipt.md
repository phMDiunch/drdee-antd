# ğŸ“¥ Requirements: Goods Receipt Note - Phiáº¿u Nháº­p Kho (GRN)

> **ğŸ“‹ STATUS: PENDING** - Giai Ä‘oáº¡n 1, TÃ­nh nÄƒng 4 (Core FIFO Engine)  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`  
> **ğŸ“„ Implementation**: `src/features/inventory/goods-receipts/`  
> **âš ï¸ Dependencies**: 015.1 Dictionary, 015.2 Supplier, 015.3 Material

## ğŸ¯ Má»¥c TiÃªu

Ghi nháº­n viá»‡c nháº­p hÃ ng hÃ³a tá»« NhÃ  cung cáº¥p vÃ o kho. ÄÃ¢y lÃ  **"trÃ¡i tim" cá»§a há»‡ thá»‘ng FIFO** vÃ¬:

- Má»—i dÃ²ng nháº­p = 1 "lÃ´ ná»™i bá»™" vá»›i giÃ¡ vá»‘n cá»‘ Ä‘á»‹nh
- Ghi nháº­n Ä‘áº§y Ä‘á»§: Sá»‘ LÃ´ NSX, Háº¡n sá»­ dá»¥ng (Ä‘á»ƒ truy xuáº¥t nguá»“n gá»‘c)
- Táº¡o ná»n táº£ng dá»¯ liá»‡u cho xuáº¥t kho tá»± Ä‘á»™ng

## ğŸ“Š Quy TrÃ¬nh Nghiá»‡p Vá»¥

```
[Nháº­p liá»‡u]     [Kiá»ƒm tra]      [XÃ¡c nháº­n]         [Káº¿t quáº£]
    â”‚               â”‚               â”‚                  â”‚
    â–¼               â–¼               â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NHÃP   â”‚â”€â”€â”€â–¶â”‚ Validateâ”‚â”€â”€â”€â–¶â”‚ ÄÃƒ XÃC   â”‚â”€â”€â”€â–¶â”‚ Tá»“n kho +  â”‚
â”‚ (DRAFT) â”‚    â”‚  Dá»¯ liá»‡uâ”‚    â”‚  NHáº¬N    â”‚    â”‚ Ghi ledger â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ (POSTED) â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘  â†“                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[Sá»­a/XÃ³a]                            â”‚
                                     â–¼
                              [KHÃ”NG Sá»¬A ÄÆ¯á»¢C]
                              (Chá»‰ Há»¦Y náº¿u chÆ°a xuáº¥t)
```

## ğŸ“‹ User Stories

### US-1: Táº¡o Phiáº¿u Nháº­p (NhÃ¡p)

**LÃ  Thá»§ Kho**, tÃ´i muá»‘n:

- Táº¡o phiáº¿u nháº­p má»›i vá»›i tráº¡ng thÃ¡i NhÃ¡p
- Há»‡ thá»‘ng tá»± sinh sá»‘ phiáº¿u ná»™i bá»™ (GRN-YYYYMMDD-XXXX)
- Nháº­p sá»‘ hÃ³a Ä‘Æ¡n/chá»©ng tá»« cá»§a NCC
- Chá»n ngÃ y nháº­p kho (khÃ´ng quÃ¡ 7 ngÃ y)
- Chá»n NCC tá»« danh sÃ¡ch
- LÆ°u phiáº¿u Ä‘á»ƒ tiáº¿p tá»¥c nháº­p sau

### US-2: Nháº­p Chi Tiáº¿t HÃ ng HÃ³a

**LÃ  Thá»§ Kho**, tÃ´i muá»‘n:

- ThÃªm nhiá»u dÃ²ng váº­t tÆ° vÃ o phiáº¿u
- Vá»›i má»—i dÃ²ng, nháº­p:
  - Váº­t tÆ° (chá»n tá»« danh sÃ¡ch)
  - **Sá»‘ lÆ°á»£ng** (bao nhiÃªu Ä‘Æ¡n vá»‹)
  - **ThÃ nh tiá»n tá»•ng** (giÃ¡ trá»‹ sau chiáº¿t kháº¥u/táº·ng kÃ¨m)
  - Há»‡ thá»‘ng **tá»± tÃ­nh Ä‘Æ¡n giÃ¡** = ThÃ nh tiá»n / Sá»‘ lÆ°á»£ng
  - **Sá»‘ LÃ´ NSX** (nháº­p tay tá»« vá» há»™p - báº¯t buá»™c)
  - **Háº¡n sá»­ dá»¥ng** (chá»n ngÃ y tá»« vá» há»™p - báº¯t buá»™c)

**Giáº£i quyáº¿t case: "Mua 10 táº·ng 5"**

- Nháº­p: Sá»‘ lÆ°á»£ng = 15, ThÃ nh tiá»n = 1,000,000
- Há»‡ thá»‘ng tÃ­nh: ÄÆ¡n giÃ¡ = 66,667 VNÄ/cÃ¡i

### US-3: XÃ¡c Nháº­n Nháº­p Kho (Posting)

**LÃ  Thá»§ Kho**, sau khi kiá»ƒm Ä‘áº¿m hÃ ng thá»±c táº¿:

- TÃ´i báº¥m "XÃ¡c nháº­n nháº­p kho"
- Há»‡ thá»‘ng:
  - KhÃ³a phiáº¿u (khÃ´ng sá»­a Ä‘Æ°á»£c ná»¯a)
  - **Táº¡o StockQuant** (tá»“n kho hiá»‡n táº¡i) cho tá»«ng dÃ²ng
  - **Ghi StockMove** (lá»‹ch sá»­ giao dá»‹ch)
  - Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng

### US-4: Há»§y Phiáº¿u ÄÃ£ XÃ¡c Nháº­n (TrÆ°á»ng há»£p Ä‘áº·c biá»‡t)

**LÃ  Quáº£n lÃ½**, náº¿u phÃ¡t hiá»‡n nháº­p sai:

- TÃ´i cÃ³ thá»ƒ há»§y phiáº¿u **CHá»ˆ KHI**:
  - HÃ ng chÆ°a xuáº¥t ra (tá»“n kho >= sá»‘ lÆ°á»£ng Ä‘Ã£ nháº­p)
  - ChÆ°a cÃ³ nghiá»‡p vá»¥ phÃ¡t sinh khÃ¡c
- Há»‡ thá»‘ng tá»± Ä‘á»™ng trá»« tá»“n kho Ä‘i

## ğŸ¨ UI/UX Requirements

### MÃ n hÃ¬nh Danh SÃ¡ch Phiáº¿u Nháº­p

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¥ Phiáº¿u Nháº­p Kho                                [+ Táº¡o Phiáº¿u Má»›i]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Tá»« ngÃ y: [ğŸ“…]  Äáº¿n: [ğŸ“…]  NCC: [Táº¥t cáº£ â–¼]  TT: [Táº¥t cáº£ â–¼] ğŸ” [...] â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Sá»‘ GRN      â”‚ Sá»‘ HÄ  â”‚ NgÃ y    â”‚ NCC    â”‚ Tá»•ng tiá»nâ”‚ TT    â”‚âš™ â”‚    â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”‚    â”‚
â”‚  â”‚ GRN-...-001 â”‚ HD123  â”‚ 20/1/25 â”‚ ABC    â”‚ 10,000k  â”‚ ğŸ“NhÃ¡pâ”‚âœâ”‚    â”‚
â”‚  â”‚ GRN-...-002 â”‚ HD124  â”‚ 21/1/25 â”‚ XYZ    â”‚ 5,000k   â”‚ âœ…ÄÃ£ XNâ”‚ğŸ‘â”‚   â”‚
â”‚  â”‚ GRN-...-003 â”‚ HD125  â”‚ 21/1/25 â”‚ ABC    â”‚ 8,000k   â”‚ âœ…ÄÃ£ XNâ”‚ğŸ‘â”‚   â”‚
â”‚  â”‚ GRN-...-004 â”‚ -      â”‚ 22/1/25 â”‚ MNO    â”‚ 3,500k   â”‚ ğŸ“NhÃ¡pâ”‚âœâ”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Form Táº¡o/Sá»­a Phiáº¿u Nháº­p

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœï¸  Phiáº¿u Nháº­p Kho [GRN-20250121-005]          [Tráº¡ng thÃ¡i:   â”‚
â”‚                                                   ğŸ“ NhÃ¡p]  [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”â”â” THÃ”NG TIN CHUNG â”â”â”                                       â”‚
â”‚                                                                 â”‚
â”‚  Sá»‘ phiáº¿u ná»™i bá»™            Sá»‘ hÃ³a Ä‘Æ¡n NCC *                   â”‚
â”‚  [GRN-20250121-005]         [________________]                 â”‚
â”‚  (Read-only, tá»± sinh)       (Nháº­p tay)                         â”‚
â”‚                                                                 â”‚
â”‚  NgÃ y nháº­p kho *            NhÃ  cung cáº¥p *                     â”‚
â”‚  [ğŸ“… 21/01/2025]            [Dropdown: Chá»n NCC â–¼]             â”‚
â”‚                             ABC Medical Supply                 â”‚
â”‚                                                                 â”‚
â”‚  Ghi chÃº                                                        â”‚
â”‚  [___________________________________]                          â”‚
â”‚                                                                 â”‚
â”‚  â”â”â” CHI TIáº¾T HÃ€NG HÃ“A â”â”â”                         [+ ThÃªm]    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Váº­t tÆ°      â”‚ SL â”‚ ThÃ nh tiá»nâ”‚ ÄÆ¡n giÃ¡ â”‚ LÃ´ NSX â”‚ HSD  â”‚ğŸ—‘â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”‚  â”‚
â”‚  â”‚ Implant A â–¼ â”‚ 10 â”‚ 1,000,000 â”‚100,000  â”‚LOT123  â”‚12/26â”‚Ã—â”‚  â”‚
â”‚  â”‚ GÄƒng tay M â–¼â”‚ 15 â”‚ 1,000,000 â”‚ 66,667  â”‚LOT456  â”‚06/26â”‚Ã—â”‚  â”‚
â”‚  â”‚ [Chá»n VT â–¼] â”‚    â”‚           â”‚         â”‚        â”‚     â”‚Ã—â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  Tá»•ng cá»™ng:                        2,000,000 VNÄ               â”‚
â”‚                                                                 â”‚
â”‚  â”â”â” HÃ€NH Äá»˜NG â”â”â”                                              â”‚
â”‚                                                                 â”‚
â”‚  [Há»§y]       [ğŸ’¾ LÆ°u NhÃ¡p]       [âœ… XÃ¡c Nháº­n Nháº­p Kho]        â”‚
â”‚  (ÄÃ³ng)      (Save DRAFT)        (POST â†’ Cáº­p nháº­t tá»“n)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LÆ°u Ã½ UI**:

- **ÄÆ¡n giÃ¡**: Read-only, mÃ u xÃ¡m, tá»± tÃ­nh = ThÃ nh tiá»n / SL
- **LÃ´ NSX & HSD**: Required, highlight Ä‘á» náº¿u bá» trá»‘ng
- **Tooltip**: "Nháº­p chÃ­nh xÃ¡c sá»‘ lÃ´ vÃ  HSD tá»« vá» há»™p Ä‘á»ƒ truy xuáº¥t nguá»“n gá»‘c"

### View Chi Tiáº¿t (ÄÃ£ XÃ¡c Nháº­n - Read Only)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ Chi Tiáº¿t Phiáº¿u Nháº­p #GRN-20250121-002      [âœ… ÄÃƒ XÃC NHáº¬N]â”‚
â”‚                                                          [ÄÃ³ng]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Sá»‘ HÄ NCC: HD124                  NgÃ y: 21/01/2025            â”‚
â”‚  NCC: XYZ Labo                     NgÆ°á»i táº¡o: Nguyá»…n VÄƒn A     â”‚
â”‚  Ghi chÃº: Nháº­p váº­t liá»‡u thÃ¡ng 1                                â”‚
â”‚                                                                 â”‚
â”‚  â”â”â” CHI TIáº¾T HÃ€NG HÃ“A â”â”â”                                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Váº­t tÆ°        â”‚ SL â”‚ ÄÆ¡n giÃ¡ â”‚ ThÃ nh tiá»nâ”‚ LÃ´ NSX â”‚ HSD   â”‚ â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”‚ â”‚
â”‚  â”‚ Implant B     â”‚ 20 â”‚ 200,000 â”‚ 4,000,000 â”‚ABC123  â”‚03/2026â”‚ â”‚
â”‚  â”‚ Abutment C    â”‚ 10 â”‚ 100,000 â”‚ 1,000,000 â”‚XYZ789  â”‚06/2027â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  Tá»•ng cá»™ng:                           5,000,000 VNÄ            â”‚
â”‚                                                                 â”‚
â”‚  [ğŸ—‘ï¸ Há»§y Phiáº¿u]  (Chá»‰ hiá»‡n náº¿u user cÃ³ quyá»n vÃ  hÃ ng chÆ°a xuáº¥t)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Functional Requirements

### FR-1: Tá»± Äá»™ng Sinh Sá»‘ Phiáº¿u

**Format**: `GRN-YYYYMMDD-XXXX`

- `GRN`: Prefix cá»‘ Ä‘á»‹nh
- `YYYYMMDD`: NgÃ y táº¡o phiáº¿u
- `XXXX`: Sequence trong ngÃ y (0001, 0002...)

```typescript
async function generateReceiptCode(): Promise<string> {
  const today = new Date();
  const dateStr = format(today, "yyyyMMdd"); // 20250121
  const prefix = `GRN-${dateStr}-`;

  const lastReceipt = await prisma.goodsReceipt.findFirst({
    where: { code: { startsWith: prefix } },
    orderBy: { code: "desc" },
  });

  if (!lastReceipt) return `${prefix}0001`;

  const lastSeq = parseInt(lastReceipt.code.split("-")[2]);
  const nextSeq = lastSeq + 1;
  return `${prefix}${nextSeq.toString().padStart(4, "0")}`;
}
```

### FR-2: Business Rules

1. **Tráº¡ng thÃ¡i**: DRAFT (NhÃ¡p) â†’ POSTED (ÄÃ£ xÃ¡c nháº­n) â†’ CANCELLED (ÄÃ£ há»§y)
2. **Validate ngÃ y nháº­p**:
   - KhÃ´ng Ä‘Æ°á»£c chá»n tÆ°Æ¡ng lai
   - KhÃ´ng Ä‘Æ°á»£c quÃ¡ khá»© > 7 ngÃ y
3. **Chi tiáº¿t phiáº¿u**:
   - Tá»‘i thiá»ƒu 1 dÃ²ng váº­t tÆ°
   - Má»—i dÃ²ng: Sá»‘ lÆ°á»£ng > 0, ThÃ nh tiá»n >= 0
   - Sá»‘ LÃ´ NSX & HSD: **Báº®T BUá»˜C** (khÃ´ng cho phÃ©p NULL)
4. **XÃ¡c nháº­n nháº­p kho**:
   - Chá»‰ khi tráº¡ng thÃ¡i = DRAFT
   - Validate táº¥t cáº£ dÃ²ng chi tiáº¿t Ä‘áº§y Ä‘á»§
5. **Há»§y phiáº¿u**:
   - Chá»‰ khi tráº¡ng thÃ¡i = POSTED
   - Kiá»ƒm tra tá»“n kho Ä‘á»§ Ä‘á»ƒ trá»«

### FR-3: Logic XÃ¡c Nháº­n Nháº­p Kho (Posting)

**ÄÃ¢y lÃ  logic quan trá»ng nháº¥t**. Khi user báº¥m "XÃ¡c nháº­n":

```typescript
async function confirmGoodsReceipt(receiptId: number) {
  return await prisma.$transaction(async (tx) => {
    // 1. Update header status
    await tx.goodsReceipt.update({
      where: { id: receiptId },
      data: { status: "POSTED" },
    });

    // 2. Get all details
    const details = await tx.goodsReceiptDetail.findMany({
      where: { goodsReceiptId: receiptId },
    });

    // 3. Process each line
    for (const detail of details) {
      // 3a. Create StockQuant (1:1 vá»›i receiptDetail)
      await tx.stockQuant.create({
        data: {
          materialId: detail.materialId,
          goodsReceiptDetailId: detail.id, // ÄÃ¢y lÃ  "lÃ´ ná»™i bá»™"
          quantity: detail.quantity,
        },
      });

      // 3b. Log StockMove (Ledger)
      await tx.stockMove.create({
        data: {
          transactionDate: receipt.receiptDate,
          type: "IN_RECEIPT",
          materialId: detail.materialId,
          quantityChange: detail.quantity, // Sá»‘ dÆ°Æ¡ng (+)
          goodsReceiptDetailId: detail.id,
          goodsReceiptId: receiptId,
        },
      });
    }

    return { success: true };
  });
}
```

### FR-4: Logic Há»§y Phiáº¿u (Cancellation)

```typescript
async function cancelGoodsReceipt(receiptId: number) {
  return await prisma.$transaction(async (tx) => {
    const details = await tx.goodsReceiptDetail.findMany({
      where: { goodsReceiptId: receiptId },
      include: { stockQuant: true },
    });

    // Validate: Kiá»ƒm tra tá»“n kho cÃ²n Ä‘á»§ khÃ´ng?
    for (const detail of details) {
      if (!detail.stockQuant) {
        throw new Error("StockQuant khÃ´ng tá»“n táº¡i");
      }
      if (detail.stockQuant.quantity < detail.quantity) {
        throw new Error(
          `KhÃ´ng thá»ƒ há»§y: ${detail.material.name} Ä‘Ã£ xuáº¥t má»™t pháº§n`
        );
      }
    }

    // OK, proceed to cancel
    for (const detail of details) {
      // Trá»« tá»“n kho
      await tx.stockQuant.update({
        where: { goodsReceiptDetailId: detail.id },
        data: { quantity: { decrement: detail.quantity } },
      });

      // Ghi StockMove Ä‘áº£o ngÆ°á»£c
      await tx.stockMove.create({
        data: {
          type: "IN_RECEIPT_CANCELLED",
          materialId: detail.materialId,
          quantityChange: -detail.quantity, // Sá»‘ Ã¢m (-)
          goodsReceiptDetailId: detail.id,
        },
      });
    }

    // Update header
    await tx.goodsReceipt.update({
      where: { id: receiptId },
      data: { status: "CANCELLED" },
    });
  });
}
```

### FR-5: API Endpoints

```
GET    /api/inventory/goods-receipts?page=1&limit=20&status=&supplierId=&fromDate=&toDate=
GET    /api/inventory/goods-receipts/:id
POST   /api/inventory/goods-receipts                    # Create draft
PUT    /api/inventory/goods-receipts/:id                # Update draft only
DELETE /api/inventory/goods-receipts/:id                # Delete draft only
POST   /api/inventory/goods-receipts/:id/confirm        # Posting
POST   /api/inventory/goods-receipts/:id/cancel         # Cancel posted
GET    /api/inventory/goods-receipts/generate-code
```

## ğŸ’¾ Data Model (Prisma)

```prisma
enum GoodsReceiptStatus {
  DRAFT       // NhÃ¡p - cho phÃ©p sá»­a
  POSTED      // ÄÃ£ xÃ¡c nháº­n - khÃ³a cá»©ng
  CANCELLED   // ÄÃ£ há»§y
}

model GoodsReceipt {
  id           Int                  @id @default(autoincrement())
  code         String               @unique // GRN-YYYYMMDD-XXXX
  invoiceNo    String?              // Sá»‘ hÃ³a Ä‘Æ¡n NCC (nháº­p tay)
  receiptDate  DateTime             @default(now())

  supplierId   Int
  supplier     Supplier             @relation(fields: [supplierId], references: [id])

  status       GoodsReceiptStatus   @default(DRAFT)
  note         String?
  totalAmount  Decimal              @default(0) @db.Decimal(15, 2)

  createdById  Int?                 // User ID (náº¿u cÃ³ auth)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  details      GoodsReceiptDetail[]
  stockMoves   StockMove[]

  @@index([code])
  @@index([receiptDate, status])
  @@index([supplierId])
}

model GoodsReceiptDetail {
  id             Int           @id @default(autoincrement())
  goodsReceiptId Int
  goodsReceipt   GoodsReceipt  @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)

  materialId     Int
  material       Material      @relation(fields: [materialId], references: [id])

  // Truy xuáº¥t nguá»“n gá»‘c (Traceability)
  batchNo        String        // Sá»‘ LÃ´ NSX (Báº¯t buá»™c nháº­p tá»« vá» há»™p)
  expiryDate     DateTime      // Háº¡n sá»­ dá»¥ng (Báº¯t buá»™c)

  // Sá»‘ lÆ°á»£ng & GiÃ¡
  quantity       Decimal       @db.Decimal(15, 2) // Sá»‘ lÆ°á»£ng nháº­p
  unitPrice      Decimal       @db.Decimal(15, 2) // ÄÆ¡n giÃ¡ = totalAmount/quantity (tá»± tÃ­nh)
  totalAmount    Decimal       @db.Decimal(15, 2) // ThÃ nh tiá»n (user nháº­p)

  // Quan há»‡ 1:1 vá»›i StockQuant (má»—i dÃ²ng nháº­p = 1 lÃ´ ná»™i bá»™)
  stockQuant     StockQuant?

  // Quan há»‡ ngÆ°á»£c: dÃ²ng nÃ y Ä‘Ã£ Ä‘Æ°á»£c xuáº¥t Ä‘i bao nhiÃªu láº§n
  issueDetails   GoodsIssueDetail[]
}

model StockQuant {
  id                   Int                @id @default(autoincrement())
  materialId           Int
  material             Material           @relation(fields: [materialId], references: [id])

  // QUAN Há»† 1:1 - ÄÃ‚Y LÃ€ "Sá» LÃ” Ná»˜I Bá»˜"
  goodsReceiptDetailId Int                @unique
  receiptDetail        GoodsReceiptDetail @relation(fields: [goodsReceiptDetailId], references: [id])

  quantity             Decimal            @default(0) @db.Decimal(15, 2) // Sá»‘ lÆ°á»£ng CÃ’N Láº I

  @@index([materialId, quantity])
  @@index([materialId, goodsReceiptDetailId(sort: Asc)]) // For FIFO query
}

enum StockMoveType {
  IN_RECEIPT               // Nháº­p mua
  IN_RECEIPT_CANCELLED     // Há»§y nháº­p
  OUT_PATIENT              // Xuáº¥t cho BN (phase 1.5)
  OUT_DEPARTMENT           // Xuáº¥t cho BS (phase 1.5)
  // ... more types in later phases
}

model StockMove {
  id               Int              @id @default(autoincrement())
  transactionDate  DateTime         @default(now())
  type             StockMoveType

  materialId       Int
  material         Material         @relation(fields: [materialId], references: [id])

  quantityChange   Decimal          @db.Decimal(15, 2) // + hoáº·c -

  // Link tá»›i chá»©ng tá»« gá»‘c
  goodsReceiptId   Int?
  goodsReceipt     GoodsReceipt?    @relation(fields: [goodsReceiptId], references: [id])
  goodsReceiptDetailId Int?

  @@index([materialId, transactionDate])
}
```

## âœ… Validation (Zod Schema)

```typescript
import { z } from "zod";

// Schema cho 1 dÃ²ng chi tiáº¿t
export const goodsReceiptDetailSchema = z.object({
  materialId: z.number({ required_error: "Vui lÃ²ng chá»n váº­t tÆ°" }).positive(),

  // Truy xuáº¥t nguá»“n gá»‘c - Báº®T BUá»˜C
  batchNo: z
    .string({ required_error: "Vui lÃ²ng nháº­p sá»‘ lÃ´ NSX tá»« vá» há»™p" })
    .min(1, "Sá»‘ lÃ´ khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng")
    .max(100),

  expiryDate: z
    .date({ required_error: "Vui lÃ²ng chá»n háº¡n sá»­ dá»¥ng tá»« vá» há»™p" })
    .refine((date) => date > new Date(), {
      message: "Háº¡n sá»­ dá»¥ng pháº£i trong tÆ°Æ¡ng lai",
    }),

  quantity: z
    .number()
    .positive("Sá»‘ lÆ°á»£ng pháº£i lá»›n hÆ¡n 0")
    .max(999999, "Sá»‘ lÆ°á»£ng quÃ¡ lá»›n"),

  totalAmount: z
    .number()
    .min(0, "ThÃ nh tiá»n khÃ´ng Ä‘Æ°á»£c Ã¢m")
    .max(9999999999, "Sá»‘ tiá»n quÃ¡ lá»›n"),
});

// Schema cho cáº£ phiáº¿u
export const goodsReceiptSchema = z.object({
  invoiceNo: z.string().max(50).optional(),

  supplierId: z
    .number({ required_error: "Vui lÃ²ng chá»n nhÃ  cung cáº¥p" })
    .positive(),

  receiptDate: z.date().refine(
    (date) => {
      const now = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(now.getDate() - 7);

      // Reset time
      date.setHours(0, 0, 0, 0);
      now.setHours(0, 0, 0, 0);
      sevenDaysAgo.setHours(0, 0, 0, 0);

      return date <= now && date >= sevenDaysAgo;
    },
    {
      message:
        "NgÃ y nháº­p pháº£i trong vÃ²ng 7 ngÃ y gáº§n Ä‘Ã¢y vÃ  khÃ´ng Ä‘Æ°á»£c lÃ  tÆ°Æ¡ng lai",
    }
  ),

  note: z.string().max(1000).optional(),

  details: z
    .array(goodsReceiptDetailSchema)
    .min(1, "Vui lÃ²ng nháº­p Ã­t nháº¥t 1 dÃ²ng hÃ ng hÃ³a"),
});
```

## ğŸ§ª Test Cases

### TC-1: Táº¡o phiáº¿u nhÃ¡p thÃ nh cÃ´ng

- **Input**: Valid header + 2 dÃ²ng chi tiáº¿t
- **Expected**: Status 201, phiáº¿u cÃ³ tráº¡ng thÃ¡i DRAFT, code tá»± sinh

### TC-2: Tá»± Ä‘á»™ng tÃ­nh Ä‘Æ¡n giÃ¡

- **Input**: quantity=15, totalAmount=1,000,000
- **Expected**: unitPrice = 66,666.67 (lÃ m trÃ²n)

### TC-3: Validate sá»‘ lÃ´ & HSD báº¯t buá»™c

- **Input**: Bá» trá»‘ng batchNo hoáº·c expiryDate
- **Expected**: Status 400, error message cá»¥ thá»ƒ

### TC-4: Validate ngÃ y nháº­p (quÃ¡ khá»© > 7 ngÃ y)

- **Input**: receiptDate = 10 ngÃ y trÆ°á»›c
- **Expected**: Status 400, "NgÃ y nháº­p pháº£i trong vÃ²ng 7 ngÃ y"

### TC-5: XÃ¡c nháº­n nháº­p kho

- **Input**: POST /goods-receipts/123/confirm
- **Expected**:
  - Status 200
  - Receipt.status = POSTED
  - StockQuant Ä‘Æ°á»£c táº¡o (1 record/detail)
  - StockMove Ä‘Æ°á»£c ghi log

### TC-6: KhÃ´ng sá»­a Ä‘Æ°á»£c phiáº¿u Ä‘Ã£ xÃ¡c nháº­n

- **Input**: PUT /goods-receipts/123 (status=POSTED)
- **Expected**: Status 403, "KhÃ´ng thá»ƒ sá»­a phiáº¿u Ä‘Ã£ xÃ¡c nháº­n"

### TC-7: Há»§y phiáº¿u (tá»“n kho Ä‘á»§)

- **Setup**: Receipt Ä‘Ã£ POST, tá»“n kho = sá»‘ lÆ°á»£ng nháº­p
- **Action**: POST /goods-receipts/123/cancel
- **Expected**: Status 200, tá»“n kho vá» 0, status=CANCELLED

### TC-8: Há»§y phiáº¿u (tá»“n kho khÃ´ng Ä‘á»§ - Ä‘Ã£ xuáº¥t)

- **Setup**: Tá»“n kho < sá»‘ lÆ°á»£ng nháº­p (Ä‘Ã£ xuáº¥t má»™t pháº§n)
- **Action**: POST /goods-receipts/123/cancel
- **Expected**: Status 400, "KhÃ´ng thá»ƒ há»§y: hÃ ng Ä‘Ã£ xuáº¥t"

## ğŸ¯ Acceptance Criteria

- [ ] Danh sÃ¡ch phiáº¿u nháº­p vá»›i filter theo ngÃ y, NCC, tráº¡ng thÃ¡i
- [ ] Form táº¡o/sá»­a vá»›i Editable Table cho chi tiáº¿t
- [ ] Code tá»± sinh theo format GRN-YYYYMMDD-XXXX
- [ ] ÄÆ¡n giÃ¡ tá»± tÃ­nh = ThÃ nh tiá»n / Sá»‘ lÆ°á»£ng (read-only)
- [ ] Validate báº¯t buá»™c Sá»‘ LÃ´ NSX vÃ  HSD
- [ ] Validate ngÃ y nháº­p khÃ´ng quÃ¡ 7 ngÃ y
- [ ] Button "XÃ¡c nháº­n" chá»‰ hiá»‡n khi status=DRAFT
- [ ] Sau xÃ¡c nháº­n: táº¡o StockQuant vÃ  StockMove Ä‘Ãºng
- [ ] Button "Há»§y" kiá»ƒm tra tá»“n kho trÆ°á»›c khi cho phÃ©p
- [ ] Phiáº¿u Ä‘Ã£ xÃ¡c nháº­n khÃ´ng cho edit (chá»‰ view)

---

**Priority**: ğŸ”´ Critical (Core cá»§a há»‡ thá»‘ng FIFO)  
**Estimated Effort**: 3-4 ngÃ y  
**Dependencies**: 015.1, 015.2, 015.3
