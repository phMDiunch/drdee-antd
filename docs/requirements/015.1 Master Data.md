# ğŸ”§ Requirements: Master Data

> **âœ… STATUS: COMPLETED** - Implemented and verified  
> **ğŸ“„ Implementation**: `src/features/master-data/` (Shared toÃ n app)  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`

## ğŸ¯ Má»¥c TiÃªu

Quáº£n lÃ½ dá»¯ liá»‡u chá»§ Ä‘á»™ng linh hoáº¡t cho toÃ n app vá»›i kháº£ nÄƒng **admin tá»± Ä‘á»‹nh nghÄ©a categories** mÃ  khÃ´ng cáº§n dev can thiá»‡p. Há»— trá»£ cáº¥u trÃºc phÃ¢n cáº¥p (cha-con) trong cÃ¹ng nhÃ³m.

**Concept:**

- **Root Categories**: Admin tá»± táº¡o (VD: "NhÃ³m NhÃ  Cung Cáº¥p", "Bá»™ MÃ´n", "ÄÆ¡n Vá»‹ TÃ­nh")
- **Children Items**: Thuá»™c vá» 1 root category, cÃ³ thá»ƒ cÃ³ nhiá»u cáº¥p con
- **Flexible**: KhÃ´ng hardcode types trong code â†’ Admin hoÃ n toÃ n kiá»ƒm soÃ¡t

**VÃ­ Dá»¥ Hierarchy:**

```
ğŸ“ NhÃ³m NhÃ  Cung Cáº¥p (root, allowHierarchy=true)
  â””â”€ NCC ChÃ­nh
  â””â”€ NCC Phá»¥
ğŸ“ Bá»™ MÃ´n (root, allowHierarchy=true)
  â””â”€ Ná»™i khoa
      â””â”€ Tim máº¡ch
      â””â”€ TiÃªu hÃ³a
  â””â”€ Ngoáº¡i khoa
ğŸ“„ ÄÆ¡n Vá»‹ TÃ­nh - Kg (root, allowHierarchy=false)
ğŸ“„ ÄÆ¡n Vá»‹ TÃ­nh - LÃ­t (root, allowHierarchy=false)
```

## ğŸ“Š Database Model

Prisma Model MasterData: `src/prisma/schema.prisma`

```prisma
model MasterData {
  id              String    @id @default(uuid())
  key             String    @unique  // MÃ£ Ä‘á»‹nh danh - IMMUTABLE
  value           String    // TÃªn hiá»ƒn thá»‹ - MUTABLE
  description     String?
  allowHierarchy  Boolean   @default(false)  // Root items: cho phÃ©p cÃ³ children
  isActive        Boolean   @default(true)

  // Self-referencing hierarchy (parent-child trong cÃ¹ng root)
  parentId    String?
  parent      MasterData?  @relation("Hierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    MasterData[] @relation("Hierarchy")
  // NoAction: App tá»± handle delete/update logic (vÃ¬ dÃ¹ng soft delete + check children)

  // Root category tracking
  rootId      String?
  root        MasterData?  @relation("RootCategory", fields: [rootId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  descendants MasterData[] @relation("RootCategory")
  // Cascade: Khi xÃ³a root â†’ xÃ³a háº¿t descendants

  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime  @updatedAt @db.Timestamptz

  @@index([rootId, isActive])
  @@index([parentId])
  @@map("master_data")
}
```

**Key Changes:**

- âŒ Bá» `type` field (khÃ´ng hardcode categories)
- âœ… ThÃªm `allowHierarchy` Boolean (root items cÃ³ thá»ƒ cÃ³ children)
- âœ… ThÃªm `rootId` + `root`/`descendants` relations (tracking category)
- âœ… `key` giá» lÃ  `@unique` globally (khÃ´ng cÃ²n unique per type)

---

## ğŸ¯ Core Requirements

### 1. â• Táº¡o Dá»¯ Liá»‡u Chá»§ (Create)

#### ğŸ” Permissions

- Chá»‰ **Admin** má»›i Ä‘Æ°á»£c táº¡o/sá»­a/xÃ³a
- Táº¥t cáº£ user xem Ä‘Æ°á»£c (Ä‘á»ƒ dÃ¹ng trong dropdowns)

#### ğŸ¨ UI/UX

- **Tree View** - Hiá»ƒn thá»‹ hierarchy trá»±c quan vá»›i expand/collapse
- **Modal form** responsive (85% width mobile, 65% width desktop)
- **React Hook Form + Zod** (KHÃ”NG dÃ¹ng Ant Design Form)
- **Real-time validation**

#### ğŸ“ Form Layout

**Táº¡o Root Category:**

```
HÃ ng 1: [Value    ] [Key  ] [â˜‘ Cho phÃ©p phÃ¢n cáº¥p] [â˜‘ KÃ­ch hoáº¡t]
HÃ ng 2: [Description                                          ]
```

**Táº¡o Child Item:**

```
HÃ ng 1: [Parent (locked - tá»« nÃºt 'Add Child')]
HÃ ng 2: [Value    ] [Key  ]
HÃ ng 3: [â˜‘ KÃ­ch hoáº¡t]
HÃ ng 4: [Description              ]
```

**Note**: Parent Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh tá»± Ä‘á»™ng khi click nÃºt "Add Child" tá»« parent node (locked input, read-only). `rootId` auto-set tá»« parent.

#### âœ… Validation Rules

- `key`: Required, 2-50 kÃ½ tá»±, lowercase, no dáº¥u, regex `/^[a-z0-9-]+$/` - **Tá»° Äá»˜NG Táº O** tá»« value (cÃ³ thá»ƒ sá»­a), **KHÃ”NG Sá»¬A** sau khi táº¡o, **UNIQUE globally**
- `value`: Required, 2-100 kÃ½ tá»± - **CÃ“ THá»‚ Sá»¬A**
- `description`: Optional, max 500 kÃ½ tá»±
- `allowHierarchy`: Boolean, chá»‰ cho root items (parentId = null)
- `rootId`: Auto-set khi chá»n parent (inherit tá»« parent.rootId hoáº·c parent.id náº¿u parent lÃ  root)
- `parentId`: Optional, TreeSelect filtered by rootId
- `isActive`: Boolean, default true

#### ğŸ”„ Business Rules

- **Root item**: `parentId = null`, `rootId = null`
- **Child item**: `parentId != null`, `rootId` auto-set theo parent
- **Hierarchy scope**: Chá»‰ trong cÃ¹ng root category (khÃ´ng cross-category)
- **allowHierarchy**: Chá»‰ root items, children inherit quyá»n cÃ³ con tá»« root

---

### 2. ğŸ“‹ Danh SÃ¡ch (List)

#### ğŸ“Š Tree View Features

- **Ant Design Tree** - Hiá»ƒn thá»‹ hierarchy vá»›i expand/collapse
- **Root level**: Hiá»ƒn thá»‹ táº¥t cáº£ root items
- **Expandable**: Click Ä‘á»ƒ xem children
- **No pagination** (< 100 items total)
- **Toggle**: "Hiá»ƒn thá»‹ Ä‘Ã£ táº¯t" checkbox
- **Action buttons**: Edit, Delete, Add Child (Admin only)

#### ğŸŒ³ Tree Node Structure

```typescript
{
  title: "NhÃ³m NhÃ  Cung Cáº¥p",
  key: "uuid-1",
  icon: allowHierarchy ? <FolderOutlined /> : <FileOutlined />,
  children: [
    { title: "NCC ChÃ­nh", key: "uuid-2", ... },
    { title: "NCC Phá»¥", key: "uuid-3", ... }
  ],
  actions: [Edit, Delete, AddChild]  // Inline actions
}
```

#### ğŸ¨ Tree Display Format

Má»—i tree node hiá»ƒn thá»‹ inline:

```
[Icon] Value (key) [Tag: Táº¯t] [Actions: Add Child | Edit | Toggle | Delete]
```

**Chi tiáº¿t**:

- **Icon**: `<FolderOutlined />` (allowHierarchy=true) hoáº·c `<FileTextOutlined />` (allowHierarchy=false)
- **Value**: TÃªn hiá»ƒn thá»‹ (bold)
- **Key**: MÃ£ Ä‘á»‹nh danh (secondary, code style)
- **Tag**: "Táº¯t" náº¿u isActive=false
- **Actions**: Inline buttons vá»›i tooltips (Admin only)

#### ğŸ”§ Components

- `MasterDataTree.tsx` - Tree view component
- `MasterDataFormModal.tsx` - Create/Edit modal form
- `MasterDataPageView.tsx` - Main page wrapper

---

### 3. âœï¸ Chá»‰nh Sá»­a (Edit)

#### ğŸ¨ UI/UX

- **Same modal** nhÆ° Create
- **Pre-populated data**
- **Key field**: Read-only (khÃ´ng cho sá»­a)
- **rootId/parentId**: KhÃ´ng thá»ƒ Ä‘á»•i (giá»¯ nguyÃªn category)
- **allowHierarchy**: Chá»‰ cho root items, khÃ´ng Ä‘á»•i náº¿u Ä‘Ã£ cÃ³ children

#### ğŸ”„ Behavior

- Cho phÃ©p sá»­a: `value`, `description`, `isActive`
- KHÃ”NG cho sá»­a: `key`, `rootId`, `parentId`, `allowHierarchy` (náº¿u cÃ³ children)
- **Unique validation**: key globally (exclude current record)
- **Circular reference check**: NgÄƒn cháº·n A â†’ B â†’ ... â†’ A (náº¿u cho phÃ©p Ä‘á»•i parent)

---

### 4. ğŸ”„ Toggle Active/Inactive & Delete Operations

#### ğŸ”„ Toggle Active (Soft Delete/Restore)

**UI:**

- Button: Icon `<StopOutlined />` (khi active) hoáº·c `<CheckCircleOutlined />` (khi inactive)
- Tooltip: "VÃ´ hiá»‡u hÃ³a" hoáº·c "KÃ­ch hoáº¡t"
- No confirmation dialog (quick toggle)

**Logic:**

```typescript
// Toggle isActive field
await masterDataRepo.toggleActive(id, !currentIsActive);
```

**Business Rules:**

- Toggle giá»¯a `isActive: true` â†” `isActive: false`
- KhÃ´ng cáº§n check children (chá»‰ áº©n/hiá»‡n, khÃ´ng xÃ³a)
- Items inactive váº«n hiá»ƒn thá»‹ khi báº­t "Hiá»ƒn thá»‹ Ä‘Ã£ táº¯t"

---

#### âŒ Delete (Hard Delete - Permanent)

**UI:**

- Button: Icon `<DeleteOutlined />`, danger style, tooltip "XÃ³a vÄ©nh viá»…n"
- Popconfirm: "Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a vÄ©nh viá»…n? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c."
- okButtonProps: `{ danger: true }`

**Logic:**

```typescript
// Kiá»ƒm tra cÃ³ children khÃ´ng
const children = await masterDataRepo.getChildren(id);
if (children.length > 0) {
  throw ERR.CONFLICT(
    "KhÃ´ng thá»ƒ xÃ³a má»¥c cÃ³ má»¥c con. HÃ£y xÃ³a cÃ¡c má»¥c con trÆ°á»›c."
  );
}

// Hard delete: permanent deletion from database
await masterDataRepo.hardDelete(id);
```

**Business Rules:**

- **Hard delete** (xÃ³a vÄ©nh viá»…n tá»« database) - Irreversible
- KhÃ´ng cho xÃ³a náº¿u cÃ³ children (pháº£i xÃ³a children trÆ°á»›c)
- **KHÃ”NG check usage** trong cÃ¡c table khÃ¡c (Supplier, Material...)
  - LÃ½ do: CÃ¡c table khÃ¡c store `key` (String), KHÃ”NG dÃ¹ng FK
  - Frontend handle: Hiá»ƒn thá»‹ `value` náº¿u tÃ¬m tháº¥y, else hiá»ƒn thá»‹ `key`
  - Trade-off: Flexibility > Strict referential integrity

**Use Cases:**

- **Toggle Active/Inactive**: áº¨n/hiá»‡n item táº¡m thá»i (reversible) - dÃ¹ng khi khÃ´ng muá»‘n hiá»ƒn thá»‹ nhÆ°ng cÃ³ thá»ƒ cáº§n sau
- **Delete**: XÃ³a vÄ©nh viá»…n (irreversible) - dÃ¹ng khi nháº­p nháº§m hoáº·c item hoÃ n toÃ n khÃ´ng cáº§n

---

## ğŸ› ï¸ Technical Implementation

### ğŸ“¡ API Endpoints

```
GET  /api/v1/master-data?rootId=uuid-1&includeInactive=1  # List by root
GET  /api/v1/master-data?rootId=null                      # List root items only
GET  /api/v1/master-data/roots?includeInactive=1          # Get root categories only (optimized)
GET  /api/v1/master-data/:id                              # Get single item by ID
```

**Cache Headers**: All GET endpoints return `Cache-Control: public, s-maxage=300, stale-while-revalidate=600` (5 mins server cache)

### Server Actions (Mutations)

```typescript
createMasterDataAction(data); // Auto-set rootId based on parentId
updateMasterDataAction(data); // Cho phÃ©p sá»­a value, description, isActive
toggleMasterDataActiveAction(id, isActive); // Toggle active/inactive (soft delete)
deleteMasterDataAction(id); // Hard delete vá»›i children check
```

### ğŸ—ï¸ Architecture

```
UI (Tree View) â†’ Hooks â†’ API Client â†’ Routes â†’ Services â†’ Repository â†’ DB
```

### âœ… Validation

- **Client**: React Hook Form + Zod
- **Server**: Zod schemas (rootId logic, hierarchy validation)
- **DB**: Unique constraint on key (globally)

---

## ğŸ“ˆ Performance

### âš¡ Caching

**Client-Side (React Query Hooks):**

```typescript
useMasterDataList(); // staleTime: Infinity, gcTime: 24h
useMasterDataRoots(); // staleTime: Infinity, gcTime: 24h
useMasterDataById(); // staleTime: Infinity, gcTime: 24h

// Táº¥t cáº£ Ä‘á»u cÃ³:
refetchOnWindowFocus: false; // Chuyá»ƒn tab khÃ´ng fetch láº¡i
refetchOnMount: false; // Component mount láº¡i khÃ´ng fetch láº¡i
refetchOnReconnect: false; // Máº¥t máº¡ng cÃ³ láº¡i khÃ´ng fetch láº¡i
```

**Behavior:**

- Chá»‰ fetch láº¡i khi user **F5** hoáº·c **vÃ o app láº¡i**
- Admin tháº¥y thay Ä‘á»•i **ngay láº­p tá»©c** sau mutations (React Query tá»± Ä‘á»™ng invalidate)
- User khÃ¡c tháº¥y sau khi F5 (tradeoff cháº¥p nháº­n Ä‘Æ°á»£c)

**Server-Side Cache:**

- API routes cache vá»›i `s-maxage=300` (5 minutes) vÃ  `stale-while-revalidate=600`

### ğŸ¯ Optimization

- Index: `key` unique, `[rootId, isActive]`, `[parentId]`
- No pagination (small dataset)
- Tree view: Load all data once, expand/collapse client-side

---

## ğŸ”— Usage in Other Features

### **How to Reference Master Data**

CÃ¡c feature khÃ¡c (Supplier, Material, GoodsReceipt...) sáº½ **store `key` (String)**, KHÃ”NG dÃ¹ng FK:

```prisma
model Supplier {
  supplierGroupKey String  // Store 'ncc-chinh', NOT UUID
  // NO @relation
}
```

### **Frontend Display Pattern**

```typescript
// Component display logic
const masterDataMap = useMemo(() => {
  return new Map(masterData.map((item) => [item.key, item.value]));
}, [masterData]);

// Display: Try to show value, fallback to key
const displayValue = masterDataMap.get(supplierGroupKey) ?? supplierGroupKey;
// Result: "NhÃ  Cung Cáº¥p ChÃ­nh" or "ncc-chinh" (if deleted)
```

### **Form Select Pattern**

```tsx
<Select>
  {masterDataItems
    .filter((item) => item.isActive) // Only active items
    .map((item) => (
      <Option key={item.key} value={item.key}>
        {item.value}
      </Option>
    ))}
</Select>
```

### **Why Store `key` instead of `id`?**

| Aspect                 | Store `key` (String)          | Store `id` (UUID FK)     |
| ---------------------- | ----------------------------- | ------------------------ |
| Semantic               | âœ… Readable: `'ncc-chinh'`    | âŒ UUID: `'abc-123-...'` |
| Portability            | âœ… Copy data between envs     | âŒ UUIDs differ          |
| Referential Integrity  | âŒ Manual validation          | âœ… DB enforced           |
| Master Data Deletable  | âœ… Yes (soft delete)          | âŒ FK constraint blocks  |
| Display when deleted   | âœ… Graceful: Show key         | âŒ Shows nothing/error   |
| Immutability Guarantee | âœ… Key immutable after create | âœ… ID never changes      |

**Trade-off Decision**: Flexibility & User Experience > Strict DB constraints

---

## âœ… Acceptance Criteria

- [x] Admin táº¡o root categories Ä‘á»™ng (khÃ´ng hardcode types)
- [x] Admin táº¡o children trong root category
- [x] Tree view hiá»ƒn thá»‹ hierarchy trá»±c quan
- [x] Toggle "Hiá»ƒn thá»‹ Ä‘Ã£ táº¯t" hoáº¡t Ä‘á»™ng
- [x] TreeSelect cho parent (filtered by rootId)
- [x] NgÄƒn circular reference
- [x] Key immutable, value mutable
- [x] Soft delete (isActive = false)
- [x] React Hook Form + Zod
- [x] Component separation (PageView + Tree + Modal)
- [x] allowHierarchy flag cho root items

---

**Priority**: ğŸ”´ Critical  
**Estimated Effort**: 5-6 ngÃ y (thÃªm Tree UI)  
**Actual Effort**: âœ… Completed  
**Pattern**: Custom Tree View + Modal  
**Status**: âœ… **IMPLEMENTED & VERIFIED** (100% match requirements)
