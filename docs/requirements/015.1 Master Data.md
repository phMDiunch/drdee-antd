# ğŸ”§ Requirements: Master Data

> **âœ… STATUS: IMPLEMENTED** - Simplified structure with hard delete only  
> **ğŸ“„ Implementation**: `src/features/master-data/` (Shared toÃ n app)  
> **ğŸ”— Parent**: `015 Inventory - Overview.md`

## ğŸ¯ Má»¥c TiÃªu

Quáº£n lÃ½ dá»¯ liá»‡u chá»§ Ä‘Æ¡n giáº£n vÃ  linh hoáº¡t cho toÃ n app vá»›i kháº£ nÄƒng **admin tá»± Ä‘á»‹nh nghÄ©a categories** mÃ  khÃ´ng cáº§n dev can thiá»‡p. Cáº¥u trÃºc 2 cáº¥p: **Category â†’ Items**.

**Concept:**

- **Category**: NhÃ³m phÃ¢n loáº¡i (VD: "bao-hanh-chinh-hang", "don-vi-tinh")
- **Items**: CÃ¡c giÃ¡ trá»‹ thuá»™c category (VD: "1 nÄƒm", "2 nÄƒm", "CÃ¡i", "RÄƒng")
- **Simple**: KhÃ´ng cÃ³ hierarchy phá»©c táº¡p, chá»‰ category + items
- **Flexible**: KhÃ´ng hardcode types â†’ Admin hoÃ n toÃ n kiá»ƒm soÃ¡t

**VÃ­ Dá»¥ Cáº¥u TrÃºc:**

```
ğŸ“ bao-hanh-chinh-hang
  â”œâ”€ 1 nÄƒm (1-nam)
  â””â”€ 2 nÄƒm (2-nam)
ğŸ“ bao-hanh-uy-tin
  â”œâ”€ 10 nÄƒm (10-nam)
  â””â”€ 15 nÄƒm (15-nam)
ğŸ“ don-vi-tinh
  â”œâ”€ CÃ¡i (cai)
  â”œâ”€ RÄƒng (rang)
  â””â”€ HÃ m (ham)
```

## ğŸ“Š Database Model

Prisma Model MasterData: `src/prisma/schema.prisma`

```prisma
model MasterData {
  id        String   @id @default(uuid())
  category  String   // NhÃ³m phÃ¢n loáº¡i (slug: 'bao-hanh-chinh-hang')
  key       String   // MÃ£ Ä‘á»‹nh danh (slug: '1-nam') - IMMUTABLE
  value     String   // TÃªn hiá»ƒn thá»‹ ('1 nÄƒm') - MUTABLE

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  @@unique([category, key])  // Unique constraint: key chá»‰ unique trong category
  @@index([category])
  @@map("master_data")
}
```

**Key Design:**

- âœ… **category**: String (slug format: lowercase, no dáº¥u) - NhÃ³m phÃ¢n loáº¡i
- âœ… **key**: String (slug format: lowercase, no dáº¥u) - MÃ£ Ä‘á»‹nh danh items
- âœ… **value**: String - TÃªn hiá»ƒn thá»‹ (cÃ³ thá»ƒ sá»­a)
- âœ… **Unique constraint**: `[category, key]` - Key unique trong category
- âŒ **Removed**: `description`, `isActive` (simplified - hard delete only)

---

## ğŸ¯ Core Requirements

### 1. â• Táº¡o Dá»¯ Liá»‡u Chá»§ (Create)

#### ğŸ” Permissions

- Chá»‰ **Admin** má»›i Ä‘Æ°á»£c táº¡o/sá»­a/xÃ³a
- Táº¥t cáº£ user xem Ä‘Æ°á»£c (Ä‘á»ƒ dÃ¹ng trong dropdowns)

#### ğŸ¨ UI/UX

- **Grouped List View** - Hiá»ƒn thá»‹ theo category (collapse/expand)
- **Modal form** responsive (85% width mobile, max 800px desktop)
- **React Hook Form + Zod** (KHÃ”NG dÃ¹ng Ant Design Form)
- **Real-time validation**

#### ğŸ“ Form Layout

**Form duy nháº¥t (táº¡o/sá»­a):**

```
HÃ ng 1: [Category (100%)                    ]  â† AutoComplete with blur â†’ slug
HÃ ng 2: [Value (50%)        ] [Key (50%)    ]  â† Value auto-gen key
```

**Note**:

- **Category**: AutoComplete (suggest existing) hoáº·c nháº­p má»›i â†’ **blur tá»± Ä‘á»™ng slugify** (VD: "Báº£o HÃ nh" â†’ "bao-hanh")
  - Mode Create + New Category: Editable, blur â†’ slugify
  - Mode Create + Add to Existing: Pre-filled, disabled
  - Mode Edit: Disabled (khÃ´ng cho Ä‘á»•i category)
- **Key**: Auto-generate slug tá»« value (cÃ³ thá»ƒ sá»­a trÆ°á»›c save), **KHÃ”NG Sá»¬A sau khi táº¡o**
  - Mode Create: Editable (auto-filled from value)
  - Mode Edit: Disabled
- **Value**: TÃªn hiá»ƒn thá»‹ (cÃ³ thá»ƒ sá»­a sau)
  - Mode Create: Editable
  - Mode Edit: Editable

#### âœ… Validation Rules

- `category`: Required, 2-50 kÃ½ tá»±, regex `/^[a-z0-9-]+$/` - **SLUGIFY on blur** (frontend + backend validation)
- `key`: Required, 2-50 kÃ½ tá»±, regex `/^[a-z0-9-]+$/` - **IMMUTABLE after create**, **UNIQUE trong category**
- `value`: Required, 2-100 kÃ½ tá»± - **MUTABLE**

#### ğŸ”„ Business Rules

- **Unique constraint**: `[category, key]` - Key chá»‰ unique trong category, cÃ³ thá»ƒ trÃ¹ng giá»¯a cÃ¡c category khÃ¡c
- **Category input**:
  - Náº¿u nháº­p category má»›i â†’ Slugify on blur â†’ Táº¡o category má»›i
  - Náº¿u chá»n category existing (khi click "Add Item" trong category) â†’ Pre-fill & disable category field
- **Auto-generate slug**:
  - **Category**: User nháº­p tá»± do â†’ Blur â†’ Slugify (VD: "Báº£o HÃ nh ChÃ­nh HÃ£ng" â†’ "bao-hanh-chinh-hang")
  - **Key**: Real-time generate tá»« value (VD: "1 nÄƒm" â†’ "1-nam")
  - DÃ¹ng `slugify` library vá»›i config: `{ lower: true, locale: 'vi', strict: true }`

---

### 2. ğŸ“‹ Danh SÃ¡ch (List)

#### ğŸ“Š Display Features

- **Ant Design Collapse** - Hiá»ƒn thá»‹ grouped by category
- **Each Panel**: 1 category vá»›i table items bÃªn trong
- **No pagination** (< 200 items total)
- **No "Hiá»ƒn thá»‹ Ä‘Ã£ táº¯t"** (hard delete only - no soft delete)
- **Action buttons**: Add (per category), Edit, Delete (Admin only)
- **Header Layout**: Title/Subtitle left, "ThÃªm Category Má»›i" button right (matches Clinic pattern)

#### ğŸ¨ Display Structure

```typescript
<PageView title="Danh Má»¥c Há»‡ Thá»‘ng">
  {/* Header: Title left, Button right */}
  <div style={{ display: "flex", justifyContent: "space-between" }}>
    <Title>Danh Má»¥c Há»‡ Thá»‘ng</Title>
    <Button onClick={openModalForNewCategory}>+ ThÃªm Category Má»›i</Button>
  </div>

  <Collapse>
    <Panel header="bao-hanh-chinh-hang (2 items)" key="bao-hanh-chinh-hang">
      <Table>
        <Row>1 nÄƒm | 1-nam | [Edit | Delete]</Row>
        <Row>2 nÄƒm | 2-nam | [Edit | Delete]</Row>
      </Table>
      <Button>+ ThÃªm Item</Button>
    </Panel>

    <Panel header="don-vi-tinh (3 items)" key="don-vi-tinh">
      <Table>
        <Row>CÃ¡i | cai | [Edit | Delete]</Row>
        <Row>RÄƒng | rang | [Edit | Delete]</Row>
        <Row>HÃ m | ham | [Edit | Delete]</Row>
      </Table>
      <Button>+ ThÃªm Item</Button>
    </Panel>
  </Collapse>
</PageView>
```

#### ğŸ“‹ Table Columns trong má»—i Panel

| Column  | Width | Description                          |
| ------- | ----- | ------------------------------------ |
| Value   | 30%   | TÃªn hiá»ƒn thá»‹ (bold)                  |
| Key     | 20%   | MÃ£ Ä‘á»‹nh danh (code style, secondary) |
| Actions | 15%   | Edit \| Delete (Admin only)          |

**Removed columns:** Description, Status (no soft delete)

#### ğŸ”§ Components

- `MasterDataPageView.tsx` - Main page wrapper vá»›i header layout
- `MasterDataList.tsx` - Grouped list with Collapse
- `MasterDataFormModal.tsx` - Create/Edit modal form

#### ğŸ”˜ Actions

- **Panel Header**: Button "+" Ä‘á»ƒ thÃªm item má»›i vÃ o category Ä‘Ã³ (auto-fill & disable category)
- **Page Top Header**: Button "ThÃªm Category Má»›i" Ä‘á»ƒ táº¡o category + item Ä‘áº§u tiÃªn

---

### 3. âœï¸ Chá»‰nh Sá»­a (Edit)

#### ğŸ¨ UI/UX

- **Same modal** nhÆ° Create
- **Pre-populated data**
- **Category field**: Disabled (khÃ´ng cho Ä‘á»•i category)
- **Key field**: Disabled (khÃ´ng cho sá»­a)

#### ğŸ”„ Behavior

- Cho phÃ©p sá»­a: `value` only
- KHÃ”NG cho sá»­a: `category`, `key`
- **No unique validation needed** (category + key khÃ´ng Ä‘á»•i)

---

### 4. âŒ Delete Operation (Hard Delete Only)

**UI:**

- Button: Icon `<DeleteOutlined />`, danger style, tooltip "XÃ³a vÄ©nh viá»…n"
- Popconfirm: "Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a vÄ©nh viá»…n? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c."
- okButtonProps: `{ danger: true }`

**Logic:**

```typescript
// Hard delete: permanent deletion from database
await masterDataRepo.hardDelete(id);
```

**Business Rules:**

- **Hard delete only** (xÃ³a vÄ©nh viá»…n tá»« database) - Irreversible
- **KHÃ”NG cÃ³ soft delete** (removed `isActive` field)
- **KHÃ”NG check usage** trong cÃ¡c table khÃ¡c (Supplier, Material...)
  - LÃ½ do: CÃ¡c table khÃ¡c store `[category, key]` (String), KHÃ”NG dÃ¹ng FK
  - Frontend handle: Hiá»ƒn thá»‹ `value` náº¿u tÃ¬m tháº¥y, else hiá»ƒn thá»‹ `key`
  - Trade-off: Flexibility > Strict referential integrity

**Use Cases:**

- XÃ³a khi nháº­p nháº§m hoáº·c item hoÃ n toÃ n khÃ´ng cáº§n
- KhÃ´ng cÃ³ soft delete - simplify logic

---

## ğŸ› ï¸ Technical Implementation

### ğŸ“¡ API Endpoints

```
GET  /api/v1/master-data  # List ALL master data (no query params, no filtering)
```

**Cache Headers**: `Cache-Control: public, s-maxage=300, stale-while-revalidate=600` (5 mins)

**Architecture Decision:**

- Load ALL data once â†’ Client-side filtering & grouping
- Perfect for small dataset (< 200 items)
- Categories derived from data using `useMemo`

### Server Actions (Mutations)

```typescript
createMasterDataAction(data); // Create new item (category + key + value)
updateMasterDataAction(data); // Update value only (category + key immutable)
deleteMasterDataAction(id); // Hard delete (permanent)
```

### ğŸ—ï¸ Architecture

```
UI (Grouped List) â†’ Hooks â†’ API Client â†’ Server Actions â†’ Services â†’ Repository â†’ DB
                        â†“
                  React Query Cache (staleTime: Infinity)
                        â†“
                  Client-side Filter/Group
```

**Key Pattern:**

1. **Single API call**: Load all data once
2. **Infinite cache**: `staleTime: Infinity` - never refetch until invalidation
3. **Client-side operations**: Filter by category, derive categories list
4. **Optimistic updates**: React Query handles cache invalidation after mutations

### âœ… Validation

- **Client**: React Hook Form + Zod (real-time validation)
- **Server**: Zod schemas + unique `[category, key]` check + slugify
- **DB**: Unique constraint on `[category, key]`

**Slugify Logic:**

```typescript
// Frontend & Backend use same library
import slugify from "slugify";

function generateSlug(text: string) {
  return slugify(text, {
    lower: true,
    locale: "vi",
    strict: true,
  });
}
```

---

## ğŸ“ˆ Performance & Caching Strategy

### âš¡ Client-Side Caching (React Query)

**Hooks Configuration:**

```typescript
useMasterData(); // Load ALL data
useMasterDataCategories(); // Derive categories from all data (useMemo)

// Cache config (all hooks):
staleTime: Infinity; // Data NEVER stale until manual invalidation
gcTime: 1000 * 60 * 60 * 24; // Keep in memory 24h
```

**Behavior:**

- **Initial load**: Fetch once on app start
- **Subsequent views**: Use cached data (instant)
- **After mutation**: Automatic invalidation & refetch
- **F5/Reload**: Fresh fetch from server

**Why `staleTime: Infinity`?**

- Master data changes infrequently
- Admin sees changes immediately (query invalidation after mutation)
- Other users see changes after F5 (acceptable trade-off)
- Reduces server load significantly

### ğŸ¯ Client-Side Operations

**All done in browser (no API calls):**

```typescript
// 1. Derive categories from master data list
const categories = useMemo(() => {
  const uniqueCategories = new Set(allItems.map((item) => item.category));
  return Array.from(uniqueCategories).sort();
}, [allItems]);

// 2. Group by category
const groupedData = useMemo(() => {
  const grouped = new Map<string, MasterDataResponse[]>();
  allItems.forEach((item) => {
    if (!grouped.has(item.category)) {
      grouped.set(item.category, []);
    }
    grouped.get(item.category)!.push(item);
  });
  return grouped;
}, [allItems]);

// 3. Filter for dropdowns
const warrantyOptions = allItems.filter(
  (item) => item.category === "bao-hanh-chinh-hang"
);
```

### ğŸš€ Optimization Benefits

- **1 API call** instead of 2 (list + categories)
- **Zero network latency** for category list (instant)
- **Instant filtering** (no loading states)
- **Perfect for small datasets** (< 200 items = ~10KB)

---

## ğŸ”— Usage in Other Features

### **How to Reference Master Data**

CÃ¡c feature khÃ¡c (Supplier, Material, GoodsReceipt...) sáº½ **store `[category, key]` (Strings)**, KHÃ”NG dÃ¹ng FK:

```prisma
model Material {
  warrantyCategory String  // Store 'bao-hanh-chinh-hang'
  warrantyKey      String  // Store '1-nam'
  unitCategory     String  // Store 'don-vi-tinh'
  unitKey          String  // Store 'cai'
  // NO @relation
}
```

### **Frontend Display Pattern**

```typescript
// Component display logic
const masterDataMap = useMemo(() => {
  const map = new Map<string, string>(); // key: 'category:key', value: 'display value'
  masterData.forEach((item) => {
    map.set(`${item.category}:${item.key}`, item.value);
  });
  return map;
}, [masterData]);

// Display: Try to show value, fallback to key
const displayValue =
  masterDataMap.get(`${warrantyCategory}:${warrantyKey}`) ?? warrantyKey;
// Result: "1 nÄƒm" or "1-nam" (if deleted)
```

### **Form Select Pattern**

```tsx
<Select placeholder="Chá»n báº£o hÃ nh">
  {masterDataItems
    .filter((item) => item.category === "bao-hanh-chinh-hang" && item.isActive)
    .map((item) => (
      <Option key={item.key} value={item.key}>
        {item.value}
      </Option>
    ))}
</Select>
```

### **Why Store `[category, key]` instead of `id`?**

| Aspect                 | Store `[category, key]`       | Store `id` (UUID FK)     |
| ---------------------- | ----------------------------- | ------------------------ |
| Semantic               | âœ… Readable: `'1-nam'`        | âŒ UUID: `'abc-123-...'` |
| Portability            | âœ… Copy data between envs     | âŒ UUIDs differ          |
| Referential Integrity  | âŒ Manual validation          | âœ… DB enforced           |
| Master Data Deletable  | âœ… Yes (soft delete)          | âŒ FK constraint blocks  |
| Display when deleted   | âœ… Graceful: Show key         | âŒ Shows nothing/error   |
| Immutability Guarantee | âœ… Key immutable after create | âœ… ID never changes      |
| Category Context       | âœ… Self-documenting           | âŒ Requires JOIN         |

**Trade-off Decision**: Flexibility & User Experience > Strict DB constraints

---

## âœ… Acceptance Criteria

- [x] Admin táº¡o categories Ä‘á»™ng (khÃ´ng hardcode types)
- [x] Admin táº¡o items trong category
- [x] Grouped list view (Collapse) hiá»ƒn thá»‹ theo category
- [x] Category input vá»›i AutoComplete + blur â†’ slugify
- [x] Key auto-generate from value, immutable after create
- [x] Value mutable (cÃ³ thá»ƒ edit)
- [x] Unique constraint: `[category, key]` enforced
- [x] Hard delete only (no soft delete / isActive)
- [x] React Hook Form + Zod validation
- [x] Component separation (PageView + List + Modal)
- [x] Single API endpoint vá»›i client-side filtering
- [x] Categories derived client-side (no separate endpoint)
- [x] `staleTime: Infinity` caching strategy
- [x] Slugify library consistency (FE/BE)
- [x] Header layout matches Clinic pattern
- [x] No description field (simplified)

---

**Priority**: ğŸ”´ Critical  
**Estimated Effort**: 3-4 ngÃ y  
**Actual Effort**: ~3 ngÃ y (simplified, no soft delete)  
**Pattern**: Grouped List with Collapse + Modal + Client-side Operations  
**Status**: âœ… **IMPLEMENTED** - Production ready
