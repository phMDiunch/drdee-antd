// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// src/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===================================
//            MODELS
// ===================================

model Clinic {
  id String @id @default(uuid())

  // Th√¥ng tin c∆° b·∫£n
  clinicCode String    @unique // M√£ ph√≤ng kh√°m
  name       String    @unique // T√™n ph√≤ng kh√°m
  shortName  String?   @unique // T√™n vi·∫øt t·∫Øt
  address    String // ƒê·ªãa ch·ªâ ph√≤ng kh√°m
  phone      String? // S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá
  email      String? // Email li√™n h·ªá
  colorCode  String? // M√£ m√†u ƒë·ªÉ ph√¢n bi·ªát ph√≤ng kh√°m tr√™n UI
  archivedAt DateTime? @db.Timestamptz // Ng√†y ph√≤ng kh√°m ng·ª´ng ho·∫°t ƒë·ªông

  // Th√¥ng tin t√†i kho·∫£n ng√¢n h√†ng
  companyBankName         String? // T√™n ng√¢n h√†ng c√¥ng ty
  companyBankAccountNo    String? // S·ªë t√†i kho·∫£n c√¥ng ty
  companyBankAccountName  String? // T√™n ch·ªß t√†i kho·∫£n c√¥ng ty
  personalBankName        String? // T√™n ng√¢n h√†ng c√° nh√¢n
  personalBankAccountNo   String? // S·ªë t√†i kho·∫£n c√° nh√¢n
  personalBankAccountName String? // T√™n ch·ªß t√†i kho·∫£n c√° nh√¢n

  // Metadata
  createdAt DateTime @default(now()) @db.Timestamptz // Ng√†y t·∫°o
  updatedAt DateTime @updatedAt @db.Timestamptz // Ng√†y c·∫≠p nh·∫≠t cu·ªëi

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  employees Employee[]

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  customers Customer[]

  // Li√™n k·∫øt ƒë·∫øn l·ªãch h·∫πn
  appointments Appointment[]

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• t∆∞ v·∫•n
  consultedServices ConsultedService[]

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω ƒëi·ªÅu tr·ªã
  treatmentLogs TreatmentLog[]

  // Li√™n k·∫øt ƒë·∫øn phi·∫øu thu
  paymentVouchers PaymentVoucher[]

  // Li√™n k·∫øt ƒë·∫øn chƒÉm s√≥c sau ƒëi·ªÅu tr·ªã
  treatmentCares TreatmentCare[]

  // Li√™n k·∫øt ƒë·∫øn ƒë∆°n h√†ng labo
  laboOrders LaboOrder[]

  // üöÄ Performance Indexes
  @@index([archivedAt, createdAt(sort: Desc)]) // Optimize: List query with archive filter + sort
}

model Employee {
  id String @id @default(uuid())

  // Th√¥ng tin t√†i kho·∫£n
  uid   String? @unique // User ID t·ª´ Supabase Auth ƒë·ªÉ li√™n k·∫øt
  email String? @unique // Email ƒëƒÉng nh·∫≠p
  role  String // Vai tr√≤ trong h·ªá th·ªëng: "admin", "employee"

  // Th√¥ng tin c∆° b·∫£n
  fullName      String //
  dob           DateTime? @db.Date // Ng√†y sinh
  gender        String? // Gi·ªõi t√≠nh
  avatarUrl     String? //
  favoriteColor String? // M√†u y√™u th√≠ch ƒë·ªÉ c√° nh√¢n h√≥a giao di·ªán

  // Th√¥ng tin li√™n h·ªá
  phone          String? @unique
  currentAddress String? // ƒê·ªãa ch·ªâ hi·ªán t·∫°i
  hometown       String? // Qu√™ qu√°n

  // Th√¥ng tin ph√°p l√Ω & BH
  nationalId           String?   @unique // S·ªë CCCD
  nationalIdIssueDate  DateTime? @db.Date // Ng√†y c·∫•p
  nationalIdIssuePlace String? // N∆°i c·∫•p
  taxId                String?   @unique // M√£ s·ªë thu·∫ø
  insuranceNumber      String?   @unique // S·ªë s·ªï BHXH

  // Th√¥ng tin ng√¢n h√†ng
  bankAccountNumber String? // S·ªë t√†i kho·∫£n ng√¢n h√†ng
  bankName          String? // T√™n ng√¢n h√†ng

  // Th√¥ng tin c√¥ng vi·ªác
  employeeCode   String? @unique // M√£ nh√¢n vi√™n
  employeeStatus String? // "ƒêang l√†m vi·ªác", "Ngh·ªâ vi·ªác"
  clinicId       String? // ID c·ªßa ph√≤ng kh√°m l√†m vi·ªác
  department     String? // Ph√≤ng ban
  team           String? // B·ªô ph·∫≠n
  jobTitle       String? // Ch·ª©c danh
  positionTitle  String? // Ch·ª©c v·ª•

  // Metadata
  createdById String? // ID c·ªßa ng∆∞·ªùi t·∫°o
  updatedById String? // ID c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  createdBy        Employee?  @relation("CreatedEmployees", fields: [createdById], references: [id])
  updatedBy        Employee?  @relation("UpdatedEmployees", fields: [updatedById], references: [id])
  createdEmployees Employee[] @relation("CreatedEmployees")
  updatedEmployees Employee[] @relation("UpdatedEmployees")

  // Li√™n k·∫øt ƒë·∫øn ph√≤ng kh√°m
  clinic Clinic? @relation(fields: [clinicId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  createdCustomers Customer[] @relation("CreatedCustomers")
  updatedCustomers Customer[] @relation("UpdatedCustomers")

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• nha khoa
  createdDentalServices DentalService[] @relation("CreatedDentalServices")
  updatedDentalServices DentalService[] @relation("UpdatedDentalServices")

  // Li√™n k·∫øt ƒë·∫øn l·ªãch h·∫πn
  primaryDentistAppointments   Appointment[] @relation("PrimaryDentistAppointments")
  secondaryDentistAppointments Appointment[] @relation("SecondaryDentistAppointments")
  createdAppointments          Appointment[] @relation("CreatedAppointments")
  updatedAppointments          Appointment[] @relation("UpdatedAppointments")

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• t∆∞ v·∫•n
  consultingDoctorServices ConsultedService[] @relation("ConsultingDoctorServices")
  saleOnlineServices       ConsultedService[] @relation("SaleOnlineServices")
  consultingSaleServices   ConsultedService[] @relation("ConsultingSaleServices")
  treatingDoctorServices   ConsultedService[] @relation("TreatingDoctorServices")
  createdConsultedServices ConsultedService[] @relation("CreatedConsultedServices")
  updatedConsultedServices ConsultedService[] @relation("UpdatedConsultedServices")

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω ƒëi·ªÅu tr·ªã
  dentistLogs    TreatmentLog[] @relation("DentistLogs")
  assistant1Logs TreatmentLog[] @relation("Assistant1Logs")
  assistant2Logs TreatmentLog[] @relation("Assistant2Logs")
  createdLogs    TreatmentLog[] @relation("CreatedLogs")
  updatedLogs    TreatmentLog[] @relation("UpdatedLogs")

  // Li√™n k·∫øt ƒë·∫øn phi·∫øu thu
  cashierVouchers PaymentVoucher[] @relation("CashierVouchers")
  createdVouchers PaymentVoucher[] @relation("CreatedVouchers")
  updatedVouchers PaymentVoucher[] @relation("UpdatedVouchers")

  // Li√™n k·∫øt ƒë·∫øn chi ti·∫øt phi·∫øu thu
  createdVoucherDetails PaymentVoucherDetail[] @relation("CreatedVoucherDetails")

  // Li√™n k·∫øt ƒë·∫øn chƒÉm s√≥c sau ƒëi·ªÅu tr·ªã (aftercare)
  careStaffTreatmentCares TreatmentCare[]
  createdTreatmentCares   TreatmentCare[] @relation("CreatedTreatmentCares")
  updatedTreatmentCares   TreatmentCare[] @relation("UpdatedTreatmentCares")

  // Li√™n k·∫øt ƒë·∫øn nh√† cung c·∫•p
  createdSuppliers Supplier[] @relation("CreatedSuppliers")
  updatedSuppliers Supplier[] @relation("UpdatedSuppliers")

  // Li√™n k·∫øt ƒë·∫øn v·∫≠t t∆∞
  createdMaterials Material[] @relation("CreatedMaterials")
  updatedMaterials Material[] @relation("UpdatedMaterials")

  // Li√™n k·∫øt ƒë·∫øn danh m·ª•c labo
  createdLaboItems LaboItem[] @relation("CreatedLaboItems")
  updatedLaboItems LaboItem[] @relation("UpdatedLaboItems")

  // Li√™n k·∫øt ƒë·∫øn b·∫£ng gi√° labo
  createdLaboServices LaboService[] @relation("CreatedLaboServices")
  updatedLaboServices LaboService[] @relation("UpdatedLaboServices")

  // Li√™n k·∫øt ƒë·∫øn ƒë∆°n h√†ng labo
  doctorLaboOrders   LaboOrder[] @relation("DoctorLaboOrders")
  sentLaboOrders     LaboOrder[] @relation("SentLaboOrders")
  receivedLaboOrders LaboOrder[] @relation("ReceivedLaboOrders")
  createdLaboOrders  LaboOrder[] @relation("CreatedLaboOrders")
  updatedLaboOrders  LaboOrder[] @relation("UpdatedLaboOrders")

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω li√™n h·ªá sale
  salesActivities SalesActivityLog[] @relation("SalesActivities")

  // üöÄ Performance Indexes
  @@index([clinicId, employeeStatus]) // Optimize: Get working employees by clinic
  @@index([employeeStatus, createdAt(sort: Desc)]) // Optimize: List employees (default mode)
  @@index([employeeStatus, fullName(sort: Asc)]) // Optimize: List working employees sorted by name
  @@index([email]) // Optimize: Login by email
  @@index([fullName]) // Optimize: Text search by name (partial match support)
}

model DentalService {
  id String @id @default(uuid())

  // Th√¥ng tin c∆° b·∫£n
  name        String  @unique // T√™n d·ªãch v·ª•, v√≠ d·ª•: "C·∫°o v√¥i rƒÉng"
  description String? // M√¥ t·∫£ chi ti·∫øt

  // Th√¥ng tin ph√¢n lo·∫°i
  serviceGroup String? // Nh√≥m d·ªãch v·ª•, v√≠ d·ª•: ni·ªÅng rƒÉng invisalign, ni·ªÅng rƒÉng m·∫Øc c√†i
  department   String? // B·ªô m√¥n, v√≠ d·ª•: ni·ªÅng rƒÉng invisalign moderate, ni·ªÅng rƒÉng invisalign comprehensive
  tags         String[] @default([]) // C√°c th·∫ª (tags) ƒë·ªÉ ph√¢n lo·∫°i d·ªãch v·ª• do ph√≤ng kh√°m t·ª± ƒë·ªãnh nghƒ©a

  // Th√¥ng tin gi√° & ƒë∆°n v·ªã
  unit     String // ƒê∆°n v·ªã t√≠nh: "RƒÉng", "H√†m", "L·∫ßn"
  price    Int // Gi√° ni√™m y·∫øt, l∆∞u d·∫°ng Int ƒë·ªÉ tr√°nh sai s·ªë
  minPrice Int? // Gi√° t·ªëi thi·ªÉu (n·∫øu c√≥)

  // Th√¥ng tin chi ti·∫øt & b·∫£o h√†nh
  officialWarranty     String? // B·∫£o h√†nh ch√≠nh h√£ng
  clinicWarranty       String? // B·∫£o h√†nh uy t√≠n t·ª´ ph√≤ng kh√°m
  origin               String? // Xu·∫•t x·ª©
  avgTreatmentMinutes  Int? // S·ªë ph√∫t ƒëi·ªÅu tr·ªã trung b√¨nh
  avgTreatmentSessions Int? // S·ªë bu·ªïi ƒëi·ªÅu tr·ªã trung b√¨nh

  // Follow-up & Payment Configuration
  requiresFollowUp   Boolean @default(false) // D·ªãch v·ª• c√≥ c·∫ßn sale follow-up kh√¥ng
  paymentAccountType String  @default("PERSONAL") // "COMPANY" | "PERSONAL" - Thu b·∫±ng TK c√¥ng ty hay c√° nh√¢n

  // Metadata
  archivedAt DateTime? @db.Timestamptz // Ng√†y d·ªãch v·ª• ng·ª´ng ho·∫°t ƒë·ªông
  createdAt  DateTime  @default(now()) @db.Timestamptz // Ng√†y t·∫°o
  updatedAt  DateTime  @updatedAt @db.Timestamptz // Ng√†y c·∫≠p nh·∫≠t cu·ªëi

  createdById String // ID c·ªßa ng∆∞·ªùi t·∫°o
  updatedById String // ID c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  createdBy Employee @relation("CreatedDentalServices", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedDentalServices", fields: [updatedById], references: [id])

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• t∆∞ v·∫•n
  consultedServices ConsultedService[]

  // üöÄ Performance Indexes
  @@index([archivedAt, name(sort: Asc)]) // Optimize: List query with archive filter + sort by name
  @@index([serviceGroup, department, archivedAt]) // Optimize: Filter by classification fields
  @@index([tags]) // Optimize: Search by tags (GIN index for array)
}

model Customer {
  id String @id @default(uuid())

  // ‚≠ê NEW: Customer Type & First Visit
  type           String // "LEAD" | "CUSTOMER" (controlled by app)
  firstVisitDate DateTime? @db.Timestamptz // When customer first visited clinic
  convertedAt    DateTime? @db.Timestamptz // When LEAD converted to CUSTOMER

  // Th√¥ng tin c∆° b·∫£n
  fullName String // H·ªç t√™n
  dob      DateTime? @db.Date // Ng√†y sinh
  gender   String? // Gi·ªõi t√≠nh

  // Th√¥ng tin li√™n h·ªá
  phone    String? @unique // S·ªë ƒëi·ªán tho·∫°i
  email    String? @unique
  address  String? // ƒê·ªãa ch·ªâ
  city     String? // T·ªânh/Th√†nh ph·ªë
  district String? // Qu·∫≠n/Huy·ªán

  primaryContactRole String? // Vai tr√≤ ng∆∞·ªùi li√™n h·ªá: B·ªë, M·∫π, Con, V·ª£, Ch·ªìng...
  primaryContactId   String? // ID c·ªßa ng∆∞·ªùi li√™n h·ªá ch√≠nh

  // Th√¥ng tin ph√¢n lo·∫°i
  customerCode String? @unique // M√£ kh√°ch h√†ng
  clinicId     String? // Chi nh√°nh

  occupation        String? // Ngh·ªÅ nghi·ªáp
  source            String? // Ngu·ªìn kh√°ch
  sourceNotes       String? // Ghi ch√∫ ngu·ªìn
  serviceOfInterest String? // D·ªãch v·ª• quan t√¢m (m·ªôt gi√° tr·ªã duy nh·∫•t)
  note              String? // ‚≠ê NEW: Ghi ch√∫ chung

  // Metadata  
  createdById String // ID c·ªßa ng∆∞·ªùi t·∫°o
  updatedById String // ID c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Li√™n k·∫øt ƒë·∫øn chi nh√°nh
  clinic Clinic? @relation(fields: [clinicId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  primaryContact Customer?  @relation("PrimaryContactDependents", fields: [primaryContactId], references: [id])
  dependents     Customer[] @relation("PrimaryContactDependents")

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  createdBy Employee @relation("CreatedCustomers", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedCustomers", fields: [updatedById], references: [id])

  // Li√™n k·∫øt ƒë·∫øn l·ªãch h·∫πn
  appointments Appointment[]

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• t∆∞ v·∫•n
  consultedServices ConsultedService[]

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω ƒëi·ªÅu tr·ªã
  treatmentLogs TreatmentLog[]

  // Li√™n k·∫øt ƒë·∫øn phi·∫øu thu
  paymentVouchers PaymentVoucher[]

  // Li√™n k·∫øt ƒë·∫øn chƒÉm s√≥c sau ƒëi·ªÅu tr·ªã (aftercare)
  treatmentCares TreatmentCare[]

  // Li√™n k·∫øt ƒë·∫øn ƒë∆°n h√†ng labo
  laboOrders LaboOrder[]

  // üöÄ Performance Indexes
  @@index([type, clinicId, firstVisitDate(sort: Desc)]) // Optimize: Customer daily view - filter by type, clinic, firstVisitDate
  @@index([type, createdAt(sort: Desc)]) // Optimize: Lead daily view - filter by type, createdAt
  @@index([type, convertedAt(sort: Desc)]) // Optimize: Lead daily view - converted customers
  @@index([type, clinicId, createdAt(sort: Desc)]) // Optimize: Customer/Lead list with pagination
  @@index([phone]) // Optimize: Phone lookup (duplicate check)
  @@index([customerCode]) // Optimize: CustomerCode search & last code lookup
  @@index([fullName]) // Optimize: Text search by name (partial match support)
}

model Appointment {
  id String @id @default(uuid())

  // Th√¥ng tin c∆° b·∫£n
  customerId          String // ID kh√°ch h√†ng
  appointmentDateTime DateTime @db.Timestamptz // Th·ªùi gian h·∫πn ch√≠nh x√°c (ng√†y v√† gi·ªù)
  duration            Int      @default(30) // Th·ªùi l∆∞·ª£ng cu·ªôc h·∫πn t√≠nh b·∫±ng ph√∫t, m·∫∑c ƒë·ªãnh l√† 30 ph√∫t
  notes               String? // N·ªôi dung, ghi ch√∫ cho cu·ªôc h·∫πn

  // Th√¥ng tin ph√¢n c√¥ng
  primaryDentistId   String // B√°c sƒ© ch√≠nh (b·∫Øt bu·ªôc)
  secondaryDentistId String? // B√°c sƒ© ph·ª• (kh√¥ng b·∫Øt bu·ªôc)
  clinicId           String // Chi nh√°nh di·ªÖn ra cu·ªôc h·∫πn

  // Tr·∫°ng th√°i & Check-in
  status       String // "Ch·ªù x√°c nh·∫≠n", "ƒê√£ x√°c nh·∫≠n", "ƒê√£ ƒë·∫øn", "Kh√¥ng ƒë·∫øn", "ƒê√£ h·ªßy"
  checkInTime  DateTime? @db.Timestamptz // Th·ªùi gian kh√°ch h√†ng check-in th·ª±c t·∫ø
  checkOutTime DateTime? @db.Timestamptz // Th·ªùi gian kh√°ch h√†ng check-out

  // Metadata
  createdById String
  updatedById String

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Li√™n k·∫øt ƒë·∫øn chi nh√°nh
  clinic Clinic @relation(fields: [clinicId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  customer Customer @relation(fields: [customerId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  primaryDentist   Employee  @relation("PrimaryDentistAppointments", fields: [primaryDentistId], references: [id])
  secondaryDentist Employee? @relation("SecondaryDentistAppointments", fields: [secondaryDentistId], references: [id])
  createdBy        Employee  @relation("CreatedAppointments", fields: [createdById], references: [id])
  updatedBy        Employee  @relation("UpdatedAppointments", fields: [updatedById], references: [id])

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• t∆∞ v·∫•n
  consultedServices ConsultedService[]

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω ƒëi·ªÅu tr·ªã
  treatmentLogs TreatmentLog[]

  // üöÄ Performance Indexes
  @@index([clinicId, appointmentDateTime(sort: Asc)]) // Optimize: Daily view - appointments by clinic & date, sorted
  @@index([customerId, appointmentDateTime(sort: Desc)]) // Optimize: Customer detail - all appointments, newest first
  @@index([primaryDentistId, appointmentDateTime]) // Optimize: Dentist schedule & availability check
  @@index([secondaryDentistId, appointmentDateTime]) // Optimize: Secondary dentist schedule & conflicts
  @@index([status, appointmentDateTime]) // Optimize: Filter by status (checked-in, confirmed, etc.)
  @@index([appointmentDateTime, clinicId]) // Optimize: Global appointment search by date range
}

model ConsultedService {
  id String @id @default(uuid())

  // Li√™n k·∫øt D·ªØ li·ªáu
  customerId      String // Kh√°ch h√†ng
  appointmentId   String? // L·ªãch h·∫πn t∆∞ v·∫•n (nullable - null khi t∆∞ v·∫•n online)
  dentalServiceId String // D·ªãch v·ª• t∆∞ v·∫•n
  clinicId        String? // Chi nh√°nh di·ªÖn ra t∆∞ v·∫•n (nullable - null khi LEAD t∆∞ v·∫•n online)

  // D·ªØ li·ªáu Sao ch√©p (Denormalized)
  // Gi·ªØ l·ªãch s·ª≠ gi√° v√† t√™n t·∫°i th·ªùi ƒëi·ªÉm t∆∞ v·∫•n
  consultedServiceName String // Sao ch√©p t√™n d·ªãch v·ª• t·∫°i th·ªùi ƒëi·ªÉm t∆∞ v·∫•n
  consultedServiceUnit String // Sao ch√©p ƒë∆°n v·ªã t√≠nh
  price                Int // Gi√° ni√™m y·∫øt g·ªëc

  // Th√¥ng tin ƒêi·ªÅu tr·ªã Chi ti·∫øt
  toothPositions String[] // M·∫£ng v·ªã tr√≠ rƒÉng, v√≠ d·ª•: ["R16", "R26"]
  specificStatus String? // Ghi ch√∫ c·ªßa b√°c sƒ© v·ªÅ t√¨nh tr·∫°ng

  // Th√¥ng tin ph√¢n lo·∫°i
  source     String? // Ngu·ªìn kh√°ch
  sourceNote String? // Ghi ch√∫ ngu·ªìn
  stage      String? // Marketing funnel stage (for future workflow automation)

  // Th√¥ng tin T√†i ch√≠nh
  quantity          Int @default(1) // S·ªë l∆∞·ª£ng
  preferentialPrice Int // Gi√° ∆∞u ƒë√£i cho 1 ƒë∆°n v·ªã
  finalPrice        Int // Th√†nh ti·ªÅn = preferentialPrice * quantity
  amountPaid        Int @default(0) // S·ªë ti·ªÅn ƒë√£ tr·∫£ cho d·ªãch v·ª• n√†y
  debt              Int // C√¥ng n·ª£ c√≤n l·∫°i

  // Tr·∫°ng th√°i & Ng√†y quan tr·ªçng
  consultationDate   DateTime? @db.Timestamptz // Ng√†y t∆∞ v·∫•n (nullable - set khi bind v·ªõi appointment)
  serviceConfirmDate DateTime? @db.Timestamptz // Ng√†y kh√°ch h√†ng ƒë·ªìng √Ω
  serviceStatus      String    @default("Ch∆∞a ch·ªët") // "Ch∆∞a ch·ªët", "ƒê√£ ch·ªët"
  treatmentStatus    String    @default("Ch∆∞a ƒëi·ªÅu tr·ªã") // "Ch∆∞a ƒëi·ªÅu tr·ªã", "ƒêang ƒëi·ªÅu tr·ªã", "Ho√†n th√†nh"

  // Th√¥ng tin Ph√¢n c√¥ng
  consultingDoctorId String?
  saleOnlineId       String? // Sale t∆∞ v·∫•n online (TR∆Ø·ªöC khi kh√°ch ƒë·∫øn ph√≤ng kh√°m)
  consultingSaleId   String? // Sale t∆∞ v·∫•n t·∫°i ph√≤ng kh√°m (SAU khi kh√°ch ƒë·∫øn)
  treatingDoctorId   String?

  // Metadata
  createdById String
  updatedById String

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  customer Customer @relation(fields: [customerId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• nha khoa
  dentalService DentalService @relation(fields: [dentalServiceId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn l·ªãch h·∫πn
  Appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Restrict)

  // Li√™n k·∫øt ƒë·∫øn chi nh√°nh
  clinic Clinic? @relation(fields: [clinicId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  consultingDoctor Employee? @relation("ConsultingDoctorServices", fields: [consultingDoctorId], references: [id])
  saleOnline       Employee? @relation("SaleOnlineServices", fields: [saleOnlineId], references: [id])
  consultingSale   Employee? @relation("ConsultingSaleServices", fields: [consultingSaleId], references: [id])
  treatingDoctor   Employee? @relation("TreatingDoctorServices", fields: [treatingDoctorId], references: [id])

  createdBy Employee @relation("CreatedConsultedServices", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedConsultedServices", fields: [updatedById], references: [id])

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω ƒëi·ªÅu tr·ªã
  treatmentLogs TreatmentLog[]

  // Li√™n k·∫øt ƒë·∫øn phi·∫øu thu chi ti·∫øt
  paymentDetails PaymentVoucherDetail[]

  // Li√™n k·∫øt ƒë·∫øn nh·∫≠t k√Ω li√™n h·ªá sale
  salesActivityLogs SalesActivityLog[]

  // üöÄ Performance Indexes
  @@index([clinicId, consultationDate(sort: Desc)]) // Optimize: Daily view - services by clinic & date
  @@index([customerId, consultationDate(sort: Desc)]) // Optimize: Customer detail - all services
  @@index([serviceStatus, createdAt(sort: Desc)]) // Optimize: Pending services follow-up
  @@index([treatmentStatus, consultationDate]) // Optimize: Filter by treatment progress
  @@index([appointmentId]) // Optimize: Services by appointment (check-in flow)
  @@index([consultingDoctorId, consultationDate]) // Optimize: Doctor's consultation history
  @@index([saleOnlineId, createdAt]) // Optimize: Online sale performance tracking
  @@index([consultingSaleId, consultationDate]) // Optimize: Clinic sale performance tracking
}

model PaymentVoucher {
  id String @id @default(uuid())

  paymentNumber   String   @unique // S·ªë phi·∫øu thu
  customerId      String // Kh√°ch h√†ng
  paymentDate     DateTime @default(now()) @db.Timestamptz // Ng√†y v√† gi·ªù thu ti·ªÅn
  totalAmount     Int // T·ªïng ti·ªÅn c·ªßa c·∫£ phi·∫øu thu
  notes           String? // N·ªôi dung thu ti·ªÅn: ƒê·∫∑t c·ªçc, Thanh to√°n ti·∫øp, Ho√†n t·∫•t thanh to√°n
  cashierId       String // Nh√¢n vi√™n thu ti·ªÅn
  clinicId        String // Chi nh√°nh th·ª±c hi·ªán thu ti·ªÅn
  accountTypeUsed String? // "COMPANY" | "PERSONAL" - Track t√†i kho·∫£n ƒë√£ d√πng

  // Metadata
  createdById String
  updatedById String
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Li√™n k·∫øt ƒë·∫øn chi ti·∫øt phi·∫øu thu
  details PaymentVoucherDetail[]

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  customer Customer @relation(fields: [customerId], references: [id])
  // Li√™n k·∫øt ƒë·∫øn chi nh√°nh
  clinic   Clinic   @relation(fields: [clinicId], references: [id])
  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  cashier  Employee @relation("CashierVouchers", fields: [cashierId], references: [id])

  createdBy Employee @relation("CreatedVouchers", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedVouchers", fields: [updatedById], references: [id])

  // Indexes
  @@index([clinicId, paymentDate])
  @@index([customerId])
  @@index([paymentNumber])
}

model PaymentVoucherDetail {
  id String @id @default(uuid())

  // Li√™n k·∫øt ng∆∞·ª£c l·∫°i v·ªõi phi·∫øu thu ch√≠nh
  paymentVoucherId String
  paymentVoucher   PaymentVoucher @relation(fields: [paymentVoucherId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• ƒë∆∞·ª£c thanh to√°n
  consultedServiceId String
  consultedService   ConsultedService @relation(fields: [consultedServiceId], references: [id])

  amount        Int // S·ªë ti·ªÅn thanh to√°n cho d√≤ng n√†y
  paymentMethod String // H√¨nh th·ª©c thanh to√°n: "Ti·ªÅn m·∫∑t", "Qu·∫πt th·∫ª",...

  // Metadata
  createdAt   DateTime @default(now()) @db.Timestamptz
  createdById String

  // 
  createdBy Employee @relation("CreatedVoucherDetails", fields: [createdById], references: [id])

  // Indexes
  @@index([consultedServiceId])
  @@index([paymentVoucherId])
}

model SalesActivityLog {
  id String @id @default(uuid())

  // Li√™n k·∫øt (Service-centric)
  consultedServiceId String
  consultedService   ConsultedService @relation(fields: [consultedServiceId], references: [id])

  saleId String // Ng∆∞·ªùi th·ª±c hi·ªán contact
  sale   Employee @relation("SalesActivities", fields: [saleId], references: [id])

  // Th√¥ng tin li√™n h·ªá
  contactType String // "call" | "message" | "meet"
  contactDate DateTime @default(now()) @db.Timestamptz

  // N·ªôi dung
  content String // T√≥m t·∫Øt cu·ªôc trao ƒë·ªïi (b·∫Øt bu·ªôc)

  // Follow-up plan
  nextContactDate DateTime? @db.Date

  // Metadata
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Indexes
  @@index([consultedServiceId, contactDate(sort: Desc)])
  @@index([saleId, contactDate(sort: Desc)])
  @@index([nextContactDate]) // For follow-up queries
}

model TreatmentLog {
  id String @id @default(uuid())

  // Li√™n k·∫øt D·ªØ li·ªáu
  customerId         String
  consultedServiceId String // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• c·ª• th·ªÉ ƒë√£ ƒë∆∞·ª£c ch·ªët
  appointmentId      String // L·ªãch h·∫πn c·ªßa bu·ªïi ƒëi·ªÅu tr·ªã n√†y

  // Th√¥ng tin L√¢m s√†ng
  treatmentDate   DateTime @default(now()) @db.Timestamptz // Ng√†y ƒëi·ªÅu tr·ªã
  treatmentNotes  String // Chi ti·∫øt, n·ªôi dung ƒëi·ªÅu tr·ªã
  nextStepNotes   String? // K·∫ø ho·∫°ch cho bu·ªïi h·∫πn ti·∫øp theo
  treatmentStatus String // "ƒêang ti·∫øn h√†nh", "Ho√†n t·∫•t b∆∞·ªõc", "Ho√†n t·∫•t d·ªãch v·ª•"

  imageUrls String[] // M·∫£ng ch·ª©a c√°c URL c·ªßa h√¨nh ·∫£nh
  xrayUrls  String[] // M·∫£ng ch·ª©a c√°c URL c·ªßa phim X-quang

  // Nh√¢n s·ª± th·ª±c hi·ªán
  dentistId    String
  assistant1Id String?
  assistant2Id String?
  clinicId     String

  // Metadata & Ghi nh·∫≠n
  createdById String
  updatedById String

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Li√™n k·∫øt ƒë·∫øn kh√°ch h√†ng
  customer Customer @relation(fields: [customerId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn d·ªãch v·ª• t∆∞ v·∫•n
  consultedService ConsultedService @relation(fields: [consultedServiceId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn l·ªãch h·∫πn
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn chi nh√°nh
  clinic Clinic @relation(fields: [clinicId], references: [id])

  // Li√™n k·∫øt ƒë·∫øn nh√¢n vi√™n
  dentist    Employee  @relation("DentistLogs", fields: [dentistId], references: [id])
  assistant1 Employee? @relation("Assistant1Logs", fields: [assistant1Id], references: [id])
  assistant2 Employee? @relation("Assistant2Logs", fields: [assistant2Id], references: [id])
  createdBy  Employee  @relation("CreatedLogs", fields: [createdById], references: [id])
  updatedBy  Employee  @relation("UpdatedLogs", fields: [updatedById], references: [id])

  // üöÄ Performance Indexes
  @@index([clinicId, treatmentDate(sort: Desc)]) // Optimize: Daily view - logs by clinic & date
  @@index([customerId, treatmentDate(sort: Desc)]) // Optimize: Customer detail - treatment history
  @@index([consultedServiceId, treatmentDate(sort: Desc)]) // Optimize: Service progress tracking
  @@index([appointmentId, createdAt(sort: Asc)]) // Optimize: Appointment treatment logs
  @@index([dentistId, treatmentDate]) // Optimize: Dentist workload & performance
  @@index([treatmentStatus, treatmentDate]) // Optimize: Treatment status filtering
}

//---------------------------
// TreatmentCare (Aftercare) v1
//---------------------------

model TreatmentCare {
  id String @id @default(uuid())

  // Li√™n k·∫øt
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // C∆° s·ªü b√°o c√°o: theo nh√¢n vi√™n chƒÉm s√≥c (careStaff)
  clinicId String
  clinic   Clinic @relation(fields: [clinicId], references: [id])

  careStaffId String
  careStaff   Employee @relation(fields: [careStaffId], references: [id])

  // Ng√†y nghi·ªáp v·ª•
  treatmentDate DateTime @db.Date // Ng√†y ƒëi·ªÅu tr·ªã (Date-only)
  careAt        DateTime @db.Timestamptz // Th·ªùi ƒëi·ªÉm chƒÉm s√≥c

  // N·ªôi dung & Tr·∫°ng th√°i
  careContent String
  careStatus  String

  // Snapshot (g·ªôp theo treatmentDate)
  treatmentServiceNames String[]
  treatingDoctorNames   String[]
  treatingDoctorIds     String[]
  treatmentClinicIds    String[]

  // Audit
  createdById String
  updatedById String
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  createdBy Employee @relation("CreatedTreatmentCares", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedTreatmentCares", fields: [updatedById], references: [id])

  // Indexes
  @@index([clinicId, treatmentDate])
  @@index([clinicId, careAt])
  @@index([careStaffId, careAt])
  @@index([customerId, treatmentDate])
}

//---------------------------
// MasterData (Shared across app)
//---------------------------

model MasterData {
  id String @id @default(uuid())

  // Ph√¢n lo·∫°i & ƒê·ªãnh danh
  category    String // Nh√≥m ph√¢n lo·∫°i (slug: 'bao-hanh-chinh-hang')
  key         String // M√£ ƒë·ªãnh danh (slug: '1-nam') - IMMUTABLE
  value       String // T√™n hi·ªÉn th·ªã ('1 nƒÉm') - MUTABLE
  description String? // M√¥ t·∫£ chi ti·∫øt (optional)

  // Audit
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // Indexes
  @@unique([category, key]) // Unique constraint: key ch·ªâ unique trong category
  @@index([category]) // Fast filter by category
}

//---------------------------
// Supplier (Nh√† cung c·∫•p)
//---------------------------

model Supplier {
  id        String  @id @default(uuid())
  name      String  @unique
  shortName String?

  // Store MasterData.key (String), NOT id (UUID)
  // NO FK relation ‚Üí Allows MasterData to be deleted
  // Frontend: Display MasterData.value if found, else display key itself
  supplierGroup String? // e.g., 'ncc-chinh', 'ncc-phu'

  phone   String?
  email   String?
  address String?
  taxCode String?
  note    String?

  archivedAt DateTime? @db.Timestamptz // Soft delete
  createdAt  DateTime  @default(now()) @db.Timestamptz
  updatedAt  DateTime  @updatedAt @db.Timestamptz

  createdById String // ID c·ªßa ng∆∞·ªùi t·∫°o
  updatedById String // ID c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t

  createdBy Employee @relation("CreatedSuppliers", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedSuppliers", fields: [updatedById], references: [id])

  // Relations
  laboServices LaboService[]
  laboOrders   LaboOrder[]

  // Indexes
  @@index([name])
  @@index([supplierGroup, archivedAt])
}

//---------------------------
// Material (V·∫≠t t∆∞)
//---------------------------

model Material {
  id          String  @id @default(uuid())
  code        String  @unique // MAT0001, MAT0002... (T·ª± sinh)
  name        String  @unique
  description String? // M√¥ t·∫£, quy c√°ch ƒë√≥ng g√≥i

  // Store MasterData.key (String), NOT id (UUID)
  // NO FK relation ‚Üí Allows MasterData to be deleted
  // Frontend: Display MasterData.value if found, else display key itself
  unit         String // ƒê∆°n v·ªã t√≠nh (category='don-vi-tinh') - Required
  materialType String // Lo·∫°i v·∫≠t t∆∞ (category='loai-vat-tu') - Required
  department   String // B·ªô m√¥n (category='bo-mon') - Required
  category     String? // Nh√≥m v·∫≠t t∆∞ (category='nhom-vat-tu')
  subCategory  String? // Ph√¢n nh√≥m (category='phan-nhom-vat-tu')

  minStockLevel Int? // M·ª©c t·ªìn kho t·ªëi thi·ªÉu
  imageUrl      String? // URL h√¨nh ·∫£nh
  tags          String[] @default([]) // Array of MasterData keys (category='tag-vat-tu')

  archivedAt DateTime? @db.Timestamptz // Soft delete
  createdAt  DateTime  @default(now()) @db.Timestamptz
  updatedAt  DateTime  @updatedAt @db.Timestamptz

  createdById String // ID c·ªßa ng∆∞·ªùi t·∫°o
  updatedById String // ID c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t

  createdBy Employee @relation("CreatedMaterials", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedMaterials", fields: [updatedById], references: [id])

  // Relations (placeholder - s·∫Ω ƒë∆∞·ª£c th√™m khi implement Goods Receipt/Issue)
  // receiptDetails  GoodsReceiptDetail[]
  // issueDetails    GoodsIssueDetail[]
  // stockQuants     StockQuant[]

  // Indexes
  @@index([code])
  @@index([name])
  @@index([materialType, department, category, archivedAt])
  @@index([tags]) // GIN index for array search in PostgreSQL
}

//---------------------------
// LaboItem (Danh m·ª•c rƒÉng gi·∫£)
//---------------------------

model LaboItem {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  // Store MasterData.key (String), NOT id (UUID)
  // NO FK relation ‚Üí Allows MasterData to be deleted
  // Frontend: Display MasterData.value if found, else display key itself
  serviceGroup String // Nh√≥m d·ªãch v·ª• labo (category='nhom-dich-vu-labo')
  unit         String // ƒê∆°n v·ªã t√≠nh (category='don-vi-tinh-labo')

  archivedAt DateTime? @db.Timestamptz // Soft delete
  createdAt  DateTime  @default(now()) @db.Timestamptz
  updatedAt  DateTime  @updatedAt @db.Timestamptz

  createdById String // ID c·ªßa ng∆∞·ªùi t·∫°o
  updatedById String // ID c·ªßa ng∆∞·ªùi c·∫≠p nh·∫≠t

  createdBy Employee @relation("CreatedLaboItems", fields: [createdById], references: [id])
  updatedBy Employee @relation("UpdatedLaboItems", fields: [updatedById], references: [id])

  // Relations
  laboServices LaboService[]
  laboOrders   LaboOrder[]

  // Indexes
  @@index([name])
  @@index([serviceGroup, archivedAt])
}

//---------------------------
// LaboService (B·∫£ng gi√° d·ªãch v·ª• labo)
//---------------------------

model LaboService {
  id String @id @default(uuid())

  // References
  supplierId String
  laboItemId String

  // Pricing
  price Int // Gi√° 1 ƒë∆°n v·ªã (VND)

  // Store MasterData.key (String), NOT id (UUID)
  // NO FK relation ‚Üí Allows MasterData to be deleted
  // Frontend: Display MasterData.value if found, else display key itself
  warranty String // e.g., "5-nam" (category='bao-hanh-labo')

  // Metadata
  createdById String
  updatedById String
  createdAt   DateTime  @default(now()) @db.Timestamptz
  updatedAt   DateTime  @updatedAt @db.Timestamptz
  archivedAt  DateTime? @db.Timestamptz

  // Relations
  supplier   Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  laboItem   LaboItem    @relation(fields: [laboItemId], references: [id], onDelete: Restrict)
  createdBy  Employee    @relation("CreatedLaboServices", fields: [createdById], references: [id])
  updatedBy  Employee    @relation("UpdatedLaboServices", fields: [updatedById], references: [id])
  laboOrders LaboOrder[] // Orders using this pricing

  // Unique constraint: M·ªói supplier ch·ªâ c√≥ 1 gi√° cho m·ªói laboItem
  @@unique([supplierId, laboItemId])
  @@index([supplierId])
  @@index([laboItemId])
}

//---------------------------
// LaboOrder (ƒê∆°n h√†ng labo - M·∫´u g·ª≠i x∆∞·ªüng)
//---------------------------

model LaboOrder {
  id String @id @default(uuid())

  // References
  customerId    String
  doctorId      String
  laboServiceId String // Link to pricing record (audit trail)
  supplierId    String // Denormalized for query performance
  laboItemId    String // Denormalized for query performance
  clinicId      String

  // Treatment Info
  treatmentDate DateTime @db.Date // Ng√†y b√°c sƒ© ƒëi·ªÅu tr·ªã
  orderType     String // "lam-moi" | "bao-hanh"

  // Pricing (Snapshot from LaboService at creation time)
  unitPrice Int // Snapshot price per unit
  quantity  Int // S·ªë l∆∞·ª£ng
  totalCost Int // = unitPrice * quantity
  warranty  String // Snapshot warranty: "5-nam"

  // Dates
  sentDate        DateTime  @default(now()) @db.Timestamptz // Ng√†y g·ª≠i m·∫´u ƒëi x∆∞·ªüng (auto-set to now)
  returnDate      DateTime? @db.Timestamptz // Ng√†y nh·∫≠n m·∫´u v·ªÅ t·ª´ x∆∞·ªüng (set when received)
  expectedFitDate DateTime? @db.Date // Ng√†y d·ª± ki·∫øn l·∫Øp cho kh√°ch (optional)

  // Details
  detailRequirement String? // Ghi ch√∫ y√™u c·∫ßu chi ti·∫øt cho x∆∞·ªüng

  // Tracking
  sentById     String // Nh√¢n vi√™n g·ª≠i m·∫´u (usually same as createdById)
  receivedById String? // Nh√¢n vi√™n nh·∫≠n m·∫´u

  // Metadata
  createdById String
  updatedById String
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz

  // Relations
  customer    Customer    @relation(fields: [customerId], references: [id])
  doctor      Employee    @relation("DoctorLaboOrders", fields: [doctorId], references: [id])
  laboService LaboService @relation(fields: [laboServiceId], references: [id])
  supplier    Supplier    @relation(fields: [supplierId], references: [id])
  laboItem    LaboItem    @relation(fields: [laboItemId], references: [id])
  clinic      Clinic      @relation(fields: [clinicId], references: [id])

  sentBy     Employee  @relation("SentLaboOrders", fields: [sentById], references: [id])
  receivedBy Employee? @relation("ReceivedLaboOrders", fields: [receivedById], references: [id])
  createdBy  Employee  @relation("CreatedLaboOrders", fields: [createdById], references: [id])
  updatedBy  Employee  @relation("UpdatedLaboOrders", fields: [updatedById], references: [id])

  // Indexes
  @@index([clinicId, sentDate])
  @@index([clinicId, returnDate])
  @@index([customerId])
  @@index([supplierId])
  @@index([laboServiceId])
}
